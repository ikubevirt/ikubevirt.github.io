{"config":{"lang":["en"],"separator":"[\\s\\u200b\\-]","pipeline":["stemmer"]},"docs":[{"location":"","title":"ikubevirt","text":"<p>Welcome to Material for MkDocs.</p>"},{"location":"blog/","title":"\u535a\u5ba2","text":"<p>{{ blog_content }}</p>"},{"location":"blog/tags/","title":"\u6807\u7b7e","text":"<p>{{ tag_content }}</p>"},{"location":"blog/posts/vpc-cni-k8s-cluster/","title":"VPC-CNI\u65b9\u6848\u5b9e\u73b0k8s\u96c6\u7fa4\u5185\u5916\u4e92\u901a","text":"<code>#CNI</code> <code>#\u7f51\u7edc</code> <code>#go</code>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#vpc-cni","title":"VPC-CNI\u65b9\u6848\u80cc\u666f","text":"<p>\u4e4b\u524d\u7684\u6587\u7ae0\u5206\u6790\u8fc7 flannel \u7f51\u7edc\u6a21\u578b\uff0c\u8bda\u7136\uff0cFlannel \u89e3\u51b3\u4e86 k8s \u96c6\u7fa4\u4e2d\u5bb9\u5668\u95f4\u7f51\u7edc\u4e92\u901a\u7684\u95ee\u9898\uff0c\u4f46\u5bf9\u4e8e\u5982\u4f55\u89e3\u51b3\u96c6\u7fa4\u5185\u5bb9\u5668\u4e0e\u96c6\u7fa4\u5916\u7684\u865a\u62df\u673a\u6216\u8005\u7269\u7406\u673a\u76f4\u63a5\u4e92\u901a\u7684\u95ee\u9898\u5374\u65e0\u80fd\u4e3a\u529b\u3002 \u5176\u5b9e\uff0c\u66f4\u786e\u5207\u8bf4\u6cd5\u662f\u96c6\u7fa4\u5916\u670d\u52a1\u65e0\u6cd5\u76f4\u63a5 ping \u901a\u96c6\u7fa4\u5185\u5bb9\u5668ip\u3002\u90a3\u4e48\u5c31\u610f\u5473\u7740\uff0c\u5728\u7c7b\u4f3c<code>dubbo</code>\u8fd9\u79cd\u5fae\u670d\u52a1\u53d1\u73b0\u548c\u6ce8\u518c\u573a\u666f\u4e2d\uff0c\u5728\u7f51\u7edc\u5c42\uff0ck8s \u96c6\u7fa4\u5916\u7684consumer\u662f\u65e0\u6cd5\u76f4\u63a5\u8fde\u901a\u96c6\u7fa4\u5185\u7684provider\u7684</p> <p>\u7591\u95ee</p> <p>\u53ef\u80fd\u6709\u4eba\u4e0d\u7981\u8981\u95ee\uff0cflannel \u4e3a\u4ec0\u4e48\u5bf9\u4e8e\u8fd9\u79cd\u573a\u666f\u65e0\u80fd\u4e3a\u529b\uff1f</p> <p>\u8fd9\u662f\u56e0\u4e3a\uff0ck8s \u96c6\u7fa4\u4e2d\u5bb9\u5668\u7684ip\u662f\u7531<code>flanneld</code>\"\u53e6\u8d77\u7089\u7076\"\u72ec\u7acb\u751f\u6210\u7684\uff0c\u5e76\u4e0d\u5728vpc\u7f51\u6bb5\u7684\u8303\u56f4\u5185\uff0c\u5bfc\u81f4\u96c6\u7fa4\u5916\u7684\u670d\u52a1\u5668\u4e0a\u7684\u8def\u7531\u8868\u7f3a\u5931\u76f8\u5e94\u7684\u8def\u7531\u6761\u76ee\u5c06\u6570\u636e\u5305\u8f6c\u53d1\u5230\u5bb9\u5668\u5185\u3002 \u806a\u660e\u5982\u4f60\uff0c\u9a6c\u4e0a\u60f3\u5230\"\u65e2\u7136\u5982\u6b64\uff0c\u90a3\u8ba9\u5bb9\u5668\u5206\u914d\u7684 ip \u5728 vpc \u7f51\u6bb5\u5185\uff0c\u4e0d\u5c31\u53ef\u4ee5\u4e86\u5417?\"</p> <p>\u606d\u559c\u4f60\uff0c\u7b54\u5bf9\u4e86\uff01\uff01\uff01</p> <p>vpc-cni \u65b9\u6848\u6574\u4f53\u6cbf\u7528\u7684\u6b63\u662f\u8fd9\u6837\u7684\u601d\u8def:\u4ece VPC \u7f51\u6bb5\u4e2d\u5206\u914d ip\u7ed9\u5bb9\u5668\u3002\u8fd9\u6837\uff0c\u96c6\u7fa4\u5185\u5916\u5c31\u5b9e\u73b0\u4e86\u65e0\u5dee\u522b\u7684\u7f51\u7edc\u76f4\u8fde\u4e92\u901a\uff1b\u53e6\u5916\u4e00\u4e2a\u597d\u5904\u662f\uff0c\u8fd9\u79cd\u65b9\u6848\u7531\u4e8e\u7701\u5374\u4e86 Flanneld \u89e3\u5c01\u88c5 vxlan \u6570\u636e\u5305\u7684\u6b65\u9aa4\uff0c\u7f51\u7edc\u6027\u80fd\u6bcb\u5eb8\u7f6e\u7591\u4e0a\u4f1a\u6709\u663e\u8457\u63d0\u5347\u3002 \u5728 k8s \u7684\u843d\u5730\u8fc7\u7a0b\u4e2d\uff0c\u4e3a\u4e86\u5c06\u4e1a\u52a1\u7cfb\u7edf\u5e73\u6ed1\u8fc1\u79fb\u5230 k8s \u4e2d\uff0c\u5c24\u5176\u662f\u5efa\u7acb\u5728 RPC+ \u6ce8\u518c\u4e2d\u5fc3\u7684\u5fae\u670d\u52a1\u67b6\u6784\u4e0a,\u5c31\u5fc5\u987b\u4fdd\u6301\u96c6\u7fa4\u5185\u5916\u7684\u76f4\u8fde\u4e92\u901a\uff0c\u8fd9\u79cd\u573a\u666f\u4e0b\uff0cvpc-cni \u65b9\u6848\u65e0\u7591\u662f\u9996\u9009\u3002</p>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#vpc-cni_1","title":"VPC-CNI\u539f\u7406","text":"<p>\u4e3b\u8981\u5b9e\u73b0\u903b\u8f91:</p> <p>Worker\u8282\u70b9\u542f\u52a8\u7684\u65f6\u5019\u6302\u8f7d\u591a\u4e2a\u865a\u62df\u7f51\u5361ENI(<code>Elastic Netowrk Interface</code>)</p> <ul> <li>\u6bcf\u4e2aENI\u90fd\u7ed1\u5b9a\u4e86\u4e00\u4e2a\u4e3bIP(Primary ip) \u548c \u591a\u4e2a secondary ip</li> <li><code>ipamd</code>(Local IP Address Manager)\u8fd0\u884c\u5728\u6bcf\u4e2a worker \u8282\u70b9\u4e0a,\u5c06\u6240\u6709ENI\u7684\u6240\u6709 secondary ip \u52a0\u5165\u5230\u672c\u5730 ip \u5730\u5740\u6c60\u4e2d</li> <li>\u5f53 cni \u63a5\u53d7\u5230\u521b\u5efa pod \u4e8b\u4ef6\u8bf7\u6c42\u65f6\uff0c\u5c31\u4f1a\u901a\u8fc7 grpc \u8bf7\u6c42<code>ipamd</code>\u62ff\u5230 ip \u5e76\u8bbe\u7f6e pod \u7f51\u7edc\u6808;\u53cd\u4e4b\uff0c\u5f53\u63a5\u6536\u5230\u5220\u9664 pod \u8bf7\u6c42\u65f6\u5c31\u4f1a\u901a\u77e5<code>ipamd</code>\u91ca\u653e ip \u5e76\u540c\u65f6\u5220\u9664 pod \u7f51\u7edc\u6808</li> </ul> <p></p>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#cni","title":"CNI\u63a5\u53e3","text":"<p>\u9075\u5b88 k8S CNI \u7f51\u7edc\u6a21\u578b\u7684\u63a5\u53e3\u89c4\u8303,\u4e3b\u8981\u5b9e\u73b0\u4e86<code>cmdAdd</code>\u3001<code>cmdDel</code> \u63a5\u53e3,\u5206\u522b\u5904\u7406 pod \u7f51\u7edc\u7684\u521b\u5efa\u548c\u9500\u6bc1\u4e8b\u4ef6</p>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#cmdadd","title":"cmdAdd","text":"cmd/routed-eni-cni-plugin/cni.go<pre><code>func cmdAdd(args *skel.CmdArgs) error {\nreturn add(args, typeswrapper.New(), grpcwrapper.New(), rpcwrapper.New(), driver.New())\n}\nfunc add(args *skel.CmdArgs, cniTypes typeswrapper.CNITYPES, grpcClient grpcwrapper.GRPC,\nrpcClient rpcwrapper.RPC, driverClient driver.NetworkAPIs) error {\nconf, log, err := LoadNetConf(args.StdinData)\n...\n// \u89e3\u6790 k8s \u53c2\u6570\nvar k8sArgs K8sArgs\nif err := cniTypes.LoadArgs(args.Args, &amp;k8sArgs); err != nil {\nlog.Errorf(\"Failed to load k8s config from arg: %v\", err)\nreturn errors.Wrap(err, \"add cmd: failed to load k8s config from arg\")\n}\n...\n// \u901a\u8fc7 grpc \u53d1\u8d77\u8bf7\u6c42\u5230 ipamd server\nconn, err := grpcClient.Dial(ipamdAddress, grpc.WithInsecure())\n...\nc := rpcClient.NewCNIBackendClient(conn)\n// \u8c03\u7528 ipamd \u7684 AddNetwork \u63a5\u53e3\u83b7\u53d6 ip \u5730\u5740\nr, err := c.AddNetwork(context.Background(),\n&amp;pb.AddNetworkRequest{\nClientVersion:              version,\nK8S_POD_NAME:               string(k8sArgs.K8S_POD_NAME),\nK8S_POD_NAMESPACE:          string(k8sArgs.K8S_POD_NAMESPACE),\nK8S_POD_INFRA_CONTAINER_ID: string(k8sArgs.K8S_POD_INFRA_CONTAINER_ID),\nNetns:                      args.Netns,\nContainerID:                args.ContainerID,\nNetworkName:                conf.Name,\nIfName:                     args.IfName,\n})\n...\naddr := &amp;net.IPNet{\nIP:   net.ParseIP(r.IPv4Addr),\nMask: net.IPv4Mask(255, 255, 255, 255),\n}\n...\n// \u83b7\u53d6\u5230 ip \u540e,\u8c03\u7528 driver \u6a21\u5757\u914d\u7f6e pod \u7684 network namespace\nerr = driverClient.SetupNS(hostVethName, args.IfName, args.Netns, addr, int(r.DeviceNumber), r.VPCcidrs, r.UseExternalSNAT, mtu, log)\n}\n...\nips := []*current.IPConfig{\n{\nVersion: \"4\",\nAddress: *addr,\n},\n}\nresult := &amp;current.Result{\nIPs: ips,\n}\nreturn cniTypes.PrintResult(result, conf.CNIVersion)\n}\n</code></pre> <p>\u603b\u7ed3:cni \u901a\u8fc7 grpc \u8bf7\u6c42<code>ipamd</code>\u670d\u52a1\u83b7\u53d6 ip,\u62ff\u5230 ip \u540e\u8c03\u7528 driver \u6a21\u5757\u8bbe\u7f6e pod \u7684\u7f51\u7edc\u73af\u5883\u3002</p>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#cmddel","title":"cmdDel","text":"<p>\u91ca\u653e pod ip \u5e76\u6e05\u7406 pod \u7684\u7f51\u7edc\u73af\u5883</p> <pre><code>func cmdDel(args *skel.CmdArgs) error {\nreturn del(args, typeswrapper.New(), grpcwrapper.New(), rpcwrapper.New(), driver.New())\n}\nfunc del(args *skel.CmdArgs, cniTypes typeswrapper.CNITYPES, grpcClient grpcwrapper.GRPC, rpcClient rpcwrapper.RPC, driverClient driver.NetworkAPIs) error {\nconf, log, err := LoadNetConf(args.StdinData)\n...\nvar k8sArgs K8sArgs\nif err := cniTypes.LoadArgs(args.Args, &amp;k8sArgs); err != nil {\nlog.Errorf(\"Failed to load k8s config from args: %v\", err)\nreturn errors.Wrap(err, \"del cmd: failed to load k8s config from args\")\n}\n// \u53d1\u8d77 grpc \u8bf7\u6c42\u901a\u77e5 ipamd \u91ca\u653e ip\nconn, err := grpcClient.Dial(ipamdAddress, grpc.WithInsecure())\n...\nc := rpcClient.NewCNIBackendClient(conn)\nr, err := c.DelNetwork(context.Background(), &amp;pb.DelNetworkRequest{\nClientVersion:              version,\nK8S_POD_NAME:               string(k8sArgs.K8S_POD_NAME),\nK8S_POD_NAMESPACE:          string(k8sArgs.K8S_POD_NAMESPACE),\nK8S_POD_INFRA_CONTAINER_ID: string(k8sArgs.K8S_POD_INFRA_CONTAINER_ID),\nNetworkName:                conf.Name,\nContainerID:                args.ContainerID,\nIfName:                     args.IfName,\nReason:                     \"PodDeleted\",\n})\n...\ndeletedPodIP := net.ParseIP(r.IPv4Addr)\nif deletedPodIP != nil {\naddr := &amp;net.IPNet{\nIP:   deletedPodIP,\nMask: net.IPv4Mask(255, 255, 255, 255),\n}\n... // \u8c03\u7528 driver \u6a21\u5757\u7684 TearDownNS \u63a5\u53e3\u5220\u9664\u6e05\u7406 pod \u7f51\u7edc\u6808\nerr = driverClient.TeardownNS(addr, int(r.DeviceNumber), log)\n...\nreturn nil\n}\n}\n</code></pre>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#driver","title":"Driver","text":"<p>\u8be5\u6a21\u5757\u4e3b\u8981\u63d0\u4f9b\u521b\u5efa\u548c\u9500\u6bc1 pod \u7f51\u7edc\u6808\u7684\u5de5\u5177,driver \u6a21\u5757\u7684\u4e3b\u51fd\u6570\u662f<code>SetupNS</code>\u548c<code>TeardownNS</code></p> <p>\u4ee3\u7801\u8def\u5f84: <code>cmd/routed-eni-cni-plugin/driver.go</code></p> <p>\u4ee3\u7801\u903b\u8f91\uff1a</p> <p></p>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#setupns","title":"SetupNS","text":"<p>\u8be5\u51fd\u6570\u4e3b\u8981\u529f\u80fd\u662f\u914d\u7f6e pod \u7f51\u7edc\u6808,\u5305\u62ec\u51c6\u5907 pod \u7684\u7f51\u7edc\u73af\u5883\u548c\u7b56\u7565\u8def\u7531\u7684\u914d\u7f6e</p> <p>\u5728 <code>aws-cni</code> \u7f51\u7edc\u6a21\u578b\u4e2d\uff0c\u8282\u70b9\u4e0a\u7684\u6bcf\u4e00\u4e2a<code>ENI</code>\u90fd\u4f1a\u751f\u6210\u76f8\u5e94\u7684\u8def\u7531\u8868\u6765\u8f6c\u53d1<code>from-pod</code>\u7684\u6d41\u91cf;\u901a\u8fc7\u7b56\u7565\u8def\u7531\u65b9\u5f0f\uff0c\u8ba9<code>to-pod</code>\u7684\u6d41\u91cf\u4f18\u5148\u8d70\u4e3b\u8def\u7531\u8868\uff0c\u800c\u5bf9\u4e8e<code>from-pod</code>\u7684\u6d41\u91cf\u5219\u8d70<code>ENI</code>\u5bf9\u5e94\u7684\u8def\u7531\u8868\uff0c\u6240\u4ee5\u5728\u914d\u7f6e pod \u7f51\u7edc\u73af\u5883\u4e2d\u6709\u914d\u7f6e\u7b56\u7565\u8def\u7531\u7684\u8fc7\u7a0b</p> <pre><code>func (os *linuxNetwork) SetupNS(hostVethName string, contVethName string, netnsPath string, addr *net.IPNet, deviceNumber int, vpcCIDRs []string, useExternalSNAT bool, mtu int, log logger.Logger) error {\nlog.Debugf(\"SetupNS: hostVethName=%s, contVethName=%s, netnsPath=%s, deviceNumber=%d, mtu=%d\", hostVethName, contVethName, netnsPath, deviceNumber, mtu)\nreturn setupNS(hostVethName, contVethName, netnsPath, addr, deviceNumber, vpcCIDRs, useExternalSNAT, os.netLink, os.ns, mtu, log, os.procSys)\n}\nfunc setupNS(hostVethName string, contVethName string, netnsPath string, addr *net.IPNet, deviceNumber int, vpcCIDRs []string, useExternalSNAT bool,\nnetLink netlinkwrapper.NetLink, ns nswrapper.NS, mtu int, log logger.Logger, procSys procsyswrapper.ProcSys) error {\n// \u8c03\u7528 setupVeth \u51fd\u6570\u8bbe\u7f6e pod \u7f51\u7edc\u73af\u5883\nhostVeth, err := setupVeth(hostVethName, contVethName, netnsPath, addr, netLink, ns, mtu, procSys, log)\n...\naddrHostAddr := &amp;net.IPNet{\nIP:   addr.IP,\nMask: net.CIDRMask(32, 32),\n}\n// \u5728\u8282\u70b9\u4e0a\u7684\u4e3b\u8def\u7531\u8868\u6dfb\u52a0\u5230 pod \u7684\u8def\u7531 ip route add $ip dev veth-1 \nroute := netlink.Route{\nLinkIndex: hostVeth.Attrs().Index,\nScope:     netlink.SCOPE_LINK,\nDst:       addrHostAddr,\n}\n// netlink \u63a5\u53e3\u5c01\u88c5\u4e86 linux \u7684 \"ip link\"\u3001\"ip route\"\u3001 \"ip rule\"\u7b49\u547d\u4ee4\nif err := netLink.RouteReplace(&amp;route); err != nil {\nreturn errors.Wrapf(err, \"setupNS: unable to add or replace route entry for %s\", route.Dst.IP.String())\n}\n// \u4f7f\u7528 \"ip rule\" \u547d\u4ee4\u6dfb\u52a0 to-pod \u7b56\u7565\u8def\u7531  512: from all to 10.0.97.30 lookup main \nerr = addContainerRule(netLink, true, addr, mainRouteTable)\n...\n// \u901a\u8fc7ENI deviceNumber \u5224\u65ad\u662f\u5426 primary ENI, 0\u8868\u793a Primary ENI\n// \u5982\u679c ENI \u4e0d\u662f primary ENI,\u5219\u6dfb\u52a0\u6d41\u91cf\u4ece pod \u51fa\u6765\u7684\u7b56\u7565\u8def\u7531 \n//  1536: from 10.0.97.30 lookup eni-1 \nif deviceNumber &gt; 0 {\ntableNumber := deviceNumber + 1\nerr = addContainerRule(netLink, false, addr, tableNumber)\n...\n}\nreturn nil\n}\n</code></pre> <p>\u6700\u7ec8\u5b9e\u73b0\u7684\u6548\u679c\uff1a</p> <pre><code># ip rule list\n0:    from all lookup local\n512:  from all to 10.0.97.30 lookup main &lt;---------- to Pod's traffic\n1025: not from all to 10.0.0.0/16 lookup main\n1536: from 10.0.97.30 lookup eni-1 &lt;-------------- from Pod's traffic\n</code></pre>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#createvethpaircontext","title":"createVethPairContext","text":"<p><code>createVethPairContext</code> \u7ed3\u6784\u4f53\u5305\u542b\u4e86\u521b\u5efa<code>vethpair</code>\u6240\u9700\u53c2\u6570\uff0c<code>run</code> \u65b9\u6cd5\u5176\u5b9e\u662f<code>setupVeth</code>\u51fd\u6570\u7684\u5177\u4f53\u5b9e\u73b0\uff0c\u5305\u542b\u4e86\u521b\u5efa<code>vethpair</code>,\u542f\u7528<code>vethpir</code>\u3001\u914d\u7f6e pod \u7f51\u5173\u3001\u8def\u7531\u7b49\u6b65\u9aa4</p> <pre><code>func newCreateVethPairContext(contVethName string, hostVethName string, addr *net.IPNet, mtu int) *createVethPairContext {\nreturn &amp;createVethPairContext{\ncontVethName: contVethName,\nhostVethName: hostVethName,\naddr:         addr,\nnetLink:      netlinkwrapper.NewNetLink(),\nip:           ipwrapper.NewIP(),\nmtu:          mtu,\n}\n}\nfunc (createVethContext *createVethPairContext) run(hostNS ns.NetNS) error {\nveth := &amp;netlink.Veth{\nLinkAttrs: netlink.LinkAttrs{\nName:  createVethContext.contVethName,\nFlags: net.FlagUp,\nMTU:   createVethContext.mtu,\n},\nPeerName: createVethContext.hostVethName,\n}\n// \u6267\u884c ip link add \u4e3a pod \u521b\u5efa vethpair\nif err := createVethContext.netLink.LinkAdd(veth); err != nil {\nreturn err\n}\nhostVeth, err := createVethContext.netLink.LinkByName(createVethContext.hostVethName)\n...\n// \u6267\u884c ip link set $link up \u542f\u7528 vethpair \u7684\u4e3b\u673a\u7aef\nif err = createVethContext.netLink.LinkSetUp(hostVeth); err != nil {\nreturn errors.Wrapf(err, \"setup NS network: failed to set link %q up\", createVethContext.hostVethName)\n}\ncontVeth, err := createVethContext.netLink.LinkByName(createVethContext.contVethName)\nif err != nil {\nreturn errors.Wrapf(err, \"setup NS network: failed to find link %q\", createVethContext.contVethName)\n}\n// \u542f\u7528 pod \u7aef\u7684 vethpair\nif err = createVethContext.netLink.LinkSetUp(contVeth); err != nil {\nreturn errors.Wrapf(err, \"setup NS network: failed to set link %q up\", createVethContext.contVethName)\n}\n// \u6dfb\u52a0\u9ed8\u8ba4\u7f51\u5173 169.254.1.1   route add default gw addr\nif err = createVethContext.netLink.RouteReplace(&amp;netlink.Route{\nLinkIndex: contVeth.Attrs().Index,\nScope:     netlink.SCOPE_LINK,\nDst:       gwNet,\n}); err != nil {\nreturn errors.Wrap(err, \"setup NS network: failed to add default gateway\")\n}\n// \u6dfb\u52a0\u9ed8\u8ba4\u8def\u7531 \u6548\u679c default via 169.254.1.1 dev eth0\nif err = createVethContext.ip.AddDefaultRoute(gwNet.IP, contVeth); err != nil {\nreturn errors.Wrap(err, \"setup NS network: failed to add default route\")\n}\n// \u7ed9\u7f51\u5361 eth0 \u6dfb\u52a0 ip \u5730\u5740 \"ip addr add $ip dev eth0\"\nif err = createVethContext.netLink.AddrAdd(contVeth, &amp;netlink.Addr{IPNet: createVethContext.addr}); err != nil {\nreturn errors.Wrapf(err, \"setup NS network: failed to add IP addr to %q\", createVethContext.contVethName)\n}\n// \u4e3a\u9ed8\u8ba4\u7f51\u5173\u6dfb\u52a0 arp \u9759\u6001\u6761\u76ee\nneigh := &amp;netlink.Neigh{\nLinkIndex:    contVeth.Attrs().Index,\nState:        netlink.NUD_PERMANENT,\nIP:           gwNet.IP,\nHardwareAddr: hostVeth.Attrs().HardwareAddr,\n}\nif err = createVethContext.netLink.NeighAdd(neigh); err != nil {\nreturn errors.Wrap(err, \"setup NS network: failed to add static ARP\")\n}\n// \u5c06 vethpair \u7684\u4e00\u7aef\u79fb\u52a8\u5230\u4e3b\u673a\u4fa7 network namespace \nif err = createVethContext.netLink.LinkSetNsFd(hostVeth, int(hostNS.Fd())); err != nil {\nreturn errors.Wrap(err, \"setup NS network: failed to move veth to host netns\")\n}\nreturn nil\n}\n</code></pre>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#teardownns","title":"TeardownNS","text":"<p>\u6e05\u7406 pod \u7f51\u7edc\u73af\u5883:</p> <pre><code>func (os *linuxNetwork) TeardownNS(addr *net.IPNet, deviceNumber int, log logger.Logger) error {\nlog.Debugf(\"TeardownNS: addr %s, deviceNumber %d\", addr.String(), deviceNumber)\nreturn tearDownNS(addr, deviceNumber, os.netLink, log)\n}\nfunc tearDownNS(addr *net.IPNet, deviceNumber int, netLink netlinkwrapper.NetLink, log logger.Logger) error {\n...\n// \u5220\u9664 to-pod \u65b9\u5411\u7684\u7b56\u7565\u8def\u7531 \u6267\u884c \"ip rule del\"\ntoContainerRule := netLink.NewRule()\ntoContainerRule.Dst = addr\ntoContainerRule.Priority = toContainerRulePriority\nerr := netLink.RuleDel(toContainerRule)\n...\n// \u5224\u65ad ENI \u662f\u5426\u4e3a Primary ENI,\u5982\u679c\u662f\u975e Primary,\u5219\u540c\u65f6\u5220\u9664 from-pod \u7684\u7b56\u7565\u8def\u7531\nif deviceNumber &gt; 0 {\nerr := deleteRuleListBySrc(*addr)\n...\n}\naddrHostAddr := &amp;net.IPNet{\nIP:   addr.IP,\nMask: net.CIDRMask(32, 32)\n}\n...\nreturn nil\n}\n</code></pre>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"blog/posts/vpc-cni-k8s-cluster/#ipamd","title":"IPAMD","text":"<p><code>IPAMD</code>\u662f\u672c\u5730 ip \u5730\u5740\u6c60\u7ba1\u7406\u8fdb\u7a0b\uff0c\u4ee5<code>daemonset</code>\u7684\u65b9\u5f0f\u8fd0\u884c\u5728\u6bcf\u4e2a worker \u8282\u70b9\u4e0a,\u7ef4\u62a4\u7740\u8282\u70b9\u4e0a\u6240\u6709\u53ef\u7528 ip \u5730\u5740\u3002</p> <p>\u7591\u95ee</p> <p>\u90a3\u4e48,\u95ee\u9898\u6765\u4e86,ip \u5730\u5740\u6c60\u4e2d\u7684\u6570\u636e\u662f\u4ece\u54ea\u91cc\u6765\u7684\u5462\uff1f</p>","tags":["CNI","\u7f51\u7edc","go"]},{"location":"cdi/","title":"CDI\u6982\u89c8","text":""},{"location":"cdi/#cdi_1","title":"\u4ec0\u4e48\u662fCDI","text":"<p>CDI\u5b9a\u4e49</p> <p>Containerized-Data-Importer (CDI) \u662f Kubernetes \u7684\u6301\u4e45\u5b58\u50a8\u7ba1\u7406\u63d2\u4ef6\u3002</p> <p>\u5b83\u7684\u4e3b\u8981\u76ee\u6807\u662f\u5728PVC\u7684\u57fa\u7840\u4e0a\u6784\u5efa kubeVirt VM \u7684\u865a\u62df\u673a\u78c1\u76d8\u8d44\u6e90\uff0c\u5e76\u63d0\u4f9b\u4e00\u79cd\u5c06\u4e0d\u540c\u6570\u636e\u6e90\u7684\u6570\u636e\u586b\u5145\u5230\u6307\u5b9aPVC\u7684\u80fd\u529b\u3002\u8ba9\u7528\u6237\u80fd\u591f\uff1a</p> <ul> <li>\u5bfc\u5165kubeVirt VM\u7684\u955c\u50cf</li> <li>\u521d\u59cb\u5316PVC\uff0c\u5bfc\u5165\u6307\u5b9a\u6570\u636e</li> </ul>"},{"location":"cdi/#_1","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"cdi/#_2","title":"\u8d44\u6e90\u5217\u8868","text":"<p>cdi\u8d44\u6e90\u5206\u4e3a\u4ee5\u4e0b\u51e0\u5927\u7c7b\uff1a</p> <p>DV\u8d44\u6e90</p><p>DataVolume</p> <p>DIC\u8d44\u6e90</p><p>DataImportCron</p> <p>\u5bf9\u8c61\u4f20\u8f93\u8d44\u6e90</p><p>ObjectTransfer</p>"},{"location":"cdi/#_3","title":"\u7279\u6027\u529f\u80fd","text":"<p>cdi\u5177\u5907\u4ee5\u4e0b\u7279\u6027\u529f\u80fd\uff1a</p> <ul> <li>\u5377\u7ba1\u7406</li> <li>\u78c1\u76d8\u7ba1\u7406</li> </ul>"},{"location":"cdi/#_4","title":"\u5377\u7ba1\u7406","text":"<p>\u70ed\u63d2\u62d4\u5377</p><p>Hotplug Volume</p>"},{"location":"cdi/quick-learn/","title":"\u5feb\u901f\u4e86\u89e3","text":""},{"location":"cdi/quick-learn/#cdi","title":"\u5982\u4f55\u4f7f\u7528CDI","text":"<p>\u4e0b\u9762\u4e00\u5f20\u56fe\u6211\u4eec\u53ef\u4ee5\u4e86\u89e3CDI\u80fd\u591f\u505a\u4ec0\u4e48\uff1a</p> <p></p> <p>\u6211\u4eec\u628aCDI\u5f53\u6210\u4e00\u4e2a\u9ed1\u76d2\uff0c\u7ad9\u5728\u4f7f\u7528\u8005\u7684\u89d2\u5ea6\u6765\u89c2\u5bdf\u5b83\u3002\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u4f7f\u7528CDI\uff0c\u5206\u522b\u662f\uff1a</p> <ul> <li>\u5728PVC\u4e0a\u6dfb\u52a0<code>annotation</code></li> <li>\u521b\u5efa<code>DataVolume</code>\uff08CDI\u65b0\u589e\u7684CRD\uff09\u5b9e\u4f8b</li> </ul> <p>CDI\u59cb\u7ec8\u505a\u4ee5\u4e0b\u4e8b\u60c5\uff1a</p> <ul> <li>\u76d1\u542c\u5230PVC\u7684<code>annotation</code>\u6216\u8005<code>DataVolume</code></li> <li>\u6839\u636e\u5b9a\u4e49\uff0c\u4ece\u6307\u5b9a\u7684<code>Source</code>\uff0c\u5c06VM Image\u6216\u8005\u5176\u4ed6\u6570\u636e\u5bfc\u5165\u5230PVC\u4e2d</li> </ul> <p>\u901a\u8fc7<code>DataVolume</code>\u4f7f\u7528CDI\u7684\u65b9\u5f0f\uff0c\u53ef\u4ee5\u901a\u8fc7\u7248\u672c\u7ba1\u7406API\u63a5\u53e3\uff0c\u4fbf\u4e8e\u5176\u4ed6\u9879\u76ee\uff08\u4f8b\u5982\uff1akubevirt\uff09\u4e0e\u4e4b\u96c6\u6210\uff0c\u53ea\u9700\u8981\u6307\u5b9a\u7279\u5b9a\u7248\u672c\u7684<code>DataVolume</code>\u5373\u53ef\uff0c\u6240\u6709\u5bf9<code>DataVolume</code>\u7684\u4fee\u6539\u90fd\u5c06\u4f53\u73b0\u5728\u65b0\u7684API\u7248\u672c\u4e0a\u3002</p> <p>\u5982\u679c\u5bf9<code>DataVolume</code>\u7684\u6570\u636e\u7ed3\u6784\u611f\u5174\u8da3\u53ef\u4ee5\u524d\u5f80DataVolume\u3002</p>"},{"location":"cdi/features/hotplug-volume/","title":"\u70ed\u63d2\u62d4\u5377","text":"<p>\u5728\u4f7f\u7528\u865a\u62df\u673a\u65f6\uff0c\u4f1a\u6709\u56e0\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u9700\u8981\u5916\u6302\u5b58\u50a8\u5377\u7684\u64cd\u4f5c\uff08\u5f53\u7136\u4e5f\u6709\u53cd\u5411\u7684\u64cd\u4f5c\uff0c\u5373\u5378\u8f7d\u5b58\u50a8\u5377\uff09\uff0c\u672c\u6587\u6211\u4eec\u6765\u4e86\u89e3\u4e0bkubevirt\u5bf9\u8fd0\u884c\u4e2d\u7684\u865a\u62df\u673a\u52a8\u6001\u64cd\u4f5c\u5b58\u50a8\u5377\u7684\u5b9e\u73b0\uff0c\u4e5f\u5c31\u662f\u70ed\u63d2\u62d4\u5b58\u50a8\u5377\u3002</p>"},{"location":"cdi/features/hotplug-volume/#_1","title":"\u70ed\u63d2\u62d4\u5377\u4ecb\u7ecd","text":"<p>\u70ed\u63d2\u62d4\u5377\u5b9a\u4e49</p> <p><code>hotplug volume</code>\u70ed\u63d2\u62d4\u5377\uff0c\u70ed\u63d2\u62d4\u5728\u8fd9\u91cc\u6307\u7684\u662f\u865a\u62df\u673a\u5728\u4e0d\u5173\u673a\u65ad\u7535\u7684\u60c5\u51b5\u652f\u6301\u63d2\u5165\u6216\u8005\u62d4\u51fa\u5377\u800c\u4e0d\u5f71\u54cd\u865a\u62df\u673a\u7684\u6b63\u5e38\u5de5\u4f5c\u3002</p> <p>kubeVirt\u5c01\u88c5\u4e86<code>virtctl addvolume</code>\u548c<code>virtctl removevolume</code>\u4e24\u4e2a\u547d\u4ee4\u6765\u652f\u6301\u70ed\u63d2\u62d4\u5377\u3002</p> <p>kubeVirt\u652f\u6301\u8fd0\u884c\u4e2d\u7684vmi\u5b9e\u4f8b\u4f7f\u7528\u70ed\u63d2\u62d4\u5377\uff0c\u4f46\u662f\u5377\u5fc5\u987b\u662f\u5757\u8bbe\u5907\uff08block volume\uff09\u6216\u8005\u5305\u542b\u4e00\u4e2a\u78c1\u76d8\u955c\u50cf\uff08disk image\uff09\u3002\u5f53\u4e00\u4e2a\u6709\u70ed\u63d2\u62d4\u5377\u7684vm\uff08\u6ce8\u610f\u662fvm\uff09\u5b9e\u4f8b\u91cd\u542f\uff08reboot\uff09\u540e\uff0c\u70ed\u63d2\u62d4\u5377\u4f1aattach\u5230\u8be5vm\u4e2d\u3002\u5982\u679c\u6b64\u65f6\u5377\u5b58\u5728\u7684\u8bdd\uff0c\u70ed\u63d2\u62d4\u5377\u4f1a\u6210\u4e3a<code>vm spec</code>\u4e0b\u7684\u4e00\u90e8\u5206\uff0c\u6b64\u65f6\u4e0d\u4f1a\u88ab\u5f53\u505a\u70ed\u63d2\u62d4\u5377\u3002\u5982\u679c\u6b64\u65f6\u4e0d\u5b58\u5728\uff0c\u8fd9\u4e2a\u5377\u5219\u4f1a\u4f5c\u4e3a\u70ed\u63d2\u62d4\u5377\u91cd\u65b0attach\u3002</p>"},{"location":"cdi/features/hotplug-volume/#hotplug-volume","title":"\u4f7f\u80fd hotplug volume","text":"<p>\u8981\u4f7f\u7528\u70ed\u63d2\u62d4\u5377\u529f\u80fd\uff0c\u5fc5\u987b\u6253\u5f00\u76f8\u5e94\u914d\u7f6e\u5f00\u5173\uff0c\u5373\u5728kubeVirt\u8fd9\u4e2aCR\u4e2d\u6dfb\u52a0<code>HotplugVolume</code>\u914d\u7f6e\u9879\u3002</p>"},{"location":"cdi/features/hotplug-volume/#virtctl","title":"virtctl \u652f\u6301","text":"<p>\u4e3a\u4e86\u70ed\u63d2\u62d4\u5377\u529f\u80fd\uff0c\u9996\u5148\u5fc5\u987b\u51c6\u5907\u597d\u4e00\u4e2a\u5377\uff0c\u8fd9\u4e2a\u5377\u53ef\u4ee5\u662f\u88ab<code>DataVolume</code>\uff08DV\uff0ckubeVirt\u7684\u4e00\u4e2aCRD\uff09\u521b\u5efa\u3002\u4e3a\u4e86\u6dfb\u52a0\u989d\u5916\u7684\u5b58\u50a8\u5230\u4e00\u4e2a\u8fd0\u884c\u4e2d\u7684vmi\u5b9e\u4f8b\u4e2d\uff0c\u6211\u4eec\u5728\u793a\u4f8b\u4e2d\u4f7f\u7528\u4e00\u4e2a\u7a7a\u7684DV\u3002</p> <pre><code>apiVersion: cdi.kubevirt.io/v1beta1\nkind: DataVolume\nmetadata:\nname: example-volume-hotplug\nspec:\nsource:\nblank: {}\npvc:\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 5Gi\n</code></pre> <p>\u5728\u8fd9\u4e2a\u793a\u4f8b\u4e2d\u6211\u4eec\u4f7f\u7528<code>ReadWriteOnce</code>\u8bbf\u95ee\u6a21\u5f0f\u548c\u9ed8\u8ba4\u7684FileSystem\u5377\u6a21\u5f0f\u3002\u53ea\u8981\u7528\u6237\u7684\u5b58\u50a8\u652f\u6301\u7ec4\u5408\uff0c\u70ed\u63d2\u62d4\u5377\u5c31\u652f\u6301\u6240\u6709\u5757\u8bbe\u5907\u5377\u6a21\u5f0f\u548c<code>ReadWriteMany</code>/<code>ReadWriteOnce</code>/<code>ReadOnlyMany</code>\u8bbf\u95ee\u6a21\u5f0f\u7684\u7ec4\u5408\u3002</p>"},{"location":"cdi/features/hotplug-volume/#_2","title":"\u6dfb\u52a0\u5377","text":"<p>\u5047\u8bbe\u5f53\u524d\u6211\u4eec\u5df2\u7ecf\u542f\u52a8\u4e86\u4e00\u4e2avmi\u5b9e\u4f8b\uff0c\u800c\u4e14\u8fd9\u4e2avmi\u5b9e\u4f8b\u7684\u540d\u79f0\u53eb\u201c<code>vmi-fedora</code>\u201d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>virtctl addvolume</code>\u547d\u4ee4\u6dfb\u52a0\u4e0a\u8ff0\u7a7a\u767d\u5377\u5230\u8fd9\u4e2a\u8fd0\u884c\u4e2d\u7684\u865a\u62df\u673a\u4e2d\u3002</p> <pre><code>$ virtctl addvolume vmi-fedora --volume-name=example-volume-hotplug\n</code></pre>"},{"location":"cdi/features/hotplug-volume/#_3","title":"\u5e8f\u5217\u53f7","text":"<p>\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>\u2013serial</code>\u53c2\u6570\u4fee\u6539\u78c1\u76d8\u7684\u5e8f\u5217\u53f7\uff1a</p> <pre><code>$ virtctl addvolume vmi-fedora --volume-name=example-volume-hotplug --serial=1234567890\n</code></pre> <p>\u8fd9\u4e2a\u5e8f\u5217\u53f7\u53ea\u5728guest\uff08\u5373\u865a\u62df\u673a\uff09\u4e2d\u4f7f\u7528\uff0c\u5728\u865a\u62df\u673a\u4e2d\uff0c\u78c1\u76d8by-id\u4f1a\u5305\u542b\u8fd9\u4e2a\u5e8f\u5217\u53f7\uff1a</p> <pre><code>$ virtctl console vmi-fedora\n\nFedora 32 (Cloud Edition)\nKernel 5.6.6-300.fc32.x86_64 on an x86_64 (ttyS0)\nSSH host key: SHA256:c8ik1A9F4E7AxVrd6eE3vMNOcMcp6qBxsf8K30oC/C8 (ECDSA)\nSSH host key: SHA256:fOAKptNAH2NWGo2XhkaEtFHvOMfypv2t6KIPANev090 (ED25519)\neth0: 10.244.196.144 fe80::d8b7:51ff:fec4:7099\nvmi-fedora login:fedora\nPassword:fedora\n[fedora@vmi-fedora ~]$ ls /dev/disk/by-id\nscsi-0QEMU_QEMU_HARDDISK_1234567890\n[fedora@vmi-fedora ~]$ </code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5e8f\u5217\u53f7\u662f\u78c1\u76d8\u540d\u79f0\u7684\u4e00\u90e8\u5206\uff0c\u53ef\u4ee5\u5229\u7528\u8be5\u5e8f\u5217\u53f7\u6765\u552f\u4e00\u8bc6\u522b\u3002\u5e8f\u5217\u53f7\u7684\u683c\u5f0f\u548c\u957f\u5ea6\u5728libvirt\u6587\u6863\u4e2d\u6709\u8bf4\u660e\uff1a</p> <pre><code>If present, this specify serial number of virtual hard drive. For example, it may look like &lt;serial&gt;WD-WMAP9A966149&lt;/serial&gt;. Not supported for scsi-block devices, that is those using disk type 'block' using device 'lun' on bus 'scsi'. Since 0.7.1\n\nNote that depending on hypervisor and device type the serial number may be truncated silently. IDE/SATA devices are commonly limited to 20 characters. SCSI devices depending on hypervisor version are limited to 20, 36 or 247 characters.\n\nHypervisors may also start rejecting overly long serials instead of truncating them in the future so it's advised to avoid the implicit truncation by testing the desired serial length range with the desired device and hypervisor combination.\n</code></pre>"},{"location":"cdi/features/hotplug-volume/#virtio-scsi","title":"\u4e3a\u4ec0\u4e48\u662fvirtio-scsi?","text":"<p>\u70ed\u63d2\u62d4\u78c1\u76d8\u7c7b\u578b\u88ab\u6307\u5b9a\u4e3a<code>scsi</code>\u78c1\u76d8\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u50cf\u666e\u901a\u7684\u78c1\u76d8\u4e00\u6837\u6307\u5b9a\u4e3a<code>virtio</code>\u7c7b\u578b\uff1f\u539f\u56e0\u662f<code>virtio</code>\u78c1\u76d8\u7684\u6570\u91cf\u9650\u5236\uff0c\u56e0\u4e3a\u5728\u865a\u62df\u673a\u91cc\uff0c\u6bcf\u4e00\u4e2a \u78c1\u76d8\u90fd\u4f1a\u4f7f\u7528\u4e00\u4e2a<code>PCIe</code>\u69fd\uff0c\u800c<code>PCIe</code>\u69fd\u7684\u6570\u91cf\u4e0a\u9650\u662f32\uff0c\u518d\u52a0\u4e0a\u4e00\u4e9b\u5176\u5b83\u8bbe\u5907\u4e5f\u4f1a\u4f7f\u7528PCIe\u69fd\uff0c\u56e0\u6b64\u7528\u6237\u53ef\u70ed\u63d2\u62d4\u78c1\u76d8\u7684\u6570\u91cf\u975e\u5e38\u6709\u9650\u3002\u53e6\u4e00\u4e2a\u95ee\u9898\u662f\u8fd9\u4e9b\u70ed\u63d2\u62d4\u69fd\u9700\u8981\u63d0\u524d\u9884\u7559\uff0c\u56e0\u4e3a\u5982\u679c\u4e8b\u5148\u4e0d\u77e5\u9053\u70ed\u63d2\u62d4\u78c1\u76d8\u7684\u6570\u91cf\uff0c\u5219\u65e0\u6cd5\u6b63\u786e\u4fdd\u7559\u6240\u9700\u7684\u63d2\u69fd\u6570\u91cf\u3002\u4e3a\u4e86\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\uff0c\u6bcf\u4e00\u4e2avm\u90fd\u6709\u4e00\u4e2a<code>virtio-scsi</code>\u63a7\u5236\u5668\uff08controller\uff09\uff0c\u5b83\u5141\u8bb8\u70ed\u63d2\u62d4\u78c1\u76d8\u4f7f\u7528<code>scsi</code>\u603b\u7ebf\u3002\u8fd9\u4e2a\u63a7\u5236\u5668\u5141\u8bb8\u70ed\u63d2\u62d4\u8d85\u8fc7400W\u4e2a\u78c1\u76d8\uff0c\u800c\u4e14<code>virtio-scsi</code>\u7684\u6027\u80fd\u548c<code>virtio</code>\u6027\u80fd\u4e5f\u975e\u5e38\u63a5\u8fd1\u3002</p>"},{"location":"cdi/features/hotplug-volume/#_4","title":"\u91cd\u542f\u4e4b\u540e\u4fdd\u7559\u70ed\u63d2\u62d4\u5377","text":"<p>\u5728\u8bb8\u591a\u573a\u666f\u4e0b\u90fd\u671f\u671bvm\u91cd\u542f\u540e\u80fd\u4fdd\u7559\u70ed\u63d2\u62d4\u5377\uff0c\u5f53\u7136\u4e5f\u671f\u671b\u5728\u91cd\u542f\u540e\u80fd\u652f\u6301\u62d4\u51fa\uff08unplug\uff09\u70ed\u63d2\u62d4\u5377\u3002\u914d\u7f6e<code>persist</code>\u53c2\u6570\u865a\u62df\u673a\u91cd\u542f\u540e\u4e0d\u80fd\u5378\u4e0b\u4e4b\u524d\u7684\u70ed\u63d2\u62d4\u5377\uff0c\u5982\u679c\u6ca1\u6709\u58f0\u660e<code>persist</code>\u53c2\u6570\uff0c\u9ed8\u8ba4\u662f\u5728vm\u91cd\u542f\u540e\u4f1a\u4ee5\u70ed\u63d2\u62d4\u5377\u7684\u5f62\u5f0f\u4fdd\u7559\u63d2\u62d4\u5377\u3002\u56e0\u6b64\u5927\u90e8\u5206\u65f6\u5019<code>persist</code>\u53c2\u6570\u90fd\u4e0d\u7528\u914d\u7f6e\uff0c\u9664\u975e\u4f60\u60f3\u865a\u62df\u673a\u91cd\u542f\u540e\u628a\u8fd9\u4e2a\u5377\u4f5c\u4e3a\u4e00\u4e2a\u6301\u4e45\u5316\u7684\u5377\u3002</p>"},{"location":"cdi/features/hotplug-volume/#_5","title":"\u6301\u4e45\u5316","text":"<p>\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u7528\u6237\u5e0c\u671bvm\u91cd\u542f\u540e\u4e4b\u524d\u7684\u70ed\u63d2\u62d4\u5377\u80fd\u4f5c\u4e3avm\u7684\u4e00\u4e2a\u6807\u51c6\u78c1\u76d8\uff0c\u4f8b\u5982\u4f60\u5411vm\u6dfb\u52a0\u4e86\u4e00\u4e9b\u6c38\u4e45\u5b58\u50a8\u3002\u6211\u4eec\u5047\u8bbe\u6b63\u5728\u8fd0\u884c\u7684vmi\u5177\u6709\u5b9a\u4e49\u5176\u89c4\u8303\u5339\u914d\u7684vm\u5bf9\u8c61\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528<code>\u2013persistent</code>\u6807\u5fd7\u8c03\u7528<code>addvolume</code>\u547d\u4ee4\u3002\u9664\u4e86\u66f4\u65b0vmi domain\u78c1\u76d8\u5916\uff0c\u8fd9\u5c06\u66f4\u65b0vm domain\u78c1\u76d8\u90e8\u5206\u3002\u8fd9\u610f\u5473\u7740\u5f53\u60a8\u91cd\u65b0\u542f\u52a8vm\u65f6\uff0c\u78c1\u76d8\u5df2\u7ecf\u5728vm\u4e2d\u5b9a\u4e49\uff0c\u56e0\u6b64\u5728\u65b0\u7684vmi\u4e2d\u4e5f\u4f1a\u5b9a\u4e49\u3002</p> <pre><code>$ virtctl addvolume vm-fedora --volume-name=example-volume-hotplug --persist\n</code></pre> <p>\u5728vm spec\u5b57\u6bb5\u4e2d\u4f1a\u663e\u793a\u6210\u4e00\u4e2a\u65b0\u7684\u78c1\u76d8\uff1a</p> <pre><code>spec:\ndomain:\ndevices:\ndisks:\n- disk:\nbus: virtio\nname: containerdisk\n- disk:\nbus: virtio\nname: cloudinitdisk\n- disk:\nbus: scsi\nname: example-volume-hotplug\nmachine:\ntype: \"\"\n</code></pre>"},{"location":"cdi/features/hotplug-volume/#_6","title":"\u5378\u8f7d\u70ed\u63d2\u62d4\u5377","text":"<p>\u4f7f\u7528\u70ed\u63d2\u62d4\u5377\u540e\uff0c\u53ef\u4ee5\u4f7f\u7528<code>virtctl removevolume</code>\u547d\u4ee4\u5c06\u70ed\u63d2\u62d4\u5377\u62d4\u51fa\uff1a</p> <pre><code>$ virtctl removevolume vmi-fedora --volume-name=example-volume-hotplug\n</code></pre> <p>Note</p> <p>\u53ea\u80fd\u5378\u4e0b\u4f7f\u7528<code>virtctl addvolume</code>\u547d\u4ee4\u6216\u8005\u8c03API\u63a5\u53e3\u6dfb\u52a0\u7684\u70ed\u63d2\u62d4\u5377\u3002</p>"},{"location":"cdi/features/hotplug-volume/#_7","title":"\u5377\u7684\u72b6\u6001","text":"<p>vmi\u5bf9\u8c61\u6709\u4e00\u4e2a\u65b0\u7684<code>status.VolumeStatus</code>\u5b57\u6bb5\uff0c\u8fd9\u662f\u4e00\u4e2a\u5305\u542b\u6bcf\u4e2a\u78c1\u76d8\u7684\u6570\u7ec4\uff08\u4e0d\u7ba1\u78c1\u76d8\u662f\u5426\u662f\u70ed\u63d2\u62d4\uff09\u3002\u4f8b\u5982\uff0c\u5728<code>addvolume</code>\u793a\u4f8b\u4e2d\u70ed\u63d2\u62d4\u5377\u540e\uff0cvmi\u72b6\u6001\u5c06\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>volumeStatus:\n- name: cloudinitdisk\ntarget: vdb\n- name: containerdisk\ntarget: vda\n- hotplugVolume:\nattachPodName: hp-volume-7fmz4\nattachPodUID: 62a7f6bf-474c-4e25-8db5-1db9725f0ed2\nmessage: Successfully attach hotplugged volume volume-hotplug to VM\nname: example-volume-hotplug\nphase: Ready\nreason: VolumeReady\ntarget: sda\n</code></pre> <p><code>vda</code>\u662f\u5305\u542b<code>Fedora OS</code>\u7684\u5bb9\u5668\u78c1\u76d8\uff0c<code>vdb</code>\u662f<code>cloudinit</code>\u78c1\u76d8\uff0c\u6b63\u5982\u4f60\u6240\u770b\u5230\u7684\uff0c\u5b83\u4eec\u53ea\u5305\u542b\u5728\u5c06\u5b83\u4eec\u5206\u914d\u7ed9vm\u65f6\u4f7f\u7528\u7684\u540d\u79f0\u548c\u76ee\u6807\uff08target\uff09\u3002\u76ee\u6807\u662f\u6307\u5b9a\u78c1\u76d8\u65f6\u4f20\u9012\u7ed9qemu\u7684\u503c\uff0c\u8be5\u503c\u5bf9\u4e8evm\u662f\u552f\u4e00\u7684\uff0c\u4e0d\u4ee3\u8868guest\uff08\u865a\u62df\u673a\uff09\u5185\u90e8\u7684\u547d\u540d\u3002\u4f8b\u5982\uff0c\u5bf9\u4e8eWindows\u865a\u62df\u673a\u64cd\u4f5c\u7cfb\u7edf\uff0ctarget\u6ca1\u6709\u610f\u4e49\uff0c\u70ed\u63d2\u62d4\u5377\u4e5f\u4e00\u6837\u3002target\u53ea\u662fqemu\u7684\u552f\u4e00\u6807\u8bc6\u7b26\uff0c\u5728guest\u4e2d\u53ef\u4ee5\u4e3a\u78c1\u76d8\u5206\u914d\u4e0d\u540c\u7684\u540d\u79f0\u3002</p> <p>\u70ed\u63d2\u62d4\u5377\u6709\u4e00\u4e9b\u5e38\u89c4\u5377\u72b6\u6001\u6ca1\u6709\u7684\u989d\u5916\u4fe1\u606f\u3002<code>attachPodName</code>\u662f\u7528\u4e8e\u5c06\u5377attach\u5230vmi\u8fd0\u884c\u7684\u8282\u70b9\u7684pod\u7684\u540d\u79f0\u3002\u5982\u679c\u5220\u9664\u6b64pod\uff0c\u5b83\u4e5f\u5c06\u505c\u6b62vmi\uff0c\u6b64\u65f6kubeVirt\u65e0\u6cd5\u4fdd\u8bc1\u5377\u5c06\u7ee7\u7eedattach\u5230\u8282\u70b9\u3002\u5176\u4ed6\u5b57\u6bb5\u4e0econditions\u7c7b\u4f3c\uff0c\u8868\u793a\u70ed\u63d2\u62d4\u8fc7\u7a0b\u7684\u72b6\u6001\u3002\u4e00\u65e6\u5377\u5c31\u7eea\uff0cvm\u5c31\u53ef\u4ee5\u4f7f\u7528\u5b83\u3002</p>"},{"location":"cdi/resource/dataImportCron/","title":"DIC\u8d44\u6e90","text":""},{"location":"cdi/resource/dataImportCron/#_1","title":"\u6982\u5ff5","text":"<p>DataImportCron\u5b9a\u4e49</p> <p>DataImportCron \u5b9a\u4e49\u4e86\u4e00\u4e2a cronjob\uff0c\u7528\u4e8e\u5b9a\u671f\u8f6e\u8be2/\u5c06\u78c1\u76d8\u6620\u50cf\u4f5c\u4e3a PVC \u5bfc\u5165\u5230\u9ec4\u91d1\u6620\u50cf\u547d\u540d\u7a7a\u95f4\u4e2d\u3002</p>"},{"location":"cdi/resource/dataVolume/","title":"DV\u8d44\u6e90","text":""},{"location":"cdi/resource/dataVolume/#datavolume","title":"DataVolume","text":"<p>DataVolume\u5b9a\u4e49</p> <p>CDI \u81ea\u5b9a\u4e49\u4e86CRD <code>DataVolume</code> \u4f5c\u4e3aK8S\u6807\u51c6PVC\u4e4b\u4e0a\u7684\u62bd\u8c61\uff0c\u5f53\u7528\u6237\u521b\u5efa <code>DataVolume</code> \u8d44\u6e90\u65f6\u63a7\u5236\u5668\u4f1a\u81ea\u52a8\u4e3a\u5176\u521b\u5efaPVC\uff0c\u5e76\u586b\u5145\u6570\u636e\u3002</p> <p>\u76ee\u524d\u652f\u6301\u4ee5\u4e0b\u6570\u636e\u6e90\uff1a</p> <ul> <li>URL (HTTP)</li> <li>Container Registry (Registry)</li> <li>\u5176\u4ed6PVC (PVC)</li> <li>\u4ece\u5ba2\u6237\u7aef\u4e0a\u4f20 (Upload)</li> <li>\u521b\u5efa\u7a7a\u767d\u78c1\u76d8 (Blank)</li> <li>\u4ece<code>oVirt/VMWare</code>\u7684API (Imageio\u548cVDDK)</li> </ul> <p>\u652f\u6301\u4e00\u4e0b\u4e24\u79cd\u6570\u636e\u7c7b\u578b\uff1a</p> <ul> <li>kubeVirt\uff1a\u8fd9\u79cd\u7c7b\u578b\u7684\u6570\u636e\uff0c\u88ab\u8ba4\u4e3a\u662f\u78c1\u76d8\u955c\u50cf\uff01cdi\u4f1a\u81ea\u52a8\u4e3a\u5176\u8f6c\u6362\u6570\u636e\u683c\u5f0f\uff08\u5982 <code>QCOW2 -&gt; Raw</code>\uff09,\u5e76\u8c03\u6574\u5176\u865a\u62df\u7a7a\u95f4\u7684\u5927\u5c0f\u3002</li> <li>archive\uff1atar\u5305\u683c\u5f0f\u7684\u6570\u636e\uff0ccdi\u4f1a\u5c06\u5176\u4e2d\u7684\u5185\u5bb9\u81ea\u52a8\u89e3\u538b\u7f29\u5230\u6307\u5b9a\u7684\u5377\u4e2d\u3002</li> </ul> <p>Warning</p> <p>\u6ce8\u610f\uff0c\u7279\u5b9a\u6570\u636e\u6e90\u53ea\u80fd\u5904\u7406\u7279\u5b9a\u683c\u5f0f\u7684\u6570\u636e\uff0c\u5173\u7cfb\u5982\u4e0b\uff1a</p> <ul> <li>http \u2192 kubevirt, archive</li> <li>registry \u2192 kubevirt</li> <li>pvc \u2192 Not applicable - content is cloned</li> <li>upload \u2192 kubevirt</li> <li>imageio \u2192 kubevirt</li> <li>vddk \u2192 kubevirt</li> </ul>"},{"location":"cdi/resource/dataVolume/#_1","title":"\u6570\u636e\u6e90","text":""},{"location":"cdi/resource/dataVolume/#http-source","title":"HTTP Source","text":"<p>\u521b\u5efa HTTP Source \u7c7b\u578b\u7684\u6e90\u65f6\uff0cCDI \u57fa\u4e8e<code>qemu-img</code> \u5de5\u5177\u5de5\u4f5c\uff0c\u652f\u6301\u7684\u955c\u50cf\u683c\u5f0f\u4e3b\u8981\u5305\u62ec\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ul> <li>VMDK\uff1aVMWare \u955c\u50cf\u7684\u683c\u5f0f</li> <li>VDI\uff1aVirtualBox \u955c\u50cf\u683c\u5f0f</li> <li>VHD\uff1aHyper-V \u955c\u50cf\u7684\u683c\u5f0f</li> <li>QCOW2/QCOW</li> <li>RAW</li> </ul>"},{"location":"cdi/resource/dataVolume/#upload-source","title":"Upload Source","text":"<p>Upload Source\u6570\u636e\u6e90\u53ef\u4ee5\u63d0\u4f9bAPI\u63a5\u53e3\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u6570\u636e\u76f4\u63a5\u63a8\u9001\u5230\u8be5\u63a5\u53e3\uff0c<code>upload</code>\u7684\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <ol> <li>\u7ba1\u7406\u5458\u90e8\u7f72\u4e86<code>cdi-uploadproxy</code>\uff0c\u5e76\u66b4\u9732\u5230\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u7684\u7f51\u7edc\u4e0a</li> <li>\u7528\u6237\u521b\u5efa<code>DataVolume</code></li> <li>\u7528\u6237\u521b\u5efa<code>UploadTokenRequest</code></li> <li>\u7528\u6237\u4f7f\u7528<code>curl</code>\u7b49\u7f51\u7edc\u5de5\u5177\u643a\u5e26<code>token</code>\u4e0a\u4f20\u955c\u50cf\u6216\u8005\u5176\u4ed6\u6570\u636e</li> </ol> <p>\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\uff1a</p> <p>\u7528\u6237\u9700\u8981\u5c06<code>cdi-uploadproxy</code>\u670d\u52a1\u7684svc\u66b4\u9732\u5230Kubernetes\u96c6\u7fa4\u4e4b\u5916\uff1a</p> <p>cdi-uploadproxy-nodeport.yaml<pre><code>apiVersion: v1\nkind: Service\nmetadata:\nname: cdi-uploadproxy-nodeport\nnamespace: cdi\nlabels:\ncdi.kubevirt.io: \"cdi-uploadproxy\"\nspec:\ntype: NodePort\nports:\n- port: 443\ntargetPort: 8443\nnodePort: 31001\nprotocol: TCP\nselector:\ncdi.kubevirt.io: cdi-uploadproxy\n</code></pre> \u5e76\u6267\u884c</p> <pre><code>kubectl apply -f cdi-uploadproxy-nodeport.yaml\n</code></pre> <p>\u624b\u5de5\u521b\u5efaDV, \u5e76\u5c06source\u6307\u5b9a\u4e3a<code>upload</code>\uff0c</p> <pre><code>apiVersion: cdi.kubevirt.io/v1beta1\nkind: DataVolume\nmetadata:\nname: upload-datavolume\nspec:\nsource:\nupload: {}\npvc:\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 500Mi\n</code></pre> <p>\u521b\u5efaUpload Token\uff0c\u96c6\u7fa4\u521b\u5efa\u4ee5\u4e0bServiceAccount\uff0c\u5e76\u7ed1\u5b9a\u76f8\u5173\u6743\u9650</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\nname: cdi-uploadtokenrequests\nnamespace: cdi\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\nname: cdi-uploadtokenrequests\nrules:\n- apiGroups:\n- \"upload.cdi.kubevirt.io\"\nresources:\n- 'uploadtokenrequests'\nverbs:\n- '*'\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\nname: ruijie:openplatform:openplatform-controller\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: cdi-uploadtokenrequests\nsubjects:\n- kind: ServiceAccount\nname: cdi-uploadtokenrequests\nnamespace: cdi\n</code></pre> <p>\u521b\u5efa\u7684<code>cdi-uploadtokenrequests</code>\u540e\uff0c\u5728cdi\u7684\u547d\u540d\u7a7a\u95f4\u4e0b\u4f1a\u81ea\u52a8\u521b\u5efa<code>secret</code>\uff0c\u540d\u79f0\u683c\u5f0f\u4e3a\uff1a<code>cdi-uploadtokenrequests-token-xxx</code> \uff0cdescribe\u8be5<code>secret</code>\u4e2d\u7684<code>token</code>\u5b57\u6bb5\uff0c\u53ef\u4ee5\u83b7\u53d6\u7528\u4e8e\u4e0a\u4f20\u7684UploadToken\uff1a</p> <p>POST\u8bf7\u6c42</p> <p>POST\uff1a<code>/apis/upload.cdi.kubevirt.io/v1beta1/namespaces/{namespace}/uploadtokenrequests</code></p> <p>\u6709\u4e24\u79cd\u65b9\u5f0f\u4e0a\u4f20\uff0c\u4e00\u79cd\u662f<code>json</code>\u505aBODY, \u53e6\u4e00\u79cd\u662f\u7528\u8d44\u6e90\u6e05\u5355<code>yaml</code>\u6587\u4ef6\u53d1POST\u8bf7\u6c42\u3002</p> jsonyaml upload-datavolume-token.json<pre><code>{\n\"apiVersion\": \"upload.cdi.kubevirt.io/v1beta1\",\n\"kind\": \"UploadTokenRequest\",\n\"metadata\": {\n\"name\": \"DV\u540d\u79f0\",\n\"namespace\": \"default\",\n\"spec\": {\n\"pvcName\": \"DV\u540d\u79f0\"\n}\n}\n}\n</code></pre> <p>\u8fd4\u56de\u4fe1\u606f <pre><code>{\n\"kind\": \"UploadTokenRequest\",\n\"apiVersion\": \"upload.cdi.kubevirt.io/v1beta1\",\n\"metadata\": {\n\"name\": \"upload-datavolume\",\n\"namespace\": \"default\",\n\"creationTimestamp\": null\n},\n\"spec\": {\n\"pvcName\": \"\"\n},\n\"status\": {\n\"token\": \"UPLOADTOKEN\"\n}\n}\n</code></pre></p> upload-datavolume-token.yaml<pre><code>apiVersion: upload.cdi.kubevirt.io/v1beta1\nkind: UploadTokenRequest\nmetadata:\nname: DV\u540d\u79f0\nnamespace: default\nspec:\npvcName: DV\u540d\u79f0\n</code></pre> <p>describe\u4e00\u4e0b<code>uploadTokenRequest</code>\uff0c</p> <p><pre><code>apiVersion: upload.cdi.kubevirt.io/v1beta1\nkind: UploadTokenRequest\nmetadata:\nannotations:\nkubectl.kubernetes.io/last-applied-configuration: |\n{\"apiVersion\":\"upload.cdi.kubevirt.io/v1beta1\",\"kind\":\"UploadTokenRequest\",\"metadata\":{\"annotations\":{},\"name\":\"DV\u540d\u79f0\",\"namespace\":\"default\"},\"spec\":{\"pvcName\":\"DV\u540d\u79f0\"}}\ncreationTimestamp: null\nname: DV\u540d\u79f0\nnamespace: default\nspec:\npvcName: DV\u540d\u79f0\nstatus:\ntoken: eyJhbGciOiJQUzUxMiIsImtpZCI6IiJ9.eyJwdmNOYW1lIjoidXBsb2FkLXRlc3QiLCJuYW1lc3BhY2UiOiJkZWZhdWx0IiwiY3JlYXRpb25UaW1lc3RhbXAiOiIyMDE4LTA5LTIxVDE4OjEyOjE5LjQwODI1MDQ4NFoifQ.JWk1VyvzSse3eFiBROKgGoLnOPCiYW9JdDWKXFROEL6XY0O5lFb1R0rwdfWwC3BBOtEA9mC9x3ZGYPnYWO-5G_r1fWKHjF-zifrCX_3Dhp3vfSq6Zfpu-vV0Qn0A3YkSCCmiC_nONAhVjEDuQsRFIKwYcxBoEOpye92ggH2u5FxQE7FwxxH6-RHun9tc_lIFX-ZFKnq7n5tWbjsTmAZI_4rDNgYkVFhFtENU6e-5_Ncokxs3YVzkbSrXweZpRmmaYQOmZhjXSLjKED_2FVq7tYeVueEEhKC_zJ-AEivstALPwPjiwyWXJyfE3dCmbA1sBKuNUrAaDlBvSAp1uPV9eQ\n</code></pre> \u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u76f4\u63a5\u83b7\u53d6<code>UPLOADTOKEN</code>\uff0c <pre><code>UPLOADTOKEN=$(kubectl apply -f upload-datavolume-token.yaml -o=\"jsonpath={.status.token}\")\n</code></pre></p> <p>\u901a\u8fc7<code>curl</code>\u4e0a\u4f20\u6570\u636e\u5230<code>datavolume</code>\uff0c</p> <pre><code># \u540c\u6b65\u4e0a\u4f20\ncurl -v --insecure -H \"Authorization: Bearer $UPLOADTOKEN\" --data-binary @tests/images/cirros-qcow2.img https://$(minikube ip):31001/v1alpha1/upload\n\n# \u5f02\u6b65\u4e0a\u4f20\ncurl -v --insecure -H \"Authorization: Bearer $UPLOADTOKEN\" --data-binary @tests/images/cirros-qcow2.img https://$(minikube ip):31001/v1alpha1/upload-async\n</code></pre>"},{"location":"cdi/resource/objectTransfer/","title":"\u5bf9\u8c61\u4f20\u8f93\u8d44\u6e90","text":""},{"location":"cdi/resource/objectTransfer/#_1","title":"\u6982\u8ff0","text":"<p>\u5bf9\u8c61\u4f20\u8f93 API \u5141\u8bb8\u5728\u547d\u540d\u7a7a\u95f4\u4e4b\u95f4\u903b\u8f91\u79fb\u52a8 <code>PersistentVolumeClaims</code> \u548c <code>DataVolume</code>\u3002 \u5b83\u901a\u8fc7\u7ef4\u62a4 Kubernetes API \u8d44\u6e90\u6765\u5b9e\u73b0\u6b64\u76ee\u7684\uff0c\u5e76\u4e14\u4e0d\u4f1a\u79fb\u52a8\u5377\u4e0a\u7684\u4efb\u4f55\u7269\u7406\u6570\u636e\u3002 \u6b64 API \u7531 CDI \u63a7\u5236\u5668\u5185\u90e8\u4f7f\u7528\uff0c\u4ee5\u4fc3\u8fdb <code>DataVolume</code> \u7684\u9ad8\u6548\u8de8\u547d\u540d\u7a7a\u95f4\u514b\u9686\u3002 \u96c6\u7fa4\u7ba1\u7406\u5458\u8fd8\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5bf9\u8c61\u4f20\u8f93 API\u3002 \u9274\u4e8e\u4ee5\u4e0b\u6e05\u5355\uff1a</p> <pre><code>apiVersion: cdi.kubevirt.io/v1beta1\nkind: ObjectTransfer\nmetadata:\nname: t1\nspec:\nsource:\nkind: PersistentVolumeClaim\nnamespace: source\nname: source-pvc\ntarget:\nnamespace: destintation\nname: destination-pvc\n</code></pre> <p>\u547d\u540d\u7a7a\u95f4\u6e90\u4e2d\u7684 PersistentVolumeClaim <code>source-pvc</code> \u5c06\u79fb\u52a8\u5230\u5177\u6709\u7ed9\u5b9a\u540d\u79f0<code>destination-pvc</code> \u7684\u547d\u540d\u7a7a\u95f4\u76ee\u6807\u3002</p> <p>\u6ce8\u610f</p> <p>\u8bf7\u6ce8\u610f\uff0c\u8fd9\u662f\u96c6\u7fa4\u8303\u56f4\u7684\u8d44\u6e90\u3002</p>"},{"location":"cdi/resource/objectTransfer/#_2","title":"\u4f20\u8f93\u64cd\u4f5c","text":"<p>\u6267\u884c\u4e0a\u9762\u7684<code>ObjectTransfer</code>\u65f6\u4f1a\u53d1\u751f\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ol> <li>\u5982\u679c\u5c1a\u672a\u5c06\u7ed1\u5b9a\u5230 (<code>source-pv</code>) \u7684 PersistentVolume <code>source-pvc</code> \u8bbe\u7f6e\u4e3a <code>Retain</code></li> <li><code>source-pvc</code> \u5df2\u5220\u9664</li> <li><code>source-pv</code> ClaimRef \u8bbe\u7f6e\u4e3a<code>destination\\destination-pvc</code></li> <li>\u5220\u9664\u4e4b\u524d\u4f7f\u7528\u4e0e<code>source-pvc</code> \u76f8\u540c\u7684\u89c4\u683c\u521b\u5efa<code>destination-pvc</code></li> </ol>"},{"location":"edge-computing/","title":"\u8fb9\u7f18\u8ba1\u7b97\u6982\u89c8","text":""},{"location":"edge-computing/#_2","title":"\u7814\u53d1\u80cc\u666f","text":"<p>\u8fb9\u7f18\u8ba1\u7b97\u7684\u63d0\u51fa\u80cc\u666f\u3002\u7269\u8054\u7f51\u3001\u5de5\u4e1a\u4e92\u8054\u7f51\u3001\u8f66\u8054\u7f51\u3001\u589e\u5f3a\u73b0\u5b9e\u3001\u865a\u62df\u73b0\u5b9e\u30014K/8K\u9ad8\u6e05\u89c6\u9891\u7b49\u4e30\u5bcc\u65b0\u578b\u4e1a\u52a1\u5e94\u7528\u7684\u5feb\u901f\u6d8c\u73b0\uff0c\u5bf9\u7f51\u7edc\u7684\u4f20\u8f93\u5bb9\u91cf\u3001\u6570\u636e\u5206\u53d1\u548c\u5904\u7406\u80fd\u529b\u7b49\u63d0\u51fa\u4e86\u8d8a\u6765\u8d8a\u9ad8\u7684\u8981\u6c42\u3002\u540c\u65f6\uff0c\u5e94\u7528\u670d\u52a1\u7684\u8fdb\u4e00\u6b65\u53d1\u5c55\u4ea7\u751f\u4e86\u6d77\u91cf\u7684\u8fde\u63a5\u548c\u6570\u636e\u3002\u53e6\u5916\uff0c\u7ec8\u7aef\u7528\u6237\u4e5f\u8d8a\u6765\u8d8a\u6e34\u671b\u83b7\u5f97\u66f4\u9ad8\u4f53\u9a8c\u8d28\u91cf\u7684\u7f51\u7edc\u670d\u52a1\uff0c\u5e76\u613f\u610f\u4e3a\u6b64\u4ed8\u51fa\u66f4\u591a\u7684\u8d39\u7528\u3002\u4f20\u7edf\u4e91\u8ba1\u7b97\u6a21\u578b\u5df2\u7ecf\u65e0\u6cd5\u6709\u6548\u5e94\u5bf9\u5feb\u901f\u589e\u52a0\u7684\u6570\u636e\u91cf\u3001\u66f4\u9ad8\u7684\u6570\u636e\u4f20\u8f93\u5e26\u5bbd\u9700\u6c42\u3001\u65b0\u578b\u5e94\u7528\u6570\u636e\u5904\u7406\u66f4\u9ad8\u7684\u5b9e\u65f6\u6027\u8981\u6c42\u3002\u56e0\u6b64\uff0c\u5fc5\u987b\u5bf9\u7f51\u7edc\u8fdb\u884c\u67b6\u6784\u4e0a\u7684\u8c03\u6574\uff0c\u4ee5\u6ee1\u8db3\u8d85\u5927\u8fde\u63a5\u3001\u8d85\u4f4e\u65f6\u5ef6\u4ee5\u53ca\u8d85\u5927\u5e26\u5bbd\u7b49\u4e1a\u52a1\u9700\u6c42\u3002\u4e3a\u4e86\u5e94\u5bf9\u4e0a\u8ff0\u6311\u6218\uff0c\u4e1a\u754c\u63d0\u51fa\u5728\u7f51\u7edc\u8fb9\u7f18\u63d0\u4f9b\u8ba1\u7b97\u5904\u7406\u4e0e\u6570\u636e\u5b58\u50a8\u7b49\u80fd\u529b\uff0c\u5373\u8fb9\u7f18\u8ba1\u7b97\uff0c\u4ee5\u8fbe\u5230\u5728\u7f51\u7edc\u8fb9\u7f18\u5411\u7528\u6237\u63d0\u4f9b\u4f18\u8d28\u670d\u52a1\u7684\u76ee\u7684\u3002</p>"},{"location":"edge-computing/#_3","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"edge-computing/#_4","title":"\u5feb\u901f\u4e86\u89e3","text":"<p>\u5386\u53f2\u80cc\u666f</p><p>History Background</p>"},{"location":"edge-computing/#_5","title":"\u5f00\u6e90\u9879\u76ee","text":"<p>KubeEdge</p><p>KubeEdge</p>"},{"location":"edge-computing/get-started/background/","title":"\u5386\u53f2\u80cc\u666f","text":"<p>1946\u5e74\u5728\u7f8e\u56fd\u5bbe\u5915\u6cd5\u5c3c\u4e9a\u5927\u5b66\uff0c\u7535\u5b50\u6676\u4f53\u7ba1\u8ba1\u7b97\u673aENIAC\u643a170\u5e73\u65b9\u7c73\u300118000\u4e2a\u6676\u4f53\u7ba1\u7684\u5e9e\u5927\u8eab\u8eaf\u6084\u7136\u95ee\u4e16\uff0c\u4f5c\u4e3a\u8ba1\u7b97\u7684\u8f7d\u4f53\uff0c\u5f00\u542f\u4e86\u73b0\u4ee3\u8ba1\u7b97\u673a\u7684\u53d1\u5c55\u4e4b\u8def\u3002</p> <p>\u6b64\u540e\uff0c\u6676\u4f53\u7ba1\u4ee3\u66ff\u4e86\u7535\u5b50\u7ba1\uff0c\u96c6\u6210\u7535\u8def\u4ee3\u66ff\u4e86\u6676\u4f53\u7ba1\uff0c\u8ba1\u7b97\u673a\u7684\u53d1\u5c55\u6cbf\u7740\u6469\u5c14\u5b9a\u5f8b\u7684\u8f68\u9053\u4e00\u8def\u72c2\u5954\uff0c\u4ece\u5de8\u5927\u7684\u673a\u623f\u4e00\u6b65\u6b65\u8d70\u8fdb\u4e86\u5343\u5bb6\u4e07\u6237\uff0c\u767b\u4e0a\u4e86\u5c0f\u5c0f\u7684\u684c\u9762\uff0c\u751a\u81f3\u4f5c\u4e3a\u53ef\u7a7f\u6234\u5d4c\u5165\u5f0f\u8bbe\u5907\u6210\u4e3a\u4eba\u4f53\u7684\u4e00\u90e8\u5206\u3002\u4f34\u968f\u8fd9\u4e00\u8fc7\u7a0b\uff0c\u8d8a\u6765\u8d8a\u591a\u7684\u7269\u7406\u4e16\u754c\u9700\u6c42\u88ab\u8f6c\u5316\u4e3a\u8ba1\u7b97\u9700\u6c42\uff0c\u8ba1\u7b97\u7684\u5f62\u6001\u4e5f\u7ecf\u5386\u4e86\u51e0\u6b21\u91cd\u8981\u53d8\u5316\u3002</p>"},{"location":"edge-computing/get-started/background/#_1","title":"\u5171\u4eab\u5230\u72ec\u5360","text":"<p>\u5728\u8ba1\u7b97\u673a\u53d1\u5c55\u521d\u671f\uff0c\u7531\u4e8e\u9ad8\u6602\u7684\u6210\u672c\uff0c\u8ba1\u7b97\u673a\u4e3b\u8981\u7528\u4e8e\u5927\u578b\u79d1\u5b66\u5b9e\u9a8c\uff0c\u51e0\u4e4e\u4e0d\u5b58\u5728\u73b0\u4ee3\u610f\u4e49\u7684\u4e2a\u4eba\u8ba1\u7b97\u673a\u3002\u56e0\u6b64\uff0c\u6b64\u65f6\u7684\u8ba1\u7b97\u8fc7\u7a0b\u5f80\u5f80\u662f\u5f88\u591a\u7528\u6237\u91c7\u7528\u5206\u65f6\u7684\u65b9\u5f0f\u5171\u4eab\u4e00\u53f0\u8ba1\u7b97\u673a\uff0c\u8fd9\u4e00\u9700\u6c42\u4e5f\u9020\u5c31\u4e86\u540e\u6765\u4eba\u4eec\u719f\u77e5\u7684UNIX\u7cfb\u7edf\u548c\u7c7bUNIX\u7cfb\u7edf\u3002</p> <p>\u867d\u7136\u6b64\u65f6\u6240\u6709\u7684\u8ba1\u7b97\u9700\u6c42\u662f\u5728\u5927\u578b\u673a\u201c\u672c\u5730\u201d\u6267\u884c\u7684\uff0c\u4f46\u5176\u4efb\u52a1\u6765\u6e90\u901a\u5e38\u662f\u591a\u4e2a\u7528\u6237\uff0c\u8d44\u6e90\u4e5f\u662f\u7531\u591a\u7528\u6237\u5171\u4eab\u7684\u3002\u56e0\u6b64\u4ece\u8ba1\u7b97\u6a21\u5f0f\u7684\u89d2\u5ea6\u800c\u8a00\uff0c\u5927\u578b\u673a\u7684\u8ba1\u7b97\u91c7\u7528\u4e86\u591a\u7528\u6237\u5171\u4eab\u7684\u6a21\u5f0f\u3002</p> <p>\u800c\u968f\u7740\u96c6\u6210\u7535\u8def\u7684\u51fa\u73b0\uff0c\u8ba1\u7b97\u673a\u4f53\u79ef\u6cbf\u7740\u201c\u6469\u5c14\u5b9a\u5f8b\u201d\u7684\u8f68\u8ff9\u4e0d\u65ad\u7f29\u5c0f\uff0c\u8ba1\u7b97\u6210\u672c\u4e0d\u65ad\u964d\u4f4e\uff0c\u4f7f\u5f97\u7528\u6237\u9010\u6e10\u80fd\u591f\u901a\u8fc7\u4e2a\u4eba\u8ba1\u7b97\u673a\u6765\u6ee1\u8db3\u5404\u7c7b\u8ba1\u7b97\u548c\u6570\u636e\u5b58\u50a8\u7684\u9700\u6c42\uff0c\u8ba1\u7b97\u7684\u5f62\u6001\u4e5f\u4ece\u591a\u7528\u6237\u5206\u65f6\u5171\u4eab\u4e3a\u4e3b\u6d41\u53d8\u4e3a\u4e86\u72ec\u5360\u8d44\u6e90\u7684\u4e2a\u4eba\u8ba1\u7b97\u673a\u4e3a\u4e3b\u6d41\u3002</p>"},{"location":"edge-computing/get-started/background/#_2","title":"\u672c\u5730\u5230\u4e91\u7aef","text":"<p>\u968f\u7740\u8ba1\u7b97\u673a\u7f51\u7edc\u548c\u901a\u4fe1\u6280\u672f\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u8ba1\u7b97\u673a\u518d\u4e5f\u4e0d\u4ec5\u4ec5\u662f\u6570\u636e\u5b58\u50a8\u548c\u8fd0\u7b97\u7684\u8f7d\u4f53\uff0c\u800c\u662f\u627f\u62c5\u4e86\u8d8a\u6765\u8d8a\u591a\u7684\u4fe1\u606f\u4f20\u8f93\u548c\u4ea4\u4e92\u4efb\u52a1\u3002\u4e0e\u6b64\u540c\u65f6\uff0c\u667a\u80fd\u624b\u673a\u3001\u4ea4\u4e92\u5f0fWeb\u670d\u52a1\u3001\u793e\u4ea4\u7f51\u7edc\u7684\u51fa\u73b0\u548c\u666e\u53ca\uff0c\u4f7f\u5f97\u5927\u91cf\u7684\u7528\u6237\u4fe1\u606f\u7531\u672c\u5730\u8fc1\u79fb\u5230\u7f51\u7edc\u670d\u52a1\u5668\u5f53\u4e2d\u3002</p> <p>\u4f34\u968f\u7740\u201c\u4fe1\u606f\u7f51\u7edc\u5316\u201d\u8fd9\u4e00\u8fc7\u7a0b\uff0c\u5728\u6570\u636e\u88ab\u5e26\u5230\u7f51\u7edc\u670d\u52a1\u5668\u4e0a\u7684\u540c\u65f6\uff0c\u4e00\u90e8\u5206\u8fd0\u7b97\u8fc7\u7a0b\u4e5f\u88ab\u5e26\u5230\u4e86\u670d\u52a1\u5668\u4e0a\uff0c\u4f8b\u5982\u7f51\u7ad9\u6258\u7ba1\u3001\u63a8\u8350\u7b97\u6cd5\u3001\u5404\u7c7b\u5728\u7ebf\u670d\u52a1\u7b49\u3002\u4e0d\u4ec5\u5982\u6b64\uff0c\u968f\u7740\u901a\u4fe1\u548c\u7f51\u7edc\u6280\u672f\u7684\u4e0d\u65ad\u53d1\u5c55\uff0c\u8d8a\u6765\u8d8a\u591a\u7684\u8ba1\u7b97\u4e1a\u52a1\u5f97\u4ee5\u901a\u8fc7\u7f51\u7edc\u5b9e\u73b0\uff0c\u4ece\u800c\u4e00\u6b65\u6b65\u5f62\u6210\u4e86\u5982\u4eca\u4e91\u8ba1\u7b97\u7684\u5f62\u6001\u3002</p>"},{"location":"edge-computing/get-started/background/#_3","title":"\u4e91\u7aef\u5230\u8fb9\u7f18","text":"<p>\u968f\u7740\u667a\u80fd\u624b\u673a\u3001\u53ef\u7a7f\u6234\u8bbe\u5907\u7b49\u667a\u80fd\u5316\u8ba1\u7b97\u8bbe\u5907\u7684\u666e\u53ca\uff0c\u4ee5\u53ca\u9ad8\u6e05\u89c6\u9891\u3001\u4eba\u5de5\u667a\u80fd\u7b97\u6cd5\u7b49\u9700\u6c42\u7684\u6d8c\u73b0\uff0c\u5404\u7c7b\u6e38\u620f\u3001\u5e94\u7528\u3001\u89c6\u9891\u4e1a\u52a1\u5bf9\u4e8e\u6570\u636e\u548c\u5b9e\u65f6\u6027\u7684\u8981\u6c42\u8d8a\u6765\u8d8a\u9ad8\uff0c\u4f8b\u5982\u98ce\u9761\u4e00\u65f6\u7684\u589e\u5f3a\u73b0\u5b9e\uff08Augmented Reality\uff0cAR\uff09\u6e38\u620f\u53e3\u888b\u5996\u602a\uff08Pokemon Go\uff09\uff0c\u5bf9\u6444\u50cf\u5934\u5b9e\u65f6\u91c7\u96c6\u7684\u56fe\u50cf\u8fdb\u884c\u8bc6\u522b\u548c\u5904\u7406\uff0c\u5e76\u5728\u8bc6\u522b\u51fa\u7684\u76ee\u6807\u4f4d\u7f6e\u663e\u793a\u4e0d\u540c\u79cd\u7c7b\u7684\u201c\u53e3\u888b\u5996\u602a\u201d\u3002</p> <p>\u5bf9\u4e8e\u6b64\u7c7b\u5e94\u7528\u4e1a\u52a1\uff0c\u4e00\u65b9\u9762\u672c\u5730\u8ba1\u7b97\u4f1a\u51fa\u73b0\u80fd\u529b\u4e0d\u8db3\u6216\u8005\u7535\u91cf\u6d88\u8017\u8fc7\u5feb\u7684\u95ee\u9898\uff1b\u53e6\u4e00\u65b9\u9762\u82e5\u91c7\u7528\u4e91\u8ba1\u7b97\u67b6\u6784\uff0c\u5219\u65e0\u6cd5\u8fbe\u5230\u6e38\u620f\u7684\u5ef6\u8fdf\u8981\u6c42\uff0c\u4e0d\u4ec5\u5982\u6b64\uff0c\u5f53\u5e94\u7528\u89c4\u6a21\u6269\u5927\u65f6\uff0c\u4e91\u8ba1\u7b97\u67b6\u6784\u4e2d\u7f51\u7edc\u5e26\u5bbd\u5c06\u4f1a\u6210\u4e3a\u74f6\u9888\uff0c\u96be\u4ee5\u652f\u6491\u6765\u81ea\u6d77\u91cf\u524d\u7aef\u8bbe\u5907\u7684\u5927\u89c4\u6a21\u5b9e\u65f6\u8ba1\u7b97\u548c\u6570\u636e\u8bf7\u6c42\u3002</p> <p>\u5373\u4fbf\u5bf9\u4e8e\u5b9e\u65f6\u6027\u8981\u6c42\u4e0d\u9ad8\u7684\u4f20\u7edf\u4e1a\u52a1\uff0c\u8d8a\u6765\u8d8a\u591a\u7684\u8bbe\u5907\u63a5\u5165\u7f51\u7edc\uff0c\u4e5f\u4f1a\u4f7f\u5f97\u4e91\u8ba1\u7b97\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4e0d\u582a\u91cd\u8d1f\uff0c\u751a\u81f3\u4f7f\u5f97\u4e91\u8ba1\u7b97\u4e2d\u5fc3\u6210\u4e3a\u8bb8\u591a\u5730\u533a\u80fd\u6e90\u6d88\u8017\u7684\u6700\u5927\u6765\u6e90\u3002</p> <p>\u4e0e\u6b64\u540c\u65f6\uff0c\u968f\u77405G/6G\u3001Wi-Fi\u7b49\u901a\u4fe1\u6280\u672f\u548c\u6807\u51c6\u7684\u5feb\u901f\u53d1\u5c55\uff0c\u7528\u6237\u7aef\u5230\u7f51\u7edc\u63a5\u5165\u7aef\u7684\u76f4\u63a5\u5ef6\u8fdf\u53ef\u4ee5\u964d\u5230\u4e2a\u4f4d\u6570\u6beb\u79d2\u7ea7\u3002\u6b64\u65f6\u6211\u4eec\u53d1\u73b0\uff0c\u5728\u4e91\u8ba1\u7b97\u67b6\u6784\u4e2d\uff0c\u6570\u636e\u4ece\u63a5\u5165\u70b9\u5230\u4e91\u8ba1\u7b97\u4e2d\u5fc3\u7684\u4f20\u8f93\u8fc7\u7a0b\u5df2\u7ecf\u5360\u636e\u4e86\u7edd\u5927\u90e8\u5206\u7684\u5ef6\u8fdf\u3002\u8003\u8651\u5230\u4e92\u8054\u7f51\u6570\u636e\u9700\u8981\u7ecf\u8fc7\u4e3b\u5e72\u7f51\u591a\u7ea7\u8def\u7531\u7684\u8fc7\u7a0b\uff0c\u8fd9\u4e00\u5ef6\u8fdf\u51e0\u4e4e\u65e0\u53ef\u907f\u514d\u3002</p> <p>\u56e0\u6b64\uff0c\u8ba1\u7b97\u8d44\u6e90\u4ece\u4e91\u4e2d\u5fc3\u4e0b\u964d\u5230\u9760\u8fd1\u7528\u6237\u7684\u7f51\u7edc\u8fb9\u7f18\u8bbe\u5907\uff08\u5982\u79fb\u52a8\u65e0\u7ebf\u57fa\u7ad9\u3001\u5bb6\u7528\u8def\u7531\u7b49\uff09\uff0c\u5219\u6210\u4e3a\u5b9e\u73b0\u5927\u89c4\u6a21\u5b9e\u65f6\u8ba1\u7b97\u7684\u5fc5\u7136\u8981\u6c42\u3002\u5982\u6b64\uff0c\u4e0d\u4ec5\u5f7b\u5e95\u907f\u514d\u4e86\u5e7f\u57df\u7f51\u4e2d\u7684\u6570\u636e\u4f20\u8f93\u5ef6\u8fdf\uff0c\u4e5f\u63d0\u5347\u4e86\u6570\u636e\u7684\u9690\u79c1\u5b89\u5168\u7ea7\u522b\u3001\u8bbf\u95ee\u6548\u7387\u4ee5\u53ca\u670d\u52a1\u90e8\u7f72\u548c\u7ba1\u7406\u7684\u7075\u6d3b\u6027\u3002</p>"},{"location":"edge-computing/kubeEdge/","title":"KubeEdge\u6982\u89c8","text":"<p>KubeEdge \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u7cfb\u7edf\uff0c\u53ef\u5c06\u672c\u673a\u5bb9\u5668\u5316\u5e94\u7528\u7f16\u6392\u548c\u7ba1\u7406\u6269\u5c55\u5230\u8fb9\u7f18\u7aef\u8bbe\u5907\u3002\u5b83\u57fa\u4e8e Kubernetes \u6784\u5efa\uff0c\u4e3a\u7f51\u7edc\u548c\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u6838\u5fc3\u57fa\u7840\u67b6\u6784\u652f\u6301\uff0c\u5e76\u5728\u4e91\u7aef\u548c\u8fb9\u7f18\u7aef\u90e8\u7f72\u5e94\u7528\uff0c\u540c\u6b65\u5143\u6570\u636e\u3002KubeEdge \u8fd8\u652f\u6301 MQTT \u534f\u8bae\uff0c\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u7f16\u5199\u5ba2\u6237\u903b\u8f91\uff0c\u5e76\u5728\u8fb9\u7f18\u7aef\u542f\u7528\u8bbe\u5907\u901a\u4fe1\u7684\u8d44\u6e90\u7ea6\u675f\u3002KubeEdge \u5305\u542b\u4e91\u7aef\u548c\u8fb9\u7f18\u7aef\u4e24\u90e8\u5206\u3002</p> <p>\u4f7f\u7528 KubeEdge\uff0c\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u5c06\u5df2\u6709\u7684\u590d\u6742\u673a\u5668\u5b66\u4e60\u3001\u56fe\u50cf\u8bc6\u522b\u3001\u4e8b\u4ef6\u5904\u7406\u548c\u5176\u4ed6\u9ad8\u7ea7\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u8fb9\u7f18\u7aef\u5e76\u8fdb\u884c\u4f7f\u7528\u3002 \u968f\u7740\u4e1a\u52a1\u903b\u8f91\u5728\u8fb9\u7f18\u7aef\u4e0a\u8fd0\u884c\uff0c\u53ef\u4ee5\u5728\u672c\u5730\u4fdd\u62a4\u548c\u5904\u7406\u5927\u91cf\u6570\u636e\u3002 \u901a\u8fc7\u5728\u8fb9\u7f18\u7aef\u5904\u7406\u6570\u636e\uff0c\u54cd\u5e94\u901f\u5ea6\u4f1a\u663e\u8457\u63d0\u9ad8\uff0c\u5e76\u4e14\u53ef\u4ee5\u66f4\u597d\u5730\u4fdd\u62a4\u6570\u636e\u9690\u79c1\u3002</p>"},{"location":"gpu/","title":"GPU\u6982\u89c8","text":""},{"location":"gpu/#_1","title":"\u7814\u53d1\u80cc\u666f","text":"<p>\u968f\u7740AI\u6280\u672f\u7684\u53d1\u5c55\uff0c\u8d1d\u58f3\u5185\u90e8\u4e5f\u6709\u8d8a\u6765\u8d8a\u591a\u7684\u573a\u666f\u4f7f\u7528\u5230\u4e86\u673a\u5668\u5b66\u4e60\u7b97\u6cd5\u63d0\u4f9b\u670d\u52a1\uff0c\u5982\u6bcf\u5929\u4e0a\u73ed\u7684\u4eba\u8138\u8bc6\u522b\u3001\u5bb6\u88c5\u73b0\u573a\u7684\u9c7c\u773c\u76d1\u63a7\u3001\u7ecf\u7eaa\u4eba\u7684\u8bed\u97f3\u8bc6\u522b\u4ee5\u53ca\u4ea4\u6613\u8fc7\u7a0b\u4e2d\u7684\u56fe\u7247\u548c\u6587\u672c\u8bc6\u522b\u7b49\u3002\u673a\u5668\u5b66\u4e60\u6a21\u578b\u4ece\u5f00\u53d1\u5230\u5e94\u7528\u7684\u57fa\u672c\u6d41\u7a0b\u5982\u56fe1\u6240\u793a\uff0c\u57fa\u672c\u53ef\u4ee5\u5206\u4e3a\u6570\u636e\u51c6\u5907\uff0c\u6a21\u578b\u5f00\u53d1\uff0c\u6a21\u578b\u5e94\u7528\u7b49\u4e09\u4e2a\u5927\u9636\u6bb5\uff0c\u5176\u4e2d\u6a21\u578b\u5f00\u53d1\u7684\u8bad\u7ec3\u548c\u6a21\u578b\u5e94\u7528\u7684\u63a8\u7406\u9636\u6bb5\u6d89\u53ca\u5927\u91cf\u7684\u77e9\u9635\u8fd0\u7b97\uff0c\u7279\u522b\u662f\u6df1\u5ea6\u5b66\u4e60\u6a21\u578b\u3002\u56e0\u6b64\u5728\u8fd9\u4e9b\u573a\u666f\u4e2d\u4f1a\u4f7f\u7528\u5bf9\u77e9\u9635\u8fd0\u7b97\u5177\u6709\u5929\u751f\u4f18\u52bf\u7684GPU\u8bbe\u5907\u6765\u52a0\u901f\u3002</p> <p>\u4f46\u662f\u5e76\u4e0d\u662f\u6240\u6709\u9636\u6bb5\u90fd\u9700\u8981\u5927\u91cfGPU\u7b97\u529b\u652f\u6301\uff0c\u5982\u5728\u7b97\u6cd5\u5de5\u7a0b\u5e08\u8c03\u8bd5\u6a21\u578b\u9636\u6bb5\uff0cGPU\u4e3b\u8981\u7528\u4e8e\u9a8c\u8bc1\u6a21\u578b\u662f\u5426\u5408\u7406\uff0c\u9a8c\u8bc1\u4e4b\u540e\u7684\u8bad\u7ec3\u624d\u9700\u8981\u5927\u91cf\u7684\u7b97\u529b\uff1b\u5728\u6a21\u578b\u63a8\u7406\u9884\u6d4b\u65f6\u53ea\u6709\u524d\u5411\u4f20\u64ad\u8ba1\u7b97\u3002\u8fd9\u4e9b\u573a\u666f\u4e0b\u5982\u679c\u72ec\u5360\u4e00\u5f20GPU\u5361\u4f1a\u5bfc\u81f4\u8d44\u6e90\u5229\u7528\u7387\u5f88\u4f4e\uff0c\u540c\u65f6\uff0c\u7ebf\u4e0a\u670d\u52a1\u53c8\u5177\u5907\u6ce2\u5cf0\u548c\u6ce2\u8c37\u7684\u60c5\u51b5\uff0c\u4f1a\u8fdb\u4e00\u6b65\u964d\u4f4e\u8d44\u6e90\u5229\u7528\u7387\uff0c\u9020\u6210\u8d44\u6e90\u6d6a\u8d39\uff0c\u589e\u5927AI\u670d\u52a1\u6210\u672c\u3002</p>"},{"location":"gpu/#_2","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"gpu/#_3","title":"\u5feb\u901f\u4e86\u89e3","text":"<p>GPU\u4ecb\u7ecd</p><p>Terminologies</p> <p>GPU\u865a\u62df\u5316</p><p>GPU Virtualization</p> <p>cGPU\u865a\u62df\u5316</p><p>cGPU Virtualization</p>"},{"location":"gpu/#operators","title":"Operators","text":"<p>GPU Operator</p><p>NVIDIA GPU Operator</p>"},{"location":"gpu/gpu/cgpuVirt/","title":"cGPU\u865a\u62df\u5316","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u8fd9\u91cc\u8c08\u5230\u7684\uff0c\u90fd\u662f nVidia \u751f\u4ea7\u7684 GPU\u3001\u90fd\u53ea\u8003\u8651 CUDA \u8ba1\u7b97\u573a\u666f\u3002\u5176\u6b21\uff0c\u8fd9\u91cc\u7684\u865a\u62df\u5316\u6307\u7684\u662f OS \u865a\u62df\u5316\u7684\u5bb9\u5668\u6280\u672f\uff0c\u4e0d\u9002\u7528\u4e8e KATA \u8fd9\u6837\u7684\u3001\u57fa\u4e8e\u7cfb\u7edf\u865a\u62df\u5316\u7684\u5b89\u5168\u5bb9\u5668\u3002</p> <p>\u5176\u6b21\uff0c\u6211\u4eec\u7684\u6280\u672f\u76ee\u6807\u5c31\u662f\u5e0c\u671b\uff1a</p> <ul> <li>\u5403\u5e72\u69a8\u5c3d\u6240\u6709\u8d44\u6e90</li> <li>\u8986\u76d6\u6240\u6709\u4e1a\u52a1\u573a\u666f</li> <li>\u63d0\u5347\u4e1a\u52a1\u603b\u4f53\u8868\u73b0</li> </ul>"},{"location":"gpu/gpu/cgpuVirt/#cuda","title":"CUDA\u7684\u751f\u6001","text":"<p>CUDA \u5f00\u53d1\u8005\u4f7f\u7528\u7684\uff0c\u901a\u5e38\u662f CUDA Runtime API\uff0c\u5b83\u662f high-level \u7684\uff1b\u800c CUDA Driver API \u5219\u662f low-level \u7684\uff0c\u5b83\u5bf9\u7a0b\u5e8f\u548c GPU \u786c\u4ef6\u6709\u66f4\u7cbe\u7ec6\u7684\u63a7\u5236\u3002Runtime API \u662f\u5bf9 Driver API \u7684\u5c01\u88c5\u3002</p> <p>CUDA Driver \u5373\u662f <code>UMD</code>\uff0c\u5b83\u76f4\u63a5\u548c <code>KMD</code> \u6253\u4ea4\u9053\u3002\u4e24\u8005\u90fd\u5c5e\u4e8e NVIDIA Driver package\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684 ABI\uff0c\u662f NVIDIA Driver package \u5185\u90e8\u7684\uff0c\u4e0d\u5bf9\u5916\u516c\u5f00\u3002</p> <p>\u82f1\u4f1f\u8fbe\u8f6f\u4ef6\u751f\u6001\u5c01\u95ed\uff1a</p> <ul> <li>\u65e0\u8bba\u662f nvidia.ko\uff0c\u8fd8\u662f <code>libcuda.so</code>\uff0c\u8fd8\u662f <code>libcudart</code>\uff0c\u90fd\u662f\u88ab\u5265\u79bb\u4e86\u7b26\u53f7\u8868\u7684</li> <li>\u5927\u591a\u6570\u51fd\u6570\u540d\u662f\u52a0\u5bc6\u66ff\u6362\u4e86\u7684</li> <li>\u5176\u5b83\u7684\u53cd\u8c03\u8bd5\u3001\u53cd\u9006\u5411\u624b\u6bb5</li> </ul> <p>\u4ee5 <code>nvidia.ko</code> \u4e3a\u4f8b\uff0c\u4e3a\u4e86\u517c\u5bb9\u4e0d\u540c\u7248\u672c\u7684 Linux \u5185\u6838 API\uff0c\u5b83\u63d0\u4f9b\u4e86\u76f8\u5f53\u4e30\u5bcc\u7684\u517c\u5bb9\u5c42\uff0c\u4e8e\u662f\u4e5f\u5c31\u5f00\u6e90\u4e86\u90e8\u5206\u4ee3\u7801:</p> <p></p> <p>\u5176\u4e2d\u8fd9\u4e2a 26M \u5927\u5c0f\u7684\u3001\u88ab\u5265\u79bb\u4e86\u7b26\u53f7\u8868\u7684 <code>nv-kernel.o_binary</code>\uff0c\u5c31\u662f GPU \u9a71\u52a8\u7684\u6838\u5fc3\u4ee3\u7801\uff0c\u6240\u6709\u7684 GPU \u786c\u4ef6\u7ec6\u8282\u90fd\u85cf\u5728\u5176\u4e2d\u3002</p>"},{"location":"gpu/gpu/cgpuVirt/#vcudacgpu","title":"vCUDA\u548c\u53cb\u5546cGPU","text":"<p>\u4e3a\u4e86\u8ba9\u591a\u4e2a\u5bb9\u5668\u53ef\u4ee5\u5171\u4eab\u540c\u4e00\u4e2a GPU\uff0c\u4e3a\u4e86\u9650\u5b9a\u6bcf\u4e2a\u5bb9\u5668\u80fd\u4f7f\u7528\u7684 GPU \u4efd\u989d\uff0c\u4e1a\u754c\u51fa\u73b0\u4e86\u4e0d\u540c\u7684\u65b9\u6848\uff0c\u5178\u578b\u7684\u5982 vCUDA \u548c cGPU\uff1a</p> <p>vCUDA\u67b6\u6784:</p> <p></p> <p>cGPU \u67b6\u6784\uff1a</p> <p></p> <p>\u4e24\u8005\u7684\u5b9e\u73b0\u7b56\u7565\u4e0d\u540c\uff0ccGPU \u6bd4 vCUDA \u66f4\u5e95\u5c42\uff0c\u4ece\u800c\u5b9e\u73b0\u4e86\u4e0d\u4fb5\u5165\u7528\u6237\u73af\u5883\u3002</p>"},{"location":"gpu/gpu/cgpuVirt/#gpu","title":"GPU\u6c60\u5316","text":"<p>\u4ee5 CUDA API \u8f6c\u53d1\u7684\u6c60\u5316\u65b9\u6848\u3001\u4e1a\u754c\u67d0\u4ea7\u54c1\u4e3a\u4f8b\uff0c\u5b83\u5230\u4e86 GPU \u6240\u5728\u7684\u540e\u7aef\u673a\u5668\u4e0a\uff0c\u7531\u4e8e\u4e00\u4e2a GPU \u5361\u53ef\u80fd\u8fd0\u884c\u591a\u4e2a GPU \u4efb\u52a1\uff0c\u8fd9\u4e9b\u4efb\u52a1\u4e4b\u95f4\uff0c\u4f9d\u7136\u9700\u8981\u6709\u7b97\u529b\u9694\u79bb\u3002\u5b83\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e00\u70b9\uff0c\u5728\u540e\u7aef\u9ed8\u8ba4\u542f\u7528\u4e86 nVidia MPS \u2014\u2014 \u4e5f\u5c31\u662f\u6545\u969c\u9694\u79bb\u6700\u5dee\u7684\u65b9\u6848\u3002\u8fd9\u4f1a\u5bfc\u81f4\u4ec0\u4e48\uff1f\u4e00\u4e2a VM \u91cc\u7684 CUDA \u7a0b\u5e8f\u8d8a\u754c\u8bbf\u95ee\u4e86\u663e\u5b58\uff0c\u4e00\u5806\u98ce\u9a6c\u725b\u4e0d\u76f8\u53ca\u7684 VM \u91cc\u7684 CUDA \u5e94\u7528\u5c31\u4f1a\u88ab\u6740\u6b7b\u3002</p> <p>\u6240\u4ee5\uff0c\u5f88\u663e\u7136\uff0cGPU \u6c60\u5316\u4e5f\u5fc5\u987b\u4ee5\u540c\u65f6\u6ee1\u8db3\u6545\u969c\u9694\u79bb\u548c\u7b97\u529b\u9694\u79bb\u7684\u65b9\u6848\u4f5c\u4e3a\u57fa\u7840\u3002</p>"},{"location":"gpu/gpu/cgpuVirt/#_1","title":"\u7b97\u529b\u9694\u79bb","text":""},{"location":"gpu/gpu/gpuVirt/","title":"GPU\u865a\u62df\u5316","text":""},{"location":"gpu/gpu/gpuVirt/#pciegpu","title":"\u4f5c\u4e3aPCIe\u8bbe\u5907\u7684GPU","text":"<p>\u4e0d\u8003\u8651\u5d4c\u5165\u5f0f\u5e73\u53f0\u7684\u8bdd\uff0c\u90a3\u4e48\uff0cGPU \u9996\u5148\u662f\u4e00\u4e2a PCIe \u8bbe\u5907\u3002GPU \u7684\u865a\u62df\u5316\uff0c\u8fd8\u662f\u8981\u9996\u5148\u4ece PCIe \u8bbe\u5907\u865a\u62df\u5316\u89d2\u5ea6\u6765\u8003\u8651\u3002</p> \u90a3\u4e48\u4e00\u4e2a PCIe \u8bbe\u5907\uff0c\u6709\u4ec0\u4e48\u8d44\u6e90\uff1f\u6709\u4ec0\u4e48\u80fd\u529b\uff1f <p>2 \u79cd\u8d44\u6e90:</p> <ul> <li>\u914d\u7f6e\u7a7a\u95f4</li> <li><code>MMIO</code></li> <li>(\u6709\u7684\u8fd8\u6709 <code>PIO</code> \u548c Option ROM\uff0c\u6b64\u7565)</li> </ul> <p>2 \u79cd\u80fd\u529b:</p> <ul> <li>\u4e2d\u65ad\u80fd\u529b</li> <li>DMA \u80fd\u529b</li> </ul> <p>\u4e00\u4e2a\u5178\u578b\u7684 GPU \u8bbe\u5907\u7684\u5de5\u4f5c\u6d41\u7a0b\u662f:</p> <ol> <li>\u5e94\u7528\u5c42\u8c03\u7528 GPU \u652f\u6301\u7684\u67d0\u4e2a API\uff0c\u5982 OpenGL \u6216 CUDA</li> <li>OpenGL \u6216 <code>CUDA</code> \u5e93\uff0c\u901a\u8fc7 <code>UMD</code> (User Mode Driver)\uff0c\u63d0\u4ea4 workload \u5230 <code>KMD</code> (Kernel Mode Driver)</li> <li><code>KMD</code> \u5199 <code>CSR MMIO</code>\uff0c\u628a\u5b83\u63d0\u4ea4\u7ed9 GPU \u786c\u4ef6</li> <li>GPU \u786c\u4ef6\u5f00\u59cb\u5de5\u4f5c... \u5b8c\u6210\u540e\uff0c<code>DMA</code> \u5230\u5185\u5b58\uff0c\u53d1\u51fa\u4e2d\u65ad\u7ed9 CPU</li> <li>CPU \u627e\u5230\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f \u2014\u2014 <code>KMD</code> \u6b64\u524d\u5411 OS Kernel \u6ce8\u518c\u8fc7\u7684 \u2014\u2014 \u8c03\u7528\u5b83</li> <li>\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u627e\u5230\u662f\u54ea\u4e2a workload \u88ab\u6267\u884c\u5b8c\u6bd5\u4e86\uff0c...\u6700\u7ec8\u9a71\u52a8\u5524\u9192\u76f8\u5173\u7684\u5e94\u7528</li> </ol>"},{"location":"gpu/gpu/gpuVirt/#pcie","title":"PCIe\u76f4\u901a","text":"<p>\u6211\u4eec\u9996\u5148\u6765\u5230 GPU \u865a\u62df\u5316\u7684\u6700\u4fdd\u5b88\u7684\u5b9e\u73b0: PCIe \u8bbe\u5907\u76f4\u901a\u3002</p> <p>\u5982\u524d\u8ff0\uff0c\u4e00\u4e2a PCIe \u8bbe\u5907\u62e5\u6709 2 \u79cd\u8d44\u6e90\u30012 \u79cd\u80fd\u529b\u3002\u4f60\u628a\u8fd9 2 \u79cd\u8d44\u6e90\u90fd\uff08\u76f4\u63a5\u6216\u95f4\u63a5\u5730\uff09\u4ea4\u7ed9 VM\u3001\u9488\u5bf9\u8fd9 2 \u79cd\u80fd\u529b\u90fd\u628a\u8bbe\u5907\u548c VM \u63a5\u901a\uff0c\u90a3\u4e48\uff0cVM \u5c31\u80fd\u5b8c\u6574\u4f7f\u7528\u8fd9\u4e2a PCIe \u8bbe\u5907\uff0c\u5c31\u50cf\u5728\u7269\u7406\u673a\u4e0a\u4e00\u6837\u3002\u8fd9\u79cd\u65b9\u6848\uff0c\u6211\u4eec\u79f0\u4e4b\u4e3a PCIe \u76f4\u901a\uff08PCIe Pass-Through\uff09\u3002\u5b83\u53ea\u80fd 1:1\uff0c\u4e0d\u652f\u6301 <code>1:N</code>\u3002\u5176\u5b9e\u5e76\u4e0d\u80fd\u7b97\u771f\u6b63\u7684\u865a\u62df\u5316\uff0c\u4e5f\u6ca1\u6709\u8d85\u5356\u7684\u53ef\u80fd\u6027\u3002</p> <p>VM \u4e2d\uff0c\u4f7f\u7528\u7684\u662f\u539f\u751f\u7684 GPU \u9a71\u52a8\u3002\u5b83\u5411 VM \u5185\u6838\u5206\u914d\u5185\u5b58\uff0c\u628a GPA \u586b\u5165\u5230 GPU \u7684 <code>CSR</code> \u5bc4\u5b58\u5668\uff0cGPU \u7528\u5b83\u4f5c\u4e3a <code>IOVA</code> \u6765\u53d1\u8d77 <code>DMA</code> \u8bbf\u95ee\uff0c<code>VT-d</code> \u4fdd\u8bc1\u628a GPA \u7ffb\u8bd1\u4e3a\u6b63\u786e\u7684 HPA\uff0c\u4ece\u800c <code>DMA</code> \u5230\u8fbe\u6b63\u786e\u7684\u7269\u7406\u5185\u5b58\u3002</p> <p>PCIe \u534f\u8bae\uff0c\u5728\u4e8b\u52a1\u5c42(<code>Transaction Layer</code>)\uff0c\u6709\u591a\u79cd TLP\uff0c<code>DMA</code> \u5373\u662f\u5176\u4e2d\u7684\u4e00\u79cd: <code>MRd/MWr</code>\u3002\u5728\u8fd9\u79cd TLP \u4e2d\uff0c\u5fc5\u987b\u643a\u5e26\u53d1\u8d77\u8005\u7684 Routing ID\uff0c\u800c\u5728 <code>IOMMU</code> \u4e2d\uff0c\u5c31\u6839\u636e\u8fd9\u6837\u7684 Routing ID\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684 <code>IOMMU</code> \u9875\u8868\u8fdb\u884c\u7ffb\u8bd1\u3002</p> <p>\u5f88\u663e\u7136\uff0cPCIe \u76f4\u901a\u53ea\u80fd\u652f\u6301 <code>1:1</code> \u7684\u573a\u666f\uff0c\u65e0\u6cd5\u6ee1\u8db3 <code>1:N</code> \u7684\u9700\u6c42\u3002</p>"},{"location":"gpu/gpu/gpuVirt/#sr-iov","title":"SR-IOV","text":"\u90a3\u4e48\uff0c\u4e1a\u754c\u5bf9 <code>1:N</code> \u7684 PCIe \u865a\u62df\u5316\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u5462\uff1f <p>\u6211\u4eec\u9996\u5148\u5c31\u4f1a\u60f3\u5230 SR-IOV\u3002SR-IOV \u662f PCI-SIG \u5728 2007 \u5e74\u63a8\u51fa\u7684\u89c4\u8303\uff0c\u76ee\u7684\u5c31\u662f PCIe \u8bbe\u5907\u7684\u865a\u62df\u5316\u3002SR-IOV \u7684\u672c\u8d28\u662f\u4ec0\u4e48\uff1f\u8003\u8651\u6211\u4eec\u8bf4\u8fc7\u7684 2 \u79cd\u8d44\u6e90\u548c 2 \u79cd\u80fd\u529b\uff0c\u6765\u770b\u770b\u4e00\u4e2a VF \u6709\u4ec0\u4e48:</p> <ul> <li>\u914d\u7f6e\u7a7a\u95f4\u662f\u865a\u62df\u7684\uff08\u7279\u6743\u8d44\u6e90\uff09</li> <li><code>MMIO</code> \u662f\u7269\u7406\u7684</li> <li>\u4e2d\u65ad\u548c DMA\uff0c\u56e0\u4e3a VF \u6709\u81ea\u5df1\u7684 PCIe \u534f\u8bae\u5c42\u7684\u6807\u8bc6\uff08Routing ID\uff0c\u5c31\u662f BDF\uff09\uff0c\u4ece\u800c\u62e5\u6709\u72ec\u7acb\u7684\u5730\u5740\u7a7a\u95f4\u3002</li> </ul> \u90a3\u4e48\uff0c\u4ec0\u4e48\u8bbe\u5907\u9002\u5408\u5b9e\u73b0 SR-IOV\uff1f <p>\u5176\u5b9e\u65e0\u975e\u662f\u8981\u6ee1\u8db3\u4e24\u70b9:</p> <ul> <li>\u786c\u4ef6\u8d44\u6e90\u8981\u5bb9\u6613 partition</li> <li>\u65e0\u72b6\u6001\uff08\u81f3\u5c11\u8981\u63a5\u8fd1\u65e0\u72b6\u6001\uff09</li> </ul> <p>\u5e38\u89c1 PCIe \u8bbe\u5907\u4e2d\uff0c\u6700\u9002\u5408 SR-IOV \u7684\u5c31\u662f\u7f51\u5361\u4e86: \u4e00\u6216\u591a\u5bf9 <code>TX/RX queue</code> + \u4e00\u6216\u591a\u4e2a\u4e2d\u65ad\uff0c\u7ed3\u5408\u4e0a\u4e00\u4e2a Routing ID\uff0c\u5c31\u53ef\u4ee5\u62bd\u8c61\u4e3a\u4e00\u4e2a VF\u3002\u800c\u4e14\u5b83\u662f\u8fd1\u4e4e\u65e0\u72b6\u6001\u7684\u3002</p> <p>\u8bd5\u8003\u8651 NVMe \u8bbe\u5907\uff0c\u5b83\u7684\u8d44\u6e90\u4e5f\u5f88\u5bb9\u6613 partition\uff0c\u4f46\u662f\u5b83\u6709\u5b58\u50a8\u6570\u636e\uff0c\u56e0\u6b64\u5728\u5b9e\u73b0 SR-IOV \u65b9\u9762\uff0c\u5c31\u4f1a\u6709\u66f4\u591a\u7684\u987e\u8651\u3002</p>"},{"location":"gpu/gpu/gpuVirt/#api","title":"API\u8f6c\u53d1","text":"<p>\u56e0\u6b64\uff0c\u5728\u4e1a\u754c\u957f\u671f\u7f3a\u4e4f SRIOV-capable GPU\u3001\u53c8\u6709\u5f3a\u70c8\u7684 <code>1:N</code> \u9700\u6c42\u7684\u60c5\u5f62\u4e0b\uff0c\u5c31\u6709\u66f4 high-level \u7684\u65b9\u6848\u51fa\u73b0\u4e86\u3002\u6211\u4eec\u9996\u5148\u56de\u5230 GPU \u5e94\u7528\u7684\u573a\u666f:</p> <ol> <li>\u6e32\u67d3\uff08<code>OpenGL</code>\u3001<code>DirectX</code>\uff0cetc.\uff09</li> <li>\u8ba1\u7b97\uff08<code>CUDA</code>\uff0c<code>OpenCL</code>\uff09</li> <li>\u5a92\u4f53\u7f16\u89e3\u7801\uff08<code>VAAPI</code>...)</li> </ol> <p>\u4e1a\u754c\u5c31\u4ece\u8fd9\u4e9b API \u5165\u624b\uff0c\u5728\u8f6f\u4ef6\u5c42\u9762\u5b9e\u73b0\u4e86**GPU \u865a\u62df\u5316**\u3002\u4ee5 AWS Elastic GPU \u4e3a\u4f8b:</p> <ul> <li>VM \u4e2d\u770b\u4e0d\u5230\u771f\u7684\u6216\u5047\u7684 GPU\uff0c\u4f46\u53ef\u4ee5\u8c03\u7528 OpenGL API \u8fdb\u884c\u6e32\u67d3</li> <li>\u5728 OpenGL API \u5c42\uff0c\u8f6f\u4ef6\u6355\u6349\u5230\u8be5\u8c03\u7528\uff0c\u8f6c\u53d1\u7ed9 Host</li> <li>Host \u8bf7\u6c42 GPU \u8fdb\u884c\u6e32\u67d3</li> <li>Host \u628a\u6e32\u67d3\u7684\u7ed3\u679c\uff0c\u8f6c\u53d1\u7ed9 VM</li> </ul> <p>API \u5c42\u7684 GPU \u865a\u62df\u5316\u662f\u76ee\u524d\u4e1a\u754c\u5e94\u7528\u6700\u5e7f\u6cdb\u7684 GPU \u865a\u62df\u5316\u65b9\u6848\u3002\u5b83\u7684\u597d\u5904\u662f:</p> <ul> <li>\u7075\u6d3b\u3002<code>1:N</code> \u7684 N\uff0c\u60f3\u5b9a\u4e3a\u591a\u5c11\uff0c\u8f6f\u4ef6\u53ef\u81ea\u884c\u51b3\u5b9a\uff1b\u54ea\u4e2a VM \u7684\u4f18\u5148\u7ea7\u9ad8\uff0c\u54ea\u4e2a VM \u7684\u4f18\u5148\u7ea7\u4f4e\uff0c\u540c\u7406\u3002</li> <li>\u4e0d\u4f9d\u8d56\u4e8e GPU \u786c\u4ef6\u5382\u5546\u3002\u5fae\u8f6f\u3001VMWare\u3001Citrix\u3001\u534e\u4e3a\u2026\u2026\u90fd\u53ef\u4ee5\u5b9e\u73b0\u3002\u8fd9\u4e9b API \u603b\u5f52\u662f\u516c\u5f00\u7684\u3002</li> <li>\u4e0d\u9650\u4e8e\u7cfb\u7edf\u865a\u62df\u5316\u73af\u5883\u3002\u5bb9\u5668\u4e5f\u597d\uff0c\u666e\u901a\u7684\u7269\u7406\u673a\u4e5f\u597d\uff0c\u90fd\u53ef\u4ee5 API \u8f6c\u53d1\u5230\u8fdc\u7aef\u3002</li> </ul> <p>\u7f3a\u70b9\u5462\uff1f</p> <p>\u590d\u6742\u5ea6\u6781\u9ad8\u3002\u540c\u4e00\u529f\u80fd\u6709\u591a\u5957 API\uff08\u6e32\u67d3\u7684 DirectX \u548c OpenGL\uff09\uff0c\u540c\u4e00\u5957 API \u8fd8\u6709\u4e0d\u540c\u7248\u672c\uff08\u5982 DirectX 9 \u548c DirectX 11\uff09\uff0c\u517c\u5bb9\u6027\u5c31\u590d\u6742\u7684\u8981\u547d\u3002 \u529f\u80fd\u4e0d\u5b8c\u6574\u3002\u8ba1\u7b97\u6e32\u67d3\u5a92\u4f53\u90fd\u652f\u6301\u7684 API \u8f6c\u53d1\u65b9\u6848\uff0c\u8fd8\u6ca1\u542c\u8bf4\u8fc7\u3002\u5e76\u4e14\uff0c\u7f16\u89e3\u7801\u751a\u81f3\u8fd8\u4e0d\u5b58\u5728\u4e1a\u754c\u516c\u7528\u7684 API</p>"},{"location":"gpu/gpu/gpuVirt/#mptmdevvgpu","title":"MPT/MDEV/vGPU","text":"<p>\u9274\u4e8e\u8fd9\u4e9b\u56f0\u96be\uff0c\u4e1a\u754c\u5c31\u51fa\u73b0\u4e86 SR-IOV\u3001API \u8f6c\u53d1\u4e4b\u5916\u7684\u7b2c\u4e09\u79cd\u65b9\u6848\u3002\u6211\u4eec\u79f0\u4e4b\u4e3a <code>MPT</code>\uff08Mediated Pass-Through\uff0c\u53d7\u63a7\u7684\u76f4\u901a\uff09\u3002 <code>MPT</code> \u672c\u8d28\u4e0a\u662f\u4e00\u79cd\u901a\u7528\u7684 PCIe \u8bbe\u5907\u865a\u62df\u5316\u65b9\u6848\uff0c\u751a\u81f3\u4e5f\u53ef\u4ee5\u7528\u4e8e PCIe \u4e4b\u5916\u7684\u8bbe\u5907\u3002\u5b83\u7684\u57fa\u672c\u601d\u8def\u662f\uff1a</p> <ul> <li>\u654f\u611f\u8d44\u6e90\u5982\u914d\u7f6e\u7a7a\u95f4\uff0c\u662f\u865a\u62df\u7684</li> <li>\u5173\u952e\u8d44\u6e90\u5982 <code>MMIO</code>\uff08CSR \u90e8\u5206\uff09\uff0c\u662f\u865a\u62df\u7684\uff0c\u4ee5\u4fbf <code>trap-and-emulate</code></li> <li>\u6027\u80fd\u5173\u952e\u8d44\u6e90\u5982 <code>MMIO</code>\uff08GPU \u663e\u5b58\u3001NVMe CMB \u7b49\uff09\uff0c\u786c\u4ef6 partition \u540e\u76f4\u63a5\u8d4b\u7ed9 VM</li> <li>Host \u4e0a\u5fc5\u987b\u5b58\u5728\u4e00\u4e2a Virtualization-Aware \u7684\u9a71\u52a8\u7a0b\u5e8f\uff0c\u4ee5\u8d1f\u8d23\u6a21\u62df\u548c\u8c03\u5ea6\uff0c\u5b83\u5b9e\u9645\u4e0a\u662f vGPU \u7684 device-model</li> </ul> <p>\u8fd9\u6837\uff0cVM \u4e2d\u5c31\u80fd\u770b\u5230\u4e00\u4e2a\u770b\u4f3c\u5b8c\u6574\u7684 GPU PCIe \u8bbe\u5907\uff0c\u5b83\u4e5f\u53ef\u4ee5 attach \u539f\u751f\u7684 GPU \u9a71\u52a8\u3002\u4ee5\u6e32\u67d3\u4e3a\u4f8b\uff0cvGPU \u7684\u57fa\u672c\u5de5\u4f5c\u6d41\u7a0b\u662f:</p> <ol> <li>VM \u4e2d\u7684 GPU \u9a71\u52a8\uff0c\u51c6\u5907\u597d\u4e00\u5757\u5185\u5b58\uff0c\u4fdd\u5b58\u7684\u662f\u6e32\u67d3 workload</li> <li>VM \u4e2d\u7684 GPU \u9a71\u52a8\uff0c\u628a\u8fd9\u5757\u5185\u5b58\u7684\u7269\u7406\u5730\u5740(GPA)\uff0c\u5199\u5165\u5230 <code>MMIO CSR</code> \u4e2d</li> <li>Host/Hypervisor/\u9a71\u52a8: \u6355\u6349\u5230\u8fd9\u6b21\u7684 <code>MMIO CSR</code> \u5199\u64cd\u4f5c\uff0c\u62ff\u5230\u4e86 GPA</li> <li>Host/Hypervisor/\u9a71\u52a8: \u628a GPA \u8f6c\u6362\u6210 HPA\uff0c\u5e76 pin \u4f4f\u76f8\u5e94\u7684\u5185\u5b58\u9875</li> <li>Host/Hypervisor/\u9a71\u52a8: \u628a HPA\uff08\u800c\u4e0d\u662f GPA\uff09\uff0c\u5199\u5165\u5230 pGPU \u7684\u771f\u5b9e\u7684 <code>MMIO CSR</code> \u4e2d</li> <li>pGPU \u5de5\u4f5c\uff0c\u5b8c\u6210\u8fd9\u4e2a\u6e32\u67d3 workload\uff0c\u5e76\u53d1\u9001\u4e2d\u65ad\u7ed9\u9a71\u52a8</li> <li>\u9a71\u52a8\u627e\u5230\u8be5\u4e2d\u65ad\u5bf9\u5e94\u54ea\u4e2a workload \u2014\u2014 \u5f53\u521d\u6211\u662f\u4e3a\u54ea\u4e2a vGPU \u63d0\u4ea4\u7684\u8fd9\u4e2a workload\uff1f \u2014\u2014 \u5e76\u6ce8\u5165\u4e00\u4e2a\u865a\u62df\u7684\u4e2d\u65ad\u5230\u76f8\u5e94\u7684 VM \u4e2d</li> <li>VM \u4e2d\u7684 GPU \u9a71\u52a8\uff0c\u6536\u5230\u4e2d\u65ad\uff0c\u77e5\u9053\u8be5 workload \u5df2\u5b8c\u6210\u3001\u7ed3\u679c\u5728\u5185\u5b58\u4e2d</li> </ol> <p>\u8fd9\u5c31\u662f <code>nVidia GRID vGPU</code>\u3001<code>Intel GVT-g</code>\uff08KVMGT\u3001XenGT\uff09\u7684\u57fa\u672c\u5b9e\u73b0\u601d\u8def\u3002\u4e00\u822c\u8ba4\u4e3a graphics stack \u662f OS \u4e2d\u6700\u590d\u6742\u7684\uff0c\u52a0\u4e0a\u865a\u62df\u5316\u4e4b\u540e\u590d\u6742\u5ea6\u66f4\u662f\u66b4\u589e\uff0c\u4efb\u4f55\u5730\u65b9\u51fa\u73b0\u4e00\u4e2a\u7f16\u7a0b\u9519\u8bef\uff0c\u8c03\u8bd5\u8d77\u6765\u90fd\u662f\u65e0\u6bd4\u75db\u82e6\u3002\u4f46\u53ea\u8981\u7a33\u5b9a\u4e0b\u6765\uff0c\u8fd9\u79cd <code>MPT</code> \u65b9\u6848\uff0c\u5c31\u80fd\u517c\u987e <code>1:N</code> \u7075\u6d3b\u6027\u3001\u9ad8\u6027\u80fd\u3001\u6e32\u67d3\u8ba1\u7b97\u5a92\u4f53\u7684\u529f\u80fd\u5b8c\u6574\u6027</p>"},{"location":"gpu/gpu/terminology/","title":"GPU\u4ecb\u7ecd","text":""},{"location":"gpu/gpu/terminology/#gpu","title":"\u4ec0\u4e48\u662fGPU","text":"<p>\u53ef\u80fd\u559c\u6b22\u6253\u6e38\u620f\u7684\u540c\u5b66\u5bf9GPU\u5e76\u4e0d\u964c\u751f\uff0c\u8fd9\u91cc\u6211\u4ecb\u7ecd\u4e00\u4e0bGPU\u7684\u6982\u5ff5\u3002</p> <p>GPU\u7684\u6982\u5ff5</p> <p>GPU \u662f\u7531\u8bb8\u591a\u66f4\u5c0f\u3001\u66f4\u4e13\u4e1a\u7684\u5185\u6838\u7ec4\u6210\u7684\u5904\u7406\u5668\uff0c\u53c8\u79f0\u56fe\u5f62\u5904\u7406\u5668\u3002\u5728\u591a\u4e2a\u5185\u6838\u4e4b\u95f4\u5212\u5206\u5e76\u6267\u884c\u4e00\u9879\u5904\u7406\u4efb\u52a1\u65f6\uff0c\u901a\u8fc7\u534f\u540c\u5de5\u4f5c\uff0c\u8fd9\u4e9b\u5185\u6838\u53ef\u4ee5\u63d0\u4f9b\u5f3a\u5927\u7684\u6027\u80fd\u3002\u5b83\u548cCPU\u6700\u5927\u7684\u533a\u522b\u5728\u4e8eGPU\u5728\u5927\u91cf\u8ba1\u7b97\u548c3D\u6e32\u67d3\u4efb\u52a1\u8fdc\u8fdc\u6bd4CPU\u6709\u7740\u66f4\u51fa\u8272\u7684\u8868\u73b0\u3002</p> <p>GPU\u7684\u5de5\u4f5c\u5927\u90e8\u5206\u5c31\u662f\u8fd9\u6837\uff0c\u8ba1\u7b97\u91cf\u5927\uff0c\u4f46\u6ca1\u4ec0\u4e48\u6280\u672f\u542b\u91cf\uff0c\u800c\u4e14\u8981\u91cd\u590d\u5f88\u591a\u5f88\u591a\u6b21\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c</p> <p>GPU\u4f8b\u5b50</p> <p>\u5c31\u50cf\u4f60\u6709\u4e2a\u5de5\u4f5c\u9700\u8981\u7b97\u51e0\u4ebf\u6b21\u4e00\u767e\u4ee5\u5185\u52a0\u51cf\u4e58\u9664\u4e00\u6837\uff0c\u6700\u597d\u7684\u529e\u6cd5\u5c31\u662f\u96c7\u4e0a\u51e0\u5341\u4e2a\u5c0f\u5b66\u751f\u4e00\u8d77\u7b97\uff0c\u4e00\u4eba\u7b97\u4e00\u90e8\u5206\uff0c\u53cd\u6b63\u8fd9\u4e9b\u8ba1\u7b97\u4e5f\u6ca1\u4ec0\u4e48\u6280\u672f\u542b\u91cf\uff0c\u7eaf\u7cb9\u4f53\u529b\u6d3b\u800c\u5df2\u3002\u800cCPU\u5c31\u50cf\u8001\u6559\u6388\uff0c\u79ef\u5206\u5fae\u5206\u90fd\u4f1a\u7b97\uff0c\u5c31\u662f\u5de5\u8d44\u9ad8\uff0c\u4e00\u4e2a\u8001\u6559\u6388\u8d44\u9876\u4e8c\u5341\u4e2a\u5c0f\u5b66\u751f\uff0c\u4f60\u8981\u662f\u5bcc\u58eb\u5eb7\u4f60\u96c7\u54ea\u4e2a\uff1fGPU\u5c31\u662f\u8fd9\u6837\uff0c\u7528\u5f88\u591a\u7b80\u5355\u7684\u8ba1\u7b97\u5355\u5143\u53bb\u5b8c\u6210\u5927\u91cf\u7684\u8ba1\u7b97\u4efb\u52a1\uff0c\u7eaf\u7cb9\u7684\u4eba\u6d77\u6218\u672f\u3002\u8fd9\u79cd\u7b56\u7565\u57fa\u4e8e\u4e00\u4e2a\u524d\u63d0\uff0c\u5c31\u662f\u5c0f\u5b66\u751fA\u548c\u5c0f\u5b66\u751fB\u7684\u5de5\u4f5c\u6ca1\u6709\u4ec0\u4e48\u4f9d\u8d56\u6027\uff0c\u662f\u4e92\u76f8\u72ec\u7acb\u7684\u3002\u5f88\u591a\u6d89\u53ca\u5230\u5927\u91cf\u8ba1\u7b97\u7684\u95ee\u9898\u57fa\u672c\u90fd\u6709\u8fd9\u79cd\u7279\u6027\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0cCPU\u548cGPU\u56e0\u4e3a\u6700\u521d\u7528\u6765\u5904\u7406\u7684\u4efb\u52a1\u5c31\u4e0d\u540c\uff0c\u6240\u4ee5\u8bbe\u8ba1\u4e0a\u6709\u4e0d\u5c0f\u7684\u533a\u522b\u3002</p>"},{"location":"gpu/gpu/terminology/#_1","title":"\u672f\u8bed\u4e13\u6709\u540d\u8bcd\u8868","text":"\u7f29\u5199 \u89e3\u91ca <code>GPU</code> Graphics Processing Unit\uff0c\u663e\u5361 <code>CUDA</code> Compute Unified Device Architecture\uff0c\u82f1\u4f1f\u8fbe 2006 \u5e74\u63a8\u51fa\u7684\u8ba1\u7b97 API <code>VT/VT-x/VT-d</code> Intel Virtualization Technology\u3002-x \u8868\u793a x86 CPU\uff0c-d \u8868\u793a Device\u3002 <code>SVM</code> AMD Secure Virtual Machine\u3002AMD \u7684\u7b49\u4ef7\u4e8e Intel VT-x \u7684\u6280\u672f\u3002 <code>EPT</code> Extended Page Table\uff0cIntel \u7684 CPU \u865a\u62df\u5316\u4e2d\u7684\u9875\u8868\u865a\u62df\u5316\u786c\u4ef6\u652f\u6301\u3002 <code>NPT</code> Nested Page Table\uff0cAMD \u7684\u7b49\u4ef7\u4e8e Intel EPT \u7684\u6280\u672f\u3002 <code>SR-IOV</code> Single Root I/O Virtualization\u3002PCI-SIG 2007 \u5e74\u63a8\u51fa\u7684 PCIe \u865a\u62df\u5316\u6280\u672f\u3002 <code>PF</code> Physical Function\uff0c\u4ea6\u5373\u7269\u7406\u5361 <code>VF</code> Virtual Function\uff0c\u4ea6\u5373 SR-IOV \u7684\u865a\u62df PCIe \u8bbe\u5907 <code>MMIO</code> Memory Mapped I/O\u3002\u8bbe\u5907\u4e0a\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\uff0cCPU \u4ee5\u5185\u5b58\u8bfb\u5199\u6307\u4ee4\u6765\u8bbf\u95ee\u3002 <code>CSR</code> Control &amp; Status Register\uff0c\u8bbe\u5907\u4e0a\u7684\u7528\u4e8e\u63a7\u5236\u3001\u6216\u53cd\u6620\u72b6\u6001\u7684\u5bc4\u5b58\u5668\u3002CSR \u901a\u5e38\u4ee5 MMIO \u7684\u65b9\u5f0f\u8bbf\u95ee\u3002 <code>UMD</code> User Mode Driver\u3002GPU \u7684\u7528\u6237\u6001\u9a71\u52a8\u7a0b\u5e8f\uff0c\u4f8b\u5982 CUDA \u7684 UMD \u662f libcuda.so <code>KMD</code> Kernel Mode Driver\u3002GPU \u7684 PCIe \u9a71\u52a8\uff0c\u4f8b\u5982\u82f1\u4f1f\u8fbe GPU \u7684 KMD \u662f nvidia.ko <code>GVA</code> Guest Virtual Address\uff0cVM \u4e2d\u7684 CPU \u865a\u62df\u5730\u5740 <code>GPA</code> Guest Physical Address\uff0cVM \u4e2d\u7684\u7269\u7406\u5730\u5740 <code>HPA</code> Host Physical Address\uff0cHost \u770b\u5230\u7684\u7269\u7406\u5730\u5740 <code>IOVA</code> I/O Virtual Address\uff0c\u8bbe\u5907\u53d1\u51fa\u53bb\u7684 DMA \u5730\u5740 <code>PCIe TLP</code> PCIe Transaction Layer Packet <code>BDF</code> Bus/Device/Function\uff0c\u4e00\u4e2a PCIe/PCI \u529f\u80fd\u7684 ID <code>MPT</code> Mediated Pass-Through\uff0c\u53d7\u63a7\u76f4\u901a\uff0c\u4e00\u79cd\u8bbe\u5907\u865a\u62df\u5316\u7684\u5b9e\u73b0\u65b9\u5f0f <code>MDEV</code> Mediated Device\uff0cLinux \u4e2d\u7684 MPT \u5b9e\u73b0 <code>PRM</code> Programming Reference Manual\uff0c\u786c\u4ef6\u7684\u7f16\u7a0b\u624b\u518c <code>MIG</code> Multi-Instance GPU\uff0cAmpere \u67b6\u6784\u9ad8\u7aef GPU \u5982 A100 \u652f\u6301\u7684\u4e00\u79cd hardware partition \u65b9\u6848"},{"location":"gpu/operators/gpuOperator/","title":"GPU Operator","text":"<p>Kubernetes \u901a\u8fc7\u8bbe\u5907\u63d2\u4ef6\u6846\u67b6\u63d0\u4f9b\u5bf9\u7279\u6b8a\u786c\u4ef6\u8d44\u6e90\u7684\u8bbf\u95ee\uff0c\u4f8b\u5982 NVIDIA GPU\u3001NIC\u3001Infiniband \u9002\u914d\u5668\u548c\u5176\u4ed6\u8bbe\u5907\u3002 \u7136\u800c\uff0c\u4f7f\u7528\u8fd9\u4e9b\u786c\u4ef6\u8d44\u6e90\u914d\u7f6e\u548c\u7ba1\u7406\u8282\u70b9\u9700\u8981\u914d\u7f6e\u591a\u4e2a\u8f6f\u4ef6\u7ec4\u4ef6\uff0c\u4f8b\u5982\u9a71\u52a8\u7a0b\u5e8f\u3001\u5bb9\u5668\u8fd0\u884c\u65f6\u6216\u5176\u4ed6\u5e93\uff0c\u8fd9\u662f\u56f0\u96be\u4e14\u5bb9\u6613\u51fa\u9519\u7684\u3002 NVIDIA GPU Operator \u4f7f\u7528 Kubernetes \u4e2d\u7684\u7b97\u5b50\u6846\u67b6\u6765\u81ea\u52a8\u7ba1\u7406\u914d\u7f6e GPU \u6240\u9700\u7684\u6240\u6709 NVIDIA \u8f6f\u4ef6\u7ec4\u4ef6\u3002 \u8fd9\u4e9b\u7ec4\u4ef6\u5305\u62ec NVIDIA \u9a71\u52a8\u7a0b\u5e8f\uff08\u7528\u4e8e\u542f\u7528 CUDA\uff09\u3001GPU \u7684 Kubernetes \u8bbe\u5907\u63d2\u4ef6\u3001NVIDIA \u5bb9\u5668\u5de5\u5177\u5305\u3001\u4f7f\u7528 GFD \u7684\u81ea\u52a8\u8282\u70b9\u6807\u8bb0\u3001\u57fa\u4e8e DCGM \u7684\u76d1\u63a7\u7b49\u3002</p>"},{"location":"gpu/operators/gpuOperator/#_1","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"gpu/operators/gpuOperator/#_2","title":"\u5feb\u901f\u4e86\u89e3","text":"<p>\u5feb\u901f\u5f00\u59cb</p><p>Get Started</p> <p>\u5e73\u53f0\u652f\u6301</p><p>Platform Support</p>"},{"location":"gpu/operators/gpuOperator/get-started/","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"gpu/operators/gpuOperator/get-started/#_1","title":"\u5148\u51b3\u6761\u4ef6","text":"<p>\u5728\u5b89\u88c5 GPU Operator \u4e4b\u524d\uff0c\u60a8\u5e94\u8be5\u786e\u4fdd Kubernetes \u96c6\u7fa4\u6ee1\u8db3\u4e00\u4e9b\u5148\u51b3\u6761\u4ef6\u3002</p> <ol> <li>Kubernetes \u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u5de5\u4f5c\u8282\u70b9\u5fc5\u987b\u8fd0\u884c\u76f8\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u7248\u672c\u624d\u80fd\u4f7f\u7528 NVIDIA GPU \u9a71\u52a8\u7a0b\u5e8f\u5bb9\u5668\u3002 \u6216\u8005\uff0c\u5982\u679c\u60a8\u5728\u8282\u70b9\u4e0a\u9884\u5b89\u88c5 NVIDIA GPU \u9a71\u52a8\u7a0b\u5e8f\uff0c\u5219\u53ef\u4ee5\u8fd0\u884c\u4e0d\u540c\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002</li> <li>\u8282\u70b9\u5fc5\u987b\u914d\u7f6e\u5bb9\u5668\u5f15\u64ce\uff0c\u4f8b\u5982 Docker CE/EE\u3001<code>cri-o</code> \u6216 <code>containerd</code>\u3002 \u5bf9\u4e8e docker\uff0c\u8bf7\u9075\u5faa\u5b98\u65b9\u5b89\u88c5\u8bf4\u660e\u3002</li> <li> <p>\u8282\u70b9\u529f\u80fd\u53d1\u73b0 (NFD) \u662f\u6bcf\u4e2a\u8282\u70b9\u4e0a Operator \u7684\u4f9d\u8d56\u9879\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cNFD master \u548cworker \u7531 Operator \u81ea\u52a8\u90e8\u7f72\u3002 \u5982\u679c NFD \u5df2\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\uff0c\u5219\u60a8\u5fc5\u987b\u5728\u5b89\u88c5 Operator \u65f6\u7981\u7528\u90e8\u7f72 NFD\u3002</p> <p>\u786e\u5b9a NFD \u662f\u5426\u5df2\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\u68c0\u67e5\u8282\u70b9\u4e0a\u7684 NFD \u6807\u7b7e\uff1a <pre><code>kubectl get nodes -o json | jq '.items[].metadata.labels | keys | any(startswith(\"feature.node.kubernetes.io\"))'\n</code></pre> \u5982\u679c\u547d\u4ee4\u8f93\u51fa\u4e3a <code>true</code>\uff0c\u5219 NFD \u5df2\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u3002</p> </li> <li> <p>\u8981\u5728 Kubernetes 1.13 \u548c 1.14 \u4e2d\u8fdb\u884c\u76d1\u63a7\uff0c\u8bf7\u542f\u7528 kubelet <code>KubeletPodResources</code> \u7279\u6027\u95e8\u63a7\u3002 \u4ece Kubernetes 1.15 \u5f00\u59cb\uff0c\u9ed8\u8ba4\u542f\u7528\u3002</p> </li> </ol> <p>\u6ce8\u610f</p> <p>\u8981\u542f\u7528 <code>KubeletPodResources</code> \u7279\u6027\u95e8\u63a7\uff0c\u8bf7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a  <pre><code>echo -e \"KUBELET_EXTRA_ARGS=--feature-gates=KubeletPodResources=true\" | sudo tee /etc/default/kubelet\n</code></pre></p> <p>\u5728 NVIDIA vGPU \u4e0a\u5b89\u88c5 GPU Operator \u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\u3002</p> <ol> <li>NVIDIA vGPU \u4e3b\u673a\u9a71\u52a8\u7a0b\u5e8f\u7248\u672c 12.0\uff08\u6216\u66f4\u9ad8\u7248\u672c\uff09\u9884\u5b89\u88c5\u5728\u6258\u7ba1 NVIDIA vGPU \u52a0\u901f\u7684 Kubernetes \u5de5\u4f5c\u8282\u70b9\u865a\u62df\u673a\u7684\u6240\u6709\u865a\u62df\u673a\u7ba1\u7406\u7a0b\u5e8f\u4e0a\u3002 \u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 NVIDIA vGPU \u6587\u6863\u3002</li> <li>\u5df2\u5b89\u88c5 NVIDIA vGPU \u8bb8\u53ef\u8bc1\u670d\u52a1\u5668\uff0c\u5e76\u4e14\u53ef\u4ece\u6240\u6709 Kubernetes \u5de5\u4f5c\u8282\u70b9\u865a\u62df\u673a\u8bbf\u95ee\u8be5\u670d\u52a1\u5668\u3002</li> <li>\u79c1\u6709\u6ce8\u518c\u8868\u53ef\u7528\u4e8e\u4e0a\u4f20 NVIDIA vGPU \u7279\u5b9a\u9a71\u52a8\u7a0b\u5e8f\u5bb9\u5668\u6620\u50cf\u3002</li> <li>\u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e2a Kubernetes \u5de5\u4f5c\u8282\u70b9\u90fd\u53ef\u4ee5\u8bbf\u95ee\u79c1\u6709\u6ce8\u518c\u8868\u3002 \u79c1\u6709\u6ce8\u518c\u8868\u8bbf\u95ee\u901a\u5e38\u901a\u8fc7 <code>imagePullSecrets</code> \u8fdb\u884c\u7ba1\u7406\u3002 \u6709\u5173\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 Kubernetes \u6587\u6863\u3002 \u7528\u6237\u9700\u8981\u5728 <code>values.yaml</code> \u6587\u4ef6\u7684\u9a71\u52a8\u7a0b\u5e8f\u90e8\u5206\u4e2d\u5411 NVIDIA GPU-Operator \u63d0\u4f9b\u8fd9\u4e9b\u673a\u5bc6\u3002</li> <li>\u9700\u8981 Git \u548c <code>Docker/Podman</code> \u4ece\u6e90\u5b58\u50a8\u5e93 (Repo) \u6784\u5efa vGPU \u9a71\u52a8\u7a0b\u5e8f\u6620\u50cf\u5e76\u5c06\u5176\u63a8\u9001\u5230\u672c\u5730\u6ce8\u518c\u8868\u3002</li> </ol> <p>\u6ce8\u610f</p> <p>\u5c06 NVIDIA vGPU \u9a71\u52a8\u7a0b\u5e8f\u4e0a\u4f20\u5230\u516c\u5f00\u53ef\u7528\u7684\u5b58\u50a8\u5e93\u6216\u4ee5\u5176\u4ed6\u65b9\u5f0f\u516c\u5f00\u5171\u4eab\u8be5\u9a71\u52a8\u7a0b\u5e8f\u8fdd\u53cd\u4e86 NVIDIA vGPU EULA\u3002</p>"},{"location":"gpu/operators/gpuOperator/get-started/#helm","title":"Helm\u90e8\u7f72","text":"<p>\u90e8\u7f72 GPU Operator \u7684\u9996\u9009\u65b9\u6cd5\u662f\u4f7f\u7528 helm\u3002</p> <p><pre><code>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 \\\n&amp;&amp; chmod 700 get_helm.sh \\\n&amp;&amp; ./get_helm.sh\n</code></pre> \u73b0\u5728\uff0c\u6dfb\u52a0 NVIDIA Helm \u5b58\u50a8\u5e93 (Repo)\uff1a <pre><code>$ helm repo add nvidia https://helm.ngc.nvidia.com/nvidia \\\n&amp;&amp; helm repo update\n</code></pre></p> <p>GPU Operator Helm \u56fe\u8868\u63d0\u4f9b\u4e86\u8bb8\u591a\u53ef\u81ea\u5b9a\u4e49\u7684\u9009\u9879\uff0c\u53ef\u4ee5\u6839\u636e\u60a8\u7684\u73af\u5883\u8fdb\u884c\u914d\u7f6e\u3002</p> <p></p>"},{"location":"gpu/operators/gpuOperator/get-started/#chart","title":"Chart\u81ea\u5b9a\u4e49\u9009\u9879","text":""},{"location":"kubeVirt/","title":"kubeVirt\u6982\u89c8","text":""},{"location":"kubeVirt/#_1","title":"\u7814\u53d1\u80cc\u666f","text":"<p>\u968f\u7740\u4e91\u65f6\u4ee3\u7684\u5230\u6765\uff0c\u5404\u5927\u4f01\u4e1a\u7eb7\u7eb7\u5c06\u4ee5\u5f80\u7684\u4f20\u7edf\u4e1a\u52a1\u8f6c\u79fb\u81f3K8s\u96c6\u7fa4\u901a\u8fc7\u5bb9\u5668\u5316\u5c06\u4e1a\u52a1\u903b\u8f91\u8dd1\u8d77\u6765\uff0c\u4f46\u540c\u65f6\u80cc\u540e\u7684\u652f\u6301\u4f9d\u7136\u662f\u9760\u7740Openstack\u4e3b\u6253\u865a\u62df\u5316\uff0c\u800c\u8fd1\u5e74OpenStack \u7684\u6d3b\u8dc3\u5ea6\u65e5\u8d8b\u4e0b\u964d\uff0c\u8fd9\u4e5f\u7ed9\u5404\u4f01\u4e1a\u5728\u865a\u62df\u673a\u8fd0\u884c\u4e1a\u52a1\u5e26\u6765\u8bf8\u591a\u4e0d\u7a33\u5b9a\u6027\u3002</p> <p>\u4e8e\u662f\uff0c\u540eKubernetes\u65f6\u4ee3\u7684\u865a\u62df\u673a\u7ba1\u7406\u6280\u672fkubeVirt\u4fbf\u9010\u6e10\u5d1b\u8d77\u3002kubeVirt\u662f Red Hat \u5f00\u6e90\u7684\u4ee5\u5bb9\u5668\u65b9\u5f0f\u8fd0\u884c\u865a\u62df\u673a\u7684\u9879\u76ee\uff0c\u662f\u57fa\u4e8ekubernetes\u8fd0\u884c\uff0c\u5229\u7528k8s CRD\u4e3a\u589e\u52a0\u8d44\u6e90\u7c7b\u578b<code>VirtualMachineInstance\uff08VMI\uff09</code>\uff0c\u4f7f\u7528CRD\u7684\u65b9\u5f0f\u662f\u7531\u4e8ekubeVirt\u5bf9\u865a\u62df\u673a\u7684\u7ba1\u7406\u4e0d\u5c40\u9650\u4e8epod\u7ba1\u7406\u63a5\u53e3\u3002\u901a\u8fc7CRD\u673a\u5236\uff0ckubeVirt\u53ef\u4ee5\u81ea\u5b9a\u4e49\u989d\u5916\u7684\u64cd\u4f5c\uff0c\u6765\u8c03\u6574\u5e38\u89c4\u5bb9\u5668\u4e2d\u4e0d\u53ef\u7528\u7684\u884c\u4e3a\u3002kubeVirt\u53ef\u4ee5\u4f7f\u7528\u5bb9\u5668\u7684image registry\u53bb\u521b\u5efa\u865a\u62df\u673a\u5e76\u63d0\u4f9bVM\u751f\u547d\u5468\u671f\u7ba1\u7406\u3002</p>"},{"location":"kubeVirt/#_2","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"kubeVirt/#_3","title":"\u5feb\u901f\u4e86\u89e3","text":"<p>\u67b6\u6784\u548c\u751f\u547d\u5468\u671f\u7ba1\u7406</p><p>Infrastructure and Lifecycle</p> <p>\u865a\u62df\u673a\u90e8\u7f72\u5b9e\u6218</p><p>VM Deployment Practice</p>"},{"location":"kubeVirt/#_4","title":"\u8d44\u6e90\u5217\u8868","text":"<p>kubeVirt\u8d44\u6e90\u5206\u4e3a\u4ee5\u4e0b\u51e0\u5927\u7c7b\uff1a</p> <p>vm\u8d44\u6e90</p><p>VirtualMachine</p> <p>vmPool\u8d44\u6e90</p><p>VirtualMachinePool</p> <p>vmi\u8d44\u6e90</p><p>VirtualMachineInstance</p> <p>vmiType\u8d44\u6e90</p><p>VirtualMachineInstancetype</p> <p>vmPreference\u8d44\u6e90</p><p>VirtualMachinePreference</p> <p>vmirs\u8d44\u6e90</p><p>VirtualMachineInstanceReplicaSet</p> <p>vmiPreset\u8d44\u6e90</p><p>VirtualMachineInstancePreset</p> <p>vmExport\u8d44\u6e90</p><p>VirtualMachineExport</p> <p>vmiMigration\u8d44\u6e90</p><p>VirtualMachineInstanceMigration</p> <p>migrationPolicy\u8d44\u6e90</p><p>MigrationPolicy</p> <p>vmSnapshot\u8d44\u6e90</p><p>VirtualMachineSnapshot</p> <p>vmRestore\u8d44\u6e90</p><p>VirtualMachineRestore</p> <p>vmClone\u8d44\u6e90</p><p>VirtualMachineClone</p>"},{"location":"kubeVirt/#_5","title":"\u7279\u6027\u529f\u80fd","text":"<p>kubeVirt\u5177\u5907\u4ee5\u4e0b\u7279\u6027\u529f\u80fd\uff1a</p> <ul> <li>\u8282\u70b9\u7ba1\u7406</li> <li>\u5185\u5b58\u7ba1\u7406</li> <li>\u6784\u5efa\u7ba1\u7406</li> </ul>"},{"location":"kubeVirt/#_6","title":"\u8282\u70b9\u7ba1\u7406","text":"<p>\u8282\u70b9\u5206\u914d</p><p>Node Assignment</p> <p>\u8282\u70b9\u7ef4\u62a4</p><p>Node Maintenance</p> <p>\u8282\u70b9\u8fc7\u5ea6\u4f7f\u7528\u7ba1\u7406</p><p>Node Overcommit</p>"},{"location":"kubeVirt/#cpu","title":"\u5185\u5b58/CPU\u7ba1\u7406","text":"<p>\u5185\u6838\u540c\u9875\u5408\u5e76</p><p>Kernel Same-page Merging</p> <p>\u865a\u62df\u673a\u5185\u5b58\u8f6c\u50a8</p><p>VM Memory Dump</p> <p>\u8d44\u6e90\u8d85\u5356</p><p>Over-subscription</p> <p>\u4e13\u7528CPU\u8d44\u6e90</p><p>Dedicated CPU Resources</p> <p>\u5927\u9875\u5185\u5b58</p><p>Hugepages</p>"},{"location":"kubeVirt/#_7","title":"\u6784\u5efa\u7ba1\u7406","text":"<p>Tekton</p><p>Tekton</p>"},{"location":"kubeVirt/#operators","title":"Operators","text":"<p>HCO</p><p>HyperConverged Cluster Operator</p> <p>SSP</p><p>SSP Operator</p>"},{"location":"kubeVirt/#_8","title":"\u6e90\u7801\u5206\u6790","text":"<p>kubeVirt\u6e90\u7801\u5206\u6790\u7ec6\u5206\u4ee5\u4e0b\u7ec4\u4ef6\uff1a</p> <p>virt-controller\u7ec4\u4ef6</p><p>virt-controller</p> <p>virt-launcher\u7ec4\u4ef6</p><p>virt-launcher</p> <p>virt-handler\u7ec4\u4ef6</p><p>virt-handler</p>"},{"location":"kubeVirt/features/dedicated-cpu-resources/","title":"\u4e13\u7528CPU\u8d44\u6e90","text":"<p>\u67d0\u4e9b\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u9700\u8981\u53ef\u9884\u6d4b\u5ef6\u8fdf\u548c\u589e\u5f3a\u6027\u80fd\u7684\u5de5\u4f5c\u8d1f\u8f7d\u5c06\u53d7\u76ca\u4e8e\u83b7\u5f97\u4e13\u7528 CPU \u8d44\u6e90\u3002 KubeVirt \u4f9d\u8d56 Kubernetes CPU \u7ba1\u7406\u5668\uff0c\u80fd\u591f\u5c06\u5ba2\u6237\u673a\u7684 vCPU \u56fa\u5b9a\u5230\u4e3b\u673a\u7684 pCPU\u3002</p>"},{"location":"kubeVirt/features/dedicated-cpu-resources/#kubernetes-cpu","title":"Kubernetes CPU \u7ba1\u7406\u5668","text":"<p>Kubernetes CPU \u7ba1\u7406\u5668\u662f\u4e00\u79cd\u5f71\u54cd\u5de5\u4f5c\u8d1f\u8f7d\u8c03\u5ea6\u7684\u673a\u5236\uff0c\u5982\u679c\u6ee1\u8db3\u4ee5\u4e0b\u8981\u6c42\uff0c\u5219\u5c06\u5176\u653e\u7f6e\u5728\u53ef\u4ee5\u5206\u914d<code>Guaranteed</code>\u8d44\u6e90\u5e76\u5c06\u67d0\u4e9b Pod \u5bb9\u5668\u56fa\u5b9a\u5230\u6258\u7ba1 pCPU \u7684\u4e3b\u673a\u4e0a\uff1a</p> <ul> <li>Pod \u7684 QoS \u6709\u4fdd\u8bc1<ul> <li>\u8d44\u6e90\u8bf7\u6c42\u548c\u9650\u5236\u662f\u76f8\u7b49\u7684</li> <li>Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u8868\u8fbe\u4e86 CPU \u548c\u5185\u5b58\u9700\u6c42</li> </ul> </li> <li>\u8bf7\u6c42\u7684 CPU \u6570\u91cf\u662f\u4e00\u4e2a\u6574\u6570</li> </ul> <p>\u9644\u52a0\u4fe1\u606f\uff1a</p> <ul> <li>\u5728 Kubernetes \u4e0a\u542f\u7528 CPU \u7ba1\u7406\u5668</li> <li>\u5728 OKD \u4e0a\u542f\u7528 CPU \u7ba1\u7406\u5668</li> <li>Kubernetes \u535a\u5ba2\u89e3\u91ca\u8be5\u529f\u80fd</li> </ul>"},{"location":"kubeVirt/features/dedicated-cpu-resources/#cpu","title":"\u7533\u8bf7\u4e13\u7528CPU\u8d44\u6e90","text":"<p>\u5728 VMI \u89c4\u8303\u4e2d\u5c06 <code>spec.domain.cpu.dedicatedCpuPlacement</code> \u8bbe\u7f6e\u4e3a <code>true</code> \u5c06\u8868\u793a\u5e0c\u671b\u5c06\u4e13\u7528 CPU \u8d44\u6e90\u5206\u914d\u7ed9 VMI</p> <p>Kubevirt \u5c06\u9a8c\u8bc1\u662f\u5426\u6ee1\u8db3\u6240\u6709\u5fc5\u8981\u6761\u4ef6\uff0c\u4ee5\u4fbf Kubernetes CPU \u7ba1\u7406\u5668\u5c06 virt-launcher \u5bb9\u5668\u56fa\u5b9a\u5230\u4e13\u7528\u4e3b\u673a CPU\u3002 \u4e00\u65e6 virt-launcher \u8fd0\u884c\uff0cVMI \u7684 vCPU \u5c06\u56fa\u5b9a\u5230\u4e13\u7528\u4e8e virt-launcher \u5bb9\u5668\u7684 <code>pCPUS</code>\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u5c06<code>spec.domain.cpu</code>\uff08\u5957\u63a5\u5b57\u3001\u6838\u5fc3\u3001\u7ebf\u7a0b\uff09\u6216<code>spec.domain.resources.requests/limits.cpu</code>\u4e2d\u7684\u6765\u5bbe\u62d3\u6251\u8bbe\u7f6e\u4e3a\u6574\u6570\uff08<code>[ 1-9]+</code>) \u6307\u793a\u4e3a VMI \u8bf7\u6c42\u7684 vCPU \u6570\u91cf\u3002 vCPU \u7684\u6570\u91cf\u8ba1\u7b97\u4e3a\u5957\u63a5\u5b57 * \u6838\u5fc3 * \u7ebf\u7a0b\uff0c\u6216\u8005\u5982\u679c<code>spec.domain.cpu</code> \u4e3a\u7a7a\uff0c\u5219\u5b83\u4ece<code>spec.domain.resources.requests.cpu</code> \u6216<code>spec.domain.resources.limits.cpu</code> \u83b7\u53d6\u503c\u3002</p> <p>\u5907\u6ce8</p> <ul> <li>\u7528\u6237\u4e0d\u5e94\u540c\u65f6\u6307\u5b9a<code>spec.domain.cpu</code>\u548c<code>spec.domain.resources.requests/limits.cpu</code></li> <li><code>spec.domain.resources.requests.cpu</code>\u5fc5\u987b\u7b49\u4e8e<code>spec.domain.resources.limits.cpu</code></li> <li>\u4f7f\u7528<code>spec.domain.cpu.sockets</code> \u800c\u4e0d\u662f<code>spec.domain.cpu.cores</code> \u65f6\uff0c\u591a\u4e2aCPU \u7ed1\u5b9a\u7684\u5fae\u57fa\u51c6\u6d4b\u8bd5\u663e\u793a\u51fa\u663e\u7740\u7684\u6027\u80fd\u4f18\u52bf\u3002</li> </ul> <p>\u6240\u6709\u4e0d\u4e00\u81f4\u7684\u8981\u6c42\u90fd\u5c06\u88ab\u62d2\u7edd\u3002</p> <p><pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nspec:\ndomain:\ncpu:\nsockets: 2\ncores: 1\nthreads: 1\ndedicatedCpuPlacement: true\nresources:\nlimits:\nmemory: 2Gi\n...\n</code></pre> \u6216\u8005 <pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nspec:\ndomain:\ncpu:\ndedicatedCpuPlacement: true\nresources:\nlimits:\ncpu: 2\nmemory: 2Gi\n...\n</code></pre></p>"},{"location":"kubeVirt/features/dedicated-cpu-resources/#qemu-cpu","title":"\u4e3a QEMU \u6a21\u62df\u5668\u7533\u8bf7\u4e13\u7528 CPU","text":"<p>\u8bb8\u591a QEMU \u7ebf\u7a0b\uff08\u4f8b\u5982 QEMU \u4e3b\u4e8b\u4ef6\u5faa\u73af\u3001\u5f02\u6b65 I/O \u64cd\u4f5c\u5b8c\u6210\u7b49\uff09\u4e5f\u5728\u4e0e VMI \u7684 vCPU \u76f8\u540c\u7684\u7269\u7406 CPU \u4e0a\u6267\u884c\u3002 \u8fd9\u53ef\u80fd\u4f1a\u5f71\u54cd vCPU \u7684\u9884\u671f\u5ef6\u8fdf\u3002 \u4e3a\u4e86\u589e\u5f3a KubeVirt \u4e2d\u7684\u5b9e\u65f6\u652f\u6301\u5e76\u6539\u5584\u5ef6\u8fdf\uff0cKubeVirt \u5c06\u5206\u914d\u4e00\u4e2a\u989d\u5916\u7684\u4e13\u7528 CPU\uff0c\u4e13\u95e8\u7528\u4e8e\u5c06\u5176\u56fa\u5b9a\u7684\u6a21\u62df\u5668\u7ebf\u7a0b\u3002 \u8fd9\u5c06\u6709\u6548\u5730\u5c06\u6a21\u62df\u5668\u7ebf\u7a0b\u4e0e VMI \u7684 vCPU\u201c\u9694\u79bb\u201d\u3002 \u5982\u679c <code>ioThreadsPolicy</code> \u8bbe\u7f6e\u4e3a <code>auto</code>\uff0c<code>IOThreads</code> \u4e5f\u5c06\u88ab\u201c\u9694\u79bb\u201d\u5e76\u653e\u7f6e\u5728\u4e0e QEMU \u4eff\u771f\u5668\u7ebf\u7a0b\u76f8\u540c\u7684\u7269\u7406 CPU \u4e0a\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u5728 VMI \u89c4\u8303\u7684 <code>Spec.Domain.CPU</code> \u90e8\u5206\u4e2d\u6307\u5b9a<code>isolateEmulatorThread: true</code> \u6765\u542f\u7528\u6b64\u529f\u80fd\u3002 \u5f53\u7136\uff0c\u8fd9\u4e2a\u8bbe\u7f6e\u5fc5\u987b\u4e0e<code>dicatedCpuPlacement: true</code> \u7ed3\u5408\u8d77\u6765\u6307\u5b9a\u3002</p> <p>\u4f8b\u5b50</p> <pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nspec:\ndomain:\ncpu:\ndedicatedCpuPlacement: true\nisolateEmulatorThread: true\nresources:\nlimits:\ncpu: 2\nmemory: 2Gi\n</code></pre>"},{"location":"kubeVirt/features/dedicated-cpu-resources/#cpu_1","title":"\u8bc6\u522b\u6b63\u5728\u8fd0\u884c\u7684 CPU \u7ba1\u7406\u5668\u7684\u8282\u70b9","text":"<p>\u76ee\u524d\uff0cKubernetes \u4e0d\u4f1a\u6807\u8bb0\u8fd0\u884c CPU \u7ba1\u7406\u5668\u7684\u8282\u70b9\u3002</p> <p>KubeVirt \u6709\u4e00\u79cd\u673a\u5236\u53ef\u4ee5\u8bc6\u522b\u54ea\u4e9b\u8282\u70b9\u6b63\u5728\u8fd0\u884c CPU \u7ba1\u7406\u5668\uff0c\u5e76\u624b\u52a8\u6dfb\u52a0 <code>cpumanager=true</code> \u6807\u7b7e\u3002 \u5f53 KubeVirt \u8bc6\u522b\u51fa CPU \u7ba1\u7406\u5668\u4e0d\u518d\u5728\u8282\u70b9\u4e0a\u8fd0\u884c\u65f6\uff0c\u8be5\u6807\u7b7e\u5c06\u88ab\u5220\u9664\u3002 \u5728 Kubernetes \u63d0\u4f9b\u6240\u9700\u529f\u80fd\u4e4b\u524d\uff0c\u8fd9\u79cd\u81ea\u52a8\u8bc6\u522b\u5e94\u88ab\u89c6\u4e3a\u4e34\u65f6\u89e3\u51b3\u65b9\u6cd5\u3002 \u56e0\u6b64\uff0c\u5e94\u901a\u8fc7\u6fc0\u6d3b KubeVirt CR \u7684 <code>CPUManager</code> \u7279\u6027\u95e8\u63a7\u6765\u624b\u52a8\u542f\u7528\u6b64\u529f\u80fd\u3002</p> <p>\u5f53\u81ea\u52a8\u8bc6\u522b\u88ab\u7981\u7528\u65f6\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u53ef\u4ee5\u5728CPU Manager\u8fd0\u884c\u65f6\u624b\u52a8\u4e3a\u6240\u6709\u8282\u70b9\u6dfb\u52a0\u4e0a\u8ff0\u6807\u7b7e\u3002</p> <ul> <li>\u8282\u70b9\u7684\u6807\u7b7e\u662f\u53ef\u89c1\u7684\uff1a<code>kubectl describe nodes</code></li> <li>\u7ba1\u7406\u5458\u53ef\u4ee5\u624b\u52a8\u6807\u8bb0\u4e22\u5931\u7684\u8282\u70b9\uff1a<code>kubectl label node [node_name] cpumanager=true</code></li> </ul>"},{"location":"kubeVirt/features/dedicated-cpu-resources/#sidecar-cpu","title":"Sidecar \u5bb9\u5668\u548c CPU \u5206\u914d\u5f00\u9500","text":"<p>\u5907\u6ce8</p> <p>\u4e3a\u4e86\u8fd0\u884c Sidecar \u5bb9\u5668\uff0cKubeVirt \u9700\u8981\u5728 KubeVirt \u7684 CR \u4e2d\u542f\u7528 Sidecar \u7279\u6027\u95e8\u63a7\u3002</p> <p>\u6839\u636e Kubernetes CPU \u7ba1\u7406\u5668\u6a21\u578b\uff0c\u4e3a\u4e86\u4f7f POD \u8fbe\u5230\u6240\u9700\u7684 QOS \u7ea7\u522b\u4fdd\u8bc1\uff0cPOD \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u5fc5\u987b\u8868\u8fbe CPU \u548c\u5185\u5b58\u8981\u6c42\u3002 \u8fd9\u4e2a\u65f6\u5019Kubevirt\u7ecf\u5e38\u4f7f\u7528sidecar\u5bb9\u5668\u6765\u6302\u8f7dVMI\u7684\u6ce8\u518c\u8868\u76d8\u3002 \u5b83\u8fd8\u4f7f\u7528\u5176\u6302\u94a9\u673a\u5236\u7684\u8fb9\u8f66\u5bb9\u5668\u3002 \u8fd9\u4e9b\u989d\u5916\u7684\u8d44\u6e90\u53ef\u4ee5\u88ab\u89c6\u4e3a\u5f00\u9500\uff0c\u5e76\u4e14\u5728\u8ba1\u7b97\u8282\u70b9\u5bb9\u91cf\u65f6\u5e94\u8be5\u8003\u8651\u5728\u5185\u3002</p> <p>\u6ce8\u610f</p> <p>Sidecar \u8d44\u6e90\u5f53\u524d\u9ed8\u8ba4\u503c\uff1a<code>CPU\uff1a200M</code>\u548c<code>Memory\uff1a64M</code> \u7531\u4e8e CPU \u8d44\u6e90\u4e0d\u662f\u4ee5\u6574\u6570\u8868\u793a\uff0cCPU \u7ba1\u7406\u5668\u4e0d\u4f1a\u5c1d\u8bd5\u5c06 Sidecar \u5bb9\u5668\u56fa\u5b9a\u5230\u4e3b\u673a CPU\u3002</p>"},{"location":"kubeVirt/features/hugepages/","title":"\u5927\u9875\u5185\u5b58","text":"<p>\u7528\u6237\u53ef\u4ee5\u6307\u5b9a\u53ef\u9009\u7684\u8d44\u6e90\u8bf7\u6c42\uff0c\u4ee5\u5141\u8bb8\u8c03\u5ea6\u7a0b\u5e8f\u5728\u627e\u5230\u6700\u5408\u9002\u7684\u8282\u70b9\u6765\u653e\u7f6e\u865a\u62df\u673a\u65f6\u505a\u51fa\u66f4\u597d\u7684\u51b3\u7b56\u3002</p> <pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nmetadata:\nname: myvmi\nspec:\ndomain:\nresources:\nrequests:\nmemory: \"1Gi\"\ncpu: \"1\"\nlimits:\nmemory: \"2Gi\"\ncpu: \"2\"\ndisks:\n- name: myimage\ndisk: {}\nvolumes:\n- name: myimage\npersistentVolumeClaim:\nclaimname: myclaim\n</code></pre>"},{"location":"kubeVirt/features/hugepages/#cpu","title":"CPU","text":"<p>\u6307\u5b9a CPU \u9650\u5236\u5c06\u786e\u5b9a\u5728\u8fd0\u884c VM \u7684\u63a7\u5236\u7ec4\u4e0a\u8bbe\u7f6e\u7684 <code>cpu</code> \u4efd\u989d\u6570\u91cf\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5f53\u5b58\u5728 CPU \u8d44\u6e90\u7ade\u4e89\u65f6\uff0cVM \u7684 CPU \u53ef\u4ee5\u5728\u5206\u914d\u7684\u8d44\u6e90\u4e0a\u6267\u884c\u7684\u65f6\u95f4\u91cf\u3002</p>"},{"location":"kubeVirt/features/hugepages/#_1","title":"\u5185\u5b58\u5f00\u9500","text":"<p>\u5404\u79cd VM \u8d44\u6e90\uff08\u4f8b\u5982\u89c6\u9891\u9002\u914d\u5668\u3001IOThread \u548c\u8865\u5145\u7cfb\u7edf\u8f6f\u4ef6\uff09\u4f1a\u6d88\u8017\u8282\u70b9\u7684\u989d\u5916\u5185\u5b58\uff0c\u8d85\u51fa\u7528\u4e8e\u6765\u5bbe\u64cd\u4f5c\u7cfb\u7edf\u6d88\u8017\u7684\u8bf7\u6c42\u5185\u5b58\u3002 \u4e3a\u4e86\u7ed9\u8c03\u5ea6\u7a0b\u5e8f\u63d0\u4f9b\u66f4\u597d\u7684\u4f30\u8ba1\uff0c\u5c06\u8ba1\u7b97\u6b64\u5185\u5b58\u5f00\u9500\u5e76\u5c06\u5176\u6dfb\u52a0\u5230\u6240\u8bf7\u6c42\u7684\u5185\u5b58\u4e2d\u3002</p>"},{"location":"kubeVirt/features/hugepages/#_2","title":"\u5927\u9875\u5185\u5b58","text":"<p>KubeVirt \u4f7f\u60a8\u53ef\u4ee5\u4f7f\u7528\u5927\u9875\u4f5c\u4e3a\u865a\u62df\u673a\u7684\u540e\u5907\u5185\u5b58\u3002 \u60a8\u9700\u8981\u63d0\u4f9b\u6240\u9700\u7684\u5185\u5b58\u8d44\u6e90\u91cf <code>resources.requests.memory</code> \u548c\u5927\u9875\u7684\u5927\u5c0f\u624d\u80fd\u4f7f\u7528 <code>memory.hugepages.pageSize</code>\uff0c\u4f8b\u5982\uff0c\u5bf9\u4e8e <code>x86_64</code> \u67b6\u6784\uff0c\u5b83\u53ef\u4ee5\u662f <code>2Mi</code>\u3002</p> <p><pre><code>apiVersion: kubevirt.io/v1alpha1\nkind: VirtualMachine\nmetadata:\nname: myvm\nspec:\ndomain:\nresources:\nrequests:\nmemory: \"64Mi\"\nmemory:\nhugepages:\npageSize: \"2Mi\"\ndisks:\n- name: myimage\ndisk: {}\nvolumes:\n- name: myimage\npersistentVolumeClaim:\nclaimname: myclaim\n</code></pre> \u5728\u4e0a\u9762\u7684\u793a\u4f8b\u4e2d\uff0cVM \u5c06\u62e5\u6709 <code>64Mi</code> \u5185\u5b58\uff0c\u4f46\u5b83\u5c06\u4f7f\u7528\u5927\u5c0f\u4e3a <code>2Mi</code> \u7684\u8282\u70b9\u5927\u9875\uff0c\u800c\u4e0d\u662f\u5e38\u89c4\u5185\u5b58\u3002</p>"},{"location":"kubeVirt/features/hugepages/#_3","title":"\u9650\u5236","text":"<ul> <li>\u8282\u70b9\u5fc5\u987b\u9884\u5148\u5206\u914d\u5927\u9875</li> <li>\u5927\u9875\u7684\u5927\u5c0f\u4e0d\u80fd\u5927\u4e8e\u8bf7\u6c42\u7684\u5185\u5b58</li> <li>\u8bf7\u6c42\u7684\u5185\u5b58\u5fc5\u987b\u80fd\u88ab\u5927\u9875\u5927\u5c0f\u6574\u9664</li> <li><code>Hugepages</code> \u9ed8\u8ba4\u4f7f\u7528 <code>memfd</code>\u3002 <code>Memfd</code> \u4ece\u5185\u6838 <code>&gt;= 4.14</code> \u5f00\u59cb\u53d7\u652f\u6301\u3002 \u5982\u679c\u60a8\u5728\u8f83\u65e7\u7684\u4e3b\u673a\u4e0a\u8fd0\u884c\uff08\u4f8b\u5982 <code>centos 7.9</code>\uff09\uff0c\u5219\u9700\u8981\u5728 VMI \u5143\u6570\u636e\u6ce8\u91ca\u4e2d\u4f7f\u7528\u6ce8\u91ca <code>kubevirt.io/memfd: \"false\"</code> \u6765\u7981\u7528 <code>memfd</code>\u3002</li> </ul>"},{"location":"kubeVirt/features/ksm/","title":"\u5185\u6838\u540c\u9875\u5408\u5e76","text":"<p>\u5185\u6838\u540c\u9875\u5408\u5e76\u5b9a\u4e49</p> <p>\u5185\u6838\u540c\u9875\u5408\u5e76 (KSM) \u5141\u8bb8\u5185\u5b58\u91cd\u590d\u6570\u636e\u5220\u9664\u3002 KSM \u5c1d\u8bd5\u627e\u5230\u76f8\u540c\u7684\u5185\u5b58\u9875\u5e76\u5c06\u5b83\u4eec\u5408\u5e76\u4ee5\u91ca\u653e\u5185\u5b58\u3002</p>"},{"location":"kubeVirt/features/ksm/#kubevirt-cr-ksm","title":"\u901a\u8fc7 KubeVirt CR \u542f\u7528 KSM","text":"<p>\u53ef\u4ee5\u901a\u8fc7 KubeVirt CR \u4e2d\u7684 <code>spec.configuration.ksmConfiguration</code> \u5728\u8282\u70b9\u4e0a\u542f\u7528 KSM\u3002 <code>ksmConfiguration</code> \u6307\u793a\u5c06\u5728\u54ea\u4e9b\u8282\u70b9\u4e0a\u542f\u7528 KSM\uff0c\u4ece\u800c\u516c\u5f00 <code>nodeLabelSelector</code>\u3002</p> <p><code>nodeLabelSelector</code> \u662f\u4e00\u4e2a <code>LabelSelector</code>\uff0c\u5e76\u6839\u636e\u8282\u70b9\u6807\u7b7e\u5b9a\u4e49\u8fc7\u6ee4\u5668\u3002 \u5982\u679c\u8282\u70b9\u7684\u6807\u7b7e\u4e0e\u6807\u7b7e\u9009\u62e9\u5668\u672f\u8bed\u5339\u914d\uff0c\u5219\u5728\u8be5\u8282\u70b9\u4e0a\u5c06\u542f\u7528 KSM\u3002</p> <p>\u5907\u6ce8</p> <ul> <li>\u5982\u679c <code>nodeLabelSelector</code> \u4e3a<code>nil</code>\uff0c\u5219\u4e0d\u4f1a\u5728\u4efb\u4f55\u8282\u70b9\u4e0a\u542f\u7528 KSM\u3002</li> <li>\u7a7a\u7684<code>nodeLabelSelector</code>\u5c06\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u542f\u7528KSM\u3002</li> </ul> <p>\u8ba9\u6211\u4eec\u770b\u51e0\u4e2a\u4f8b\u5b50\uff1a</p> <p>\u542f\u7528KSM\u7684\u4f8b\u5b50</p> <ul> <li>\u5728\u4e3b\u673a\u540d\u4e3a<code>node01</code>\u6216<code>node03</code>\u7684\u8282\u70b9\u4e0a\u542f\u7528KSM\uff1a       <pre><code>spec:\nconfiguration:\nksmConfiguration:\nnodeLabelSelector:\nmatchExpressions:\n- key: kubernetes.io/hostname\noperator: In\nvalues:\n- node01\n- node03\n</code></pre></li> <li>\u5728\u5e26\u6709\u6807\u7b7e <code>kubevirt.io/first-label: true\u3001kubevirt.io/second-label: true</code> \u7684\u8282\u70b9\u4e0a\u542f\u7528 KSM\uff1a       <pre><code>spec:\nconfiguration:\nksmConfiguration:\nnodeLabelSelector:\nmatchLabels:\nkubevirt.io/first-label: \"true\"\nkubevirt.io/second-label: \"true\"\n</code></pre></li> <li>\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u542f\u7528KSM:       <pre><code>spec:\nconfiguration:\nksmConfiguration:\nnodeLabelSelector: {}\n</code></pre></li> </ul>"},{"location":"kubeVirt/features/ksm/#_1","title":"\u6ce8\u89e3\u548c\u6062\u590d\u673a\u5236","text":"<p>\u5728 kubeVirt \u901a\u8fc7\u914d\u7f6e\u542f\u7528 KSM \u7684\u8282\u70b9\u4e0a\uff0c\u5c06\u6dfb\u52a0\u6ce8\u91ca (<code>kubevirt.io/ksm-handler-management</code>)\u3002 \u8be5\u6ce8\u91ca\u662f\u4e00\u4e2a\u5185\u90e8\u8bb0\u5f55\uff0c\u7528\u4e8e\u8ddf\u8e2a\u54ea\u4e9b\u8282\u70b9\u5f53\u524d\u7531 virt-handler \u7ba1\u7406\uff0c\u4ee5\u4fbf\u5728\u5c06\u6765 ksmConfiguration \u66f4\u6539\u65f6\u53ef\u4ee5\u533a\u5206\u5e94\u6062\u590d\u54ea\u4e9b\u8282\u70b9\u3002</p> <p>\u8ba9\u6211\u4eec\u60f3\u8c61\u4e00\u4e0b\u8fd9\u4e2a\u573a\u666f\uff1a</p> <ol> <li>\u96c6\u7fa4\u4e2d\u6709 3 \u4e2a\u8282\u70b9\uff0c\u5176\u4e2d\u4e00\u4e2a\uff08<code>node01</code>\uff09\u5df2\u5916\u90e8\u542f\u7528 KSM\u3002</li> <li>\u7ba1\u7406\u5458\u4fee\u8865 KubeVirt CR\uff0c\u6dfb\u52a0 ksmConfiguration\uff0c\u4e3a <code>node02</code> \u548c <code>node03</code> \u542f\u7528 ksm\u3002</li> <li>\u4e00\u6bb5\u65f6\u95f4\u540e\uff0c\u7ba1\u7406\u5458\u518d\u6b21\u4fee\u8865 KubeVirt CR\uff0c\u5220\u9664 ksmConfiguration\u3002</li> </ol> <p>\u7531\u4e8e\u8be5\u6ce8\u91ca\uff0cvirt-handler \u80fd\u591f\u4ec5\u5728\u5176\u672c\u8eab\u5df2\u542f\u7528\u7684\u8282\u70b9\uff08<code>node02</code>\u3001<code>node03</code>\uff09\u4e0a\u7981\u7528 ksm\uff0c\u800c\u5176\u4ed6\u8282\u70b9\u4fdd\u6301\u4e0d\u53d8\uff08<code>node01</code>\uff09\u3002</p>"},{"location":"kubeVirt/features/ksm/#_2","title":"\u8282\u70b9\u6253\u6807\u7b7e","text":"<p>kubeVirt \u53ef\u4ee5\u53d1\u73b0\u54ea\u4e9b\u8282\u70b9\u542f\u7528\u4e86 KSM\uff0c\u5e76\u5c06\u4f7f\u7528\u503c\u4e3a <code>true</code> \u7684\u7279\u6b8a\u6807\u7b7e (<code>kubevirt.io/ksm-enabled</code>) \u6765\u6807\u8bb0\u5b83\u4eec\u3002 \u8be5\u6807\u7b7e\u53ef\u7528\u4e8e\u8c03\u5ea6\u542f\u7528\u6216\u672a\u542f\u7528 KSM \u7684\u8282\u70b9\u4e2d\u7684\u865a\u62df\u673a\u3002</p> <pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachine\nmetadata:\nname: testvm\nspec:\nrunning: true\ntemplate:\nmetadata:\nlabels:\nkubevirt.io/vm: testvm\nspec:\nnodeSelector:\nkubevirt.io/ksm-enabled: \"true\"\n[...]\n</code></pre>"},{"location":"kubeVirt/features/node-assignment/","title":"\u8282\u70b9\u5206\u914d","text":"<p>\u60a8\u53ef\u4ee5\u9650\u5236\u865a\u62df\u673a\u4ec5\u5728\u7279\u5b9a\u8282\u70b9\u4e0a\u8fd0\u884c\u6216\u66f4\u559c\u6b22\u5728\u7279\u5b9a\u8282\u70b9\u4e0a\u8fd0\u884c\uff1a</p> <ul> <li>\u8282\u70b9\u9009\u62e9\u5668</li> <li>\u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027</li> <li>\u6c61\u70b9\u548c\u5bb9\u5fcd</li> </ul>"},{"location":"kubeVirt/features/node-assignment/#_1","title":"\u8282\u70b9\u9009\u62e9\u5668","text":"<p>\u8bbe\u7f6e<code>spec.nodeSelector</code>\u8981\u6c42\uff0c\u9650\u5236\u8c03\u5ea6\u7a0b\u5e8f\u4ec5\u5728\u5305\u542b\u6307\u5b9a\u6807\u7b7e\u7684\u8282\u70b9\u4e0a\u8c03\u5ea6VM\u3002 \u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0cvmi \u5305\u542b\u6807\u7b7e <code>cpu: Slow</code> \u548c <code>storage: fast</code>\uff1a</p> <pre><code>metadata:\nname: testvmi-ephemeral\napiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nspec:\nnodeSelector:\ncpu: slow\nstorage: fast\ndomain:\nresources:\nrequests:\nmemory: 64M\ndevices:\ndisks:\n- name: mypvcdisk\nlun: {}\nvolumes:\n- name: mypvcdisk\npersistentVolumeClaim:\nclaimName: mypvc\n</code></pre> <p>\u56e0\u6b64\uff0c\u8c03\u5ea6\u7a0b\u5e8f\u53ea\u4f1a\u5c06 vmi \u8c03\u5ea6\u5230\u5143\u6570\u636e\u4e2d\u5305\u542b\u8fd9\u4e9b\u6807\u7b7e\u7684\u8282\u70b9\u3002 \u5b83\u7684\u5de5\u4f5c\u539f\u7406\u4e0e Pods \u8282\u70b9\u9009\u62e9\u5668\u5b8c\u5168\u76f8\u540c\u3002 \u6709\u5173\u66f4\u591a\u793a\u4f8b\uff0c\u8bf7\u53c2\u9605 Pod nodeSelector \u6587\u6863\u3002</p>"},{"location":"kubeVirt/features/node-assignment/#_2","title":"\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027","text":"<p><code>spec.affinity</code> \u5b57\u6bb5\u5141\u8bb8\u6307\u5b9a\u865a\u62df\u673a\u7684\u786c\u4eb2\u548c\u529b\u548c\u8f6f\u4eb2\u548c\u529b\u3002 \u53ef\u4ee5\u9488\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\uff08VM \u548c Pod\uff09\u548c\u8282\u70b9\u7f16\u5199\u5339\u914d\u89c4\u5219\u3002 \u7531\u4e8e VM \u662f\u57fa\u4e8e Pod \u7684\u5de5\u4f5c\u8d1f\u8f7d\u7c7b\u578b\uff0c\u56e0\u6b64 Pod \u4eb2\u548c\u6027\u4e5f\u4f1a\u5f71\u54cd VM\u3002</p> <p><code>podAffinity</code> \u548c <code>podAntiAffinity</code> \u7684\u793a\u4f8b\u53ef\u80fd\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>metadata:\nname: testvmi-ephemeral\napiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nspec:\nnodeSelector:\ncpu: slow\nstorage: fast\ndomain:\nresources:\nrequests:\nmemory: 64M\ndevices:\ndisks:\n- name: mypvcdisk\nlun: {}\naffinity:\npodAffinity:\nrequiredDuringSchedulingIgnoredDuringExecution:\n- labelSelector:\nmatchExpressions:\n- key: security\noperator: In\nvalues:\n- S1\ntopologyKey: failure-domain.beta.kubernetes.io/zone\npodAntiAffinity:\npreferredDuringSchedulingIgnoredDuringExecution:\n- weight: 100\npodAffinityTerm:\nlabelSelector:\nmatchExpressions:\n- key: security\noperator: In\nvalues:\n- S2\ntopologyKey: kubernetes.io/hostname\nvolumes:\n- name: mypvcdisk\npersistentVolumeClaim:\nclaimName: mypvc\n</code></pre> <p>\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027\u7684\u5de5\u4f5c\u539f\u7406\u4e0e Pod \u4eb2\u548c\u6027\u5b8c\u5168\u76f8\u540c\u3002 \u8fd9\u5305\u62ec <code>podAffinity</code>\u3001<code>podAntiAffinity</code>\u3001<code>nodeAffinity</code> \u548c <code>nodeAntiAffinity</code>\u3002 \u6709\u5173\u66f4\u591a\u793a\u4f8b\u548c\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 Pod \u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027\u6587\u6863\u3002</p>"},{"location":"kubeVirt/features/node-assignment/#_3","title":"\u6c61\u70b9\u548c\u5bb9\u5fcd","text":"<p>\u5982\u4e0a\u6240\u8ff0\uff0c\u4eb2\u548c\u6027\u662f VM \u7684\u4e00\u4e2a\u5c5e\u6027\uff0c\u5b83\u5c06 VM \u5438\u5f15\u5230\u4e00\u7ec4\u8282\u70b9\uff08\u4f5c\u4e3a\u504f\u597d\u6216\u786c\u6027\u8981\u6c42\uff09\u3002 \u6c61\u70b9\u5219\u76f8\u53cd\u2014\u2014\u5b83\u4eec\u5141\u8bb8\u4e00\u4e2a\u8282\u70b9\u6392\u65a5\u4e00\u7ec4\u865a\u62df\u673a\u3002</p> <p>\u6c61\u70b9\u548c\u5bb9\u5fcd\u534f\u540c\u5de5\u4f5c\u4ee5\u786e\u4fdd\u865a\u62df\u673a\u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u4e0d\u9002\u5f53\u7684\u8282\u70b9\u4e0a\u3002 \u4e00\u4e2a\u6216\u591a\u4e2a\u6c61\u70b9\u88ab\u5e94\u7528\u5230\u4e00\u4e2a\u8282\u70b9\uff1b \u8fd9\u6807\u5fd7\u7740\u8be5\u8282\u70b9\u4e0d\u5e94\u63a5\u53d7\u4efb\u4f55\u4e0d\u80fd\u5bb9\u5fcd\u6c61\u70b9\u7684\u865a\u62df\u673a\u3002 \u5bb9\u5fcd\u5e94\u7528\u4e8e\u865a\u62df\u673a\uff0c\u5e76\u5141\u8bb8\uff08\u4f46\u4e0d\u8981\u6c42\uff09\u865a\u62df\u673a\u8c03\u5ea6\u5230\u5177\u6709\u5339\u914d\u6c61\u70b9\u7684\u8282\u70b9\u4e0a\u3002</p> <p>\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>kubectl taint</code> \u5c06\u6c61\u70b9\u6dfb\u52a0\u5230\u8282\u70b9\u3002 \u4f8b\u5982\uff0c</p> <pre><code>kubectl taint nodes node1 key=value:NoSchedule\n</code></pre> <p>\u5bb9\u5fcd\u5ea6\u7684\u793a\u4f8b\u53ef\u80fd\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>metadata:\nname: testvmi-ephemeral\napiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nspec:\nnodeSelector:\ncpu: slow\nstorage: fast\ndomain:\nresources:\nrequests:\nmemory: 64M\ndevices:\ndisks:\n- name: mypvcdisk\nlun: {}\ntolerations:\n- key: \"key\"\noperator: \"Equal\"\nvalue: \"value\"\neffect: \"NoSchedule\"\n</code></pre>"},{"location":"kubeVirt/features/node-assignment/#descheduler","title":"\u4f7f\u7528 Descheduler \u8fdb\u884c\u8282\u70b9\u5e73\u8861","text":"<p>\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ef\u80fd\u9700\u8981\u6839\u636e\u5f53\u524d\u7684\u8c03\u5ea6\u7b56\u7565\u548c\u8d1f\u8f7d\u6761\u4ef6\u91cd\u65b0\u5e73\u8861\u96c6\u7fa4\u3002 Descheduler \u53ef\u4ee5\u627e\u5230 pod\uff0c\u4f8b\u5982\u8fd9\u8fdd\u53cd\u4e86 \u8c03\u5ea6\u51b3\u7b56\u5e76\u6839\u636e\u8c03\u5ea6\u5668\u7b56\u7565\u9a71\u9010\u5b83\u4eec\u3002 kubeVirt VM \u88ab\u89c6\u4e3a\u5177\u6709\u672c\u5730\u5b58\u50a8\u7684 Pod\uff0c\u56e0\u6b64\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cdescheduler \u4e0d\u4f1a\u9a71\u9010\u5b83\u4eec\u3002 \u4f46\u53ef\u4ee5\u901a\u8fc7\u5411 VM \u4e2d\u7684 VMI \u6a21\u677f\u6dfb\u52a0\u7279\u6b8a\u6ce8\u91ca\u6765\u8f7b\u677e\u8986\u76d6\u5b83\uff1a</p> <pre><code>spec:\ntemplate:\nmetadata:\nannotations:\ndescheduler.alpha.kubernetes.io/evict: true\n</code></pre> <p>\u6b64\u6ce8\u91ca\u5c06\u5bfc\u81f4 descheduler \u80fd\u591f\u9a71\u9010 VM \u7684 pod\uff0c\u7136\u540e\u8c03\u5ea6\u7a0b\u5e8f\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u8c03\u5ea6\u8be5 pod\u3002 \u5728\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664 VirtualMachineInstance \u7684\u5f53\u524d\u5b9e\u4f8b\u4e4b\u524d\uff0cVirtualMachine \u6c38\u8fdc\u4e0d\u4f1a\u91cd\u65b0\u542f\u52a8\u6216\u91cd\u65b0\u521b\u5efa VirtualMachineInstance\u3002</p>"},{"location":"kubeVirt/features/node-maintenance/","title":"\u8282\u70b9\u7ef4\u62a4","text":"<p>\u5728\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664 kubernetes \u8282\u70b9\u4e4b\u524d\uff0c\u7528\u6237\u9700\u8981\u786e\u4fdd VirtualMachineInstances \u5728\u5173\u95ed\u8282\u70b9\u7535\u6e90\u4e4b\u524d\u5df2\u6b63\u5e38\u7ec8\u6b62\u3002 \u7531\u4e8e\u6240\u6709 VirtualMachineInstances \u90fd\u7531 Pod \u652f\u6301\uff0c\u56e0\u6b64\u9a71\u9010 VirtualMachineInstances \u7684\u63a8\u8350\u65b9\u6cd5\u662f\u4f7f\u7528 <code>kubectl drain</code> \u547d\u4ee4\uff0c\u6216\u8005\u5728 OKD \u7684\u60c5\u51b5\u4e0b\u4f7f\u7528 <code>oc adm drain</code> \u547d\u4ee4\u3002</p>"},{"location":"kubeVirt/features/node-maintenance/#_1","title":"\u4ece\u8282\u70b9\u4e2d\u9010\u51fa\u6240\u6709\u865a\u62df\u673a","text":"<p>\u901a\u8fc7\u4ece\u96c6\u7fa4\u8282\u70b9\u5217\u8868\u4e2d\u8bc6\u522b\u8282\u70b9\u6765\u9009\u62e9\u8981\u4ece\u4e2d\u9a71\u9010 VirtualMachineInstances \u7684\u8282\u70b9\u3002</p> <p>\u4ee5\u4e0b\u547d\u4ee4\u5c06\u6b63\u5e38\u7ec8\u6b62\u7279\u5b9a\u8282\u70b9\u4e0a\u7684\u6240\u6709\u865a\u62df\u673a\u3002 \u5c06 <code>&lt;node-name&gt;</code> \u66ff\u6362\u4e3a\u5e94\u53d1\u751f\u9a71\u9010\u7684\u8282\u70b9\u7684\u540d\u79f0\u3002</p> <pre><code>kubectl drain &lt;node-name&gt; --delete-local-data --ignore-daemonsets=true --force --pod-selector=kubevirt.io=virt-launcher\n</code></pre> <p>\u4e0b\u9762\u8be6\u7ec6\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u9700\u8981\u4f20\u9012\u7ed9\u6392\u51fa\u547d\u4ee4\u7684\u6bcf\u4e2a\u53c2\u6570\u3002</p> <ul> <li> <p><code>kubectl drain &lt;node-name&gt;</code> \u6b63\u5728\u9009\u62e9\u7279\u5b9a\u8282\u70b9\u4f5c\u4e3a\u9a71\u9010\u76ee\u6807</p> </li> <li> <p><code>--delete-local-data</code> \u662f\u5220\u9664\u4efb\u4f55\u4f7f\u7528 emptyDir \u5377\u7684 pod \u6240\u5fc5\u9700\u7684\u5fc5\u9700\u6807\u5fd7\u3002 VirtualMachineInstance Pod \u786e\u5b9e\u4f7f\u7528 emptyDir \u5377\uff0c\u4f46\u662f\u8fd9\u4e9b\u5377\u4e2d\u7684\u6570\u636e\u662f\u77ed\u6682\u7684\uff0c\u8fd9\u610f\u5473\u7740\u7ec8\u6b62\u540e\u53ef\u4ee5\u5b89\u5168\u5730\u5220\u9664\u3002</p> </li> <li> <p><code>--ignore-daemonsets=true</code> \u662f\u5fc5\u9700\u7684\u6807\u5fd7\uff0c\u56e0\u4e3a\u8fd0\u884c VirtualMachineInstance \u7684\u6bcf\u4e2a\u8282\u70b9\u4e5f\u5c06\u8fd0\u884c\u6211\u4eec\u79f0\u4e3a virt-handler \u7684\u52a9\u624b DaemonSet\u3002 \u4e0d\u5141\u8bb8\u4f7f\u7528 <code>kubectl drain</code> \u9a71\u9010 DaemonSet\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u6b64\u547d\u4ee4\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u9047\u5230 DaemonSet\uff0c\u5219\u8be5\u547d\u4ee4\u5c06\u5931\u8d25\u3002 \u8be5\u6807\u5fd7\u544a\u8bc9\u547d\u4ee4\u53ef\u4ee5\u5b89\u5168\u5730\u8fdb\u884c\u9a71\u9010\u5e76\u5ffd\u7565 DaemonSet\u3002</p> </li> <li> <p><code>--force</code> \u662f\u5fc5\u9700\u7684\u6807\u5fd7\uff0c\u56e0\u4e3a VirtualMachineInstance pod \u4e0d\u5c5e\u4e8e ReplicaSet \u6216 DaemonSet \u63a7\u5236\u5668\u3002 \u8fd9\u610f\u5473\u7740 kubectl \u65e0\u6cd5\u4fdd\u8bc1\u5728\u76ee\u6807\u8282\u70b9\u4e0a\u7ec8\u6b62\u7684 pod \u5728 pod \u88ab\u9a71\u9010\u540e\u5c06\u5f97\u5230\u91cd\u65b0\u5b89\u6392\u7684\u66ff\u6362\uff0c\u5e76\u5c06\u5176\u653e\u7f6e\u5728\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u4f4d\u7f6e\u3002 KubeVirt \u6709\u81ea\u5df1\u7684\u63a7\u5236\u5668\u6765\u7ba1\u7406\u5e95\u5c42 VirtualMachineInstance pod\u3002 \u6bcf\u4e2a\u63a7\u5236\u5668\u5bf9\u4e8e\u88ab\u9a71\u9010\u7684 VirtualMachineInstance \u7684\u884c\u4e3a\u90fd\u4e0d\u540c\u3002 \u672c\u6587\u6863\u4e0b\u9762\u8fdb\u4e00\u6b65\u6982\u8ff0\u4e86\u8be5\u884c\u4e3a\u3002</p> </li> <li> <p><code>--pod-selector=kubevirt.io=virt-launcher</code> \u8868\u793a\u53ea\u6709 KubeVirt \u7ba1\u7406\u7684 VirtualMachineInstance pod \u624d\u4f1a\u4ece\u8282\u70b9\u4e2d\u5220\u9664\u3002</p> </li> </ul>"},{"location":"kubeVirt/features/node-maintenance/#vm-pod","title":"\u4ece\u8282\u70b9\u4e2d\u9010\u51fa\u6240\u6709 VM \u548c Pod","text":"<p>\u901a\u8fc7\u4ece\u4e0a\u4e00\u4e2a\u547d\u4ee4\u4e2d\u5220\u9664 <code>-pod-selector</code> \u53c2\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u9a71\u9010\u8282\u70b9\u4e0a\u7684\u6240\u6709 Pod\u3002 \u6b64\u547d\u4ee4\u53ef\u786e\u4fdd\u4e0e VM \u5173\u8054\u7684 Pod \u4ee5\u53ca\u6240\u6709\u5176\u4ed6 Pod \u5747\u4ece\u76ee\u6807\u8282\u70b9\u9010\u51fa\u3002</p> <pre><code>kubectl drain &lt;\u8282\u70b9\u540d\u79f0&gt; --delete-local-data --ignore-daemonsets=true --force\n</code></pre>"},{"location":"kubeVirt/features/node-maintenance/#vmi","title":"\u901a\u8fc7\u4ece\u8282\u70b9\u5b9e\u65f6\u8fc1\u79fb\u64a4\u51fa VMI","text":"<p>\u5982\u679c\u542f\u7528\u4e86 LiveMigration \u7279\u6027\u95e8\u63a7\uff0c\u5219\u53ef\u4ee5\u5728 VMI \u4e0a\u6307\u5b9a <code>evictionStrategy</code>\uff0c\u5b83\u5c06\u5bf9\u8282\u70b9\u4e0a\u7279\u5b9a\u6c61\u70b9\u7684\u5b9e\u65f6\u8fc1\u79fb\u505a\u51fa\u53cd\u5e94\u3002 VMI \u6216\u865a\u62df\u673a\u4e2d\u7684 VMI \u6a21\u677f\u4e0a\u7684\u4ee5\u4e0b\u4ee3\u7801\u7247\u6bb5\u53ef\u786e\u4fdd\u5728\u8282\u70b9\u9a71\u9010\u671f\u95f4\u8fc1\u79fb VMI\uff1a</p> <pre><code>spec:\nevictionStrategy: LiveMigrate\n</code></pre> <p>\u8fd9\u662f\u5b8c\u6574\u7684VMI, <pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachineInstance\nmetadata:\nname: testvmi-nocloud\nspec:\nterminationGracePeriodSeconds: 30\nevictionStrategy: LiveMigrate\ndomain:\nresources:\nrequests:\nmemory: 1024M\ndevices:\ndisks:\n- name: containerdisk\ndisk:\nbus: virtio\n- disk:\nbus: virtio\nname: cloudinitdisk\nvolumes:\n- name: containerdisk\ncontainerDisk:\nimage: kubevirt/fedora-cloud-container-disk-demo:latest\n- name: cloudinitdisk\ncloudInitNoCloud:\nuserData: |-\n#cloud-config\npassword: fedora\nchpasswd: { expire: False }\n</code></pre></p> <p>\u5728\u5e55\u540e\uff0c\u4e3a\u6bcf\u4e2a\u5b9a\u4e49\u4e86 <code>evictionStrategy</code> \u7684 VMI \u521b\u5efa\u4e00\u4e2a <code>PodDisruptionBudget</code>\u3002 \u8fd9\u786e\u4fdd\u4e86\u8fd9\u4e9b VMI \u4e0a\u7684\u9a71\u9010\u88ab\u963b\u6b62\uff0c\u5e76\u4e14\u6211\u4eec\u53ef\u4ee5\u4fdd\u8bc1 VMI \u5c06\u88ab\u8fc1\u79fb\u800c\u4e0d\u662f\u5173\u95ed\u3002</p>"},{"location":"kubeVirt/features/node-maintenance/#_2","title":"\u9a71\u9010\u540e\u91cd\u65b0\u542f\u7528\u8282\u70b9","text":"<p><code>kubectl drain</code>\u5c06\u5bfc\u81f4\u76ee\u6807\u8282\u70b9\u88ab\u6807\u8bb0\u4e3a\u4e0d\u53ef\u8c03\u5ea6\u3002 \u8fd9\u610f\u5473\u7740\u8be5\u8282\u70b9\u5c06\u6ca1\u6709\u8d44\u683c\u8fd0\u884c\u65b0\u7684 VirtualMachineInstances \u6216 Pod\u3002</p> <p>\u5982\u679c\u786e\u5b9a\u76ee\u6807\u8282\u70b9\u5e94\u518d\u6b21\u53d8\u5f97\u53ef\u8c03\u5ea6\uff0c\u5219\u5fc5\u987b\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002</p> KubernetesOKD <pre><code>kubectl uncordon &lt;\u8282\u70b9\u540d\u79f0&gt;\n</code></pre> <pre><code>oc adm uncordon &lt;\u8282\u70b9\u540d\u79f0&gt;\n</code></pre>"},{"location":"kubeVirt/features/node-maintenance/#_3","title":"\u9a71\u9010\u540e\u5173\u95ed\u8282\u70b9","text":"<p>\u4ece KubeVirt \u7684\u89d2\u5ea6\u6765\u770b\uff0c\u4e00\u65e6\u6240\u6709 VirtualMachineInstances \u4ece\u8282\u70b9\u4e2d\u88ab\u9010\u51fa\uff0c\u8be5\u8282\u70b9\u5c31\u53ef\u4ee5\u5b89\u5168\u5173\u95ed\u3002 \u5728\u591a\u7528\u9014\u96c6\u7fa4\u4e2d\uff0cVirtualMachineInstances \u4e0e\u5176\u4ed6\u5bb9\u5668\u5316\u5de5\u4f5c\u8d1f\u8f7d\u4e00\u8d77\u8c03\u5ea6\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u9700\u8981\u786e\u4fdd\u5728\u5173\u95ed\u8282\u70b9\u7535\u6e90\u4e4b\u524d\u6240\u6709\u5176\u4ed6 Pod \u5df2\u88ab\u5b89\u5168\u9a71\u9010\u3002</p>"},{"location":"kubeVirt/features/node-maintenance/#_4","title":"\u865a\u62df\u673a\u9a71\u9010","text":"<p>\u9a71\u9010\u8bbe\u7f6e\u4e3a <code>running=true</code> \u7684 VirtualMachine \u6240\u62e5\u6709\u7684\u4efb\u4f55 VirtualMachineInstance \u5c06\u5bfc\u81f4 VirtualMachineInstance \u88ab\u91cd\u65b0\u8c03\u5ea6\u5230\u53e6\u4e00\u4e2a\u8282\u70b9\u3002</p> <p>\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cVirtualMachineInstance \u5c06\u88ab\u8feb\u5173\u95ed\u7535\u6e90\u5e76\u5728\u53e6\u4e00\u4e2a\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u3002 \u672a\u6765\u4e00\u65e6 KubeVirt \u5f15\u5165\u5b9e\u65f6\u8fc1\u79fb\u652f\u6301\uff0c\u865a\u62df\u673a\u5c06\u80fd\u591f\u5728\u9a71\u9010\u671f\u95f4\u65e0\u7f1d\u8fc1\u79fb\u5230\u53e6\u4e00\u4e2a\u8282\u70b9\u3002</p>"},{"location":"kubeVirt/features/node-maintenance/#vmirs","title":"vmirs \u9a71\u9010\u884c\u4e3a","text":"<p>\u9a71\u9010 VirtualMachineInstanceReplicaSet \u62e5\u6709\u7684 VirtualMachineInstance \u5c06\u5bfc\u81f4 VirtualMachineInstanceReplicaSet \u5728\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u8282\u70b9\u4e0a\u8c03\u5ea6\u66ff\u6362\u88ab\u9a71\u9010\u7684 VirtualMachineInstance\u3002</p>"},{"location":"kubeVirt/features/node-maintenance/#vmi_1","title":"vmi \u9a71\u9010\u884c\u4e3a","text":"<p>\u4e0d\u53d7 VirtualMachineInstanceReplicaSet \u6216 VirtualMachine \u5bf9\u8c61\u652f\u6301\u7684 VirtualMachineInstance \u5728\u9a71\u9010\u540e\u4e0d\u4f1a\u88ab\u91cd\u65b0\u8c03\u5ea6\u3002</p>"},{"location":"kubeVirt/features/oversubscription/","title":"\u8d44\u6e90\u8d85\u5356","text":""},{"location":"kubeVirt/features/oversubscription/#kubevirt","title":"kubeVirt\u8d44\u6e90\u7ba1\u7406","text":"<p>Kubernetes\u901a\u8fc7Pod\u7684Resource <code>requests</code>\u6765\u7533\u8bf7\u5360\u7528\u8d44\u6e90\uff0c\u6839\u636e\u8d44\u6e90\u8bf7\u6c42\u91cfKubernetes\u8ba1\u7b97\u4e3b\u673a\u8282\u70b9\u8d44\u6e90\u8fdb\u884cPod\u7684\u8c03\u5ea6\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0bkubeVirt\u6839\u636e\u865a\u62df\u673aVM\u7684\u8d44\u6e90\u8bf7\u6c42\u4ece\u4e3b\u673a\u7533\u8bf7\u8d44\u6e90\u521b\u5efa\u865a\u62df\u673avirt-launcher Pod\uff0cPod\u8c03\u5ea6\u540e\u8c03\u7528<code>libvirt</code>\u521b\u5efa\u5bf9\u5e94\u865a\u62df\u673a\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u8fbe\u5230\u4e86Kubernetes\u5bf9\u865a\u62df\u673a\u8d44\u6e90\u7684\u7ba1\u7406\u548c\u8c03\u5ea6\u3002</p> <p>\u901a\u8fc7\u4e0a\u9762\u4ecb\u7ecd\uff0c\u6211\u4eec\u77e5\u9053kubeVirt\u53ef\u4ee5\u5206\u5f00\u914d\u7f6ePod\u7684\u8d44\u6e90<code>request</code>\u4e0e<code>libvirt</code>\u865a\u62df\u673a\u8d44\u6e90\uff0c\u6bd4\u5982\u901a\u8fc7\u8bbe\u7f6e\u4e00\u4e2a\u6bd4\u4f8b\u6765\u8fbe\u5230\u865a\u62df\u673a\u8d44\u6e90\u8d85\u5356\u3002\u4e3e\u4f8b\u8bf4\u660e\uff0c\u5982\u679c\u6211\u4eec\u8bbe\u7f6e\u5185\u5b58\u8d85\u5356\u6bd4\u4f8b\u4e3a<code>150%</code>\uff0c\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u673a\u5185\u5b58\u4e3a<code>3072M</code>\uff0c\u90a3\u4e48Pod\u8bf7\u6c42\u5185\u5b58\u8d44\u6e90\u5219\u4e3a<code>2048M</code>\u3002\u5047\u8bbe\u4e3b\u673a\u5185\u5b58\u4e3a<code>100G</code>\uff0c\u4e0d\u8003\u8651\u5176\u4ed6\u7ec4\u4ef6\u8d44\u6e90\u5f00\u9500\uff0c\u6839\u636ePod\u8bf7\u6c42\u5219\u53ef\u4ee5\u521b\u5efa\u51fa\u5185\u5b58\u603b\u91cf\u4e3a<code>150G</code>\u7684\u865a\u62df\u673a\u3002</p>"},{"location":"kubeVirt/features/oversubscription/#cpu","title":"CPU\u65f6\u95f4","text":"<p>Kubernetes\u5c06CPU\u4e00\u4e2a\u6838\u5207\u5206\u4e3a1000\u65f6\u95f4\u7247\uff0c\u4f7f\u7528m\u4f5c\u4e3a\u5355\u4f4d\uff0c<code>1m</code>\u8868\u793a\u5343\u5206\u4e4b\u4e00\u6838milliCPU\u3002</p>"},{"location":"kubeVirt/features/oversubscription/#_1","title":"\u8d44\u6e90\u8d85\u5356\u5b9e\u8df5","text":""},{"location":"kubeVirt/features/oversubscription/#kubevirt_1","title":"kubeVirt\u914d\u7f6e\u8d44\u6e90\u5206\u914d\u6bd4\u4f8b","text":"<p><code>cpuAllocationRatio</code>\u6307\u5b9aCPU\u5206\u914d\u6bd4\u4f8b<code>2000%</code>\uff0c\u6bd4\u5982\u865a\u62df\u673aCPU\u6838\u6570\u4e3a12\u6838\uff0cPod virt-launcher\u7684CPU\u8d44\u6e90\u8bf7\u6c42\u5219\u4e3a<code>600m</code>\u3002<code>memoryOvercommit</code>\u6307\u5b9a\u5185\u5b58\u5206\u914d\u6bd4\u4f8b\u4e3a<code>150%</code>\u3002</p> <pre><code>kubectl -n kubevirt edit kubevirt\n...\nspec:\nconfiguration:\ndeveloperConfiguration:\ncpuAllocationRatio: 20\nfeatureGates:\n- HardDisk\n- DataVolumes\nmemoryOvercommit: 150\n...\n</code></pre>"},{"location":"kubeVirt/features/oversubscription/#kubevirt_2","title":"\u521b\u5efakubeVirt\u865a\u62df\u673a","text":"<p>\u53ef\u4ee5\u770b\u5230<code>spec.template.domain</code>\u4e0b\u7684<code>spec.template.domain.cpu</code>\u548c<code>spec.template.domain.memory</code>\u6307\u5b9a\u4e86\u521b\u5efa\u865a\u62df\u673a\u8d44\u6e90\u3002</p> <p><code>spec.template.domain.resources.overcommitGuestOverhead</code>\u914d\u7f6e\u4e0d\u8bf7\u6c42\u989d\u5916\u8d44\u6e90\u5f00\u9500\uff0c\u7ba1\u7406\u865a\u62df\u673a\u7684\u57fa\u7840\u8bbe\u65bd\u7ec4\u4ef6\u9700\u8981\u7684\u5185\u5b58\u8d44\u6e90\u3002\u9ed8\u8ba4\u4e3a<code>false</code>\uff0c\u5f53\u521b\u5efa\u4e00\u4e2a\u865a\u62df\u673a\u5185\u5b58\u4e3a<code>1Gi</code>\u65f6\uff0cvirt-launcher Pod\u8bf7\u6c42\u7684\u5185\u5b58\u8d44\u6e90\u4e3a<code>1Gi + 200Mi</code>\u3002</p> <p><code>spec.template.domain.resources.requests</code>\u8fd9\u91cc\u4ecd\u7136\u6307\u5b9a\u4e86<code>requests</code>\uff0cvirt-launcher Pod\u5c06\u4f7f\u7528\u8fd9\u4e2a<code>requests</code>\u6765\u8bf7\u6c42k8s\u8d44\u6e90\uff0c\u8fd9\u6837\u5c31\u4f1a\u4e0d\u4f7f\u7528\u4e0a\u9762\u914d\u7f6e\u7684\u6bd4\u4f8b\u3002\u4e00\u822c\u60c5\u51b5\u4e0d\u9700\u8981\u518d\u8fd9\u91cc\u6307\u5b9a<code>requests</code>\uff0ckubeVirt\u4f7f\u7528\u6bd4\u4f8b\u8ba1\u7b97\u51fa<code>requests</code>\u7684\u8d44\u6e90\u91cf\u3002</p> <pre><code>apiVersion: kubevirt.io/v1\nkind: VirtualMachine\nmetadata:\nlabels:\nkubevirt.io/vm: mailserver\nname: ubuntu-c\nnamespace: mail263\nspec:\nrunning: true\ntemplate:\nmetadata:\nlabels:\nkubevirt.io/vm: ubuntu-c\nannotations:\novn.kubernetes.io/ip_address: 172.16.3.203\novn.kubernetes.io/mac_address: 00:00:00:1F:C5:8F\nspec:\ndomain:\ncpu:\ncores: 12\nmodel: host-passthrough\nmemory:\nguest: 96Gi\ndevices:\ndisks:\n- name: bootdisk\ndisk:\nbus: virtio\n- disk:\nbus: virtio\nname: cloudinitdisk\ninterfaces:\n- name: default\nbridge: {}\nmacAddress: 00:00:00:1f:c5:8f\nresources:\novercommitGuestOverhead: true\nrequests:\nmemory: 16Gi\nnetworks:\n- name: default\npod: {}\nterminationGracePeriodSeconds: 0\nvolumes:\n- name: bootdisk\ndataVolume:\nname: ubuntuboot-c\n- name: cloudinitdisk\ncloudInitNoCloud:\nuserData: |-\n#cloud-config\nssh_pwauth: True\nchpasswd:\nlist: |\nubuntu:ubuntu\n</code></pre>"},{"location":"kubeVirt/features/oversubscription/#kubevirtubuntu-cvmi","title":"\u67e5\u770bkubeVirt\u7684ubuntu-c\u865a\u62df\u673aVMI\u8d44\u6e90\u5b9a\u4e49","text":"<pre><code>spec:\ndomain:\ncpu:\ncores: 12\nmodel: host-passthrough\nmemory:\nguest: 96Gi\nresources:\novercommitGuestOverhead: true\nrequests:\nmemory: 16Gi\n</code></pre>"},{"location":"kubeVirt/features/oversubscription/#virt-launcher-pod","title":"\u67e5\u770bvirt-launcher Pod\u8d44\u6e90\u8bf7\u6c42","text":"<p>\u53ef\u4ee5\u770b\u5230CPU\u6839\u636e\u914d\u7f6e\u7684\u6bd4\u4f8b<code>2000%</code>\u8ba1\u7b97\u5f97\u5230\uff0c\u5185\u5b58\u6839\u636e<code>requests</code>\u6307\u5b9a\u503c\u7533\u8bf7\u3002</p> <pre><code>    resources:\nlimits:\ndevices.kubevirt.io/kvm: \"1\"\ndevices.kubevirt.io/tun: \"1\"\ndevices.kubevirt.io/vhost-net: \"1\"\nrequests:\ncpu: 600m\ndevices.kubevirt.io/kvm: \"1\"\ndevices.kubevirt.io/tun: \"1\"\ndevices.kubevirt.io/vhost-net: \"1\"\nephemeral-storage: 50M\nmemory: 16Gi\n</code></pre>"},{"location":"kubeVirt/features/oversubscription/#_2","title":"\u67e5\u770b\u865a\u62df\u673a\u7cfb\u7edf\u8d44\u6e90","text":"<pre><code>ubuntu@ubuntu-c:~$ free -m\n              total        used        free      shared  buff/cache   available\nMem:          96575         290       95782           1         503       95442\nSwap:             0           0           0\nubuntu@ubuntu-c:~$ top\ntop - 10:38:49 up 10:17,  1 user,  load average: 0.48, 0.20, 0.08\nTasks: 198 total,   1 running, 197 sleeping,   0 stopped,   0 zombie\n%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu1  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu2  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu3  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu4  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu5  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu6  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu7  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu8  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu9  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu10 :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n%Cpu11 :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\nMiB Mem :  96575.3 total,  95781.5 free,    290.4 used,    503.4 buff/cache\nMiB Swap:      0.0 total,      0.0 free,      0.0 used.  95441.8 avail Mem\n</code></pre>"},{"location":"kubeVirt/features/vm-mem-dump/","title":"\u865a\u62df\u673a\u5185\u5b58\u8f6c\u50a8","text":"<p>kubeVirt \u73b0\u5728\u652f\u6301\u83b7\u53d6 VM \u5185\u5b58\u8f6c\u50a8\u4ee5\u8fdb\u884c\u5206\u6790\u3002 \u5185\u5b58\u8f6c\u50a8\u53ef\u7528\u4e8e\u8bca\u65ad\u3001\u8bc6\u522b\u548c\u89e3\u51b3\u865a\u62df\u673a\u4e2d\u7684\u95ee\u9898\u3002 \u901a\u5e38\u63d0\u4f9b\u6709\u5173\u7a0b\u5e8f\u3001\u5e94\u7528\u7a0b\u5e8f\u548c\u7cfb\u7edf\u7ec8\u6b62\u6216\u5d29\u6e83\u4e4b\u524d\u7684\u6700\u540e\u72b6\u6001\u7684\u4fe1\u606f\u3002</p> <p>\u5907\u6ce8</p> <p>\u6b64\u5185\u5b58\u8f6c\u50a8\u4e0d\u7528\u4e8e\u4fdd\u5b58\u865a\u62df\u673a\u72b6\u6001\u5e76\u5728\u4ee5\u540e\u6062\u590d\u3002</p>"},{"location":"kubeVirt/features/vm-mem-dump/#_1","title":"\u5148\u51b3\u6761\u4ef6","text":""},{"location":"kubeVirt/features/vm-mem-dump/#_2","title":"\u70ed\u63d2\u62d4\u95e8\u63a7","text":"<p>\u5185\u5b58\u8f6c\u50a8\u8fdb\u7a0b\u5c06 PVC \u5b89\u88c5\u5230 virt-launcher\uff0c\u4ee5\u4fbf\u83b7\u53d6\u8be5 PVC \u4e2d\u7684\u8f93\u51fa\uff0c\u56e0\u6b64\u5fc5\u987b\u542f\u7528\u70ed\u63d2\u62d4\u5377\u529f\u80fd\u95e8\u3002 KubeVirt CR \u4e2d\u7684\u529f\u80fd\u95e8\u5b57\u6bb5\u5fc5\u987b\u901a\u8fc7\u6dfb\u52a0 <code>HotplugVolumes</code> \u6765\u6269\u5c55\u3002</p>"},{"location":"kubeVirt/features/vm-mem-dump/#virtctl","title":"virtctl \u652f\u6301","text":""},{"location":"kubeVirt/features/vm-mem-dump/#_3","title":"\u83b7\u53d6\u5185\u5b58\u8f6c\u50a8","text":"<p>\u73b0\u5728\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u4e2a\u6b63\u5728\u8fd0\u884c\u7684\u865a\u62df\u673a\uff0c\u5e76\u4e14\u8be5\u865a\u62df\u673a\u7684\u540d\u79f0\u662f\"my-vm\"\u3002 \u6211\u4eec\u53ef\u4ee5\u8f6c\u50a8\u5230\u73b0\u6709\u7684 pvc\uff0c\u6216\u8005\u8bf7\u6c42\u521b\u5efa\u4e00\u4e2a\u3002</p>"},{"location":"kubeVirt/features/vm-mem-dump/#pvc","title":"\u73b0\u6709 PVC","text":"<p>PVC \u7684\u5927\u5c0f\u5fc5\u987b\u8db3\u591f\u5927\u4ee5\u5bb9\u7eb3\u5185\u5b58\u8f6c\u50a8\u3002 \u8ba1\u7b97\u516c\u5f0f\u4e3a <code>(VMMemorySize + 100Mi) * FileSystemOverhead</code>\uff0c\u5176\u4e2d <code>VMMemorySize</code> \u662f\u5185\u5b58\u5927\u5c0f\uff0c<code>100Mi</code> \u662f\u4e3a\u5185\u5b58\u8f6c\u50a8\u5f00\u9500\u4fdd\u7559\u7684\u7a7a\u95f4\uff0c<code>FileSystemOverhead</code> \u662f\u7528\u4e8e\u6839\u636e\u6587\u4ef6\u7cfb\u7edf\u5f00\u9500\u8c03\u6574\u8bf7\u6c42\u7684 PVC \u5927\u5c0f\u7684\u503c\u3002 PVC \u8fd8\u5fc5\u987b\u5177\u6709\u6587\u4ef6\u7cfb\u7edf\u5377\u6a21\u5f0f\u3002</p> <p>\u4f8b\u5982\uff1a</p> <p>PVC\u4f8b\u5b50</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: my-pvc\nspec:\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 2Gi\nstorageClassName: rook-ceph-block\nvolumeMode: Filesystem\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 virtctl \u63d0\u4f9b\u7684<code>memory-dump get</code>\u547d\u4ee4\u5c06 VM \u7684\u5185\u5b58\u8f6c\u50a8\u5230 PVC\uff0c</p> <pre><code>$ virtctl memory-dump get my-vm --claim-name=my-pvc\n</code></pre>"},{"location":"kubeVirt/features/vm-mem-dump/#pvc_1","title":"\u6309\u9700 PVC","text":"<p>\u5bf9\u4e8e\u6309\u9700 PVC\uff0c\u6211\u4eec\u9700\u8981\u5728 virtctl \u8bf7\u6c42\u4e2d\u6dfb\u52a0 <code>--create-claim</code> \u6807\u5fd7\uff1a</p> <pre><code>$ virtctl memory-dump get my-vm --claim-name=new-pvc --create-claim\n</code></pre> <p>\u5c06\u521b\u5efa\u5927\u5c0f\u8db3\u4ee5\u5bb9\u7eb3\u8f6c\u50a8\u7684 PVC\u3002 \u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528\u9002\u5f53\u7684\u6807\u5fd7\u6765\u8bf7\u6c42\u7279\u5b9a\u7684\u5b58\u50a8\u7c7b\u522b\u548c\u8bbf\u95ee\u6a21\u5f0f\u3002</p>"},{"location":"kubeVirt/features/vm-mem-dump/#_4","title":"\u4e0b\u8f7d\u5185\u5b58\u8f6c\u50a8","text":"<p>\u901a\u8fc7\u6dfb\u52a0 <code>--output</code> \u6807\u5fd7\uff0c\u5185\u5b58\u5c06\u8f6c\u50a8\u5230 PVC\uff0c\u7136\u540e\u4e0b\u8f7d\u5230\u7ed9\u5b9a\u7684\u8f93\u51fa\u8def\u5f84\u3002</p> <pre><code>$ virtctl memory-dump get myvm --claim-name=memoryvolume --create-claim --output=memoryDump.dump.gz\n</code></pre> <p>\u8981\u4ece\u4e0e VM \u5173\u8054\u7684 PVC \u4e0b\u8f7d\u6700\u540e\u7684\u5185\u5b58\u8f6c\u50a8\u800c\u4e0d\u89e6\u53d1\u53e6\u4e00\u4e2a\u5185\u5b58\u8f6c\u50a8\uff0c\u8bf7\u4f7f\u7528\u5185\u5b58\u8f6c\u50a8\u4e0b\u8f7d\u547d\u4ee4\u3002</p> <pre><code>$ virtctl memory-dump download myvm --output=memoryDump.dump.gz\n</code></pre> <p>\u8981\u4ece\u5df2\u4e0e VM \u89e3\u9664\u5173\u8054\u7684 PVC \u4e0b\u8f7d\u5185\u5b58\u8f6c\u50a8\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>virtctl vmexport</code> \u547d\u4ee4\u3002</p>"},{"location":"kubeVirt/features/vm-mem-dump/#_5","title":"\u76d1\u63a7\u5185\u5b58\u8f6c\u50a8","text":""},{"location":"kubeVirt/features/tekton/","title":"Tekton\u6982\u89c8","text":""},{"location":"kubeVirt/features/tekton/#_1","title":"\u5148\u51b3\u6761\u4ef6","text":"<ul> <li>Tekton</li> <li>KubeVirt</li> <li>CDI</li> <li>SSP</li> </ul>"},{"location":"kubeVirt/features/tekton/#_2","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"kubeVirt/features/tekton/#operator","title":"\u76f8\u5173 Operator","text":"<p>HCO</p><p>HyperConverged Cluster Operator</p> <p>SSP</p><p>SSP Operator</p>"},{"location":"kubeVirt/features/tekton/#tekton_1","title":"Tekton","text":"<p>Tekton \u5b89\u88c5</p><p>Tekton Installation</p> <p>Tekton \u4efb\u52a1</p><p>Tekton Task</p>"},{"location":"kubeVirt/kubeVirt/quick-deploy/","title":"\u865a\u62df\u673a\u90e8\u7f72\u5b9e\u6218","text":"<p>\u4fd7\u8bdd\u8bf4\uff0c\u5b9e\u8df5\u662f\u68c0\u9a8c\u771f\u7406\u7684\u552f\u4e00\u6807\u51c6\uff0c\u4e0d\u59a8\u8ba9\u6211\u4eec\u5c1d\u8bd5\u7528kubeVirt\u90e8\u7f72\u4e00\u53f0\u5c5e\u4e8e\u81ea\u5df1\u7684\u865a\u62df\u673a\u5427~</p>"},{"location":"kubeVirt/kubeVirt/quick-deploy/#_1","title":"\u51c6\u5907\u73af\u5883","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u5b89\u88c5<code>libvirt</code>\u548c<code>qemu</code>\uff0c</p> <pre><code>yum install -y qemu-kvm libvirt virt-install bridge-utils\n</code></pre> <p>\u67e5\u770b\u8282\u70b9\u662f\u5426\u652f\u6301 kvm \u865a\u62df\u673a\u5316</p> <pre><code>$ virt-host-validate qemu\n  QEMU: \u6b63\u5728\u68c0\u67e5 for hardware virtualization                           : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 if device /dev/kvm exists                             : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 if device /dev/kvm is accessible                      : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 if device /dev/vhost-net exists                       : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 if device /dev/net/tun exists                         : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'memory' controller support                : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'memory' controller mount-point            : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'cpu' controller support                   : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'cpu' controller mount-point               : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'cpuacct' controller support               : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'cpuacct' controller mount-point           : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'cpuset' controller support                : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'cpuset' controller mount-point            : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'devices' controller support               : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'devices' controller mount-point           : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'blkio' controller support                 : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for cgroup 'blkio' controller mount-point             : PASS\n  QEMU: \u6b63\u5728\u68c0\u67e5 for device assignment IOMMU support                   : WARN (No ACPI DMAR table found, IOMMU either disabled in BIOS or not supported by this hardware platform)\n</code></pre> <p>\u5982\u679c\u4e0d\u652f\u6301\uff0c\u5219\u8ba9 Kubevirt \u4f7f\u7528\u8f6f\u4ef6\u865a\u62df\u5316\uff1a</p> <pre><code>kubectl create namespace kubevirt\nkubectl create configmap -n kubevirt kubevirt-config --from-literal debug.useEmulation=true\n</code></pre> <p>\u5f00\u59cb\u90e8\u7f72\u6700\u65b0\u7248\u672c\u7684kubeVirt\uff0c</p> <pre><code>export VERSION=$(curl -s https://api.github.com/repos/kubevirt/kubevirt/releases | grep tag_name | grep -v -- '-rc' | head -1 | awk -F': ' '{print $2}' | sed 's/,//' | xargs)\nkubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/kubevirt-operator.yaml\nkubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/${VERSION}/kubevirt-cr.yaml\n</code></pre> <p>\u67e5\u770b\u547d\u4ee4\u6267\u884c\u7ed3\u679c</p> <pre><code>$ kubectl get pods -n kubevirt\nNAME                               READY   STATUS    RESTARTS      AGE\nvirt-api-59d4c5cb49-6b2r2          1/1     Running   1 (82m ago)   82m\nvirt-api-59d4c5cb49-d9w4z          1/1     Running   1 (82m ago)   82m\nvirt-controller-8684f9db98-d6w6p   1/1     Running   0             82m\nvirt-controller-8684f9db98-hrkjg   1/1     Running   0             82m\nvirt-handler-2hfxz                 1/1     Running   0             82m\nvirt-handler-4vk84                 1/1     Running   0             82m\nvirt-handler-qg4qt                 1/1     Running   0             82m\nvirt-handler-qnzsh                 1/1     Running   0             82m\nvirt-operator-5fcd4ff76f-47n27     1/1     Running   0             84m\nvirt-operator-5fcd4ff76f-kq4h8     1/1     Running   0             84m\n</code></pre> <p>\u63a5\u7740\u6211\u4eec\u90e8\u7f72CDI\uff0cCDI (Containerized Data Importer) \u53ef\u4ee5\u4f7f\u7528 PVC \u4f5c\u4e3a KubeVirt VM \u78c1\u76d8\uff0c\u5efa\u8bae\u540c\u65f6\u5b89\u88c5\uff1a</p> <pre><code>export VERSION=$(curl -s https://github.com/kubevirt/containerized-data-importer/releases | grep -o \"v[0-9]\\.[0-9]*\\.[0-9]*\" | head -1)\nkubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-operator.yaml\nkubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-cr.yaml\n</code></pre> <p>\u5b89\u88c5<code>virtctl</code>\u5de5\u5177\uff0cvirtctl \u5de5\u5177\u53ef\u4ee5\u76f4\u63a5\u7528\u6765\u64cd\u4f5c\u865a\u62df\u673a\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7d\uff0c</p> <pre><code>export VERSION=$(curl -s https://api.github.com/repos/kubevirt/kubevirt/releases | grep tag_name | grep -v -- '-rc' | head -1 | awk -F': ' '{print $2}' | sed 's/,//' | xargs)\ncurl -L -o /usr/local/bin/virtctl https://github.com/kubevirt/kubevirt/releases/download/$VERSION/virtctl-$VERSION-linux-amd64\nchmod +x /usr/local/bin/virtctl\n</code></pre>"},{"location":"kubeVirt/kubeVirt/quick-deploy/#centos7","title":"\u90e8\u7f72\u865a\u62df\u673aCentOS7","text":""},{"location":"kubeVirt/kubeVirt/quick-deploy/#_2","title":"\u51c6\u5907\u7cfb\u7edf\u955c\u50cf","text":"<p>\u4e0b\u8f7d CentOS7 \u955c\u50cf\uff0c\u9009\u62e9\u963f\u91cc\u4e91\u955c\u50cf\u7ad9 https://mirrors.aliyun.com/centos/7/isos/x86_64/</p> <p></p>"},{"location":"kubeVirt/kubeVirt/quick-deploy/#_3","title":"\u4e0a\u4f20\u955c\u50cf\u6587\u4ef6","text":"<p>KubeVirt \u53ef\u4ee5\u4f7f\u7528 PVC \u4f5c\u4e3a\u540e\u7aef\u78c1\u76d8\uff0c\u4f7f\u7528 <code>filesystem</code> \u7c7b\u578b\u7684 PVC \u65f6\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u65f6 <code>/disk.img</code> \u8fd9\u4e2a\u955c\u50cf\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u955c\u50cf\u4e0a\u4f20\u5230 PVC\uff0c \u5728\u521b\u5efa VMI \u65f6\u4f7f\u7528\u6b64 PVC\u3002\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u9700\u8981\u6ce8\u610f\u4e0b\u9762\u51e0\u70b9\uff1a</p> <ul> <li>\u4e00\u4e2a PVC \u53ea\u5141\u8bb8\u5b58\u5728\u4e00\u4e2a\u955c\u50cf\uff0c\u53ea\u5141\u8bb8\u4e00\u4e2a VMI \u4f7f\u7528\uff0c\u8981\u521b\u5efa\u591a\u4e2a VMI\uff0c\u9700\u8981\u4e0a\u4f20\u591a\u6b21</li> <li><code>/disk.img</code> \u7684\u683c\u5f0f\u5fc5\u987b\u662f RAW \u683c\u5f0f</li> </ul> <p>CDI \u63d0\u4f9b\u4e86\u4f7f\u7528\u4f7f\u7528 PVC \u4f5c\u4e3a\u865a\u62df\u673a\u78c1\u76d8\u7684\u65b9\u6848\uff0c\u5728\u865a\u62df\u673a\u542f\u52a8\u524d\u901a\u8fc7\u4e0b\u9762\u65b9\u5f0f\u586b\u5145 PVC\uff1a</p> <ul> <li>\u901a\u8fc7 URL \u5bfc\u5165\u865a\u62df\u673a\u955c\u50cf\u5230 PVC\uff0cURL \u53ef\u4ee5\u662f http \u94fe\u63a5\uff0cs3 \u94fe\u63a5</li> <li>Clone \u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684 PVC</li> <li>\u901a\u8fc7 container registry \u5bfc\u5165\u865a\u62df\u673a\u78c1\u76d8\u5230 PVC\uff0c\u9700\u8981\u7ed3\u5408 <code>ContainerDisk</code> \u4f7f\u7528</li> <li>\u901a\u8fc7\u5ba2\u6237\u7aef\u4e0a\u4f20\u672c\u5730\u955c\u50cf\u5230 PVC</li> </ul> <p>\u901a\u8fc7\u547d\u4ee4\u884c <code>virtctl</code>\uff0c\u7ed3\u5408 CDI \u9879\u76ee\uff0c\u53ef\u4ee5\u4e0a\u4f20\u672c\u5730\u955c\u50cf\u5230 PVC \u4e0a\uff0c\u652f\u6301\u7684\u955c\u50cf\u683c\u5f0f\u6709\uff1a</p> <ul> <li><code>.img</code></li> <li><code>.qcow2</code></li> <li><code>.iso</code></li> <li>\u538b\u7f29\u4e3a <code>.tar</code>\uff0c<code>.gz</code>\uff0c<code>.xz</code> \u683c\u5f0f\u7684\u4e0a\u8ff0\u955c\u50cf</li> </ul> <p>\u4e0a\u4f20\u955c\u50cf\u6587\u4ef6</p> <pre><code>$  export CDI_PROXY=`kubectl -n cdi get svc -l cdi.kubevirt.io=cdi-uploadproxy -o go-template --template='{{ (index .items 0).spec.clusterIP }}'`\n$ virtctl image-upload --image-path='/root/iso/CentOS-7-x86_64-DVD-2009.iso' --pvc-name=iso-centos7  --pvc-size=5G --uploadproxy-url=https://$CDI_PROXY  --insecure  --wait-secs=240\nPVC default/iso-centos7 not found\nPersistentVolumeClaim default/iso-centos7 created\nWaiting for PVC iso-centos7 upload pod to be ready...\nPod now ready\nUploading data to https://10.98.254.51\n\n4.39 GiB / 4.39 GiB [=============================================================================================================================================================] 100.00% 3m43s\n\nUploading data completed successfully, waiting for processing to complete, you can hit ctrl-c without interrupting the progress\nProcessing completed successfully\nUploading /root/iso/CentOS-7-x86_64-DVD-2009.iso completed successfully\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li><code>\u2013image-path</code> : \u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\u8def\u5f84\u3002</li> <li><code>\u2013pvc-name</code> : \u6307\u5b9a\u5b58\u50a8\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\u7684 PVC\uff0c\u8fd9\u4e2a PVC \u4e0d\u9700\u8981\u63d0\u524d\u51c6\u5907\u597d\uff0c\u955c\u50cf\u4e0a\u4f20\u8fc7\u7a0b\u4e2d\u4f1a\u81ea\u52a8\u521b\u5efa\u3002</li> <li><code>\u2013pvc-size</code> : PVC \u5927\u5c0f\uff0c\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\u5927\u5c0f\u6765\u8bbe\u5b9a\uff0c\u4e00\u822c\u7565\u5927\u4e00\u4e2a G \u5c31\u884c\u3002</li> <li><code>\u2013uploadproxy-url</code> : <code>cdi-uploadproxy</code> \u7684 Service IP\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>kubectl -n cdi get svc -l cdi.kubevirt.io=cdi-uploadproxy</code> \u6765\u67e5\u770b\u3002</li> </ul>"},{"location":"kubeVirt/kubeVirt/quick-deploy/#hostdisk","title":"\u542f\u52a8HostDisk\u7279\u6027\u95e8\u63a7","text":"<p>kubeVirt\u652f\u6301<code>HostDisk</code></p> <pre><code>$ kubectl edit kubevirt kubevirt -n kubevirt\n    ...\n    spec:\n      configuration:\n        developerConfiguration:\n          featureGates:\n            - DataVolumes\n            - LiveMigration\n            - HostDisk\n    ...\n</code></pre>"},{"location":"kubeVirt/kubeVirt/quick-deploy/#centos7_1","title":"\u7f16\u6392CentOS7\u865a\u62df\u673a\u6a21\u677f\u6587\u4ef6","text":"kubevirt-centos7.yaml<pre><code>apiVersion: kubevirt.io/v1beta1\nkind: VirtualMachine\nmetadata:\nname: centos7\nspec:\nrunning: false\ntemplate:\nmetadata:\nlabels:\nkubevirt.io/domain: centos7\nspec:\ndomain:\ncpu:\ncores: 1\ndevices:\ndisks:\n- bootOrder: 1\ncdrom:\nbus: sata\nname: cdromiso\n- disk:\nbus: virtio\nname: harddrive\n- cdrom:\nbus: sata\nname: virtiocontainerdisk\ninterfaces:\n- masquerade: {}\nmodel: e1000\nname: default\nmachine:\ntype: q35\nresources:\nrequests:\nmemory: 2G\nnetworks:\n- name: default\npod: {}\nvolumes:\n- name: cdromiso\npersistentVolumeClaim:\nclaimName: iso-centos7\n- name: harddrive\nhostDisk:\ncapacity: 30Gi\npath: /data/disk.img\ntype: DiskOrCreate\n- containerDisk:\nimage: kubevirt/virtio-container-disk\nname: virtiocontainerdisk\n</code></pre> <p>\u8fd9\u91cc\u7528\u5230\u4e86 3 \u4e2a Volume\uff1a</p> <ul> <li><code>cdromiso</code> : \u63d0\u4f9b\u64cd\u4f5c\u7cfb\u7edf\u5b89\u88c5\u955c\u50cf\uff0c\u5373\u4e0a\u6587\u4e0a\u4f20\u955c\u50cf\u540e\u751f\u6210\u7684 PVC iso-centos7\u3002</li> <li><code>harddrive</code> : \u865a\u62df\u673a\u4f7f\u7528\u7684\u78c1\u76d8\uff0c\u5373\u64cd\u4f5c\u7cfb\u7edf\u5c31\u4f1a\u5b89\u88c5\u5728\u8be5\u78c1\u76d8\u4e0a\u3002\u8fd9\u91cc\u9009\u62e9 <code>hostDisk</code> \u76f4\u63a5\u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u4ee5\u63d0\u5347\u6027\u80fd\uff0c\u5982\u679c\u4f7f\u7528\u5206\u5e03\u5f0f\u5b58\u50a8\u5219\u4f53\u9a8c\u975e\u5e38\u4e0d\u597d\u3002</li> <li><code>containerDisk</code> : \u7531\u4e8e Windows \u9ed8\u8ba4\u65e0\u6cd5\u8bc6\u522b <code>raw</code> \u683c\u5f0f\u7684\u78c1\u76d8\uff0c\u6240\u4ee5\u9700\u8981\u5b89\u88c5 <code>virtio</code> \u9a71\u52a8\u3002 <code>containerDisk</code> \u53ef\u4ee5\u5c06\u6253\u5305\u597d <code>virtio</code> \u9a71\u52a8\u7684\u5bb9\u5668\u955c\u50cf\u6302\u8f7d\u5230\u865a\u62df\u673a\u4e2d\u3002</li> </ul> <p>\u5173\u4e8e\u7f51\u7edc\u90e8\u5206\uff0c<code>spec.template.spec.networks</code> \u5b9a\u4e49\u4e86\u4e00\u4e2a\u7f51\u7edc\u53eb <code>default</code>\uff0c\u8fd9\u91cc\u8868\u793a\u4f7f\u7528 Kubernetes \u9ed8\u8ba4\u7684 CNI\u3002<code>spec.template.spec.domain.devices.interfaces</code> \u9009\u62e9\u5b9a\u4e49\u7684 \u7f51\u7edc <code>default</code>\uff0c\u5e76\u5f00\u542f <code>masquerade</code>\uff0c\u4ee5\u4f7f\u7528\u7f51\u7edc\u5730\u5740\u8f6c\u6362 (NAT) \u6765\u901a\u8fc7 Linux \u7f51\u6865\u5c06\u865a\u62df\u673a\u8fde\u63a5\u81f3 Pod \u7f51\u7edc\u540e\u7aef\u3002</p> <p>\u7f16\u6392\u6a21\u677f\u6587\u4ef6\uff0c</p> <pre><code>kubectl apply -f kubevirt-centos7.yaml\n</code></pre>"},{"location":"kubeVirt/kubeVirt/quick-deploy/#vnc","title":"\u542f\u52a8\u865a\u62df\u673a\u548cvnc\u4ee3\u7406","text":"<p>\u542f\u52a8\u865a\u62df\u673a\uff0c</p> <pre><code>virtctl start centos7\n</code></pre> <p>\u542f\u52a8vnc\u4ee3\u7406\uff0c</p> <pre><code>$ virtctl vnc centos7 --proxy-only --address=0.0.0.0\n{\"port\":42743}\n{\"component\":\"\",\"level\":\"info\",\"msg\":\"connection timeout: 1m0s\",\"pos\":\"vnc.go:153\",\"timestamp\":\"2022-06-07T10:06:11.066704Z\"}\n{\"component\":\"\",\"level\":\"info\",\"msg\":\"VNC Client connected in 7.866330333s\",\"pos\":\"vnc.go:166\",\"timestamp\":\"2022-06-07T10:06:18.933070Z\"}\n</code></pre> <p>\u6267\u884c\u5b8c\u4e0a\u9762\u7684\u547d\u4ee4\u540e\uff0c\u5c31\u4f1a\u6253\u5f00\u672c\u5730\u7684 VNC \u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u865a\u62df\u673a\uff0c</p> <p></p> <p>\u76f4\u63a5\u4e0b\u4e00\u6b65\u76f4\u5230\u5b8c\u6210\u5373\u53ef\u3002\u5b89\u88c5\u5b8c\u6210\u91cd\u542f\u540e\u865a\u62df\u673a\u4f9d\u65e7\u4f1a\u4ece <code>cdrom</code> \u542f\u52a8\uff0c\u4fee\u6539 vm\uff0c</p> <pre><code>virtctl stop centos7\nkubectl edit virtualmachine.kubevirt.io/centos7\n</code></pre> <p>\u8bbe\u786c\u76d8\u4e3a\u7b2c\u4e00\u542f\u52a8\u9879\uff0c</p> <pre><code>...\n        devices:\n          disks:\n          - bootOrder: 2\ncdrom:\n              bus: sata\n            name: cdromiso\n          - bootOrder: 1\ndisk:\n              bus: virtio\n            name: harddrive\n...\n</code></pre> <p>\u4fee\u6539\u5b8c\u6210\uff0c\u91cd\u542f\u865a\u62df\u673a</p> <pre><code>virtctl start centos7\n</code></pre> <p>centOS7 \u865a\u62df\u673a\u542f\u52a8\u6b63\u5e38\u3002</p> <p></p>"},{"location":"kubeVirt/kubeVirt/quick-learn/","title":"\u67b6\u6784\u4e0e\u751f\u547d\u5468\u671f\u7ba1\u7406","text":""},{"location":"kubeVirt/kubeVirt/quick-learn/#kubevirt","title":"kubeVirt\u7684\u67b6\u6784","text":"<p>kubeVirt\u4ee5CRD\u7684\u5f62\u5f0f\u5c06VM\u7ba1\u7406\u63a5\u53e3\u63a5\u5165\u5230kubernetes\u4e2d\uff0c\u901a\u8fc7\u4e00\u4e2apod\u53bb\u4f7f\u7528libvirtd\u7ba1\u7406VM\u7684\u65b9\u5f0f\uff0c\u5b9e\u73b0pod\u4e0eVM\u7684\u4e00\u4e00\u5bf9\u5e94\uff0c\u505a\u5230\u5982\u540c\u5bb9\u5668\u4e00\u822c\u53bb\u7ba1\u7406\u865a\u62df\u673a\uff0c\u5e76\u4e14\u505a\u5230\u4e0e\u5bb9\u5668\u4e00\u6837\u7684\u8d44\u6e90\u7ba1\u7406\u3001\u8c03\u5ea6\u89c4\u5212\u3001\u8fd9\u4e00\u5c42\u6574\u4f53\u4e0e\u4f01\u4e1aIAAS\u5173\u7cfb\u4e0d\u5927\uff0c\u4e5f\u65b9\u4fbf\u4f01\u4e1a\u7684\u63a5\u5165\uff0c\u7edf\u4e00\u7eb3\u7ba1\u3002</p> \u7ec4\u4ef6 \u63cf\u8ff0 <code>virt-api</code> kubeVirt\u662f\u4ee5CRD\u5f62\u5f0f\u53bb\u7ba1\u7406VM Pod\uff0c<code>virt-api</code>\u5c31\u662f\u6240\u6709\u865a\u62df\u5316\u64cd\u4f5c\u7684\u5165\u53e3\uff0c\u8fd9\u91cc\u9762\u5305\u62ec\u5e38\u89c4\u7684CDR\u66f4\u65b0\u9a8c\u8bc1\u3001\u4ee5\u53ca<code>console\u3001vm start\u3001stop</code>\u7b49\u64cd\u4f5c\u3002 <code>virt-controller</code> <li> <code>virt-controller</code>\u4f1a\u6839\u636evmi CRD\uff0c\u751f\u6210\u5bf9\u5e94\u7684<code>virt-launcher</code> Pod\uff0c\u5e76\u7ef4\u62a4CRD\u7684\u72b6\u6001\u3002<li> \u4e0ekubernetes api-server\u901a\u8baf\u76d1\u63a7VMI\u8d44\u6e90\u7684\u521b\u5efa\u5220\u9664\u7b49\u72b6\u6001\u3002 <code>virt-handler</code> <li> <code>virt-handler</code>\u4f1a\u4ee5daemonset\u5f62\u5f0f\u90e8\u7f72\u5728\u6bcf\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u8d1f\u8d23\u76d1\u63a7\u8282\u70b9\u4e0a\u7684\u6bcf\u4e2a\u865a\u62df\u673a\u5b9e\u4f8b\u72b6\u6001\u53d8\u5316\uff0c\u4e00\u65e6\u68c0\u6d4b\u5230\u72b6\u6001\u7684\u53d8\u5316\uff0c\u4f1a\u8fdb\u884c\u54cd\u5e94\u5e76\u4e14\u786e\u4fdd\u76f8\u5e94\u7684\u64cd\u4f5c\u80fd\u591f\u8fbe\u5230\u6240\u9700\uff08\u7406\u60f3\uff09\u7684\u72b6\u6001\u3002<li> <code>virt-handler</code>\u8fd8\u4f1a\u4fdd\u6301\u96c6\u7fa4\u7ea7\u522b<code>VMI Spec</code>\u4e0e\u76f8\u5e94libvirt\u57df\u4e4b\u95f4\u7684\u540c\u6b65\uff1b\u62a5\u544a<code>libvirt</code>\u57df\u72b6\u6001\u548c\u96c6\u7fa4Spec\u7684\u53d8\u5316\uff1b\u8c03\u7528\u4ee5\u8282\u70b9\u4e3a\u4e2d\u5fc3\u7684\u63d2\u4ef6\u4ee5\u6ee1\u8db3VMI Spec\u5b9a\u4e49\u7684\u7f51\u7edc\u548c\u5b58\u50a8\u8981\u6c42\u3002 <code>virt-launcher</code> <li> \u6bcf\u4e2a<code>virt-launcher</code> pod\u5bf9\u5e94\u7740\u4e00\u4e2aVMI\uff0ckubelet\u53ea\u8d1f\u8d23<code>virt-launcher</code> pod\u8fd0\u884c\u72b6\u6001\uff0c\u4e0d\u4f1a\u53bb\u5173\u5fc3VMI\u521b\u5efa\u60c5\u51b5\u3002<li> <code>virt-handler</code>\u4f1a\u6839\u636eCRD\u53c2\u6570\u914d\u7f6e\u53bb\u901a\u77e5<code>virt-launcher</code>\u53bb\u4f7f\u7528\u672c\u5730\u7684<code>libvirtd</code>\u5b9e\u4f8b\u6765\u542f\u52a8VMI\uff0c\u968f\u7740Pod\u7684\u751f\u547d\u5468\u671f\u7ed3\u675f\uff0c<code>virt-lanuncher</code>\u4e5f\u4f1a\u53bb\u901a\u77e5VMI\u53bb\u6267\u884c\u7ec8\u6b62\u64cd\u4f5c\uff1b<li> \u5176\u6b21\u5728\u6bcf\u4e2a<code>virt-launcher</code> pod\u4e2d\u8fd8\u5bf9\u5e94\u7740\u4e00\u4e2a<code>libvirtd</code>\uff0c<code>virt-launcher</code>\u901a\u8fc7<code>libvirtd</code>\u53bb\u7ba1\u7406VM\u7684\u751f\u547d\u5468\u671f\uff0c\u8fd9\u6837\u505a\u5230\u53bb\u4e2d\u5fc3\u5316\uff0c\u4e0d\u518d\u662f\u4ee5\u524d\u7684\u865a\u62df\u673a\u90a3\u5957\u505a\u6cd5\uff0c\u4e00\u4e2a<code>libvirtd</code>\u53bb\u7ba1\u7406\u591a\u4e2aVM\u3002 <code>virtctl</code> kubeVirt\u81ea\u5e26\u7c7b\u4f3c<code>kubectl</code>\u7684\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u5b83\u662f\u8d8a\u8fc7<code>virt-launcher</code> pod\u8fd9\u4e00\u5c42\u53bb\u76f4\u63a5\u7ba1\u7406VM\u865a\u62df\u673a\uff0c\u53ef\u4ee5\u63a7\u5236VM\u7684<code>start\u3001stop\u3001restart</code>\u3002"},{"location":"kubeVirt/kubeVirt/quick-learn/#kubevirt_1","title":"kubeVirt\u7ba1\u7406\u865a\u62df\u673a\u673a\u5236","text":"<p>\u5728\u8bb2\u89e3kubeVirt\u7ba1\u7406\u673a\u5236\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u4e86\u89e3\u4e00\u4e0b<code>libvirt</code>\u3002</p>"},{"location":"kubeVirt/kubeVirt/quick-learn/#libvirt","title":"libvirt","text":"<p>\u5728\u4e91\u8ba1\u7b97\u53d1\u5c55\u4e2d\uff0c\u6709\u4e24\u7c7b\u865a\u62df\u5316\u5e73\u53f0\uff1a</p> <ul> <li>openstack\uff08iaas\uff09\uff1a\u5173\u6ce8\u4e8e\u8d44\u6e90\u7684\u5229\u7528\uff0c\u865a\u62df\u673a\u7684\u8ba1\u7b97\uff0c\u7f51\u7edc\u548c\u5b58\u50a8</li> <li>kubernetes\uff08paas\uff09\uff1a\u5173\u6ce8\u5bb9\u5668\u7684\u7f16\u6392\u8c03\u5ea6\uff0c\u81ea\u52a8\u5316\u90e8\u7f72\uff0c\u53d1\u5e03\u7ba1\u7406</li> </ul> <p><code>libvirt</code>\u662f\u4e00\u4e2a\u865a\u62df\u5316\u7ba1\u7406\u5e73\u53f0\u7684\u8f6f\u4ef6\u96c6\u5408\u3002\u5b83\u63d0\u4f9b\u7edf\u4e00\u7684API\uff0c\u5b88\u62a4\u8fdb\u7a0blibvirtd\u548c\u4e00\u4e2a\u9ed8\u8ba4\u547d\u4ee4\u884c\u7ba1\u7406\u5de5\u5177\uff1a<code>virsh</code>\u3002 \u5176\u5b9e\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>kvm-qemu</code>\u547d\u4ee4\u884c\u7684\u7ba1\u7406\u5de5\u5177\uff0c\u4f46\u662f\u5176\u53c2\u6570\u8fc7\u591a\uff0c\u4e0d\u4fbf\u4f7f\u7528\u3002 \u6240\u4ee5\u6211\u4eec\u901a\u5e38\u4f7f\u7528<code>libvirt</code>\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u6765\u5bf9\u865a\u62df\u6362\u8fdb\u884c\u7ba1\u7406\u3002</p> <p><code>libvirt</code>\u662fHypervisor\u7684\u7ba1\u7406\u65b9\u6848\uff0c\u5c31\u662f\u7ba1\u7406Hypervisor\u7684\u3002 </p> <p>\u7591\u95ee</p> <p>\u90a3Hypervisor\u5230\u5e95\u6709\u54ea\u4e9b\u5462\uff1f</p> <p>Hypervisor\uff08VMM\uff09\u865a\u62df\u673a\u76d1\u89c6\u5668\u6709\u4ee5\u4e0b\u5206\u7c7b\uff1a</p>  \u865a\u62df\u673a\u76d1\u89c6\u5668\u7c7b\u522b \u63cf\u8ff0 Type I hypervisor: \u786c\u4ef6\u865a\u62df\u5316 \u8fd9\u4e9bHypervisor\u662f\u76f4\u63a5\u5b89\u88c5\u5e76\u8fd0\u884c\u5728\u5bbf\u4e3b\u673a\u4e0a\u7684\u786c\u4ef6\u4e4b\u4e0a\u7684\uff0cHypervisor\u8fd0\u884c\u5728\u786c\u4ef6\u4e4b\u4e0a\u6765\u63a7\u5236\u548c\u7ba1\u7406\u786c\u4ef6\u8d44\u6e90\u3002 \u6bd4\u5982\uff1a<li> <code>Microsoft Hyper-V</code> <li> <code>VMware ESXI</code> <li> <code>KVM</code> Typer-II hypervisor: hosted hypervisors \u8fd9\u4e9bHypervisor\u76f4\u63a5\u4f5c\u4e3a\u4e00\u79cd\u8ba1\u7b97\u673a\u7a0b\u5e8f\u8fd0\u884c\u5728\u5bbf\u4e3b\u673a\u4e0a\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u4e0a\u7684\u3002 \u6bd4\u5982\uff1a<li> <code>QEMU</code> <li> <code>VirtualBox</code> <li> <code>VMware Player</code> <li> <code>VMware WorkStation</code> \u865a\u62df<code>CPU</code>\uff0c<code>MEM</code>\uff08\u5185\u5b58\uff09\uff0c<code>I/Odevices</code> <li> \u5176\u4e2d<code>Intel VT-x/AMD-X</code>\u5b9e\u73b0\u7684\u662f<code>CPU</code>\u865a\u62df\u5316 <li> <code>Intel EPT/AMD-NPT</code>\u5b9e\u73b0<code>MEM</code>\u7684\u865a\u62df\u5316 <code>Qemu-Kvm</code>\u7684\u7ed3\u5408 <code>KVM</code>\u53ea\u80fd\u8fdb\u884c<code>CPU</code>\uff0c<code>MEM</code>\u7684\u865a\u62df\u5316\uff0c<code>QEMU</code>\u80fd\u8fdb\u884c\u786c\u4ef6\uff0c\u6bd4\u5982\uff1a\u58f0\u5361\uff0cUSE\u63a5\u53e3\uff0c...\u7684\u865a\u62df\u5316\uff0c\u56e0\u6b64\u901a\u5e38\u5c06<code>QEMU</code>\uff0c<code>KVM</code>\u7ed3\u5408\u5171\u540c\u865a\u62df\uff1a<code>QEMU-KVM</code>\u3002 <p>\u6211\u4eec\u901a\u8fc7<code>libvirt</code>\u547d\u4ee4\u884c\u5de5\u5177\uff0c\u6765\u8c03\u52a8Hypervisor\uff0c\u4ece\u800c\u4f7fHypervisor\u7ba1\u7406\u865a\u62df\u673a\u3002</p>"},{"location":"kubeVirt/kubeVirt/quick-learn/#_1","title":"\u865a\u62df\u673a\u955c\u50cf\u5236\u4f5c\u4e0e\u7ba1\u7406","text":"<p>\u865a\u62df\u673a\u955c\u50cf\u91c7\u7528\u5bb9\u5668\u955c\u50cf\u5f62\u5f0f\u5b58\u653e\u5728\u955c\u50cf\u4ed3\u5e93\u4e2d\u3002\u521b\u5efa\u539f\u7406\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u5c06Linux\u53d1\u884c\u7248\u672c\u7684\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5230\u57fa\u7840\u955c\u50cf\u7684<code>/disk</code>\u76ee\u5f55\u5185\uff0c\u955c\u50cf\u683c\u5f0f\u652f\u6301<code>qcow2\u3001raw\u3001img</code>\u3002\u901a\u8fc7Dockerfile\u6587\u4ef6\u5c06\u865a\u62df\u673a\u955c\u50cf\u5236\u4f5c\u6210\u5bb9\u5668\u955c\u50cf\uff0c\u7136\u540e\u5206\u522b\u63a8\u9001\u5230\u4e0d\u540c\u7684registry\u955c\u50cf\u4ed3\u5e93\u4e2d\u3002\u5ba2\u6237\u5728\u521b\u5efa\u865a\u62df\u673a\u65f6\uff0c\u6839\u636e\u914d\u7f6e\u7684\u4f18\u5148\u7ea7\u7b56\u7565\u62c9\u53d6registry\u4e2d\u7684\u865a\u62df\u673a\u5bb9\u5668\u955c\u50cf\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u53f0registry\u6545\u969c\uff0c\u4f1a\u53e6\u4e00\u53f0\u5065\u5eb7\u7684registry\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"kubeVirt/kubeVirt/quick-learn/#_2","title":"\u865a\u62df\u673a\u751f\u547d\u5468\u671f\u7ba1\u7406","text":"<p>kubeVirt\u865a\u62df\u673a\u751f\u547d\u5468\u671f\u7ba1\u7406\u4e3b\u8981\u5206\u4e3a\u4ee5\u4e0b\u51e0\u79cd\u72b6\u6001\uff1a</p> <ul> <li>\u865a\u62df\u673a\u521b\u5efa\uff1a\u521b\u5efaVM\u5bf9\u8c61\uff0c\u5e76\u540c\u6b65\u521b\u5efa<code>DataVolume/PVC</code>\uff0c\u4eceHarbor\u955c\u50cf\u4ed3\u5e93\u4e2d\u62c9\u53d6\u7cfb\u7edf\u6a21\u677f\u955c\u50cf\u62f7\u8d1d\u81f3\u76ee\u6807\u8c03\u5ea6\u4e3b\u673a\uff0c\u901a\u8fc7\u8c03\u5ea6\u3001IP\u5206\u914d\u540e\u751f\u6210VMI\u4ee5\u53ca\u7ba1\u7406VM\u7684Launcher Pod\u4ece\u800c\u542f\u52a8\u4f9b\u4e1a\u52a1\u4f7f\u7528\u7684VM\u3002</li> <li>\u865a\u62df\u673a\u8fd0\u884c\uff1a\u8fd0\u884c\u72b6\u6001\u4e0b\u7684VM \u53ef\u4ee5\u8fdb\u884c\u63a7\u5236\u53f0\u7ba1\u7406\u3001\u5feb\u7167\u5907\u4efd/\u6062\u590d\u3001\u70ed\u8fc1\u79fb\u3001\u78c1\u76d8\u70ed\u6302\u8f7d/\u70ed\u5220\u9664\u7b49\u64cd\u4f5c\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u8fdb\u884c\u91cd\u542f\u3001\u4e0b\u7535\u64cd\u4f5c\uff0c\u63d0\u9ad8VM\u5b89\u5168\u7684\u540c\u65f6\u89e3\u51b3\u4e1a\u52a1\u5b58\u50a8\u7a7a\u95f4\u9700\u6c42\u548c\u4e3b\u673a\u5f02\u5e38Hung\u7b49\u95ee\u9898\u3002</li> <li>\u865a\u62df\u673a\u5173\u673a\uff1a\u5173\u673a\u72b6\u6001\u4e0b\u7684VM\u53ef\u4ee5\u8fdb\u884c\u5feb\u7167\u5907\u4efd/\u6062\u590d\u3001\u51b7\u8fc1\u79fb\u3001<code>CPU/MEM</code>\u89c4\u683c\u53d8\u66f4\u3001\u91cd\u547d\u540d\u4ee5\u53ca\u78c1\u76d8\u6302\u8f7d\u7b49\u64cd\u4f5c\uff0c\u540c\u65f6\u53ef\u901a\u8fc7\u91cd\u65b0\u542f\u52a8\u8fdb\u5165\u8fd0\u884c\u72b6\u6001\uff0c\u4e5f\u53ef\u5220\u9664\u8fdb\u884c\u8d44\u6e90\u56de\u6536\u3002</li> <li>\u865a\u62df\u673a\u5220\u9664\uff1a\u5bf9\u865a\u673a\u8d44\u6e90\u8fdb\u884c\u56de\u6536\uff0c\u4f46VM\u6240\u5c5e\u7684\u78c1\u76d8\u6570\u636e\u4ecd\u5c06\u4fdd\u7559\u3001\u5177\u5907\u6062\u590d\u6761\u4ef6\u3002</li> </ul>"},{"location":"kubeVirt/kubeVirt/quick-learn/#_3","title":"\u865a\u62df\u673a\u521b\u5efa","text":"<p>\u5173\u4e8e\u865a\u62df\u673a\u7684\u521b\u5efa\u6d41\u7a0b\u5982\u4e0b\u56fe\uff1a</p> <p></p> <p>\u521b\u5efa\u6d41\u7a0b\u5177\u4f53\u63cf\u8ff0\uff1a</p> <ol> <li>\u7528\u6237\u7f16\u5199VM\u7c7b\u578b\u7684\u8d44\u6e90\u6e05\u5355</li> <li>\u4f7f\u7528<code>apply</code>\u547d\u4ee4\u521b\u5efaVM\u8d44\u6e90</li> <li>VM\u8d44\u6e90\u521b\u5efa\u5b8c\u6210\u4ee5\u540e\uff0c<code>virt-controller</code>\u4f1a\u68c0\u6d4b\u5230\u6709\u4e2aVM\u7c7b\u578b\u7684\u8d44\u6e90\u521b\u5efa</li> <li>\u68c0\u67e5\u6b64VM\u7684\u72b6\u6001\uff0c\u9ed8\u8ba4\u6709\u4e2a\u5b57\u6bb5<code>Running: false</code>, \u6b64\u65f6\u4e0d\u4f1a\u521b\u5efaVMI\u8d44\u6e90</li> <li>\u4f7f\u7528<code>virtctl</code>\u547d\u4ee4\u548c<code>virt-api</code>\u4ea4\u4e92\uff0c\u4ece\u800c\u542f\u52a8VM</li> <li>VM\u8d44\u6e90\u4e0b\u7684\u72b6\u6001\u5b57\u6bb5\u53d8\u6210<code>Running: true</code></li> <li><code>virt-controller</code>\u53d1\u73b0VM\u6587\u4ef6\u53d1\u751f\u53d8\u5316\uff0c\u5e76\u4e14\u68c0\u67e5\u5230\u5df2\u7ecf\u4e3a<code>true</code>\uff0c\u8868\u793a\u53ef\u4ee5\u521b\u5efaVMI\u4e86</li> <li><code>virt-controller</code>\u68c0\u6d4b\u5230\u6709\u4e2aVMI\u8d44\u6e90\u88ab\u521b\u5efa\uff0c\u5e76\u6839\u636eVMI\u76f8\u5173\u914d\u7f6e\u4fe1\u606f\u4ee5\u53ca\u73b0\u6709\u7684\u8d44\u6e90\uff0c\u4ece\u800c\u521b\u5efa<code>virt-launcher Pod</code></li> <li><code>api-server</code>\u53d1\u73b0\u6709\u4e2a<code>virt-launcher Pod</code>\u5373\u5c06\u88ab\u521b\u5efa\uff0c\u5148\u8fdb\u884c\u8c03\u5ea6</li> <li><code>kubelet</code>\u521b\u5efa\u6b64pod</li> <li>\u5f53<code>virt-launcher Pod</code>\u88ab\u62c9\u8d77\u4ee5\u540e\uff0c<code>virt-handler</code>\u76d1\u6d4b\u5230\u8fd9\u4e2apod</li> <li><code>virt-handler</code>\u5f00\u59cb\u521b\u5efa\u76f8\u5173\u7684\u7f51\u7edc\u8bbe\u5907\u5e76\u4e14\u68c0\u67e5VMI\u8d44\u6e90\u72b6\u6001\uff0c\u7136\u540e\u5c06VMI\u8d44\u6e90\u53d1\u9001\u7ed9<code>virt-launcher</code></li> <li><code>virt-launcher</code>\u63a5\u6536\u5230VMI\u8d44\u6e90\u4ee5\u540e\uff0c\u5c06VMI\u8d44\u6e90\u8f6c\u6362\u4e3adomain xml\u6587\u4ef6</li> <li>xml\u6587\u4ef6\u88ab<code>libvirtd</code>\u8bc6\u522b</li> <li><code>libvirtd</code>\u5c06xml\u6587\u4ef6\u8f6c\u6362\u4e3a<code>KVM</code>\u7684\u542f\u52a8\u53c2\u6570\u5e76\u542f\u52a8VM</li> </ol>"},{"location":"kubeVirt/kubeVirt/quick-learn/#_4","title":"\u8d44\u6e90\u6e05\u5355","text":"<p>\u5173\u4e8e\u8d44\u6e90\u6e05\u5355\uff0ckubeVirt \u4e3b\u8981\u5b9e\u73b0\u4e86\u4e0b\u9762\u51e0\u79cd\u8d44\u6e90\uff0c\u4ee5\u5b9e\u73b0\u5bf9\u865a\u62df\u673a\u7684\u7ba1\u7406\uff1a</p> \u8d44\u6e90\u5bf9\u8c61 \u63cf\u8ff0 <code>VirtualMachineInstance\uff08VMI\uff09</code> \u7c7b\u4f3c\u4e8e kubernetes Pod\uff0c\u662f\u7ba1\u7406\u865a\u62df\u673a\u7684\u6700\u5c0f\u8d44\u6e90\u3002\u4e00\u4e2a <code>VirtualMachineInstance</code> \u5bf9\u8c61\u5373\u8868\u793a\u4e00\u53f0\u6b63\u5728\u8fd0\u884c\u7684\u865a\u62df\u673a\u5b9e\u4f8b\uff0c\u5305\u542b\u4e00\u4e2a\u865a\u62df\u673a\u6240\u9700\u8981\u7684\u5404\u79cd\u914d\u7f6e\u3002 <code>VirtualMachine\uff08VM\uff09</code> \u4e3a\u96c6\u7fa4\u5185\u7684 <code>VirtualMachineInstance</code> \u63d0\u4f9b\u7ba1\u7406\u529f\u80fd\uff0c\u4f8b\u5982\u5f00\u673a/\u5173\u673a/\u91cd\u542f\u865a\u62df\u673a\uff0c\u786e\u4fdd\u865a\u62df\u673a\u5b9e\u4f8b\u7684\u542f\u52a8\u72b6\u6001\uff0c\u4e0e\u865a\u62df\u673a\u5b9e\u4f8b\u662f <code>1:1</code> \u7684\u5173\u7cfb\uff0c\u7c7b\u4f3c\u4e0e <code>spec.replica</code> \u4e3a 1 \u7684 <code>StatefulSet</code>\u3002 <code>VirtualMachineInstanceReplicaSet</code> \u7c7b\u4f3c <code>ReplicaSet</code>\uff0c\u53ef\u4ee5\u542f\u52a8\u6307\u5b9a\u6570\u91cf\u7684 <code>VirtualMachineInstance</code>\uff0c\u5e76\u4e14\u4fdd\u8bc1\u6307\u5b9a\u6570\u91cf\u7684 <code>VirtualMachineInstance</code> \u8fd0\u884c\uff0c\u53ef\u4ee5\u914d\u7f6e <code>HPA</code>\u3002"},{"location":"kubeVirt/operators/ssp-operator/","title":"SSP","text":"<p>SSP Operator\u5b9a\u4e49</p> <p>SSP Operator \u662f\u4e00\u4e2a\u57fa\u4e8e Golang \u7f16\u5199\u7684 Operator\uff0c\u8d1f\u8d23\u90e8\u7f72 kubevirt-tekton-tasks \u548c\u793a\u4f8bCI\u3002</p> <p>SSP \u4f5c\u4e3a<code>hyperconverged-cluster-operator</code>\u7684\u4e00\u90e8\u5206\uff0c\u4e5f\u53ef\u4ee5\u7531\u7528\u6237\u4ece\u6700\u65b0\u7248\u672c\u72ec\u7acb\u90e8\u7f72\u3002</p> <p>\u5907\u6ce8</p> <p>SSP \u9700\u8981 Tekton \u624d\u80fd\u5de5\u4f5c\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cSSP \u4e0d\u90e8\u7f72 KubeVirt Tekton \u4efb\u52a1\u8d44\u6e90\u3002 \u7528\u6237\u5fc5\u987b\u5728 HCO CR \u4e2d\u542f\u7528 <code>deployTektonTaskResources</code> \u7279\u6027\u95e8\u63a7\u624d\u80fd\u90e8\u7f72\u5176\u6240\u6709\u8d44\u6e90\uff1a</p> <pre><code>apiVersion: hco.kubevirt.io/v1beta1\nkind: HyperConverged\nmetadata:\nname: kubevirt-hyperconverged\nnamespace: kubevirt-hyperconverged\nspec:\nfeatureGates:\ndeployTektonTaskResources: true\n</code></pre> <p>\u6216\u8005\u662f\u5728SSP CR\uff0c</p> <pre><code>apiVersion: ssp.kubevirt.io/v1beta2\nkind: SSP\nmetadata:\nname: ssp\nnamespace: kubevirt\nspec:\nfeatureGates:\ndeployTektonTaskResources: true\n</code></pre> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u5728HCO CR\u4e2d\u542f\u7528 <code>deployTektonTaskResources</code> \u7279\u6027\u95e8\u63a7\uff1a</p> KubernetesOKD <pre><code>kubectl patch hco kubevirt-hyperconverged  --type=merge -p '{\"spec\":{\"featureGates\": {\"deployTektonTaskResources\": true}}}'\n</code></pre> <pre><code>oc patch hco kubevirt-hyperconverged  --type=merge -p '{\"spec\":{\"featureGates\": {\"deployTektonTaskResources\": true}}}'\n</code></pre> <p>\u6216\u8005\u901a\u8fc7patch\u7ed9SSP CR\u6253\u8865\u4e01\uff0c</p> KubernetesOKD <pre><code>kubectl patch ssp ssp  --type=merge -p '{\"spec\":{\"featureGates\": {\"deployTektonTaskResources\": true}}}'\n</code></pre> <pre><code>oc patch ssp ssp  --type=merge -p '{\"spec\":{\"featureGates\": {\"deployTektonTaskResources\": true}}}'\n</code></pre> <p>\u4e00\u65e6\u7279\u6027\u95e8\u63a7<code>spec.featureGates.deployTektonTaskResources</code>\u88ab\u7f6e\u4e3a<code>true</code>\u65f6\uff0cSSP\u5c06\u4e0d\u4f1a\u5220\u9664\u4efb\u4f55\u4efb\u52a1\u548c\u793a\u4f8bCI\uff0c\u5c31\u7b97\u662f\u7279\u6027\u95e8\u63a7\u56de\u7f6e\u6210<code>false</code>\u3002</p> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5728HCO CR\u4e2d\u914d\u7f6e\u4e24\u4e2a\u5b57\u6bb5 <code>spec.tektonPipelinesNamespace</code> \u6216 <code>spec.tektonTasksNamespace</code>\u5c06\u793a\u4f8bCI\u6216\u8005\u4efb\u52a1\u90e8\u7f72\u5230\u54ea\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\uff0c</p> <pre><code>apiVersion: hco.kubevirt.io/v1beta1\nkind: HyperConverged\nmetadata:\nname: kubevirt-hyperconverged\nnamespace: kubevirt-hyperconverged\nspec:\ntektonPipelinesNamespace: userNamespace\ntektonTasksNamespace: userNamespace\n</code></pre> <p>\u6216\u8005\u5728SSP CR\u4e2d\u914d\u7f6e\u4e24\u4e2a\u5b57\u6bb5 <code>spec.tektonPipelines.namespace</code> \u6216 <code>spec.tektonTasks.namespace</code>:</p> <pre><code>apiVersion: ssp.kubevirt.io/v1beta2\nkind: SSP\nmetadata:\nname: ssp\nnamespace: kubevirt\nspec:\ntektonPipelines:\nnamespace: kubevirt\ntektonTasks:\nnamespace: kubevirt\n</code></pre>"},{"location":"kubeVirt/resource/migrationPolicy/","title":"MigrationPolicy","text":"<p>migrationPolicy\u5b9a\u4e49</p> <p><code>migrationPolicy</code>\u63d0\u4f9b\u4e86\u4e00\u79cd\u5c06\u8fc1\u79fb\u914d\u7f6e\u5e94\u7528\u5230\u865a\u62df\u673a\u7684\u65b0\u65b9\u6cd5\u3002 \u8fd9\u4e9b\u7b56\u7565\u53ef\u4ee5\u7ec6\u5316 KubeVirt CR \u7684 <code>MigrationConfiguration</code>\uff0c\u7528\u4e8e\u8bbe\u7f6e\u96c6\u7fa4\u8303\u56f4\u7684\u8fc1\u79fb\u914d\u7f6e\u3002 \u8fd9\u6837\uff0c\u96c6\u7fa4\u8303\u56f4\u7684\u8bbe\u7f6e\u5c31\u53ef\u4ee5\u4f5c\u4e3a\u9ed8\u8ba4\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7<code>migrationPolicy</code>\u8fdb\u884c\u7ec6\u5316\uff08\u5373\u66f4\u6539\u3001\u5220\u9664\u6216\u6dfb\u52a0\uff09\u3002</p>"},{"location":"kubeVirt/resource/migrationPolicy/#_1","title":"\u6982\u8ff0","text":"<p>kubeVirt \u652f\u6301\u865a\u62df\u673a\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5b9e\u65f6\u8fc1\u79fb\u3002 \u5728\u5f15\u5165<code>migrationPolicy</code>\u4e4b\u524d\uff0c\u53ea\u80fd\u901a\u8fc7\u7f16\u8f91 kubeVirt CR \u7684\u89c4\u8303\u6216\u66f4\u5177\u4f53\u5730\u8bf4 <code>MigrationConfiguration</code> CRD \u5728\u96c6\u7fa4\u8303\u56f4\u5185\u914d\u7f6e\u8fc1\u79fb\u8bbe\u7f6e\u3002</p> <p>\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7684\u8fc1\u79fb\u884c\u4e3a\u7684\u51e0\u4e2a\u65b9\u9762\uff08\u5c3d\u7ba1\u4e0d\u662f\u5168\u90e8\uff09\u5305\u62ec\uff1a </p> <ul> <li>\u5e26\u5bbd </li> <li>\u81ea\u52a8\u6536\u655b </li> <li>\u540e/\u9884\u590d\u5236 </li> <li>\u5e76\u884c\u8fc1\u79fb\u7684\u6700\u5927\u6570\u91cf </li> <li>\u8d85\u65f6</li> </ul> <p><code>migrationPolicy</code>\u6982\u62ec\u4e86\u5b9a\u4e49\u8fc1\u79fb\u914d\u7f6e\u7684\u6982\u5ff5\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u4e0d\u540c\u7684\u914d\u7f6e\u5e94\u7528\u4e8e\u7279\u5b9a\u7684\u865a\u62df\u673a\u7ec4\u3002</p> <p>\u8fd9\u79cd\u529f\u80fd\u5bf9\u4e8e\u8bb8\u591a\u9700\u8981\u533a\u5206\u4e0d\u540c\u5de5\u4f5c\u8d1f\u8f7d\u7684\u4e0d\u540c\u7528\u4f8b\u975e\u5e38\u6709\u7528\u3002 \u53ef\u80fd\u9700\u8981\u533a\u5206\u4e0d\u540c\u7684\u914d\u7f6e\uff0c\u56e0\u4e3a\u4e0d\u540c\u7684\u5de5\u4f5c\u8d1f\u8f7d\u88ab\u8ba4\u4e3a\u5177\u6709\u4e0d\u540c\u7684\u4f18\u5148\u7ea7\u3001\u5b89\u5168\u9694\u79bb\u3001\u5177\u6709\u4e0d\u540c\u8981\u6c42\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3001\u6709\u52a9\u4e8e\u805a\u5408\u4e0d\u9002\u5408\u8fc1\u79fb\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ee5\u53ca\u8bb8\u591a\u5176\u4ed6\u539f\u56e0\u3002</p>"},{"location":"kubeVirt/resource/migrationPolicy/#migrationpolicy_1","title":"MigrationPolicy\u4f7f\u7528","text":"<p>\u76ee\u524d\uff0c<code>migrationPolicy</code> \u89c4\u8303\u4ec5\u5305\u542b KubeVirt CR \u7684 <code>MigrationConfiguration</code> \u4e2d\u7684\u4ee5\u4e0b\u914d\u7f6e\uff08\u5c06\u6765\u4f1a\u6dfb\u52a0\u66f4\u591a\u4e0d\u5c5e\u4e8e KubeVirt CR \u7684\u914d\u7f6e\uff09\uff1a</p> <pre><code>apiVersion: migrations.kubevirt.io/v1alpha1\nkind: MigrationPolicy\nspec:\nallowAutoConverge: true\nbandwidthPerMigration: 217Ki\ncompletionTimeoutPerGiB: 23\nallowPostCopy: false\n</code></pre> <p>\u4ee5\u4e0a\u6240\u6709\u5b57\u6bb5\u90fd\u662f\u53ef\u9009\u7684\u3002 \u7701\u7565\u65f6\uff0c\u914d\u7f6e\u5c06\u6309\u7167 KubeVirt CR \u7684 <code>MigrationConfiguration</code> \u4e2d\u7684\u5b9a\u4e49\u5e94\u7528\u3002 \u8fd9\u6837\uff0cKubeVirt CR \u5c06\u5145\u5f53\u672a\u7ed1\u5b9a\u5230\u4efb\u4f55 <code>MigrationPolicy</code> \u7684 VM \u548c\u7ed1\u5b9a\u5230\u672a\u5b9a\u4e49\u914d\u7f6e\u7684\u6240\u6709\u5b57\u6bb5\u7684 <code>MigrationPolicy</code> \u7684 VM \u7684\u4e00\u7ec4\u53ef\u914d\u7f6e\u9ed8\u8ba4\u503c\u3002</p>"},{"location":"kubeVirt/resource/virtualMachine/","title":"VirtualMachine","text":""},{"location":"kubeVirt/resource/virtualMachine/#crd","title":"\u865a\u62df\u673aCRD","text":"<p>\u9996\u5148\u6765\u770b\u770bVM\u8fd9\u4e2aCRD\u7684\u5b9a\u4e49\uff1a</p> <pre><code>type VirtualMachine struct {\nmetav1.TypeMeta   `json:\",inline\"`\nmetav1.ObjectMeta `json:\"metadata,omitempty\"`\n// Spec contains the specification of VirtualMachineInstance created\nSpec VirtualMachineSpec `json:\"spec\" valid:\"required\"`\n// Status holds the current state of the controller and brief information\n// about its associated VirtualMachineInstance\nStatus VirtualMachineStatus `json:\"status,omitempty\"`\n}\ntype VirtualMachineSpec struct {\n// Running controls whether the associatied VirtualMachineInstance is created or not\n// Mutually exclusive with RunStrategy\nRunning *bool `json:\"running,omitempty\" optional:\"true\"`\n// Running state indicates the requested running state of the VirtualMachineInstance\n// mutually exclusive with Running\nRunStrategy *VirtualMachineRunStrategy `json:\"runStrategy,omitempty\" optional:\"true\"`\n// FlavorMatcher references a flavor that is used to fill fields in Template\nFlavor *FlavorMatcher `json:\"flavor,omitempty\" optional:\"true\"`\n// Template is the direct specification of VirtualMachineInstance\nTemplate *VirtualMachineInstanceTemplateSpec `json:\"template\"`\n// dataVolumeTemplates is a list of dataVolumes that the VirtualMachineInstance template can reference.\n// DataVolumes in this list are dynamically created for the VirtualMachine and are tied to the VirtualMachine's life-cycle.\nDataVolumeTemplates []DataVolumeTemplateSpec `json:\"dataVolumeTemplates,omitempty\"`\n}\n</code></pre> <p>\u5728<code>VirtualMachineSpec</code>\u4e2d\uff0c\u6709\u4ee5\u4e0b\u7684\u53c2\u6570\uff1a</p> <code>VirtualMachineSpec</code>\u53c2\u6570 \u63cf\u8ff0 <code>Running</code> \u4e0e<code>RunStrategy</code>\u5b57\u6bb5\u4e92\u65a5\uff08\u5373\u53ea\u80fd\u4e8c\u9009\u4e00\uff09\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u4e3a<code>true</code>\uff0c\u521b\u5efa\u4e86VM\u5bf9\u8c61\u540e\u4f1a\u6839\u636e<code>Template</code>\u4e2d\u7684\u5185\u5bb9\u521b\u5efaVMI\uff0c<code>false</code>\u5219\u4e0d\u4f1a\u3002 <code>RunStrategy</code> \u4e0e<code>Running</code>\u5b57\u6bb5\u4e92\u65a5\uff08\u5373\u53ea\u80fd\u4e8c\u9009\u4e00\uff09\uff0c\u865a\u62df\u673a\u7684\u8fd0\u884c\u7b56\u7565\uff0c\u53ef\u9009\u503c\u4e3a\uff1a<li><code>Always</code>-\u8868\u793aVMI\u5bf9\u8c61\u5e94\u8be5\u4e00\u76f4\u662f<code>running</code>\u72b6\u6001\uff1b<li> <code>Halted</code>-\u8868\u793aVMI\u5bf9\u8c61\u6c38\u8fdc\u90fd\u4e0d\u5e94\u8be5\u662f<code>running</code>\u72b6\u6001\uff1b<li> <code>Manual</code>-VMI\u53ef\u4ee5\u901a\u8fc7API\u63a5\u53e3\u542f\u52a8\u6216\u8005\u505c\u6b62\uff1b<li> <code>RerunOnFailure</code>-VMI\u521d\u59cb\u5e94\u4e3a<code>running</code>\uff0c\u5f53\u6709\u9519\u8bef\u53d1\u751f\u65f6\u4f1a\u81ea\u52a8\u91cd\u542f\uff1b<li> <code>Once</code>-VMI\u53ea\u4f1a\u8fd0\u884c\u4e00\u6b21\uff0c\u5f53\u51fa\u73b0\u9519\u8bef\u7b49\u60c5\u51b5\u65f6\u4e0d\u4f1a\u91cd\u542f\u3002 <code>Flavor</code> \u865a\u62df\u673a\u5e95\u5c42\u7279\u6027\u914d\u7f6e\uff0c\u4ece\u4ee3\u7801\u4e0a\u770b\u76ee\u524d\u53ea\u6709CPU\u7684\u914d\u7f6e\uff0c\u76f8\u5173\u914d\u7f6e\u9879\u5305\u62ec\u662f\u5426\u7ed1\u5b9aCPU\uff08\u7ed1\u5b9a\u7684CPU\u53ea\u80fd\u7ed9\u8be5\u865a\u62df\u673a\u4f7f\u7528\uff09\u3001\u865a\u62df\u673a\u4e2d\u7684\u7ebf\u7a0b\u6570\u3001NUMA\u914d\u7f6e\u7b49\u3002<code>flavor</code>\u6709<code>VirtualMachineFlavor</code>\u548c<code>VirtualMachineClusterFlavor</code>\u4e24\u79cd\u7c7b\u578b\u6570\u636e\u3002\u8be5\u5b57\u6bb5\u4f1a\u88ab\u586b\u5145\u5230VMI\u6a21\u677f\u5bf9\u5e94\u5b57\u6bb5\u4e2d\u3002 <code>Template</code> VMI\u7684\u6a21\u677f\uff0c\u7c7b\u4f3cdeployment\u4e2d\u914d\u7f6e\u7684pod\u6a21\u677f\u3002 <code>DataVolumeTemplates</code> \u6570\u636e\u5377\u6a21\u677f\uff0c\u8fd9\u91cc\u914d\u7f6e\u7684\u6570\u636e\u5377\u4f1a\u81ea\u52a8\u521b\u5efa\uff0c\u5e76\u4e14\u53ef\u4ee5\u88ab<code>Template</code>\u5b57\u6bb5\u7684\u6a21\u677f\u4e2d\u4f7f\u7528\u3002\u8fd9\u4e9b\u6570\u636e\u5377\u7684\u751f\u547d\u5468\u671f\u548cVM\u5bf9\u8c61\u7684\u751f\u547d\u5468\u671f\u4e00\u81f4\u3002"},{"location":"kubeVirt/resource/virtualMachineClone/","title":"vmClone\u8d44\u6e90","text":""},{"location":"kubeVirt/resource/virtualMachineClone/#_1","title":"\u5148\u51b3\u6761\u4ef6","text":""},{"location":"kubeVirt/resource/virtualMachineClone/#snapshot-restore","title":"snapshot \u548c restore","text":"<p>\u4ece\u5e95\u5c42\u65b9\u9762\u770b\uff0c<code>clone</code> API \u4f9d\u8d56\u4e8e<code>snapshot</code>\u548c<code>restore</code> API\u3002 \u56e0\u6b64\uff0c\u4e3a\u4e86\u80fd\u591f\u4f7f\u7528<code>clone</code> API\uff0c\u8bf7\u53c2\u9605snapshot\u548crestore\u5148\u51b3\u6761\u4ef6\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineClone/#_2","title":"\u5feb\u7167\u7279\u6027\u95e8\u63a7","text":"<p>\u76ee\u524d\uff0c<code>clone</code> API \u7531<code>snapshot</code>\u7279\u6027\u95e8\u63a7\u4fdd\u62a4\u3002 KubeVirt CR \u4e2d\u7684<code>feature gates</code>\u5b57\u6bb5\u5fc5\u987b\u901a\u8fc7\u6dfb\u52a0\u5feb\u7167\u6765\u6269\u5c55\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineClone/#clone","title":"Clone \u5bf9\u8c61","text":"<p>\u9996\u5148\uff0c\u5982\u4e0a\u6240\u8ff0\uff0c<code>clone</code> API \u4f9d\u8d56\u4e8e\u5e95\u5c42\u7684<code>snapshot</code>\u548c<code>restore</code> API\u3002 \u56e0\u6b64\uff0c\u67e5\u770b<code>snapshot</code>\u548c<code>restore</code>\u7528\u6237\u6307\u5357\u9875\u9762\u4ee5\u83b7\u53d6\u66f4\u591a\u4fe1\u606f\u53ef\u80fd\u4f1a\u6709\u6240\u5e2e\u52a9\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineClone/#vmclone","title":"vmClone \u5bf9\u8c61\u6982\u8ff0","text":"<p>\u4e3a\u4e86\u542f\u52a8\u514b\u9686\uff0c\u9700\u8981\u5728\u96c6\u7fa4\u4e0a\u521b\u5efa <code>VirtualMachineClone</code> \u5bf9\u8c61 (CRD)\u3002 \u8fd9\u79cd\u5bf9\u8c61\u7684\u4e00\u4e2a\u4f8b\u5b50\u662f\uff1a</p> <p>vmClone\u4f8b\u5b50</p> <pre><code>apiVersion: \"clone.kubevirt.io/v1alpha1\"\nkind: VirtualMachineClone\nmetadata:\nname: testclone\nspec:\n# source &amp; target definitions\nsource:\napiGroup: kubevirt.io\nkind: VirtualMachine\nname: vm-cirros\ntarget:\napiGroup: kubevirt.io\nkind: VirtualMachine\nname: vm-clone-target\n# labels &amp; annotations definitions\nlabelFilters:\n- \"*\"\n- \"!someKey/*\"\nannotationFilters:\n- \"anotherKey/*\"\n# other identity stripping specs:\nnewMacAddresses:\ninterfaceName: \"00-11-22\"\nnewSMBiosSerial: \"new-serial\"\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineClone/#source-target","title":"source \u548c target","text":"<p><code>source</code>\u548c<code>target</code>\u8868\u793a<code>source</code>/<code>target</code> API \u7ec4\u3001\u79cd\u7c7b\u548c\u540d\u79f0\u3002 \u4e00\u4e9b\u91cd\u8981\u7684\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li> <p>\u76ee\u524d\uff0c\u552f\u4e00\u652f\u6301\u7684\u7c7b\u578b\u662f <code>VirtualMachine</code>\uff08\u5c5e\u4e8e <code>kubevirt.io</code> api \u7ec4\uff09\u548c <code>VirtualMachineSnapshot</code>\uff08\u5c5e\u4e8e <code>snapshot.kubevirt.io</code> api \u7ec4\uff09\uff0c\u4f46\u9884\u8ba1\u5c06\u6765\u4f1a\u652f\u6301\u66f4\u591a\u7c7b\u578b\u3002 \u6709\u5173\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u4e0b\u9762\u7684\u201c\u672a\u6765\u8def\u7ebf\u56fe\u201d\u3002</p> </li> <li> <p><code>target</code>\u540d\u79f0\u662f\u53ef\u9009\u7684\u3002 \u5982\u679c\u672a\u6307\u5b9a\uff0c\u514b\u9686\u63a7\u5236\u5668\u5c06\u81ea\u52a8\u4e3a<code>target</code>\u751f\u6210\u540d\u79f0\u3002</p> </li> <li> <p><code>target</code>\u548c<code>source</code>\u5fc5\u987b\u4f4d\u4e8e\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u3002</p> </li> </ul>"},{"location":"kubeVirt/resource/virtualMachineClone/#label-annotation-filters","title":"label \u548c annotation filters","text":"<p>\u8fd9\u4e9b\u89c4\u8303\u5b57\u6bb5\u65e8\u5728\u786e\u5b9a\u54ea\u4e9b<code>label/annotations</code>\u88ab\u590d\u5236\u5230\u76ee\u6807\u6216\u88ab\u5265\u79bb\u3002</p> <p>\u8fc7\u6ee4\u5668\u662f\u5b57\u7b26\u4e32\u5217\u8868\u3002 \u6bcf\u4e2a\u5b57\u7b26\u4e32\u4ee3\u8868\u6e90\u4e2d\u53ef\u80fd\u5b58\u5728\u7684\u4e00\u4e2a\u952e\u3002 \u4e0e\u8fd9\u4e9b\u503c\u4e4b\u4e00\u5339\u914d\u7684\u6bcf\u4e2a\u6e90\u5bc6\u94a5\u90fd\u5c06\u88ab\u590d\u5236\u5230\u514b\u9686\u7684\u76ee\u6807\u3002 \u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u4f7f\u7528\u7279\u6b8a\u7684\u7c7b\u4f3c\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u5b57\u7b26\uff1a</p> <ul> <li>\u901a\u914d\u7b26 <code>(*)</code> \u53ef\u7528\u4e8e\u5339\u914d\u4efb\u4f55\u5185\u5bb9\u3002 \u901a\u914d\u7b26\u53ea\u80fd\u7528\u5728\u8fc7\u6ee4\u5668\u7684\u672b\u5c3e\u3002</li> <li>\u8fd9\u4e9b\u8fc7\u6ee4\u5668\u6709\u6548\uff1a<ul> <li><code>\"*\"</code></li> <li><code>\"some/key*\"</code></li> </ul> </li> <li>\u8fd9\u4e9b\u8fc7\u6ee4\u5668\u65e0\u6548\uff1a<ul> <li><code>\"some/*/key\"</code></li> <li><code>\"*/key\"</code></li> </ul> </li> <li>\u5426\u5b9a\u5b57\u7b26 <code>(!)</code> \u53ef\u7528\u4e8e\u907f\u514d\u5339\u914d\u67d0\u4e9b\u952e\u3002 \u5426\u5b9a\u53ea\u80fd\u7528\u5728\u8fc7\u6ee4\u5668\u7684\u5f00\u5934\u3002 \u8bf7\u6ce8\u610f\uff0c\u5426\u5b9a\u548c\u901a\u914d\u7b26\u53ef\u4ee5\u4e00\u8d77\u4f7f\u7528\u3002</li> <li>\u8fd9\u4e9b\u8fc7\u6ee4\u5668\u6709\u6548\uff1a<ul> <li><code>\"!some/key\"</code></li> <li><code>\"!some/*\"</code></li> </ul> </li> <li>\u8fd9\u4e9b\u8fc7\u6ee4\u5668\u65e0\u6548\uff1a<ul> <li><code>\"key!\"</code></li> <li><code>\"some/!key\"</code></li> </ul> </li> </ul> <p>\u8bbe\u7f6e<code>label/annotation</code>\u8fc7\u6ee4\u5668\u662f\u53ef\u9009\u7684\u3002 \u5982\u679c\u672a\u8bbe\u7f6e\uff0c\u5219\u9ed8\u8ba4\u590d\u5236\u6240\u6709<code>label/annotations</code>\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineClone/#newmacaddresses","title":"newMacAddresses","text":"<p>\u8be5\u5b57\u6bb5\u7528\u4e8e\u663e\u5f0f\u66ff\u6362\u67d0\u4e9b\u63a5\u53e3\u7684 MAC \u5730\u5740\u3002 \u8be5\u5b57\u6bb5\u662f\u5b57\u7b26\u4e32\u5230\u5b57\u7b26\u4e32\u7684\u6620\u5c04\uff1b \u952e\u4ee3\u8868\u63a5\u53e3\u540d\u79f0\uff0c\u503c\u4ee3\u8868\u514b\u9686\u76ee\u6807\u7684\u65b0 MAC \u5730\u5740\u3002</p> <p>\u8be5\u5b57\u6bb5\u662f\u53ef\u9009\u7684\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6240\u6709 MAC \u5730\u5740\u90fd\u4f1a\u88ab\u5220\u9664\u3002 \u8fd9\u9002\u5408\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72 <code>kube-mac-pool</code> \u65f6\u7684\u60c5\u51b5\uff0c\u8be5\u96c6\u7fa4\u4f1a\u81ea\u52a8\u4e3a\u76ee\u6807\u5206\u914d\u65b0\u7684\u6709\u6548 MAC \u5730\u5740\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineClone/#newsmbiosserial","title":"newSMBiosSerial","text":"<p>\u8be5\u5b57\u6bb5\u7528\u4e8e\u663e\u5f0f\u8bbe\u7f6e\u76ee\u6807\u7684 SMBios \u4e32\u884c\u3002</p> <p>\u8be5\u5b57\u6bb5\u662f\u53ef\u9009\u7684\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u76ee\u6807\u5c06\u5177\u6709\u57fa\u4e8e\u865a\u62df\u673a\u540d\u79f0\u81ea\u52a8\u751f\u6210\u7684\u5e8f\u5217\u53f7\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineClone/#vmclone_1","title":"\u521b\u5efa vmClone \u5bf9\u8c61","text":"<p><code>clone</code>\u6e05\u5355\u51c6\u5907\u597d\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u5b83\uff1a</p> <pre><code>kubectl create -f clone.yaml\n</code></pre> <p>\u8981\u7b49\u5f85<code>clone</code>\u5b8c\u6210\uff0c\u8bf7\u6267\u884c\uff1a <pre><code>kubectl wait vmclone testclone --for condition=Ready\n</code></pre></p> <p>\u60a8\u53ef\u4ee5\u5728<code>clone</code>\u72b6\u6001\u4e2d\u68c0\u67e5<code>clone</code>\u7684\u9636\u6bb5\u3002 \u5b83\u53ef\u4ee5\u662f\u4ee5\u4e0b\u4e4b\u4e00\uff1a</p> <ul> <li><code>Progressing</code></li> <li><code>Succeeded</code></li> </ul> <p><code>clone</code>\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u68c0\u67e5<code>target</code>\uff1a</p> <pre><code>kubectl get vm vm-clone-target -o yaml\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineExport/","title":"VirtualMachineExport","text":"<p>\u60a8\u53ef\u80fd\u9700\u8981\u5c06\u865a\u62df\u673a\u53ca\u5176\u76f8\u5173\u78c1\u76d8\u4ece\u96c6\u7fa4\u4e2d\u5bfc\u51fa\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u5c06\u8be5\u865a\u62df\u673a\u5bfc\u5165\u5230\u53e6\u4e00\u4e2a\u7cfb\u7edf\u6216\u96c6\u7fa4\u4e2d\u3002 \u865a\u62df\u673a\u78c1\u76d8\u662f\u60a8\u60f3\u8981\u5bfc\u51fa\u7684\u6700\u91cd\u8981\u7684\u5185\u5bb9\u3002 \u5bfc\u51fa API \u53ef\u4ee5\u4ee5\u58f0\u660e\u65b9\u5f0f\u5bfc\u51fa\u865a\u62df\u673a\u78c1\u76d8\u3002 \u8fd8\u53ef\u4ee5\u5bfc\u51fa\u5355\u4e2a PVC \u53ca\u5176\u5185\u5bb9\uff0c\u4f8b\u5982\u5f53\u60a8\u4ece\u865a\u62df\u673a\u521b\u5efa\u5185\u5b58\u8f6c\u50a8\u6216\u4f7f\u7528 <code>virtio-fs</code> \u8ba9\u865a\u62df\u673a\u586b\u5145 PVC \u65f6\u3002</p> <p>\u4e3a\u4e86\u4e0d\u4f7f kubernetes API \u670d\u52a1\u5668\u8fc7\u8f7d\uff0c\u6570\u636e\u901a\u8fc7\u4e13\u7528\u7684\u5bfc\u51fa\u4ee3\u7406\u670d\u52a1\u5668\u4f20\u8f93\u3002 \u7136\u540e\uff0c\u4ee3\u7406\u670d\u52a1\u5668\u53ef\u4ee5\u901a\u8fc7\u4e0e <code>Ingress/Route</code> \u6216 <code>NodePort</code> \u5173\u8054\u7684\u670d\u52a1\u5411\u5916\u754c\u53d1\u5e03\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineExport/#export","title":"Export \u7279\u6027\u95e8\u63a7","text":"<p>\u5fc5\u987b\u5728\u7279\u6027\u95e8\u63a7\u4e2d\u542f\u7528 <code>VMExport</code> \u652f\u6301\u624d\u80fd\u53ef\u7528\u3002 KubeVirt CR \u4e2d\u7684<code>feature gates</code>\u5b57\u6bb5\u5fc5\u987b\u901a\u8fc7\u6dfb\u52a0 <code>VMExport</code> \u6765\u6269\u5c55\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineExport/#export-token","title":"Export token","text":"<p>\u4e3a\u4e86\u5b89\u5168\u5730\u5bfc\u51fa\u865a\u62df\u673a\u78c1\u76d8\uff0c\u60a8\u5fc5\u987b\u521b\u5efa\u4e00\u4e2a\u7528\u4e8e\u6388\u6743\u7528\u6237\u8bbf\u95ee\u5bfc\u51fa\u7aef\u70b9\u7684<code>token</code>\u3002 \u6b64\u4ee4\u724c\u5fc5\u987b\u4e0e\u865a\u62df\u673a\u4f4d\u4e8e\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u3002 \u5bc6\u94a5\u7684\u5185\u5bb9\u53ef\u4ee5\u4f5c\u4e3a<code>token</code>\u6807\u5934\u6216\u53c2\u6570\u4f20\u9012\u5230\u5bfc\u51fa URL\u3002 \u6807\u5934\u6216\u53c2\u6570\u7684\u540d\u79f0\u662f <code>x-kubevirt-export-token</code>\uff0c\u5176\u503c\u4e0e\u5bc6\u94a5\u7684\u5185\u5bb9\u5339\u914d\u3002 \u8be5\u79d8\u5bc6\u53ef\u4ee5\u547d\u540d\u4e3a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4efb\u4f55\u6709\u6548\u79d8\u5bc6\u3002 \u6211\u4eec\u5efa\u8bae\u60a8\u751f\u6210\u81f3\u5c11 12 \u4e2a\u5b57\u7b26\u7684\u5b57\u6bcd\u6570\u5b57\u6807\u8bb0\u3002 \u6570\u636e\u5bc6\u94a5\u5e94\u8be5\u662f<code>token</code>\u3002 \u4f8b\u5982\uff1a</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\nname: example-token\nstringData:\ntoken: 1234567890ab\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineExport/#_1","title":"\u5bfc\u51fa\u865a\u62df\u673a\u5377","text":"<p>\u521b\u5efa<code>token</code>\u540e\uff0c\u60a8\u73b0\u5728\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a VMExport CR \u6765\u6807\u8bc6\u8981\u5bfc\u51fa\u7684\u865a\u62df\u673a\u3002 \u60a8\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 <code>VMExport</code>\uff1a</p> <pre><code>apiVersion: export.kubevirt.io/v1alpha1\nkind: VirtualMachineExport\nmetadata:\nname: example-export\nspec:\ntokenSecretRef: example-token\nsource:\napiGroup: \"kubevirt.io\"\nkind: VirtualMachine\nname: example-vm\n</code></pre> <p>\u5c06\u5bfc\u51fa VM \u4e2d\u5b58\u5728\u7684\u4ee5\u4e0b\u5377\uff1a</p> <ul> <li>PVC</li> <li>DataVolumes</li> <li>\u5185\u5b58\u8f6c\u50a8</li> </ul> <p>\u4e0d\u4f1a\u5bfc\u51fa\u6240\u6709\u5176\u4ed6\u5377\u7c7b\u578b\u3002 \u4e3a\u4e86\u907f\u514d\u5bfc\u51fa\u4e0d\u4e00\u81f4\u7684\u6570\u636e\uff0c\u865a\u62df\u673a\u53ea\u80fd\u5728\u5173\u95ed\u7535\u6e90\u65f6\u5bfc\u51fa\u3002 \u5982\u679c\u865a\u62df\u673a\u542f\u52a8\uff0c\u4efb\u4f55\u6d3b\u52a8\u7684 VM \u5bfc\u51fa\u90fd\u5c06\u7ec8\u6b62\u3002 \u8981\u4ece\u6b63\u5728\u8fd0\u884c\u7684\u865a\u62df\u673a\u5bfc\u51fa\u6570\u636e\uff0c\u60a8\u5fc5\u987b\u9996\u5148\u521b\u5efa\u865a\u62df\u673a\u5feb\u7167\uff08\u89c1\u4e0b\u6587\uff09\u3002</p> <p>\u5982\u679c VM \u5305\u542b\u591a\u4e2a\u53ef\u5bfc\u51fa\u7684\u5377\uff0c\u5219\u6bcf\u4e2a\u5377\u5c06\u83b7\u5f97\u81ea\u5df1\u7684 URL \u94fe\u63a5\u3002 \u5982\u679c VM \u4e0d\u5305\u542b\u53ef\u5bfc\u51fa\u7684\u5377\uff0c<code>VMExport</code> \u5c06\u8fdb\u5165\u201c\u8df3\u8fc7\u201d\u9636\u6bb5\uff0c\u5e76\u4e14\u4e0d\u4f1a\u542f\u52a8\u5bfc\u51fa\u670d\u52a1\u5668\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineExport/#_2","title":"\u5bfc\u51fa\u865a\u62df\u673a\u5feb\u7167\u5377","text":"<p>\u60a8\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a VMExport CR \u6765\u6807\u8bc6\u8981\u5bfc\u51fa\u7684\u865a\u62df\u673a\u5feb\u7167\u3002 \u60a8\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 <code>VMExport</code>\uff1a</p> <pre><code>apiVersion: export.kubevirt.io/v1alpha1\nkind: VirtualMachineExport\nmetadata:\nname: example-export\nspec:\ntokenSecretRef: example-token\nsource:\napiGroup: \"snapshot.kubevirt.io\"\nkind: VirtualMachineSnapshot\nname: example-vmsnapshot\n</code></pre> <p>\u5f53\u60a8\u57fa\u4e8e\u865a\u62df\u673a\u5feb\u7167\u521b\u5efa <code>VMExport</code> \u65f6\uff0c\u63a7\u5236\u5668\u5c06\u5c1d\u8bd5\u4ece\u865a\u62df\u673a\u5feb\u7167\u4e2d\u5305\u542b\u7684\u5377\u5feb\u7167\u521b\u5efa PVC\u3002 \u4e00\u65e6\u6240\u6709 PVC \u51c6\u5907\u5c31\u7eea\uff0c\u5bfc\u51fa\u670d\u52a1\u5668\u5c06\u542f\u52a8\uff0c\u60a8\u53ef\u4ee5\u5f00\u59cb\u5bfc\u51fa\u3002 \u5982\u679c\u865a\u62df\u673a\u5feb\u7167\u5305\u542b\u591a\u4e2a\u53ef\u5bfc\u51fa\u7684\u5377\uff0c\u5219\u6bcf\u4e2a\u5377\u5c06\u83b7\u5f97\u81ea\u5df1\u7684 URL \u94fe\u63a5\u3002 \u5982\u679c\u865a\u62df\u673a\u5feb\u7167\u4e0d\u5305\u542b\u53ef\u5bfc\u51fa\u7684\u5377\uff0c<code>VMExport</code> \u5c06\u8fdb\u5165\u8df3\u8fc7\u9636\u6bb5\uff0c\u5e76\u4e14\u4e0d\u4f1a\u542f\u52a8\u5bfc\u51fa\u670d\u52a1\u5668\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineExport/#pvc","title":"\u5bfc\u51faPVC","text":"<p>\u60a8\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a VMExport CR \u6765\u6807\u8bc6\u8981\u5bfc\u51fa\u7684\u6301\u4e45\u5377\u58f0\u660e (PVC)\u3002 \u60a8\u53ef\u4ee5\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 <code>VMExport</code>\uff1a</p> <pre><code>apiVersion: export.kubevirt.io/v1alpha1\nkind: VirtualMachineExport\nmetadata:\nname: example-export\nspec:\ntokenSecretRef: example-token\nsource:\napiGroup: \"\"\nkind: PersistentVolumeClaim\nname: example-pvc\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0cPVC \u540d\u79f0\u4e3a <code>example-pvc</code>\u3002 \u8bf7\u6ce8\u610f\uff0cPVC \u4e0d\u9700\u8981\u5305\u542b\u865a\u62df\u673a\u78c1\u76d8\uff0c\u5b83\u53ef\u4ee5\u5305\u542b\u4efb\u4f55\u5185\u5bb9\uff0c\u4f46\u4e3b\u8981\u7528\u4f8b\u662f\u5bfc\u51fa\u865a\u62df\u673a\u78c1\u76d8\u3002 \u5c06\u6b64 yaml \u53d1\u5e03\u5230\u96c6\u7fa4\u540e\uff0c\u5c06\u5728\u4e0e PVC \u76f8\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5bfc\u51fa\u670d\u52a1\u5668\u3002 \u5982\u679c\u6e90 PVC \u6b63\u5728\u88ab\u53e6\u4e00\u4e2a pod\uff08\u4f8b\u5982 virt-launcher pod\uff09\u4f7f\u7528\uff0c\u5219\u5bfc\u51fa\u5c06\u4fdd\u6301\u6302\u8d77\u72b6\u6001\uff0c\u76f4\u5230 PVC \u4e0d\u518d\u4f7f\u7528\u3002 \u5982\u679c\u5bfc\u51fa\u5668\u670d\u52a1\u5668\u5904\u4e8e\u6d3b\u52a8\u72b6\u6001\u5e76\u4e14\u53e6\u4e00\u4e2a pod \u5f00\u59cb\u4f7f\u7528 PVC\uff0c\u5219\u5bfc\u51fa\u5668\u670d\u52a1\u5668\u5c06\u88ab\u7ec8\u6b62\uff0c\u76f4\u5230 PVC \u4e0d\u518d\u4f7f\u7528\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineExport/#_3","title":"\u5bfc\u51fa\u72b6\u6001\u94fe\u63a5","text":"<p><code>VirtualMachineExport</code> CR \u5c06\u5305\u542b\u5e26\u6709\u5bfc\u51fa\u670d\u52a1\u7684\u5185\u90e8\u548c\u5916\u90e8\u94fe\u63a5\u7684\u72b6\u6001\u3002 \u5185\u90e8\u94fe\u63a5\u4ec5\u5728\u96c6\u7fa4\u5185\u90e8\u6709\u6548\uff0c\u5916\u90e8\u94fe\u63a5\u4ec5\u5bf9\u901a\u8fc7 Ingress \u6216 Route \u7684\u5916\u90e8\u8bbf\u95ee\u6709\u6548\u3002 <code>cert</code> \u5b57\u6bb5\u5c06\u5305\u542b\u7b7e\u7f72\u5185\u90e8\u94fe\u63a5\u5bfc\u51fa\u670d\u52a1\u5668\u8bc1\u4e66\u7684 CA\uff0c\u6216\u7b7e\u7f72\u8def\u7531\u6216\u5165\u53e3\u7684 CA\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineInstance/","title":"VirtualMachineInstance","text":""},{"location":"kubeVirt/resource/virtualMachineInstanceMigration/","title":"VirtualMachineInstanceMigration","text":""},{"location":"kubeVirt/resource/virtualMachineInstanceMigration/#_1","title":"\u8fc1\u79fb\u95ee\u9898","text":"<p>\u865a\u62df\u673a\u8fc1\u79fb</p> <p>\u865a\u62df\u673a\u8fc1\u79fb\u4e00\u822c\u662f\u6307\u56e0\u5bbf\u4e3b\u673a\u51fa\u73b0\u6545\u969c\u65f6\uff0c\u9700\u8981\u5c06\u4e0a\u9762\u8fd0\u884c\u7684\u865a\u62df\u673a\u8fc1\u79fb\u5230\u5176\u5b83\u5bbf\u4e3b\u673a\u4e0a\u7684\u8fc7\u7a0b\u3002</p> <p>\u5728\u505a\u865a\u62df\u673a\u8fc1\u79fb\u524d\uff0c\u9996\u5148\u9700\u8981\u8003\u8651\u8fc1\u79fb\u524d\u540e\u5bbf\u4e3b\u673a\u7684\u786c\u4ef6\u8d44\u6e90\u5dee\u5f02\u6027\uff0c\u5305\u62ec\u5bbf\u4e3b\u673a\u67b6\u6784\uff08x86\u3001ARM\u7b49\uff09\u3001\u5bbf\u4e3b\u673acpu\u7c7b\u578b\uff08Intel\u3001AMD\u7b49\uff09\u7b49\u56e0\u7d20\uff0c\u8fd9\u90e8\u5206\u5185\u5bb9\u9700\u8981\u7ed3\u5408\u5177\u4f53\u4e1a\u52a1\u573a\u666f\u5177\u4f53\u5206\u6790\uff0c\u4e0d\u5728\u672c\u6587\u8ba8\u8bba\u8303\u56f4\u5185\u3002</p> <p>\u9664\u53bb\u786c\u4ef6\u8d44\u6e90\u5dee\u5f02\uff0ckubeVirt\u865a\u62df\u673a\u8fc1\u79fb\u8fd8\u9700\u8981\u8003\u8651\u4ee5\u4e0b\u95ee\u9898\uff1a</p> kubevirt\u5982\u4f55\u505akvm\u8fc1\u79fb\uff1f <p>kubeVirt\u7684kvm\u865a\u62df\u673a\u662f\u8fd0\u884c\u5728pod\u4e2d\u7684\uff0c\u4e3a\u4e86\u5b9e\u73b0kvm\u8fc1\u79fb\uff0ckubevirt\u5b9a\u4e49\u4e86\u4e00\u4e2a\u53eb\u4f5c<code>VirtualMachineInstanceMigration</code>\u7684CRD\u3002\u7528\u6237\u5982\u679c\u60f3\u8fc1\u79fbkubeVirt kvm\uff0c\u7f16\u5199\u4e00\u4e2a<code>VirtualMachineInstanceMigration</code>\u5bf9\u8c61apply\u5373\u53ef\uff0capply\u540e\u5bf9\u5e94\u7684controller\u4f1a\u5728\u5176\u5b83\u8282\u70b9\u521b\u5efa\u4e00\u4e2a\u65b0\u7684kvm pod\uff0c\u4e4b\u540e\u518d\u505a\u5207\u6362\uff0c\u4ece\u800c\u5b8c\u6210kvm\u7684\u8fc1\u79fb\u3002</p> \u8fc1\u79fb\u8fc7\u7a0b\u5bf9\u4e1a\u52a1\u7684\u5f71\u54cd? <p>\u8fc1\u79fb\u53ef\u4ee5\u5206\u4e3a\u51b7\u8fc1\u79fb\uff08<code>offline migration</code>\uff0c\u4e5f\u53eb\u5e38\u89c4\u8fc1\u79fb\u3001\u79bb\u7ebf\u8fc1\u79fb\uff09\u548c\u70ed\u8fc1\u79fb\uff08<code>live migration</code>\uff0c\u4e5f\u53eb\u52a8\u6001\u8fc1\u79fb\u3001\u5b9e\u65f6\u8fc1\u79fb\uff09\uff0c\u51b7\u8fc1\u79fb\u5728\u8fc1\u79fb\u4e4b\u524d\u9700\u8981\u5c06\u865a\u62df\u673a\u5173\u673a\uff0c\u7136\u540e\u5c06\u865a\u62df\u673a\u955c\u50cf\u548c\u72b6\u6001\u62f7\u8d1d\u5230\u76ee\u6807\u5bbf\u4e3b\u673a\uff0c\u4e4b\u540e\u518d\u542f\u52a8\uff1b\u70ed\u8fc1\u79fb\u5219\u662f\u5c06\u865a\u62df\u673a\u4fdd\u5b58\uff08save\uff09/\u56de\u590d\uff08restore\uff09\uff0c\u5373\u5c06\u6574\u4e2a\u865a\u62df\u673a\u7684\u8fd0\u884c\u72b6\u6001\u5b8c\u6574\u7684\u4fdd\u5b58\u4e0b\u6765\uff0c\u62f7\u8d1d\u5230\u5176\u5b83\u5bbf\u4e3b\u673a\u4e0a\u540e\u5feb\u901f\u7684\u6062\u590d\u3002\u70ed\u8fc1\u79fb\u76f8\u6bd4\u4e8e\u51b7\u8fc1\u79fb\uff0c\u5bf9\u4e1a\u52a1\u6765\u8bf4\u51e0\u4e4e\u65e0\u611f\u77e5\u3002</p> <p>kubeVirt\u7684<code>VirtualMachineInstanceMigration</code>\u652f\u6301<code>live migration</code>\uff0c\u5b98\u65b9\u8d44\u6599\u53ef\u53c2\u8003\u300aLive Migration in KubeVirt\u300b</p> \u6570\u636e\u5bf9\u8fc1\u79fb\u7684\u9650\u5236\uff1f <p>\u8fd9\u91cc\u8bf4\u7684\u6570\u636e\u4e3b\u8981\u8003\u8651\u5185\u5b58\u6570\u636e\u3001\u7cfb\u7edf\u76d8/\u6570\u636e\u76d8\u6570\u636e\uff0c\u7cfb\u7edf\u76d8\u548c\u6570\u636e\u76d8\u5982\u679c\u4f7f\u7528\u4e86\u5bbf\u4e3b\u673a\u7684\u672c\u5730\u76d8\uff08\u5982SSD\uff09\uff0c\u8fc1\u79fb\u540e\u6570\u636e\u4f1a\u4e22\u5931\uff0c\u4e91\u76d8\uff08\u5305\u62ecpvc\uff09\u5219\u65e0\u5f71\u54cd\u3002</p> \u5982\u4f55\u4fdd\u8bc1kubevirt kvm pod\u4e0d\u518d\u8c03\u5ea6\u5230\u672c\u673a\uff1f <p>kubeVirt\u7684kvm pod\u8c03\u5ea6\u7531k8s\u8c03\u5ea6\u5668\u5b8c\u6210\uff0c\u56e0\u6b64\u4e3a\u4e86\u9632\u6b62\u65b0\u7684kvm pod\u518d\u6b21\u8c03\u5ea6\u5230\u672c\u8282\u70b9\uff0c\u53ef\u4ee5\u901a\u8fc7\u7ed9\u8282\u70b9\u6253\u6c61\u70b9\u7b49\u65b9\u6cd5\u6765\u89e3\u51b3\u3002</p> \u4e1a\u52a1\u65b9\u5bf9\u865a\u62df\u673a\u7684ip\u662f\u654f\u611f\u7684\uff0c\u5982\u4f55\u4fdd\u8bc1\u8fc1\u79fb\u540e\u865a\u62df\u673a\u7684ip\u4e0d\u53d8\uff1f <p>kubeVirt\u7684kvm\u865a\u62df\u673a\u662f\u5728pod\u4e2d\u542f\u52a8\u7684\uff0c\u4ece\u800c\u8be5pod\u548c\u5bf9\u5e94\u7684\u865a\u62df\u673aip\u4e0ek8s\u7f51\u7edc\u65b9\u6848\u6709\u5173\uff0c\u56e0\u6b64\u53ef\u4ee5\u8003\u8651\u5728CNI\u7f51\u7edc\u65b9\u6848\u4e2d\u5b9e\u73b0kvm\u7684\u56fa\u5b9aip\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineInstanceMigration/#_2","title":"\u6d41\u7a0b\u5206\u6790","text":"<p>\u6211\u4eec\u5047\u8bbe\u73b0\u5728\u6709\u4e00\u4e2arunning\u7684kvm\uff08\u5373\u5b58\u5728\u4e00\u4e2a<code>running</code>\u72b6\u6001\u7684vmi\u548cpod\uff09\uff0c\u6b64\u65f6apply\u4e00\u4e2a<code>VirtualMachineInstanceMigration</code>\u4f1a\u53d1\u751f\u4ec0\u4e48\uff1a</p> <p></p>"},{"location":"kubeVirt/resource/virtualMachineInstancePreset/","title":"VirtualMachineInstancePreset","text":"<p><code>VirtualMachineInstancePresets</code> \u662f\u4e00\u822c <code>VirtualMachineInstance</code> \u914d\u7f6e\u7684\u6269\u5c55\uff0c\u5176\u884c\u4e3a\u4e0e Kubernetes \u4e2d\u7684 <code>PodPresets</code> \u975e\u5e38\u76f8\u4f3c\u3002 \u521b\u5efa <code>VirtualMachineInstance</code> \u65f6\uff0c\u4efb\u4f55\u9002\u7528\u7684 <code>VirtualMachineInstancePresets</code> \u5c06\u5e94\u7528\u4e8e <code>VirtualMachineInstance</code> \u7684\u73b0\u6709\u89c4\u8303\u3002 \u8fd9\u5141\u8bb8\u91cd\u590d\u4f7f\u7528\u5e94\u7528\u4e8e\u591a\u4e2a <code>VirtualMachineInstances</code> \u7684\u901a\u7528\u8bbe\u7f6e\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineInstancePreset/#_1","title":"\u6267\u884c\u903b\u8f91","text":"<p><code>VirtualMachineInstancePresets</code> \u5728\u5904\u7406 <code>VirtualMachineInstance</code> \u8d44\u6e90\u65f6\u5c3d\u65e9\u5e94\u7528\u3002 \u8fd9\u610f\u5473\u7740 <code>VirtualMachineInstance</code> \u8d44\u6e90\u5728\u88ab KubeVirt \u7684\u4efb\u4f55\u5176\u4ed6\u7ec4\u4ef6\u5904\u7406\u4e4b\u524d\u88ab\u4fee\u6539\u3002</p> <p>\u4e00\u65e6 <code>VirtualMachineInstancePreset</code> \u6210\u529f\u5e94\u7528\u4e8e <code>VirtualMachineInstance</code>\uff0c<code>VirtualMachineInstance</code> \u5c06\u88ab\u6807\u8bb0\u4e00\u4e2a\u6ce8\u91ca\u4ee5\u8868\u660e\u5b83\u5df2\u88ab\u5e94\u7528\u3002 \u5982\u679c\u5728\u5e94\u7528 <code>VirtualMachineInstancePreset</code> \u65f6\u53d1\u751f\u51b2\u7a81\uff0c\u5219 <code>VirtualMachineInstancePreset</code> \u7684\u8be5\u90e8\u5206\u5c06\u88ab\u8df3\u8fc7\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineInstancePreset/#_2","title":"\u521b\u5efa\u548c\u4f7f\u7528","text":"<p>KubeVirt \u4f7f\u7528 Kubernetes \u6807\u7b7e\u548c\u9009\u62e9\u5668\u6765\u786e\u5b9a\u54ea\u4e9b <code>VirtualMachineInstancePresets</code> \u9002\u7528\u4e8e\u4efb\u4f55\u7ed9\u5b9a\u7684 <code>VirtualMachineInstance</code>\uff0c\u7c7b\u4f3c\u4e8e <code>PodPresets</code> \u5728 Kubernetes \u4e2d\u7684\u5de5\u4f5c\u65b9\u5f0f\u3002 \u6210\u529f\u5b8c\u6210\u540e\uff0c<code>VirtualMachineInstance</code> \u4f1a\u6807\u6709\u6ce8\u91ca\u3002</p> <p>\u4efb\u4f55\u57df\u7ed3\u6784\u90fd\u53ef\u4ee5\u5728 <code>VirtualMachineInstancePreset</code> \u7684\u89c4\u8303\u4e2d\u5217\u51fa\u3002 \u4f8b\u5982 \u65f6\u949f\u3001\u529f\u80fd\u3001\u5185\u5b58\u3001CPU \u6216\u7f51\u7edc\u63a5\u53e3\u7b49\u8bbe\u5907\u3002 <code>VirtualMachineInstancePreset</code> \u7684\u89c4\u8303\u90e8\u5206\u7684\u6240\u6709\u5143\u7d20\u90fd\u5c06\u5e94\u7528\u4e8e <code>VirtualMachineInstance</code>\u3002</p> <p><code>VirtualMachineInstancePresets</code> \u662f\u547d\u540d\u7a7a\u95f4\u8d44\u6e90\uff0c\u56e0\u6b64\u5e94\u5728\u4e0e\u4f7f\u7528\u5b83\u4eec\u7684 <code>VirtualMachineInstances</code> \u76f8\u540c\u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u521b\u5efa\uff1a</p> <pre><code>kubectl create -f &lt;\u9884\u8bbe&gt;.yaml [--namespace &lt;\u547d\u540d\u7a7a\u95f4&gt;]\n</code></pre> <p>KubeVirt \u5c06\u901a\u8fc7\u5339\u914d\u6807\u7b7e\u6765\u786e\u5b9a\u54ea\u4e9b <code>VirtualMachineInstancePresets</code> \u5e94\u7528\u4e8e\u7279\u5b9a\u7684 <code>VirtualMachineInstance</code>\u3002 \u4f8b\u5982\uff1a</p> <pre><code>kind: VirtualMachineInstancePreset\nmetadata:\nname: example-preset\nspec:\nselector:\nmatchLabels:\nkubevirt.io/flavor: foo\n...\n</code></pre> <p>\u5c06\u5339\u914d\u540c\u4e00\u547d\u540d\u7a7a\u95f4\u4e2d\u6807\u7b7e\u4e3a <code>kubevirt.io/flavor: foo</code> \u7684\u4efb\u4f55 <code>VirtualMachineInstance</code>\u3002 \u4f8b\u5982\uff1a</p> <pre><code>kind: VirtualMachineInstance\nversion: v1\nmetadata:\nname: myvm\nlabels:\nkubevirt.io/flavor: foo\n...\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineInstancePreset/#vmipreset","title":"\u6392\u9664vmiPreset","text":"<p>\u7531\u4e8e <code>VirtualMachineInstancePresets</code> \u4f7f\u7528\u9009\u62e9\u5668\u6765\u6307\u793a\u5176\u8bbe\u7f6e\u5e94\u5e94\u7528\u4e8e\u54ea\u4e9b <code>VirtualMachineInstances</code>\uff0c\u56e0\u6b64\u9700\u8981\u5b58\u5728\u4e00\u79cd\u673a\u5236\uff0c<code>VirtualMachineInstances</code> \u53ef\u4ee5\u901a\u8fc7\u8be5\u673a\u5236\u5b8c\u5168\u9009\u62e9\u9000\u51fa <code>VirtualMachineInstancePresets</code>\u3002 \u8fd9\u662f\u4f7f\u7528\u6ce8\u91ca\u5b8c\u6210\u7684\uff1a</p> <pre><code>kind: VirtualMachineInstance\nversion: v1\nmetadata:\nname: myvm\nannotations:\nvirtualmachinepresets.admission.kubevirt.io/exclude: \"true\"\n...\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/","title":"VirtualMachineInstanceReplicaSet","text":""},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/#_1","title":"\u865a\u62df\u673a\u5b9e\u4f8b\u5f39\u6027\u4f38\u7f29","text":"<p>vmirs\u5b9a\u4e49</p> <p>VirtualMachineInstanceReplicaSet\uff08vmirs\uff09\u786e\u4fdd\u6307\u5b9a\u6570\u91cf\u7684 VirtualMachineInstance\uff08vmi\uff09 \u526f\u672c\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u5728\u8fd0\u884c\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u7406\u89e3\uff0cvmirs \u5c31\u662fkubernetes\uff08k8s\uff09\u91cc\u9762\u7684\u63a7\u5236\u5668\uff08Deployment\uff0cReplicaSet\uff09\u7ba1\u7406\u6211\u4eecpod\u7684\u526f\u672c\u6570\uff0c\u5b9e\u73b0\u6269\u7f29\u5bb9\u3001\u56de\u6eda\u7b49\u3002\u4e5f\u53ef\u4ee5\u501f\u52a9HorizontalPodAutoscaler\uff08HPA\uff09\u5b9e\u73b0\u5f39\u6027\u4f38\u7f29\u3002\u8fd9\u91cc\u6211\u4eec\u5c31\u8bf4vmirs\u63a7\u5236\u5668\uff0c\u5728\u8fd9\u91cc\u7684vmirs\u63a7\u5236\u5668\uff0c\u7ba1\u7406\u6211\u4eecvmi\u865a\u62df\u673a\u5b9e\u4f8b\u7684\u526f\u672c\u6570\uff0c\u4e5f\u53ef\u4ee5\u5b9e\u73b0\u6269\u7f29\u5bb9\uff0c\u501f\u52a9HPA\u5b9e\u73b0\u5f39\u6027\u4f38\u7f29\u3002\u6240\u6709\u6211\u4eec\u7684yaml\u6587\u4ef6\u5199\u6cd5\u539f\u7406\u90fd\u7c7b\u4f3c\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/#_2","title":"\u9002\u7528\u573a\u666f","text":"<p>\u5f53\u9700\u8981\u8bb8\u591a\u76f8\u540c\u7684\u865a\u62df\u673a\uff0c\u5e76\u4e14\u4e0d\u5173\u5fc3\u5728\u865a\u62df\u673a\u7ec8\u6b62\u540e\u4efb\u4f55\u78c1\u76d8\u72b6\u6001\u65f6\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/#vmirs","title":"vmirs\u4f7f\u7528","text":""},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/#vmirs_1","title":"\u521b\u5efavmirs","text":"<p>\u7f16\u5199vmirs\u7684\u8d44\u6e90\u6587\u4ef6:</p> vmirs.yaml<pre><code>apiVersion: kubevirt.io/v1alpha3\nkind: VirtualMachineInstanceReplicaSet\nmetadata:\nname: testreplicaset\nspec:\nreplicas: 2\nselector:\nmatchLabels:\nmyvmi: myvmi  # \u4fdd\u6301\u4e00\u81f4\uff0c\u9009\u62e9\ntemplate:\nmetadata:\nlabels:\nmyvmi: myvmi # \u4fdd\u6301\u4e00\u81f4\uff0c\u5339\u914d\nspec:\ndomain:\ndevices:\ndisks:\n- name: containerdisk\ndisk:\nbus: virtio\nresources:\nrequests:\nmemory: 1024M\nvolumes:\n- name: containerdisk\ncontainerDisk:\nimage: centos7\nimagePullPolicy: IfNotPresent\n</code></pre> <p>\u7136\u540e <code>kubectl</code> \u521b\u5efa vmirs,</p> <pre><code>[root@master vm]# kubectl apply -f vmirs.yaml\nvirtualmachineinstancereplicaset.kubevirt.io/testreplicaset created\n</code></pre> <p>\u67e5\u770b\u8fd0\u884c\u72b6\u6001\uff0c</p> <pre><code>[root@master vm]# kubectl get vmis\nNAME                  AGE   PHASE        IP             NODENAME   READY\ntestreplicaset6vm9s   42s   Running      10.244.0.139   master     False\ntestreplicaset8dshm   22s   Scheduling                             False\ntestreplicasetbqxnb   22s   Scheduling                             False\n[root@master vm]# kubectl get vmis\nNAME                  AGE   PHASE     IP             NODENAME   READY\ntestreplicaset8dshm   46s   Running   10.244.0.141   master     False\ntestreplicasetbqxnb   46s   Running   10.244.0.140   master     False\n[root@master vm]# kubectl get pod\nNAME                                      READY   STATUS    RESTARTS   AGE\nvirt-launcher-testreplicaset8dshm-nz7x2   2/2     Running   0          69s\nvirt-launcher-testreplicasetbqxnb-ljp2f   2/2     Running   0          70s\n</code></pre> <p><code>describe</code> \u67e5\u770b\u8be6\u7ec6\u4fe1\u606f,</p> <pre><code>[root@master vm]# kubectl describe vmirs testreplicaset\nName:         testreplicaset\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  kubevirt.io/latest-observed-api-version: v1\n              kubevirt.io/storage-observed-api-version: v1alpha3\nAPI Version:  kubevirt.io/v1\nKind:         VirtualMachineInstanceReplicaSet\nMetadata:\n  Creation Timestamp:  2022-05-02T13:50:05Z\n  Generation:          2\nManaged Fields:\n    API Version:  kubevirt.io/v1alpha3\n    Fields Type:  FieldsV1\n    fieldsV1:\n      f:metadata:\n        f:annotations:\n          f:kubevirt.io/latest-observed-api-version:\n          f:kubevirt.io/storage-observed-api-version:\n      f:spec:\n        f:template:\n          f:metadata:\n            f:creationTimestamp:\n      f:status:\n        .:\n        f:labelSelector:\n        f:replicas:\n    Manager:      Go-http-client\n    Operation:    Update\n    Time:         2022-05-02T13:50:05Z\n    API Version:  kubevirt.io/v1alpha3\n    Fields Type:  FieldsV1\n    fieldsV1:\n      f:metadata:\n        f:annotations:\n ...\n ...\n                  .:\n                  f:memory:\n            f:volumes:\n    Manager:         kubectl\n    Operation:       Update\n    Time:            2022-05-02T13:50:05Z\n  Resource Version:  267261\nSelf Link:         /apis/kubevirt.io/v1/namespaces/default/virtualmachineinstancereplicasets/testreplicaset\n  UID:               96d17d12-17b5-4df7-940a-fac7c6b820d2\nSpec:\n  Replicas:  2\nSelector:\n    Match Labels:\n      Myvmi:  myvmi\n  Template:\n    Metadata:\n      Creation Timestamp:  &lt;nil&gt;\n      Labels:\n        Myvmi:  myvmi\n    Spec:\n      Domain:\n        Devices:\n          Disks:\n            Disk:\n              Bus:  virtio\n            Name:   containerdisk\n        Resources:\n          Requests:\n            Memory:  1024M\n      Volumes:\n        Container Disk:\n          Image:              kubevirt/cirros-container-disk-demo\n          Image Pull Policy:  IfNotPresent\n        Name:                 containerdisk\nStatus:\n  Label Selector:  myvmi=myvmi\n  Replicas:        2\nEvents:\n  Type    Reason            Age    From                                 Message\n  ----    ------            ----   ----                                 -------\n  Normal  SuccessfulCreate  5m21s  virtualmachinereplicaset-controller  Started the virtual machine by creating the new virtual machine instance testreplicaseth6zsl\n  Normal  SuccessfulCreate  5m21s  virtualmachinereplicaset-controller  Started the virtual machine by creating the new virtual machine instance testreplicasetw75s4\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/#_3","title":"\u6269\u7f29\u5bb9","text":"<p>\u67e5\u770b vmirs,</p> <pre><code>[root@master vm]# kubectl get -f vmis.yaml\nNAME             DESIRED   CURRENT   READY   AGE\ntestreplicaset   3         3                 2m52s\n</code></pre> <p>\u4f7f\u7528scale\u547d\u4ee4\uff0c\u8bbe\u7f6e\u526f\u672c\u6570\u4e3a5,</p> <pre><code>[root@master vm]# kubectl scale vmirs testreplicaset --replicas 5\nvirtualmachineinstancereplicaset.kubevirt.io/testreplicaset scaled\n</code></pre> <p>\u67e5\u770b\u6548\u679c\uff0c</p> <pre><code>[root@master vm]# kubectl get vmis\nNAME                  AGE     PHASE     IP             NODENAME   READY\ntestreplicaset98x8d   5m29s   Running   10.244.0.146   master     False\ntestreplicasetddqc9   2m24s   Running   10.244.0.148   master     False\ntestreplicasetdss8l   5m29s   Running   10.244.0.144   master     False\ntestreplicasetmhm6x   5m29s   Running   10.244.0.145   master     False\ntestreplicasetv4dzs   2m24s   Running   10.244.0.147   master     False\n\n[root@master vm]# kubectl get pod\nNAME                                      READY   STATUS    RESTARTS   AGE\nvirt-launcher-testreplicaset98x8d-5p99p   2/2     Running   0          3m15s\nvirt-launcher-testreplicasetddqc9-6c2m4   2/2     Running   0          10s\nvirt-launcher-testreplicasetdss8l-9mv56   2/2     Running   0          3m15s\nvirt-launcher-testreplicasetmhm6x-r76wt   2/2     Running   0          3m15s\nvirt-launcher-testreplicasetv4dzs-bm4s8   2/2     Running   0          10s\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineInstanceReplicaSet/#_4","title":"\u5f39\u6027\u4f38\u7f29","text":"yaml\u6587\u4ef6autoscale\u547d\u4ee4 <p>\u4f7f\u7528Horizontal Pod Autoscaler\uff08hpa\uff09\uff0c\u521b\u5efayaml\u6587\u4ef6,</p> <p>vmirs-hpa.yaml<pre><code>apiVersion: autoscaling/v1\nkind: HorizontalPodAutoscaler\nmetadata:\ncreationTimestamp: null\nname: testreplicaset\nspec:\nmaxReplicas: 5\nminReplicas: 2\nscaleTargetRef:\napiVersion: kubevirt.io/v1\nkind: VirtualMachineInstanceReplicaSet\nname: testreplicaset\n</code></pre> \u521b\u5efavmirs-hpa\uff0c</p> <pre><code>[root@master vm]# kubectl apply -f vmirs-hpa.yaml\nhorizontalpodautoscaler.autoscaling/testreplicaset created\n</code></pre> <p>\u67e5\u770b\u72b6\u6001\uff0c <pre><code>[root@master vm]# kubectl get hpa\nNAME             REFERENCE                                         TARGETS         MINPODS   MAXPODS   REPLICAS   AGE\ntestreplicaset   VirtualMachineInstanceReplicaSet/testreplicaset   &lt;unknown&gt;/80%   2         5         0          7s\n</code></pre></p> <p>\u4f7f\u7528<code>kubectl autoscale</code>\u547d\u4ee4,</p> <pre><code>[root@master vm]# kubectl autoscale vmirs testreplicaset --min=2 --max=5\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineInstancetype/","title":"vmiType\u8d44\u6e90","text":"<p>KubeVirt \u4e3a\u5b9e\u4f8b\u7c7b\u578b\u63d0\u4f9b\u4e86\u4e24\u79cd CRD\uff1a\u96c6\u7fa4\u8303\u56f4\u7684 <code>VirtualMachineClusterInstancetype</code> \u548c\u5177\u4f53\u547d\u540d\u7a7a\u95f4\u4e0b\u7684 <code>VirtualMachineInstancetype</code>\u3002 \u8fd9\u4e9b CRD \u901a\u8fc7\u5171\u4eab <code>VirtualMachineInstancetypeSpec</code> \u5c01\u88c5\u4e86 VirtualMachine \u7684\u4ee5\u4e0b\u8d44\u6e90\u76f8\u5173\u7279\u5f81\uff1a</p> <code>VirtualMachineInstancetypeSpec</code>\u53c2\u6570 \u63cf\u8ff0 <code>CPU</code> \u63d0\u4f9b\u7ed9<code>guest</code>\u7684\u6240\u9700 vCPU \u6570\u91cf <code>Memory</code> \u63d0\u4f9b\u7ed9<code>guest</code>\u6240\u9700\u7684\u5185\u5b58\u91cf <code>GPUs</code> \u8981\u76f4\u901a\u7684\u53ef\u9009 vGPU \u5217\u8868 <code>HostDevices</code> \u8981\u76f4\u901a\u7684\u4e3b\u673a\u8bbe\u5907\u7684\u53ef\u9009\u5217\u8868 <code>IOThreadsPolicy</code> \u8981\u4f7f\u7528\u7684<code>IOThreadsPolicy</code>\uff08\u53ef\u9009\uff09 <code>LaunchSecurity</code> \u8981\u4f7f\u7528\u7684<code>LaunchSecurity</code>\uff08\u53ef\u9009\uff09 <p>\u4f8b\u5982:</p> <pre><code>apiVersion: instancetype.kubevirt.io/v1beta1\nkind: VirtualMachineInstancetype\nmetadata:\nname: example-instancetype\nspec:\ncpu:\nguest: 1\nmemory:\nguest: 128Mi\n</code></pre> <p>\u5b9e\u4f8b\u7c7b\u578b\u4e2d\u63d0\u4f9b\u7684\u4efb\u4f55\u5185\u5bb9\u90fd\u4e0d\u80fd\u5728\u865a\u62df\u673a\u4e2d\u8986\u76d6\u3002 \u4f8b\u5982\uff0c\u7531\u4e8e<code>CPU</code>\u548c<code>Memory</code>\u90fd\u662f\u5b9e\u4f8b\u7c7b\u578b\u7684\u5fc5\u9700\u5c5e\u6027\uff0c\u5982\u679c\u7528\u6237\u5728\u5e95\u5c42<code>VirtualMachine</code>\u4e2d\u8bf7\u6c42<code>CPU</code>\u6216<code>Memory</code>\u8d44\u6e90\uff0c\u5b9e\u4f8b\u7c7b\u578b\u5c06\u53d1\u751f\u51b2\u7a81\uff0c\u5e76\u4e14\u5728\u521b\u5efa\u8fc7\u7a0b\u4e2d\u8bf7\u6c42\u5c06\u88ab\u62d2\u7edd\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePool/","title":"VirtualMachinePool","text":""},{"location":"kubeVirt/resource/virtualMachinePool/#virtualmachinepool_1","title":"\u4ec0\u4e48\u662f VirtualMachinePool","text":"<p>VirtualMachinePool\u5b9a\u4e49</p> <p>VirtualMachinePool \u5c1d\u8bd5\u786e\u4fdd\u6307\u5b9a\u6570\u91cf\u7684 VirtualMachine \u526f\u672c\u53ca\u5176\u5404\u81ea\u7684 VirtualMachineInstance \u968f\u65f6\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u3002 \u6362\u53e5\u8bdd\u8bf4\uff0cVirtualMachinePool \u53ef\u786e\u4fdd\u4e00\u4e2a VirtualMachine \u6216\u4e00\u7ec4 VirtualMachine \u59cb\u7ec8\u5904\u4e8e\u542f\u52a8\u72b6\u6001\u5e76\u51c6\u5907\u5c31\u7eea\u3002</p> <p>\u4e0d\u4fdd\u7559\u4efb\u4f55\u72b6\u6001\uff0c\u4e5f\u4e0d\u4fdd\u8bc1\u4efb\u4f55\u65f6\u5019\u8fd0\u884c\u7684 VirtualMachineInstance \u526f\u672c\u7684\u6700\u5927\u6570\u91cf\u3002 \u4f8b\u5982\uff0c</p> <p>\u4f8b\u5b50</p> <p>\u5982\u679c\u4ecd\u5728\u8fd0\u884c\u7684\u865a\u62df\u673a\u53ef\u80fd\u8fdb\u5165\u672a\u77e5\u72b6\u6001\uff0c\u5219 VirtualMachinePool \u53ef\u80fd\u4f1a\u51b3\u5b9a\u521b\u5efa\u65b0\u526f\u672c\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePool/#virtualmachinepool_2","title":"VirtualMachinePool \u4f7f\u7528","text":"<p>VirtualMachinePool \u5141\u8bb8\u6211\u4eec\u5728<code>spec.virtualMachineTemplate</code> \u4e2d\u6307\u5b9a<code>VirtualMachineTemplate</code>\u3002 \u5b83\u7531<code>spec.virtualMachineTemplate.metadata</code>\u4e2d\u7684<code>ObjectMetadata\u548cspec.virtualMachineTemplate.spec</code>\u4e2d\u7684<code>VirtualMachineSpec</code>\u7ec4\u6210\u3002 \u865a\u62df\u673a\u7684\u89c4\u683c\u7b49\u4e8eVirtualMachine\u5de5\u4f5c\u8d1f\u8f7d\u4e2d\u865a\u62df\u673a\u7684\u89c4\u683c\u3002</p> <p><code>spec.replicas</code> \u53ef\u7528\u4e8e\u6307\u5b9a\u9700\u8981\u591a\u5c11\u4e2a\u526f\u672c\u3002 \u5982\u679c\u672a\u6307\u5b9a\uff0c\u5219\u9ed8\u8ba4\u503c\u4e3a 1\u3002\u8be5\u503c\u53ef\u4ee5\u968f\u65f6\u66f4\u65b0\u3002 \u63a7\u5236\u5668\u5c06\u5bf9\u53d8\u5316\u505a\u51fa\u53cd\u5e94\u3002</p> <p>\u63a7\u5236\u5668\u4f7f\u7528<code>spec.selector</code> \u6765\u8ddf\u8e2a\u6258\u7ba1\u865a\u62df\u673a\u3002 \u6b64\u5904\u6307\u5b9a\u7684\u9009\u62e9\u5668\u5fc5\u987b\u80fd\u591f\u4e0e <code>spec.virtualMachineTemplate.metadata.labels</code> \u4e2d\u6307\u5b9a\u7684\u865a\u62df\u673a\u6807\u7b7e\u5339\u914d\u3002 \u5982\u679c\u9009\u62e9\u5668\u4e0e\u8fd9\u4e9b\u6807\u7b7e\u4e0d\u5339\u914d\uff0c\u6216\u8005\u5b83\u4eec\u4e3a\u7a7a\uff0c\u5219\u63a7\u5236\u5668\u9664\u4e86\u8bb0\u5f55\u9519\u8bef\u4e4b\u5916\u5c06\u4e0d\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\u3002 \u7528\u6237\u8d1f\u8d23\u907f\u514d\u521b\u5efa\u53ef\u80fd\u4e0e\u9009\u62e9\u5668\u548c\u6a21\u677f\u6807\u7b7e\u51b2\u7a81\u7684\u5176\u4ed6\u865a\u62df\u673a\u6216 VirtualMachinePools\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePool/#virtualmachinepool_3","title":"\u521b\u5efa VirtualMachinePool","text":"<p><code>VirtualMachinePool</code> \u662f Kubevirt API <code>pool.kubevirt.io/v1alpha1</code> \u7684\u4e00\u90e8\u5206\u3002\u4ee5\u4e0b\u662f\u521b\u5efa<code>VirtualMachinePool</code>\u7684\u793a\u4f8b\uff0c</p> vm-pool-cirros.yaml<pre><code>apiVersion: pool.kubevirt.io/v1alpha1\nkind: VirtualMachinePool\nmetadata:\nname: vm-pool-cirros\nspec:\nreplicas: 3\nselector:\nmatchLabels:\nkubevirt.io/vmpool: vm-pool-cirros\nvirtualMachineTemplate:\nmetadata:\ncreationTimestamp: null\nlabels:\nkubevirt.io/vmpool: vm-pool-cirros\nspec:\nrunning: true\ntemplate:\nmetadata:\ncreationTimestamp: null\nlabels:\nkubevirt.io/vmpool: vm-pool-cirros\nspec:\ndomain:\ndevices:\ndisks:\n- disk:\nbus: virtio\nname: containerdisk\nresources:\nrequests:\nmemory: 128Mi\nterminationGracePeriodSeconds: 0\nvolumes:\n- containerDisk:\nimage: kubevirt/cirros-container-disk-demo:latest\nname: containerdisk\n</code></pre> <p>\u63d0\u4ea4\u4e0a\u8ff0\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c</p> <pre><code>$ kubectl create -f vm-pool-cirros.yaml\nvirtualmachinepool.pool.kubevirt.io/vm-pool-cirros created\n$ kubectl describe vmpool vm-pool-cirros\nName:         vm-pool-cirros\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\nAPI Version:  pool.kubevirt.io/v1alpha1\nKind:         VirtualMachinePool\nMetadata:\n  Creation Timestamp:  2023-02-09T18:30:08Z\n  Generation:          1\nManager:      kubectl-create\n    Operation:    Update\n    Time:         2023-02-09T18:30:08Z\n    API Version:  pool.kubevirt.io/v1alpha1\n    Fields Type:  FieldsV1\n    fieldsV1:\n      f:status:\n        .:\n        f:labelSelector:\n        f:readyReplicas:\n        f:replicas:\n    Manager:         virt-controller\n    Operation:       Update\n    Subresource:     status\n    Time:            2023-02-09T18:30:44Z\n  Resource Version:  6606\nUID:               ba51daf4-f99f-433c-89e5-93f39bc9989d\nSpec:\n  Replicas:  3\nSelector:\n    Match Labels:\n      kubevirt.io/vmpool:  vm-pool-cirros\n  Virtual Machine Template:\n    Metadata:\n      Creation Timestamp:  &lt;nil&gt;\n      Labels:\n        kubevirt.io/vmpool:  vm-pool-cirros\n    Spec:\n      Running:  true\nTemplate:\n        Metadata:\n          Creation Timestamp:  &lt;nil&gt;\n          Labels:\n            kubevirt.io/vmpool:  vm-pool-cirros\n        Spec:\n          Domain:\n            Devices:\n              Disks:\n                Disk:\n                  Bus:  virtio\n                Name:   containerdisk\n            Resources:\n              Requests:\n                Memory:                      128Mi\n          Termination Grace Period Seconds:  0\nVolumes:\n            Container Disk:\n              Image:  kubevirt/cirros-container-disk-demo:latest\n            Name:     containerdisk\nStatus:\n  Label Selector:  kubevirt.io/vmpool=vm-pool-cirros\n  Ready Replicas:  2\nReplicas:        3\nEvents:\n  Type    Reason            Age   From                           Message\n  ----    ------            ----  ----                           -------\n  Normal  SuccessfulCreate  17s   virtualmachinepool-controller  Created VM default/vm-pool-cirros-0\n  Normal  SuccessfulCreate  17s   virtualmachinepool-controller  Created VM default/vm-pool-cirros-2\n  Normal  SuccessfulCreate  17s   virtualmachinepool-controller  Created VM default/vm-pool-cirros-1\n</code></pre> <p><code>Replicas</code> \u4e3a 3\uff0c<code>Ready Replicas</code> \u4e3a 2\u3002\u8fd9\u610f\u5473\u7740\u5728\u663e\u793a\u72b6\u6001\u65f6\uff0c\u5df2\u7ecf\u521b\u5efa\u4e86\u4e09\u4e2a\u865a\u62df\u673a\uff0c\u4f46\u53ea\u6709\u4e24\u4e2a\u6b63\u5728\u8fd0\u884c\u5e76\u51c6\u5907\u5c31\u7eea\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePool/#scale-subresource","title":"\u901a\u8fc7 Scale Subresource \u4f38\u7f29","text":"<p><code>VirtualMachinePool</code> \u652f\u6301Scale Subresource\u3002 \u56e0\u6b64\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>kubectl</code> \u5bf9\u5176\u8fdb\u884c\u4f38\u7f29\u3002</p> <pre><code>$ kubectl scale vmpool vm-pool-cirros --replicas 5\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachinePool/#virtualmachinepool-virtualmachine","title":"\u4ece VirtualMachinePool \u4e2d\u5220\u9664 VirtualMachine","text":"<p>\u4ece <code>VirtualMachinePool</code> \u4e2d\u5220\u9664 <code>VirtualMachine</code>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u9700\u8981\u4ece\u865a\u62df\u673a\u4e2d\u5220\u9664<code>ownerReferences</code>\u3002 \u8fd9\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528 <code>kubectl edit</code> \u6216 <code>kubectl patch</code> \u6765\u5b9e\u73b0\u3002 \u4f7f\u7528 <code>kubectl</code> \u8865\u4e01\uff0c\u5982\u4e0b\uff1a</p> <pre><code>kubectl patch vm vm-pool-cirros-0 --type merge --patch '{\"metadata\":{\"ownerReferences\":null}}'\n</code></pre> <p>Note</p> <p>\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u65b0\u865a\u62df\u673a\u6807\u7b7elabel\u4ee5\u907f\u514d\u5bf9\u9009\u62e9\u5668selector\u4ea7\u751f\u5f71\u54cd\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePool/#hpa","title":"HPA\u4f7f\u7528","text":"<p>HorizontalPodAutoscaler (HPA) \u53ef\u4ee5\u4e0e <code>VirtualMachinePool</code> \u4e00\u8d77\u4f7f\u7528\u3002 \u53ea\u9700\u5728<code>Spec</code>\u4e2d\u5f15\u7528\u5b83\u5373\u53ef\uff1a</p> <pre><code>apiVersion: autoscaling/v1\nkind: HorizontalPodAutoscaler\nmetadata:\ncreationTimestamp: null\nname: vm-pool-cirros\nspec:\nmaxReplicas: 10\nminReplicas: 3\nscaleTargetRef:\napiVersion: pool.kubevirt.io/v1alpha1\nkind: VirtualMachinePool\nname: vm-pool-cirros\ntargetCPUUtilizationPercentage: 50\n</code></pre> <p>\u6216\u8005\u4f7f\u7528 <code>kubectl autoscale</code> \u901a\u8fc7\u547d\u4ee4\u884c\u5b9a\u4e49 HPA\uff1a</p> <pre><code>$ kubectl autoscale vmpool vm-pool-cirros --min=3 --max=10 --cpu-percent=50\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachinePool/#virtualmachinepool_4","title":"\u5c06 VirtualMachinePool \u4f5c\u4e3a\u670d\u52a1\u66b4\u9732","text":"<p><code>VirtualMachinePool</code> \u53ef\u4ee5\u4f5c\u4e3a\u670d\u52a1\u66b4\u9732\u3002 \u5b8c\u6210\u6b64\u64cd\u4f5c\u540e\uff0c\u5c06\u9009\u62e9\u4e00\u4e2a\u865a\u62df\u673a\u526f\u672c\u6765\u5b9e\u9645\u4ea4\u4ed8\u670d\u52a1\u3002</p> <p>\u4f8b\u5982\uff0c\u5c06 <code>SSH</code> \u7aef\u53e3 (22) \u66b4\u9732\u4e3a <code>ClusterIP</code> \u670d\u52a1\uff1a</p> vm-pool-cirros-ssh.yaml<pre><code>apiVersion: v1\nkind: Service\nmetadata:\nname: vm-pool-cirros-ssh\nspec:\ntype: ClusterIP\nselector:\nkubevirt.io/vmpool: vm-pool-cirros\nports:\n- protocol: TCP\nport: 2222\ntargetPort: 22\n</code></pre> <p>\u5c06\u6b64\u6e05\u5355\u4fdd\u5b58\u5230 <code>vm-pool-cirros-ssh.yaml</code> \u5e76\u5c06\u5176\u63d0\u4ea4\u5230 Kubernetes \u5c06\u521b\u5efa\u4fa6\u542c\u7aef\u53e3 2222 \u5e76\u8f6c\u53d1\u5230\u7aef\u53e3 22 \u7684 <code>ClusterIP</code> \u670d\u52a1\u3002</p> <p>\u6709\u5173\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u670d\u52a1\u5bf9\u8c61\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePool/#_1","title":"\u6301\u4e45\u5316\u5b58\u50a8","text":"<p>\u5728<code>spec.virtualMachineTemplate.spec</code>\u4e2d\u4f7f\u7528<code>DataVolumeTemplates</code>\u5c06\u5bfc\u81f4\u4e3aVMPool\u4e2d\u7684\u6bcf\u4e2aVM\u521b\u5efa\u552f\u4e00\u7684\u6301\u4e45\u5b58\u50a8\u3002 \u5f53\u4ece<code>spec.virtualMachineTemplate.spec.dataVolumeTemplates</code> \u521b\u5efaVM \u65f6\uff0c<code>DataVolumeTemplate</code> \u540d\u79f0\u5c06\u9644\u52a0 VM \u7684\u987a\u5e8f\u540e\u7f00\u3002 \u8fd9\u4f7f\u5f97\u6bcf\u4e2a\u865a\u62df\u673a\u6210\u4e3a\u5b8c\u5168\u72ec\u7279\u7684\u6709\u72b6\u6001\u5de5\u4f5c\u8d1f\u8f7d\u3002</p>"},{"location":"kubeVirt/resource/virtualMachinePreference/","title":"vmPreference\u8d44\u6e90","text":"<p>kubeVirt \u8fd8\u63d0\u4f9b\u4e86\u4e24\u4e2a\u57fa\u4e8e\u504f\u597d\u7684 CRD\uff0c\u540c\u6837\u662f\u96c6\u7fa4\u8303\u56f4\u7684 <code>VirtualMachineClusterPreference</code> \u548c\u5177\u4f53\u547d\u540d\u7a7a\u95f4\u4e0b\u7684 <code>VirtualMachinePreference</code>\u3002 \u8fd9\u4e9b CRD \u5c01\u88c5\u4e86\u8fd0\u884c\u7ed9\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\u6240\u9700\u7684 VirtualMachine \u7684\u4efb\u4f55\u5269\u4f59\u5c5e\u6027\u7684\u9996\u9009\u503c\uff0c\u8fd9\u4e5f\u662f\u901a\u8fc7\u5171\u4eab <code>VirtualMachinePreferenceSpec</code> \u5b9e\u73b0\u7684\u3002</p> <p>\u4f8b\u5b50</p> <pre><code>apiVersion: instancetype.kubevirt.io/v1beta1\nkind: VirtualMachinePreference\nmetadata:\nname: example-preference\nspec:\ndevices:\npreferredDiskBus: virtio\npreferredInterfaceModel: virtio\n</code></pre> <p>\u4e0eInstancetypes\u4e0d\u540c\uff0c\u9996\u9009\u9879\u4ec5\u4ee3\u8868\u9996\u9009\u503c\uff0c\u56e0\u6b64\u5b83\u4eec\u53ef\u4ee5\u88ab\u7528\u6237\u63d0\u4f9b\u7684 <code>VirtualMachine</code> \u4e2d\u7684\u503c\u8986\u76d6\u3002</p> <p>\u5728\u4e0b\u9762\u6240\u793a\u7684\u793a\u4f8b\u4e2d\uff0c\u7528\u6237\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5e26\u6709\u5df2\u5728 <code>DiskTarget</code> \u4e2d\u5b9a\u4e49\u7684\u78c1\u76d8\u603b\u7ebf\u7684 <code>VirtualMachine</code>\uff0c\u5e76\u4e14\u8fd8\u4f7f\u7528 <code>DevicePreference</code> \u548c <code>PreferredDiskBus</code> \u9009\u62e9\u4e86\u4e00\u7ec4\u9996\u9009\u9879\uff0c\u56e0\u6b64\u4f7f\u7528\u7528\u6237\u5728 <code>VirtualMachine</code> \u548c <code>DiskTarget</code> \u4e2d\u7684\u539f\u59cb\u9009\u62e9\uff1a</p> vmPref.yaml<pre><code>---\napiVersion: instancetype.kubevirt.io/v1beta1\nkind: VirtualMachinePreference\nmetadata:\nname: example-preference-disk-virtio\nspec:\ndevices:\npreferredDiskBus: virtio\n---\napiVersion: kubevirt.io/v1\nkind: VirtualMachine\nmetadata:\nname: example-preference-user-override\nspec:\npreference:\nkind: VirtualMachinePreference\nname: example-preference-disk-virtio\nrunning: false\ntemplate:\nspec:\ndomain:\nmemory:\nguest: 128Mi\ndevices:\ndisks:\n- disk:\nbus: sata\nname: containerdisk\n- disk: {}\nname: cloudinitdisk\nresources: {}\nterminationGracePeriodSeconds: 0\nvolumes:\n- containerDisk:\nimage: registry:5000/kubevirt/cirros-container-disk-demo:devel\nname: containerdisk\n- cloudInitNoCloud:\nuserData: |\n#!/bin/sh\necho 'printed from cloud-init userdata'\nname: cloudinitdisk\n</code></pre> <p>\u5bf9\u4e0a\u8ff0\u6e05\u5355\u5bf9\u8c61\u8fdb\u884c\u7f16\u6392\uff0c\u5e76\u542f\u52a8VM\uff0c</p> <pre><code>$ kubectl apply -f vmiPref.yaml\nvirtualmachinepreference.instancetype.kubevirt.io/example-preference-disk-virtio created\nvirtualmachine.kubevirt.io/example-preference-user-override configured\n\n$ virtctl start example-preference-user-override\nVM example-preference-user-override was scheduled to start\n\n# We can see the original request from the user within the VirtualMachine lists `containerdisk` with a `SATA` bus\n$ kubectl get vms/example-preference-user-override -o json | jq .spec.template.spec.domain.devices.disks\n[\n{\n\"disk\": {\n\"bus\": \"sata\"\n},\n    \"name\": \"containerdisk\"\n},\n  {\n\"disk\": {},\n    \"name\": \"cloudinitdisk\"\n}\n]\n# This is still the case in the VirtualMachineInstance with the remaining disk using the `preferredDiskBus` from the preference of `virtio`\n$ kubectl get vmis/example-preference-user-override -o json | jq .spec.domain.devices.disks\n[\n{\n\"disk\": {\n\"bus\": \"sata\"\n},\n    \"name\": \"containerdisk\"\n},\n  {\n\"disk\": {\n\"bus\": \"virtio\"\n},\n    \"name\": \"cloudinitdisk\"\n}\n]\n</code></pre>"},{"location":"kubeVirt/resource/virtualMachineRestore/","title":"VirtualMachineRestore","text":"<p>\u60a8\u53ef\u4ee5\u4f7f\u7528\u865a\u62df\u673a\u5feb\u7167\u5c06\u73b0\u6709\u865a\u62df\u673a\uff08VM\uff09\u6062\u590d\u5230\u4ee5\u524d\u7684\u914d\u7f6e\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineRestore/#_1","title":"\u6062\u590d\u6d41\u7a0b","text":"<p>\u521b\u5efa\u4e00\u4e2a YAML \u6587\u4ef6\u6765\u5b9a\u4e49 <code>VirtualMachineRestore</code> \u5bf9\u8c61\uff0c\u5b83\u6307\u5b9a\u60a8\u8981\u6062\u590d\u7684\u865a\u62df\u673a\u7684\u540d\u79f0\u4ee5\u53ca\u8981\u7528\u4f5c\u6e90\u7684\u5feb\u7167\u540d\u79f0\u3002\u4f8b\u5982:</p> my-vmrestore.yaml<pre><code>apiVersion: snapshot.kubevirt.io/v1alpha1\nkind: VirtualMachineRestore\nmetadata:\nname: my-vmrestore # (1)\nspec:\ntarget:\napiGroup: kubevirt.io\nkind: VirtualMachine\nname: my-vm # (2)\nvirtualMachineSnapshotName: my-vmsnapshot # (3)\n</code></pre> <ol> <li>\u65b0 <code>VirtualMachineRestore</code> \u5bf9\u8c61\u7684\u540d\u79f0\u3002</li> <li>\u8981\u6062\u590d\u7684\u76ee\u6807\u865a\u62df\u673a\u7684\u540d\u79f0\u3002</li> <li>\u4f5c\u4e3a\u6e90\u7684 <code>VirtualMachineSnapshot</code> \u5bf9\u8c61\u7684\u540d\u79f0\u3002</li> </ol> <p>\u7136\u540e\u521b\u5efa <code>VirtualMachineRestore</code> \u8d44\u6e90\u3002\u5feb\u7167\u63a7\u5236\u5668\u66f4\u65b0\u4e86 <code>VirtualMachineRestore</code> \u5bf9\u8c61\u7684 <code>status</code> \u5b57\u6bb5\uff0c\u5e76\u5c06\u73b0\u6709\u865a\u62df\u673a\u914d\u7f6e\u66ff\u6362\u4e3a\u5feb\u7167\u5185\u5bb9\u3002</p> <pre><code>kubectl create -f my-vmrestore.yaml\n</code></pre> <p>\u9a8c\u8bc1\u865a\u62df\u673a\u662f\u5426\u5df2\u6062\u590d\u5230\u5feb\u7167\u4ee3\u8868\u7684\u4ee5\u524d\u7684\u72b6\u6001\u3002<code>complete</code> \u6807\u5fd7\u9700\u8981\u88ab\u8bbe\u7f6e\u4e3a <code>true</code>\u3002</p> <pre><code>kubectl get vmrestore my-vmrestore\n</code></pre> <p>\u8f93\u51fa\u793a\u4f8b\uff1a <pre><code>apiVersion: snapshot.kubevirt.io/v1alpha1\nkind: VirtualMachineRestore\nmetadata:\ncreationTimestamp: \"2020-09-30T14:46:27Z\"\ngeneration: 5\nname: my-vmrestore\nnamespace: default\nownerReferences:\n- apiVersion: kubevirt.io/v1alpha3\n  blockOwnerDeletion: true\ncontroller: true\nkind: VirtualMachine\n  name: my-vm\n  uid: 355897f3-73a0-4ec4-83d3-3c2df9486f4f\n  resourceVersion: \"5512\"\nselfLink: /apis/snapshot.kubevirt.io/v1alpha1/namespaces/default/virtualmachinerestores/my-vmrestore\n  uid: 71c679a8-136e-46b0-b9b5-f57175a6a041\n  spec:\n    target:\n      apiGroup: kubevirt.io\n      kind: VirtualMachine\n      name: my-vm\n  virtualMachineSnapshotName: my-vmsnapshot\n  status:\n  complete: true # (1)\nconditions:\n  - lastProbeTime: null\n  lastTransitionTime: \"2020-09-30T14:46:28Z\"\nreason: Operation complete\nstatus: \"False\" # (2)\ntype: Progressing\n  - lastProbeTime: null\n  lastTransitionTime: \"2020-09-30T14:46:28Z\"\nreason: Operation complete\nstatus: \"True\" # (3)\ntype: Ready\n  deletedDataVolumes:\n  - test-dv1\n  restoreTime: \"2020-09-30T14:46:28Z\"\nrestores:\n  - dataVolumeName: restore-71c679a8-136e-46b0-b9b5-f57175a6a041-datavolumedisk1\n  persistentVolumeClaim: restore-71c679a8-136e-46b0-b9b5-f57175a6a041-datavolumedisk1\n  volumeName: datavolumedisk1\n  volumeSnapshotName: vmsnapshot-28eedf08-5d6a-42c1-969c-2eda58e2a78d-volume-datavolumedisk1\n</code></pre></p> <ol> <li>\u6307\u5b9a\u5c06\u865a\u62df\u673a\u6062\u590d\u5230\u5feb\u7167\u4ee3\u8868\u7684\u72b6\u6001\u7684\u8fdb\u7a0b\u662f\u5426\u5df2\u5b8c\u6210\u3002</li> <li><code>Progressing</code> \u6761\u4ef6\u7684 <code>status</code> \u5b57\u6bb5\u6307\u5b9a VM \u662f\u5426\u4ecd\u7136\u88ab\u6062\u590d\u3002</li> <li><code>Ready</code> \u6761\u4ef6\u7684 <code>status</code> \u5b57\u6bb5\u6307\u5b9a VM \u6062\u590d\u8fc7\u7a0b\u662f\u5426\u5b8c\u6210\u3002</li> </ol>"},{"location":"kubeVirt/resource/virtualMachineSnapshot/","title":"VirtualMachineSnapshot","text":""},{"location":"kubeVirt/resource/virtualMachineSnapshot/#_1","title":"\u5173\u4e8e\u865a\u62df\u673a\u5feb\u7167","text":"<p>\u865a\u62df\u673a\u5feb\u7167</p> <p>\u5feb\u7167\u4ee3\u8868\u865a\u62df\u673a\uff08VM\uff09\u5728\u7279\u5b9a\u65f6\u95f4\u70b9\u7684\u72b6\u6001\u548c\u6570\u636e\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5feb\u7167\u5c06\u73b0\u6709\u865a\u62df\u673a\u6062\u590d\u5230\u4ee5\u524d\u7684\u72b6\u6001\uff08\u7531\u5feb\u7167\u4ee3\u8868\uff09\u8fdb\u884c\u5907\u4efd\u548c\u6062\u590d\uff0c\u6216\u8005\u5feb\u901f\u56de\u6eda\u5230\u4ee5\u524d\u7684\u5f00\u53d1\u7248\u672c\u3002</p> <p>\u4ece\u5173\u95ed\uff08\u505c\u6b62\u72b6\u6001\uff09\u7684\u865a\u62df\u673a\u521b\u5efa\u79bb\u7ebf\u865a\u62df\u673a\u5feb\u7167\u3002\u5feb\u7167\u5b58\u50a8\u9644\u52a0\u5230\u865a\u62df\u673a\u7684\u6bcf\u4e2a Container Storage Interface\uff08CSI\uff09\u5377\u7684\u526f\u672c\u4ee5\u53ca\u865a\u62df\u673a\u89c4\u683c\u548c\u5143\u6570\u636e\u7684\u526f\u672c\u3002\u521b\u5efa\u540e\u65e0\u6cd5\u66f4\u6539\u5feb\u7167\u3002</p> <p>\u901a\u8fc7\u79bb\u7ebf\u865a\u62df\u673a\u5feb\u7167\u529f\u80fd\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u548c\u5e94\u7528\u7a0b\u5e8f\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\uff1a</p> <ul> <li>\u521b\u5efa\u65b0\u5feb\u7167</li> <li>\u5217\u51fa\u9644\u52a0\u5230\u7279\u5b9a\u865a\u62df\u673a\u7684\u6240\u6709\u5feb\u7167</li> <li>\u4ece\u5feb\u7167\u6062\u590d\u865a\u62df\u673a</li> <li>\u5220\u9664\u73b0\u6709\u865a\u62df\u673a\u5feb\u7167</li> </ul> <p>\u60a8\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a <code>VirtualMachineSnapshot</code> \u5bf9\u8c61\u6765\u4e3a\u79bb\u7ebf\u865a\u62df\u673a\u521b\u5efa\u865a\u62df\u673a\u5feb\u7167\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineSnapshot/#crd","title":"\u865a\u62df\u673a\u5feb\u7167CRD","text":"<p>VM \u5feb\u7167\u529f\u80fd\u5f15\u5165\u4e86\u4e09\u4e2a\u65b0\u7684 API \u5bf9\u8c61\uff0c\u5b9a\u4e49\u4e3a CRD\uff0c\u7528\u4e8e\u7ba1\u7406\u5feb\u7167\uff1a</p> \u8d44\u6e90\u5bf9\u8c61 \u63cf\u8ff0 <code>VirtualMachineSnapshot</code> \u4ee3\u8868\u521b\u5efa\u5feb\u7167\u7684\u7528\u6237\u8bf7\u6c42\u3002\u5b83\u5305\u542b\u6709\u5173\u865a\u62df\u673a\u5f53\u524d\u72b6\u6001\u7684\u4fe1\u606f\u3002 <code>VirtualMachineSnapshotContent</code> \u4ee3\u8868\u96c6\u7fa4\u4e2d\u7f6e\u5907\u7684\u8d44\u6e90\uff08\u5feb\u7167\uff09\u3002\u5b83\u7531\u865a\u62df\u673a\u5feb\u7167\u63a7\u5236\u5668\u521b\u5efa\uff0c\u5176\u4e2d\u5305\u542b\u6062\u590d\u865a\u62df\u673a\u6240\u9700\u7684\u6240\u6709\u8d44\u6e90\u7684\u5f15\u7528\u3002 <code>VirtualMachineRestore</code> \u4ee3\u8868\u4ece\u5feb\u7167\u4e2d\u6062\u590d\u865a\u62df\u673a\u7684\u7528\u6237\u8bf7\u6c42\u3002 <p>VM \u5feb\u7167\u63a7\u5236\u5668\u4f1a\u628a\u4e00\u4e2a <code>VirtualMachineSnapshotContent</code> \u5bf9\u8c61\u4e0e\u521b\u5efa\u5b83\u7684 <code>VirtualMachineSnapshotContent</code> \u5bf9\u8c61\u7ed1\u5b9a\uff0c\u5e76\u5177\u6709\u4e00\u5bf9\u4e00\u7684\u6620\u5c04\u3002</p>"},{"location":"kubeVirt/resource/virtualMachineSnapshot/#_2","title":"\u5148\u51b3\u6761\u4ef6","text":"<p>\u5148\u51b3\u6761\u4ef6</p> <ul> <li>\u786e\u4fdd\u6301\u4e45\u6027\u5377\u58f0\u660e\uff08PVC\uff09\u4f4d\u4e8e\u652f\u6301 Container Storage Interface\uff08CSI\uff09\u5377\u5feb\u7167\u7684\u5b58\u50a8\u7c7b\u4e2d\u3002</li> <li>\u5173\u95ed\u60a8\u8981\u4e3a\u5176\u521b\u5efa\u5feb\u7167\u7684\u865a\u62df\u673a\u3002</li> </ul>"},{"location":"kubeVirt/resource/virtualMachineSnapshot/#_3","title":"\u521b\u5efa\u6d41\u7a0b","text":"<p>\u521b\u5efa\u4e00\u4e2a YAML \u6587\u4ef6\u6765\u5b9a\u4e49 <code>VirtualMachineSnapshot</code> \u5bf9\u8c61\uff0c\u4ee5\u6307\u5b9a\u65b0 <code>VirtualMachineSnapshot</code> \u7684\u540d\u79f0\u548c\u6e90\u865a\u62df\u673a\u7684\u540d\u79f0\u3002 \u4f8b\u5982\uff1a</p> my-vmsnapshot.yaml<pre><code>apiVersion: snapshot.kubevirt.io/v1alpha1\nkind: VirtualMachineSnapshot\nmetadata:\nname: my-vmsnapshot # (1)\nspec:\nsource:\napiGroup: kubevirt.io\nkind: VirtualMachine\nname: my-vm # (2)\n</code></pre> <ol> <li>\u65b0\u7684 <code>VirtualMachineSnapshot</code> \u5bf9\u8c61\u7684\u540d\u79f0\u3002</li> <li>\u6e90\u865a\u62df\u673a\u7684\u540d\u79f0\u3002</li> </ol> <p>\u521b\u5efa <code>VirtualMachineSnapshot</code> \u8d44\u6e90\u3002\u5feb\u7167\u63a7\u5236\u5668\u4f1a\u521b\u5efa\u4e00\u4e2a <code>VirtualMachineSnapshotContent</code> \u5bf9\u8c61\uff0c\u5c06\u5176\u7ed1\u5b9a\u5230 <code>VirtualMachineSnapshot</code> \u5e76\u66f4\u65b0 <code>VirtualMachineSnapshot</code> \u5bf9\u8c61\u7684 <code>status</code> \u548c <code>readyToUse</code> \u5b57\u6bb5\u3002</p> <pre><code>kubectl create -f my-vmsnapshot.yaml\n</code></pre> <p>\u9a8c\u8bc1 <code>VirtualMachineSnapshot</code> \u5bf9\u8c61\u662f\u5426\u5df2\u521b\u5efa\u5e76\u7ed1\u5b9a\u5230 <code>VirtualMachineSnapshotContent</code>\u3002<code>readyToUse</code> \u6807\u5fd7\u5fc5\u987b\u8bbe\u4e3a <code>true</code>\u3002</p> <pre><code>kubectl describe vmsnapshot my-vmsnapshot\n</code></pre> <p>\u8f93\u51fa\u793a\u4f8b:</p> <pre><code>apiVersion: snapshot.kubevirt.io/v1alpha1\nkind: VirtualMachineSnapshot\nmetadata:\ncreationTimestamp: \"2020-09-30T14:41:51Z\"\nfinalizers:\n- snapshot.kubevirt.io/vmsnapshot-protection\ngeneration: 5\nname: mysnap\nnamespace: default\nresourceVersion: \"3897\"\nselfLink: /apis/snapshot.kubevirt.io/v1alpha1/namespaces/default/virtualmachinesnapshots/my-vmsnapshot\nuid: 28eedf08-5d6a-42c1-969c-2eda58e2a78d\nspec:\nsource:\napiGroup: kubevirt.io\nkind: VirtualMachine\nname: my-vm\nstatus:\nconditions:\n  - lastProbeTime: null\n  lastTransitionTime: \"2020-09-30T14:42:03Z\"\nreason: Operation complete\nstatus: \"False\" # (1)\ntype: Progressing\n  - lastProbeTime: null\n  lastTransitionTime: \"2020-09-30T14:42:03Z\"\nreason: Operation complete\nstatus: \"True\" # (2)\ntype: Ready\ncreationTime: \"2020-09-30T14:42:03Z\"\nreadyToUse: true # (3)\nsourceUID: 355897f3-73a0-4ec4-83d3-3c2df9486f4f\nvirtualMachineSnapshotContentName: vmsnapshot-content-28eedf08-5d6a-42c1-969c-2eda58e2a78d # (4)\n</code></pre> <ol> <li><code>Progressing</code> \u7684 <code>status</code> \u5b57\u6bb5\u6307\u5b9a\u5feb\u7167\u662f\u5426\u4ecd\u7136\u5728\u521b\u5efa\u3002</li> <li><code>Ready</code> \u6761\u4ef6\u7684 <code>status</code> \u5b57\u6bb5\u6307\u5b9a\u5feb\u7167\u521b\u5efa\u8fc7\u7a0b\u662f\u5426\u5b8c\u6210\u3002</li> <li>\u6307\u5b9a\u5feb\u7167\u662f\u5426\u51c6\u5907\u5c31\u7eea\u53ef\u7528\u88ab\u4f7f\u7528\u3002</li> <li>\u6307\u5b9a\u5feb\u7167\u88ab\u7ed1\u5b9a\u5230\u5feb\u7167\u63a7\u5236\u5668\u521b\u5efa\u7684 <code>VirtualMachineSnapshotContent</code> \u5bf9\u8c61\u3002</li> </ol> <p>\u68c0\u67e5 <code>VirtualMachineSnapshotContent</code> \u8d44\u6e90\u7684 <code>spec:volumeBackups</code> \u5c5e\u6027\uff0c\u4ee5\u9a8c\u8bc1\u5feb\u7167\u4e2d\u5305\u542b\u4e86\u9884\u671f\u7684 PVC\u3002</p>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-handler/","title":"virt-handler","text":"<p><code>virt-handler</code> \u7684\u5165\u53e3\u5728\u4e0b\u9762\u8fd9\u4e2a\u51fd\u6570 <pre><code>src\\kubevirt.io\\kubevirt\\cmd\\virt-handler\\virt-handler.go:main()\n</code></pre></p> <p>\u8fd9\u4e2a\u51fd\u6570\u505a\u7684\u4e8b\u60c5\u6709\uff1a</p> <ol> <li>\u521d\u59cb\u5316\u4e00\u4e2a <code>virtHandlerApp</code> \uff0c\u6ce8\u518c <code>flag</code> \u53c2\u6570\uff0c\u4f7f virt-handler \u53ef\u6267\u884c\u6587\u4ef6\u53ef\u4ee5\u63a5\u6536\u53c2\u6570\u8f93\u5165</li> <li>\u521d\u59cb\u5316\u65e5\u5fd7\u8bb0\u5f55\u5668\uff0c\u65e5\u5fd7\u7ea7\u522b\u4e3a <code>INFO</code></li> <li>\u8fd0\u884c app</li> </ol> <p><code>Run</code> \u51fd\u6570\u7684\u4e3b\u8981\u903b\u8f91\u5c31\u662f\u5b9e\u4f8b\u5316\u4e00\u4e2a VirtualMachineController \u5bf9\u8c61</p> <pre><code>vmController := virthandler.NewController(\nrecorder,\napp.virtCli,\napp.HostOverride,\napp.PodIpAddress,\napp.VirtShareDir,\napp.VirtPrivateDir,\nvmiSourceInformer,\nvmiTargetInformer,\ndomainSharedInformer,\ngracefulShutdownInformer,\nint(app.WatchdogTimeoutDuration.Seconds()),\napp.MaxDevices,\napp.clusterConfig,\npodIsolationDetector,\nmigrationProxy,\n)\ngo vmController.Run(10, stop)\n</code></pre> <p>\u5e76\u4e14\u542f\u7528 10 \u4e2a\u534f\u7a0b\uff0c\u4f7f\u7528 <code>wait.Until</code> \u6bcf\u95f4\u9694 1 \u79d2\u8fd0\u884c\u7a0b\u5e8f</p> <pre><code>func (c *VirtualMachineController) Run(threadiness int, stopCh chan struct{}) {\n...more\nfor i := 0; i &lt; threadiness; i++ {\ngo wait.Until(c.runWorker, time.Second, stopCh)\n}\n...more\n</code></pre> <p>\u68c0\u67e5 <code>VirtualMachineController.Queue</code> \u662f\u5426\u6709\u9700\u8981\u5904\u7406\u7684 vmi \u5b9e\u4f8b\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u9000\u51fa\u7b49\u5f85\u4e0b\u4e00\u5faa\u73af\uff0c\u5982\u679c\u6709\uff0c\u5c31\u6267\u884c <code>c.execut</code> \u53bb\u6267\u884c\u76f8\u5e94\u903b\u8f91\uff0c\u5305\u62ec <code>virt-launcher</code> Pod \u7684\u7f51\u7edc\u51c6\u5907\uff0c\u865a\u62df\u673a\u7684\u542f\u52a8\u3002</p> <pre><code>func (c *VirtualMachineController) Execute() bool {\nkey, quit := c.Queue.Get()\nif quit {\nreturn false\n}\ndefer c.Queue.Done(key)\nif err := c.execute(key.(string)); err != nil {\nlog.Log.Reason(err).Infof(\"re-enqueuing VirtualMachineInstance %v\", key)\nc.Queue.AddRateLimited(key)\n} else {\nlog.Log.V(4).Infof(\"processed VirtualMachineInstance %v\", key)\nc.Queue.Forget(key)\n}\nreturn true\n}\n</code></pre> <p>\u90a3\u4e48 <code>VirtualMachineController.Queue</code> \u7684\u961f\u5217\u6d88\u606f\u662f\u54ea\u91cc\u585e\u5165\u7684\u5462\uff1f</p> <p>\u8fd9\u5c31\u4e0d\u5f97\u4e0d\u8bf4\u5230 K8S \u7684 Informer \u673a\u5236\u5177\u4f53\u53ef\u53c2\u8003\u8fd9\u7bc7\u6587\u7ae0\uff1ahttps://www.kubernetes.org.cn/2693.html</p> <p>\u5176\u5b9e\u65e9\u5728\u5b9e\u4f8b\u5316 VirtualMachineController \u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u5c31\u6709\u4f20\u5165\u51e0\u4e2a Informer \u5bf9\u8c61\uff0c\u5305\u62ec\uff1a</p> <ul> <li><code>vmiSourceInformer</code>\uff1a\u6709\u65b0\u589e\u5230\u8be5\u8282\u70b9\u7684\u865a\u62df\u673a</li> <li><code>vmiTargetInformer</code>\uff1a\u6709\u8fc1\u79fb\u5230\u8be5\u53f0\u8282\u70b9\u7684\u865a\u62df\u673a</li> <li><code>domainSharedInformer</code> \uff1a\u76d1\u542c\u672c\u8282\u70b9\u4e0a\u7684 virt-launcher \u4e2d\u7684 domain \u5b9e\u4f8b</li> </ul> <p>\u5728 NewController \u91cc\u4f1a\u7ed9\u8fd9\u4e9b Informer \u5bf9\u8c61\u6ce8\u518c\u56de\u8c03\u51fd\u6570\uff0c\u5f53 K8S \u4e0a\u6709\u8be5 Host \u7684 vmi \u5bf9\u8c61\u53d1\u751f\u65b0\u589e\u3001\u9500\u6bc1\u3001\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u89e6\u53d1\u76f8\u5e94\u7684\u51fd\u6570</p> <pre><code>vmiSourceInformer.AddEventHandler(cache.ResourceEventHandlerFuncs{\nAddFunc:    c.addFunc,\nDeleteFunc: c.deleteFunc,\nUpdateFunc: c.updateFunc,\n})\n</code></pre> <p>\u4ee5\u65b0\u589e\u4e3a\u4f8b\uff0c\u6765\u770b\u4e00\u4e0b <code>addFunc</code> \u7684\u4ee3\u7801</p> <p>\u5728\u51fd\u6570\u4e2d\u4f1a\u5c06 vmi \u7684 key \uff08\u7c7b\u4f3c <code>default/vm-name</code>\uff09\u585e\u5165\u5230 <code>VirtualMachineController.Queue</code> \u961f\u5217\u4e2d\u3002</p> <pre><code>func (d *VirtualMachineController) addFunc(obj interface{}) {\nkey, err := controller.KeyFunc(obj)\nif err == nil {\nd.Queue.Add(key)\n}\n}\n</code></pre> <p>\u8bf4\u5b8c\u6d88\u606f\u961f\u5217\u7684\u4e8b\u60c5\uff0c\u518d\u56de\u5230\u4e3b\u4f53\u903b\u8f91\uff0c\u7ee7\u7eed\u5f80\u4e0b\u770b <code>c.execute</code>\u7684\u4ee3\u7801</p> <p>\u5728\u8fd9\u4e2a\u51fd\u6570\u91cc\uff0c\u4f1a\u62ff\u7740 key \u53bb\u4e00\u4e2a\u4e00\u4e2a\u67e5\u770b\u662f\u5728 <code>vmiSourceInformer</code> \u3001<code>vmiTargetInformer</code> \u548c <code>domainInformer</code> \u7684\u54ea\u4e00\u4e2a\u7f13\u5b58\u4e2d\uff0c\u5e76\u83b7\u5f97\u5177\u4f53\u7684 vmi \u5bf9\u8c61\u4fe1\u606f\u3002</p> <p>\u7136\u540e\u518d\u5224\u65ad\u8be5 vmi \u662f\u8fc1\u79fb\u7684\u6e90\u8fd8\u662f\u76ee\u6807\uff0c\u5982\u679c\u90fd\u4e0d\u662f\uff0c\u5c31\u8bf4\u660e\u662f\u65b0\u673a\u521b\u5efa\uff0c\u5e94\u8be5\u8d70 <code>defaultExecute</code></p> <pre><code>    if vmiExists &amp;&amp; d.isPreMigrationTarget(vmi) {\n// 1. PRE-MIGRATION TARGET PREPARATION PATH\n//\n// If this node is the target of the vmi's migration, take\n// a different execute path. The target execute path prepares\n// the local environment for the migration, but does not\n// start the VMI\nreturn d.migrationTargetExecute(vmi, vmiExists, domainExists)\n} else if vmiExists &amp;&amp; d.isOrphanedMigrationSource(vmi) {\n// 3. POST-MIGRATION SOURCE CLEANUP\n//\n// After a migration, the migrated domain still exists in the old\n// source's domain cache. Ensure that any node that isn't currently\n// the target or owner of the VMI handles deleting the domain locally.\nreturn d.migrationOrphanedSourceNodeExecute(vmi, domainExists)\n}\nreturn d.defaultExecute(key,\nvmi,\nvmiExists,\ndomain,\ndomainExists)\n</code></pre> <p><code>defaultExecute</code> \u51fd\u6570\u4e2d\uff0c\u4f1a\u6839\u636e vmi \u548c domain \u7684\u771f\u5b9e\u72b6\u6001\u7684\u4e0d\u540c\uff0c\u9009\u62e9\u4e0d\u540c\u7684\u5904\u7406\u65b9\u6848\uff0c\u7531\u4e8e\u573a\u666f\u8fc7\u591a\uff0c\u8fd9\u91cc\u4e0d\u4e00\u4e00\u89e3\u91ca\uff0c\u8981\u7528\u7684\u65f6\u5019\u6765\u8fd9\u8fb9\u770b\u4ee3\u7801\u5373\u53ef\uff0c\u73b0\u5728\u4e3b\u8981\u7406\u6e05\u865a\u62df\u673a\u521b\u5efa\u6d41\u7a0b\uff0c\u4e5f\u5373 vmi \u7684\u72b6\u6001\u4e3a <code>Scheduled</code> \u6216\u8005 <code>Failed</code> \u7684\u65f6\u5019\uff0c\u800c domain \u5176\u5b9e\u8fd8\u6ca1\u521b\u5efa\uff0c<code>shouldUpdate</code> \u5c31\u4f1a\u662f <code>true</code>\uff0c\u56e0\u4e3a\u5c31\u4f1a\u8d70 <code>processVmUpdate</code> \u5c31\u521b\u5efa\u865a\u62df\u673a\uff0c\u6765\u4fdd\u6301 vmi \u548c domain \u7684\u72b6\u6001\u4e00\u81f4\u3002</p> <pre><code>// Determine if an active (or about to be active) VirtualMachineInstance should be updated.\nif vmiExists &amp;&amp; !vmi.IsFinal() {\n// requiring the phase of the domain and VirtualMachineInstance to be in sync is an\n// optimization that prevents unnecessary re-processing VMIs during the start flow.\nphase, err := d.calculateVmPhaseForStatusReason(domain, vmi)\nif err != nil {\nreturn err\n}\nif vmi.Status.Phase == phase {\nshouldUpdate = true\n}\n}\nswitch {\ncase forceIgnoreSync:\nlog.Log.Object(vmi).V(3).Info(\"No update processing required: forced ignore\")\ncase shouldShutdown:\nlog.Log.Object(vmi).V(3).Info(\"Processing shutdown.\")\nsyncErr = d.processVmShutdown(vmi, domain)\ncase shouldDelete:\nlog.Log.Object(vmi).V(3).Info(\"Processing deletion.\")\nsyncErr = d.processVmDelete(vmi)\ncase shouldCleanUp:\nlog.Log.Object(vmi).V(3).Info(\"Processing local ephemeral data cleanup for shutdown domain.\")\nsyncErr = d.processVmCleanup(vmi)\ncase shouldUpdate:\nlog.Log.Object(vmi).V(3).Info(\"Processing vmi update\")\nsyncErr = d.processVmUpdate(vmi)\ndefault:\nlog.Log.Object(vmi).V(3).Info(\"No update processing required\")\n}\n</code></pre> <p>\u5728 <code>processVmUpdate</code> \u51fd\u6570\uff0c\u8fd8\u4f1a\u7ee7\u7eed\u5224\u65ad\u8be5\u865a\u62df\u673a\u662f\u8fc1\u79fb\u6d41\u7a0b\u8fd8\u662f\u65b0\u5efa\u6d41\u7a0b</p> <pre><code>func (d *VirtualMachineController) processVmUpdate(vmi *v1.VirtualMachineInstance) error {\n...more\nif d.isPreMigrationTarget(vmi) {\nreturn d.vmUpdateHelperMigrationTarget(vmi)\n} else if d.isMigrationSource(vmi) {\nreturn d.vmUpdateHelperMigrationSource(vmi)\n} else {\nreturn d.vmUpdateHelperDefault(vmi)\n}\n}\n</code></pre> <p>\u7ee7\u7eed\u5f80 <code>vmUpdateHelperDefault</code> \u51fd\u6570\u67e5\u770b\u5177\u4f53\u7684\u903b\u8f91\uff1a</p> <ul> <li>\u51c6\u5907 virt-launcher \u7684\u7f51\u7edc\u73af\u5883\uff1a<code>d.setPodNetworkPhase1(vmi)</code></li> <li>\u53d1\u9001 gRPC \u6d88\u606f\u7ed9 virt-launcher\uff1a<code>client.SyncVirtualMachine(vmi, options)</code></li> </ul>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-launcher/","title":"virt-launcher","text":""},{"location":"kubeVirt/sourceCodeAnalysis/virt-launcher/#virt-launcher-virtwrap","title":"virt-launcher virtwrap \u51c6\u5907\u865a\u62df\u673a\u7684\u7f51\u7edc","text":"<p>virt-launcher pod \u548c \u865a\u62df\u673a\u4e00\u4e00\u5bf9\u5e94\uff0c\u5728pod\u4e2d\u8fd0\u884c\u4e00\u53f0\u865a\u62df\u673a\uff0c virt-launcher pod\u8d1f\u8d23\u63d0\u4f9b\u8fd0\u884c\u865a\u62df\u673a\u5fc5\u8981\u7684\u7ec4\u4ef6\u3002\u672c\u7bc7\u6587\u7ae0\u662f\u4ecb\u7ecd\u7f51\u7edc\u76f8\u5173\u7684\u7ec4\u4ef6\u3002\u4e0b\u56fe\u662fKubeVirt\u7684\u7f51\u7edc\u3002</p> <p></p> <p>\u89e3\u91ca</p> <ul> <li>\u4e09\u4e2a\u5305\u542b\u5173\u7cfb\u7684\u5b9e\u7ebf\u6846\uff0c\u4ece\u5916\u5230\u91cc\u5206\u522b\u662f\uff1aKubernetes\u5de5\u4f5c\u8282\u70b9\u3001\u5de5\u4f5c\u8282\u70b9\u4e0a\u7684POD\u3001POD\u91cc\u8fd0\u884c\u7684VM\u865a\u62df\u673a</li> <li>\u4e09\u4e2a\u5e76\u5217\u7684\u865a\u7ebf\u6846\uff0c\u4ece\u4e0b\u5230\u4e0a\u5206\u522b\u662f\uff1aKubernetes\u7f51\u7edc\uff08Kubernetes CNI\u8d1f\u8d23\u914d\u7f6e\uff09\uff0c<code>libvirt</code>\u7f51\u7edc\uff0c\u865a\u62df\u673a\u7f51\u7edc\u3002\u672c\u7bc7\u4e0d\u6d89\u53caKubernetes\u7f51\u7edc\uff0c\u53ea\u6d89\u53ca<code>libvirt</code>\u7f51\u7edc\uff0c\u865a\u62df\u673a\u7f51\u7edc</li> </ul>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/","title":"\u542f\u52a8\u6d41\u7a0b","text":""},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#_1","title":"\u901a\u7528\u6e90\u7801\u5165\u53e3","text":"<p>\u5728\u6b64\u4e4b\u524d\uff0c\u9700\u8981\u77e5\u9053\u6240\u6709\u7684 kubevirt \u7ec4\u4ef6\u90fd\u662f\u4ece <code>cmd/virt-*</code> \u5f00\u59cb\u7684</p> <p></p>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#_2","title":"\u542f\u52a8\u6d41\u7a0b","text":"<p>\u9996\u5148\u8c03\u7528\u5165\u53e3\u51fd\u6570 kubevirt/cmd/virt-controller/virt-controller.go<pre><code>import (\n_ \"kubevirt.io/kubevirt/pkg/monitoring/client/prometheus\"    // import for prometheus metrics\n_ \"kubevirt.io/kubevirt/pkg/monitoring/reflector/prometheus\" // import for prometheus metrics\n_ \"kubevirt.io/kubevirt/pkg/monitoring/workqueue/prometheus\" // import for prometheus metrics\n\"kubevirt.io/kubevirt/pkg/virt-controller/watch\"\n)\nfunc main() {\nwatch.Execute()\n}\n</code></pre> \u76f4\u63a5\u8c03\u7528<code>kubevirt/pkg/virt-controller/watch/application.go</code>\u4e2d\u7684<code>Execute</code>\u51fd\u6570\u542f\u52a8virt-controller\u3002\u4e0b\u9762\u4e3b\u8981\u5206\u6790<code>Execute</code>\u51fd\u6570\u4e2d\u7684\u5185\u5bb9\u3002</p>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#leaderelectionconfiguration","title":"\u83b7\u53d6<code>leaderElectionConfiguration</code>","text":"<p>\u83b7\u53d6<code>leaderElectionConfiguration</code>, \u53ef\u901a\u8fc7<code>leaderelectionconfig</code>\u5305\u83b7\u53d6\uff1a kubevirt/pkg/virt-controller/watch/application.go<pre><code>app.LeaderElection = leaderelectionconfig.DefaultLeaderElectionConfiguration()\n</code></pre></p>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#kubevirtclient","title":"\u83b7\u53d6<code>KubevirtClient</code>","text":"kubevirt/pkg/virt-controller/watch/application.go<pre><code>clientConfig, err := kubecli.GetKubevirtClientConfig()\nif err != nil {\npanic(err)\n}\nclientConfig.RateLimiter = app.reloadableRateLimiter\napp.clientSet, err = kubecli.GetKubevirtClientFromRESTConfig(clientConfig)\nif err != nil {\ngolog.Fatal(err)\n}\n</code></pre>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#informerfactory","title":"\u83b7\u53d6<code>informerFactory</code>","text":"<p>\u83b7\u53d6<code>informerFactory</code>\uff0c\u5e76\u5b9e\u4f8b\u5316\u4e00\u7cfb\u5217\u5177\u4f53\u8d44\u6e90\u7c7b\u578b\u7684Informer\uff0c\u4f8b\u5982<code>crdInformer</code>\u3001<code>kubeVirtInformer</code>\u3001<code>vmiInformer</code>\u3001<code>kvPodInformer</code>\u3001<code>nodeInformer</code>\u3001<code>vmInformer</code>\u3001<code>migrationInformer</code>\u7b49 kubevirt/pkg/virt-controller/watch/application.go<pre><code>app.informerFactory = controller.NewKubeInformerFactory(app.restClient, app.clientSet, nil, app.kubevirtNamespace)\n// \u5b9e\u4f8b\u5316\u5404\u8d44\u6e90\u7c7b\u578b\u7684informer\napp.crdInformer = app.informerFactory.CRD()\napp.kubeVirtInformer = app.informerFactory.KubeVirt()\n// ...\n</code></pre></p>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#controller","title":"\u521d\u59cb\u5316\u4e00\u7cfb\u5217controller","text":"<p>\u8fd9\u4e00\u7cfb\u5217controller\u4e3b\u8981\u5305\u62ec<code>vmiController</code>\u3001<code>nodeController</code>\u3001<code>migrationController</code>\u3001<code>vmController</code>\u3001<code>evacuationController</code>\u3001<code>snapshotController</code>\u3001<code>restoreController</code>\u3001<code>replicaSetController</code>\u3001<code>disruptionBudgetController</code> kubevirt/pkg/virt-controller/watch/application.go<pre><code>// \u521d\u59cb\u5316\u4e00\u7cfb\u5217controller\napp.initCommon()\napp.initReplicaSet()\napp.initPool()\napp.initVirtualMachines()\napp.initDisruptionBudgetController()\napp.initEvacuationController()\napp.initSnapshotController()\napp.initRestoreController()\napp.initExportController()\napp.initWorkloadUpdaterController()\napp.initCloneController()\n</code></pre></p>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#leaderelectorvirt-controller","title":"\u901a\u8fc7<code>leaderElector</code>\u542f\u52a8virt-controller","text":"<p>\u901a\u8fc7<code>leaderElector</code>\u6765\u542f\u52a8virt-controller\uff0c\u5e76\u5728<code>leaderElector</code>\u4e2d\u542f\u52a8\u5404\u4e2acontroller\u7684<code>Run</code>\u51fd\u6570\u3002</p> kubevirt/pkg/virt-controller/watch/application.go<pre><code>func (vca *VirtControllerApp) Run() {\nlogger := log.Log\npromCertManager := bootstrap.NewFileCertificateManager(vca.promCertFilePath, vca.promKeyFilePath)\ngo promCertManager.Start()\npromTLSConfig := kvtls.SetupPromTLS(promCertManager, vca.clusterConfig)\ngo func() {\nhttpLogger := logger.With(\"service\", \"http\")\n_ = httpLogger.Level(log.INFO).Log(\"action\", \"listening\", \"interface\", vca.BindAddress, \"port\", vca.Port)\nhttp.Handle(\"/metrics\", promhttp.Handler())\nserver := http.Server{\nAddr:      vca.Address(),\nHandler:   http.DefaultServeMux,\nTLSConfig: promTLSConfig,\n}\nif err := server.ListenAndServeTLS(\"\", \"\"); err != nil {\ngolog.Fatal(err)\n}\n}()\nif err := vca.setupLeaderElector(); err != nil {\ngolog.Fatal(err)\n}\nreadyGauge.Set(1)\nvca.leaderElector.Run(vca.ctx)\nreadyGauge.Set(0)\npanic(\"unreachable\")\n}\n</code></pre>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/virt-controller-start/#virt-controller","title":"virt-controller\u5206\u6790","text":"<ul> <li>vmController \u2013 \u6df1\u5165\u5256\u6790<code>vmController</code>\u5b9e\u73b0\u8fc7\u7a0b</li> <li>vmiController \u2013 \u6df1\u5165\u5256\u6790<code>vmiController</code>\u5b9e\u73b0\u8fc7\u7a0b</li> </ul>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/vm-controller/","title":"vmController","text":""},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/vm-controller/#vmcontroller","title":"vmController","text":"<p>\u4ee3\u7801\u4f4d\u4e8e<code>kubevirt/pkg/virt-controller/watch/vm.go</code>\u6587\u4ef6\u4e2d\u3002</p> <ol> <li>\u76d1\u542c<code>VM</code>\u5bf9\u8c61\u3001<code>VMI</code>\u5bf9\u8c61\u3001<code>DataVolume</code>\u5bf9\u8c61\u5e76\u6dfb\u52a0\u5bf9\u5e94\u7684<code>EventHandler</code>\u3002 </li> <li>\u6536\u5230Event\u4e8b\u4ef6\u4e4b\u540e\u52a0\u5165\u5230workQueue\u3002<ul> <li><code>VM</code>\u5bf9\u8c61\u7684Event\u4e8b\u4ef6\u76f4\u63a5\u52a0\u5165workQueue\u3002</li> <li><code>VMI</code>\u5bf9\u8c61\u7684Event\u4e8b\u4ef6\u5148\u5224\u65ad\u662f\u5426\u7531VM\u5bf9\u8c61\u6240\u63a7\u5236\uff0c\u5982\u679c\u662f\u5219\u5c06\u8be5VM\u5bf9\u8c61\u52a0\u5165workQueue\uff0c\u5426\u5219\u627e\u5230\u5339\u914d\u7684VM\uff0c\u5c06\u5339\u914d\u7684VM\u52a0\u5165\u5230workQueue\uff0c\u5c1d\u8bd5\u6536\u517b\u5b64\u513f\u7684VMI\u5bf9\u8c61\u3002</li> <li><code>DataVolume</code>\u5bf9\u8c61\u7684Event\u4e8b\u4ef6\u5148\u5224\u65ad\u662f\u5426\u7531VM\u5bf9\u8c61\u6240\u63a7\u5236\uff0c\u5982\u679c\u662f\u5219\u5c06\u8be5VM\u5bf9\u8c61\u52a0\u5165workQueue\uff0c\u5426\u5219\u4e0d\u5904\u7406\u3002</li> </ul> </li> <li>\u901a\u8fc7<code>Run()</code>-&gt;<code>runWorker()</code>-&gt;<code>Execute()</code>-&gt;<code>execute()</code>\uff0c\u4eceworkQueue\u4e2d\u53d6\u51fa\u5bf9\u8c61\u7684key\uff0c\u7136\u540e\u5728<code>execute</code>\u4e2d\u5904\u7406\u3002</li> <li><code>execute()</code> \u51fd\u6570\u7684\u5904\u7406\u903b\u8f91<ul> <li>\u6839\u636ekey\uff0c\u4eceInformer\u7684\u672c\u5730\u7f13\u5b58\u4e2d\u83b7\u53d6VM\u5bf9\u8c61\u3002</li> <li>\u521b\u5efa<code>VirtualMachineControllerRefManager</code>\u3002</li> <li>\u6839\u636ekey\uff0c\u4eceInformer\u7684\u672c\u5730\u7f13\u5b58\u4e2d\u83b7\u53d6VMI\u5bf9\u8c61</li> <li>\u5982\u679c\u83b7\u53d6VMI\u5bf9\u8c61\u6210\u529f\uff0c\u5219<code>VirtualMachineControllerRefManager</code>\u5c1d\u8bd5\u6536\u517b\u6216\u9057\u5f03VMI\u3002</li> <li>\u6839\u636e<code>Spec.DataVolumeTemplates</code>,\u4eceInformer\u7684\u672c\u5730\u7f13\u5b58\u4e2d\u83b7\u53d6dataVolumes\u3002</li> <li>\u68c0\u67e5<code>dataVolumes</code>\u662f\u5426\u5df2\u7ecf<code>ready</code>\uff0c\u82e5\u5df2\u7ecf<code>ready</code>\u5219\u8c03\u7528<code>startStop()</code><ul> <li><code>RunStrategy==Always</code>:\u865a\u62df\u673a\u5b9e\u4f8bVMI\u5e94\u8be5\u603b\u662f\u5b58\u5728\uff0c\u5982\u679c\u865a\u62df\u673a\u5b9e\u4f8bVMI crash\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u865a\u62df\u673a\u3002\u7b49\u540c\u4e8e<code>spec.running:true</code>\u3002</li> <li><code>RunStrategy==RerunOnFailure</code>:\u5982\u679c\u865a\u62df\u673a\u5b9e\u4f8bVMI\u8fd0\u884c\u5931\u8d25\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u865a\u62df\u673a\u3002\u5982\u679c\u662f\u7531\u5ba2\u6237\u7aef\u4e3b\u52a8\u6210\u529f\u5173\u95ed\uff0c\u5219\u4e0d\u4f1a\u518d\u91cd\u65b0\u521b\u5efa\u3002</li> <li><code>RunStrategy==Manual</code>:\u865a\u62df\u673a\u5b9e\u4f8bVMI\u8fd0\u884c\u72b6\u51b5\u901a\u8fc7start/stop/restart\u624b\u5de5\u6765\u63a7\u5236\u3002</li> <li><code>RunStrategy==Halted</code>:\u865a\u62df\u673a\u5b9e\u4f8bVMI\u5e94\u8be5\u603b\u662f\u6302\u8d77\u3002\u7b49\u540c\u4e8e<code>spec.running:false</code>\u3002</li> </ul> </li> <li>\u66f4\u65b0VMStatus<ul> <li>\u4fee\u6539<code>vm.Status.Created</code>\uff0c<code>vm.Status.Ready</code></li> <li>\u4fee\u6539<code>vm.Status.StateChangeRequests</code></li> <li>\u4fee\u6539<code>vm.Status.Conditions</code></li> <li>\u66f4\u65b0VMStatus</li> </ul> </li> </ul> </li> </ol>"},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/vmi-controller/","title":"vmiController","text":""},{"location":"kubeVirt/sourceCodeAnalysis/virt-controller/vmi-controller/#vmicontroller","title":"vmiController","text":"<p>\u4ee3\u7801\u4f4d\u4e8e<code>kubevirt/pkg/virt-controller/watch/vmi.go</code>\u6587\u4ef6\u4e2d\u3002</p> <ol> <li>\u76d1\u542c<code>VMI</code>\u5bf9\u8c61\u3001<code>Pod</code>\u5bf9\u8c61\u3001<code>DataVolume</code>\u5bf9\u8c61\u5e76\u6dfb\u52a0\u5bf9\u5e94\u7684EventHandler\u3002</li> <li>\u6536\u5230Event\u4e8b\u4ef6\u4e4b\u540e\u52a0\u5165\u5230workQueue\u3002<ul> <li><code>VMI</code>\u5bf9\u8c61\u7684Event\u4e8b\u4ef6\u76f4\u63a5\u52a0\u5165workQueue\u3002</li> <li><code>Pod</code>\u5bf9\u8c61\u7684Event\u4e8b\u4ef6\u5148\u5224\u65ad\u662f\u5426\u7531VM\u5bf9\u8c61\u6240\u63a7\u5236\uff0c\u5982\u679c\u662f\u5219\u5c06\u8be5VM\u5bf9\u8c61\u52a0\u5165workQueue\uff0c\u5426\u5219\u4e0d\u5904\u7406\u3002</li> <li><code>DataVolume</code>\u5bf9\u8c61\u7684Event\u4e8b\u4ef6\uff0c\u6839\u636e<code>DataVolume</code>\u7684Namespace\u548cName\u83b7\u53d6\u5339\u914d\u7684vmis\uff0c\u7136\u540e\u5c06vmis\u5bf9\u8c61\u4f9d\u6b21\u52a0\u5165\u5230workQueue\u3002</li> </ul> </li> <li>\u901a\u8fc7<code>Run()</code>-&gt;<code>runWorker()</code>-&gt;<code>Execute()</code>-&gt;<code>execute()</code>\uff0c\u4eceworkQueue\u4e2d\u53d6\u51fa\u5bf9\u8c61\u7684key\uff0c\u7136\u540e\u5728<code>execute</code>\u4e2d\u5904\u7406\u3002</li> <li><code>execute()</code> \u51fd\u6570\u7684\u5904\u7406\u903b\u8f91<ul> <li>\u6839\u636ekey\uff0c\u4eceInformer\u7684\u672c\u5730\u7f13\u5b58\u4e2d\u83b7\u53d6VM\u5bf9\u8c61\u3002</li> <li>\u83b7\u53d6\u548c\u5f53\u524dvmi\u5bf9\u8c61\u5339\u914d\u7684Pod\u3002</li> <li>\u6839\u636e<code>vmi.Spec.Volumes</code>\uff0c\u83b7\u53d6\u5339\u914d\u7684<code>DataVolumes</code>\u5bf9\u8c61\u3002</li> <li>\u540c\u6b65sync\uff0c\u82e5Pod\u4e0d\u5b58\u5728\uff0c\u5219\u521b\u5efalanucher\u6240\u5728\u7684Pod\u3002</li> <li>\u66f4\u65b0vmi\u5bf9\u8c61\u7684status\u3002</li> </ul> </li> </ol>"},{"location":"monitor/","title":"\u76d1\u63a7","text":""},{"location":"network/","title":"\u7f51\u7edc\u6982\u89c8","text":""},{"location":"network/#_2","title":"\u7814\u53d1\u80cc\u666f","text":"<p>\u968f\u7740\u4e91\u539f\u751f\u6280\u672f\u4ece\u5e94\u7528\u4fa7\u5411\u6570\u636e\u4e2d\u5fc3\u548c\u57fa\u7840\u8bbe\u65bd\u4e0b\u6c89\uff0c\u8d8a\u6765\u8d8a\u591a\u7684\u4f01\u4e1a\u5f00\u59cb\u4f7f\u7528 Kubernetes \u548c KubeVirt \u6765\u8fd0\u884c\u865a\u62df\u5316\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5b9e\u73b0\u5728\u7edf\u4e00\u7684\u63a7\u5236\u5e73\u9762\u540c\u65f6\u7ba1\u7406\u865a\u62df\u673a\u548c\u5bb9\u5668\u3002\u7136\u800c\u4e00\u65b9\u9762\u865a\u62df\u673a\u7684\u4f7f\u7528\u573a\u666f\u548c\u4e60\u60ef\u90fd\u548c\u5bb9\u5668\u6709\u7740\u663e\u8457\u7684\u5dee\u5f02\uff0c\u53e6\u4e00\u65b9\u9762\u65b0\u5174\u7684\u5bb9\u5668\u7f51\u7edc\u5e76\u6ca1\u6709\u4e13\u95e8\u5bf9\u865a\u62df\u5316\u573a\u666f\u8fdb\u884c\u8bbe\u8ba1\uff0c\u529f\u80fd\u7684\u5b8c\u5907\u6027\u548c\u6027\u80fd\u90fd\u4e0e\u4f20\u7edf\u865a\u62df\u5316\u7f51\u7edc\u5b58\u5728\u8f83\u5927\u5dee\u8ddd\u3002\u7f51\u7edc\u95ee\u9898\u6210\u4e3a\u4e86\u4e91\u539f\u751f\u865a\u62df\u5316\u7684\u74f6\u9888\u6240\u5728\u3002</p>"},{"location":"network/#_3","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"network/#_4","title":"\u7f51\u7edc\u5f00\u53d1\u7b56\u7565","text":"<p>Kube-OVN \u7531\u4e8e\u4f7f\u7528\u4e86\u5728\u4f20\u7edf\u865a\u62df\u5316\u7f51\u7edc\u4e2d\u5f97\u5230\u5e7f\u6cdb\u4f7f\u7528\u7684 OVN/OVS\uff0c\u5728\u5f00\u6e90\u540e\u5f97\u5230\u4e86\u5f88\u591a KubeVirt \u7528\u6237\u7684\u5173\u6ce8\uff0c\u4e00\u90e8\u5206\u524d\u6cbf\u7684 KubeVirt \u7528\u6237\u6839\u636e\u81ea\u5df1\u7684\u4f7f\u7528\u573a\u666f\u8fdb\u4e00\u6b65\u5b8c\u5584\u4e86 Kube-OVN \u7684\u7f51\u7edc\u80fd\u529b\u3002</p> <p>Kube-OVN</p><p>Kube-OVN</p> <p>Multus \u591a\u7f51\u5361\u63d2\u4ef6</p><p>Multus CNI Plugin</p> <p>DPDK</p><p>DPDK</p> <p>SR-IOV</p><p>SR-IOV</p>"},{"location":"network/dpdk/","title":"DPDK\u6982\u89c8","text":""},{"location":"network/kube-ovn/","title":"Kube-OVN \u6982\u89c8","text":"<p>Kube-OVN \u662f\u4e00\u6b3e CNCF \u65d7\u4e0b\u7684\u4f01\u4e1a\u7ea7\u4e91\u539f\u751f\u7f51\u7edc\u7f16\u6392\u7cfb\u7edf\uff0c\u5c06 SDN \u7684\u80fd\u529b\u548c\u4e91\u539f\u751f\u7ed3\u5408\uff0c \u63d0\u4f9b\u4e30\u5bcc\u7684\u529f\u80fd\uff0c\u6781\u81f4\u7684\u6027\u80fd\u4ee5\u53ca\u826f\u597d\u7684\u53ef\u8fd0\u7ef4\u6027\u3002</p>"},{"location":"network/kube-ovn/#_1","title":"\u6280\u672f\u67b6\u6784","text":"<p>\u603b\u4f53\u6765\u770b\uff0cKube-OVN \u4f5c\u4e3a Kubernetes \u548c OVN \u4e4b\u95f4\u7684\u4e00\u4e2a\u6865\u6881\uff0c\u5c06\u6210\u719f\u7684 SDN \u548c\u4e91\u539f\u751f\u76f8\u7ed3\u5408\u3002 \u8fd9\u610f\u5473\u7740 Kube-OVN \u4e0d\u4ec5\u901a\u8fc7 OVN \u5b9e\u73b0\u4e86 Kubernetes \u4e0b\u7684\u7f51\u7edc\u89c4\u8303\uff0c\u4f8b\u5982 CNI\uff0cService \u548c Networkpolicy\uff0c\u8fd8\u5c06\u5927\u91cf\u7684 SDN \u9886\u57df\u80fd\u529b\u5e26\u5165\u4e91\u539f\u751f\uff0c\u4f8b\u5982\u903b\u8f91\u4ea4\u6362\u673a\uff0c\u903b\u8f91\u8def\u7531\u5668\uff0cVPC\uff0c\u7f51\u5173\uff0cQoS\uff0cACL \u548c\u6d41\u91cf\u955c\u50cf\u3002</p> <p>\u540c\u65f6 Kube-OVN \u8fd8\u4fdd\u6301\u4e86\u826f\u597d\u7684\u5f00\u653e\u6027\u53ef\u4ee5\u548c\u8bf8\u591a\u6280\u672f\u65b9\u6848\u96c6\u6210\uff0c\u4f8b\u5982 Cilium\uff0cSubmariner\uff0cPrometheus\uff0cKubeVirt \u7b49\u7b49\u3002</p> <p>\u7ec4\u4ef6\u4ecb\u7ecd</p><p>Component Introduction</p> <p>Underlay\u6d41\u91cf\u62d3\u6251</p><p>Underlay Traffic Topology</p>"},{"location":"network/kube-ovn/#_2","title":"\u4e30\u5bcc\u7684\u529f\u80fd","text":"<p>\u5982\u679c\u4f60\u6000\u5ff5 SDN \u9886\u57df\u4e30\u5bcc\u7684\u7f51\u7edc\u80fd\u529b\u5374\u5728\u4e91\u539f\u751f\u9886\u57df\u82e6\u82e6\u8ffd\u5bfb\u800c\u4e0d\u5f97\uff0c\u90a3\u4e48 Kube-OVN \u5c06\u662f\u4f60\u7684\u6700\u4f73\u9009\u62e9\u3002</p> <p>\u501f\u52a9 OVS/OVN \u5728 SDN \u9886\u57df\u6210\u719f\u7684\u80fd\u529b\uff0cKube-OVN \u5c06\u7f51\u7edc\u865a\u62df\u5316\u7684\u4e30\u5bcc\u529f\u80fd\u5e26\u5165\u4e91\u539f\u751f\u9886\u57df\u3002\u76ee\u524d\u5df2\u652f\u6301\u5b50\u7f51\u7ba1\u7406\uff0c \u9759\u6001 IP \u5206\u914d\uff0c\u5206\u5e03\u5f0f/\u96c6\u4e2d\u5f0f\u7f51\u5173\uff0cUnderlay/Overlay \u6df7\u5408\u7f51\u7edc\uff0c VPC \u591a\u79df\u6237\u7f51\u7edc\uff0c\u8de8\u96c6\u7fa4\u4e92\u8054\u7f51\u7edc\uff0cQoS \u7ba1\u7406\uff0c \u591a\u7f51\u5361\u7ba1\u7406\uff0cACL \u7f51\u7edc\u63a7\u5236\uff0c\u6d41\u91cf\u955c\u50cf\uff0cARM \u652f\u6301\uff0c Windows \u652f\u6301\u7b49\u8bf8\u591a\u529f\u80fd\u3002</p> <p>\u90e8\u5206\u7279\u6027\u529f\u80fd\u5982\u4e0b:</p> <p>\u9759\u6001IP\u5730\u5740</p><p>Fixed IP Address</p> <p>\u5b50\u7f51\u914d\u7f6e</p><p>Subnet</p> <p>IP\u6c60\u914d\u7f6e</p><p>IP Pool</p> <p>VPC\u914d\u7f6e</p><p>VPC</p> <p>VPC QoS\u914d\u7f6e</p><p>VPC QoS</p> <p>VPC\u4e92\u8054</p><p>VPC Peering</p> <p>\u591a\u7f51\u5361\u7ba1\u7406</p><p>Manage Multiple Interface</p> <p>\u591a\u96c6\u7fa4\u4e92\u8054</p><p>Cluster Inter-connection</p> <p>\u5bb9\u5668\u7f51\u7edcQoS\u914d\u7f6e</p><p>Manage QoS</p> <p>LB\u7c7b\u578bService</p><p>LoadBalancer Service</p> <p>EIP\u548cSNAT\u914d\u7f6e</p><p>EIP and SNAT</p> <p>\u5b89\u5168\u7ec4\u914d\u7f6e</p><p>SecurityGroup</p> <p>Underlay\u7f51\u7edc</p><p>Underlay Network</p> <p>VIP\u9884\u7559\u914d\u7f6e</p><p>VIP Reservation</p> <p>DHCP\u914d\u7f6e</p><p>DHCP</p>"},{"location":"network/kube-ovn/#_3","title":"\u6781\u81f4\u7684\u6027\u80fd","text":"<p>\u5982\u679c\u4f60\u62c5\u5fc3\u5bb9\u5668\u7f51\u7edc\u4f1a\u5e26\u6765\u989d\u5916\u7684\u6027\u80fd\u635f\u8017\uff0c\u90a3\u4e48\u6765\u770b\u4e00\u4e0b Kube-OVN \u662f\u5982\u4f55\u6781\u81f4\u7684\u4f18\u5316\u6027\u80fd\u3002</p> <p>\u5728\u6570\u636e\u5e73\u9762\uff0c\u901a\u8fc7\u4e00\u7cfb\u5217\u5bf9\u6d41\u8868\u548c\u5185\u6838\u7684\u7cbe\u5fc3\u4f18\u5316\uff0c\u5e76\u501f\u52a9 eBPF\u3001DPDK\u3001\u667a\u80fd\u7f51\u5361\u5378\u8f7d\u7b49\u65b0\u5174\u6280\u672f\uff0c Kube-OVN \u53ef\u4ee5\u5728\u5ef6\u8fdf\u548c\u541e\u5410\u91cf\u7b49\u65b9\u9762\u7684\u6307\u6807\u8fbe\u5230\u8fd1\u4f3c\u6216\u8d85\u51fa\u5bbf\u4e3b\u673a\u7f51\u7edc\u6027\u80fd\u7684\u6c34\u5e73\u3002\u5728\u63a7\u5236\u5e73\u9762\uff0c\u901a\u8fc7\u5bf9 OVN \u4e0a\u6e38\u6d41\u8868\u7684\u88c1\u526a\uff0c \u5404\u79cd\u7f13\u5b58\u6280\u672f\u7684\u4f7f\u7528\u548c\u8c03\u4f18\uff0cKube-OVN \u53ef\u4ee5\u652f\u6301\u5927\u89c4\u6a21\u4e0a\u5343\u8282\u70b9\u548c\u4e0a\u4e07 Pod \u7684\u96c6\u7fa4\u3002</p> <p>\u6b64\u5916 Kube-OVN \u8fd8\u5728\u4e0d\u65ad\u4f18\u5316 CPU \u548c\u5185\u5b58\u7b49\u8d44\u6e90\u7684\u4f7f\u7528\u91cf\uff0c\u4ee5\u9002\u5e94\u8fb9\u7f18\u7b49\u8d44\u6e90\u6709\u9650\u573a\u666f\u3002</p>"},{"location":"network/kube-ovn/#_4","title":"\u826f\u597d\u7684\u53ef\u8fd0\u7ef4\u6027","text":"<p>\u5982\u679c\u4f60\u5bf9\u5bb9\u5668\u7f51\u7edc\u7684\u8fd0\u7ef4\u5fc3\u5b58\u5fe7\u8651\uff0cKube-OVN \u5185\u7f6e\u4e86\u5927\u91cf\u7684\u5de5\u5177\u6765\u5e2e\u52a9\u4f60\u7b80\u5316\u8fd0\u7ef4\u64cd\u4f5c\u3002</p> <p>Kube-OVN \u63d0\u4f9b\u4e86\u4e00\u952e\u5b89\u88c5\u811a\u672c\uff0c\u5e2e\u52a9\u7528\u6237\u8fc5\u901f\u642d\u5efa\u751f\u4ea7\u5c31\u7eea\u7684\u5bb9\u5668\u7f51\u7edc\u3002\u540c\u65f6\u5185\u7f6e\u7684\u4e30\u5bcc\u7684\u76d1\u63a7\u6307\u6807\u548c Grafana \u9762\u677f\uff0c \u53ef\u5e2e\u52a9\u7528\u6237\u5efa\u7acb\u5b8c\u5584\u7684\u76d1\u63a7\u4f53\u7cfb\u3002\u5f3a\u5927\u7684\u547d\u4ee4\u884c\u5de5\u5177\u53ef\u4ee5\u7b80\u5316\u7528\u6237\u7684\u65e5\u5e38\u8fd0\u7ef4\u64cd\u4f5c\u3002\u901a\u8fc7\u548c Cilium \u7ed3\u5408\uff0c\u5229\u7528 eBPF \u80fd\u529b\u7528\u6237\u53ef\u4ee5 \u589e\u5f3a\u5bf9\u7f51\u7edc\u7684\u53ef\u89c2\u6d4b\u6027\u3002 \u6b64\u5916\u6d41\u91cf\u955c\u50cf\u7684\u80fd\u529b\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u81ea\u5b9a\u4e49\u6d41\u91cf\u76d1\u63a7\uff0c\u5e76\u548c\u4f20\u7edf\u7684 NPM \u7cfb\u7edf\u5bf9\u63a5\u3002</p> <p>OVN\u6d41\u91cf\u955c\u50cf</p><p>OVN Remote Port Mirroring</p>"},{"location":"network/kube-ovn/architecture/quick-learn/","title":"\u7ec4\u4ef6\u4ecb\u7ecd","text":"<p>Kube-OVN \u7684\u7ec4\u4ef6\u53ef\u4ee5\u5927\u81f4\u5206\u4e3a\u4e09\u7c7b\uff1a</p> <ul> <li>\u4e0a\u6e38 OVN/OVS \u7ec4\u4ef6\u3002</li> <li>\u6838\u5fc3\u63a7\u5236\u5668\u548c Agent\u3002</li> <li>\u76d1\u63a7\uff0c\u8fd0\u7ef4\u5de5\u5177\u548c\u6269\u5c55\u7ec4\u4ef6\u3002</li> </ul> <p></p>"},{"location":"network/kube-ovn/architecture/quick-learn/#ovnovs","title":"\u4e0a\u6e38 OVN/OVS \u7ec4\u4ef6","text":"<p>\u8be5\u7c7b\u578b\u7ec4\u4ef6\u6765\u81ea OVN/OVS \u793e\u533a\uff0c\u5e76\u9488\u5bf9 Kube-OVN \u7684\u4f7f\u7528\u573a\u666f\u505a\u4e86\u7279\u5b9a\u4fee\u6539\u3002 OVN/OVS \u672c\u8eab\u662f\u4e00\u5957\u6210\u719f\u7684\u7ba1\u7406\u865a\u673a\u548c\u5bb9\u5668\u7684 SDN \u7cfb\u7edf\u3002Kube-OVN \u4f7f\u7528 OVN \u7684\u5317\u5411\u63a5\u53e3\u521b\u5efa\u548c\u8c03\u6574\u865a\u62df\u7f51\u7edc\uff0c\u5e76\u5c06\u5176\u4e2d\u7684\u7f51\u7edc\u6982\u5ff5\u6620\u5c04\u5230 Kubernetes \u4e4b\u5185\u3002</p> <p>\u6240\u6709 OVN/OVS \u76f8\u5173\u7ec4\u4ef6\u90fd\u5df2\u6253\u5305\u6210\u5bf9\u5e94\u955c\u50cf\uff0c\u5e76\u53ef\u5728 Kubernetes \u4e2d\u8fd0\u884c\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#ovn-central","title":"ovn-central","text":"<p><code>ovn-central</code> Deployment \u8fd0\u884c OVN \u7684\u7ba1\u7406\u5e73\u9762\u7ec4\u4ef6\uff0c\u5305\u62ec <code>ovn-nb</code>, <code>ovn-sb</code>, \u548c <code>ovn-northd</code>\u3002</p> <p><code>ovn-nb</code>\uff1a \u4fdd\u5b58\u865a\u62df\u7f51\u7edc\u914d\u7f6e\uff0c\u5e76\u63d0\u4f9b API \u8fdb\u884c\u865a\u62df\u7f51\u7edc\u7ba1\u7406\u3002<code>kube-ovn-controller</code> \u5c06\u4f1a\u4e3b\u8981\u548c <code>ovn-nb</code> \u8fdb\u884c\u4ea4\u4e92\u914d\u7f6e\u865a\u62df\u7f51\u7edc\u3002 <code>ovn-sb</code>\uff1a \u4fdd\u5b58\u4ece <code>ovn-nb</code> \u7684\u903b\u8f91\u7f51\u7edc\u751f\u6210\u7684\u903b\u8f91\u6d41\u8868\uff0c\u4ee5\u53ca\u5404\u4e2a\u8282\u70b9\u7684\u5b9e\u9645\u7269\u7406\u7f51\u7edc\u72b6\u6001\u3002 <code>ovn-northd</code>\uff1a\u5c06 <code>ovn-nb</code> \u7684\u865a\u62df\u7f51\u7edc\u7ffb\u8bd1\u6210 <code>ovn-sb</code> \u4e2d\u7684\u903b\u8f91\u6d41\u8868\u3002</p> <p>\u591a\u4e2a <code>ovn-central</code> \u5b9e\u4f8b\u4f1a\u901a\u8fc7 Raft \u534f\u8bae\u540c\u6b65\u6570\u636e\u4fdd\u8bc1\u9ad8\u53ef\u7528\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#ovs-ovn","title":"ovs-ovn","text":"<p><code>ovs-ovn</code> \u4ee5 <code>DaemonSet</code> \u5f62\u5f0f\u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\uff0c\u5728 Pod \u5185\u8fd0\u884c\u4e86 <code>openvswitch</code>, <code>ovsdb</code>, \u548c <code>ovn-controller</code>\u3002\u8fd9\u4e9b\u7ec4\u4ef6\u4f5c\u4e3a <code>ovn-central</code> \u7684 Agent \u5c06\u903b\u8f91\u6d41\u8868\u7ffb\u8bd1\u6210\u771f\u5b9e\u7684\u7f51\u7edc\u914d\u7f6e\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#agent","title":"\u6838\u5fc3\u63a7\u5236\u5668\u548c Agent","text":"<p>\u8be5\u90e8\u5206\u4e3a Kube-OVN \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4f5c\u4e3a OVN \u548c Kubernetes \u4e4b\u95f4\u7684\u4e00\u4e2a\u6865\u6881\uff0c\u5c06\u4e24\u4e2a\u7cfb\u7edf\u6253\u901a\u5e76\u5c06\u7f51\u7edc\u6982\u5ff5\u8fdb\u884c\u76f8\u4e92\u8f6c\u6362\u3002 \u5927\u90e8\u5206\u7684\u6838\u5fc3\u529f\u80fd\u90fd\u5728\u8be5\u90e8\u5206\u7ec4\u4ef6\u4e2d\u5b9e\u73b0\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#kube-ovn-controller","title":"kube-ovn-controller","text":"<p>\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a <code>Deployment</code> \u6267\u884c\u6240\u6709 Kubernetes \u5185\u8d44\u6e90\u5230 OVN \u8d44\u6e90\u7684\u7ffb\u8bd1\u5de5\u4f5c\uff0c\u5176\u4f5c\u7528\u76f8\u5f53\u4e8e\u6574\u4e2a Kube-OVN \u7cfb\u7edf\u7684\u63a7\u5236\u5e73\u9762\u3002 <code>kube-ovn-controller</code> \u76d1\u542c\u4e86\u6240\u6709\u548c\u7f51\u7edc\u529f\u80fd\u76f8\u5173\u8d44\u6e90\u7684\u4e8b\u4ef6\uff0c\u5e76\u6839\u636e\u8d44\u6e90\u53d8\u5316\u60c5\u51b5\u66f4\u65b0 OVN \u5185\u7684\u903b\u8f91\u7f51\u7edc\u3002\u4e3b\u8981\u76d1\u542c\u7684\u8d44\u6e90\u5305\u62ec\uff1a <code>Pod</code>\uff0c<code>Service</code>\uff0c<code>Endpoint</code>\uff0c<code>Node</code>\uff0c<code>NetworkPolicy</code>\uff0c<code>VPC</code>\uff0c<code>Subnet</code>\uff0c<code>Vlan</code>\uff0c<code>ProviderNetwork</code>\u3002</p> <p>\u4ee5 Pod \u4e8b\u4ef6\u4e3a\u4f8b\uff0c <code>kube-ovn-controller</code> \u76d1\u542c\u5230 Pod \u521b\u5efa\u4e8b\u4ef6\u540e\uff0c\u901a\u8fc7\u5185\u7f6e\u7684\u5185\u5b58 IPAM \u529f\u80fd\u5206\u914d\u5730\u5740\uff0c\u5e76\u8c03\u7528 <code>ovn-central</code> \u521b\u5efa \u903b\u8f91\u7aef\u53e3\uff0c\u9759\u6001\u8def\u7531\u548c\u53ef\u80fd\u7684 ACL \u89c4\u5219\u3002\u63a5\u4e0b\u6765 <code>kube-ovn-controller</code> \u5c06\u5206\u914d\u5230\u7684\u5730\u5740\uff0c\u548c\u5b50\u7f51\u4fe1\u606f\u4f8b\u5982 CIDR\uff0c\u7f51\u5173\uff0c\u8def\u7531\u7b49\u4fe1\u606f\u5199\u4f1a\u5230 <code>Pod</code> \u7684 <code>annotation</code> \u4e2d\u3002\u8be5 <code>annotation</code> \u540e\u7eed\u4f1a\u88ab <code>kube-ovn-cni</code> \u8bfb\u53d6\u7528\u6765\u914d\u7f6e\u672c\u5730\u7f51\u7edc\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#kube-ovn-cni","title":"kube-ovn-cni","text":"<p>\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a <code>DaemonSet</code> \u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\uff0c\u5b9e\u73b0 CNI \u63a5\u53e3\uff0c\u5e76\u64cd\u4f5c\u672c\u5730\u7684 OVS \u914d\u7f6e\u5355\u673a\u7f51\u7edc\u3002</p> <p>\u8be5 <code>DaemonSet</code> \u4f1a\u590d\u5236 kube-ovn \u4e8c\u8fdb\u5236\u6587\u4ef6\u5230\u6bcf\u53f0\u673a\u5668\uff0c\u4f5c\u4e3a <code>kubelet</code> \u548c <code>kube-ovn-cni</code> \u4e4b\u95f4\u7684\u4ea4\u4e92\u5de5\u5177\uff0c\u5c06\u76f8\u5e94 CNI \u8bf7\u6c42 \u53d1\u9001\u7ed9 <code>kube-ovn-cni</code> \u6267\u884c\u3002\u8be5\u4e8c\u8fdb\u5236\u6587\u4ef6\u9ed8\u8ba4\u4f1a\u88ab\u590d\u5236\u5230 <code>/opt/cni/bin</code> \u76ee\u5f55\u4e0b\u3002</p> <p><code>kube-ovn-cni</code> \u4f1a\u914d\u7f6e\u5177\u4f53\u7684\u7f51\u7edc\u6765\u6267\u884c\u76f8\u5e94\u6d41\u91cf\u64cd\u4f5c\uff0c\u4e3b\u8981\u5de5\u4f5c\u5305\u62ec\uff1a</p> <ol> <li>\u914d\u7f6e <code>ovn-controller</code> \u548c <code>vswitchd</code>\u3002</li> <li>\u5904\u7406 CNI <code>add/del</code> \u8bf7\u6c42\uff1a<ul> <li>\u521b\u5efa\u5220\u9664 <code>veth</code> \u5e76\u548c OVS \u7aef\u53e3\u7ed1\u5b9a\u3002</li> <li>\u914d\u7f6e OVS \u7aef\u53e3\u4fe1\u606f\u3002</li> <li>\u66f4\u65b0\u5bbf\u4e3b\u673a\u7684 <code>iptables/ipset/route</code> \u7b49\u89c4\u5219\u3002</li> </ul> </li> <li>\u52a8\u6001\u66f4\u65b0\u5bb9\u5668 QoS.</li> <li>\u521b\u5efa\u5e76\u914d\u7f6e <code>ovn0</code> \u7f51\u5361\u8054\u901a\u5bb9\u5668\u7f51\u7edc\u548c\u4e3b\u673a\u7f51\u7edc\u3002</li> <li>\u914d\u7f6e\u4e3b\u673a\u7f51\u5361\u6765\u5b9e\u73b0 <code>Vlan/Underlay/EIP</code> \u7b49\u529f\u80fd\u3002</li> <li>\u52a8\u6001\u914d\u7f6e\u96c6\u7fa4\u4e92\u8054\u7f51\u5173\u3002</li> </ol>"},{"location":"network/kube-ovn/architecture/quick-learn/#_1","title":"\u76d1\u63a7\uff0c\u8fd0\u7ef4\u5de5\u5177\u548c\u6269\u5c55\u7ec4\u4ef6","text":"<p>\u8be5\u90e8\u5206\u7ec4\u4ef6\u4e3b\u8981\u63d0\u4f9b\u76d1\u63a7\uff0c\u8bca\u65ad\uff0c\u8fd0\u7ef4\u64cd\u4f5c\u4ee5\u53ca\u548c\u5916\u90e8\u8fdb\u884c\u5bf9\u63a5\uff0c\u5bf9 Kube-OVN \u7684\u6838\u5fc3\u7f51\u7edc\u80fd\u529b\u8fdb\u884c\u6269\u5c55\uff0c\u5e76\u7b80\u5316\u65e5\u5e38\u8fd0\u7ef4\u64cd\u4f5c\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#kube-ovn-speaker","title":"kube-ovn-speaker","text":"<p>\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u7279\u5b9a\u6807\u7b7e\u7684\u8282\u70b9\u4e0a\uff0c\u5bf9\u5916\u53d1\u5e03\u5bb9\u5668\u7f51\u7edc\u7684\u8def\u7531\uff0c\u4f7f\u5f97\u5916\u90e8\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 Pod IP \u8bbf\u95ee\u5bb9\u5668\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#kube-ovn-pinger","title":"kube-ovn-pinger","text":"<p>\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a DaemonSet \u8fd0\u884c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6536\u96c6 OVS \u8fd0\u884c\u4fe1\u606f\uff0c\u8282\u70b9\u7f51\u7edc\u8d28\u91cf\uff0c\u7f51\u7edc\u5ef6\u8fdf\u7b49\u4fe1\u606f\uff0c\u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\u53ef\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#kube-ovn-monitor","title":"kube-ovn-monitor","text":"<p>\u8be5\u7ec4\u4ef6\u4e3a\u4e00\u4e2a Deployment \u6536\u96c6 OVN \u7684\u8fd0\u884c\u4fe1\u606f\uff0c\u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\u53ef\u53c2\u8003 Kube-OVN \u76d1\u63a7\u6307\u6807\u3002</p>"},{"location":"network/kube-ovn/architecture/quick-learn/#kubectl-ko","title":"kubectl-ko","text":"<p>\u8be5\u7ec4\u4ef6\u4e3a kubectl \u63d2\u4ef6\uff0c\u53ef\u4ee5\u5feb\u901f\u8fd0\u884c\u5e38\u89c1\u8fd0\u7ef4\u64cd\u4f5c\u3002</p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/","title":"Underlay\u6d41\u91cf\u62d3\u6251","text":""},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#_1","title":"\u540c\u8282\u70b9\u540c\u5b50\u7f51","text":"<p>\u5185\u90e8\u903b\u8f91\u4ea4\u6362\u673a\u76f4\u63a5\u4ea4\u6362\u6570\u636e\u5305\uff0c\u4e0d\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\u3002</p> <p></p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#_2","title":"\u8de8\u8282\u70b9\u540c\u5b50\u7f51","text":"<p>\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u4ea4\u6362\u673a\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u8fdb\u884c\u4ea4\u6362\u3002</p> <p></p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#_3","title":"\u540c\u8282\u70b9\u4e0d\u540c\u5b50\u7f51","text":"<p>\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002</p> <p></p> <p>\u6ce8\u610f</p> <p>\u6b64\u5904 <code>br-provider-1</code> \u548c <code>br-provider-2</code> \u53ef\u4ee5\u662f\u540c\u4e00\u4e2a OVS \u7f51\u6865\uff0c\u5373\u591a\u4e2a\u4e0d\u540c\u5b50\u7f51\u53ef\u4ee5\u4f7f\u7528\u540c\u4e00\u4e2a Provider Network\u3002</p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#_4","title":"\u8de8\u8282\u70b9\u4e0d\u540c\u5b50\u7f51","text":"<p>\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002</p> <p></p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#_5","title":"\u8bbf\u95ee\u5916\u90e8","text":"<p>\u6570\u636e\u5305\u7ecf\u7531\u8282\u70b9\u7f51\u5361\u8fdb\u5165\u5916\u90e8\u7f51\u7edc\uff0c\u7531\u5916\u90e8\u4ea4\u6362\u673a\u53ca\u8def\u7531\u5668\u8fdb\u884c\u4ea4\u6362\u548c\u8def\u7531\u8f6c\u53d1\u3002</p> <p></p> <p>\u6ce8\u610f</p> <p>\u8282\u70b9\u4e0e Pod \u4e4b\u95f4\u7684\u901a\u4fe1\u5927\u4f53\u4e0a\u4e5f\u9075\u5faa\u6b64\u903b\u8f91\u3002</p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#vlan-tag","title":"\u65e0 Vlan Tag \u4e0b\u603b\u89c8","text":""},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#vlan","title":"\u591a VLAN \u603b\u89c8","text":""},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#pod-service-ip","title":"Pod \u8bbf\u95ee Service IP","text":"<p>Kube-OVN \u4e3a\u6bcf\u4e2a Kubernetes Service \u5728\u6bcf\u4e2a\u5b50\u7f51\u7684\u903b\u8f91\u4ea4\u6362\u673a\u4e0a\u914d\u7f6e\u4e86\u8d1f\u8f7d\u5747\u8861\u3002 \u5f53 Pod \u901a\u8fc7\u8bbf\u95ee Service IP \u8bbf\u95ee\u5176\u5b83 Pod \u65f6\uff0c\u4f1a\u6784\u9020\u4e00\u4e2a\u76ee\u7684\u5730\u5740\u4e3a Service IP\u3001\u76ee\u7684 MAC \u5730\u5740\u4e3a\u7f51\u5173 MAC \u5730\u5740\u7684\u7f51\u7edc\u5305\u3002 \u7f51\u7edc\u5305\u8fdb\u5165\u903b\u8f91\u4ea4\u6362\u673a\u540e\uff0c\u8d1f\u8f7d\u5747\u8861\u4f1a\u5bf9\u7f51\u7edc\u5305\u8fdb\u884c\u62e6\u622a\u548c DNAT \u5904\u7406\uff0c\u5c06\u76ee\u7684 IP \u548c\u7aef\u53e3\u4fee\u6539\u4e3a Service \u5bf9\u5e94\u7684\u67d0\u4e2a Endpoint \u7684 IP \u548c\u7aef\u53e3\u3002 \u7531\u4e8e\u903b\u8f91\u4ea4\u6362\u673a\u5e76\u672a\u4fee\u6539\u7f51\u7edc\u5305\u7684\u4e8c\u5c42\u76ee\u7684 MAC \u5730\u5740\uff0c\u7f51\u7edc\u5305\u5728\u8fdb\u5165\u5916\u90e8\u4ea4\u6362\u673a\u540e\u4ecd\u7136\u4f1a\u9001\u5230\u5916\u90e8\u7f51\u5173\uff0c\u6b64\u65f6\u9700\u8981\u5916\u90e8\u7f51\u5173\u5bf9\u7f51\u7edc\u5305\u8fdb\u884c\u8f6c\u53d1\u3002</p>"},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#service-pod","title":"Service \u540e\u7aef\u4e3a\u540c\u8282\u70b9\u540c\u5b50\u7f51 Pod","text":""},{"location":"network/kube-ovn/architecture/underlay-traffic-topology/#service-pod_1","title":"Service \u540e\u7aef\u4e3a\u540c\u8282\u70b9\u4e0d\u540c\u5b50\u7f51 Pod","text":""},{"location":"network/kube-ovn/devops/remote-port-mirroring/","title":"OVN\u6d41\u91cf\u955c\u50cf","text":"<p>\u6b64\u529f\u80fd\u53ef\u4ee5\u5c06\u6307\u5b9a Pod\u3001\u6307\u5b9a\u65b9\u5411\u7684\u6d41\u91cf\uff0c\u901a\u8fc7 GRE/ERSPAN \u5c01\u88c5\u540e\uff0c\u4f20\u8f93\u5230\u8fdc\u7aef\u3002</p>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#multus-cni","title":"\u90e8\u7f72 Multus-CNI","text":"<p>\u53c2\u8003 Multus-CNI \u6587\u6863 \u90e8\u7f72 Multus\u3002</p>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#_1","title":"\u521b\u5efa\u9644\u5c5e\u7f51\u7edc","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u5185\u5bb9\u521b\u5efa\u9644\u5c5e\u7f51\u7edc\uff1a</p> <pre><code>apiVersion: \"k8s.cni.cncf.io/v1\"\nkind: NetworkAttachmentDefinition\nmetadata:\nname: attachnet\nnamespace: default\nspec:\nconfig: |\n{\n\"cniVersion\": \"0.3.1\",\n\"type\": \"kube-ovn\",\n\"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\",\n\"provider\": \"attachnet.default.ovn\"\n}\n</code></pre> <p>\u5176\u4e2d <code>provider</code> \u5b57\u6bb5\u683c\u5f0f\u4e3a <code>&lt;NAME&gt;.&lt;NAMESPACE&gt;.ovn</code>\u3002</p>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#underlay","title":"\u521b\u5efa Underlay \u7f51\u7edc","text":"<p>\u955c\u50cf\u6d41\u91cf\u662f\u5c01\u88c5\u540e\u8fdb\u884c\u4f20\u8f93\u7684\uff0c\u56e0\u6b64\u7528\u4e8e\u4f20\u8f93\u7684\u7f51\u7edc\uff0cMTU \u9700\u8981\u5927\u4e8e\u88ab\u955c\u50cf\u7684 LSP/Pod\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 Underlay \u4f5c\u4e3a\u4f20\u8f93\u7f51\u7edc\u3002</p> <p>\u4f7f\u7528\u4ee5\u4e0b\u5185\u5bb9\u521b\u5efa Underlay \u7f51\u7edc\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: ProviderNetwork\nmetadata:\nname: net1\nspec:\ndefaultInterface: eth1\n---\napiVersion: kubeovn.io/v1\nkind: Vlan\nmetadata:\nname: vlan1\nspec:\nid: 0\nprovider: net1\n---\napiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: subnet1\nspec:\nprotocol: IPv4\ncidrBlock: 172.19.0.0/16\nexcludeIps:\n- 172.19.0.2..172.19.0.20\ngateway: 172.19.0.1\nvlan: vlan1\nprovider: attachnet.default.ovn\n</code></pre> <p>\u5176\u4e2d\uff0c\u5b50\u7f51\u7684 <code>provider</code> \u5fc5\u987b\u4e0e\u9644\u5c5e\u7f51\u7edc\u7684 <code>provider</code> \u76f8\u540c\u3002</p>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#pod","title":"\u521b\u5efa\u6d41\u91cf\u63a5\u6536 Pod","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u5185\u5bb9\u521b\u5efa\u7528\u4e8e\u63a5\u6536\u955c\u50cf\u6d41\u91cf\u7684 Pod\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod1\nannotations:\nk8s.v1.cni.cncf.io/networks: default/attachnet\nspec:\ncontainers:\n- name: bash\nimage: docker.io/kubeovn/kube-ovn:v1.12.1\nargs:\n- bash\n- -c\n- sleep infinity\nsecurityContext:\nprivileged: true\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b Pod \u7684 IP \u5730\u5740\uff1a</p> <pre><code>$ kubectl get ips | grep pod1\npod1.default                        10.16.0.12   00:00:00:FF:34:24  kube-ovn-worker  ovn-default\npod1.default.attachnet.default.ovn  172.19.0.21  00:00:00:A0:30:68  kube-ovn-worker  subnet1\n</code></pre> <p>\u8bb0\u4f4f\u7b2c\u4e8c\u7f51\u5361\u7684 IP \u5730\u5740 <code>172.19.0.21</code>\u3002</p>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#ovn","title":"\u521b\u5efa OVN \u6d41\u91cf\u955c\u50cf","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u521b\u5efa OVN \u6d41\u91cf\u955c\u50cf\uff1a</p> <pre><code>kubectl ko nbctl mirror-add mirror1 gre 99 from-lport 172.19.0.21\nkubectl ko nbctl lsp-attach-mirror coredns-787d4945fb-gpnkb.kube-system mirror1\n</code></pre> <p>\u5176\u4e2d <code>coredns-787d4945fb-gpnkb.kube-system</code> \u662f OVN LSP \u7684\u540d\u79f0\uff0c\u683c\u5f0f\u901a\u5e38\u4e3a <code>&lt;POD_NAME&gt;.&lt;POD_NAMESPACE&gt;</code>\u3002</p> <p>\u76f8\u5173\u7684 OVN \u547d\u4ee4\u4f7f\u7528\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>ovn-nbctl mirror-add &lt;NAME&gt; &lt;TYPE&gt; &lt;INDEX&gt; &lt;FILTER&gt; &lt;IP&gt;\n\nNAME   - add a mirror with given name\nTYPE   - specify TYPE 'gre' or 'erspan'\nINDEX  - specify the tunnel INDEX value\n         (indicates key if GRE, erpsan_idx if ERSPAN)\nFILTER - specify FILTER for mirroring selection\n         ('to-lport' / 'from-lport')\nIP     - specify Sink / Destination i.e. Remote IP\n\novn-nbctl mirror-del [NAME]         remove mirrors\novn-nbctl mirror-list               print mirrors\n\novn-nbctl lsp-attach-mirror PORT MIRROR   attach source PORT to MIRROR\novn-nbctl lsp-detach-mirror PORT MIRROR   detach source PORT from MIRROR\n</code></pre>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#pod_1","title":"\u914d\u7f6e\u6d41\u91cf\u63a5\u6536 Pod","text":"<p>\u5728\u524d\u9762\u521b\u5efa\u7684 Pod \u4e2d\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>root@pod1:/kube-ovn# ip link add mirror1 type gretap local 172.19.0.21 key 99 dev net1\nroot@pod1:/kube-ovn# ip link set mirror1 up\n</code></pre> <p>\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5\u5728\u63a5\u6536\u6d41\u91cf\u7684 Pod \u4e2d\u8fdb\u884c\u6293\u5305\u9a8c\u8bc1\uff1a</p> <pre><code>root@pod1:/kube-ovn# tcpdump -i mirror1 -nnve\ntcpdump: listening on mirror1, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n05:13:30.328808 00:00:00:a3:f5:e2 &gt; 00:00:00:97:0f:6e, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Request who-has 10.16.0.7 tell 10.16.0.4, length 28\n05:13:30.559167 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 212: (tos 0x0, ttl 64, id 57364, offset 0, flags [DF], proto UDP (17), length 198)\n10.16.0.4.53 &gt; 10.16.0.6.50472: 34511 NXDomain*- 0/1/1 (170)\n05:13:30.559343 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 212: (tos 0x0, ttl 64, id 57365, offset 0, flags [DF], proto UDP (17), length 198)\n10.16.0.4.53 &gt; 10.16.0.6.45177: 1659 NXDomain*- 0/1/1 (170)\n05:13:30.560625 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 200: (tos 0x0, ttl 64, id 57367, offset 0, flags [DF], proto UDP (17), length 186)\n10.16.0.4.53 &gt; 10.16.0.6.43848: 2636*- 0/1/1 (158)\n05:13:30.562774 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 191: (tos 0x0, ttl 64, id 57368, offset 0, flags [DF], proto UDP (17), length 177)\n10.16.0.4.53 &gt; 10.16.0.6.37755: 48737 NXDomain*- 0/1/1 (149)\n05:13:30.563523 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 187: (tos 0x0, ttl 64, id 57369, offset 0, flags [DF], proto UDP (17), length 173)\n10.16.0.4.53 &gt; 10.16.0.6.53887: 45519 NXDomain*- 0/1/1 (145)\n05:13:30.564940 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 201: (tos 0x0, ttl 64, id 57370, offset 0, flags [DF], proto UDP (17), length 187)\n10.16.0.4.53 &gt; 10.16.0.6.40846: 25745 NXDomain*- 0/1/1 (159)\n05:13:30.565140 00:00:00:a3:f5:e2 &gt; 00:00:00:89:d5:cc, ethertype IPv4 (0x0800), length 201: (tos 0x0, ttl 64, id 57371, offset 0, flags [DF], proto UDP (17), length 187)\n10.16.0.4.53 &gt; 10.16.0.6.45214: 61875 NXDomain*- 0/1/1 (159)\n05:13:30.566023 00:00:00:a3:f5:e2 &gt; 00:00:00:55:e4:4e, ethertype IPv4 (0x0800), length 80: (tos 0x0, ttl 64, id 45937, offset 0, flags [DF], proto UDP (17), length 66)\n10.16.0.4.44116 &gt; 172.18.0.1.53: 16025+ [1au] AAAA? alauda.cn. (38)\n</code></pre>"},{"location":"network/kube-ovn/devops/remote-port-mirroring/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ol> <li>\u5982\u679c\u4f7f\u7528 ERSPAN \u4f5c\u4e3a\u5c01\u88c5\u534f\u8bae\uff0cOVN \u8282\u70b9\u53ca\u8fdc\u7aef\u8bbe\u5907\u7684 Linux \u5185\u6838\u7248\u672c\u4e0d\u5f97\u4f4e\u4e8e 4.14\u3002\u82e5\u4f7f\u7528 ERSPAN \u4f5c\u4e3a\u5c01\u88c5\u534f\u8bae\u4e14\u4f7f\u7528 IPv6 \u4f5c\u4e3a\u4f20\u8f93\u7f51\u7edc\uff0cLinux \u5185\u6838\u7248\u672c\u4e0d\u5f97\u4f4e\u4e8e 4.16\u3002</li> <li>\u955c\u50cf\u6d41\u91cf\u7684\u4f20\u8f93\u662f\u5355\u5411\u7684\uff0c\u53ea\u9700\u4fdd\u8bc1 OVN \u8282\u70b9\u80fd\u591f\u8bbf\u95ee\u8fdc\u7aef\u8bbe\u5907\u5373\u53ef\u3002</li> </ol>"},{"location":"network/kube-ovn/features/cluster-inter-connection/","title":"\u591a\u96c6\u7fa4\u4e92\u8054","text":""},{"location":"network/kube-ovn/features/cluster-inter-connection/#ovn-ic","title":"\u4f7f\u7528 OVN-IC \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054","text":"<p>Kube-OVN \u652f\u6301\u901a\u8fc7 OVN-IC \u5c06\u4e24\u4e2a Kubernetes \u96c6\u7fa4 Pod \u7f51\u7edc\u6253\u901a\uff0c\u6253\u901a\u540e\u7684\u4e24\u4e2a\u96c6\u7fa4\u5185\u7684 Pod \u53ef\u4ee5\u901a\u8fc7 Pod IP \u8fdb\u884c\u76f4\u63a5\u901a\u4fe1\u3002 Kube-OVN \u4f7f\u7528\u96a7\u9053\u5bf9\u8de8\u96c6\u7fa4\u6d41\u91cf\u8fdb\u884c\u5c01\u88c5\uff0c\u4e24\u4e2a\u96c6\u7fa4\u4e4b\u95f4\u53ea\u8981\u5b58\u5728\u4e00\u7ec4 IP \u53ef\u8fbe\u7684\u673a\u5668\u5373\u53ef\u5b8c\u6210\u5bb9\u5668\u7f51\u7edc\u7684\u4e92\u901a\u3002</p> <p>\u5907\u6ce8</p> <p>\u8be5\u6a21\u5f0f\u7684\u591a\u96c6\u7fa4\u4e92\u8054\u4e3a Overlay \u7f51\u7edc\u529f\u80fd\uff0cUnderlay \u7f51\u7edc\u5982\u679c\u60f3\u8981\u5b9e\u73b0\u96c6\u7fa4\u4e92\u8054\u9700\u8981\u5e95\u5c42\u57fa\u7840\u8bbe\u65bd\u505a\u7f51\u7edc\u6253\u901a\u3002</p> <p></p>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#_1","title":"\u524d\u63d0\u6761\u4ef6","text":"<ol> <li>\u81ea\u52a8\u4e92\u8054\u6a21\u5f0f\u4e0b\u4e0d\u540c\u96c6\u7fa4\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u76f8\u4e92\u91cd\u53e0\uff0c\u9ed8\u8ba4\u5b50\u7f51\u9700\u5728\u5b89\u88c5\u65f6\u914d\u7f6e\u4e3a\u4e0d\u91cd\u53e0\u7684\u7f51\u6bb5\u3002\u82e5\u5b58\u5728\u91cd\u53e0\u9700\u53c2\u8003\u540e\u7eed\u624b\u52a8\u4e92\u8054\u8fc7\u7a0b\uff0c\u53ea\u80fd\u5c06\u4e0d\u91cd\u53e0\u7f51\u6bb5\u6253\u901a\u3002</li> <li>\u9700\u8981\u5b58\u5728\u4e00\u7ec4\u673a\u5668\u53ef\u4ee5\u88ab\u6bcf\u4e2a\u96c6\u7fa4\u7684 <code>kube-ovn-controller</code> \u901a\u8fc7 IP \u8bbf\u95ee\uff0c\u7528\u6765\u90e8\u7f72\u8de8\u96c6\u7fa4\u4e92\u8054\u7684\u63a7\u5236\u5668\u3002</li> <li>\u6bcf\u4e2a\u96c6\u7fa4\u9700\u8981\u6709\u4e00\u7ec4\u53ef\u4ee5\u901a\u8fc7 IP \u8fdb\u884c\u8de8\u96c6\u7fa4\u4e92\u8bbf\u7684\u673a\u5668\u4f5c\u4e3a\u4e4b\u540e\u7684\u7f51\u5173\u8282\u70b9\u3002</li> <li>\u8be5\u529f\u80fd\u53ea\u5bf9\u9ed8\u8ba4 VPC \u751f\u6548\uff0c\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u65e0\u6cd5\u4f7f\u7528\u4e92\u8054\u529f\u80fd\u3002</li> </ol>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#ovn-ic_1","title":"\u90e8\u7f72\u5355\u8282\u70b9 OVN-IC \u6570\u636e\u5e93","text":"<p>\u5728\u6bcf\u4e2a\u96c6\u7fa4 <code>kube-ovn-controller</code> \u53ef\u901a\u8fc7 IP \u8bbf\u95ee\u7684\u673a\u5668\u4e0a\u90e8\u7f72 <code>OVN-IC</code> \u6570\u636e\u5e93\uff0c\u8be5\u8282\u70b9\u5c06\u4fdd\u5b58\u5404\u4e2a\u96c6\u7fa4\u540c\u6b65\u4e0a\u6765\u7684\u7f51\u7edc\u914d\u7f6e\u4fe1\u606f\u3002</p> <p>\u90e8\u7f72 <code>docker</code>/<code>containerd</code> \u7684\u73af\u5883\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 <code>OVN-IC</code> \u6570\u636e\u5e93\uff1a</p> dockercontainerd <pre><code>docker run --name=ovn-ic-db -d --network=host --privileged  -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn kubeovn/kube-ovn:v1.12.0 bash start-ic-db.sh\n</code></pre> <pre><code>ctr -n k8s.io run -d --net-host --privileged --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\" docker.io/kubeovn/kube-ovn:v1.12.0 ovn-ic-db bash start-ic-db.sh\n</code></pre>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#_2","title":"\u81ea\u52a8\u8def\u7531\u8bbe\u7f6e","text":"<p>\u5728\u81ea\u52a8\u8def\u7531\u8bbe\u7f6e\u4e0b\uff0c\u6bcf\u4e2a\u96c6\u7fa4\u4f1a\u5c06\u81ea\u5df1\u9ed8\u8ba4 VPC \u4e0b <code>Subnet</code> \u7684 CIDR \u4fe1\u606f\u540c\u6b65\u7ed9 <code>OVN-IC</code>\uff0c\u56e0\u6b64\u8981\u786e\u4fdd\u4e24\u4e2a\u96c6\u7fa4\u7684 <code>Subnet</code> CIDR \u4e0d\u5b58\u5728\u91cd\u53e0\u3002</p> <p>\u5728 <code>kube-system</code> Namespace \u4e0b\u521b\u5efa <code>ovn-ic-config</code> ConfigMap\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: ovn-ic-config\nnamespace: kube-system\ndata:\nenable-ic: \"true\"\naz-name: \"az1\" ic-db-host: \"192.168.65.3\"\nic-nb-port: \"6645\" ic-sb-port: \"6646\"\ngw-nodes: \"az1-gw\"\nauto-route: \"true\"\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>enable-ic</code> \u662f\u5426\u5f00\u542f\u96c6\u7fa4\u4e92\u8054\u3002 <code>az-name</code> \u533a\u5206\u4e0d\u540c\u96c6\u7fa4\u7684\u96c6\u7fa4\u540d\u79f0\uff0c\u6bcf\u4e2a\u4e92\u8054\u96c6\u7fa4\u9700\u4e0d\u540c\u3002 <code>ic-db-host</code> \u90e8\u7f72 <code>OVN-IC</code> \u6570\u636e\u5e93\u7684\u8282\u70b9\u5730\u5740\u3002 <code>ic-nb-port</code> <code>OVN-IC</code> \u5317\u5411\u6570\u636e\u5e93\u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a <code>6645</code>\u3002 <code>ic-sb-port</code> <code>OVN-IC</code> \u5357\u5411\u6570\u636e\u5e93\u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a <code>6646</code>\u3002 <code>gw-nodes</code> \u96c6\u7fa4\u4e92\u8054\u4e2d\u627f\u62c5\u7f51\u5173\u5de5\u4f5c\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 <code>auto-route</code> \u662f\u5426\u81ea\u52a8\u5bf9\u5916\u53d1\u5e03\u548c\u5b66\u4e60\u8def\u7531\u3002 <p>\u6ce8\u610f</p> <p>\u4e3a\u4e86\u4fdd\u8bc1\u64cd\u4f5c\u7684\u6b63\u786e\u6027\uff0c<code>ovn-ic-config</code> \u8fd9\u4e2a ConfigMap \u4e0d\u5141\u8bb8\u4fee\u6539\u3002\u5982\u6709\u53c2\u6570\u9700\u8981\u53d8\u66f4\uff0c\u8bf7\u5220\u9664\u8be5 ConfigMap\uff0c\u4fee\u6539\u540e\u518d\u5e94\u7528\u6b64 ConfigMap\u3002</p> <p>\u5728 <code>ovn-ic</code> \u5bb9\u5668\u5185\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u5efa\u7acb\u4e92\u8054\u903b\u8f91\u4ea4\u6362\u673a <code>ts</code>\uff1a</p> <pre><code>$ ovn-ic-sbctl show\navailability-zone az1\n    gateway deee03e0-af16-4f45-91e9-b50c3960f809\n        hostname: az1-gw\n        type: geneve\n            ip: 192.168.42.145\n        port ts-az1\n            transit switch: ts\n            address: [\"00:00:00:50:AC:8C 169.254.100.45/24\"]\navailability-zone az2\n    gateway e94cc831-8143-40e3-a478-90352773327b\n        hostname: az2-gw\n        type: geneve\n            ip: 192.168.42.149\n        port ts-az2\n            transit switch: ts\n            address: [\"00:00:00:07:4A:59 169.254.100.63/24\"]\n</code></pre> <p>\u5728\u6bcf\u4e2a\u96c6\u7fa4\u89c2\u5bdf\u903b\u8f91\u8def\u7531\u662f\u5426\u6709\u5b66\u4e60\u5230\u7684\u5bf9\u7aef\u8def\u7531\uff1a</p> <pre><code>$ kubectl ko nbctl lr-route-list ovn-cluster\nIPv4 Routes\n                10.42.1.1            169.254.100.45 dst-ip (learned)\n10.42.1.3                100.64.0.2 dst-ip\n                10.16.0.2                100.64.0.2 src-ip\n                10.16.0.3                100.64.0.2 src-ip\n                10.16.0.4                100.64.0.2 src-ip\n                10.16.0.6                100.64.0.2 src-ip\n             10.17.0.0/16            169.254.100.45 dst-ip (learned)\n100.65.0.0/16            169.254.100.45 dst-ip (learned)\n</code></pre> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u5c1d\u8bd5\u5728\u96c6\u7fa4 1 \u5185\u7684\u4e00\u4e2a Pod \u5185\u76f4\u63a5 <code>ping</code> \u96c6\u7fa4 2 \u5185\u7684\u4e00\u4e2a Pod IP \u89c2\u5bdf\u662f\u5426\u53ef\u4ee5\u8054\u901a\u3002</p> <p>\u5bf9\u4e8e\u67d0\u4e2a\u4e0d\u60f3\u5bf9\u5916\u81ea\u52a8\u53d1\u5e03\u8def\u7531\u7684\u5b50\u7f51\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>Subnet</code> \u91cc\u7684 <code>disableInterConnection</code> \u6765\u7981\u6b62\u8def\u7531\u5e7f\u64ad\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: no-advertise\nspec:\ncidrBlock: 10.199.0.0/16\ndisableInterConnection: true\n</code></pre>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#_3","title":"\u624b\u52a8\u8def\u7531\u8bbe\u7f6e","text":"<p>\u5bf9\u4e8e\u96c6\u7fa4\u95f4\u5b58\u5728\u91cd\u53e0 CIDR \u53ea\u5e0c\u671b\u505a\u90e8\u5206\u5b50\u7f51\u6253\u901a\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u6b65\u9aa4\u624b\u52a8\u53d1\u5e03\u5b50\u7f51\u8def\u7531\u3002</p> <p>\u5728 <code>kube-system</code> Namespace \u4e0b\u521b\u5efa <code>ovn-ic-config</code> ConfigMap\uff0c\u5e76\u5c06 <code>auto-route</code> \u8bbe\u7f6e\u4e3a <code>false</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: ovn-ic-config\nnamespace: kube-system\ndata:\nenable-ic: \"true\"\naz-name: \"az1\" ic-db-host: \"192.168.65.3\"\nic-nb-port: \"6645\" ic-sb-port: \"6646\"\ngw-nodes: \"az1-gw\"\nauto-route: \"false\"\n</code></pre> <p>\u5728\u6bcf\u4e2a\u96c6\u7fa4\u5206\u522b\u67e5\u770b\u8fdc\u7aef\u903b\u8f91\u7aef\u53e3\u7684\u5730\u5740\uff0c\u7528\u4e8e\u4e4b\u540e\u624b\u52a8\u914d\u7f6e\u8def\u7531\uff1a</p> <pre><code>[root@az1 ~]# kubectl ko nbctl show\nswitch a391d3a1-14a0-4841-9836-4bd930c447fb (ts)\nport ts-az1\n        type: router\n        router-port: az1-ts\n    port ts-az2\n        type: remote\n        addresses: [\"00:00:00:4B:E2:9F 169.254.100.31/24\"]\n[root@az2 ~]# kubectl ko nbctl show\nswitch da6138b8-de81-4908-abf9-b2224ec4edf3 (ts)\nport ts-az2\n        type: router\n        router-port: az2-ts\n    port ts-az1\n        type: remote\n        addresses: [\"00:00:00:FB:2A:F7 169.254.100.79/24\"]   </code></pre> <p>\u7531\u4e0a\u8f93\u51fa\u53ef\u77e5\uff0c\u96c6\u7fa4 <code>az1</code> \u5230 \u96c6\u7fa4 <code>az2</code> \u7684\u8fdc\u7aef\u5730\u5740\u4e3a <code>169.254.100.31</code>\uff0c<code>az2</code> \u5230 <code>az1</code> \u7684\u8fdc\u7aef\u5730\u5740\u4e3a <code>169.254.100.79</code>\u3002</p> <p>\u4e0b\u9762\u624b\u52a8\u8bbe\u7f6e\u8def\u7531\uff0c\u5728\u8be5\u4f8b\u5b50\u4e2d\uff0c\u96c6\u7fa4 <code>az1</code> \u5185\u7684\u5b50\u7f51 CIDR \u4e3a <code>10.16.0.0/24</code>\uff0c\u96c6\u7fa4 <code>az2</code> \u5185\u7684\u5b50\u7f51 CIDR \u4e3a <code>10.17.0.0/24</code>\u3002</p> <p>\u5728\u96c6\u7fa4 <code>az1</code> \u8bbe\u7f6e\u5230\u96c6\u7fa4 <code>az2</code> \u7684\u8def\u7531:</p> <pre><code>kubectl ko nbctl lr-route-add ovn-cluster 10.17.0.0/24 169.254.100.31\n</code></pre> <p>\u5728\u96c6\u7fa4 <code>az2</code> \u8bbe\u7f6e\u5230\u96c6\u7fa4 <code>az1</code> \u7684\u8def\u7531:</p> <pre><code>kubectl ko nbctl lr-route-add ovn-cluster 10.16.0.0/24 169.254.100.79\n</code></pre>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#ovn-ic_2","title":"\u9ad8\u53ef\u7528 OVN-IC \u6570\u636e\u5e93\u90e8\u7f72","text":"<p><code>OVN-IC</code> \u6570\u636e\u5e93\u4e4b\u95f4\u53ef\u4ee5\u901a\u8fc7 Raft \u534f\u8bae\u7ec4\u6210\u4e00\u4e2a\u9ad8\u53ef\u7528\u96c6\u7fa4\uff0c\u8be5\u90e8\u7f72\u6a21\u5f0f\u9700\u8981\u81f3\u5c11 3 \u4e2a\u8282\u70b9\u3002</p> <p>\u9996\u5148\u5728\u7b2c\u4e00\u4e2a\u8282\u70b9\u4e0a\u542f\u52a8 <code>OVN-IC</code> \u6570\u636e\u5e93\u7684 leader\u3002</p> <p>\u90e8\u7f72 <code>docker</code>/<code>containerd</code> \u73af\u5883\u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> dockercontainerd <pre><code>docker run --name=ovn-ic-db -d --network=host --privileged -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn -e LOCAL_IP=\"192.168.65.3\"  -e NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"   kubeovn/kube-ovn:v1.12.0 bash start-ic-db.sh\n</code></pre> <pre><code>ctr -n k8s.io run -d --net-host --privileged --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\"  --env=\"NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"\" --env=\"LOCAL_IP=\"192.168.65.3\"\" docker.io/kubeovn/kube-ovn:v1.12.0 ovn-ic-db bash start-ic-db.sh\n</code></pre> <ul> <li><code>LOCAL_IP</code>\uff1a \u5f53\u524d\u5bb9\u5668\u6240\u5728\u8282\u70b9 IP \u5730\u5740\u3002</li> <li><code>NODE_IPS</code>\uff1a \u8fd0\u884c <code>OVN-IC</code> \u6570\u636e\u5e93\u7684\u4e09\u4e2a\u8282\u70b9 IP \u5730\u5740\uff0c\u4f7f\u7528\u9017\u53f7\u8fdb\u884c\u5206\u9694\u3002</li> </ul> <p>\u63a5\u4e0b\u6765\uff0c\u5728\u53e6\u5916\u4e24\u4e2a\u8282\u70b9\u90e8\u7f72 <code>OVN-IC</code> \u6570\u636e\u5e93\u7684 follower\u3002</p> <p>\u90e8\u7f72 <code>docker</code>/<code>containerd</code> \u73af\u5883\u7684\u7528\u6237\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> dockercontainerd <pre><code>docker run --name=ovn-ic-db -d --network=host --privileged -v /etc/ovn/:/etc/ovn -v /var/run/ovn:/var/run/ovn -v /var/log/ovn:/var/log/ovn -e LOCAL_IP=\"192.168.65.2\"  -e NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\" -e LEADER_IP=\"192.168.65.3\"  kubeovn/kube-ovn:v1.12.0 bash start-ic-db.sh\n</code></pre> <pre><code>ctr -n k8s.io run -d --net-host --privileged --mount=\"type=bind,src=/etc/ovn/,dst=/etc/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/run/ovn,dst=/var/run/ovn,options=rbind:rw\" --mount=\"type=bind,src=/var/log/ovn,dst=/var/log/ovn,options=rbind:rw\"  --env=\"NODE_IPS=\"192.168.65.3,192.168.65.2,192.168.65.1\"\" --env=\"LOCAL_IP=\"192.168.65.2\"\" --env=\"LEADER_IP=\"192.168.65.3\"\" docker.io/kubeovn/kube-ovn:v1.12.0 ovn-ic-db bash start-ic-db.sh\n</code></pre> <ul> <li><code>LOCAL_IP</code>\uff1a \u5f53\u524d\u5bb9\u5668\u6240\u5728\u8282\u70b9 IP \u5730\u5740\u3002</li> <li><code>NODE_IPS</code>\uff1a \u8fd0\u884c <code>OVN-IC</code> \u6570\u636e\u5e93\u7684\u4e09\u4e2a\u8282\u70b9 IP \u5730\u5740\uff0c\u4f7f\u7528\u9017\u53f7\u8fdb\u884c\u5206\u9694\u3002</li> <li><code>LEADER_IP</code>: \u8fd0\u884c <code>OVN-IC</code> \u6570\u636e\u5e93 <code>leader</code> \u8282\u70b9\u7684 IP \u5730\u5740\u3002</li> </ul> <p>\u5728\u6bcf\u4e2a\u96c6\u7fa4\u521b\u5efa <code>ovn-ic-config</code> \u65f6\u6307\u5b9a\u591a\u4e2a <code>OVN-IC</code> \u6570\u636e\u5e93\u8282\u70b9\u5730\u5740\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: ovn-ic-config\nnamespace: kube-system\ndata:\nenable-ic: \"true\"\naz-name: \"az1\" ic-db-host: \"192.168.65.3,192.168.65.2,192.168.65.1\"\nic-nb-port: \"6645\"\nic-sb-port: \"6646\"\ngw-nodes: \"az1-gw\"\nauto-route: \"true\"\n</code></pre>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#_4","title":"\u624b\u52a8\u91cd\u7f6e","text":"<p>\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\uff0c\u7531\u4e8e\u914d\u7f6e\u9519\u8bef\u9700\u8981\u5bf9\u6574\u4e2a\u4e92\u8054\u914d\u7f6e\u8fdb\u884c\u6e05\u7406\uff0c\u53ef\u4ee5\u53c2\u8003\u4e0b\u9762\u7684\u6b65\u9aa4\u6e05\u7406\u73af\u5883\u3002</p> <p>\u5220\u9664\u5f53\u524d\u7684 <code>ovn-ic-config</code> Configmap\uff1a</p> <pre><code>kubectl -n kube-system delete cm ovn-ic-config\n</code></pre> <p>\u5220\u9664 <code>ts</code> \u903b\u8f91\u4ea4\u6362\u673a\uff1a</p> <pre><code>kubectl-ko nbctl ls-del ts\n</code></pre> <p>\u5728\u5bf9\u7aef\u96c6\u7fa4\u91cd\u590d\u540c\u6837\u7684\u6b65\u9aa4\u3002</p>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#az-name","title":"\u4fee\u6539 az-name","text":"<p>\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>kubectl edit</code> \u7684\u65b9\u5f0f\u5bf9 <code>ovn-ic-config</code> \u8fd9\u4e2a configmap \u4e2d\u7684 <code>az-name</code> \u5b57\u6bb5\u8fdb\u884c\u4fee\u6539\u3002 \u4f46\u662f\u9700\u8981\u5728\u6bcf\u4e2a ovn-cni pod \u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5426\u5219\u53ef\u80fd\u51fa\u73b0\u6700\u957f 10 \u5206\u949f\u7684\u8de8\u96c6\u7fa4\u7f51\u7edc\u4e2d\u65ad\u3002</p> <pre><code>ovn-appctl -t ovn-controller inc-engine/recompute\n</code></pre>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#submariner","title":"\u4f7f\u7528 Submariner \u8fdb\u884c\u591a\u96c6\u7fa4\u4e92\u8054","text":"<p>Submariner \u4f5c\u4e3a\u53ef\u4ee5\u6253\u901a\u591a\u4e2a Kubernetes \u96c6\u7fa4 Pod \u548c Service \u7f51\u7edc\u7684\u5f00\u6e90\u7f51\u7edc\u7ec4\u4ef6\uff0c\u80fd\u591f\u5e2e\u52a9 Kube-OVN \u5b9e\u73b0\u591a\u96c6\u7fa4\u4e92\u8054\u3002</p> <p>\u76f8\u6bd4\u901a\u8fc7 <code>OVN-IC</code> \u6253\u901a\u591a\u96c6\u7fa4\u7f51\u7edc\u7684\u65b9\u5f0f\uff0cSubmariner \u53ef\u4ee5\u6253\u901a Kube-OVN \u548c\u975e Kube-OVN \u7684\u96c6\u7fa4\u7f51\u7edc\uff0c\u5e76 \u80fd\u63d0\u4f9b Service \u7684\u8de8\u96c6\u7fa4\u80fd\u529b\u3002\u4f46\u662f Submariner \u76ee\u524d\u53ea\u80fd\u5b9e\u73b0\u9ed8\u8ba4\u5b50\u7f51\u7684\u6253\u901a\uff0c\u65e0\u6cd5\u5b9e\u73b0\u591a\u5b50\u7f51\u9009\u62e9\u6027\u6253\u901a\u3002</p>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#_5","title":"\u524d\u63d0\u6761\u4ef6","text":"<ul> <li>\u4e24\u4e2a\u96c6\u7fa4\u7684 Service CIDR \u548c\u9ed8\u8ba4\u5b50\u7f51\u7684 CIDR \u4e0d\u80fd\u91cd\u53e0\u3002</li> </ul>"},{"location":"network/kube-ovn/features/cluster-inter-connection/#submariner_1","title":"\u90e8\u7f72 Submariner","text":"<p>\u4e0b\u8f7d <code>subctl</code> \u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u90e8\u7f72\u5230\u76f8\u5e94\u8def\u5f84\uff1a</p> <pre><code>curl -Ls https://get.submariner.io | bash\nexport PATH=$PATH:~/.local/bin\necho export PATH=\\$PATH:~/.local/bin &gt;&gt; ~/.profile\n</code></pre> <p>\u5207\u6362 <code>kubeconfig</code> \u81f3\u5e0c\u671b\u90e8\u7f72 <code>submariner-broker</code> \u7684\u96c6\u7fa4\u8fdb\u884c\u90e8\u7f72\uff1a</p> <pre><code>subctl deploy-broker\n</code></pre> <p>\u5728\u672c\u6587\u6863\u4e2d <code>cluster0</code> \u7684\u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e3a <code>10.16.0.0/16</code>\uff0c<code>join</code> \u5b50\u7f51 CIDR \u4e3a <code>100.64.0.0/16</code>\uff0c<code>cluster1</code> \u7684\u9ed8\u8ba4\u5b50\u7f51 CIDR \u4e3a <code>11.16.0.0/16</code>\uff0c<code>join</code> \u5b50\u7f51 CIDR \u4e3a <code>100.68.0.0/16</code>\u3002</p> <p>\u5207\u6362 <code>kubeconfig</code> \u81f3 <code>cluster0</code> \u6ce8\u518c\u96c6\u7fa4\u81f3 broker\uff0c\u5e76\u6ce8\u518c\u7f51\u5173\u8282\u70b9:</p> <pre><code>subctl  join broker-info.subm --clusterid  cluster0 --clustercidr 100.64.0.0/16,10.16.0.0/16  --natt=false --cable-driver vxlan --health-check=false\nkubectl label nodes cluster0 submariner.io/gateway=true\n</code></pre> <p>\u5207\u6362 <code>kubeconfig</code> \u81f3 <code>cluster1</code> \u6ce8\u518c\u96c6\u7fa4\u81f3 broker\uff0c\u5e76\u6ce8\u518c\u7f51\u5173\u8282\u70b9:</p> <pre><code>subctl  join broker-info.subm --clusterid  cluster1 --clustercidr 100.68.0.0/16,11.16.0.0/16  --natt=false --cable-driver vxlan --health-check=false\nkubectl label nodes cluster1 submariner.io/gateway=true\n</code></pre> <p>\u5982\u679c\u6267\u884c<code>join</code>\u547d\u4ee4\u4e4b\u540e\u6ca1\u6709\u65b0\u7684gateway, <code>routeagentpod</code> \u51fa\u73b0\u7684\u8bdd, \u8bf7\u4e3a<code>submariner-operator</code>\u8fd9\u4e2a<code>clusterrole</code>\u589e\u52a0\u4ee5\u4e0b\u6743\u9650:</p> <pre><code>- apiGroups:\n- \"apps\"\nresources:\n- daemonsets\nverbs:\n- create\n- get\n- list\n- watch\n- update\n</code></pre> <p>\u5bf9\u4e8e\u591a\u8282\u70b9\u7684\u96c6\u7fa4\uff0c\u9700\u8981\u5c06\u9ed8\u8ba4\u7684<code>subnet ovn-default</code>\u7684\u7f51\u5173\u914d\u7f6e\u6539\u4e3a<code>centralized</code>\u3002\u4e3a submariner \u914d\u7f6e\u7684gateway\u8282\u70b9\u9700\u8981\u548c<code>subnet</code>\u8282\u70b9\u5b8c\u5168\u76f8\u540c\u3002</p> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u5728\u4e24\u4e2a\u96c6\u7fa4\u5185\u5206\u522b\u542f\u52a8 Pod \u5e76\u5c1d\u8bd5\u4f7f\u7528 IP \u8fdb\u884c\u76f8\u4e92\u8bbf\u95ee\u3002</p> <p>\u5982\u679c\u51fa\u73b0\u7f51\u7edc\u4e92\u901a\u95ee\u9898\u53ef\u901a\u8fc7 <code>subctl</code> \u547d\u4ee4\u8fdb\u884c\u8bca\u65ad\uff1a</p> <pre><code>subctl show all\nsubctl diagnose all\n</code></pre>"},{"location":"network/kube-ovn/features/container-network-qos/","title":"\u5bb9\u5668\u7f51\u7edcQoS\u914d\u7f6e","text":"<p>Kube-OVN \u652f\u6301\u57fa\u4e8e\u5355\u4e2a Pod \u7684\u4e24\u79cd\u4e0d\u540c\u7c7b\u578b\u7684 QoS\uff1a</p> <ul> <li>\u6700\u5927\u5e26\u5bbd\u9650\u5236 QoS\u3002</li> <li><code>linux-netem</code>\uff0c\u6a21\u62df\u8bbe\u5907\u5e72\u6270\u4e22\u5305\u7b49\u7684 QoS\uff0c\u53ef\u7528\u4e8e\u6a21\u62df\u6d4b\u8bd5\u3002</li> </ul> <p>\u5907\u6ce8</p> <p>\u76ee\u524d\u53ea\u652f\u6301 Pod \u7ea7\u522b QoS \u4e0d\u652f\u6301 Namespace \u6216 Subnet \u7ea7\u522b\u7684 QoS \u9650\u5236\u3002</p>"},{"location":"network/kube-ovn/features/container-network-qos/#qos","title":"\u57fa\u4e8e\u6700\u5927\u5e26\u5bbd\u9650\u5236\u7684 QoS","text":"<p>\u8be5\u7c7b\u578b\u7684 QoS \u53ef\u4ee5\u901a\u8fc7 Pod annotation \u52a8\u6001\u8fdb\u884c\u914d\u7f6e\uff0c\u53ef\u4ee5\u5728\u4e0d\u4e2d\u65ad Pod \u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\u8fdb\u884c\u8c03\u6574\u3002 \u5e26\u5bbd\u9650\u901f\u7684\u5355\u4f4d\u4e3a <code>Mbit/s</code>\u3002</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: qos\nnamespace: ls1\nannotations:\novn.kubernetes.io/ingress_rate: \"3\"\novn.kubernetes.io/egress_rate: \"1\"\nspec:\ncontainers:\n- name: qos\nimage: docker.io/library/nginx:alpine\n</code></pre> <p>\u4f7f\u7528 <code>annotation</code> \u52a8\u6001\u8c03\u6574 QoS\uff1a</p> <pre><code>kubectl annotate --overwrite  pod nginx-74d5899f46-d7qkn ovn.kubernetes.io/ingress_rate=3\n</code></pre>"},{"location":"network/kube-ovn/features/container-network-qos/#qos_1","title":"\u6d4b\u8bd5QoS\u8c03\u6574","text":"<p>\u90e8\u7f72\u6027\u80fd\u6d4b\u8bd5\u9700\u8981\u7684\u5bb9\u5668\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\nname: perf\nnamespace: ls1\nlabels:\napp: perf\nspec:\nselector:\nmatchLabels:\napp: perf\ntemplate:\nmetadata:\nlabels:\napp: perf\nspec:\ncontainers:\n- name: nginx\nimage: docker.io/kubeovn/perf\n</code></pre> <p>\u8fdb\u5165\u5176\u4e2d\u4e00\u4e2a Pod \u5e76\u5f00\u542f iperf3 server\uff1a</p> <pre><code>$ kubectl exec -it perf-4n4gt -n ls1 sh\n$ iperf3 -s\n-----------------------------------------------------------\nServer listening on 5201\n-----------------------------------------------------------\n</code></pre> <p>\u8fdb\u5165\u53e6\u4e00\u4e2a Pod \u8bf7\u6c42\u4e4b\u524d\u7684 Pod\uff1a</p> <pre><code>$ kubectl exec -it perf-d4mqc -n ls1 sh\n$ iperf3 -c 10.66.0.12\nConnecting to host 10.66.0.12, port 5201\n[  4] local 10.66.0.14 port 51544 connected to 10.66.0.12 port 5201\n[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd\n[  4]   0.00-1.00   sec  86.4 MBytes   725 Mbits/sec    3    350 KBytes\n[  4]   1.00-2.00   sec  89.9 MBytes   754 Mbits/sec  118    473 KBytes\n[  4]   2.00-3.00   sec   101 MBytes   848 Mbits/sec  184    586 KBytes\n[  4]   3.00-4.00   sec   104 MBytes   875 Mbits/sec  217    671 KBytes\n[  4]   4.00-5.00   sec   111 MBytes   935 Mbits/sec  175    772 KBytes\n[  4]   5.00-6.00   sec   100 MBytes   840 Mbits/sec  658    598 KBytes\n[  4]   6.00-7.00   sec   106 MBytes   890 Mbits/sec  742    668 KBytes\n[  4]   7.00-8.00   sec   102 MBytes   857 Mbits/sec  764    724 KBytes\n[  4]   8.00-9.00   sec  97.4 MBytes   817 Mbits/sec  1175    764 KBytes\n[  4]   9.00-10.00  sec   111 MBytes   934 Mbits/sec  1083    838 KBytes\n- - - - - - - - - - - - - - - - - - - - - - - - -\n[ ID] Interval           Transfer     Bandwidth       Retr\n[  4]   0.00-10.00  sec  1010 MBytes   848 Mbits/sec  5119             sender\n[  4]   0.00-10.00  sec  1008 MBytes   846 Mbits/sec                  receiver\n\niperf Done.\n</code></pre> <p>\u4fee\u6539\u7b2c\u4e00\u4e2a Pod \u7684\u5165\u53e3\u5e26\u5bbd QoS\uff1a</p> <pre><code>kubectl annotate --overwrite  pod perf-4n4gt -n ls1 ovn.kubernetes.io/ingress_rate=30\n</code></pre> <p>\u518d\u6b21\u4ece\u7b2c\u4e8c\u4e2a Pod \u6d4b\u8bd5\u7b2c\u4e00\u4e2a Pod \u5e26\u5bbd\uff1a</p> <pre><code>$ iperf3 -c 10.66.0.12\nConnecting to host 10.66.0.12, port 5201\n[  4] local 10.66.0.14 port 52372 connected to 10.66.0.12 port 5201\n[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd\n[  4]   0.00-1.00   sec  3.66 MBytes  30.7 Mbits/sec    2   76.1 KBytes\n[  4]   1.00-2.00   sec  3.43 MBytes  28.8 Mbits/sec    0    104 KBytes\n[  4]   2.00-3.00   sec  3.50 MBytes  29.4 Mbits/sec    0    126 KBytes\n[  4]   3.00-4.00   sec  3.50 MBytes  29.3 Mbits/sec    0    144 KBytes\n[  4]   4.00-5.00   sec  3.43 MBytes  28.8 Mbits/sec    0    160 KBytes\n[  4]   5.00-6.00   sec  3.43 MBytes  28.8 Mbits/sec    0    175 KBytes\n[  4]   6.00-7.00   sec  3.50 MBytes  29.3 Mbits/sec    0    212 KBytes\n[  4]   7.00-8.00   sec  3.68 MBytes  30.9 Mbits/sec    0    294 KBytes\n[  4]   8.00-9.00   sec  3.74 MBytes  31.4 Mbits/sec    0    398 KBytes\n[  4]   9.00-10.00  sec  3.80 MBytes  31.9 Mbits/sec    0    526 KBytes\n- - - - - - - - - - - - - - - - - - - - - - - - -\n[ ID] Interval           Transfer     Bandwidth       Retr\n[  4]   0.00-10.00  sec  35.7 MBytes  29.9 Mbits/sec    2             sender\n[  4]   0.00-10.00  sec  34.5 MBytes  29.0 Mbits/sec                  receiver\n\niperf Done.\n</code></pre>"},{"location":"network/kube-ovn/features/container-network-qos/#linux-netem-qos","title":"linux-netem QoS","text":"<p>Pod \u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b <code>annotation</code> \u914d\u7f6e <code>linux-netem</code> \u7c7b\u578b QoS\uff1a <code>ovn.kubernetes.io/latency\u3001ovn.kubernetes.io/limit</code> \u548c <code>ovn.kubernetes.io/loss</code>\u3002</p> <ul> <li><code>ovn.kubernetes.io/latency</code>\uff1a\u8bbe\u7f6e Pod \u6d41\u91cf\u5ef6\u8fdf\uff0c\u53d6\u503c\u4e3a\u6574\u6570\uff0c\u5355\u4f4d\u4e3a ms\u3002</li> <li><code>ovn.kubernetes.io/limit</code>\uff1a \u4e3a <code>qdisc</code> \u961f\u5217\u53ef\u5bb9\u7eb3\u7684\u6700\u5927\u6570\u636e\u5305\u6570\uff0c\u53d6\u503c\u4e3a\u6574\u5f62\u6570\u503c\uff0c\u4f8b\u5982 1000\u3002</li> <li><code>ovn.kubernetes.io/loss</code>\uff1a \u4e3a\u8bbe\u7f6e\u7684\u62a5\u6587\u4e22\u5305\u6982\u7387\uff0c\u53d6\u503c\u4e3a <code>float</code> \u7c7b\u578b\uff0c\u4f8b\u5982\u53d6\u503c\u4e3a 20\uff0c\u5219\u4e3a\u8bbe\u7f6e 20% \u7684\u4e22\u5305\u6982\u7387\u3002</li> </ul>"},{"location":"network/kube-ovn/features/dhcp/","title":"DHCP\u914d\u7f6e","text":"<p>\u5728\u4f7f\u7528 SR-IOV \u6216 DPDK \u7c7b\u578b\u7f51\u7edc\u65f6\uff0cKubeVirt \u5185\u7f6e\u7684 DHCP \u65e0\u6cd5\u5728\u8be5\u7f51\u7edc\u6a21\u5f0f\u4e0b\u5de5\u4f5c\u3002Kube-OVN \u53ef\u4ee5\u5229\u7528 OVN \u7684 DHCP \u80fd\u529b\u5728\u5b50\u7f51\u7ea7\u522b\u8bbe\u7f6e DHCP \u9009\u9879\uff0c\u4ece\u800c\u5e2e\u52a9\u8be5\u7f51\u7edc\u7c7b\u578b\u7684 KubeVirt \u865a\u673a\u6b63\u5e38\u4f7f\u7528 DHCP \u83b7\u5f97\u5206\u914d\u7684 IP \u5730\u5740\u3002Kube-OVN \u540c\u65f6\u652f\u6301 DHCPv4 \u548c DHCPv6\u3002</p> <p>\u5b50\u7f51 DHCP \u7684\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: sn-dual\nspec:\ncidrBlock: \"10.0.0.0/24,240e::a00/120\"\ndefault: false\ndisableGatewayCheck: true\ndisableInterConnection: false\nexcludeIps:\n- 10.0.0.1\n- 240e::a01\ngateway: 10.0.0.1,240e::a01\ngatewayNode: ''\ngatewayType: distributed\nnatOutgoing: false\nprivate: false\nprotocol: Dual\nprovider: ovn\nvpc: vpc-test\nenableDHCP: true\ndhcpV4Options: \"lease_time=3600,router=10.0.0.1,server_id=169.254.0.254,server_mac=00:00:00:2E:2F:B8\"\ndhcpV6Options: \"server_id=00:00:00:2E:2F:C5\"\nenableIPv6RA: true\nipv6RAConfigs: \"address_mode=dhcpv6_stateful,max_interval=30,min_interval=5,send_periodic=true\"\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>enableDHCP</code> \u662f\u5426\u5f00\u542f\u5b50\u7f51\u7684 DHCP \u529f\u80fd\u3002 <code>dhcpV4Options,dhcpV6Options</code> \u8be5\u5b57\u6bb5\u76f4\u63a5\u66b4\u9732 <code>ovn-nb</code> \u5185 DHCP \u76f8\u5173\u9009\u9879\uff0c\u8bf7\u53c2\u8003 DHCP Options\u3002 \u9ed8\u8ba4\u503c\u5206\u522b\u4e3a \"<code>lease_time=3600</code>, <code>router=$ipv4_gateway</code>, <code>server_id=169.254.0.254</code>, <code>server_mac=$random_mac</code>\" \u548c <code>server_id=$random_mac</code>\u3002 <code>enableIPv6RA</code> \u662f\u5426\u5f00\u542f DHCPv6 \u7684\u8def\u7531\u5e7f\u64ad\u529f\u80fd\u3002 <code>ipv6RAConfigs</code> \u8be5\u5b57\u6bb5\u76f4\u63a5\u66b4\u9732 <code>ovn-nb</code> \u5185 <code>Logical_Router_Port</code> \u76f8\u5173\u9009\u9879\uff0c\u8bf7\u53c2\u8003 <code>Logical Router Port</code> \u9ed8\u8ba4\u503c\u4e3a <code>address_mode=dhcpv6_stateful</code>, <code>max_interval=30</code>, <code>min_interval=5</code>, <code>send_periodic=true</code>\u3002"},{"location":"network/kube-ovn/features/eip-snat/","title":"EIP\u548cSNAT\u914d\u7f6e","text":"<p>Kube-OVN \u652f\u6301\u5229\u7528 OVN \u4e2d\u7684 L3 Gateway \u529f\u80fd\u6765\u5b9e\u73b0 Pod \u7ea7\u522b\u7684 SNAT \u548c EIP \u529f\u80fd\u3002 \u901a\u8fc7\u4f7f\u7528 SNAT\uff0c\u4e00\u7ec4 Pod \u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a IP \u5730\u5740\u5bf9\u5916\u8fdb\u884c\u8bbf\u95ee\u3002 \u901a\u8fc7 EIP \u7684\u529f\u80fd\uff0c\u4e00\u4e2a Pod \u53ef\u4ee5\u76f4\u63a5\u548c\u4e00\u4e2a\u5916\u90e8 IP \u5173\u8054\uff0c \u5916\u90e8\u670d\u52a1\u53ef\u4ee5\u901a\u8fc7 EIP \u76f4\u63a5\u8bbf\u95ee Pod\uff0cPod \u4e5f\u5c06\u901a\u8fc7\u8fd9\u4e2a EIP \u8bbf\u95ee\u5916\u90e8\u670d\u52a1\u3002</p> <p></p>"},{"location":"network/kube-ovn/features/eip-snat/#_1","title":"\u51c6\u5907\u5de5\u4f5c","text":"<ul> <li>\u4e3a\u4e86\u4f7f\u7528 OVN \u7684 L3 Gateway \u80fd\u529b\uff0c\u5fc5\u987b\u5c06\u4e00\u4e2a\u5355\u72ec\u7684\u7f51\u5361\u63a5\u5165 OVS \u7f51\u6865\u4e2d\u8fdb\u884c Overlay \u548c Underlay \u7f51\u7edc\u7684\u6253\u901a\uff0c \u4e3b\u673a\u5fc5\u987b\u6709\u5176\u4ed6\u7684\u7f51\u5361\u7528\u4e8e\u8fd0\u7ef4\u7ba1\u7406\u3002</li> <li>\u7531\u4e8e\u7ecf\u8fc7 NAT \u540e\u7684\u6570\u636e\u5305\u4f1a\u76f4\u63a5\u8fdb\u5165 Underlay \u7f51\u7edc\uff0c\u5fc5\u987b\u786e\u8ba4\u5f53\u524d\u7684\u7f51\u7edc\u67b6\u6784\u4e0b\u6b64\u7c7b\u6570\u636e\u5305\u53ef\u4ee5\u5b89\u5168\u901a\u8fc7\u3002</li> <li>\u76ee\u524d EIP \u548c SNAT \u5730\u5740\u6ca1\u6709\u51b2\u7a81\u68c0\u6d4b\uff0c\u9700\u8981\u7ba1\u7406\u5458\u624b\u52a8\u5206\u914d\u907f\u514d\u5730\u5740\u51b2\u7a81\u3002</li> </ul>"},{"location":"network/kube-ovn/features/eip-snat/#_2","title":"\u521b\u5efa\u914d\u7f6e\u6587\u4ef6","text":"<p>\u5728 <code>kube-system</code> \u4e0b\u521b\u5efa ConfigMap <code>ovn-external-gw-config</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: ovn-external-gw-config\nnamespace: kube-system\ndata:\nenable-external-gw: \"true\"\nexternal-gw-nodes: \"kube-ovn-worker\"\nexternal-gw-nic: \"eth1\"\nexternal-gw-addr: \"172.56.0.1/16\"\nnic-ip: \"172.56.0.254/16\"\nnic-mac: \"16:52:f3:13:6a:25\"\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>enable-external-gw</code> \u662f\u5426\u5f00\u542f SNAT \u548c EIP \u529f\u80fd\u3002 <code>type</code> <code>centrailized</code> \u6216 <code>distributed</code>\uff0c \u9ed8\u8ba4\u4e3a <code>centralized</code> \u5982\u679c\u4f7f\u7528 <code>distributed</code>\uff0c\u5219\u96c6\u7fa4\u6240\u6709\u8282\u70b9\u90fd\u9700\u8981\u6709\u540c\u540d\u7f51\u5361\u6765\u627f\u62c5\u7f51\u5173\u529f\u80fd\u3002 <code>external-gw-nodes</code> <code>centralized</code> \u6a21\u5f0f\u4e0b\uff0c\u627f\u62c5\u7f51\u5173\u4f5c\u7528\u7684\u8282\u70b9\u540d\uff0c\u9017\u53f7\u5206\u9694\u3002 <code>external-gw-nic</code> \u8282\u70b9\u4e0a\u627f\u62c5\u7f51\u5173\u4f5c\u7528\u7684\u7f51\u5361\u540d\u3002 <code>external-gw-addr</code> \u7269\u7406\u7f51\u7edc\u7f51\u5173\u7684 IP \u548c\u63a9\u7801\u3002 <code>nic-ip,nic-mac</code> \u5206\u914d\u7ed9\u903b\u8f91\u7f51\u5173\u7aef\u53e3\u7684 IP \u548c Mac\uff0c\u9700\u4e3a\u7269\u7406\u6bb5\u672a\u88ab\u5360\u7528\u7684 IP \u548c Mac\u3002"},{"location":"network/kube-ovn/features/eip-snat/#ovn-ovs","title":"\u89c2\u5bdf OVN \u548c OVS \u72b6\u6001\u786e\u8ba4\u914d\u7f6e\u751f\u6548","text":"<p>\u68c0\u67e5 OVN-NB \u72b6\u6001, \u786e\u8ba4 <code>ovn-external</code> \u903b\u8f91\u4ea4\u6362\u673a\u5b58\u5728\uff0c\u5e76\u4e14 <code>ovn-cluster-ovn-external</code> \u903b\u8f91\u8def\u7531\u5668\u7aef\u53e3\u4e0a \u7ed1\u5b9a\u4e86\u6b63\u786e\u7684\u5730\u5740\u548c <code>chassis</code>\u3002</p> <pre><code>$ kubectl ko nbctl show\nswitch 3de4cea7-1a71-43f3-8b62-435a57ef16a6 (ovn-external)\nport ln-ovn-external\n        type: localnet\n        addresses: [\"unknown\"]\nport ovn-external-ovn-cluster\n        type: router\n        router-port: ovn-cluster-ovn-external\nrouter e1eb83ad-34be-4ed5-9a02-fcc8b1d357c4 (ovn-cluster)\nport ovn-cluster-ovn-external\n        mac: \"ac:1f:6b:2d:33:f1\"\nnetworks: [\"172.56.0.100/16\"]\ngateway chassis: [a5682814-2e2c-46dd-9c1c-6803ef0dab66]\n</code></pre> <p>\u68c0\u67e5 OVS \u72b6\u6001\uff0c\u786e\u8ba4\u76f8\u5e94\u7684\u7f51\u5361\u5df2\u7ecf\u6865\u63a5\u8fdb <code>br-external</code> \u7f51\u6865\uff1a</p> <pre><code>$ kubectl ko vsctl ${gateway node name} show\ne7d81150-7743-4d6e-9e6f-5c688232e130\n    Bridge br-external\n        Port br-external\n            Interface br-external\n                type: internal\n        Port eno2\n            Interface eno2\n        Port patch-ln-ovn-external-to-br-int\n            Interface patch-ln-ovn-external-to-br-int\n                type: patch\n                options: {peer=patch-br-int-to-ln-ovn-external}\n</code></pre>"},{"location":"network/kube-ovn/features/eip-snat/#pod-eip-snat","title":"Pod \u914d\u7f6e EIP \u548c SNAT","text":"<p>\u53ef\u901a\u8fc7\u5728 Pod \u4e0a\u589e\u52a0 <code>ovn.kubernetes.io/snat</code> \u6216 <code>ovn.kubernetes.io/eip annotation</code> \u6765\u5206\u522b\u914d\u7f6e SNAT \u548c EIP\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pod-gw\nannotations:\novn.kubernetes.io/snat: 172.56.0.200\nspec:\ncontainers:\n- name: snat-pod\nimage: docker.io/library/nginx:alpine\n---\napiVersion: v1\nkind: Pod\nmetadata:\nname: pod-gw\nannotations:\novn.kubernetes.io/eip: 172.56.0.233\nspec:\ncontainers:\n- name: eip-pod\nimage: docker.io/library/nginx:alpine\n</code></pre> <p>\u53ef\u901a\u8fc7 kubectl \u6216\u5176\u4ed6\u5de5\u5177\u52a8\u6001\u8c03\u6574 Pod \u6240\u914d\u7f6e\u7684 EIP \u6216 SNAT \u89c4\u5219\uff0c\u66f4\u6539\u65f6\u8bf7\u6ce8\u610f\u8981\u540c\u65f6\u5220\u9664 <code>ovn.kubernetes.io/routed annotation</code> \u89e6\u53d1\u8def\u7531\u7684\u53d8\u66f4\uff1a</p> <pre><code>kubectl annotate pod pod-gw ovn.kubernetes.io/eip=172.56.0.221 --overwrite\nkubectl annotate pod pod-gw ovn.kubernetes.io/routed-\n</code></pre> <p>\u5f53 EIP \u6216 SNAT \u89c4\u5219\u751f\u6548\u540e\uff0c<code>ovn.kubernetes.io/routed annotation</code> \u4f1a\u88ab\u91cd\u65b0\u6dfb\u52a0\u3002</p>"},{"location":"network/kube-ovn/features/eip-snat/#_3","title":"\u9ad8\u7ea7\u8bbe\u7f6e","text":"<p><code>kube-ovn-controller</code> \u7684\u90e8\u5206\u542f\u52a8\u53c2\u6570\u53ef\u5bf9 SNAT \u548c EIP \u529f\u80fd\u8fdb\u884c\u9ad8\u9636\u914d\u7f6e\uff1a</p> <ul> <li><code>--external-gateway-config-ns</code>: <code>Configmap ovn-external-gw-config</code> \u6240\u5c5e Namespace\uff0c \u9ed8\u8ba4\u4e3a <code>kube-system</code>\u3002</li> <li><code>--external-gateway-net</code>: \u7269\u7406\u7f51\u5361\u6240\u6865\u63a5\u7684\u7f51\u6865\u540d\uff0c\u9ed8\u8ba4\u4e3a <code>external</code>\u3002</li> <li><code>--external-gateway-vlanid</code>: \u7269\u7406\u7f51\u7edc Vlan Tag \u53f7\uff0c\u9ed8\u8ba4\u4e3a 0\uff0c \u5373\u4e0d\u4f7f\u7528 <code>Vlan</code>\u3002</li> </ul>"},{"location":"network/kube-ovn/features/fixed-ip-address/","title":"\u9759\u6001IP\u5730\u5740","text":"<p>Kube-OVN \u9ed8\u8ba4\u4f1a\u6839\u636e Pod \u6240\u5728 Namespace \u6240\u5c5e\u7684\u5b50\u7f51\u4e2d\u968f\u673a\u5206\u914d IP \u548c Mac\u3002 \u9488\u5bf9\u5de5\u4f5c\u8d1f\u8f7d\u9700\u8981\u56fa\u5b9a\u5730\u5740\u7684\u60c5\u51b5\uff0cKube-OVN \u6839\u636e\u4e0d\u540c\u7684\u573a\u666f\uff0c\u63d0\u4f9b\u4e86\u591a\u79cd\u56fa\u5b9a\u5730\u5740\u7684\u65b9\u6cd5\uff1a</p> <ul> <li>\u5355\u4e2a Pod \u56fa\u5b9a IP/Mac\u3002</li> <li>Workload \u901a\u7528 IP Pool \u65b9\u5f0f\u6307\u5b9a\u56fa\u5b9a\u5730\u5740\u8303\u56f4\u3002</li> <li>StatefulSet \u56fa\u5b9a\u5730\u5740\u3002</li> <li>KubeVirt VM \u56fa\u5b9a\u5730\u5740\u3002</li> </ul>"},{"location":"network/kube-ovn/features/fixed-ip-address/#pod-ip-mac","title":"\u5355\u4e2a Pod \u56fa\u5b9a IP \u548c Mac","text":"<p>\u53ef\u4ee5\u5728\u521b\u5efa Pod \u65f6\u901a\u8fc7 annotation \u6765\u6307\u5b9a Pod \u8fd0\u884c\u65f6\u6240\u9700\u7684 IP/Mac, <code>kube-ovn-controller</code> \u8fd0\u884c\u65f6\u5c06\u4f1a\u8df3\u8fc7\u5730\u5740\u968f\u673a\u5206\u914d\u9636\u6bb5\uff0c\u7ecf\u8fc7\u51b2\u7a81\u68c0\u6d4b\u540e\u76f4\u63a5\u4f7f\u7528\u6307\u5b9a\u5730\u5740\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: static-ip\nannotations:\novn.kubernetes.io/ip_address: 10.16.0.15   // \u53cc\u6808\u5730\u5740\u4f7f\u7528\u9017\u53f7\u5206\u9694 10.16.0.15,fd00:10:16::15\novn.kubernetes.io/mac_address: 00:00:00:53:6B:B6\nspec:\ncontainers:\n- name: static-ip\nimage: docker.io/library/nginx:alpine\n</code></pre> <p>\u5728\u4f7f\u7528 <code>annotation</code> \u5b9a\u4e49\u5355\u4e2a Pod IP/Mac \u65f6\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ol> <li>\u6240\u4f7f\u7528\u7684 IP/Mac \u4e0d\u80fd\u548c\u5df2\u6709\u7684 IP/Mac \u51b2\u7a81\u3002</li> <li>IP \u5fc5\u987b\u5728\u6240\u5c5e\u5b50\u7f51\u7684 CIDR \u5185\u3002</li> <li>\u53ef\u4ee5\u53ea\u6307\u5b9a IP \u6216 Mac\uff0c\u53ea\u6307\u5b9a\u4e00\u4e2a\u65f6\uff0c\u53e6\u4e00\u4e2a\u4f1a\u968f\u673a\u5206\u914d\u3002</li> </ol>"},{"location":"network/kube-ovn/features/fixed-ip-address/#workload-ip-pool","title":"Workload \u901a\u7528 IP Pool \u56fa\u5b9a\u5730\u5740","text":"<p>Kube-OVN \u652f\u6301\u901a\u8fc7 <code>annotation ovn.kubernetes.io/ip_pool</code> \u7ed9 Workload\uff08Deployment/StatefulSet/DaemonSet/Job/CronJob\uff09\u8bbe\u7f6e\u56fa\u5b9a IP\u3002 <code>kube-ovn-controller</code> \u4f1a\u81ea\u52a8\u9009\u62e9 <code>ovn.kubernetes.io/ip_pool</code> \u4e2d\u6307\u5b9a\u7684 IP \u5e76\u8fdb\u884c\u51b2\u7a81\u68c0\u6d4b\u3002</p> <p>IP Pool \u7684 <code>Annotation</code> \u9700\u8981\u52a0\u5728 template \u5185\u7684 <code>annotation</code> \u5b57\u6bb5\uff0c\u9664\u4e86 Kubernetes \u5185\u7f6e\u7684 Workload \u7c7b\u578b\uff0c \u5176\u4ed6\u7528\u6237\u81ea\u5b9a\u4e49\u7684 Workload \u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6837\u7684\u65b9\u5f0f\u8fdb\u884c\u56fa\u5b9a\u5730\u5740\u5206\u914d\u3002</p>"},{"location":"network/kube-ovn/features/fixed-ip-address/#deployment-ip","title":"Deployment \u56fa\u5b9a IP \u793a\u4f8b","text":"<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: ippool\nlabels:\napp: ippool\nspec:\nreplicas: 2\nselector:\nmatchLabels:\napp: ippool\ntemplate:\nmetadata:\nlabels:\napp: ippool\nannotations:\novn.kubernetes.io/ip_pool: 10.16.0.15,10.16.0.16,10.16.0.17 // \u53cc\u6808\u5730\u5740\u4f7f\u7528\u5206\u53f7\u8fdb\u884c\u5206\u9694 10.16.0.15,fd00:10:16::000E;10.16.0.16,fd00:10:16::000F;10.16.0.17,fd00:10:16::0010\nspec:\ncontainers:\n- name: ippool\nimage: docker.io/library/nginx:alpine\n</code></pre> <p>\u6ce8\u610f</p> <p>\u5bf9 Workload \u4f7f\u7528\u56fa\u5b9a IP \u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ol> <li><code>ovn.kubernetes.io/ip_pool</code> \u4e2d\u7684 IP \u5e94\u8be5\u5c5e\u4e8e\u6240\u5728\u5b50\u7f51\u7684 CIDR \u5185\u3002</li> <li><code>ovn.kubernetes.io/ip_pool</code> \u4e2d\u7684 IP \u4e0d\u80fd\u548c\u5df2\u4f7f\u7528\u7684 IP \u51b2\u7a81\u3002</li> <li>\u5f53 <code>ovn.kubernetes.io/ip_pool</code> \u4e2d\u7684 IP \u6570\u91cf\u5c0f\u4e8e <code>replicas</code> \u6570\u91cf\u65f6\uff0c\u591a\u51fa\u7684 Pod \u5c06\u65e0\u6cd5\u521b\u5efa\u3002\u4f60\u9700\u8981\u6839\u636e Workload \u7684\u66f4\u65b0\u7b56\u7565\u4ee5\u53ca\u6269\u5bb9\u89c4\u5212\u8c03\u6574 <code>ovn.kubernetes.io/ip_pool</code> \u4e2d IP \u7684\u6570\u91cf\u3002</li> </ol>"},{"location":"network/kube-ovn/features/fixed-ip-address/#statefulset","title":"StatefulSet \u56fa\u5b9a\u5730\u5740","text":"<p>StatefulSet \u548c\u5176\u4ed6 Workload \u76f8\u540c\u53ef\u4ee5\u4f7f\u7528 ovn.kubernetes.io/ip_pool \u6765\u6307\u5b9a Pod \u4f7f\u7528\u7684 IP\u3002</p> <p>\u7531\u4e8e StatefulSet \u591a\u7528\u4e8e\u6709\u72b6\u6001\u670d\u52a1\uff0c\u5bf9\u7f51\u7edc\u6807\u793a\u7684\u56fa\u5b9a\u6709\u66f4\u9ad8\u7684\u8981\u6c42\uff0cKube-OVN \u505a\u4e86\u7279\u6b8a\u7684\u5f3a\u5316\uff1a</p> <ol> <li>Pod \u4f1a\u6309\u987a\u5e8f\u5206\u914d <code>ovn.kubernetes.io/ip_pool</code> \u4e2d\u7684 IP\u3002\u4f8b\u5982 StatefulSet \u7684\u540d\u5b57\u4e3a web\uff0c\u5219 web-0 \u4f1a\u4f7f\u7528 <code>ovn.kubernetes.io/ip_pool</code> \u4e2d\u7684\u7b2c\u4e00\u4e2a IP\uff0c <code>web-1</code> \u4f1a\u4f7f\u7528\u7b2c\u4e8c\u4e2a IP\uff0c\u4ee5\u6b64\u7c7b\u63a8\u3002</li> <li>StatefulSet Pod \u5728\u66f4\u65b0\u6216\u5220\u9664\u7684\u8fc7\u7a0b\u4e2d OVN \u4e2d\u7684 <code>logical_switch_port</code> \u4e0d\u4f1a\u5220\u9664\uff0c\u65b0\u751f\u6210\u7684 Pod \u76f4\u63a5\u590d\u7528\u65e7\u7684 interface \u4fe1\u606f\u3002\u56e0\u6b64 Pod \u53ef\u4ee5\u590d\u7528 IP/Mac \u53ca\u5176\u4ed6\u7f51\u7edc\u4fe1\u606f\uff0c\u8fbe\u5230\u548c StatefulSet Volume \u7c7b\u4f3c\u7684\u72b6\u6001\u4fdd\u7559\u529f\u80fd\u3002</li> <li>\u57fa\u4e8e 2 \u7684\u80fd\u529b\uff0c\u5bf9\u4e8e\u6ca1\u6709 <code>ovn.kubernetes.io/ip_pool</code> \u6ce8\u89e3\u7684 StatefulSet\uff0cPod \u7b2c\u4e00\u6b21\u751f\u6210\u65f6\u4f1a\u968f\u673a\u5206\u914d IP/Mac\uff0c\u4e4b\u540e\u5728\u6574\u4e2a StatefulSet \u7684\u751f\u547d\u5468\u671f\u5185\uff0c\u7f51\u7edc\u4fe1\u606f\u90fd\u4f1a\u4fdd\u6301\u56fa\u5b9a\u3002</li> </ol>"},{"location":"network/kube-ovn/features/fixed-ip-address/#statefulset_1","title":"StatefulSet \u793a\u4f8b","text":"<pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\nname: web\nspec:\nserviceName: \"nginx\"\nreplicas: 2\nselector:\nmatchLabels:\napp: nginx\ntemplate:\nmetadata:\nlabels:\napp: nginx\nspec:\ncontainers:\n- name: nginx\nimage: docker.io/library/nginx:alpine\nports:\n- containerPort: 80\nname: web\n</code></pre> <p>\u53ef\u4ee5\u5c1d\u8bd5\u5220\u9664 StatefulSet \u4e0b Pod \u89c2\u5bdf Pod IP \u53d8\u5316\u4fe1\u606f\u3002</p>"},{"location":"network/kube-ovn/features/fixed-ip-address/#kubevirt-vm","title":"KubeVirt VM \u56fa\u5b9a\u5730\u5740","text":"<p>\u9488\u5bf9 KubeVirt \u521b\u5efa\u7684 VM \u5b9e\u4f8b\uff0c<code>kube-ovn-controller</code> \u53ef\u4ee5\u6309\u7167\u7c7b\u4f3c StatefulSet Pod \u7684\u65b9\u5f0f\u8fdb\u884c IP \u5730\u5740\u5206\u914d\u548c\u7ba1\u7406\u3002 \u4ee5\u8fbe\u5230 VM \u5b9e\u4f8b\u5728\u751f\u547d\u5468\u671f\u5185\u542f\u505c\uff0c\u5347\u7ea7\uff0c\u8fc1\u79fb\u7b49\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u5730\u5740\u56fa\u5b9a\u4e0d\u53d8\uff0c\u66f4\u7b26\u865a\u62df\u5316\u5408\u7528\u6237\u7684\u5b9e\u9645\u4f7f\u7528\u4f53\u9a8c\u3002</p>"},{"location":"network/kube-ovn/features/ip-pool/","title":"IP\u6c60\u914d\u7f6e","text":"<p>IP\u6c60</p> <p>IP \u6c60\uff08IPPool\uff09\u662f\u6bd4\u5b50\u7f51\uff08Subnet\uff09\u66f4\u7ec6\u529b\u5ea6\u7684 IPAM \u7ba1\u7406\u5355\u5143\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 IP \u6c60\u5c06\u5b50\u7f51\u7f51\u6bb5\u7ec6\u5206\u4e3a\u591a\u4e2a\u5355\u5143\uff0c\u6bcf\u4e2a\u5355\u5143\u7ed1\u5b9a\u4e00\u4e2a\u6216\u591a\u4e2a\u547d\u540d\u7a7a\u95f4\uff08Namespace\uff09\u3002</p>"},{"location":"network/kube-ovn/features/ip-pool/#_1","title":"\u4f7f\u7528\u65b9\u6cd5","text":"<pre><code>apiVersion: kubeovn.io/v1\nkind: IPPool\nmetadata:\nname: pool-1\nspec:\nsubnet: ovn-default\nips:\n- \"10.16.0.201\"\n- \"10.16.0.210/30\"\n- \"10.16.0.220..10.16.0.230\"\nnamespaces:\n- ns-1\n</code></pre> <p>\u5b57\u6bb5\u8bf4\u660e\uff1a</p> \u5b57\u6bb5\u540d\u79f0 \u7528\u9014\u63cf\u8ff0 \u5907\u6ce8 <code>subnet</code> \u6307\u5b9a\u6240\u5c5e\u5b50\u7f51 \u5fc5\u586b <code>ips</code> \u6307\u5b9a\u5305\u542b\u7684 IP \u8303\u56f4 \u652f\u6301 \u3001 \u4ee5\u53ca .. \u4e09\u79cd\u683c\u5f0f\uff0c\u652f\u6301 IPv6\u3002 <code>namespaces</code> \u7ed1\u5b9a\u547d\u540d\u7a7a\u95f4 \u53ef\u9009"},{"location":"network/kube-ovn/features/ip-pool/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u4e3a\u4fdd\u8bc1\u4e0e Workload \u901a\u7528 IP Pool \u56fa\u5b9a\u5730\u5740 \u7684\u517c\u5bb9\u6027\uff0cIP \u6c60\u7684\u540d\u79f0\u4e0d\u80fd\u662f\u4e00\u4e2a IP \u5730\u5740\uff1b</li> <li>IP \u6c60\u7684 <code>.spec.ips</code> \u53ef\u6307\u5b9a\u8d85\u51fa\u5b50\u7f51\u8303\u56f4\u7684 IP \u5730\u5740\uff0c\u4f46\u5b9e\u9645\u6709\u6548\u7684 IP \u5730\u5740\u662f <code>.spec.ips</code> \u4e0e\u5b50\u7f51 CIDR \u7684\u4ea4\u96c6\uff1b</li> <li>\u540c\u4e00\u4e2a\u5b50\u7f51\u7684\u4e0d\u540c IP \u6c60\uff0c\u4e0d\u80fd\u5305\u542b\u76f8\u540c\u7684\uff08\u6709\u6548\uff09IP \u5730\u5740\uff1b</li> <li>IP \u6c60\u7684 <code>.spec.ips</code> \u53ef\u52a8\u6001\u4fee\u6539\uff1b</li> <li>IP \u6c60\u4f1a\u7ee7\u627f\u5b50\u7f51\u7684\u4fdd\u7559 IP\uff0c\u4ece IP \u6c60\u968f\u673a\u5206\u914d IP \u5730\u5740\u65f6\uff0c\u4f1a\u8df3\u8fc7\u5305\u542b\u5728 IP \u6c60\u4e2d\u7684\u4fdd\u7559 IP\uff1b</li> <li>\u4ece\u5b50\u7f51\u968f\u673a\u5206\u914d IP \u5730\u5740\u65f6\uff0c\u53ea\u4f1a\u4ece\u5b50\u7f51\u6240\u6709 IP \u6c60\u4ee5\u5916\u7684\u8303\u56f4\u5206\u914d\u3002</li> </ul>"},{"location":"network/kube-ovn/features/lb-service/","title":"LB\u7c7b\u578bService","text":"<p>Kube-OVN \u5df2\u7ecf\u652f\u6301\u4e86 VPC \u548c VPC \u7f51\u5173\u7684\u5b9e\u73b0\uff0c\u5177\u4f53\u914d\u7f6e\u53ef\u4ee5\u53c2\u8003 VPC \u914d\u7f6e\u3002</p> <p>\u7531\u4e8e VPC \u7f51\u5173\u7684\u4f7f\u7528\u6bd4\u8f83\u590d\u6742\uff0c\u57fa\u4e8e VPC \u7f51\u5173\u7684\u5b9e\u73b0\u505a\u4e86\u7b80\u5316\uff0c\u652f\u6301\u5728\u9ed8\u8ba4 VPC \u4e0b\u521b\u5efa LoadBalancer \u7c7b\u578b\u7684 Service\uff0c\u5b9e\u73b0\u901a\u8fc7 LoadBalancerIP \u6765\u8bbf\u95ee\u9ed8\u8ba4 VPC \u4e0b\u7684 Service\u3002</p> <p>\u9996\u5148\u786e\u8ba4\u73af\u5883\u4e0a\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\uff1a</p> <ol> <li>\u5b89\u88c5\u4e86 multus-cni \u548c macvlan cni\u3002</li> <li>LoadBalancer Service \u7684\u652f\u6301\uff0c\u662f\u5bf9 VPC \u7f51\u5173\u4ee3\u7801\u8fdb\u884c\u7b80\u5316\u5b9e\u73b0\u7684\uff0c\u4ecd\u7136\u4f7f\u7528 <code>vpc-nat-gw</code> \u7684\u955c\u50cf\uff0c\u4f9d\u8d56 <code>macvlan</code> \u63d0\u4f9b\u591a\u7f51\u5361\u529f\u80fd\u652f\u6301\u3002</li> <li>\u76ee\u524d\u53ea\u652f\u6301\u5728\u9ed8\u8ba4 VPC \u914d\u7f6e\uff0c\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684 LoadBalancer \u652f\u6301\u53ef\u4ee5\u53c2\u8003 VPC \u7684\u6587\u6863 VPC \u914d\u7f6e\u3002</li> </ol>"},{"location":"network/kube-ovn/features/lb-service/#vpc-loadbalancer-service","title":"\u9ed8\u8ba4 VPC LoadBalancer Service \u914d\u7f6e\u6b65\u9aa4","text":""},{"location":"network/kube-ovn/features/lb-service/#_1","title":"\u5f00\u542f\u7279\u6027\u5f00\u5173","text":"<p>\u4fee\u6539 <code>kube-system</code> namespace \u4e0b\u7684 deployment <code>kube-ovn-controller</code>\uff0c\u5728 <code>args</code> \u4e2d\u589e\u52a0\u53c2\u6570 <code>--enable-lb-svc=true</code>\uff0c\u5f00\u542f\u529f\u80fd\u5f00\u5173\uff0c\u8be5\u53c2\u6570\u9ed8\u8ba4\u4e3a <code>false</code>\u3002</p> <pre><code>containers:\n- args:\n- /kube-ovn/start-controller.sh\n- --default-cidr=10.16.0.0/16\n- --default-gateway=10.16.0.1\n- --default-gateway-check=true\n- --enable-lb-svc=true                  // \u53c2\u6570\u8bbe\u7f6e\u4e3a true\n</code></pre>"},{"location":"network/kube-ovn/features/lb-service/#networkattachmentdefinition-crd","title":"\u521b\u5efa NetworkAttachmentDefinition CRD \u8d44\u6e90","text":"<p>\u53c2\u8003\u4ee5\u4e0b yaml\uff0c\u521b\u5efa <code>net-attach-def</code> \u8d44\u6e90:</p> <pre><code>apiVersion: \"k8s.cni.cncf.io/v1\"\nkind: NetworkAttachmentDefinition\nmetadata:\nname: lb-svc-attachment\nnamespace: kube-system\nspec:\nconfig: '{\n\"cniVersion\": \"0.3.0\",\n\"type\": \"macvlan\",\n\"master\": \"eth0\",                         //\u7269\u7406\u7f51\u5361\uff0c\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u914d\u7f6e\n\"mode\": \"bridge\"\n}'\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u901a\u8fc7\u7269\u7406\u7f51\u5361 <code>eth0</code> \u6765\u5b9e\u73b0\u591a\u7f51\u5361\u529f\u80fd\uff0c\u5982\u679c\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u7269\u7406\u7f51\u5361\uff0c\u53ef\u4ee5\u901a\u8fc7\u4fee\u6539 <code>master</code> \u53d6\u503c\uff0c\u6307\u5b9a\u4f7f\u7528\u7684\u7269\u7406\u7f51\u5361\u540d\u79f0\u3002</p>"},{"location":"network/kube-ovn/features/lb-service/#subnet","title":"\u521b\u5efa Subnet","text":"<p>\u521b\u5efa\u7684 Subnet\uff0c\u7528\u4e8e\u7ed9 LoadBalancer Service \u5206\u914d LoadBalancerIP\uff0c\u8be5\u5730\u5740\u6b63\u5e38\u60c5\u51b5\u4e0b\u5728\u96c6\u7fa4\u5916\u5e94\u8be5\u53ef\u4ee5\u8bbf\u95ee\u5230\u3002\u53ef\u4ee5\u914d\u7f6e Underlay Subnet \u7528\u4e8e\u5730\u5740\u5206\u914d\u3002</p> <p>\u53c2\u8003\u4ee5\u4e0b yaml\uff0c\u521b\u5efa\u65b0\u5b50\u7f51\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: attach-subnet\nspec:\nprotocol: IPv4\nprovider: lb-svc-attachment.kube-system    # provider \u683c\u5f0f\u56fa\u5b9a\uff0c\u7531\u4e0a\u4e00\u6b65\u521b\u5efa\u7684 net-attach-def \u8d44\u6e90\u7684 Name.Namespace \u7ec4\u6210\ncidrBlock: 172.18.0.0/16\ngateway: 172.18.0.1\nexcludeIps:\n- 172.18.0.0..172.18.0.10\n</code></pre> <p><code>Subnet</code> \u4e2d <code>provider</code> \u53c2\u6570\u4ee5 <code>ovn</code> \u6216\u8005\u4ee5 <code>.ovn</code> \u4e3a\u540e\u7f00\u7ed3\u675f\uff0c\u8868\u793a\u8be5\u5b50\u7f51\u662f\u7531 Kube-OVN \u7ba1\u7406\u4f7f\u7528\uff0c\u9700\u8981\u5bf9\u5e94\u521b\u5efa <code>logical switch</code> \u8bb0\u5f55\u3002</p> <p>provider \u975e ovn \u6216\u8005\u975e <code>.ovn</code> \u4e3a\u540e\u7f00\u7ed3\u675f\uff0c\u5219 Kube-OVN \u53ea\u63d0\u4f9b IPAM \u529f\u80fd\uff0c\u8bb0\u5f55 IP \u5730\u5740\u5206\u914d\u60c5\u51b5\uff0c\u4e0d\u5bf9\u5b50\u7f51\u505a\u4e1a\u52a1\u903b\u8f91\u5904\u7406\u3002</p>"},{"location":"network/kube-ovn/features/lb-service/#loadbalancer-service","title":"\u521b\u5efa LoadBalancer Service","text":"<p>\u53c2\u8003\u4ee5\u4e0b yaml\uff0c\u521b\u5efa LoadBalancer Service\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\nannotations:\nlb-svc-attachment.kube-system.kubernetes.io/logical_switch: attach-subnet   #\u53ef\u9009\novn.kubernetes.io/attachmentprovider: lb-svc-attachment.kube-system          #\u5fc5\u987b\nlabels:\napp: dynamic\nname: test-service\nnamespace: default\nspec:\nloadBalancerIP: 172.18.0.18                                                   #\u53ef\u9009\nports:\n- name: test\nprotocol: TCP\nport: 80\ntargetPort: 80\nselector:\napp: dynamic\nsessionAffinity: None\ntype: LoadBalancer\n</code></pre> <p>\u5728 yaml \u4e2d\uff0c<code>annotation ovn.kubernetes.io/attachmentprovider</code> \u4e3a\u5fc5\u586b\u9879\uff0c\u53d6\u503c\u7531\u7b2c\u4e00\u6b65\u521b\u5efa\u7684 <code>net-attach-def</code> \u8d44\u6e90\u7684 Name.Namespace \u7ec4\u6210\u3002\u8be5 <code>annotation</code> \u7528\u4e8e\u5728\u521b\u5efa Pod \u65f6\uff0c\u67e5\u627e <code>net-attach-def</code> \u8d44\u6e90\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>annotation</code> \u6307\u5b9a\u591a\u7f51\u5361\u5730\u5740\u5206\u914d\u4f7f\u7528\u7684\u5b50\u7f51\u3002<code>annotation key</code> \u683c\u5f0f\u4e3a <code>net-attach-def</code> \u8d44\u6e90\u7684 <code>Name.Namespace.kubernetes.io/logical_switch</code>\u3002\u8be5\u914d\u7f6e\u4e3a\u53ef\u9009\u9009\u9879\uff0c\u5728\u6ca1\u6709\u6307\u5b9a LoadBalancerIP \u5730\u5740\u7684\u60c5\u51b5\u4e0b\uff0c\u5c06\u4ece\u8be5\u5b50\u7f51\u52a8\u6001\u5206\u914d\u5730\u5740\uff0c\u586b\u5145\u5230 LoadBalancerIP \u5b57\u6bb5\u3002</p> <p>\u5982\u679c\u9700\u8981\u9759\u6001\u914d\u7f6e LoadBalancerIP \u5730\u5740\uff0c\u53ef\u4ee5\u914d\u7f6e <code>spec.loadBalancerIP</code> \u5b57\u6bb5\uff0c\u8be5\u5730\u5740\u9700\u8981\u5728\u6307\u5b9a\u5b50\u7f51\u7684\u5730\u5740\u8303\u56f4\u5185\u3002</p> <p>\u5728\u6267\u884c yaml \u521b\u5efa Service \u540e\uff0c\u5728 Service \u540c Namespace \u4e0b\uff0c\u53ef\u4ee5\u770b\u5230 Pod \u542f\u52a8\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pod\nNAME                                      READY   STATUS    RESTARTS   AGE\nlb-svc-test-service-6869d98dd8-cjvll      1/1     Running   0          107m\n$ kubectl get svc\nNAME              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\ntest-service      LoadBalancer   10.109.201.193   172.18.0.18   80:30056/TCP   107m\n</code></pre> <p>\u6307\u5b9a <code>service.spec.loadBalancerIP</code> \u53c2\u6570\u65f6\uff0c\u6700\u7ec8\u5c06\u8be5\u53c2\u6570\u8d4b\u503c\u7ed9 <code>service external-ip</code> \u5b57\u6bb5\u3002\u4e0d\u6307\u5b9a\u7684\u60c5\u51b5\u4e0b\uff0c\u8be5\u53c2\u6570\u4e3a\u968f\u673a\u5206\u914d\u503c\u3002</p> <p>\u67e5\u770b\u6d4b\u8bd5 Pod \u7684 yaml \u8f93\u51fa\uff0c\u5b58\u5728\u591a\u7f51\u5361\u5206\u914d\u7684\u5730\u5740\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pod -o yaml lb-svc-test-service-6869d98dd8-cjvll\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    k8s.v1.cni.cncf.io/network-status: |-\n      [{\n\"name\": \"kube-ovn\",\n          \"ips\": [\n\"10.16.0.2\"\n],\n          \"default\": true,\n          \"dns\": {}\n},{\n\"name\": \"default/test-service\",\n          \"interface\": \"net1\",\n          \"mac\": \"ba:85:f7:02:9f:42\",\n          \"dns\": {}\n}]\nk8s.v1.cni.cncf.io/networks: default/test-service\n    k8s.v1.cni.cncf.io/networks-status: |-\n      [{\n\"name\": \"kube-ovn\",\n          \"ips\": [\n\"10.16.0.2\"\n],\n          \"default\": true,\n          \"dns\": {}\n},{\n\"name\": \"default/test-service\",\n          \"interface\": \"net1\",\n          \"mac\": \"ba:85:f7:02:9f:42\",\n          \"dns\": {}\n}]\novn.kubernetes.io/allocated: \"true\"\novn.kubernetes.io/cidr: 10.16.0.0/16\n    ovn.kubernetes.io/gateway: 10.16.0.1\n    ovn.kubernetes.io/ip_address: 10.16.0.2\n    ovn.kubernetes.io/logical_router: ovn-cluster\n    ovn.kubernetes.io/logical_switch: ovn-default\n    ovn.kubernetes.io/mac_address: 00:00:00:45:F4:29\n    ovn.kubernetes.io/pod_nic_type: veth-pair\n    ovn.kubernetes.io/routed: \"true\"\ntest-service.default.kubernetes.io/allocated: \"true\"\ntest-service.default.kubernetes.io/cidr: 172.18.0.0/16\n    test-service.default.kubernetes.io/gateway: 172.18.0.1\n    test-service.default.kubernetes.io/ip_address: 172.18.0.18\n    test-service.default.kubernetes.io/logical_switch: attach-subnet\n    test-service.default.kubernetes.io/mac_address: 00:00:00:AF:AA:BF\n    test-service.default.kubernetes.io/pod_nic_type: veth-pair\n</code></pre> <p>\u67e5\u770b Service \u7684\u4fe1\u606f\uff1a</p> <pre><code># kubectl get svc -o yaml test-service\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/last-applied-configuration: |\n{\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":{\"test-service.default.kubernetes.io/logical_switch\":\"attach-subnet\"},\"labels\":{\"app\":\"dynamic\"},\"name\":\"test-service\",\"namespace\":\"default\"},\"spec\":{\"ports\":[{\"name\":\"test\",\"port\":80,\"protocol\":\"TCP\",\"targetPort\":80}],\"selector\":{\"app\":\"dynamic\"},\"sessionAffinity\":\"None\",\"type\":\"LoadBalancer\"}}\novn.kubernetes.io/vpc: ovn-cluster\n    test-service.default.kubernetes.io/logical_switch: attach-subnet\n  creationTimestamp: \"2022-06-15T09:01:58Z\"\nlabels:\n    app: dynamic\n  name: test-service\n  namespace: default\n  resourceVersion: \"38485\"\nuid: 161edee1-7f6e-40f5-9e09-5a52c44267d0\nspec:\n  allocateLoadBalancerNodePorts: true\nclusterIP: 10.109.201.193\n  clusterIPs:\n  - 10.109.201.193\n  externalTrafficPolicy: Cluster\n  internalTrafficPolicy: Cluster\n  ipFamilies:\n  - IPv4\n  ipFamilyPolicy: SingleStack\n  ports:\n  - name: test\nnodePort: 30056\nport: 80\nprotocol: TCP\n    targetPort: 80\nselector:\n    app: dynamic\n  sessionAffinity: None\n  type: LoadBalancer\nstatus:\n  loadBalancer:\n    ingress:\n    - ip: 172.18.0.18\n</code></pre>"},{"location":"network/kube-ovn/features/lb-service/#loadbalancerip","title":"\u6d4b\u8bd5 LoadBalancerIP\u8bbf\u95ee","text":"<p>\u53c2\u8003\u4ee5\u4e0b yaml, \u521b\u5efa\u6d4b\u8bd5 Pod\uff0c\u4f5c\u4e3a Service \u7684 Endpoints \u63d0\u4f9b\u670d\u52a1:</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nlabels:\napp: dynamic\nname: dynamic\nnamespace: default\nspec:\nreplicas: 2\nselector:\nmatchLabels:\napp: dynamic\nstrategy:\nrollingUpdate:\nmaxSurge: 25%\nmaxUnavailable: 25%\ntype: RollingUpdate\ntemplate:\nmetadata:\ncreationTimestamp: null\nlabels:\napp: dynamic\nspec:\ncontainers:\n- image: docker.io/library/nginx:alpine\nimagePullPolicy: IfNotPresent\nname: nginx\ndnsPolicy: ClusterFirst\nrestartPolicy: Always\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u63d0\u4f9b\u7684\u5b50\u7f51\u5730\u5740\uff0c\u5728\u96c6\u7fa4\u5916\u5e94\u8be5\u53ef\u4ee5\u8bbf\u95ee\u5230\u3002\u4e3a\u4e86\u7b80\u5355\u9a8c\u8bc1\uff0c\u5728\u96c6\u7fa4\u5185\u8bbf\u95ee Service \u7684 <code>LoadBalancerIP:Port</code>\uff0c\u67e5\u770b\u662f\u5426\u6b63\u5e38\u8bbf\u95ee\u6210\u529f\u3002</p> <pre><code>$ curl 172.18.0.11:80\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Hello World!&lt;/title&gt;\n&lt;link href='//fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'&gt;\n&lt;style&gt;\nbody {\nbackground-color: white;\ntext-align: center;\npadding: 50px;\nfont-family: \"Open Sans\",\"Helvetica Neue\",Helvetica,Arial,sans-serif;\n}\n#logo {\nmargin-bottom: 40px;\n}\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Hello World!&lt;/h1&gt;\n&lt;h3&gt;Links found&lt;/h3&gt;\n&lt;h3&gt;I am on  dynamic-7d8d7874f5-hsgc4&lt;/h3&gt;\n&lt;h3&gt;Cookie                  =&lt;/h3&gt;\n&lt;b&gt;KUBERNETES&lt;/b&gt; listening in 443 available at tcp://10.96.0.1:443&lt;br /&gt;\n&lt;h3&gt;my name is hanhouchao!&lt;/h3&gt;\n&lt;h3&gt; RequestURI='/'&lt;/h3&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u8fdb\u5165 Service \u521b\u5efa\u7684 Pod\uff0c\u67e5\u770b\u7f51\u7edc\u7684\u4fe1\u606f:</p> <pre><code>$ ip a\n4: net1@if62: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default\n    link/ether ba:85:f7:02:9f:42 brd ff:ff:ff:ff:ff:ff link-netnsid 0\ninet 172.18.0.18/16 scope global net1\n       valid_lft forever preferred_lft forever\n    inet6 fe80::b885:f7ff:fe02:9f42/64 scope link\n       valid_lft forever preferred_lft forever\n36: eth0@if37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1400 qdisc noqueue state UP group default\n    link/ether 00:00:00:45:f4:29 brd ff:ff:ff:ff:ff:ff link-netnsid 0\ninet 10.16.0.2/16 brd 10.16.255.255 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::200:ff:fe45:f429/64 scope link\n       valid_lft forever preferred_lft forever\n\n$ ip rule\n0: from all lookup local\n32764: from all iif eth0 lookup 100\n32765: from all iif net1 lookup 100\n32766: from all lookup main\n32767: from all lookup default\n\n$ ip route show table 100\ndefault via 172.18.0.1 dev net1\n10.109.201.193 via 10.16.0.1 dev eth0\n172.18.0.0/16 dev net1 scope link\n\n$ iptables -t nat -L -n -v\nChain PREROUTING (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            172.18.0.18          tcp dpt:80 to:10.109.201.193:80\n\nChain INPUT (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n\nChain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)\npkts bytes target     prot opt in     out     source               destination\n    0     0 MASQUERADE  all  --  *      *       0.0.0.0/0            10.109.201.193\n</code></pre>"},{"location":"network/kube-ovn/features/manage-multiple-interface/","title":"\u591a\u7f51\u5361\u7ba1\u7406","text":"<p>Kube-OVN \u53ef\u4ee5\u4e3a\u5176\u4ed6 CNI \u7f51\u7edc\u63d2\u4ef6\uff0c\u4f8b\u5982 macvlan\u3001vlan\u3001host-device \u7b49\u63d2\u4ef6\u63d0\u4f9b\u96c6\u7fa4\u7ea7\u522b\u7684 IPAM \u80fd\u529b\uff0c \u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5230 Kube-OVN \u4e2d\u5b50\u7f51\u4ee5\u53ca\u56fa\u5b9a IP \u529f\u80fd\u3002</p> <p>\u540c\u65f6 Kube-OVN \u4e5f\u652f\u6301\u591a\u5757\u7f51\u5361\u5747\u4e3a Kube-OVN \u7c7b\u578b\u7f51\u5361\u60c5\u51b5\u4e0b\u7684\u5730\u5740\u7ba1\u7406\u3002</p>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#_1","title":"\u5de5\u4f5c\u539f\u7406","text":"<p>\u901a\u8fc7\u4f7f\u7528 Multus CNI, \u6211\u4eec\u53ef\u4ee5\u7ed9\u4e00\u4e2a Pod \u6dfb\u52a0\u591a\u5757\u4e0d\u540c\u7f51\u7edc\u7684\u7f51\u5361\u3002 \u7136\u800c\u6211\u4eec\u4ecd\u7136\u7f3a\u4e4f\u5bf9\u96c6\u7fa4\u8303\u56f4\u5185\u4e0d\u540c\u7f51\u7edc\u7684 IP \u5730\u5740\u8fdb\u884c\u7ba1\u7406\u7684\u80fd\u529b\u3002\u5728 Kube-OVN \u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u80fd\u591f\u901a\u8fc7 <code>Subnet</code> \u548c IP \u7684 CRD \u6765\u8fdb\u884c IP \u7684\u9ad8\u7ea7\u7ba1\u7406\uff0c \u4f8b\u5982\u5b50\u7f51\u7ba1\u7406\uff0cIP \u9884\u7559\uff0c\u968f\u673a\u5206\u914d\uff0c\u56fa\u5b9a\u5206\u914d\u7b49\u3002\u73b0\u5728\u6211\u4eec\u5bf9\u5b50\u7f51\u8fdb\u884c\u6269\u5c55\uff0c\u6765\u63a5\u5165\u5176\u4ed6\u4e0d\u540c\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u4f7f\u5f97\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kube-OVN \u7684 IPAM \u529f\u80fd\u3002</p>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#_2","title":"\u5de5\u4f5c\u6d41\u7a0b","text":"<p>\u4e0a\u56fe\u5c55\u793a\u4e86\u5982\u4f55\u901a\u8fc7 Kube-OVN \u6765\u7ba1\u7406\u5176\u4ed6\u7f51\u7edc\u63d2\u4ef6\u7684 IP \u5730\u5740\u3002\u5176\u4e2d\u5bb9\u5668\u7684 <code>eth0</code> \u7f51\u5361\u63a5\u5165 OVN \u7f51\u7edc\uff0c<code>net1</code> \u7f51\u5361\u63a5\u5165\u5176\u4ed6 CNI \u7f51\u7edc\u3002 <code>net1</code> \u7f51\u7edc\u7684\u7f51\u7edc\u5b9a\u4e49\u6765\u81ea\u4e8e <code>multus-cni</code> \u4e2d\u7684 <code>NetworkAttachmentDefinition</code> \u8d44\u6e90\u5b9a\u4e49\u3002</p> <p>\u5f53 Pod \u521b\u5efa\u65f6\uff0c<code>kube-ovn-controller</code> \u4f1a\u76d1\u542c\u5230 Pod \u6dfb\u52a0\u4e8b\u4ef6\uff0c\u5e76\u6839\u636e Pod \u4e2d\u7684 <code>annotation</code> \u53bb\u5bfb\u627e\u5230\u5bf9\u5e94\u7684 <code>Subnet</code> \u5e76\u4ece\u4e2d\u8fdb\u884c IP \u7684\u5206\u914d\u548c\u7ba1\u7406\uff0c \u5e76\u5c06 Pod \u6240\u5206\u914d\u5230\u7684\u5730\u5740\u4fe1\u606f\u5199\u56de\u5230 Pod <code>annotation</code> \u4e2d\u3002</p> <p>\u5728\u5bb9\u5668\u6240\u5728\u673a\u5668\u7684 CNI \u53ef\u4ee5\u901a\u8fc7\u5728\u914d\u7f6e\u4e2d\u914d\u7f6e <code>kube-ovn-cni</code> \u4f5c\u4e3a ipam \u63d2\u4ef6, <code>kube-ovn-cni</code> \u5c06\u4f1a\u8bfb\u53d6 Pod <code>annotation</code> \u5e76\u5c06\u5730\u5740\u4fe1\u606f\u901a\u8fc7 CNI \u534f\u8bae\u7684\u6807\u51c6\u683c\u5f0f\u8fd4\u56de\u7ed9\u76f8\u5e94\u7684 CNI \u63d2\u4ef6\u3002</p>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#_3","title":"\u4f7f\u7528\u65b9\u6cd5","text":""},{"location":"network/kube-ovn/features/manage-multiple-interface/#cni-ipam","title":"\u4e3a\u5176\u4ed6 CNI \u63d0\u4f9b IPAM","text":"<p>\u6b64\u65f6\u4e3b\u7f51\u5361\u4e3a Kube-OVN \u7c7b\u578b\u7f51\u5361\uff0c\u9644\u5c5e\u7f51\u5361\u4e3a\u5176\u4ed6\u7c7b\u578b CNI\u3002</p>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#_4","title":"\u521b\u5efa\u9644\u5c5e\u7f51\u5361","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528 <code>macvlan</code> \u4f5c\u4e3a\u5bb9\u5668\u7f51\u7edc\u7684\u7b2c\u4e8c\u4e2a\u7f51\u7edc\uff0c\u5e76\u5c06\u5176 <code>ipam</code> \u8bbe\u7f6e\u4e3a <code>kube-ovn</code>\uff1a</p> <pre><code>apiVersion: \"k8s.cni.cncf.io/v1\"\nkind: NetworkAttachmentDefinition\nmetadata:\nname: macvlan\nnamespace: default\nspec:\nconfig: '{\n\"cniVersion\": \"0.3.0\",\n\"type\": \"macvlan\",\n\"master\": \"eth0\",\n\"mode\": \"bridge\",\n\"ipam\": {\n\"type\": \"kube-ovn\",\n\"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\",\n\"provider\": \"macvlan.default\"\n}\n}'\n</code></pre> <ul> <li><code>spec.config.ipam.type</code>: \u9700\u8981\u4e3a kube-ovn \u6765\u8c03\u7528 kube-ovn \u7684\u63d2\u4ef6\u6765\u83b7\u53d6\u5730\u5740\u4fe1\u606f\u3002</li> <li><code>server_socket</code>: Kube-OVN \u901a\u4fe1\u4f7f\u7528\u7684 <code>socket</code> \u6587\u4ef6\u3002 \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a <code>/run/openvswitch/kube-ovn-daemon.sock</code>\u3002</li> <li><code>provider</code>: \u5f53\u524d NetworkAttachmentDefinition \u7684 <code>&lt;name&gt;.&lt;namespace&gt;</code> , Kube-OVN \u5c06\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u627e\u5230\u5bf9\u5e94\u7684 <code>Subnet</code> \u8d44\u6e90\u3002</li> </ul>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#kube-ovn","title":"\u9644\u5c5e\u7f51\u5361\u4e3a Kube-OVN \u7c7b\u578b\u7f51\u5361","text":"<p>\u6b64\u65f6\u591a\u5757\u7f51\u5361\u5747\u4e3a Kube-OVN \u7c7b\u578b\u7f51\u5361\u3002</p>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#_5","title":"\u521b\u5efa\u9644\u5c5e\u7f51\u5361","text":"<p>\u5c06 <code>provider</code> \u7684\u540e\u7f00\u8bbe\u7f6e\u4e3a <code>ovn</code>\uff1a</p> <pre><code>apiVersion: \"k8s.cni.cncf.io/v1\"\nkind: NetworkAttachmentDefinition\nmetadata:\nname: attachnet\nnamespace: default\nspec:\nconfig: '{\n\"cniVersion\": \"0.3.0\",\n\"type\": \"kube-ovn\",\n\"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\",\n\"provider\": \"attachnet.default.ovn\"\n}'\n</code></pre> <ul> <li><code>spec.config.type</code>: \u8bbe\u7f6e\u4e3a kube-ovn \u6765\u89e6\u53d1 CNI \u63d2\u4ef6\u4f7f\u7528 Kube-OVN \u5b50\u7f51\u3002</li> <li><code>server_socket</code>: Kube-OVN \u901a\u4fe1\u4f7f\u7528\u7684 <code>socket</code> \u6587\u4ef6\u3002 \u9ed8\u8ba4\u4f4d\u7f6e\u4e3a <code>/run/openvswitch/kube-ovn-daemon.sock</code>\u3002</li> <li><code>provider</code>: \u5f53\u524d NetworkAttachmentDefinition \u7684 <code>&lt;name&gt;.&lt;namespace&gt;.ovn</code> , Kube-OVN \u5c06\u4f1a\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u627e\u5230\u5bf9\u5e94\u7684 <code>Subnet</code> \u8d44\u6e90\uff0c\u6ce8\u610f\u540e\u7f00\u9700\u8981\u8bbe\u7f6e\u4e3a <code>ovn</code>\u3002</li> </ul>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#kube-ovn-subnet","title":"\u521b\u5efa\u4e00\u4e2a Kube-OVN Subnet","text":"<p>\u521b\u5efa\u4e00\u4e2a Kube-OVN Subnet,\u8bbe\u7f6e\u5bf9\u5e94\u7684 <code>cidrBlock</code> \u548c <code>exclude_ips</code>, <code>provider</code> \u5e94\u8be5\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <code>&lt;name&gt;.&lt;namespace&gt;</code>, \u4f8b\u5982\u7528 <code>macvlan</code> \u63d0\u4f9b\u9644\u52a0\u7f51\u5361\uff0c\u521b\u5efa <code>Subnet</code> \u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: macvlan\nspec:\nprotocol: IPv4\nprovider: macvlan.default\ncidrBlock: 172.17.0.0/16\ngateway: 172.17.0.1\nexcludeIps:\n- 172.17.0.0..172.17.0.10\n</code></pre> <p><code>gateway</code>, <code>private</code>, <code>nat</code> \u53ea\u5bf9 <code>provider</code> \u7c7b\u578b\u4e3a <code>ovn</code> \u7684\u7f51\u7edc\u751f\u6548\uff0c\u4e0d\u9002\u7528\u4e8e attachment network\u3002</p> <p>\u5982\u679c\u4ee5 Kube-OVN \u4f5c\u4e3a\u9644\u52a0\u7f51\u5361\uff0c\u5219 <code>provider</code> \u5e94\u8be5\u8bbe\u7f6e\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <code>&lt;name&gt;.&lt;namespace&gt;.ovn</code>\uff0c\u5e76\u8981\u4ee5 <code>ovn</code> \u4f5c\u4e3a\u540e\u7f00\u7ed3\u675f\u3002 \u7528 Kube-OVN \u63d0\u4f9b\u9644\u52a0\u7f51\u5361\uff0c\u521b\u5efa <code>Subnet</code> \u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: attachnet\nspec:\nprotocol: IPv4\nprovider: attachnet.default.ovn\ncidrBlock: 172.17.0.0/16\ngateway: 172.17.0.1\nexcludeIps:\n- 172.17.0.0..172.17.0.10\n</code></pre>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#pod","title":"\u521b\u5efa\u4e00\u4e2a\u591a\u7f51\u7edc\u7684 Pod","text":"<p>\u5bf9\u4e8e\u5730\u5740\u968f\u673a\u5206\u914d\u7684 Pod\uff0c\u53ea\u9700\u8981\u6dfb\u52a0\u5982\u4e0b <code>annotation</code> <code>k8s.v1.cni.cncf.io/networks</code>,\u53d6\u503c\u4e3a\u5bf9\u5e94\u7684 NetworkAttachmentDefinition \u7684 <code>&lt;namespace&gt;/&lt;name&gt;</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: samplepod\nnamespace: default\nannotations:\nk8s.v1.cni.cncf.io/networks: default/macvlan\nspec:\ncontainers:\n- name: samplepod\ncommand: [\"/bin/ash\", \"-c\", \"trap : TERM INT; sleep infinity &amp; wait\"]\nimage: docker.io/library/alpine:edge\n</code></pre>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#ip-pod","title":"\u521b\u5efa\u56fa\u5b9a IP \u7684 Pod","text":"<p>\u5bf9\u4e8e\u56fa\u5b9a IP \u7684 Pod\uff0c\u6dfb\u52a0 <code>&lt;networkAttachmentName&gt;.&lt;networkAttachmentNamespace&gt;.kubernetes.io/ip_address</code> annotation\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: static-ip\nnamespace: default\nannotations:\nk8s.v1.cni.cncf.io/networks: default/macvlan\novn.kubernetes.io/ip_address: 10.16.0.15\novn.kubernetes.io/mac_address: 00:00:00:53:6B:B6\nmacvlan.default.kubernetes.io/ip_address: 172.17.0.100\nmacvlan.default.kubernetes.io/mac_address: 00:00:00:53:6B:BB\nspec:\ncontainers:\n- name: static-ip\nimage: docker.io/library/nginx:alpine\n</code></pre>"},{"location":"network/kube-ovn/features/manage-multiple-interface/#ip","title":"\u521b\u5efa\u4f7f\u7528\u56fa\u5b9a IP \u7684\u5de5\u4f5c\u8d1f\u8f7d","text":"<p>\u5bf9\u4e8e\u4f7f\u7528 ippool \u7684\u5de5\u4f5c\u8d1f\u8f7d, \u6dfb\u52a0 <code>&lt;networkAttachmentName&gt;.&lt;networkAttachmentNamespace&gt;.kubernetes.io/ip_pool</code> annotations:</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nnamespace: default\nname: static-workload\nlabels:\napp: static-workload\nspec:\nreplicas: 2\nselector:\nmatchLabels:\napp: static-workload\ntemplate:\nmetadata:\nlabels:\napp: static-workload\nannotations:\nk8s.v1.cni.cncf.io/networks: default/macvlan\novn.kubernetes.io/ip_pool: 10.16.0.15,10.16.0.16,10.16.0.17\nmacvlan.default.kubernetes.io/ip_pool: 172.17.0.200,172.17.0.201,172.17.0.202\nspec:\ncontainers:\n- name: static-workload\nimage: docker.io/library/nginx:alpine\n</code></pre>"},{"location":"network/kube-ovn/features/securityGroup/","title":"\u5b89\u5168\u7ec4\u914d\u7f6e","text":"<p>Kube-OVN \u652f\u6301\u4e86\u5b89\u5168\u7ec4\u7684\u914d\u7f6e\uff0c\u914d\u7f6e\u5b89\u5168\u7ec4\u4f7f\u7528\u7684 CRD \u4e3a <code>SecurityGroup</code>\u3002</p>"},{"location":"network/kube-ovn/features/securityGroup/#_1","title":"\u5b89\u5168\u7ec4\u4f7f\u7528","text":"<p>\u4f8b\u5b50</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: SecurityGroup\nmetadata:\nname: sg-example\nspec:\nallowSameGroupTraffic: true\negressRules:\n- ipVersion: ipv4\npolicy: allow\npriority: 1\nprotocol: all\nremoteAddress: 10.16.0.13/16\nremoteType: address\ningressRules:\n- ipVersion: ipv4\npolicy: deny\npriority: 1\nprotocol: icmp\nremoteAddress: 10.16.0.14/16\nremoteType: address\n</code></pre> <p>\u5b89\u5168\u7ec4\u5404\u5b57\u6bb5\u7684\u5177\u4f53\u542b\u4e49\u5982\u4e0b\uff1a</p> <code>securityGroupSpec</code>\u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>ingressRules</code> \u5165\u65b9\u5411\u5b89\u5168\u7ec4\u89c4\u5219 <code>egressRules</code> \u51fa\u65b9\u5411\u5b89\u5168\u7ec4\u89c4\u5219 <code>allowSameGroupTraffic</code> \u540c\u4e00\u5b89\u5168\u7ec4\u5185\u7684 lsp \u662f\u5426\u53ef\u4ee5\u4e92\u901a\uff0c\u4ee5\u53ca\u6d41\u91cf\u89c4\u5219\u662f\u5426\u9700\u8981\u66f4\u65b0 <code>SgRule</code>\u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>ipVersion</code> IP \u7248\u672c\u53f7\uff0c\u53d6\u503c\u4e3a <code>ipv4</code> \u6216\u8005 <code>ipv6</code> <code>protocol</code> \u53d6\u503c\u4e3a <code>all</code>\u3001<code>icmp</code>\u3001<code>tcp</code> \u6216\u8005 <code>udp</code> <code>priority</code> Int Acl \u4f18\u5148\u7ea7\uff0c\u53d6\u503c\u8303\u56f4\u4e3a 1-200\uff0c\u6570\u503c\u8d8a\u5c0f\uff0c\u4f18\u5148\u7ea7\u8d8a\u9ad8 <code>remoteType</code> \u53d6\u503c\u4e3a <code>address</code> \u6216\u8005 <code>securityGroup</code> <code>remoteAddress</code> \u5bf9\u7aef\u5730\u5740 <code>remoteSecurityGroup</code> \u5bf9\u7aef\u5b89\u5168\u7ec4 <code>portRangeMin</code> \u7aef\u53e3\u8303\u56f4\u8d77\u59cb\u503c\uff0c\u6700\u5c0f\u53d6\u503c\u4e3a 1 <code>portRangeMax</code> Int \u7aef\u53e3\u8303\u56f4\u6700\u5927\u503c\uff0c\u6700\u5927\u53d6\u503c\u4e3a <code>65535</code> <code>policy</code> \u53d6\u503c\u4e3a <code>allow</code> \u6216\u8005 <code>drop</code> <p>Pod \u901a\u8fc7\u6dfb\u52a0 <code>annotation</code> \u6765\u7ed1\u5b9a\u5b89\u5168\u7ec4\uff0c\u4f7f\u7528\u7684 <code>annotation</code> \u6709\u4e24\u4e2a\uff1a</p> <pre><code>    ovn.kubernetes.io/port_security: \"true\"\novn.kubernetes.io/security_groups: sg-example\n</code></pre>"},{"location":"network/kube-ovn/features/securityGroup/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5b89\u5168\u7ec4\u6700\u540e\u662f\u901a\u8fc7\u8bbe\u7f6e ACL \u89c4\u5219\u6765\u9650\u5236\u8bbf\u95ee\u7684\uff0cOVN \u6587\u6863\u4e2d\u63d0\u5230\uff0c\u5982\u679c\u5339\u914d\u5230\u7684\u4e24\u4e2a ACL \u89c4\u5219\u62e5\u6709\u76f8\u540c\u7684\u4f18\u5148\u7ea7\uff0c\u5b9e\u9645\u8d77\u4f5c\u7528\u7684\u662f\u54ea\u4e2a ACL \u662f\u4e0d\u786e\u5b9a\u7684\u3002\u56e0\u6b64\u8bbe\u7f6e\u5b89\u5168\u7ec4\u89c4\u5219\u7684\u65f6\u5019\uff0c\u9700\u8981\u6ce8\u610f\u533a\u5206\u4f18\u5148\u7ea7\u3002</p> <p>\u5f53\u6dfb\u52a0\u5b89\u5168\u7ec4\u7684\u65f6\u5019\uff0c\u8981\u6e05\u695a\u7684\u77e5\u9053\u662f\u5728\u6dfb\u52a0\u4ec0\u4e48\u9650\u5236\u3002Kube-OVN \u4f5c\u4e3a CNI\uff0c\u521b\u5efa Pod \u540e\u4f1a\u8fdb\u884c Pod \u5230\u7f51\u5173\u7684\u8fde\u901a\u6027\u6d4b\u8bd5\uff0c\u5982\u679c\u8bbf\u95ee\u4e0d\u901a\u7f51\u5173\uff0c\u5c31\u4f1a\u5bfc\u81f4 Pod \u4e00\u76f4\u5904\u4e8e <code>ContainerCreating</code> \u72b6\u6001\uff0c\u65e0\u6cd5\u987a\u5229\u5207\u6362\u5230 <code>Running</code> \u72b6\u6001\u3002</p>"},{"location":"network/kube-ovn/features/securityGroup/#_3","title":"\u5b9e\u9645\u6d4b\u8bd5","text":"<p>\u5229\u7528\u4ee5\u4e0b yaml \u521b\u5efa Pod\uff0c\u5728 <code>annotation</code> \u4e2d\u6307\u5b9a\u7ed1\u5b9a\u793a\u4f8b\u4e2d\u7684\u5b89\u5168\u7ec4\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\napp: static\nannotations:\novn.kubernetes.io/port_security: 'true'\novn.kubernetes.io/security_groups: 'sg-example'\nname: sg-test-pod\nnamespace: default\nspec:\nnodeName: kube-ovn-worker\ncontainers:\n- image: docker.io/library/nginx:alpine\nimagePullPolicy: IfNotPresent\nname: qatest\n</code></pre> <p>\u5b9e\u9645\u6d4b\u8bd5\u7ed3\u679c\u663e\u793a\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl get pod -o wide\nNAME                   READY   STATUS              RESTARTS   AGE     IP           NODE                     NOMINATED NODE   READINESS GATES\nsg-test-pod            0/1     ContainerCreating   0          5h32m   &lt;none&gt;       kube-ovn-worker          &lt;none&gt;           &lt;none&gt;\ntest-99fff7f86-52h9r   1/1     Running             0          5h41m   10.16.0.14   kube-ovn-control-plane   &lt;none&gt;           &lt;none&gt;\ntest-99fff7f86-qcgjw   1/1     Running             0          5h43m   10.16.0.13   kube-ovn-worker          &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6267\u884c <code>kubectl describe pod</code> \u67e5\u770b Pod \u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u770b\u5230\u62a5\u9519\u63d0\u793a\uff1a</p> <pre><code># kubectl describe pod sg-test-pod\nName:         sg-test-pod\nNamespace:    default\nPriority:     0\nNode:         kube-ovn-worker/172.18.0.2\nStart Time:   Tue, 28 Feb 2023 10:29:36 +0800\nLabels:       app=static\nAnnotations:  ovn.kubernetes.io/allocated: true\novn.kubernetes.io/cidr: 10.16.0.0/16\n              ovn.kubernetes.io/gateway: 10.16.0.1\n              ovn.kubernetes.io/ip_address: 10.16.0.15\n              ovn.kubernetes.io/logical_router: ovn-cluster\n              ovn.kubernetes.io/logical_switch: ovn-default\n              ovn.kubernetes.io/mac_address: 00:00:00:FA:17:97\n              ovn.kubernetes.io/pod_nic_type: veth-pair\n              ovn.kubernetes.io/port_security: true\novn.kubernetes.io/routed: true\novn.kubernetes.io/security_groups: sg-allow-reject\nStatus:       Pending\nIP:\nIPs:          &lt;none&gt;\n\u00b7\n\u00b7\n\u00b7\nEvents:\n  Type     Reason                  Age                    From     Message\n  ----     ------                  ----                   ----     -------\n  Warning  FailedCreatePodSandBox  5m3s (x70 over 4h59m)  kubelet  (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to setup network for sandbox \"40636e0c7f1ade5500fa958486163d74f2e2300051a71522a9afd7ba0538afb6\": plugin type=\"kube-ovn\" failed (add): RPC failed; request ip return 500 configure nic failed 10.16.0.15 network not ready after 200 ping 10.16.0.1\n</code></pre> <p>\u4fee\u6539\u5b89\u5168\u7ec4\u7684\u89c4\u5219\uff0c\u6dfb\u52a0\u5230\u7f51\u5173\u7684\u8bbf\u95ee\u89c4\u5219\uff0c\u53c2\u8003\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: SecurityGroup\nmetadata:\nname: sg-gw-both\nspec:\nallowSameGroupTraffic: true\negressRules:\n- ipVersion: ipv4\npolicy: allow\npriority: 2\nprotocol: all\nremoteAddress: 10.16.0.13/16\nremoteType: address\n- ipVersion: ipv4\npolicy: allow\npriority: 1\nprotocol: all\nremoteAddress: 10.16.0.1/16\nremoteType: address\ningressRules:\n- ipVersion: ipv4\npolicy: deny\npriority: 2\nprotocol: icmp\nremoteAddress: 10.16.0.14/16\nremoteType: address\n- ipVersion: ipv4\npolicy: allow\npriority: 1\nprotocol: icmp\nremoteAddress: 10.16.0.1/16\nremoteType: address\n</code></pre> <p>\u5206\u522b\u5728\u5165\u65b9\u5411\u548c\u51fa\u65b9\u5411\u89c4\u5219\u4e2d\uff0c\u6dfb\u52a0\u5141\u8bb8\u5230\u7f51\u5173\u7684\u8bbf\u95ee\u89c4\u5219\uff0c\u5e76\u4e14\u8bbe\u7f6e\u8be5\u89c4\u5219\u7684\u4f18\u5148\u7ea7\u6700\u9ad8\u3002</p> <p>\u5229\u7528\u4ee5\u4e0b yaml \u7ed1\u5b9a\u5b89\u5168\u7ec4\uff0c\u90e8\u7f72 Pod \u540e\uff0c\u786e\u8ba4 Pod \u53ef\u4ee5\u6b63\u5e38\u8fd0\u884c\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nlabels:\napp: static\nannotations:\novn.kubernetes.io/port_security: 'true'\novn.kubernetes.io/security_groups: 'sg-gw-both'\nname: sg-gw-both\nnamespace: default\nspec:\nnodeName: kube-ovn-worker\ncontainers:\n- image: docker.io/library/nginx:alpine\nimagePullPolicy: IfNotPresent\nname: qatest\n</code></pre> <p>\u90e8\u7f72\u540e\u67e5\u770b Pod \u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pod -o wide\nNAME                   READY   STATUS              RESTARTS   AGE     IP           NODE                     NOMINATED NODE   READINESS GATES\nsg-test-pod            0/1     ContainerCreating   0          5h41m   &lt;none&gt;       kube-ovn-worker          &lt;none&gt;           &lt;none&gt;\nsg-gw-both             1/1     Running             0          5h37m   10.16.0.19   kube-ovn-worker          &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u56e0\u6b64\u5bf9\u4e8e\u5b89\u5168\u7ec4\u7684\u4f7f\u7528\uff0c\u8981\u7279\u522b\u660e\u786e\u6dfb\u52a0\u7684\u9650\u5236\u89c4\u5219\u7684\u4f5c\u7528\u3002\u5982\u679c\u5355\u7eaf\u662f\u9650\u5236\u6d41\u91cf\u8bbf\u95ee\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u7f51\u7edc\u7b56\u7565\u5b9e\u73b0\u3002</p>"},{"location":"network/kube-ovn/features/subnet/","title":"\u5b50\u7f51\u914d\u7f6e","text":"<p>\u5b50\u7f51</p> <p>\u5b50\u7f51\u662f Kube-OVN \u4e2d\u7684\u4e00\u4e2a\u6838\u5fc3\u6982\u5ff5\u548c\u57fa\u672c\u4f7f\u7528\u5355\u5143\uff0cKube-OVN \u4f1a\u4ee5\u5b50\u7f51\u6765\u7ec4\u7ec7 IP \u548c\u7f51\u7edc\u914d\u7f6e\uff0c\u6bcf\u4e2a Namespace \u53ef\u4ee5\u5f52\u5c5e\u4e8e\u7279\u5b9a\u7684\u5b50\u7f51\uff0c Namespace \u4e0b\u7684 Pod \u4f1a\u81ea\u52a8\u4ece\u6240\u5c5e\u7684\u5b50\u7f51\u4e2d\u83b7\u53d6 IP \u5e76\u5171\u4eab\u5b50\u7f51\u7684\u7f51\u7edc\u914d\u7f6e\uff08CIDR\uff0c\u7f51\u5173\u7c7b\u578b\uff0c\u8bbf\u95ee\u63a7\u5236\uff0cNAT \u63a7\u5236\u7b49\uff09\u3002</p> <p>\u548c\u5176\u4ed6 CNI \u7684\u6bcf\u4e2a\u8282\u70b9\u7ed1\u5b9a\u4e00\u4e2a\u5b50\u7f51\u7684\u5b9e\u73b0\u4e0d\u540c\uff0c\u5728 Kube-OVN \u4e2d\u5b50\u7f51\u4e3a\u4e00\u4e2a\u5168\u5c40\u7684\u865a\u62df\u7f51\u7edc\u914d\u7f6e\uff0c\u540c\u4e00\u4e2a\u5b50\u7f51\u7684\u5730\u5740\u53ef\u4ee5\u5206\u5e03\u5728\u4efb\u610f\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002</p> <p></p>"},{"location":"network/kube-ovn/features/subnet/#_1","title":"\u9ed8\u8ba4\u5b50\u7f51","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u7528\u6237\u7684\u5feb\u901f\u4e0a\u624b\u4f7f\u7528\uff0cKube-OVN \u5185\u7f6e\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u5b50\u7f51\uff0c\u6240\u6709\u672a\u663e\u5f0f\u58f0\u660e\u5b50\u7f51\u5f52\u5c5e\u7684 Namespace \u4f1a\u81ea\u52a8\u4ece\u9ed8\u8ba4\u5b50\u7f51\u4e2d\u5206\u914d IP\uff0c \u5e76\u4f7f\u7528\u9ed8\u8ba4\u5b50\u7f51\u7684\u7f51\u7edc\u4fe1\u606f\u3002\u8be5\u5b50\u7f51\u7684\u914d\u7f6e\u4e3a\u5b89\u88c5\u65f6\u6307\u5b9a\uff0c\u53ef\u4ee5\u53c2\u8003\u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e\uff0c \u5982\u679c\u8981\u5728\u5b89\u88c5\u540e\u4fee\u6539\u9ed8\u8ba4\u7f51\u7edc\u7684 CIDR \u8bf7\u53c2\u8003\u4fee\u6539\u9ed8\u8ba4\u7f51\u7edc\u3002</p> <p>\u5728 Overlay \u6a21\u5f0f\u4e0b\uff0c\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u4e86\u5206\u5e03\u5f0f\u7f51\u5173\u5e76\u5bf9\u51fa\u7f51\u6d41\u91cf\u8fdb\u884c NAT \u8f6c\u6362\uff0c\u5176\u884c\u4e3a\u548c Flannel \u7684\u9ed8\u8ba4\u884c\u4e3a\u57fa\u672c\u4e00\u81f4\uff0c \u7528\u6237\u65e0\u9700\u989d\u5916\u7684\u914d\u7f6e\u5373\u53ef\u4f7f\u7528\u5230\u5927\u90e8\u5206\u7684\u7f51\u7edc\u529f\u80fd\u3002</p> <p>\u5728 Underlay \u6a21\u5f0f\u4e0b\uff0c\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528\u7269\u7406\u7f51\u5173\u4f5c\u4e3a\u51fa\u7f51\u7f51\u5173\uff0c\u5e76\u5f00\u542f <code>arping</code> \u68c0\u67e5\u7f51\u7edc\u8fde\u901a\u6027\u3002</p>"},{"location":"network/kube-ovn/features/subnet/#_2","title":"\u67e5\u770b\u9ed8\u8ba4\u5b50\u7f51","text":"<p>\u9ed8\u8ba4\u5b50\u7f51 <code>spec</code> \u4e2d\u7684 <code>default</code> \u5b57\u6bb5\u4e3a <code>true</code>\uff0c\u4e00\u4e2a\u96c6\u7fa4\u4e0b\u53ea\u6709\u4e00\u4e2a\u9ed8\u8ba4\u5b50\u7f51\uff0c\u9ed8\u8ba4\u540d\u4e3a ovn-default\u3002</p> <p>\u67e5\u770b\u9ed8\u8ba4\u5b50\u7f51\uff1a</p> <pre><code>$ kubectl get subnet ovn-default -o yaml\napiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\n  creationTimestamp: \"2019-08-06T09:33:43Z\"\ngeneration: 1\nname: ovn-default\n  resourceVersion: \"1571334\"\nselfLink: /apis/kubeovn.io/v1/subnets/ovn-default\n  uid: 7e2451f8-fb44-4f7f-b3e0-cfd27f6fd5d6\nspec:\n  cidrBlock: 10.16.0.0/16\n  default: true\nexcludeIps:\n  - 10.16.0.1\n  gateway: 10.16.0.1\n  gatewayType: distributed\n  natOutgoing: true\nprivate: false\nprotocol: IPv4\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#cidr","title":"\u4fee\u6539\u5b50\u7f51 CIDR","text":"<p>\u6ce8\u610f</p> <p>\u4fee\u6539\u5b50\u7f51 CIDR \u540e\u4e4b\u524d\u521b\u5efa\u7684 Pod \u5c06\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u7f51\u7edc\u9700\u8981\u8fdb\u884c\u91cd\u5efa\u3002 \u5efa\u8bae\u64cd\u4f5c\u524d\u614e\u91cd\u8003\u8651\u3002\u672c\u6587\u53ea\u9488\u5bf9\u4e1a\u52a1\u5b50\u7f51 CIDR \u66f4\u6539\u8fdb\u884c\u64cd\u4f5c\uff0c\u5982\u9700 \u66f4\u6539 Join \u5b50\u7f51 CIDR \u8bf7\u53c2\u8003\u66f4\u6539 Join \u5b50\u7f51 CIDR\u3002</p>"},{"location":"network/kube-ovn/features/subnet/#_3","title":"\u7f16\u8f91\u5b50\u7f51","text":"<p>\u4f7f\u7528 <code>kubectl edit</code> \u4fee\u6539\u5b50\u7f51 <code>cidrBlock</code>\uff0c<code>gateway</code> \u548c <code>excludeIps</code>\u3002</p> <pre><code>kubectl edit subnet test-subnet\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#namespace-pod","title":"\u91cd\u5efa\u8be5\u5b50\u7f51\u7ed1\u5b9a\u7684 Namespace \u4e0b\u6240\u6709 Pod","text":"<p>\u4ee5\u5b50\u7f51\u7ed1\u5b9a <code>test</code> Namespace \u4e3a\u4f8b\uff1a <pre><code>for pod in $(kubectl get pod --no-headers -n \"$ns\" --field-selector spec.restartPolicy=Always -o custom-columns=NAME:.metadata.name,HOST:spec.hostNetwork | awk '{if ($2!=\"true\") print $1}'); do\nkubectl delete pod \"$pod\" -n test --ignore-not-found\ndone\n</code></pre></p> <p>\u82e5\u53ea\u4f7f\u7528\u4e86\u9ed8\u8ba4\u5b50\u7f51\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u5220\u9664\u6240\u6709\u975e host \u7f51\u7edc\u6a21\u5f0f\u7684 Pod\uff1a</p> <pre><code>for ns in $(kubectl get ns --no-headers -o custom-columns=NAME:.metadata.name); do\nfor pod in $(kubectl get pod --no-headers -n \"$ns\" --field-selector spec.restartPolicy=Always -o custom-columns=NAME:.metadata.name,HOST:spec.hostNetwork | awk '{if ($2!=\"true\") print $1}'); do\nkubectl delete pod \"$pod\" -n \"$ns\" --ignore-not-found\n  done\ndone\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#_4","title":"\u66f4\u6539\u9ed8\u8ba4\u5b50\u7f51\u914d\u7f6e","text":"<p>\u82e5\u4fee\u6539\u7684\u4e3a\u9ed8\u8ba4\u5b50\u7f51\u7684 CIDR \u8fd8\u9700\u8981\u66f4\u6539 <code>kube-ovn-controller</code> Deployment \u7684\u542f\u52a8\u53c2\u6570\uff1a</p> <pre><code>args:\n- --default-cidr=10.17.0.0/16\n- --default-gateway=10.17.0.1\n- --default-exclude-ips=10.17.0.1\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#join","title":"Join \u5b50\u7f51","text":"<p>\u5728 Kubernetes \u7684\u7f51\u7edc\u89c4\u8303\u4e2d\uff0c\u8981\u6c42 Node \u53ef\u4ee5\u548c\u6240\u6709\u7684 Pod \u76f4\u63a5\u901a\u4fe1\u3002 \u4e3a\u4e86\u5728 Overlay \u7f51\u7edc\u6a21\u5f0f\u4e0b\u8fbe\u5230\u8fd9\u4e2a\u76ee\u7684\uff0c Kube-OVN \u521b\u5efa\u4e86\u4e00\u4e2a <code>join</code> \u5b50\u7f51\uff0c \u5e76\u5728\u6bcf\u4e2a Node \u8282\u70b9\u521b\u5efa\u4e86\u4e00\u5757\u865a\u62df\u7f51\u5361 <code>ovn0</code> \u63a5\u5165 join \u5b50\u7f51\uff0c\u901a\u8fc7\u8be5\u7f51\u7edc\u5b8c\u6210\u8282\u70b9\u548c Pod \u4e4b\u95f4\u7684\u7f51\u7edc\u4e92\u901a\u3002</p> <p>\u8be5\u5b50\u7f51\u7684\u914d\u7f6e\u4e3a\u5b89\u88c5\u65f6\u6307\u5b9a\uff0c\u53ef\u4ee5\u53c2\u8003\u5185\u7f6e\u7f51\u7edc\u8bbe\u7f6e\uff0c\u5982\u679c\u8981\u5728\u5b89\u88c5\u540e\u4fee\u6539\u3002 <code>join</code> \u5b50\u7f51\u7684 CIDR \u8bf7\u53c2\u8003\u4fee\u6539 Join \u5b50\u7f51</p>"},{"location":"network/kube-ovn/features/subnet/#join_1","title":"\u67e5\u770b Join \u5b50\u7f51","text":"<p>\u8be5\u5b50\u7f51\u9ed8\u8ba4\u540d\u4e3a <code>join</code> \u4e00\u822c\u65e0\u9700\u5bf9\u8be5\u5b50\u7f51 CIDR \u5916\u7684\u5176\u4ed6\u7f51\u7edc\u914d\u7f6e\u8fdb\u884c\u4fee\u6539\u3002</p> <p><pre><code>$ kubectl get subnet join -o yaml\napiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\n  creationTimestamp: \"2019-08-06T09:33:43Z\"\ngeneration: 1\nname: join\n  resourceVersion: \"1571333\"\nselfLink: /apis/kubeovn.io/v1/subnets/join\n  uid: 9c744810-c678-4d50-8a7d-b8ec12ef91b8\nspec:\n  cidrBlock: 100.64.0.0/16\n  default: false\nexcludeIps:\n  - 100.64.0.1\n  gateway: 100.64.0.1\n  gatewayNode: \"\"\ngatewayType: \"\"\nnatOutgoing: false\nprivate: false\nprotocol: IPv4\n</code></pre> \u5728 node \u8282\u70b9\u67e5\u770b <code>ovn0</code> \u7f51\u5361\uff1a</p> <pre><code>$ **ifconfig ovn0\novn0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1420\ninet 100.64.0.4  netmask 255.255.0.0  broadcast 100.64.255.255\n        inet6 fe80::800:ff:fe40:5  prefixlen 64  scopeid 0x20&lt;link&gt;\n        ether 0a:00:00:40:00:05  txqueuelen 1000  (Ethernet)\nRX packets 18  bytes 1428 (1.3 KiB)\nRX errors 0  dropped 0  overruns 0  frame 0\nTX packets 19  bytes 1810 (1.7 KiB)\nTX errors 0  dropped 0 overruns 0  carrier 0  collisions 0**\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#join-cidr","title":"\u4fee\u6539 Join \u5b50\u7f51 CIDR","text":"<p>\u6ce8\u610f</p> <p>\u4fee\u6539 Join \u5b50\u7f51 CIDR \u540e\u4e4b\u524d\u521b\u5efa\u7684 Pod \u5c06\u65e0\u6cd5\u6b63\u5e38\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\uff0c\u9700\u8981\u7b49\u91cd\u5efa\u5b8c\u6210, \u5efa\u8bae\u524d\u64cd\u4f5c\u65f6\u614e\u91cd\u8003\u8651\u3002</p>"},{"location":"network/kube-ovn/features/subnet/#join_2","title":"\u5220\u9664 Join \u5b50\u7f51","text":"<pre><code>kubectl patch subnet join --type='json' -p '[{\"op\": \"replace\", \"path\": \"/metadata/finalizers\", \"value\": []}]'\nkubectl delete subnet join\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#_5","title":"\u6e05\u7406\u76f8\u5173\u5206\u914d\u4fe1\u606f","text":"<pre><code>kubectl annotate node ovn.kubernetes.io/allocated=false --all --overwrite\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#join_3","title":"\u4fee\u6539 Join \u5b50\u7f51\u76f8\u5173\u4fe1\u606f","text":"<p>\u4fee\u6539 <code>kube-ovn-controller</code> \u5185 Join \u5b50\u7f51\u76f8\u5173\u4fe1\u606f\uff1a</p> <pre><code>kubectl edit deployment -n kube-system kube-ovn-controller\n</code></pre> <p>\u4fee\u6539\u4e0b\u5217\u53c2\u6570:</p> <pre><code>args:\n- --node-switch-cidr=100.51.0.0/16\n</code></pre> <p>\u91cd\u542f <code>kube-ovn-controller</code> \u91cd\u5efa <code>join</code> \u5b50\u7f51\uff1a</p> <pre><code>kubectl delete pod -n kube-system -lapp=kube-ovn-controller\n</code></pre> <p>\u67e5\u770b\u65b0\u7684 Join \u5b50\u7f51\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get subnet\nNAME          PROVIDER   VPC           PROTOCOL   CIDR            PRIVATE   NAT     DEFAULT   GATEWAYTYPE   V4USED   V4AVAILABLE   V6USED   V6AVAILABLE   EXCLUDEIPS\njoin          ovn        ovn-cluster   IPv4       100.51.0.0/16   false     false   false     distributed   2        65531         0        0             [\"100.51.0.1\"]\novn-default   ovn        ovn-cluster   IPv4       10.17.0.0/16    false     true    true      distributed   5        65528         0        0             [\"10.17.0.1\"]\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#ovn0","title":"\u91cd\u65b0\u914d\u7f6e ovn0 \u7f51\u5361\u5730\u5740","text":"<p>\u6bcf\u4e2a\u8282\u70b9\u7684 <code>ovn0</code> \u7f51\u5361\u4fe1\u606f\u9700\u8981\u91cd\u65b0\u66f4\u65b0\uff0c\u53ef\u901a\u8fc7\u91cd\u542f <code>kube-ovn-cni</code> \u6765\u5b8c\u6210\uff1a</p> <pre><code>kubectl delete pod -n kube-system -l app=kube-ovn-cni\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#_6","title":"\u521b\u5efa\u81ea\u5b9a\u4e49\u5b50\u7f51","text":""},{"location":"network/kube-ovn/features/subnet/#_7","title":"\u521b\u5efa\u5b50\u7f51","text":"<pre><code>cat &lt;&lt;EOF | kubectl create -f -\napiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\n  name: subnet1\nspec:\n  protocol: IPv4\n  cidrBlock: 10.66.0.0/16\n  excludeIps:\n  - 10.66.0.1..10.66.0.10\n  - 10.66.0.101..10.66.0.151\n  gateway: 10.66.0.1\n  gatewayType: distributed\n  natOutgoing: true\n  routeTable: \"\"\n  namespaces:\n  - ns1\n  - ns2\nEOF\n</code></pre> <p>\u90e8\u5206<code>subnetSpec</code>\u53c2\u6570\u63cf\u8ff0\u5982\u4e0b\uff1a</p> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>cidrBlock</code> \u5b50\u7f51 CIDR \u8303\u56f4\uff0c\u540c\u4e00\u4e2a VPC \u4e0b\u7684\u4e0d\u540c Subnet CIDR \u4e0d\u80fd\u91cd\u53e0\u3002 <code>excludeIps</code> \u4fdd\u7559\u5730\u5740\u5217\u8868\uff0c\u5bb9\u5668\u7f51\u7edc\u5c06\u4e0d\u4f1a\u81ea\u52a8\u5206\u914d\u5217\u8868\u5185\u7684\u5730\u5740\uff0c\u53ef\u7528\u505a\u56fa\u5b9a IP \u5730\u5740\u5206\u914d\u6bb5\uff0c\u4e5f\u53ef\u5728 Underlay \u6a21\u5f0f\u4e0b\u907f\u514d\u548c\u7269\u7406\u7f51\u7edc\u4e2d\u5df2\u6709\u8bbe\u5907\u51b2\u7a81\u3002 <code>gateway</code> \u8be5\u5b50\u7f51\u7f51\u5173\u5730\u5740\uff0cOverlay \u6a21\u5f0f\u4e0b Kube-OVN \u4f1a\u81ea\u52a8\u5206\u914d\u5bf9\u5e94\u7684\u903b\u8f91\u7f51\u5173\uff0cUnderlay \u6a21\u5f0f\u4e0b\u8be5\u5730\u5740\u9700\u4e3a\u5e95\u5c42\u7269\u7406\u7f51\u5173\u5730\u5740\u3002 <code>namespaces</code> \u7ed1\u5b9a\u8be5\u5b50\u7f51\u7684 Namespace \u5217\u8868\uff0c\u7ed1\u5b9a\u540e Namespace \u4e0b\u7684 Pod \u5c06\u4f1a\u4ece\u5f53\u524d\u5b50\u7f51\u5206\u914d\u5730\u5740\u3002 <code>routeTable</code> \u5173\u8054\u7684\u8def\u7531\u8868\uff0c\u9ed8\u8ba4\u5173\u8054\u4e3b\u8def\u7531\u8868\uff0c\u8def\u7531\u8868\u5b9a\u4e49\u8bf7\u53c2\u8003\u9759\u6001\u8def\u7531"},{"location":"network/kube-ovn/features/subnet/#_8","title":"\u9a8c\u8bc1\u5b50\u7f51\u7ed1\u5b9a\u751f\u6548","text":"<pre><code>$ kubectl create ns ns1\nnamespace/ns1 created\n\n$ kubectl run nginx --image=docker.io/library/nginx:alpine -n ns1\ndeployment.apps/nginx created\n\n$ kubectl get pod -n ns1 -o wide\nNAME                     READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES\nnginx-74d5899f46-n8wtg   1/1     Running   0          10s   10.66.0.11   node1   &lt;none&gt;           &lt;none&gt;\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#overlay","title":"Overlay \u5b50\u7f51\u7f51\u5173","text":"<p>\u6ce8\u610f</p> <p>\u8be5\u529f\u80fd\u53ea\u5bf9 Overlay \u6a21\u5f0f\u5b50\u7f51\u751f\u6548\uff0cUnderlay \u7c7b\u578b\u5b50\u7f51\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u9700\u8981\u501f\u52a9\u5e95\u5c42\u7269\u7406\u7f51\u5173\u3002</p> <p>Overlay \u5b50\u7f51\u4e0b\u7684 Pod \u9700\u8981\u901a\u8fc7\u7f51\u5173\u6765\u8bbf\u95ee\u96c6\u7fa4\u5916\u90e8\u7f51\u7edc\uff0cKube-OVN \u76ee\u524d\u652f\u6301\u4e24\u79cd\u7c7b\u578b\u7684\u7f51\u5173\uff1a \u5206\u5e03\u5f0f\u7f51\u5173\u548c\u96c6\u4e2d\u5f0f\u7f51\u5173\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u5b50\u7f51\u4e2d\u5bf9\u7f51\u5173\u7684\u7c7b\u578b\u8fdb\u884c\u8c03\u6574\u3002</p> <p>\u4e24\u79cd\u7c7b\u578b\u7f51\u5173\u5747\u652f\u6301 <code>natOutgoing</code> \u8bbe\u7f6e\uff0c\u7528\u6237\u53ef\u4ee5\u9009\u62e9 Pod \u8bbf\u95ee\u5916\u7f51\u65f6\u662f\u5426\u9700\u8981\u8fdb\u884c <code>snat</code>\u3002</p>"},{"location":"network/kube-ovn/features/subnet/#_9","title":"\u5206\u5e03\u5f0f\u7f51\u5173","text":"<p>\u5b50\u7f51\u7684\u9ed8\u8ba4\u7c7b\u578b\u7f51\u5173\uff0c\u6bcf\u4e2a node \u4f1a\u4f5c\u4e3a\u5f53\u524d node \u4e0a pod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u7684\u7f51\u5173\u3002 \u6570\u636e\u5305\u4f1a\u901a\u8fc7\u672c\u673a\u7684 <code>ovn0</code> \u7f51\u5361\u6d41\u5165\u4e3b\u673a\u7f51\u7edc\u6808\uff0c\u518d\u6839\u636e\u4e3b\u673a\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u51fa\u7f51\u3002 \u5f53 <code>natOutgoing</code> \u4e3a <code>true</code> \u65f6\uff0cPod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u5c06\u4f1a\u4f7f\u7528\u5f53\u524d\u6240\u5728\u5bbf\u4e3b\u673a\u7684 IP\u3002</p> <p></p> <p>\u5b50\u7f51\u793a\u4f8b\uff0c\u5176\u4e2d <code>gatewayType</code> \u5b57\u6bb5\u4e3a <code>distributed</code>\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: distributed\nspec:\nprotocol: IPv4\ncidrBlock: 10.166.0.0/16\ndefault: false\nexcludeIps:\n- 10.166.0.1\ngateway: 10.166.0.1\ngatewayType: distributed\nnatOutgoing: true\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#_10","title":"\u96c6\u4e2d\u5f0f\u7f51\u5173","text":"<p>\u5982\u679c\u5e0c\u671b\u5b50\u7f51\u5185\u6d41\u91cf\u8bbf\u95ee\u5916\u7f51\u4f7f\u7528\u56fa\u5b9a\u7684 IP\uff0c\u4ee5\u4fbf\u5ba1\u8ba1\u548c\u767d\u540d\u5355\u7b49\u5b89\u5168\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5728\u5b50\u7f51\u4e2d\u8bbe\u7f6e\u7f51\u5173\u7c7b\u578b\u4e3a\u96c6\u4e2d\u5f0f\u7f51\u5173\u3002 \u5728\u96c6\u4e2d\u5f0f\u7f51\u5173\u6a21\u5f0f\u4e0b\uff0cPod \u8bbf\u95ee\u5916\u7f51\u7684\u6570\u636e\u5305\u4f1a\u9996\u5148\u88ab\u8def\u7531\u5230\u7279\u5b9a\u8282\u70b9\u7684 <code>ovn0</code> \u7f51\u5361\uff0c\u518d\u901a\u8fc7\u4e3b\u673a\u7684\u8def\u7531\u89c4\u5219\u8fdb\u884c\u51fa\u7f51\u3002 \u5f53 <code>natOutgoing</code> \u4e3a <code>true</code> \u65f6\uff0cPod \u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u5c06\u4f1a\u4f7f\u7528\u7279\u5b9a\u5bbf\u4e3b\u673a\u7684 IP\u3002</p> <p>\u5b50\u7f51\u793a\u4f8b\uff0c\u5176\u4e2d <code>gatewayType</code> \u5b57\u6bb5\u4e3a <code>centralized</code>\uff0c<code>gatewayNode</code> \u4e3a\u7279\u5b9a\u673a\u5668\u5728 Kubernetes \u4e2d\u7684 <code>NodeName</code>\u3002 \u5176\u4e2d <code>gatewayNode</code> \u5b57\u6bb5\u53ef\u4ee5\u4e3a\u9017\u53f7\u5206\u9694\u7684\u591a\u53f0\u4e3b\u673a\u3002</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: centralized\nspec:\nprotocol: IPv4\ncidrBlock: 10.166.0.0/16\ndefault: false\nexcludeIps:\n- 10.166.0.1\ngateway: 10.166.0.1\ngatewayType: centralized\ngatewayNode: \"node1,node2\"\nnatOutgoing: true\n</code></pre> <ul> <li>\u96c6\u4e2d\u5f0f\u7f51\u5173\u5982\u679c\u5e0c\u671b\u6307\u5b9a\u673a\u5668\u7684\u7279\u5b9a\u7f51\u5361\u8fdb\u884c\u51fa\u7f51\uff0c<code>gatewayNode</code> \u53ef\u66f4\u6539\u4e3a <code>kube-ovn-worker:172.18.0.2</code>, <code>kube-ovn-control-plane:172.18.0.3</code> \u683c\u5f0f\u3002</li> <li>\u96c6\u4e2d\u5f0f\u7f51\u5173\u9ed8\u8ba4\u4e3a\u4e3b\u5907\u6a21\u5f0f\uff0c\u53ea\u6709\u4e3b\u8282\u70b9\u8fdb\u884c\u6d41\u91cf\u8f6c\u53d1\uff0c \u5982\u679c\u9700\u8981\u5207\u6362\u4e3a <code>ECMP</code> \u6a21\u5f0f\uff0c\u8bf7\u53c2\u8003\u96c6\u4e2d\u5f0f\u7f51\u5173 <code>ECMP</code> \u5f00\u542f\u8bbe\u7f6e\u3002</li> <li>\u4ece Kube-OVN v1.12.0 \u7248\u672c\u5f00\u59cb\uff0c\u5728 <code>subnet</code> crd \u5b9a\u4e49\u4e2d\u589e\u52a0\u4e86 <code>spec</code> \u5b57\u6bb5 <code>enableEcmp</code>\uff0c\u5c06\u96c6\u4e2d\u5f0f\u5b50\u7f51 <code>ECMP</code> \u5f00\u5173\u63a7\u5236\u8fc1\u79fb\u5230\u5b50\u7f51\u5c42\u7ea7\uff0c\u53ef\u4ee5\u57fa\u4e8e\u4e0d\u540c\u7684\u5b50\u7f51\u5206\u522b\u8bbe\u7f6e\u662f\u5426\u5f00\u542f <code>ECMP</code> \u6a21\u5f0f\u3002\u539f\u6709\u7684 <code>kube-ovn-controller Deployment</code> \u4e2d\u7684 <code>enable-ecmp</code>\u53c2\u6570\u4e0d\u518d\u4f7f\u7528\u3002\u4e4b\u524d\u7248\u672c\u5347\u7ea7\u5230 v1.12.0 \u4e4b\u540e\uff0c\u5b50\u7f51\u5f00\u5173\u4f1a\u81ea\u52a8\u7ee7\u627f\u539f\u6709\u7684\u5168\u5c40\u5f00\u5173\u53c2\u6570\u53d6\u503c\u3002</li> </ul>"},{"location":"network/kube-ovn/features/subnet/#acl","title":"\u5b50\u7f51 ACL \u8bbe\u7f6e","text":"<p>\u5bf9\u4e8e\u6709\u7ec6\u7c92\u5ea6 ACL \u63a7\u5236\u7684\u573a\u666f\uff0cKube-OVN \u7684 <code>Subnet</code> \u63d0\u4f9b\u4e86 ACL \u89c4\u5219\u7684\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7f51\u7edc\u89c4\u5219\u7684\u7cbe\u7ec6\u63a7\u5236\u3002</p> <p>Subnet \u4e2d\u7684 ACL \u89c4\u5219\u548c OVN \u7684 ACL \u89c4\u5219\u4e00\u81f4\uff0c\u76f8\u5173\u5b57\u6bb5\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 ovn-nb ACL Table\uff0c <code>match</code> \u5b57\u6bb5\u652f\u6301\u7684\u5b57\u6bb5\u53ef\u53c2\u8003 ovn-sb Logical Flow Table\u3002</p> <p>\u5141\u8bb8 IP \u5730\u5740\u4e3a <code>10.10.0.2</code> \u7684 Pod \u8bbf\u95ee\u6240\u6709\u5730\u5740\uff0c\u4f46\u4e0d\u5141\u8bb8\u5176\u4ed6\u5730\u5740\u4e3b\u52a8\u8bbf\u95ee\u81ea\u5df1\u7684 ACL \u89c4\u5219\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: acl\nspec:\nacls:\n- action: drop\ndirection: to-lport\nmatch: ip4.dst == 10.10.0.2 &amp;&amp; ip\npriority: 1002\n- action: allow-related\ndirection: from-lport\nmatch: ip4.src == 10.10.0.2 &amp;&amp; ip\npriority: 1002\ncidrBlock: 10.10.0.0/24\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#_11","title":"\u5b50\u7f51\u9694\u79bb\u8bbe\u7f6e","text":"<p>\u5907\u6ce8</p> <p>\u5b50\u7f51 ACL \u7684\u529f\u80fd\u53ef\u4ee5\u8986\u76d6\u5b50\u7f51\u9694\u79bb\u7684\u529f\u80fd\uff0c\u5e76\u6709\u66f4\u597d\u7684\u7075\u6d3b\u6027\uff0c\u6211\u4eec\u63a8\u8350\u4f7f\u7528\u5b50\u7f51 ACL \u6765\u505a\u76f8\u5e94\u7684\u914d\u7f6e\u3002</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Kube-OVN \u521b\u5efa\u7684\u5b50\u7f51\u4e4b\u95f4\u53ef\u4ee5\u76f8\u4e92\u901a\u4fe1\uff0cPod \u4e5f\u53ef\u4ee5\u901a\u8fc7\u7f51\u5173\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u3002</p> <p>\u5982\u9700\u5bf9\u5b50\u7f51\u95f4\u7684\u8bbf\u95ee\u8fdb\u884c\u63a7\u5236\uff0c\u53ef\u4ee5\u5728\u5b50\u7f51 CRD \u4e2d\u5c06 <code>private</code> \u8bbe\u7f6e\u4e3a <code>true</code>\uff0c\u5219\u8be5\u5b50\u7f51\u5c06\u548c\u5176\u4ed6\u5b50\u7f51\u4ee5\u53ca\u5916\u90e8\u7f51\u7edc\u9694\u79bb\uff0c \u53ea\u80fd\u8fdb\u884c\u5b50\u7f51\u5185\u90e8\u7684\u901a\u4fe1\u3002\u5982\u9700\u5f00\u767d\u540d\u5355\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>allowSubnets</code> \u8fdb\u884c\u8bbe\u7f6e\u3002<code>allowSubnets</code> \u5185\u7684\u7f51\u6bb5\u548c\u8be5\u5b50\u7f51\u53ef\u4ee5\u53cc\u5411\u4e92\u8bbf\u3002</p>"},{"location":"network/kube-ovn/features/subnet/#_12","title":"\u5f00\u542f\u8bbf\u95ee\u63a7\u5236\u7684\u5b50\u7f51\u793a\u4f8b","text":"<pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: private\nspec:\nprotocol: IPv4\ndefault: false\nnamespaces:\n- ns1\n- ns2\ncidrBlock: 10.69.0.0/16\nprivate: true\nallowSubnets:\n- 10.16.0.0/16\n- 10.18.0.0/16\n</code></pre>"},{"location":"network/kube-ovn/features/subnet/#underlay","title":"Underlay \u76f8\u5173\u9009\u9879","text":"<p>\u6ce8\u610f</p> <p>\u8be5\u90e8\u5206\u529f\u80fd\u53ea\u5bf9 Underlay \u7c7b\u578b\u5b50\u7f51\u751f\u6548\u3002</p> <ul> <li><code>vlan</code>: \u5982\u679c\u4f7f\u7528 Underlay \u7f51\u7edc\uff0c\u8be5\u5b57\u6bb5\u7528\u6765\u63a7\u5236\u8be5 <code>Subnet</code> \u548c\u54ea\u4e2a <code>Vlan</code> CR \u8fdb\u884c\u7ed1\u5b9a\u3002\u8be5\u9009\u9879\u9ed8\u8ba4\u4e3a\u7a7a\u5b57\u7b26\u4e32\uff0c\u5373\u4e0d\u4f7f\u7528 Underlay \u7f51\u7edc\u3002</li> <li><code>logicalGateway</code>: \u4e00\u4e9b Underlay \u73af\u5883\u4e3a\u7eaf\u4e8c\u5c42\u7f51\u7edc\uff0c\u4e0d\u5b58\u5728\u7269\u7406\u7684\u4e09\u5c42\u7f51\u5173\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u501f\u52a9 OVN \u672c\u8eab\u7684\u80fd\u529b\u8bbe\u7f6e\u4e00\u4e2a\u865a\u62df\u7f51\u5173\uff0c\u5c06 Underlay \u548c Overlay \u7f51\u7edc\u6253\u901a\u3002\u9ed8\u8ba4\u503c\u4e3a\uff1a<code>false</code>\u3002</li> </ul>"},{"location":"network/kube-ovn/features/subnet/#_13","title":"\u7f51\u5173\u68c0\u67e5\u8bbe\u7f6e","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b <code>kube-ovn-cni</code> \u5728\u542f\u52a8 Pod \u540e\u4f1a\u4f7f\u7528 ICMP \u6216 ARP \u534f\u8bae\u8bf7\u6c42\u7f51\u5173\u5e76\u7b49\u5f85\u8fd4\u56de\uff0c \u4ee5\u9a8c\u8bc1\u7f51\u7edc\u5de5\u4f5c\u6b63\u5e38\uff0c\u5728\u90e8\u5206 Underlay \u73af\u5883\u7f51\u5173\u65e0\u6cd5\u54cd\u5e94 ARP \u8bf7\u6c42\uff0c\u6216\u65e0\u9700\u7f51\u7edc\u5916\u90e8\u8054\u901a\u7684\u573a\u666f \u53ef\u4ee5\u5173\u95ed\u7f51\u5173\u68c0\u67e5\u3002</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: disable-gw-check\nspec:\ndisableGatewayCheck: true\n</code></pre>"},{"location":"network/kube-ovn/features/underlay-network/","title":"Underlay\u7f51\u7edc","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Kube-OVN \u7684\u9ed8\u8ba4\u5b50\u7f51\u4f7f\u7528 Geneve \u5bf9\u8de8\u4e3b\u673a\u6d41\u91cf\u8fdb\u884c\u5c01\u88c5\uff0c\u5728\u57fa\u7840\u8bbe\u65bd\u4e4b\u4e0a\u62bd\u8c61\u51fa\u4e00\u5c42\u865a\u62df\u7684 Overlay \u7f51\u7edc\u3002</p> <p>\u5bf9\u4e8e\u5e0c\u671b\u5bb9\u5668\u7f51\u7edc\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u7f51\u7edc\u5730\u5740\u6bb5\u60c5\u51b5\uff0c\u53ef\u4ee5\u5c06 Kube-OVN \u7684\u9ed8\u8ba4\u5b50\u7f51\u5de5\u4f5c\u5728 Underlay \u6a21\u5f0f\uff0c\u53ef\u4ee5\u76f4\u63a5\u7ed9\u5bb9\u5668\u5206\u914d\u7269\u7406\u7f51\u7edc\u4e2d\u7684\u5730\u5740\u8d44\u6e90\uff0c\u8fbe\u5230\u66f4\u597d\u7684\u6027\u80fd\u4ee5\u53ca\u548c\u7269\u7406\u7f51\u7edc\u7684\u8fde\u901a\u6027\u3002</p> <p></p>"},{"location":"network/kube-ovn/features/underlay-network/#_1","title":"\u529f\u80fd\u9650\u5236","text":"<p>\u7531\u4e8e\u8be5\u6a21\u5f0f\u4e0b\u5bb9\u5668\u7f51\u7edc\u76f4\u63a5\u4f7f\u7528\u7269\u7406\u7f51\u7edc\u8fdb\u884c\u4e8c\u5c42\u5305\u8f6c\u53d1\uff0cOverlay \u6a21\u5f0f\u4e0b\u7684 SNAT/EIP\uff0c \u5206\u5e03\u5f0f\u7f51\u5173/\u96c6\u4e2d\u5f0f\u7f51\u5173\u7b49 L3 \u529f\u80fd\u65e0\u6cd5\u4f7f\u7528\uff0cVPC \u7ea7\u522b\u7684\u9694\u79bb\u4e5f\u65e0\u6cd5\u5bf9 Underlay \u5b50\u7f51\u751f\u6548\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#macvlan","title":"\u548c Macvlan \u76f8\u6bd4\u8f83","text":"<p>Kube-OVN \u7684 Underlay \u6a21\u5f0f\u548c Macvlan \u5de5\u4f5c\u6a21\u5f0f\u5341\u5206\u7c7b\u4f3c\uff0c\u5728\u529f\u80fd\u548c\u6027\u80fd\u4e0a\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u4e2a\u533a\u522b\uff1a</p> <ol> <li>\u7531\u4e8e Macvlan \u7684\u5185\u6838\u8def\u5f84\u66f4\u77ed\uff0c\u5e76\u4e14\u4e0d\u9700\u8981 OVS \u5bf9\u6570\u636e\u5305\u8fdb\u884c\u5904\u7406\uff0cMacvlan \u5728\u541e\u5410\u91cf\u548c\u5ef6\u8fdf\u6027\u80fd\u6307\u6807\u4e0a\u8868\u73b0\u4f1a\u66f4\u597d\u3002</li> <li>Kube-OVN \u901a\u8fc7\u6d41\u8868\u63d0\u4f9b\u4e86 <code>arp-proxy</code> \u529f\u80fd\uff0c\u53ef\u4ee5\u7f13\u89e3\u5927\u89c4\u6a21\u7f51\u7edc\u4e0b\u7684 arp \u5e7f\u64ad\u98ce\u66b4\u98ce\u9669\u3002</li> <li>\u7531\u4e8e Macvlan \u5de5\u4f5c\u5728\u5185\u6838\u5e95\u5c42\uff0c\u4f1a\u7ed5\u8fc7\u5bbf\u4e3b\u673a\u7684 netfilter\uff0cService \u548c NetworkPolicy \u529f\u80fd\u9700\u8981\u989d\u5916\u5f00\u53d1\u3002Kube-OVN \u901a\u8fc7 OVS \u6d41\u8868\u63d0\u4f9b\u4e86 Service \u548c NetworkPolicy \u7684\u80fd\u529b\u3002</li> <li>Kube-OVN \u7684 Underlay \u6a21\u5f0f\u76f8\u6bd4 Macvlan \u989d\u5916\u63d0\u4f9b\u4e86\u5730\u5740\u7ba1\u7406\uff0c\u56fa\u5b9a IP \u548c QoS \u7b49\u529f\u80fd\u3002</li> </ol>"},{"location":"network/kube-ovn/features/underlay-network/#_2","title":"\u73af\u5883\u8981\u6c42","text":"<p>\u5728 Underlay \u6a21\u5f0f\u4e0b\uff0cOVS \u5c06\u4f1a\u6865\u63a5\u4e00\u4e2a\u8282\u70b9\u7f51\u5361\u5230 OVS \u7f51\u6865\uff0c\u5e76\u5c06\u6570\u636e\u5305\u76f4\u63a5\u901a\u8fc7\u8be5\u8282\u70b9\u7f51\u5361\u5bf9\u5916\u53d1\u9001\uff0cL2/L3 \u5c42\u9762\u7684\u8f6c\u53d1\u80fd\u529b\u9700\u8981\u4f9d\u8d56\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u3002 \u9700\u8981\u9884\u5148\u5728\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u914d\u7f6e\u5bf9\u5e94\u7684\u7f51\u5173\u3001Vlan \u548c\u5b89\u5168\u7b56\u7565\u7b49\u914d\u7f6e\u3002</p> <ol> <li>\u5bf9\u4e8e OpenStack \u7684 VM \u73af\u5883\uff0c\u9700\u8981\u5c06\u5bf9\u5e94\u7f51\u7edc\u7aef\u53e3\u7684 <code>PortSecurity</code> \u5173\u95ed\u3002</li> <li>\u5bf9\u4e8e VMware \u7684 vSwitch \u7f51\u7edc\uff0c\u9700\u8981\u5c06 MAC Address Changes, Forged Transmits \u548c Promiscuous Mode Operation \u8bbe\u7f6e\u4e3a allow\u3002</li> <li>\u5bf9\u4e8e Hyper-V \u865a\u62df\u5316\uff0c\u9700\u8981\u5f00\u542f\u865a\u62df\u673a\u7f51\u5361\u9ad8\u7ea7\u529f\u80fd\u4e2d\u7684 MAC Address Spoofing\u3002</li> <li>\u516c\u6709\u4e91\uff0c\u4f8b\u5982 AWS\u3001GCE\u3001\u963f\u91cc\u4e91\u7b49\u7531\u4e8e\u4e0d\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49 Mac \u65e0\u6cd5\u652f\u6301 Underlay \u6a21\u5f0f\u7f51\u7edc\uff0c\u5728\u8fd9\u79cd\u573a\u666f\u4e0b\u5982\u679c\u60f3\u4f7f\u7528 Underlay \u63a8\u8350\u4f7f\u7528\u5bf9\u5e94\u516c\u6709\u4e91\u5382\u5546\u63d0\u4f9b\u7684 VPC-CNI\u3002</li> <li>\u6865\u63a5\u7f51\u5361\u4e0d\u80fd\u4e3a Linux Bridge\u3002</li> </ol> <p>\u5bf9\u4e8e\u7ba1\u7406\u7f51\u548c\u5bb9\u5668\u7f51\u4f7f\u7528\u540c\u4e00\u4e2a\u7f51\u5361\u7684\u60c5\u51b5\u4e0b\uff0cKube-OVN \u4f1a\u5c06\u7f51\u5361\u7684 Mac \u5730\u5740\u3001IP \u5730\u5740\u3001\u8def\u7531\u4ee5\u53ca MTU \u5c06\u8f6c\u79fb\u6216\u590d\u5236\u81f3\u5bf9\u5e94\u7684 OVS Bridge\uff0c \u4ee5\u652f\u6301\u5355\u7f51\u5361\u90e8\u7f72 Underlay \u7f51\u7edc\u3002OVS Bridge \u540d\u79f0\u683c\u5f0f\u4e3a <code>br-PROVIDER_NAME</code>\uff0c<code>PROVIDER_NAME</code> \u4e3a Provider \u7f51\u7edc\u540d\u79f0\uff08\u9ed8\u8ba4\u4e3a provider\uff09\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#_3","title":"\u90e8\u7f72\u65f6\u6307\u5b9a\u7f51\u7edc\u6a21\u5f0f","text":"<p>\u8be5\u90e8\u7f72\u6a21\u5f0f\u5c06\u9ed8\u8ba4\u5b50\u7f51\u8bbe\u7f6e\u4e3a Underlay \u6a21\u5f0f\uff0c\u6240\u6709\u672a\u6307\u5b9a\u5b50\u7f51\u7684 Pod \u5747\u4f1a\u9ed8\u8ba4\u8fd0\u884c\u5728 Underlay \u7f51\u7edc\u4e2d\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#_4","title":"\u4e0b\u8f7d\u5b89\u88c5\u811a\u672c","text":"<pre><code>wget https://raw.githubusercontent.com/kubeovn/kube-ovn/release-1.12/dist/images/install.sh\n</code></pre>"},{"location":"network/kube-ovn/features/underlay-network/#_5","title":"\u4fee\u6539\u811a\u672c\u4e2d\u76f8\u5e94\u914d\u7f6e","text":"<pre><code>ENABLE_ARP_DETECT_IP_CONFLICT # \u5982\u6709\u9700\u8981\uff0c\u53ef\u4ee5\u9009\u62e9\u5173\u95ed vlan \u7f51\u7edc arp \u51b2\u7a81\u68c0\u6d4b\nNETWORK_TYPE                  # \u8bbe\u7f6e\u4e3a vlan\nVLAN_INTERFACE_NAME           # \u8bbe\u7f6e\u4e3a\u5bbf\u4e3b\u673a\u4e0a\u627f\u62c5\u5bb9\u5668\u6d41\u91cf\u7684\u7f51\u5361\uff0c\u4f8b\u5982 eth1\nVLAN_ID                       # \u4ea4\u6362\u673a\u6240\u63a5\u53d7\u7684 VLAN Tag\uff0c\u82e5\u8bbe\u7f6e\u4e3a 0 \u5219\u4e0d\u505a VLAN \u5c01\u88c5\nPOD_CIDR                      # \u8bbe\u7f6e\u4e3a\u7269\u7406\u7f51\u7edc CIDR\uff0c \u4f8b\u5982 192.168.1.0/24\nPOD_GATEWAY                   # \u8bbe\u7f6e\u4e3a\u7269\u7406\u7f51\u7edc\u7f51\u5173\uff0c\u4f8b\u5982 192.168.1.1\nEXCLUDE_IPS                   # \u6392\u9664\u8303\u56f4\uff0c\u907f\u514d\u5bb9\u5668\u7f51\u6bb5\u548c\u7269\u7406\u7f51\u7edc\u5df2\u7528 IP \u51b2\u7a81\uff0c\u4f8b\u5982 192.168.1.1..192.168.1.100\nENABLE_LB                     # \u5982\u679c Underlay \u5b50\u7f51\u9700\u8981\u4f7f\u7528 Service \u9700\u8981\u8bbe\u7f6e\u4e3a true \nEXCHANGE_LINK_NAME            # \u662f\u5426\u4ea4\u6362\u9ed8\u8ba4 provider-network \u4e0b OVS \u7f51\u6865\u548c\u6865\u63a5\u7f51\u5361\u7684\u540d\u5b57\uff0c\u9ed8\u8ba4\u4e3a false\nLS_DNAT_MOD_DL_DST            # DNAT \u65f6\u662f\u5426\u5bf9 MAC \u5730\u5740\u8fdb\u884c\u8f6c\u6362\uff0c\u53ef\u52a0\u901f Service \u7684\u8bbf\u95ee\uff0c\u9ed8\u8ba4\u4e3a true\n</code></pre>"},{"location":"network/kube-ovn/features/underlay-network/#_6","title":"\u8fd0\u884c\u5b89\u88c5\u811a\u672c","text":"<pre><code>bash install.sh\n</code></pre>"},{"location":"network/kube-ovn/features/underlay-network/#crd-underlay","title":"\u901a\u8fc7 CRD \u52a8\u6001\u521b\u5efa Underlay \u7f51\u7edc","text":"<p>\u8be5\u65b9\u5f0f\u53ef\u5728\u5b89\u88c5\u540e\u52a8\u6001\u7684\u521b\u5efa\u67d0\u4e2a Underlay \u5b50\u7f51\u4f9b Pod \u4f7f\u7528\u3002\u9700\u8981\u914d\u7f6e <code>ProviderNetwork</code>\uff0c<code>Vlan</code> \u548c <code>Subnet</code> \u4e09\u79cd\u81ea\u5b9a\u4e49\u8d44\u6e90\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#providernetwork","title":"\u521b\u5efa ProviderNetwork","text":"<p><code>ProviderNetwork</code> \u63d0\u4f9b\u4e86\u4e3b\u673a\u7f51\u5361\u5230\u7269\u7406\u7f51\u7edc\u6620\u5c04\u7684\u62bd\u8c61\uff0c\u5c06\u540c\u5c5e\u4e00\u4e2a\u7f51\u7edc\u7684\u7f51\u5361\u8fdb\u884c\u7edf\u4e00\u7ba1\u7406\uff0c \u5e76\u89e3\u51b3\u5728\u590d\u6742\u73af\u5883\u4e0b\u540c\u673a\u5668\u591a\u7f51\u5361\u3001\u7f51\u5361\u540d\u4e0d\u4e00\u81f4\u3001\u5bf9\u5e94 Underlay \u7f51\u7edc\u4e0d\u4e00\u81f4\u7b49\u60c5\u51b5\u4e0b\u7684\u914d\u7f6e\u95ee\u9898\u3002</p> <p>\u521b\u5efa\u5982\u4e0b <code>ProviderNetwork</code> \u5e76\u5e94\u7528:</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: ProviderNetwork\nmetadata:\nname: net1\nspec:\ndefaultInterface: eth1\ncustomInterfaces:\n- interface: eth2\nnodes:\n- node1\nexcludeNodes:\n- node2\n</code></pre> <p>\u6ce8\u610f</p> <p><code>ProviderNetwork</code> \u8d44\u6e90\u540d\u79f0\u7684\u957f\u5ea6\u4e0d\u5f97\u8d85\u8fc7 12\u3002</p> \u5b57\u6bb5\u540d\u79f0 \u7528\u9014\u63cf\u8ff0 \u5907\u6ce8 <code>defaultInterface</code> <code>ProviderNetwork</code> \u521b\u5efa\u6210\u529f\u540e\uff0c\u5404\u8282\u70b9\uff08\u9664 <code>excludeNodes</code> \u5916\uff09\u4e2d\u4f1a\u521b\u5efa\u540d\u4e3a <code>br-net1</code>\uff08\u683c\u5f0f\u4e3a <code>br-NAME</code>\uff09\u7684 OVS \u7f51\u6865\uff0c\u5e76\u5c06\u6307\u5b9a\u7684\u8282\u70b9\u7f51\u5361\u6865\u63a5\u81f3\u6b64\u7f51\u6865\u3002 \u4e3a\u9ed8\u8ba4\u4f7f\u7528\u7684\u8282\u70b9\u7f51\u5361\u540d\u79f0 <code>customInterfaces</code> \u53ef\u9488\u5bf9\u7279\u5b9a\u8282\u70b9\u6307\u5b9a\u9700\u8981\u4f7f\u7528\u7684\u7f51\u5361\u3002 \u53ef\u9009\u9879 <code>excludeNodes</code> \u7528\u4e8e\u6307\u5b9a\u4e0d\u6865\u63a5\u7f51\u5361\u7684\u8282\u70b9\u3002\u8be5\u5217\u8868\u4e2d\u7684\u8282\u70b9\u4f1a\u88ab\u6dfb\u52a0 <code>net1.provider-network.ovn.kubernetes.io/exclude=true</code> \u6807\u7b7e\u3002 \u53ef\u9009\u9879 <p>\u5176\u5b83\u8282\u70b9\u4f1a\u88ab\u6dfb\u52a0\u5982\u4e0b\u6807\u7b7e:</p> Key Value \u63cf\u8ff0 <code>net1.provider-network.ovn.kubernetes.io/ready</code> <code>true</code> \u8282\u70b9\u4e2d\u7684\u6865\u63a5\u5de5\u4f5c\u5df2\u5b8c\u6210\uff0c<code>ProviderNetwork</code> \u5728\u8282\u70b9\u4e2d\u53ef\u7528 <code>net1.provider-network.ovn.kubernetes.io/interface</code> <code>eth1</code> \u8282\u70b9\u4e2d\u88ab\u6865\u63a5\u7684\u7f51\u5361\u7684\u540d\u79f0 <code>net1.provider-network.ovn.kubernetes.io/mtu</code> 1500 \u8282\u70b9\u4e2d\u88ab\u6865\u63a5\u7684\u7f51\u5361\u7684 MTU <p>\u6ce8\u610f</p> <p>\u5982\u679c\u8282\u70b9\u7f51\u5361\u4e0a\u5df2\u7ecf\u914d\u7f6e\u4e86 IP\uff0c\u5219 IP \u5730\u5740\u548c\u7f51\u5361\u4e0a\u7684\u8def\u7531\u4f1a\u88ab\u8f6c\u79fb\u81f3\u5bf9\u5e94\u7684 OVS \u7f51\u6865\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#vlan","title":"\u521b\u5efa VLAN","text":"<p><code>Vlan</code> \u63d0\u4f9b\u4e86\u5c06 Vlan Tag \u548c <code>ProviderNetwork</code> \u8fdb\u884c\u7ed1\u5b9a\u7684\u80fd\u529b\u3002</p> <p>\u521b\u5efa\u5982\u4e0b VLAN \u5e76\u5e94\u7528\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Vlan\nmetadata:\nname: vlan1\nspec:\nid: 0\nprovider: net1\n</code></pre> \u5b57\u6bb5\u540d\u79f0 \u7528\u9014\u63cf\u8ff0 <code>id</code> \u4e3a VLAN ID/Tag\uff0cKube-OVN \u4f1a\u5bf9\u5bf9\u8be5 Vlan \u4e0b\u7684\u6d41\u91cf\u589e\u52a0 <code>Vlan</code> \u6807\u7b7e\uff0c\u4e3a 0 \u65f6\u4e0d\u589e\u52a0\u4efb\u4f55\u6807\u7b7e\u3002 <code>provider</code> \u4e3a\u9700\u8981\u4f7f\u7528\u7684 <code>ProviderNetwork</code> \u8d44\u6e90\u7684\u540d\u79f0\u3002\u591a\u4e2a VLAN \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u4e2a <code>ProviderNetwork</code>\u3002"},{"location":"network/kube-ovn/features/underlay-network/#_7","title":"\u521b\u5efa\u5b50\u7f51","text":"<p>\u5c06 <code>Vlan</code> \u548c\u4e00\u4e2a\u5b50\u7f51\u7ed1\u5b9a\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: subnet1\nspec:\nprotocol: IPv4\ncidrBlock: 172.17.0.0/16\ngateway: 172.17.0.1\nvlan: vlan1\n</code></pre> <p>\u5c06 <code>vlan</code> \u7684\u503c\u6307\u5b9a\u4e3a\u9700\u8981\u4f7f\u7528\u7684 VLAN \u540d\u79f0\u5373\u53ef\u3002\u591a\u4e2a <code>Subnet</code> \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u4e2a VLAN\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#_8","title":"\u5bb9\u5668\u521b\u5efa","text":"<p>\u53ef\u6309\u6b63\u5e38\u5bb9\u5668\u521b\u5efa\u65b9\u5f0f\u8fdb\u884c\u521b\u5efa\uff0c\u67e5\u770b\u5bb9\u5668 IP \u662f\u5426\u5728\u89c4\u5b9a\u8303\u56f4\u5185\uff0c\u4ee5\u53ca\u5bb9\u5668\u662f\u5426\u53ef\u4ee5\u548c\u7269\u7406\u7f51\u7edc\u4e92\u901a\u3002</p> <p>\u5982\u6709\u56fa\u5b9a IP \u9700\u6c42\uff0c\u53ef\u53c2\u8003\u9759\u6001IP\u5730\u5740\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#_9","title":"\u4f7f\u7528\u903b\u8f91\u7f51\u5173","text":"<p>\u5bf9\u4e8e\u7269\u7406\u7f51\u7edc\u4e0d\u5b58\u5728\u7f51\u5173\u7684\u60c5\u51b5\uff0cKube-OVN \u652f\u6301\u5728 Underlay \u6a21\u5f0f\u7684\u5b50\u7f51\u4e2d\u914d\u7f6e\u4f7f\u7528\u903b\u8f91\u7f51\u5173\u3002 \u82e5\u8981\u4f7f\u7528\u6b64\u529f\u80fd\uff0c\u8bbe\u7f6e\u5b50\u7f51\u7684 <code>spec.logicalGateway</code> \u4e3a <code>true</code> \u5373\u53ef\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: subnet1\nspec:\nprotocol: IPv4\ncidrBlock: 172.17.0.0/16\ngateway: 172.17.0.1\nvlan: vlan1\nlogicalGateway: true\n</code></pre> <p>\u5f00\u542f\u6b64\u529f\u80fd\u540e\uff0cPod \u4e0d\u4f7f\u7528\u5916\u90e8\u7f51\u5173\uff0c\u800c\u662f\u4f7f\u7528 Kube-OVN \u521b\u5efa\u7684\u903b\u8f91\u8def\u7531\u5668\uff08Logical Router\uff09\u5bf9\u4e8e\u8de8\u7f51\u6bb5\u901a\u4fe1\u8fdb\u884c\u8f6c\u53d1\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#underlay-overlay","title":"Underlay \u548c Overlay \u7f51\u7edc\u4e92\u901a","text":"<p>\u5982\u679c\u4e00\u4e2a\u96c6\u7fa4\u540c\u65f6\u5b58\u5728 Underlay \u548c Overlay \u5b50\u7f51\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Overlay \u5b50\u7f51\u4e0b\u7684 Pod \u53ef\u4ee5\u901a\u8fc7\u7f51\u5173\u4ee5 NAT \u7684\u65b9\u5f0f\u8bbf\u95ee Underlay \u5b50\u7f51\u4e0b\u7684 Pod IP\u3002 \u5728 Underlay \u5b50\u7f51\u7684 Pod \u770b\u6765 Overlay \u5b50\u7f51\u7684\u5730\u5740\u662f\u4e00\u4e2a\u5916\u90e8\u7684\u5730\u5740\uff0c\u9700\u8981\u901a\u8fc7\u5e95\u5c42\u7269\u7406\u8bbe\u5907\u53bb\u8f6c\u53d1\uff0c\u4f46\u5e95\u5c42\u7269\u7406\u8bbe\u5907\u5e76\u4e0d\u6e05\u695a Overlay \u5b50\u7f51\u7684\u5730\u5740\u65e0\u6cd5\u8fdb\u884c\u8f6c\u53d1\u3002 \u56e0\u6b64 Underlay \u5b50\u7f51\u4e0b\u7684 Pod \u65e0\u6cd5\u901a\u8fc7 Pod IP \u76f4\u63a5\u8bbf\u95ee Overlay \u5b50\u7f51\u7684 Pod\u3002</p> <p>\u5982\u679c\u9700\u8981 Underlay \u548c Overlay \u4e92\u901a\u9700\u8981\u5c06\u5b50\u7f51\u7684 <code>u2oInterconnection</code> \u8bbe\u7f6e\u4e3a <code>true</code>\uff0c\u5728\u8fd9\u4e2a\u60c5\u51b5\u4e0b Kube-OVN \u4f1a\u989d\u5916\u4f7f\u7528\u4e00\u4e2a Underlay IP \u5c06 Underlay \u5b50\u7f51 \u548c ovn-cluster \u903b\u8f91\u8def\u7531\u5668\u8fde\u63a5\uff0c\u5e76\u8bbe\u7f6e\u5bf9\u5e94\u7684\u8def\u7531\u89c4\u5219\u5b9e\u73b0\u4e92\u901a\u3002 \u548c\u903b\u8f91\u7f51\u5173\u4e0d\u540c\uff0c\u8be5\u65b9\u6848\u53ea\u4f1a\u8fde\u63a5 Kube-OVN \u5185\u90e8\u7684 Underlay \u548c Overlay \u5b50\u7f51\uff0c\u5176\u4ed6\u8bbf\u95ee\u5916\u7f51\u7684\u6d41\u91cf\u8fd8\u662f\u4f1a\u901a\u8fc7\u7269\u7406\u7f51\u5173\u8fdb\u884c\u8f6c\u53d1\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#ip","title":"\u6307\u5b9a\u903b\u8f91\u7f51\u5173IP","text":"<p>\u5f00\u542f\u4e92\u901a\u529f\u80fd\u540e\uff0c\u4f1a\u968f\u673a\u4ece subnet \u5185\u7684\u53d6\u4e00\u4e2a IP \u4f5c\u4e3a\u903b\u8f91\u7f51\u5173\uff0c\u5982\u679c\u9700\u8981\u6307\u5b9a Underlay Subnet \u7684\u903b\u8f91\u7f51\u5173\u53ef\u4ee5\u6307\u5b9a\u5b57\u6bb5 <code>u2oInterconnectionIP</code>\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#underlay-subnet-vpc","title":"\u6307\u5b9a Underlay Subnet \u8fde\u63a5\u7684\u81ea\u5b9a\u4e49 VPC","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Underlay Subnet \u4f1a\u548c\u9ed8\u8ba4 VPC \u4e0a\u7684 Overlay Subnet \u4e92\u901a\uff0c\u5982\u679c\u8981\u6307\u5b9a\u548c\u67d0\u4e2a VPC \u4e92\u901a\uff0c\u5728 <code>u2oInterconnection</code> \u8bbe\u7f6e\u4e3a <code>true</code> \u540e\uff0c\u6307\u5b9a <code>subnet.spec.vpc</code> \u5b57\u6bb5\u4e3a\u8be5 VPC \u540d\u5b57\u5373\u53ef\u3002</p>"},{"location":"network/kube-ovn/features/underlay-network/#_10","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u60a8\u4f7f\u7528\u7684\u8282\u70b9\u7f51\u5361\u4e0a\u914d\u7f6e\u6709 IP \u5730\u5740\uff0c\u4e14\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7 Netplan \u914d\u7f6e\u7f51\u7edc\uff08\u5982 Ubuntu\uff09\uff0c\u5efa\u8bae\u60a8\u5c06 Netplan \u7684 <code>renderer</code> \u8bbe\u7f6e\u4e3a <code>NetworkManager</code>\uff0c\u5e76\u4e3a\u8282\u70b9\u7f51\u5361\u914d\u7f6e\u9759\u6001 IP \u5730\u5740\uff08\u5173\u95ed DHCP\uff09\uff1a</p> <pre><code>network:\nrenderer: NetworkManager\nethernets:\neth0:\ndhcp4: no\naddresses:\n- 172.16.143.129/24\nversion: 2\n</code></pre> <p>\u5982\u679c\u60a8\u8981\u4fee\u6539\u7f51\u5361\u7684 IP \u6216\u8def\u7531\u914d\u7f6e\uff0c\u9700\u8981\u5728\u4fee\u6539 <code>netplan</code> \u914d\u7f6e\u540e\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>netplan generate\n\nnmcli connection reload netplan-eth0\nnmcli device set eth0 managed yes\n</code></pre> <p>\u6267\u884c\u4ee5\u4e0a\u547d\u4ee4\u540e\uff0cKube-OVN \u4f1a\u5c06\u7f51\u5361\u4e0a\u7684 IP \u53ca\u8def\u7531\u91cd\u65b0\u8f6c\u79fb\u81f3 OVS \u7f51\u6865\u3002</p> <p>\u5982\u679c\u60a8\u4f7f\u7528\u7684\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7 NetworkManager \u7ba1\u7406\u7f51\u7edc\uff08\u5982 CentOS\uff09\uff0c\u5728\u4fee\u6539\u7f51\u5361\u914d\u7f6e\u540e\u9700\u8981\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>nmcli connection reload eth0\nnmcli device set eth0 managed yes\nnmcli -t -f GENERAL.STATE device show eth0 | grep -qw unmanaged || nmcli device reapply eth0\n</code></pre> <p>\u6ce8\u610f</p> <p>\u8282\u70b9\u7f51\u5361\u914d\u7f6e\u7684\u52a8\u6001\u4fee\u6539\u4ec5\u652f\u6301 IP \u548c\u8def\u7531\uff0c\u4e0d\u652f\u6301 MAC \u5730\u5740\u7684\u4fee\u6539\u3002</p>"},{"location":"network/kube-ovn/features/vip-reservation/","title":"VIP\u9884\u7559\u914d\u7f6e","text":"<p>\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u6211\u4eec\u5e0c\u671b\u52a8\u6001\u7684\u9884\u7559\u4e00\u90e8\u5206 IP \u4f46\u662f\u5e76\u4e0d\u5206\u914d\u7ed9 Pod \u800c\u662f\u5206\u914d\u7ed9\u5176\u4ed6\u7684\u57fa\u7840\u8bbe\u65bd\u542f\u7528\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>Kubernetes \u5d4c\u5957 Kubernetes \u7684\u573a\u666f\u4e2d\u4e0a\u5c42 Kubernetes \u4f7f\u7528 Underlay \u7f51\u7edc\u4f1a\u5360\u7528\u5e95\u5c42 Subnet \u53ef\u7528\u5730\u5740\u3002</li> <li>LB \u6216\u5176\u4ed6\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u9700\u8981\u4f7f\u7528\u4e00\u4e2a <code>Subnet</code> \u5185\u7684 IP\uff0c\u4f46\u4e0d\u4f1a\u5355\u72ec\u8d77 Pod\u3002</li> </ul>"},{"location":"network/kube-ovn/features/vip-reservation/#vip","title":"\u521b\u5efa\u968f\u673a\u5730\u5740 VIP","text":"<p>\u5982\u679c\u53ea\u662f\u4e3a\u4e86\u9884\u7559\u82e5\u5e72 IP \u800c\u5bf9 IP \u5730\u5740\u672c\u8eab\u6ca1\u6709\u8981\u6c42\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 yaml \u8fdb\u884c\u521b\u5efa\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Vip\nmetadata:\nname: vip-dynamic-01\nspec:\nsubnet: ovn-default\ntype: \"\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>subnet</code> \u5c06\u4ece\u8be5 Subnet \u4e2d\u9884\u7559 IP\u3002 <code>type</code> \u76ee\u524d\u652f\u6301\u4e24\u79cd\u7c7b\u578b\uff0c\u4e3a\u7a7a\u8868\u793a\u4ec5\u7528\u4e8e ipam ip \u5360\u4f4d\uff0c<code>switch_lb_vip</code> \u8868\u793a\u8be5 vip \u4ec5\u7528\u4e8e switch lb \u524d\u7aef vip \u548c\u540e\u7aef ip \u9700\u5904\u4e8e\u540c\u4e00\u5b50\u7f51\u3002 <p>\u521b\u5efa\u6210\u529f\u540e\u67e5\u8be2\u8be5 VIP\uff1a</p> <pre><code>$ kubectl get vip\nNAME             V4IP         PV4IP   MAC                 PMAC   V6IP   PV6IP   SUBNET        READY\nvip-dynamic-01   10.16.0.12           00:00:00:F0:DB:25                         ovn-default   true\n</code></pre> <p>\u53ef\u89c1\u8be5 VIP \u88ab\u5206\u914d\u4e86 <code>10.16.0.12</code> \u7684 IP \u5730\u5740\uff0c\u8be5\u5730\u5740\u53ef\u4ee5\u4e4b\u540e\u4f9b\u5176\u4ed6\u7f51\u7edc\u57fa\u7840\u8bbe\u65bd\u4f7f\u7528\u3002</p>"},{"location":"network/kube-ovn/features/vip-reservation/#vip_1","title":"\u521b\u5efa\u56fa\u5b9a\u5730\u5740 VIP","text":"<p>\u5982\u5bf9\u9884\u7559\u7684 VIP \u7684 IP \u5730\u5740\u6709\u9700\u6c42\u53ef\u4f7f\u7528\u4e0b\u9762\u7684 yaml \u8fdb\u884c\u56fa\u5b9a\u5206\u914d\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Vip\nmetadata:\nname: static-vip01\nspec:\nsubnet: ovn-default v4ip: \"10.16.0.121\"\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>subnet</code> \u5c06\u4ece\u8be5 Subnet \u4e2d\u9884\u7559 IP\u3002 <code>v4ip</code> \u56fa\u5b9a\u5206\u914d\u7684 IP \u5730\u5740\uff0c\u8be5\u5730\u5740\u9700\u5728 <code>subnet</code> \u7684 CIDR \u8303\u56f4\u5185\u3002 <p>\u521b\u5efa\u6210\u529f\u540e\u67e5\u8be2\u8be5 VIP\uff1a</p> <pre><code>$ kubectl get vip\nNAME             V4IP         PV4IP   MAC                 PMAC   V6IP   PV6IP   SUBNET        READY\nstatic-vip01   10.16.0.121           00:00:00:F0:DB:26                         ovn-default   true\n</code></pre> <p>\u53ef\u89c1\u8be5 VIP \u88ab\u5206\u914d\u4e86\u6240\u9884\u671f\u7684 IP \u5730\u5740\u3002</p>"},{"location":"network/kube-ovn/features/vip-reservation/#pod-vip-ip","title":"Pod \u4f7f\u7528 VIP \u6765\u56fa\u5b9a IP","text":"<p>\u53ef\u4ee5\u4f7f\u7528 <code>annotation</code> \u5c06\u67d0\u4e2a VIP \u5206\u914d\u7ed9\u4e00\u4e2a Pod\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: static-ip\nannotations:\novn.kubernetes.io/vip: vip-dynamic-01 # \u6307\u5b9a vip\nnamespace: default\nspec:\ncontainers:\n- name: static-ip\nimage: docker.io/library/nginx:alpine\n</code></pre>"},{"location":"network/kube-ovn/features/vip-reservation/#statefulset-kubevirt-vm-vip","title":"StatefulSet \u548c Kubevirt VM \u4fdd\u7559 VIP","text":"<p>\u9488\u5bf9 StatefulSet \u548c VM \u7684\u7279\u6b8a\u6027\uff0c\u5728\u4ed6\u4eec\u7684 Pod \u9500\u6bc1\u518d\u62c9\u8d77\u8d77\u540e\u4f1a\u91cd\u65b0\u4f7f\u7528\u4e4b\u524d\u8bbe\u7f6e\u7684 VIP\u3002</p> <p>VM \u4fdd\u7559 VIP \u9700\u8981\u786e\u4fdd <code>kube-ovn-controller</code> \u7684 <code>keep-vm-ip</code> \u53c2\u6570\u4e3a <code>true</code>\u3002\u8bf7\u53c2\u8003 Kubevirt VM \u56fa\u5b9a\u5730\u5740\u5f00\u542f\u8bbe\u7f6e</p>"},{"location":"network/kube-ovn/features/vpc-peering/","title":"VPC\u4e92\u8054","text":"<p>VPC \u4e92\u8054\u63d0\u4f9b\u4e86\u4e00\u79cd\u5c06\u4e24\u4e2a VPC \u7f51\u7edc\u901a\u8fc7\u903b\u8f91\u8def\u7531\u6253\u901a\u7684\u673a\u5236\uff0c\u4ece\u800c\u4f7f\u4e24\u4e2a VPC \u5185\u7684\u5de5\u4f5c\u8d1f\u8f7d\u53ef\u4ee5\u50cf\u5728\u540c\u4e00\u4e2a\u79c1\u6709\u7f51\u7edc\u4e00\u6837\uff0c \u901a\u8fc7\u79c1\u6709\u5730\u5740\u76f8\u4e92\u8bbf\u95ee\uff0c\u65e0\u9700\u901a\u8fc7\u5916\u90e8\u7f51\u5173\u8fdb\u884c NAT \u8f6c\u53d1\u3002</p>"},{"location":"network/kube-ovn/features/vpc-peering/#_1","title":"\u524d\u63d0\u6761\u4ef6","text":"<ol> <li>\u8be5\u529f\u80fd\u53ea\u9002\u7528\u4e8e\u7528\u6237\u81ea\u5b9a\u4e49 VPC\u3002</li> <li>\u4e3a\u4e86\u907f\u514d\u8def\u7531\u91cd\u53e0\u4e24\u4e2a VPC \u5185\u7684\u5b50\u7f51 CIDR \u4e0d\u80fd\u91cd\u53e0\u3002</li> <li>\u76ee\u524d\u53ea\u652f\u6301\u4e24\u4e2a VPC \u7684\u4e92\u8054\uff0c\u66f4\u591a\u7ec4 VPC \u4e4b\u95f4\u7684\u4e92\u8054\u6682\u4e0d\u652f\u6301\u3002</li> </ol>"},{"location":"network/kube-ovn/features/vpc-peering/#_2","title":"\u4f7f\u7528\u65b9\u5f0f","text":"<p>\u9996\u5148\u521b\u5efa\u4e24\u4e2a\u4e0d\u4e92\u8054\u7684 VPC\uff0c\u6bcf\u4e2a VPC \u4e0b\u5404\u6709\u4e00\u4e2a Subnet\uff0cSubnet \u7684 CIDR \u4e92\u4e0d\u91cd\u53e0\u3002</p> <pre><code>kind: Vpc\napiVersion: kubeovn.io/v1\nmetadata:\nname: vpc-1\nspec: {}\n---\nkind: Subnet\napiVersion: kubeovn.io/v1\nmetadata:\nname: net1\nspec:\nvpc: vpc-1\ncidrBlock: 10.0.0.0/16\n---\nkind: Vpc\napiVersion: kubeovn.io/v1\nmetadata:\nname: vpc-2\nspec: {}\n---\nkind: Subnet\napiVersion: kubeovn.io/v1\nmetadata:\nname: net2\nspec:\nvpc: vpc-2\ncidrBlock: 172.31.0.0/16\n</code></pre> <p>\u5728\u6bcf\u4e2a VPC \u5185\u5206\u522b\u589e\u52a0 <code>vpcPeerings</code> \u548c\u5bf9\u5e94\u7684\u9759\u6001\u8def\u7531\uff1a</p> <pre><code>kind: Vpc\napiVersion: kubeovn.io/v1\nmetadata:\nname: vpc-1\nspec: vpcPeerings:\n- remoteVpc: vpc-2\nlocalConnectIP: 169.254.0.1/30\nstaticRoutes:\n- cidr: 172.31.0.0/16\nnextHopIP: 169.254.0.2\npolicy: policyDst\n---\nkind: Vpc\napiVersion: kubeovn.io/v1\nmetadata:\nname: vpc-2\nspec:\nvpcPeerings:\n- remoteVpc: vpc-1\nlocalConnectIP: 169.254.0.2/30\nstaticRoutes:\n- cidr: 10.0.0.0/16\nnextHopIP: 169.254.0.1\npolicy: policyDst\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>remoteVpc</code> \u4e92\u8054\u7684\u53e6\u4e00\u4e2a VPC \u7684\u540d\u5b57\u3002 <code>localConnectIP</code> \u4f5c\u4e3a\u4e92\u8054\u7aef\u70b9\u7684 IP \u5730\u5740\u548c CIDR\uff0c\u6ce8\u610f\u4e24\u7aef IP \u5e94\u5c5e\u4e8e\u540c\u4e00 CIDR\uff0c\u4e14\u4e0d\u80fd\u548c\u5df2\u6709\u5b50\u7f51\u51b2\u7a81\u3002 <code>cidr</code> \u53e6\u4e00\u7aef <code>Subnet</code> \u7684 CIDR\u3002 <code>nextHopIP</code> \u4e92\u8054 VPC \u53e6\u4e00\u7aef\u7684 <code>localConnectIP</code>\u3002 <p>\u5206\u522b\u5728\u4e24\u4e2a <code>Subnet</code> \u4e0b\u521b\u5efa Pod</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nannotations:\novn.kubernetes.io/logical_switch: net1\nname: vpc-1-pod\nspec:\ncontainers:\n- name: vpc-1-pod\nimage: docker.io/library/nginx:alpine\n---\napiVersion: v1\nkind: Pod\nmetadata:\nannotations:\novn.kubernetes.io/logical_switch: net2\nname: vpc-2-pod\nspec:\ncontainers:\n- name: vpc-2-pod\nimage: docker.io/library/nginx:alpine\n</code></pre> <p>\u6d4b\u8bd5\u7f51\u7edc\u8fde\u901a\u6027</p> <pre><code>$ kubectl exec -it vpc-1-pod -- ping $(kubectl get pod vpc-2-pod -o jsonpath='{.status.podIP}')\nPING 172.31.0.2 (172.31.0.2): 56 data bytes\n64 bytes from 172.31.0.2: seq=0 ttl=62 time=0.655 ms\n64 bytes from 172.31.0.2: seq=1 ttl=62 time=0.086 ms\n64 bytes from 172.31.0.2: seq=2 ttl=62 time=0.098 ms\n^C\n--- 172.31.0.2 ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max = 0.086/0.279/0.655 ms\n$ kubectl exec -it vpc-2-pod -- ping $(kubectl get pod vpc-1-pod -o jsonpath='{.status.podIP}')\nPING 10.0.0.2 (10.0.0.2): 56 data bytes\n64 bytes from 10.0.0.2: seq=0 ttl=62 time=0.594 ms\n64 bytes from 10.0.0.2: seq=1 ttl=62 time=0.093 ms\n64 bytes from 10.0.0.2: seq=2 ttl=62 time=0.088 ms\n^C\n--- 10.0.0.2 ping statistics ---\n3 packets transmitted, 3 packets received, 0% packet loss\nround-trip min/avg/max = 0.088/0.258/0.594 ms\n</code></pre>"},{"location":"network/kube-ovn/features/vpc-qos/","title":"VPC QOS\u914d\u7f6e","text":"<p>Kube-OVN \u652f\u6301\u4f7f\u7528 <code>QoSPolicy</code> CRD \u5bf9\u81ea\u5b9a\u4e49 VPC \u7684\u6d41\u91cf\u901f\u7387\u8fdb\u884c\u9650\u5236\u3002</p>"},{"location":"network/kube-ovn/features/vpc-qos/#eip-qos","title":"EIP QoS","text":"<p>\u5bf9 EIP \u8fdb\u884c\u9650\u901f\uff0c\u9650\u901f\u503c\u4e3a <code>1Mbps</code>\uff0c\u4f18\u5148\u7ea7\u4e3a 1\uff0c\u8fd9\u91cc <code>shared=false</code>\uff0c\u8868\u793a\u8fd9\u4e2a <code>QoSPolicy</code> \u53ea\u80fd\u7ed9\u8fd9\u4e2a EIP \u4f7f\u7528\u4e14\u652f\u6301\u52a8\u6001\u4fee\u6539 <code>QoSPolicy</code> \u53bb\u53d8\u66f4 QoS \u89c4\u5219\u3002</p> <p><code>QoSPolicy</code> \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: QoSPolicy\nmetadata:\nname: qos-eip-example\nspec:\nshared: false\nbindingType: EIP\nbandwidthLimitRules:\n- name: eip-ingress\nrateMax: \"1\" # Mbps\nburstMax: \"1\" # Mbps\npriority: 1\ndirection: ingress\n- name: eip-egress\nrateMax: \"1\" # Mbps\nburstMax: \"1\" # Mbps\npriority: 1\ndirection: egress\n</code></pre> <p>IptablesEIP \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>kind: IptablesEIP\napiVersion: kubeovn.io/v1\nmetadata:\nname: eip-1\nspec:\nnatGwDp: gw1\nqosPolicy: qos-eip-example\n</code></pre> <p><code>.spec.qosPolicy</code>\u7684\u503c\u652f\u6301\u521b\u5efa\u65f6\u4f20\u5165\uff0c\u4e5f\u652f\u6301\u521b\u5efa\u540e\u4fee\u6539\u3002</p>"},{"location":"network/kube-ovn/features/vpc-qos/#qos-eip","title":"\u67e5\u770b\u5df2\u542f\u7528 QoS \u7684 EIP","text":"<p>\u901a\u8fc7label\u67e5\u770b\u5df2\u7ecf\u8bbe\u7f6e\u5bf9\u5e94 qos \u7684 eip\uff1a</p> <pre><code>$ kubectl get eip  -l ovn.kubernetes.io/qos=qos-eip-example\nNAME    IP             MAC                 NAT   NATGWDP   READY\neip-1   172.18.11.24   00:00:00:34:41:0B   fip   gw1       true\n</code></pre> <p>\u5bf9 VPC NATGW \u7684 <code>net1</code> \u7f51\u5361\u901f\u7387\u8fdb\u884c\u9650\u5236\uff0c\u9650\u901f\u503c\u4e3a <code>10Mbps</code>\uff0c\u4f18\u5148\u7ea7\u4e3a 3\uff0c\u8fd9\u91cc <code>shared=true</code>\uff0c\u8868\u793a\u8fd9\u4e2a <code>QoSPolicy</code> \u53ef\u4ee5\u540c\u65f6\u7ed9\u591a\u4e2a\u8d44\u6e90\u4f7f\u7528\uff0c\u8fd9\u79cd\u573a\u666f\u4e0b\u4e0d\u5141\u8bb8\u4fee\u6539 <code>QoSPolicy</code> \u7684\u5185\u5bb9\u3002</p> <p><code>QoSPolicy</code> \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: QoSPolicy\nmetadata:\nname: qos-natgw-example\nspec:\nshared: true\nbindingType: NATGW\nbandwidthLimitRules:\n- name: net1-ingress\ninterface: net1\nrateMax: \"10\" # Mbps\nburstMax: \"10\" # Mbps\npriority: 3\ndirection: ingress\n- name: net1-egress\ninterface: net1\nrateMax: \"10\" # Mbps\nburstMax: \"10\" # Mbps\npriority: 3\ndirection: egress\n</code></pre> <p><code>VpcNatGateway</code> \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: VpcNatGateway\nmetadata:\nname: gw1\nspec:\nvpc: test-vpc-1\nsubnet: net1\nlanIp: 10.0.1.254\nqosPolicy: qos-natgw-example\nselector:\n- \"kubernetes.io/hostname: kube-ovn-worker\"\n- \"kubernetes.io/os: linux\"\n</code></pre> <p><code>.spec.qosPolicy</code>\u7684\u503c\u652f\u6301\u521b\u5efa\u4f20\u5165\uff0c\u4e5f\u652f\u6301\u540e\u7eed\u4fee\u6539\u3002</p>"},{"location":"network/kube-ovn/features/vpc-qos/#net1-qos","title":"net1 \u7f51\u5361\u7279\u5b9a\u6d41\u91cf QoS","text":"<p>\u5bf9 net1 \u7f51\u5361\u4e0a\u7279\u5b9a\u6d41\u91cf\u8fdb\u884c\u9650\u901f\uff0c\u9650\u901f\u503c\u4e3a <code>5Mbps</code>\uff0c\u4f18\u5148\u7ea7\u4e3a 2\uff0c\u8fd9\u91cc <code>shared=true</code>\uff0c\u8868\u793a\u8fd9\u4e2a <code>QoSPolicy</code> \u53ef\u4ee5\u540c\u65f6\u7ed9\u591a\u4e2a\u8d44\u6e90\u4f7f\u7528\uff0c\u6b64\u65f6\u4e0d\u5141\u8bb8\u4fee\u6539 <code>QoSPolicy</code> \u7684\u5185\u5bb9\u3002</p> <p><code>QoSPolicy</code> \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: QoSPolicy\nmetadata:\nname: qos-natgw-example\nspec:\nshared: true\nbindingType: NATGW\nbandwidthLimitRules:\n- name: net1-extip-ingress\ninterface: net1\nrateMax: \"5\" # Mbps\nburstMax: \"5\" # Mbps\npriority: 2\ndirection: ingress\nmatchType: ip\nmatchValue: src 172.18.11.22/32\n- name: net1-extip-egress\ninterface: net1\nrateMax: \"5\" # Mbps\nburstMax: \"5\" # Mbps\npriority: 2\ndirection: egress\nmatchType: ip\nmatchValue: dst 172.18.11.23/32\n</code></pre> <p><code>VpcNatGateway</code> \u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: VpcNatGateway\nmetadata:\nname: gw1\nspec:\nvpc: test-vpc-1\nsubnet: net1\nlanIp: 10.0.1.254\nqosPolicy: qos-natgw-example\nselector:\n- \"kubernetes.io/hostname: kube-ovn-worker\"\n- \"kubernetes.io/os: linux\"\n</code></pre>"},{"location":"network/kube-ovn/features/vpc-qos/#qos-natgw","title":"\u67e5\u770b\u5df2\u542f\u7528 QoS \u7684 NATGW","text":"<p>\u901a\u8fc7<code>label</code>\u67e5\u770b\u5df2\u7ecf\u8bbe\u7f6e\u5bf9\u5e94 qos \u7684 eip\uff1a</p> <pre><code>$ kubectl get vpc-nat-gw  -l ovn.kubernetes.io/qos=qos-natgw-example\nNAME   VPC          SUBNET   LANIP\ngw1    test-vpc-1   net1     10.0.1.254\n</code></pre>"},{"location":"network/kube-ovn/features/vpc-qos/#qos","title":"\u67e5\u770b qos \u89c4\u5219","text":"<pre><code>$ kubectl get qos -A\nNAME                SHARED   BINDINGTYPE\nqos-eip-example     false    EIP\nqos-natgw-example   true     NATGW\n</code></pre>"},{"location":"network/kube-ovn/features/vpc-qos/#_1","title":"\u9650\u5236","text":"<ul> <li>\u53ea\u6709\u5728\u672a\u4f7f\u7528\u65f6\u624d\u80fd\u5220\u9664 QoS \u7b56\u7565\u3002\u56e0\u6b64\uff0c\u5728\u5220\u9664 QoS \u7b56\u7565\u4e4b\u524d\uff0c\u8bf7\u5148\u67e5\u770b\u5df2\u542f\u7528 QoS \u7684 EIP \u548c NATGW\uff0c\u53bb\u6389\u5b83\u4eec\u7684 <code>spec.qosPolicy</code> \u914d\u7f6e\u3002</li> </ul>"},{"location":"network/kube-ovn/features/vpc/","title":"VPC\u914d\u7f6e","text":"<p>Kube-OVN \u652f\u6301\u591a\u79df\u6237\u9694\u79bb\u7ea7\u522b\u7684 VPC \u7f51\u7edc\u3002\u4e0d\u540c VPC \u7f51\u7edc\u76f8\u4e92\u72ec\u7acb\uff0c\u53ef\u4ee5\u5206\u522b\u914d\u7f6e Subnet \u7f51\u6bb5\uff0c \u8def\u7531\u7b56\u7565\uff0c\u5b89\u5168\u7b56\u7565\uff0c\u51fa\u7f51\u7f51\u5173\uff0cEIP \u7b49\u914d\u7f6e\u3002</p>"},{"location":"network/kube-ovn/features/vpc/#_1","title":"\u4f7f\u7528\u573a\u666f","text":"<p>VPC \u4e3b\u8981\u7528\u4e8e\u6709\u591a\u79df\u6237\u7f51\u7edc\u5f3a\u9694\u79bb\u7684\u573a\u666f\uff0c\u90e8\u5206 Kubernetes \u7f51\u7edc\u529f\u80fd\u5728\u591a\u79df\u6237\u7f51\u7edc\u4e0b\u5b58\u5728\u51b2\u7a81\u3002 </p> <p>\u4f8b\u5b50</p> <p>\u4f8b\u5982\u8282\u70b9\u548c Pod \u4e92\u8bbf\uff0cNodePort \u529f\u80fd\uff0c\u57fa\u4e8e\u7f51\u7edc\u8bbf\u95ee\u7684\u5065\u5eb7\u68c0\u67e5\u548c DNS \u80fd\u529b\u5728\u591a\u79df\u6237\u7f51\u7edc\u573a\u666f\u6682\u4e0d\u652f\u6301\u3002 </p> <p>\u4e3a\u4e86\u65b9\u4fbf\u5e38\u89c1 Kubernetes \u7684\u4f7f\u7528\u573a\u666f\uff0cKube-OVN \u9ed8\u8ba4 VPC \u505a\u4e86\u7279\u6b8a\u8bbe\u8ba1\uff0c\u8be5 VPC \u4e0b\u7684 Subnet \u53ef\u4ee5\u6ee1\u8db3 Kubernetes \u89c4\u8303\u3002\u7528\u6237\u81ea\u5b9a\u4e49 VPC \u652f\u6301\u672c\u6587\u6863\u4ecb\u7ecd\u7684\u9759\u6001\u8def\u7531\uff0cEIP \u548c NAT \u7f51\u5173\u7b49\u529f\u80fd\u3002 \u5e38\u89c1\u9694\u79bb\u9700\u6c42\u53ef\u901a\u8fc7\u9ed8\u8ba4 VPC \u4e0b\u7684\u7f51\u7edc\u7b56\u7565\u548c\u5b50\u7f51 ACL \u5b9e\u73b0\uff0c\u5728\u4f7f\u7528\u81ea\u5b9a\u4e49 VPC \u524d\u8bf7\u660e\u786e\u662f\u5426\u9700\u8981 VPC \u7ea7\u522b\u7684\u9694\u79bb\uff0c\u5e76\u4e86\u89e3\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684\u9650\u5236\u3002 \u5728 Underlay \u7f51\u7edc\u4e0b\uff0c\u7269\u7406\u4ea4\u6362\u673a\u8d1f\u8d23\u6570\u636e\u9762\u8f6c\u53d1\uff0cVPC \u65e0\u6cd5\u5bf9 Underlay \u5b50\u7f51\u8fdb\u884c\u9694\u79bb\u3002</p> <p></p>"},{"location":"network/kube-ovn/features/vpc/#vpc","title":"\u521b\u5efa\u81ea\u5b9a\u4e49VPC","text":"<p>\u521b\u5efa\u4e24\u4e2a VPC\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Vpc\nmetadata:\nname: test-vpc-1\nspec:\nnamespaces:\n- ns1\n---\nkind: Vpc\napiVersion: kubeovn.io/v1\nmetadata:\nname: test-vpc-2\nspec:\nnamespaces:\n- ns2\n</code></pre> <ul> <li><code>namespaces</code> \u53ef\u4ee5\u9650\u5b9a\u53ea\u6709\u54ea\u4e9b Namespace \u53ef\u4ee5\u4f7f\u7528\u5f53\u524d VPC\uff0c\u82e5\u4e3a\u7a7a\u5219\u4e0d\u9650\u5b9a\u3002</li> </ul> <p>\u521b\u5efa\u4e24\u4e2a\u5b50\u7f51\uff0c\u5206\u5c5e\u4e24\u4e2a\u4e0d\u540c\u7684 VPC \u5e76\u6709\u76f8\u540c\u7684 CIDR:</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: net1\nspec:\nvpc: test-vpc-1\ncidrBlock: 10.0.1.0/24\nprotocol: IPv4\nnamespaces:\n- ns1\n---\napiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: net2\nspec:\nvpc: test-vpc-2\ncidrBlock: 10.0.1.0/24\nprotocol: IPv4\nnamespaces:\n- ns2\n</code></pre> <p>\u5206\u522b\u5728\u4e24\u4e2a Namespace \u4e0b\u521b\u5efa Pod:</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nannotations:\novn.kubernetes.io/logical_switch: net1\nnamespace: ns1\nname: vpc1-pod\nspec:\ncontainers:\n- name: vpc1-pod\nimage: docker.io/library/nginx:alpine\n---\napiVersion: v1\nkind: Pod\nmetadata:\nannotations:\novn.kubernetes.io/logical_switch: net2\nnamespace: ns2\nname: vpc2-pod\nspec:\ncontainers:\n- name: vpc2-pod\nimage: docker.io/library/nginx:alpine\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\u53ef\u89c2\u5bdf\u4e24\u4e2a Pod \u5730\u5740\u5c5e\u4e8e\u540c\u4e00\u4e2a CIDR\uff0c\u4f46\u7531\u4e8e\u8fd0\u884c\u5728\u4e0d\u540c\u7684\u79df\u6237 VPC\uff0c\u4e24\u4e2a Pod \u65e0\u6cd5\u76f8\u4e92\u8bbf\u95ee\u3002</p>"},{"location":"network/kube-ovn/features/vpc/#vpc-pod-livenessprobe-readinessprobe","title":"\u81ea\u5b9a\u4e49 VPC Pod \u652f\u6301 livenessProbe \u548c readinessProbe","text":"<p>\u7531\u4e8e\u5e38\u89c4\u914d\u7f6e\u4e0b\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684 Pod \u548c\u8282\u70b9\u7684\u7f51\u7edc\u4e4b\u95f4\u5e76\u4e0d\u4e92\u901a\uff0c\u6240\u4ee5 kubelet \u53d1\u9001\u7684\u63a2\u6d4b\u62a5\u6587\u65e0\u6cd5\u5230\u8fbe\u81ea\u5b9a VPC \u5185\u7684 Pod\u3002Kube-OVN \u901a\u8fc7 TProxy \u5c06 kubelet \u53d1\u9001\u7684\u63a2\u6d4b\u62a5\u6587\u91cd\u5b9a\u5411\u5230\u81ea\u5b9a\u4e49 VPC \u5185\u7684 Pod\uff0c\u4ece\u800c\u5b9e\u73b0\u8fd9\u4e00\u529f\u80fd\u3002</p> <p>\u914d\u7f6e\u65b9\u6cd5\u5982\u4e0b\uff0c\u5728 Daemonset <code>kube-ovn-cni</code> \u4e2d\u589e\u52a0\u53c2\u6570 <code>--enable-tproxy=true</code>\uff1a</p> <pre><code>spec:\ntemplate:\nspec:\ncontainers:\n- args:\n- --enable-tproxy=true\n</code></pre> <p>\u8be5\u529f\u80fd\u9650\u5236\u6761\u4ef6\uff1a</p> <ol> <li>\u5f53\u540c\u4e00\u4e2a\u8282\u70b9\u4e0b\u51fa\u73b0\u4e0d\u540c VPC \u4e0b\u7684 Pod \u5177\u6709\u76f8\u540c\u7684 IP\uff0c\u63a2\u6d4b\u529f\u80fd\u5931\u6548\u3002</li> <li>\u76ee\u524d\u6682\u65f6\u53ea\u652f\u6301 <code>tcpSocket</code> \u548c <code>httpGet</code> \u4e24\u79cd\u63a2\u6d4b\u65b9\u5f0f\u3002</li> </ol>"},{"location":"network/kube-ovn/features/vpc/#vpc_1","title":"\u521b\u5efa VPC \u7f51\u5173","text":"<p>\u6ce8\u610f</p> <p>\u81ea\u5b9a\u4e49 VPC \u4e0b\u7684\u5b50\u7f51\u4e0d\u652f\u6301\u9ed8\u8ba4 VPC \u4e0b\u7684\u5206\u5e03\u5f0f\u7f51\u5173\u548c\u96c6\u4e2d\u5f0f\u7f51\u5173\u3002</p> <p>VPC \u5185\u5bb9\u5668\u8bbf\u95ee\u5916\u90e8\u7f51\u7edc\u9700\u8981\u901a\u8fc7 VPC \u7f51\u5173\uff0cVPC \u7f51\u5173\u53ef\u4ee5\u6253\u901a\u7269\u7406\u7f51\u7edc\u548c\u79df\u6237\u7f51\u7edc\uff0c\u5e76\u63d0\u4f9b \u6d6e\u52a8 IP\uff0cSNAT \u548c DNAT \u529f\u80fd\u3002</p> <p>VPC \u7f51\u5173\u529f\u80fd\u4f9d\u8d56 Multus-CNI \u7684\u591a\u7f51\u5361\u529f\u80fd\uff0c\u5b89\u88c5\u8bf7\u53c2\u8003 multus-cni\u3002</p>"},{"location":"network/kube-ovn/features/vpc/#_2","title":"\u914d\u7f6e\u5916\u90e8\u7f51\u7edc","text":"<pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: ovn-vpc-external-network\nspec:\nprotocol: IPv4\nprovider: ovn-vpc-external-network.kube-system\ncidrBlock: 192.168.0.0/24\ngateway: 192.168.0.1  # IP address of the physical gateway\nexcludeIps:\n- 192.168.0.1..192.168.0.10\n---\napiVersion: \"k8s.cni.cncf.io/v1\"\nkind: NetworkAttachmentDefinition\nmetadata:\nname: ovn-vpc-external-network\nnamespace: kube-system\nspec:\nconfig: '{\n\"cniVersion\": \"0.3.0\",\n\"type\": \"macvlan\",\n\"master\": \"eth1\",\n\"mode\": \"bridge\",\n\"ipam\": {\n\"type\": \"kube-ovn\",\n\"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\",\n\"provider\": \"ovn-vpc-external-network.kube-system\"\n}\n}'\n</code></pre> <ul> <li>\u8be5 Subnet \u7528\u6765\u7ba1\u7406\u53ef\u7528\u7684\u5916\u90e8\u5730\u5740\uff0c\u7f51\u6bb5\u5185\u7684\u5730\u5740\u5c06\u4f1a\u901a\u8fc7 Macvlan \u5206\u914d\u7ed9 VPC \u7f51\u5173\uff0c\u8bf7\u548c\u7f51\u7edc\u7ba1\u7406\u6c9f\u901a\u7ed9\u51fa\u53ef\u7528\u7684\u7269\u7406\u6bb5 IP\u3002</li> <li>VPC \u7f51\u5173\u4f7f\u7528 Macvlan \u505a\u7269\u7406\u7f51\u7edc\u914d\u7f6e\uff0cNetworkAttachmentDefinition \u7684 master \u9700\u4e3a\u5bf9\u5e94\u7269\u7406\u7f51\u8def\u7f51\u5361\u7684\u7f51\u5361\u540d\u3002</li> <li><code>name</code> \u5916\u90e8\u7f51\u7edc\u540d\u79f0</li> </ul> <p>\u5728 Macvlan \u6a21\u5f0f\u4e0b\uff0c\u9644\u5c5e\u7f51\u5361\u4f1a\u5c06\u6570\u636e\u5305\u76f4\u63a5\u901a\u8fc7\u8be5\u8282\u70b9\u7f51\u5361\u5bf9\u5916\u53d1\u9001\uff0cL2/L3 \u5c42\u9762\u7684\u8f6c\u53d1\u80fd\u529b\u9700\u8981\u4f9d\u8d56\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u3002 \u9700\u8981\u9884\u5148\u5728\u5e95\u5c42\u7f51\u7edc\u8bbe\u5907\u914d\u7f6e\u5bf9\u5e94\u7684\u7f51\u5173\u3001Vlan \u548c\u5b89\u5168\u7b56\u7565\u7b49\u914d\u7f6e\u3002</p> <ol> <li>\u5bf9\u4e8e OpenStack \u7684 VM \u73af\u5883\uff0c\u9700\u8981\u5c06\u5bf9\u5e94\u7f51\u7edc\u7aef\u53e3\u7684 <code>PortSecurity</code> \u5173\u95ed\u3002</li> <li>\u5bf9\u4e8e VMware \u7684 vSwitch \u7f51\u7edc\uff0c\u9700\u8981\u5c06 <code>MAC Address Changes</code>, <code>Forged Transmits</code> \u548c <code>Promiscuous Mode Operation</code> \u8bbe\u7f6e\u4e3a <code>allow</code>\u3002</li> <li>\u5bf9\u4e8e Hyper-V \u865a\u62df\u5316\uff0c\u9700\u8981\u5f00\u542f\u865a\u62df\u673a\u7f51\u5361\u9ad8\u7ea7\u529f\u80fd\u4e2d\u7684 <code>MAC Address Spoofing</code>\u3002</li> <li>\u516c\u6709\u4e91\uff0c\u4f8b\u5982 AWS\u3001GCE\u3001\u963f\u91cc\u4e91\u7b49\u7531\u4e8e\u4e0d\u652f\u6301\u7528\u6237\u81ea\u5b9a\u4e49 Mac \u65e0\u6cd5\u652f\u6301 Macvlan \u6a21\u5f0f\u7f51\u7edc\u3002</li> <li>\u7531\u4e8e Macvlan \u672c\u8eab\u7684\u9650\u5236\uff0cMacvlan \u5b50\u63a5\u53e3\u65e0\u6cd5\u8bbf\u95ee\u7236\u63a5\u53e3\u5730\u5740\u3002</li> <li>\u5982\u679c\u7269\u7406\u7f51\u5361\u5bf9\u5e94\u4ea4\u6362\u673a\u63a5\u53e3\u4e3a Trunk \u6a21\u5f0f\uff0c\u9700\u8981\u5728\u8be5\u7f51\u5361\u4e0a\u521b\u5efa\u5b50\u63a5\u53e3\u518d\u63d0\u4f9b\u7ed9 Macvlan \u4f7f\u7528\u3002</li> </ol>"},{"location":"network/kube-ovn/features/vpc/#vpc_2","title":"\u5f00\u542f VPC \u7f51\u5173\u529f\u80fd","text":"<p>VPC \u7f51\u5173\u529f\u80fd\u9700\u8981\u901a\u8fc7 <code>kube-system</code> \u4e0b\u7684 <code>ovn-vpc-nat-gw-config</code> \u5f00\u542f\uff1a</p> <pre><code>---\nkind: ConfigMap\napiVersion: v1\nmetadata:\nname: ovn-vpc-nat-config\nnamespace: kube-system\ndata:\nimage: 'docker.io/kubeovn/vpc-nat-gateway:v1.12.0' ---\nkind: ConfigMap\napiVersion: v1\nmetadata:\nname: ovn-vpc-nat-gw-config\nnamespace: kube-system\ndata:\nenable-vpc-nat-gw: 'true'\n</code></pre> <ul> <li><code>image</code>: \u7f51\u5173 Pod \u6240\u4f7f\u7528\u7684\u955c\u50cf\u3002</li> <li><code>enable-vpc-nat-gw</code>\uff1a \u63a7\u5236\u662f\u5426\u542f\u7528 VPC \u7f51\u5173\u529f\u80fd\u3002</li> </ul>"},{"location":"network/kube-ovn/features/vpc/#vpc_3","title":"\u521b\u5efa VPC \u7f51\u5173\u5e76\u914d\u7f6e\u9ed8\u8ba4\u8def\u7531","text":"<pre><code>kind: VpcNatGateway\napiVersion: kubeovn.io/v1\nmetadata:\nname: gw1\nspec:\nvpc: test-vpc-1\nsubnet: net1\nlanIp: 10.0.1.254\nselector:\n- \"kubernetes.io/hostname: kube-ovn-worker\"\n- \"kubernetes.io/os: linux\"\nexternalSubnets:\n- ovn-vpc-external-network\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>vpc</code> \u8be5 <code>VpcNatGateway</code> \u6240\u5c5e\u7684 VPC\u3002 <code>subnet</code> \u4e3a VPC \u5185\u67d0\u4e2a <code>Subnet</code> \u540d\uff0cVPC \u7f51\u5173 Pod \u4f1a\u5728\u8be5\u5b50\u7f51\u4e0b\u7528 <code>lanIp</code> \u6765\u8fde\u63a5\u79df\u6237\u7f51\u7edc\u3002 <code>lanIp</code> <code>subnet</code> \u5185\u67d0\u4e2a\u672a\u88ab\u4f7f\u7528\u7684 IP\uff0cVPC \u7f51\u5173 Pod \u6700\u7ec8\u4f1a\u4f7f\u7528\u8be5 Pod\u3002\u5f53 VPC \u914d\u7f6e\u8def\u7531\u9700\u8981\u6307\u5411\u5f53\u524d <code>VpcNatGateway</code> \u65f6 <code>nextHopIP</code> \u9700\u8981\u8bbe\u7f6e\u4e3a\u8fd9\u4e2a <code>lanIp</code>\u3002 <code>selector</code> <code>VpcNatGateway</code> Pod \u7684\u8282\u70b9\u9009\u62e9\u5668\uff0c\u683c\u5f0f\u548c Kubernetes \u4e2d\u7684 NodeSelector \u683c\u5f0f\u76f8\u540c\u3002 <code>externalSubnets</code> VPC \u7f51\u5173\u4f7f\u7528\u7684\u5916\u90e8\u7f51\u7edc\uff0c\u5982\u679c\u4e0d\u914d\u7f6e\u5219\u9ed8\u8ba4\u4f7f\u7528 <code>ovn-vpc-external-network</code>\uff0c\u5f53\u524d\u7248\u672c\u53ea\u652f\u6301\u914d\u7f6e\u4e00\u4e2a\u5916\u90e8\u7f51\u7edc\u3002 <code>tolerations</code> \u4e3a VPC \u7f51\u5173\u914d\u7f6e\u5bb9\u5fcd\u5ea6\uff0c\u5177\u4f53\u914d\u7f6e\u53c2\u8003 \u6c61\u70b9\u548c\u5bb9\u5fcd\u5ea6\u3002\uff08\u53ef\u914d\uff09 <code>affinity</code> \u4e3a VPC \u7f51\u5173 Pod \u6216\u8282\u70b9\u914d\u7f6e\u4eb2\u548c\u6027\uff0c\u5177\u4f53\u8bbe\u7f6e\u53c2\u8003 \u4eb2\u548c\u6027\u4e0e\u53cd\u4eb2\u548c\u6027\u3002\uff08\u53ef\u914d\uff09"},{"location":"network/kube-ovn/features/vpc/#eip","title":"\u521b\u5efa EIP","text":"<p>EIP \u4e3a\u5916\u90e8\u7f51\u7edc\u6bb5\u7684\u67d0\u4e2a IP \u5206\u914d\u7ed9 VPC \u7f51\u5173\u540e\u53ef\u8fdb\u884c DNAT\uff0cSNAT \u548c\u6d6e\u52a8 IP \u64cd\u4f5c\u3002</p> <p>\u968f\u673a\u5206\u914d\u4e00\u4e2a\u5730\u5740\u7ed9 EIP\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: IptablesEIP\nmetadata:\nname: eip-random\nspec:\nnatGwDp: gw1\n</code></pre> <p>\u56fa\u5b9a EIP \u5730\u5740\u5206\u914d\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: IptablesEIP\nmetadata:\nname: eip-static\nspec:\nnatGwDp: gw1\nv4ip: 10.0.1.111\n</code></pre> <p>\u6307\u5b9a EIP \u6240\u5728\u7684\u5916\u90e8\u7f51\u7edc\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: IptablesEIP\nmetadata:\nname: eip-random\nspec:\nnatGwDp: gw1\nexternalSubnet: ovn-vpc-external-network\n</code></pre> <ul> <li><code>externalSubnet</code>\uff1a EIP \u6240\u5728\u5916\u90e8\u7f51\u7edc\u540d\u79f0\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u5219\u9ed8\u8ba4\u4e3a <code>ovn-vpc-external-network</code>\uff0c\u5982\u679c\u6307\u5b9a\u5219\u5fc5\u987b\u4e3a\u6240\u5728 VPC \u7f51\u5173\u7684 <code>externalSubnets</code> \u4e2d\u7684\u4e00\u4e2a\u3002</li> </ul>"},{"location":"network/kube-ovn/features/vpc/#dnat","title":"\u521b\u5efa DNAT \u89c4\u5219","text":"<p>\u901a\u8fc7 DNAT \u89c4\u5219\uff0c\u5916\u90e8\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a EIP \u52a0\u7aef\u53e3\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee VPC \u5185\u7684\u4e00\u4e2a IP \u548c\u7aef\u53e3\u3002</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: IptablesEIP\nmetadata:\nname: eipd01\nspec:\nnatGwDp: gw1\n---\nkind: IptablesDnatRule\napiVersion: kubeovn.io/v1\nmetadata:\nname: dnat01\nspec:\neip: eipd01 externalPort: '8888'\ninternalIp: 10.0.1.10\ninternalPort: '80'\nprotocol: tcp\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#snat","title":"\u521b\u5efa SNAT \u89c4\u5219","text":"<p>\u901a\u8fc7 SNAT \u89c4\u5219\uff0cVPC \u5185\u7684 Pod \u8bbf\u95ee\u5916\u90e8\u7684\u5730\u5740\u65f6\u5c06\u4f1a\u901a\u8fc7\u5bf9\u5e94 EIP \u8fdb\u884c SNAT\u3002</p> <pre><code>---\napiVersion: kubeovn.io/v1\nkind: IptablesEIP\nmetadata:\nname: eips01\nspec:\nnatGwDp: gw1\n---\napiVersion: kubeovn.io/v1\nkind: IptablesSnatRule\nmetadata:\nname: snat01\nspec:\neip: eips01\ninternalCIDR: 10.0.1.0/24\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#ip","title":"\u521b\u5efa\u6d6e\u52a8 IP","text":"<p>\u901a\u8fc7\u6d6e\u52a8 IP \u89c4\u5219\uff0cVPC \u5185\u7684\u4e00\u4e2a IP \u4f1a\u548c EIP \u8fdb\u884c\u5b8c\u5168\u6620\u5c04\uff0c\u5916\u90e8\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a EIP \u65b9\u4f4d VPC \u5185\u7684 IP\uff0cVPC \u5185\u7684\u8fd9\u4e2a IP \u8bbf\u95ee\u5916\u90e8\u5730\u5740\u65f6\u4e5f\u4f1a SNAT \u6210\u8fd9\u4e2a EIP\u3002</p> <pre><code>---\napiVersion: kubeovn.io/v1\nkind: IptablesEIP\nmetadata:\nname: eipf01\nspec:\nnatGwDp: gw1\n---\napiVersion: kubeovn.io/v1\nkind: IptablesFIPRule\nmetadata:\nname: fip01\nspec:\neip: eipf01\ninternalIp: 10.0.1.5\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#_3","title":"\u81ea\u5b9a\u4e49\u8def\u7531","text":"<p>\u5728\u81ea\u5b9a\u4e49 VPC \u5185\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7f51\u7edc\u5185\u90e8\u7684\u8def\u7531\u89c4\u5219\uff0c\u7ed3\u5408\u7f51\u5173\u5b9e\u73b0\u66f4\u7075\u6d3b\u7684\u8f6c\u53d1\u3002 Kube-OVN \u652f\u6301\u9759\u6001\u8def\u7531\u548c\u66f4\u4e3a\u7075\u6d3b\u7684\u7b56\u7565\u8def\u7531\u3002</p>"},{"location":"network/kube-ovn/features/vpc/#_4","title":"\u9759\u6001\u8def\u7531","text":"<pre><code>apiVersion: kubeovn.io/v1\nkind: Vpc\nmetadata:\nname: test-vpc-1\nspec:\nstaticRoutes:\n- cidr: 0.0.0.0/0\nnextHopIP: 10.0.1.254\npolicy: policyDst\n- cidr: 172.31.0.0/24\nnextHopIP: 10.0.1.253\npolicy: policySrc\nrouteTable: \"rtb1\"\n</code></pre> <ul> <li><code>policy</code>: \u652f\u6301\u76ee\u7684\u5730\u5740\u8def\u7531 <code>policyDst</code> \u548c\u6e90\u5730\u5740\u8def\u7531 <code>policySrc</code>\u3002</li> <li>\u5f53\u8def\u7531\u89c4\u5219\u5b58\u5728\u91cd\u53e0\u65f6\uff0cCIDR \u63a9\u7801\u8f83\u957f\u7684\u89c4\u5219\u4f18\u5148\u7ea7\u66f4\u9ad8\uff0c\u82e5\u63a9\u7801\u957f\u5ea6\u76f8\u540c\u5219\u76ee\u7684\u5730\u5740\u8def\u7531\u4f18\u5148\u4e8e\u6e90\u5730\u5740\u8def\u7531\u3002</li> <li><code>routeTable</code>: \u53ef\u6307\u5b9a\u9759\u6001\u8def\u7531\u6240\u5728\u7684\u8def\u7531\u8868\uff0c\u9ed8\u8ba4\u5728\u4e3b\u8def\u7531\u8868\u3002\u5b50\u7f51\u5173\u8054\u8def\u7531\u8868\u8bf7\u53c2\u8003\u521b\u5efa\u5b50\u7f51</li> </ul>"},{"location":"network/kube-ovn/features/vpc/#_5","title":"\u7b56\u7565\u8def\u7531","text":"<p>\u9488\u5bf9\u9759\u6001\u8def\u7531\u5339\u914d\u7684\u6d41\u91cf\uff0c\u53ef\u901a\u8fc7\u7b56\u7565\u8def\u7531\u8fdb\u884c\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\u3002\u7b56\u7565\u8def\u7531\u63d0\u4f9b\u4e86\u66f4\u7cbe\u786e\u7684\u5339\u914d\u89c4\u5219\uff0c\u4f18\u5148\u7ea7\u63a7\u5236 \u548c\u66f4\u591a\u7684\u8f6c\u53d1\u52a8\u4f5c\u3002\u8be5\u529f\u80fd\u4e3a OVN \u5185\u90e8\u903b\u8f91\u8def\u7531\u5668\u7b56\u7565\u529f\u80fd\u7684\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\uff0c\u66f4\u591a\u4f7f\u7528\u4fe1\u606f\u8bf7\u53c2\u8003 Logical Router Policy\u3002</p> <p>\u7b80\u5355\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Vpc\nmetadata:\nname: test-vpc-1\nspec:\npolicyRoutes:\n- action: drop\nmatch: ip4.src==10.0.1.0/24 &amp;&amp; ip4.dst==10.0.1.250\npriority: 11\n- action: reroute\nmatch: ip4.src==10.0.1.0/24\nnextHopIP: 10.0.1.252\npriority: 10\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#_6","title":"\u81ea\u5b9a\u4e49\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u89c4\u5219","text":"<p>Kubernetes \u672c\u8eab\u63d0\u4f9b\u7684 Service \u80fd\u529b\u53ef\u4ee5\u5b8c\u6210\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u7684\u529f\u80fd\uff0c\u4f46\u662f\u53d7\u9650\u4e8e Kubernetes \u5b9e\u73b0\uff0c Service \u7684 IP \u5730\u5740\u662f\u5168\u5c40\u5206\u914d\u4e14\u4e0d\u80fd\u91cd\u590d\u3002\u5bf9\u4e8e VPC \u7684\u4f7f\u7528\u573a\u666f\uff0c\u7528\u6237\u5e0c\u671b\u80fd\u81ea\u5b9a\u4e49\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u7684\u5730\u5740 \u8303\u56f4\uff0c\u4e0d\u540c VPC \u4e0b\u7684\u8d1f\u8f7d\u5747\u8861\u5730\u5740\u53ef\u80fd\u91cd\u53e0\uff0cKubernetes \u5185\u7f6e\u7684 Service \u529f\u80fd\u65e0\u6cd5\u5b8c\u5168\u6ee1\u8db3\u3002</p> <p>\u9488\u5bf9\u8fd9\u7c7b\u573a\u666f\uff0cKube-OVN \u63d0\u4f9b\u4e86 <code>SwitchLBRule</code> \u8d44\u6e90\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u7684\u5730\u5740\u8303\u56f4\u3002</p> <p>\u4e00\u4e2a <code>SwitchLBRule</code> \u4f8b\u5b50\u5982\u4e0b\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: SwitchLBRule\nmetadata:\nname:  cjh-slr-nginx\nspec:\nvip: 1.1.1.1\nsessionAffinity: ClientIP\nnamespace: default\nselector:\n- app:nginx\nports:\n- name: dns\nport: 8888\ntargetPort: 80\nprotocol: TCP\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>vip</code> \u81ea\u5b9a\u4e49\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u7684\u5730\u5740\u3002 <code>namespace</code> \u8d1f\u8f7d\u5747\u8861\u5668\u540e\u7aef Pod \u6240\u5728\u7684 Namespace\u3002 <code>sessionAffinity</code> \u548c Service \u7684 sessionAffinity \u529f\u80fd\u76f8\u540c\u3002 <code>selector</code> \u548c Service \u7684 selector \u529f\u80fd\u76f8\u540c\u3002 <code>ports</code> \u548c Service \u7684 port \u529f\u80fd\u76f8\u540c\u3002 <p>\u67e5\u770b\u90e8\u7f72\u7684\u5185\u90e8\u8d1f\u8f7d\u5747\u8861\u5668\u89c4\u5219\uff1a</p> <pre><code>$ kubectl get slr\nNAME                VIP         PORT(S)                  SERVICE                             AGE\nvpc-dns-test-cjh2   10.96.0.3   53/UDP,53/TCP,9153/TCP   kube-system/slr-vpc-dns-test-cjh2   88m\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#vpc-dns","title":"\u81ea\u5b9a\u4e49 vpc-dns","text":"<p>\u7531\u4e8e\u81ea\u5b9a\u4e49 VPC \u548c\u9ed8\u8ba4 VPC \u7f51\u7edc\u76f8\u4e92\u9694\u79bb\uff0cVPC \u5185 Pod \u65e0\u6cd5\u4f7f\u7528\u9ed8\u8ba4\u7684 coredns \u670d\u52a1\u8fdb\u884c\u57df\u540d\u89e3\u6790\u3002 \u5982\u679c\u5e0c\u671b\u5728\u81ea\u5b9a\u4e49 VPC \u5185\u4f7f\u7528 coredns \u89e3\u6790\u96c6\u7fa4\u5185 Service \u57df\u540d\uff0c\u53ef\u4ee5\u901a\u8fc7 Kube-OVN \u63d0\u4f9b\u7684 vpc-dns \u8d44\u6e90\u6765\u5b9e\u73b0\u3002</p>"},{"location":"network/kube-ovn/features/vpc/#_7","title":"\u521b\u5efa\u9644\u52a0\u7f51\u5361","text":"<pre><code>apiVersion: \"k8s.cni.cncf.io/v1\"\nkind: NetworkAttachmentDefinition\nmetadata:\nname: ovn-nad\nnamespace: default\nspec:\nconfig: '{\n\"cniVersion\": \"0.3.0\",\n\"type\": \"kube-ovn\",\n\"server_socket\": \"/run/openvswitch/kube-ovn-daemon.sock\",\n\"provider\": \"ovn-nad.default.ovn\"\n}'\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#ovn-default-provider","title":"\u4fee\u6539 ovn-default \u903b\u8f91\u4ea4\u6362\u673a\u7684 provider","text":"<p>\u4fee\u6539 <code>ovn-default</code> \u7684 provider\uff0c\u4e3a\u4e0a\u9762 nad \u914d\u7f6e\u7684 provider <code>ovn-nad.default.ovn</code>\uff1a</p> <pre><code>apiVersion: kubeovn.io/v1\nkind: Subnet\nmetadata:\nname: ovn-default\nspec:\ncidrBlock: 10.16.0.0/16\ndefault: true\ndisableGatewayCheck: false\ndisableInterConnection: false\nenableDHCP: false\nenableIPv6RA: false\nexcludeIps:\n- 10.16.0.1\ngateway: 10.16.0.1\ngatewayType: distributed\nlogicalGateway: false\nnatOutgoing: true\nprivate: false\nprotocol: IPv4\nprovider: ovn-nad.default.ovn\nvpc: ovn-cluster\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#vpc-dns-configmap","title":"\u914d\u7f6e vpc-dns \u7684 ConfigMap","text":"<p>\u5728 <code>kube-system</code> \u547d\u540d\u7a7a\u95f4\u4e0b\u521b\u5efa <code>configmap</code>\uff0c\u914d\u7f6e <code>vpc-dns</code> \u4f7f\u7528\u53c2\u6570\uff0c\u7528\u4e8e\u540e\u9762\u542f\u52a8 <code>vpc-dns</code> \u529f\u80fd\uff1a</p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\nname: vpc-dns-config\nnamespace: kube-system\ndata:\ncoredns-vip: 10.96.0.3\nenable-vpc-dns: true\nnad-name: ovn-nad\nnad-provider: ovn-nad.default.ovn\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>enable-vpc-dns</code> \uff08\u53ef\u7f3a\u7701\uff09<code>true</code> \u542f\u7528\u529f\u80fd\uff0cfalse \u5173\u95ed\u529f\u80fd\u3002\u9ed8\u8ba4 <code>true</code>\u3002 <code>coredns-image</code> \uff08\u53ef\u7701\u7565\uff09\uff1adns \u90e8\u7f72\u955c\u50cf\u3002\u9ed8\u8ba4\u4e3a\u96c6\u7fa4 coredns \u90e8\u7f72\u7248\u672c\u3002 <code>coredns-template</code> \uff08\u53ef\u7701\u7565\uff09\uff1adns \u90e8\u7f72\u6a21\u677f\u6240\u5728\u7684 URL\u3002\u9ed8\u8ba4\uff1a\u5f53\u524d\u7248\u672c\u4ed3\u5e93\u91cc\u7684 <code>yamls/coredns-template.yaml</code> <code>coredns-vip</code> \u4e3a coredns \u63d0\u4f9b lb \u670d\u52a1\u7684 <code>vip</code>\u3002 <code>nad-name</code> \u914d\u7f6e\u7684 <code>network-attachment-definitions</code> \u8d44\u6e90\u540d\u79f0\u3002 <code>nad-provider</code> \u4f7f\u7528\u7684 <code>provider</code> \u540d\u79f0\u3002 <code>k8s-service-host</code> \uff08\u53ef\u7f3a\u7701\uff09 \u7528\u4e8e coredns \u8bbf\u95ee k8s apiserver \u670d\u52a1\u7684 <code>ip</code>\u3002 <code>k8s-service-port</code> \uff08\u53ef\u7f3a\u7701\uff09\u7528\u4e8e coredns \u8bbf\u95ee k8s apiserver \u670d\u52a1\u7684 <code>port</code>\u3002"},{"location":"network/kube-ovn/features/vpc/#vpc-dns_1","title":"\u90e8\u7f72 vpc-dns \u4f9d\u8d56\u8d44\u6e90","text":"<pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\nlabels:\nkubernetes.io/bootstrapping: rbac-defaults\nname: system:vpc-dns\nrules:\n- apiGroups:\n- \"\"\nresources:\n- endpoints\n- services\n- pods\n- namespaces\nverbs:\n- list\n- watch\n- apiGroups:\n- discovery.k8s.io\nresources:\n- endpointslices\nverbs:\n- list\n- watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\nannotations:\nrbac.authorization.kubernetes.io/autoupdate: \"true\"\nlabels:\nkubernetes.io/bootstrapping: rbac-defaults\nname: vpc-dns\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: system:vpc-dns\nsubjects:\n- kind: ServiceAccount\nname: vpc-dns\nnamespace: kube-system\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\nname: vpc-dns\nnamespace: kube-system\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\nname: vpc-dns-corefile\nnamespace: kube-system\ndata:\nCorefile: |\n.:53 {\nerrors\nhealth {\nlameduck 5s\n}\nready\nkubernetes cluster.local in-addr.arpa ip6.arpa {\npods insecure\nfallthrough in-addr.arpa ip6.arpa\n}\nprometheus :9153\nforward . /etc/resolv.conf {\nprefer_udp\n}\ncache 30\nloop\nreload\nloadbalance\n}\n</code></pre>"},{"location":"network/kube-ovn/features/vpc/#vpc-dns_2","title":"\u90e8\u7f72 vpc-dns","text":"<pre><code>kind: VpcDns\napiVersion: kubeovn.io/v1\nmetadata:\nname: test-cjh1\nspec:\nvpc: cjh-vpc-1\nsubnet: cjh-subnet-1\n</code></pre> \u53c2\u6570\u5b57\u6bb5 \u63cf\u8ff0 <code>vpc</code> \u7528\u4e8e\u90e8\u7f72 dns \u7ec4\u4ef6\u7684 vpc \u540d\u79f0\u3002 <code>subnet</code> \u7528\u4e8e\u90e8\u7f72 dns \u7ec4\u4ef6\u7684\u5b50\u540d\u79f0\u3002 <p>\u67e5\u770b\u8d44\u6e90\u4fe1\u606f\uff1a</p> <pre><code>[root@hci-dev-mst-1 kubeovn]# kubectl get vpc-dns\nNAME        ACTIVE   VPC         SUBNET   test-cjh1   false    cjh-vpc-1   cjh-subnet-1   test-cjh2   true     cjh-vpc-1   cjh-subnet-2 </code></pre> <ul> <li><code>ACTIVE: true</code> \u6210\u529f\u90e8\u7f72\u4e86\u81ea\u5b9a\u4e49 dns \u7ec4\u4ef6\uff0c<code>false</code> \u65e0\u90e8\u7f72</li> </ul>"},{"location":"network/kube-ovn/features/vpc/#_8","title":"\u9650\u5236","text":"<ul> <li>\u4e00\u4e2a vpc \u4e0b\u53ea\u4f1a\u90e8\u7f72\u4e00\u4e2a\u81ea\u5b9a\u4e49 dns \u7ec4\u4ef6;</li> <li>\u5f53\u4e00\u4e2a vpc \u4e0b\u914d\u7f6e\u591a\u4e2a vpc-dns \u8d44\u6e90\uff08\u5373\u540c\u4e00\u4e2a vpc \u4e0d\u540c\u7684 <code>subnet</code>\uff09\uff0c\u53ea\u6709\u4e00\u4e2a vpc-dns \u8d44\u6e90\u72b6\u6001 <code>true</code>\uff0c\u5176\u4ed6\u4e3a <code>false</code>;</li> <li>\u5f53 <code>true</code> \u7684 vpc-dns \u88ab\u5220\u9664\u6389\uff0c\u4f1a\u83b7\u53d6\u5176\u4ed6 <code>false</code> \u7684 vpc-dns \u8fdb\u884c\u90e8\u7f72\u3002</li> </ul>"},{"location":"network/multus/","title":"Multus\u6982\u89c8","text":""},{"location":"network/sr-iov/","title":"SR-IOV\u6982\u89c8","text":""},{"location":"storage/","title":"\u5b58\u50a8\u6982\u89c8","text":""},{"location":"storage/#_2","title":"\u6982\u5ff5","text":"<p>PV\u5b9a\u4e49</p> <p>PV \u7684\u5168\u79f0\u662f\uff1a<code>PersistentVolume</code>\uff08\u6301\u4e45\u5316\u5377\uff09\uff0c\u662f\u5bf9\u5e95\u5c42\u5171\u4eab\u5b58\u50a8\u7684\u4e00\u79cd\u62bd\u8c61\uff0cPV \u7531\u7ba1\u7406\u5458\u8fdb\u884c\u521b\u5efa\u548c\u914d\u7f6e\uff0c\u5b83\u548c\u5177\u4f53\u7684\u5e95\u5c42\u7684\u5171\u4eab\u5b58\u50a8\u6280\u672f\u7684\u5b9e\u73b0\u65b9\u5f0f\u6709\u5173\uff0c\u6bd4\u5982 <code>Ceph</code>\u3001<code>GlusterFS</code>\u3001<code>NFS</code>\u3001<code>hostPath</code> \u7b49\uff0c\u90fd\u662f\u901a\u8fc7\u63d2\u4ef6\u673a\u5236\u5b8c\u6210\u4e0e\u5171\u4eab\u5b58\u50a8\u7684\u5bf9\u63a5\u3002</p> <p>PVC\u5b9a\u4e49</p> <p>PVC \u7684\u5168\u79f0\u662f\uff1a<code>PersistentVolumeClaim</code>\uff08\u6301\u4e45\u5316\u5377\u58f0\u660e\uff09\uff0cPVC \u662f\u7528\u6237\u5b58\u50a8\u7684\u4e00\u79cd\u58f0\u660e\uff0cPVC \u548c Pod \u6bd4\u8f83\u7c7b\u4f3c\uff0cPod \u6d88\u8017\u7684\u662f\u8282\u70b9\uff0cPVC \u6d88\u8017\u7684\u662f PV \u8d44\u6e90\uff0cPod \u53ef\u4ee5\u8bf7\u6c42 CPU \u548c\u5185\u5b58\uff0c\u800c PVC \u53ef\u4ee5\u8bf7\u6c42\u7279\u5b9a\u7684\u5b58\u50a8\u7a7a\u95f4\u548c\u8bbf\u95ee\u6a21\u5f0f\u3002\u5bf9\u4e8e\u771f\u6b63\u4f7f\u7528\u5b58\u50a8\u7684\u7528\u6237\u4e0d\u9700\u8981\u5173\u5fc3\u5e95\u5c42\u7684\u5b58\u50a8\u5b9e\u73b0\u7ec6\u8282\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5373\u53ef\u3002</p> <p>\u4f46\u662f\u901a\u8fc7 PVC \u8bf7\u6c42\u5230\u4e00\u5b9a\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u5f88\u6709\u53ef\u80fd\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u5e94\u7528\u5bf9\u4e8e\u5b58\u50a8\u8bbe\u5907\u7684\u5404\u79cd\u9700\u6c42\uff0c\u800c\u4e14\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\u5bf9\u4e8e\u5b58\u50a8\u6027\u80fd\u7684\u8981\u6c42\u53ef\u80fd\u4e5f\u4e0d\u5c3d\u76f8\u540c\uff0c\u6bd4\u5982\u8bfb\u5199\u901f\u5ea6\u3001\u5e76\u53d1\u6027\u80fd\u7b49\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0cKubernetes \u53c8\u4e3a\u6211\u4eec\u5f15\u5165\u4e86\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a<code>StorageClass</code>\uff0c\u901a\u8fc7 <code>StorageClass</code> \u7684\u5b9a\u4e49\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u5c06\u5b58\u50a8\u8d44\u6e90\u5b9a\u4e49\u4e3a\u67d0\u79cd\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u5feb\u901f\u5b58\u50a8\u3001\u6162\u901f\u5b58\u50a8\u7b49\uff0c\u7528\u6237\u6839\u636e <code>StorageClass</code> \u7684\u63cf\u8ff0\u5c31\u53ef\u4ee5\u975e\u5e38\u76f4\u89c2\u7684\u77e5\u9053\u5404\u79cd\u5b58\u50a8\u8d44\u6e90\u7684\u5177\u4f53\u7279\u6027\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6839\u636e\u5e94\u7528\u7684\u7279\u6027\u53bb\u7533\u8bf7\u5408\u9002\u7684\u5b58\u50a8\u8d44\u6e90\u4e86\uff0c\u6b64\u5916 StorageClass \u8fd8\u53ef\u4ee5\u4e3a\u6211\u4eec\u81ea\u52a8\u751f\u6210 PV\uff0c\u514d\u53bb\u4e86\u6bcf\u6b21\u624b\u52a8\u521b\u5efa\u7684\u9ebb\u70e6\u3002</p>"},{"location":"storage/#_3","title":"\u7814\u7a76\u5185\u5bb9","text":"<p>\u4ee5\u4e0b\u7814\u7a76\u5185\u5bb9\u7ec6\u5206\u4e86\u51e0\u9879\u4f9b\u8bfb\u8005\u5b66\u4e60\u548c\u53c2\u8003\u3002</p>"},{"location":"storage/#local","title":"Local \u672c\u5730\u5b58\u50a8","text":"<p>\u6211\u4eec\u6709\u901a\u8fc7 <code>hostPath</code> \u6216\u8005 <code>emptyDir</code> \u7684\u65b9\u5f0f\u6765\u6301\u4e45\u5316\u6211\u4eec\u7684\u6570\u636e\uff0c\u4f46\u662f\u663e\u7136\u6211\u4eec\u8fd8\u9700\u8981\u66f4\u52a0\u53ef\u9760\u7684\u5b58\u50a8\u6765\u4fdd\u5b58\u5e94\u7528\u7684\u6301\u4e45\u5316\u6570\u636e\uff0c\u8fd9\u6837\u5bb9\u5668\u5728\u91cd\u5efa\u540e\uff0c\u4f9d\u7136\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u6570\u636e\u3002\u4f46\u662f\u5b58\u50a8\u8d44\u6e90\u548c CPU \u8d44\u6e90\u4ee5\u53ca\u5185\u5b58\u8d44\u6e90\u6709\u5f88\u5927\u4e0d\u540c\uff0c\u4e3a\u4e86\u5c4f\u853d\u5e95\u5c42\u7684\u6280\u672f\u5b9e\u73b0\u7ec6\u8282\uff0c\u8ba9\u7528\u6237\u66f4\u52a0\u65b9\u4fbf\u7684\u4f7f\u7528\uff0cKubernetes \u4fbf\u5f15\u5165\u4e86 PV \u548c PVC \u4e24\u4e2a\u91cd\u8981\u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u5b9e\u73b0\u5bf9\u5b58\u50a8\u7684\u7ba1\u7406\u3002</p> <p>Local \u672c\u5730\u5b58\u50a8\u5206\u4e3a\u4ee5\u4e0b\u51e0\u7c7b\uff1a</p> <p>HostPath</p><p>HostPath</p> <p>Local PV</p><p>Local PV</p>"},{"location":"storage/#openebs","title":"OpenEBS \u5b58\u50a8","text":"<p>OpenEBS \u662f\u4e00\u79cd\u6a21\u62df\u4e86 AWS \u7684 EBS\u3001\u963f\u91cc\u4e91\u7684\u4e91\u76d8\u7b49\u5757\u5b58\u50a8\u5b9e\u73b0\u7684\u57fa\u4e8e\u5bb9\u5668\u7684\u5b58\u50a8\u5f00\u6e90\u8f6f\u4ef6\u3002OpenEBS \u662f\u4e00\u79cd\u57fa\u4e8e CAS(Container Attached Storage) \u7406\u5ff5\u7684\u5bb9\u5668\u89e3\u51b3\u65b9\u6848\uff0c\u5176\u6838\u5fc3\u7406\u5ff5\u662f\u5b58\u50a8\u548c\u5e94\u7528\u4e00\u6837\u91c7\u7528\u5fae\u670d\u52a1\u67b6\u6784\uff0c\u5e76\u901a\u8fc7 Kubernetes \u6765\u505a\u8d44\u6e90\u7f16\u6392\u3002\u5176\u67b6\u6784\u5b9e\u73b0\u4e0a\uff0c\u6bcf\u4e2a\u5377\u7684 Controller \u90fd\u662f\u4e00\u4e2a\u5355\u72ec\u7684 Pod\uff0c\u4e14\u4e0e\u5e94\u7528 Pod \u5728\u540c\u4e00\u4e2a\u8282\u70b9\uff0c\u5377\u7684\u6570\u636e\u4f7f\u7528\u591a\u4e2a Pod \u8fdb\u884c\u7ba1\u7406\u3002</p>"},{"location":"storage/#_4","title":"\u5b58\u50a8\u7ec4\u4ef6","text":"<p>OpenEBS \u6709\u5f88\u591a\u7ec4\u4ef6\uff0c\u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u51e0\u7c7b\uff1a</p> <p>\u63a7\u5236\u5e73\u9762</p><p>Control Plane</p> <p>\u6570\u636e\u5e73\u9762</p><p>Data Plane</p> <p>\u8282\u70b9\u78c1\u76d8\u7ba1\u7406\u5668</p><p>Node Disk Manager</p>"},{"location":"storage/#_5","title":"\u7279\u6027\u529f\u80fd","text":"<p>OpenEBS \u7279\u6027\u529f\u80fd\u5206\u4e3a\u4ee5\u4e0b\u51e0\u7c7b:</p> <p>\u5bb9\u5668\u9644\u52a0\u5b58\u50a8</p><p>Container Attached Storage</p> <p>\u540c\u6b65\u590d\u5236</p><p>Synchronous Replication</p> <p>\u5feb\u7167\u514b\u9686</p><p>Snapshot and Clone</p> <p>\u5907\u4efd\u6062\u590d</p><p>Backup and Restore</p>"},{"location":"storage/#ceph","title":"Ceph \u5b58\u50a8","text":"<p>Ceph \u662f\u4e00\u4e2a\u7edf\u4e00\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u63d0\u4f9b\u8f83\u597d\u7684\u6027\u80fd\u3001\u53ef\u9760\u6027\u548c\u53ef\u6269\u5c55\u6027\u3002\u6700\u65e9\u8d77\u6e90\u4e8e Sage \u535a\u58eb\u671f\u95f4\u7684\u5de5\u4f5c\uff0c\u968f\u540e\u8d21\u732e\u7ed9\u5f00\u6e90\u793e\u533a\u3002</p> <p>\u53c2\u8003\u5185\u5bb9\u5982\u4e0b:</p> <p>\u67b6\u6784\u548c\u7ec4\u4ef6</p><p>Infrastructure and Components</p> <p>\u5757\u5b58\u50a8</p><p>Block Storage</p> <p>\u90e8\u7f72\u5b89\u88c5</p><p>Installation</p>"},{"location":"storage/ceph/block-storage/","title":"\u5757\u5b58\u50a8","text":""},{"location":"storage/ceph/block-storage/#_1","title":"\u6587\u4ef6\u5b58\u50a8","text":"<p>\u5178\u578b\u8bbe\u5907 FTP\u3001NFS \u670d\u52a1\u5668\uff0c\u4e3a\u4e86\u514b\u670d\u5757\u5b58\u50a8\u6587\u4ef6\u65e0\u6cd5\u5171\u4eab\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u6709\u4e86\u6587\u4ef6\u5b58\u50a8\uff0c\u5728\u670d\u52a1\u5668\u4e0a\u67b6\u8bbe FTP \u4e0e NFS \u670d\u52a1\u5668\uff0c\u5c31\u662f\u6587\u4ef6\u5b58\u50a8\u3002</p> <p>\u4f18\u70b9</p> <p>\u9020\u4ef7\u4f4e\uff0c\u968f\u4fbf\u4e00\u53f0\u673a\u5668\u5c31\u53ef\u4ee5\u4e86 \u65b9\u4fbf\u6587\u4ef6\u53ef\u4ee5\u5171\u4eab</p> <p>\u7f3a\u70b9</p> <ul> <li>\u8bfb\u5199\u901f\u7387\u4f4e</li> <li>\u4f20\u8f93\u901f\u7387\u6162</li> </ul> <p>\u4f7f\u7528\u573a\u666f</p> <ul> <li>\u65e5\u5fd7\u5b58\u50a8</li> <li>\u6709\u76ee\u5f55\u7ed3\u6784\u7684\u6587\u4ef6\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"storage/ceph/block-storage/#_2","title":"\u5bf9\u8c61\u5b58\u50a8","text":"<p>\u5178\u578b\u8bbe\u5907</p> <p>\u5185\u7f6e\u5927\u5bb9\u91cf\u786c\u76d8\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u5668(swift, s3)\uff1b\u591a\u53f0\u670d\u52a1\u5668\u5185\u7f6e\u5927\u5bb9\u91cf\u786c\u76d8\uff0c\u5b89\u88c5\u4e0a\u5bf9\u8c61\u5b58\u50a8\u7ba1\u7406\u8f6f\u4ef6\uff0c\u5bf9\u5916\u63d0\u4f9b\u8bfb\u5199\u8bbf\u95ee\u529f\u80fd\u3002</p> <p>\u4f18\u70b9</p> <ul> <li>\u5177\u5907\u5757\u5b58\u50a8\u7684\u8bfb\u5199\u9ad8\u901f\u3002</li> <li>\u5177\u5907\u6587\u4ef6\u5b58\u50a8\u7684\u5171\u4eab\u7b49\u7279\u6027</li> </ul> <p>\u4f7f\u7528\u573a\u666f\uff1a(\u9002\u5408\u66f4\u65b0\u53d8\u52a8\u8f83\u5c11\u7684\u6570\u636e)</p> <ul> <li>\u56fe\u7247\u5b58\u50a8</li> <li>\u89c6\u9891\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"storage/ceph/infrastructure/","title":"\u67b6\u6784\u548c\u7ec4\u4ef6","text":"<p>Ceph \u662f\u4e00\u4e2a\u7edf\u4e00\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u63d0\u4f9b\u8f83\u597d\u7684\u6027\u80fd\u3001\u53ef\u9760\u6027\u548c\u53ef\u6269\u5c55\u6027\u3002\u6700\u65e9\u8d77\u6e90\u4e8e Sage \u535a\u58eb\u671f\u95f4\u7684\u5de5\u4f5c\uff0c\u968f\u540e\u8d21\u732e\u7ed9\u5f00\u6e90\u793e\u533a\u3002</p>"},{"location":"storage/ceph/infrastructure/#_1","title":"\u7b80\u4ecb","text":"<p>\u9ad8\u6027\u80fd</p> <ul> <li>\u629b\u5f03\u4e86\u4f20\u7edf\u7684\u96c6\u4e2d\u5f0f\u5b58\u50a8\u8fd0\u8f93\u5c40\u5bfb\u5740\u7684\u65b9\u6848\uff0c\u91c7\u7528 CRUSH \u7b97\u6cd5\uff0c\u6570\u636e\u5206\u5e03\u5747\u8861\uff0c\u5e76\u884c\u5ea6\u9ad8\u3002</li> <li>\u8003\u8651\u4e86\u5bb9\u707e\u57df\u7684\u9694\u79bb\uff0c\u80fd\u591f\u5b9e\u73b0\u5404\u7c7b\u8d1f\u8f7d\u7684\u526f\u672c\u8bbe\u7f6e\u89c4\u5219\uff0c\u4f8b\u5982\u8de8\u673a\u623f\u3001\u673a\u67b6\u611f\u77e5\u7b49\u3002</li> <li>\u80fd\u591f\u652f\u6301\u4e0a\u5343\u4e2a\u5b58\u50a8\u8282\u70b9\u7684\u89c4\u6a21\uff0c\u652f\u6301 TB \u5230 PB \u7ea7\u7684\u6570\u636e\u3002</li> </ul> <p>\u9ad8\u53ef\u7528\u6027</p> <ul> <li>\u526f\u672c\u6570\u53ef\u4ee5\u7075\u6d3b\u63a7\u5236</li> <li>\u652f\u6301\u6545\u969c\u57df\u5206\u79bb\uff0c\u6570\u636e\u5f3a\u4e00\u81f4\u6027</li> <li>\u591a\u79cd\u6545\u969c\u573a\u666f\u81ea\u52a8\u8fdb\u884c\u4fee\u590d\u81ea\u6108</li> <li>\u6ca1\u6709\u5355\u70b9\u6545\u969c\uff0c\u81ea\u52a8\u7ba1\u7406</li> </ul> <p>\u9ad8\u53ef\u6269\u5c55\u6027</p> <ul> <li>\u53bb\u4e2d\u5fc3\u5316</li> <li>\u6269\u5c55\u7075\u6d3b</li> <li>\u968f\u7740\u8282\u70b9\u589e\u52a0\u800c\u7ebf\u6027\u589e\u957f</li> </ul> <p>\u7279\u6027\u4e30\u5bcc</p> <ul> <li>\u652f\u6301\u4e09\u79cd\u5b58\u50a8\u63a5\u53e3\uff1a\u5757\u5b58\u50a8\u3001\u6587\u4ef6\u5b58\u50a8\u3001\u5bf9\u8c61\u5b58\u50a8</li> <li>\u652f\u6301\u81ea\u5b9a\u4e49\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u8bed\u8a00\u9a71\u52a8</li> </ul>"},{"location":"storage/ceph/infrastructure/#_2","title":"\u67b6\u6784","text":"<p>\u652f\u6301\u4e09\u79cd\u63a5\u53e3</p> <ul> <li><code>Object</code>\uff1a\u6709\u539f\u751f API\uff0c\u800c\u4e14\u4e5f\u517c\u5bb9 Swift \u548c S3 \u7684 API</li> <li><code>Block</code>\uff1a\u652f\u6301\u7cbe\u7b80\u914d\u7f6e\u3001\u5feb\u7167\u3001\u514b\u9686</li> <li><code>File</code>\uff1aPosix \u63a5\u53e3\uff0c\u652f\u6301\u5feb\u7167</li> </ul> <p></p>"},{"location":"storage/ceph/infrastructure/#_3","title":"\u7ec4\u4ef6","text":"\u7ec4\u4ef6 \u63cf\u8ff0 <code>Monitor</code> \u4e00\u4e2a Ceph \u96c6\u7fa4\u9700\u8981\u591a\u4e2a <code>Monitor</code> \u7ec4\u6210\u7684\u5c0f\u96c6\u7fa4\uff0c\u5b83\u4eec\u901a\u8fc7 Paxos \u540c\u6b65\u6570\u636e\uff0c\u7528\u6765\u4fdd\u5b58 OSD \u7684\u5143\u6570\u636e\u3002 <code>OSD</code> <code>Object Storage Device</code>\uff0c\u4e5f\u5c31\u662f\u8d1f\u8d23\u54cd\u5e94\u5ba2\u6237\u7aef\u8bf7\u6c42\u8fd4\u56de\u5177\u4f53\u6570\u636e\u7684\u8fdb\u7a0b\uff0c\u4e00\u4e2a Ceph \u96c6\u7fa4\u4e00\u822c\u90fd\u6709\u5f88\u591a\u4e2a OSD\u3002\u4e3b\u8981\u529f\u80fd\u7528\u4e8e\u6570\u636e\u7684\u5b58\u50a8\uff0c\u5f53\u76f4\u63a5\u4f7f\u7528\u786c\u76d8\u4f5c\u4e3a\u5b58\u50a8\u76ee\u6807\u65f6\uff0c\u4e00\u5757\u786c\u76d8\u79f0\u4e4b\u4e3a <code>OSD</code>\uff0c\u5f53\u4f7f\u7528\u4e00\u4e2a\u76ee\u5f55\u4f5c\u4e3a\u5b58\u50a8\u76ee\u6807\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u76ee\u5f55\u4e5f\u88ab\u79f0\u4e3a OSD\u3002 <code>MDS</code> <code>Ceph Metadata Server</code>\uff0c\u662f CephFS \u670d\u52a1\u4f9d\u8d56\u7684\u5143\u6570\u636e\u670d\u52a1\uff0c\u5bf9\u8c61\u5b58\u50a8\u548c\u5757\u8bbe\u5907\u5b58\u50a8\u4e0d\u9700\u8981\u8be5\u670d\u52a1\u3002 <code>Object</code> Ceph \u6700\u5e95\u5c42\u7684\u5b58\u50a8\u5355\u5143\u662f <code>Object</code> \u5bf9\u8c61\uff0c\u4e00\u6761\u6570\u636e\u3001\u4e00\u4e2a\u914d\u7f6e\u90fd\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u6bcf\u4e2a Object \u5305\u542b ID\u3001\u5143\u6570\u636e\u548c\u539f\u59cb\u6570\u636e\u3002 <code>Pool</code> <code>Pool</code> \u662f\u4e00\u4e2a\u5b58\u50a8\u5bf9\u8c61\u7684\u903b\u8f91\u5206\u533a\uff0c\u5b83\u901a\u5e38\u89c4\u5b9a\u4e86\u6570\u636e\u5197\u4f59\u7684\u7c7b\u578b\u4e0e\u526f\u672c\u6570\uff0c\u9ed8\u8ba4\u4e3a3\u526f\u672c\u3002\u5bf9\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684\u5b58\u50a8\uff0c\u9700\u8981\u5355\u72ec\u7684 Pool\uff0c\u5982 RBD\u3002 <code>PG</code> \u5168\u79f0 <code>Placement Groups</code>\uff0c\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u4e00\u4e2a <code>OSD</code> \u5305\u542b\u591a\u4e2a <code>PG</code>\u3002\u5f15\u5165 PG \u8fd9\u4e00\u5c42\u5176\u5b9e\u662f\u4e3a\u4e86\u66f4\u597d\u7684\u5206\u914d\u6570\u636e\u548c\u5b9a\u4f4d\u6570\u636e\u3002\u6bcf\u4e2a Pool \u5185\u5305\u542b\u5f88\u591a\u4e2a <code>PG</code>\uff0c\u5b83\u662f\u4e00\u4e2a\u5bf9\u8c61\u7684\u96c6\u5408\uff0c\u670d\u52a1\u7aef\u6570\u636e\u5747\u8861\u548c\u6062\u590d\u7684\u6700\u5c0f\u5355\u4f4d\u5c31\u662f PG\u3002 <code>FileStore</code>\u4e0e<code>BlueStore</code> <code>FileStore</code> \u662f\u8001\u7248\u672c\u9ed8\u8ba4\u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u4f7f\u7528 <code>FileStore</code>\uff0c\u5efa\u8bae\u4f7f\u7528 xfs \u6587\u4ef6\u7cfb\u7edf\u3002<code>BlueStore</code> \u662f\u4e00\u4e2a\u65b0\u7684\u540e\u7aef\u5b58\u50a8\u5f15\u64ce\uff0c\u53ef\u4ee5\u76f4\u63a5\u7ba1\u7406\u88f8\u786c\u76d8\uff0c\u629b\u5f03\u4e86 ext4 \u4e0e xfs \u7b49\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u3002\u53ef\u4ee5\u76f4\u63a5\u5bf9\u7269\u7406\u786c\u76d8\u8fdb\u884c\u64cd\u4f5c\uff0c\u540c\u65f6\u6548\u7387\u4e5f\u9ad8\u51fa\u5f88\u591a\u3002 <code>Rados</code> \u5168\u79f0 <code>Reliable Autonomic Distributed Object Store</code>\uff0c\u662f Ceph \u96c6\u7fa4\u7684\u7cbe\u534e\uff0c\u7528\u4e8e\u5b9e\u73b0\u6570\u636e\u5206\u914d\u3001Failover \u7b49\u96c6\u7fa4\u64cd\u4f5c\u3002 <code>Librados</code> <code>Librados</code> \u662f <code>Rados</code> \u63d0\u4f9b\u5e93\uff0c\u56e0\u4e3a <code>RADOS</code> \u662f\u534f\u8bae\u5f88\u96be\u76f4\u63a5\u8bbf\u95ee\uff0c\u56e0\u6b64\u4e0a\u5c42\u7684 <code>RBD</code>\u3001<code>RGW</code> \u548c <code>CephFS</code> \u90fd\u662f\u901a\u8fc7 librados \u8bbf\u95ee\u7684\uff0c\u76ee\u524d\u63d0\u4f9b PHP\u3001Ruby\u3001Java\u3001Python\u3001C \u548c C++ \u652f\u6301\u3002 <code>CRUSH</code> <code>CRUSH</code> \u662f Ceph \u4f7f\u7528\u7684\u6570\u636e\u5206\u5e03\u7b97\u6cd5\uff0c\u7c7b\u4f3c\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u8ba9\u6570\u636e\u5206\u914d\u5230\u9884\u671f\u7684\u5730\u65b9\u3002 <code>RBD</code> \u5168\u79f0 <code>RADOS Block Device</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u5757\u8bbe\u5907\u670d\u52a1\uff0c\u5982\u865a\u62df\u673a\u786c\u76d8\uff0c\u652f\u6301\u5feb\u7167\u529f\u80fd\u3002 <code>RGW</code> \u5168\u79f0\u662f <code>RADOS Gateway</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u63a5\u53e3\u4e0e S3 \u548c Swift \u517c\u5bb9\u3002 <code>CephFS</code> \u5168\u79f0 <code>Ceph File System</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u6587\u4ef6\u7cfb\u7edf\u670d\u52a1\u3002 <ul> <li>pool \u662f ceph \u5b58\u50a8\u6570\u636e\u65f6\u7684\u903b\u8f91\u5206\u533a\uff0c\u5b83\u8d77\u5230 namespace \u7684\u4f5c\u7528</li> <li>\u6bcf\u4e2a pool \u5305\u542b\u4e00\u5b9a\u6570\u91cf(\u53ef\u914d\u7f6e)\u7684 PG</li> <li>PG \u91cc\u7684\u5bf9\u8c61\u88ab\u6620\u5c04\u5230\u4e0d\u540c\u7684 Object \u4e0a</li> <li>pool \u662f\u5206\u5e03\u5230\u6574\u4e2a\u96c6\u7fa4\u7684</li> </ul>"},{"location":"storage/ceph/installation/","title":"\u90e8\u7f72\u5b89\u88c5","text":"<p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\uff0c\u4e5f\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>Rook</code> \u6765\u90e8\u7f72 Ceph \u96c6\u7fa4\uff0c<code>Rook</code> \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5b58\u50a8\u7f16\u6392\u5de5\u5177\uff0c\u63d0\u4f9b\u5e73\u53f0\u3001\u6846\u67b6\u548c\u5bf9\u5404\u79cd\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u7684\u652f\u6301\uff0c\u4ee5\u548c\u4e91\u539f\u751f\u73af\u5883\u8fdb\u884c\u672c\u5730\u96c6\u6210\u3002</p> <p><code>Rook</code> \u5c06\u5b58\u50a8\u8f6f\u4ef6\u8f6c\u53d8\u6210\u81ea\u6211\u7ba1\u7406\u3001\u81ea\u6211\u6269\u5c55\u548c\u81ea\u6211\u4fee\u590d\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u901a\u8fc7\u81ea\u52a8\u5316\u90e8\u7f72\u3001\u542f\u52a8\u3001\u914d\u7f6e\u3001\u4f9b\u5e94\u3001\u6269\u5c55\u3001\u5347\u7ea7\u3001\u8fc1\u79fb\u3001\u707e\u96be\u6062\u590d\u3001\u76d1\u63a7\u548c\u8d44\u6e90\u7ba1\u7406\u6765\u5b9e\u73b0\u3002<code>Rook</code> \u5e95\u5c42\u4f7f\u7528\u4e91\u539f\u751f\u5bb9\u5668\u7ba1\u7406\u3001\u8c03\u5ea6\u548c\u7f16\u6392\u5e73\u53f0\u63d0\u4f9b\u7684\u80fd\u529b\u6765\u63d0\u4f9b\u8fd9\u4e9b\u529f\u80fd\uff0c\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u5e73\u5e38\u8bf4\u7684 Operator\u3002<code>Rook</code> \u5229\u7528\u6269\u5c55\u529f\u80fd\u5c06\u5176\u6df1\u5ea6\u96c6\u6210\u5230\u4e91\u539f\u751f\u73af\u5883\u4e2d\uff0c\u5e76\u4e3a\u8c03\u5ea6\u3001\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u8d44\u6e90\u7ba1\u7406\u3001\u5b89\u5168\u6027\u3001\u76d1\u63a7\u7b49\u63d0\u4f9b\u4e86\u65e0\u7f1d\u7684\u4f53\u9a8c\u3002\u6709\u5173 <code>Rook</code> \u5f53\u524d\u652f\u6301\u7684\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u7684\u72b6\u6001\u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u53ef\u4ee5\u53c2\u8003 <code>Rook</code> \u4ed3\u5e93 \u7684\u9879\u76ee\u4ecb\u7ecd\u3002</p> <p></p> <p><code>Rook</code> \u5305\u542b\u591a\u4e2a\u7ec4\u4ef6\uff1a</p> <ul> <li><code>Rook Operator</code>\uff1aRook \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c<code>Rook Operator</code> \u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5bb9\u5668\uff0c\u81ea\u52a8\u542f\u52a8\u5b58\u50a8\u96c6\u7fa4\uff0c\u5e76\u76d1\u63a7\u5b58\u50a8\u5b88\u62a4\u8fdb\u7a0b\uff0c\u6765\u786e\u4fdd\u5b58\u50a8\u96c6\u7fa4\u7684\u5065\u5eb7\u3002</li> <li><code>Rook Agent</code>\uff1a\u5728\u6bcf\u4e2a\u5b58\u50a8\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5e76\u914d\u7f6e\u4e00\u4e2a <code>FlexVolume</code> \u6216\u8005 CSI \u63d2\u4ef6\uff0c\u548c Kubernetes \u7684\u5b58\u50a8\u5377\u63a7\u5236\u6846\u67b6\u8fdb\u884c\u96c6\u6210\u3002Agent \u5904\u7406\u6240\u6709\u7684\u5b58\u50a8\u64cd\u4f5c\uff0c\u4f8b\u5982\u6302\u63a5\u7f51\u7edc\u5b58\u50a8\u8bbe\u5907\u3001\u5728\u4e3b\u673a\u4e0a\u52a0\u8f7d\u5b58\u50a8\u5377\u4ee5\u53ca\u683c\u5f0f\u5316\u6587\u4ef6\u7cfb\u7edf\u7b49\u3002</li> <li><code>Rook Discovers</code>\uff1a\u68c0\u6d4b\u6302\u63a5\u5230\u5b58\u50a8\u8282\u70b9\u4e0a\u7684\u5b58\u50a8\u8bbe\u5907\u3002</li> </ul> <p><code>Rook</code> \u8fd8\u4f1a\u7528 Kubernetes Pod \u7684\u5f62\u5f0f\uff0c\u90e8\u7f72 Ceph \u7684 MON\u3001OSD \u4ee5\u53ca MGR \u5b88\u62a4\u8fdb\u7a0b\u3002<code>Rook Operator</code> \u8ba9\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 CRD \u6765\u521b\u5efa\u548c\u7ba1\u7406\u5b58\u50a8\u96c6\u7fa4\u3002\u6bcf\u79cd\u8d44\u6e90\u90fd\u5b9a\u4e49\u4e86\u81ea\u5df1\u7684 CRD\uff1a</p> <ul> <li><code>RookCluster</code>\uff1a\u63d0\u4f9b\u4e86\u5bf9\u5b58\u50a8\u673a\u7fa4\u7684\u914d\u7f6e\u80fd\u529b\uff0c\u7528\u6765\u63d0\u4f9b\u5757\u5b58\u50a8\u3001\u5bf9\u8c61\u5b58\u50a8\u4ee5\u53ca\u5171\u4eab\u6587\u4ef6\u7cfb\u7edf\u3002\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u591a\u4e2a <code>Pool</code>\u3002</li> <li><code>Pool</code>\uff1a\u4e3a\u5757\u5b58\u50a8\u63d0\u4f9b\u652f\u6301\uff0c<code>Pool</code> \u4e5f\u662f\u7ed9\u6587\u4ef6\u548c\u5bf9\u8c61\u5b58\u50a8\u63d0\u4f9b\u5185\u90e8\u652f\u6301\u3002</li> <li><code>Object Store</code>\uff1a\u7528 S3 \u517c\u5bb9\u63a5\u53e3\u5f00\u653e\u5b58\u50a8\u670d\u52a1\u3002</li> <li><code>File System</code>\uff1a\u4e3a\u591a\u4e2a Kubernetes Pod \u63d0\u4f9b\u5171\u4eab\u5b58\u50a8\u3002</li> </ul>"},{"location":"storage/ceph/installation/#_1","title":"\u90e8\u7f72","text":""},{"location":"storage/ceph/installation/#_2","title":"\u73af\u5883","text":"<p><code>Rook Ceph</code> \u9700\u8981\u4f7f\u7528 RBD \u5185\u6838\u6a21\u5757\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c <code>lsmod|grep rbd</code> \u6765\u6d4b\u8bd5 Kubernetes \u8282\u70b9\u662f\u5426\u6709\u8be5\u6a21\u5757\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u9700\u8981\u66f4\u65b0\u4e0b\u5185\u6838\u7248\u672c\u3002</p> <p>\u53e6\u5916\u9700\u8981\u5728\u8282\u70b9\u4e0a\u5b89\u88c5 <code>lvm2</code> \u8f6f\u4ef6\u5305\uff1a</p> <pre><code># Centos\nsudo yum install -y lvm2\n\n# Ubuntu\nsudo apt-get install -y lvm2\n</code></pre>"},{"location":"storage/ceph/installation/#_3","title":"\u5b89\u88c5","text":"<p>\u6211\u4eec\u8fd9\u91cc\u90e8\u7f72\u6700\u65b0\u7684 <code>release-1.5</code> \u7248\u672c\u7684 <code>Rook</code>\uff0c\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\u5730\u5740\uff1ahttps://github.com/rook/rook/tree/release-1.5/cluster/examples/kubernetes/ceph\u3002</p> <p>\u4ece\u4e0a\u9762\u94fe\u63a5\u4e2d\u4e0b\u8f7d <code>common.yaml</code> \u4e0e <code>operator.yaml</code> \u4e24\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code># \u4f1a\u5b89\u88c5rbac\u76f8\u5173\u8d44\u6e90\u5bf9\u8c61\n$ kubectl apply -f common.yaml\n# \u5b89\u88c5 CRD\n$ kubectl apply -f crds.yaml\n# \u5b89\u88c5 rook operator\n$ kubectl apply -f operator.yaml\n</code></pre> <p>\u5728\u7ee7\u7eed\u64cd\u4f5c\u4e4b\u524d\uff0c\u9a8c\u8bc1 <code>rook-ceph-operator</code> \u662f\u5426\u5904\u4e8e<code>Running</code>\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n rook-ceph                                   NAME                                  READY   STATUS    RESTARTS   AGE\nrook-ceph-operator-559b6fcf59-qrd2p   1/1     Running   5          58m\n</code></pre> <p>\u5f53 <code>Rook Operator</code> \u5904\u4e8e Running \u72b6\u6001\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa Ceph \u96c6\u7fa4\u4e86\u3002\u4e3a\u4e86\u4f7f\u96c6\u7fa4\u5728\u91cd\u542f\u540e\u4e0d\u53d7\u5f71\u54cd\uff0c\u8bf7\u786e\u4fdd\u8bbe\u7f6e\u7684 <code>dataDirHostPath</code> \u5c5e\u6027\u503c\u4e3a\u6709\u6548\u5f97\u4e3b\u673a\u8def\u5f84\u3002\u66f4\u591a\u76f8\u5173\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u76f8\u5173\u6587\u6863\u3002</p> <p>\u521b\u5efa\u5982\u4e0b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> cluster.yaml<pre><code>apiVersion: ceph.rook.io/v1\nkind: CephCluster\nmetadata:\nname: rook-ceph\nnamespace: rook-ceph\nspec:\ncephVersion:\n# \u6700\u65b0\u5f97 ceph \u955c\u50cf, \u53ef\u4ee5\u67e5\u770b https://hub.docker.com/r/ceph/ceph/tags\nimage: ceph/ceph:v15.2.8\ndataDirHostPath: /var/lib/rook  # \u7528\u4e8e\u5b58\u50a8rook\u7684\u76f8\u5173\u914d\u7f6e\u7684\u4e3b\u673a\u76ee\u5f55\nmon:  # monitor \u7684\u6570\u91cf\uff08\u4e00\u822c\u8bbe\u7f6e\u5927\u4e8e1\u7684\u5947\u6570\uff09\ncount: 3\ndashboard:  # \u5f00\u542fdashboard\nenabled: true\nstorage:  # \u6574\u4e2a\u96c6\u7fa4\u7684\u5b58\u50a8\u914d\u7f6e\uff08\u53ef\u4ee5\u5355\u72ec\u4e3a\u67d0\u4e2a\u8282\u70b9\u914d\u7f6e\u8fdb\u884c\u8986\u76d6\uff09\nuseAllNodes: true\nuseAllDevices: false\n# \u91cd\u8981: Directories \u5e94\u8be5\u53ea\u5728\u9884\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\ndirectories:\n- path: /data/rook\n</code></pre> <p>\u5176\u4e2d\u6709\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u5b57\u6bb5\uff1a</p> \u5b57\u6bb5 \u63cf\u8ff0 <code>dataDirHostPath</code> \u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\uff0c\u7528\u4e8e\u6bcf\u4e2a\u670d\u52a1\u5b58\u50a8\u914d\u7f6e\u548c\u6570\u636e\u3002\u5982\u679c\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u8be5\u76ee\u5f55\u3002\u7531\u4e8e\u6b64\u76ee\u5f55\u5728\u4e3b\u673a\u4e0a\u4fdd\u7559\uff0c\u56e0\u6b64\u5728\u5220\u9664 Pod \u540e\u5c06\u4fdd\u7559\u8be5\u76ee\u5f55\uff0c\u53e6\u5916\u4e0d\u5f97\u4f7f\u7528\u4ee5\u4e0b\u8def\u5f84\u53ca\u5176\u4efb\u4f55\u5b50\u8def\u5f84\uff1a<code>/etc/ceph</code>\u3001<code>/rook</code> \u6216 <code>/var/log/ceph</code>\u3002\u5982\u679c\u5220\u9664\u96c6\u7fa4\u5e76\u5728\u540c\u4e00\u4e3b\u673a\u4e0a\u542f\u52a8\u65b0\u96c6\u7fa4\uff0c\u5219 <code>dataDirHostPath</code> \u5fc5\u987b\u5220\u9664\u4f7f\u7528\u7684\u8def\u5f84\uff0c\u5426\u5219\uff0c\u8fc7\u65f6\u7684\u914d\u7f6e\u5c06\u4fdd\u7559\u5728\u5148\u524d\u7684\u96c6\u7fa4\u4e2d\uff0c\u5bfc\u81f4\u65b0\u7684 mons \u5c06\u65e0\u6cd5\u542f\u52a8\u3002 <code>useAllNodes</code> \u7528\u4e8e\u8868\u793a\u662f\u5426\u4f7f\u7528\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u8fdb\u884c\u5b58\u50a8\uff0c\u5982\u679c\u5728 nodes \u5b57\u6bb5\u4e0b\u6307\u5b9a\u4e86\u8282\u70b9\uff0c\u5219\u5fc5\u987b\u5c06 <code>useAllNodes</code> \u8bbe\u7f6e\u4e3a <code>false</code>\u3002 <code>useAllDevices</code> \u8868\u793a <code>OSD</code> \u662f\u5426\u81ea\u52a8\u4f7f\u7528\u8282\u70b9\u4e0a\u7684\u6240\u6709\u8bbe\u5907\uff0c\u4e00\u822c\u8bbe\u7f6e\u4e3a <code>false</code>\uff0c\u8fd9\u6837\u53ef\u63a7\u6027\u8f83\u9ad8 <code>directories</code> \u4e00\u822c\u6765\u8bf4\u5e94\u8be5\u4f7f\u7528\u4e00\u5757\u88f8\u76d8\u6765\u505a\u5b58\u50a8\uff0c\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u4f7f\u7528\u4e00\u4e2a\u76ee\u5f55\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u5f53\u7136\u751f\u6210\u73af\u5883\u4e0d\u63a8\u8350\u4f7f\u7528\u76ee\u5f55\u3002 <p>\u6211\u4eec\u5728 <code>node1</code>\u3001<code>node2</code>\u3001<code>node3</code> \u8fd93\u4e2a\u8282\u70b9\u4e0a\u90fd\u4e00\u4e2a\u5927\u5c0f\u4e3a <code>100G</code> \u7684 <code>/dev/vdb2</code> \u8bbe\u5907\uff0c\u6240\u4ee5\u6211\u4eec\u662f\u624b\u52a8\u6307\u5b9a <code>storage</code> \u7684\u914d\u7f6e\uff1a</p> <pre><code>[root@node1 ~]# fdisk -l\nDisk /dev/vda: 21.5 GB, 21474836480 bytes, 41943040 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x00053d5b\n\nDevice Boot      Start         End      Blocks   Id  System\n/dev/vda1   *        2048     1026047      512000   83  Linux\n/dev/vda2         1026048     5220351     2097152   82  Linux swap / Solaris\n/dev/vda3         5220352    41943039    18361344   83  Linux\n\nDisk /dev/vdb: 322.1 GB, 322122547200 bytes, 629145600 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0xf3f54157\n\nDevice Boot      Start         End      Blocks   Id  System\n/dev/vdb1            2048   419430399   209714176   83  Linux\n/dev/vdb2       419430400   629145599   104857600   83  Linux\n\nDisk /dev/sda: 10.7 GB, 10737418240 bytes, 20971520 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 4096 bytes\nI/O size (minimum/optimal): 4096 bytes / 4096 bytes\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u4e9b\u5b57\u6bb5\u5c5e\u6027\u4e4b\u5916\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u53ef\u4ee5\u7ec6\u7c92\u5ea6\u63a7\u5236\u5f97\u53c2\u6570\uff0c\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u76f8\u5173\u6587\u6863\u3002\u73b0\u5728\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 <code>CephCluster</code> \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f cluster.yaml cephcluster.ceph.rook.io/rook-ceph created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c<code>Rook Operator</code> \u5c31\u4f1a\u6839\u636e\u6211\u4eec\u7684\u63cf\u8ff0\u4fe1\u606f\u53bb\u81ea\u52a8\u521b\u5efa Ceph \u96c6\u7fa4\u4e86\u3002</p>"},{"location":"storage/ceph/installation/#_4","title":"\u9a8c\u8bc1","text":"<p>\u8981\u9a8c\u8bc1\u96c6\u7fa4\u662f\u5426\u5904\u4e8e\u6b63\u5e38\u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Rook \u5de5\u5177\u7bb1 \u6765\u8fd0\u884c <code>ceph status</code> \u547d\u4ee4\u67e5\u770b\u3002</p> <p>Rook \u5de5\u5177\u7bb1\u662f\u4e00\u4e2a\u7528\u4e8e\u8c03\u8bd5\u548c\u6d4b\u8bd5 Rook \u7684\u5e38\u7528\u5de5\u5177\u5bb9\u5668\uff0c\u8be5\u5de5\u5177\u57fa\u4e8e CentOS \u955c\u50cf\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 <code>yum</code> \u6765\u8f7b\u677e\u5b89\u88c5\u66f4\u591a\u7684\u5de5\u5177\u5305\u3002\u6211\u4eec\u8fd9\u91cc\u7528 Deployment \u63a7\u5236\u5668\u6765\u90e8\u7f72 Rook \u5de5\u5177\u7bb1\uff0c\u90e8\u7f72\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> toolbox.yaml<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: rook-ceph-tools\nnamespace: rook-ceph\nlabels:\napp: rook-ceph-tools\nspec:\nreplicas: 1\nselector:\nmatchLabels:\napp: rook-ceph-tools\ntemplate:\nmetadata:\nlabels:\napp: rook-ceph-tools\nspec:\ndnsPolicy: ClusterFirstWithHostNet\ncontainers:\n- name: rook-ceph-tools\nimage: rook/ceph:v1.2.1\ncommand: [\"/tini\"]\nargs: [\"-g\", \"--\", \"/usr/local/bin/toolbox.sh\"]\nimagePullPolicy: IfNotPresent\nenv:\n- name: ROOK_ADMIN_SECRET\nvalueFrom:\nsecretKeyRef:\nname: rook-ceph-mon\nkey: admin-secret\nsecurityContext:\nprivileged: true\nvolumeMounts:\n- mountPath: /dev\nname: dev\n- mountPath: /sys/bus\nname: sysbus\n- mountPath: /lib/modules\nname: libmodules\n- name: mon-endpoint-volume\nmountPath: /etc/rook\n# \u5982\u679c\u8bbe\u7f6e hostNetwork: false,  \"rbd map\" \u547d\u4ee4\u4f1a\u88ab hang \u4f4f, \u53c2\u8003 https://github.com/rook/rook/issues/2021\nhostNetwork: true\nvolumes:\n- name: dev\nhostPath:\npath: /dev\n- name: sysbus\nhostPath:\npath: /sys/bus\n- name: libmodules\nhostPath:\npath: /lib/modules\n- name: mon-endpoint-volume\nconfigMap:\nname: rook-ceph-mon-endpoints\nitems:\n- key: data\npath: mon-endpoints\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f toolbox.yaml\ndeployment.apps/rook-ceph-tools created\n</code></pre> <p>\u4e00\u65e6 toolbox \u7684 Pod \u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u5165\u5230\u5de5\u5177\u7bb1\u5185\u90e8\u8fdb\u884c\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl -n rook-ceph exec -it $(kubectl -n rook-ceph get pod -l \"app=rook-ceph-tools\" -o jsonpath='{.items[0].metadata.name}') bash\n</code></pre> <p>\u5de5\u5177\u7bb1\u4e2d\u7684\u6240\u6709\u53ef\u7528\u5de5\u5177\u547d\u4ee4\u5747\u5df2\u51c6\u5907\u5c31\u7eea\uff0c\u53ef\u6ee1\u8db3\u60a8\u7684\u6545\u969c\u6392\u9664\u9700\u6c42\u3002\u4f8b\u5982\uff1a</p> <pre><code>ceph status\nceph osd status\nceph df\nrados df\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u9700\u8981\u6ee1\u8db3\u4e0b\u9762\u7684\u6761\u4ef6\u624d\u8ba4\u4e3a\u662f\u5065\u5eb7\u7684\uff1a</p> <ul> <li>\u6240\u6709 mons \u5e94\u8be5\u8fbe\u5230\u6cd5\u5b9a\u6570\u91cf</li> <li>mgr \u5e94\u8be5\u662f\u6fc0\u6d3b\u72b6\u6001</li> <li>\u81f3\u5c11\u6709\u4e00\u4e2a OSD \u5904\u4e8e\u6fc0\u6d3b\u72b6\u6001</li> <li>\u5982\u679c\u4e0d\u662f HEALTH_OK \u72b6\u6001\uff0c\u5219\u5e94\u8be5\u67e5\u770b\u544a\u8b66\u6216\u8005\u9519\u8bef\u4fe1\u606f</li> </ul> <pre><code>$ ceph status\nceph status\n  cluster:\n    id:     dae083e6-8487-447b-b6ae-9eb321818439\n    health: HEALTH_OK\n\nservices:\n    mon: 3 daemons, quorum a,b,c (age 15m)\nmgr: a(active, since 2m)\nosd: 31 osds: 2 up (since 6m), 2 in (since 6m)\ndata:\n    pools:   0 pools, 0 pgs\n    objects: 0 objects, 0 B\n    usage:   79 GiB used, 314 GiB / 393 GiB avail\n    pgs:\n</code></pre> <p>\u5982\u679c\u7fa4\u96c6\u8fd0\u884c\u4e0d\u6b63\u5e38\uff0c\u53ef\u4ee5\u67e5\u770b Ceph \u5e38\u89c1\u95ee\u9898 \u4ee5\u4e86\u89e3\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u548c\u53ef\u80fd\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"storage/ceph/installation/#_5","title":"\u9762\u677f","text":"<p>Ceph \u6709\u4e00\u4e2a Dashboard \u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u5305\u62ec\u603b\u4f53\u8fd0\u884c\u72b6\u6001\uff0c<code>mgr</code>\u3001<code>osd</code> \u548c\u5176\u4ed6 Ceph \u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u67e5\u770b\u6c60\u548c PG \u72b6\u6001\uff0c\u4ee5\u53ca\u663e\u793a\u5b88\u62a4\u8fdb\u7a0b\u7684\u65e5\u5fd7\u7b49\u7b49\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u7684 cluster CRD \u5bf9\u8c61\u4e2d\u5f00\u542f dashboard\uff0c\u8bbe\u7f6e<code>dashboard.enable=true</code>\u5373\u53ef\uff0c\u8fd9\u6837 <code>Rook Operator</code> \u5c31\u4f1a\u542f\u7528 <code>ceph-mgr dashboard</code> \u6a21\u5757\uff0c\u5e76\u5c06\u521b\u5efa\u4e00\u4e2a Kubernetes Service \u6765\u66b4\u9732\u8be5\u670d\u52a1\uff0c\u5c06\u542f\u7528\u7aef\u53e3 7000 \u8fdb\u884c https \u8bbf\u95ee\uff0c\u5982\u679c Ceph \u96c6\u7fa4\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b Dashboard \u7684 Service\uff1a</p> <pre><code>$ kubectl get svc -n rook-ceph\nNAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nrook-ceph-mgr              ClusterIP   10.99.87.1       &lt;none&gt;        9283/TCP            3m6s\nrook-ceph-mgr-dashboard    ClusterIP   10.111.195.180   &lt;none&gt;        7000/TCP            3m29s\n</code></pre> <p>\u8fd9\u91cc\u7684 <code>rook-ceph-mgr</code> \u670d\u52a1\u7528\u4e8e\u62a5\u544a Prometheus metrics \u6307\u6807\u6570\u636e\u7684\uff0c\u800c\u540e\u9762\u7684\u7684 rook-ceph-mgr-dashboard \u670d\u52a1\u5c31\u662f\u6211\u4eec\u7684 Dashboard \u670d\u52a1\uff0c\u5982\u679c\u5728\u96c6\u7fa4\u5185\u90e8\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 DNS \u540d\u79f0 <code>http://rook-ceph-mgr-dashboard.rook-ceph:7000</code> \u6216\u8005 CluterIP <code>http://10.111.195.180:7000</code> \u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u4f46\u662f\u5982\u679c\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8fdb\u884c\u8bbf\u95ee\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u901a\u8fc7 Ingress \u6216\u8005 NodePort \u7c7b\u578b\u7684 Service \u6765\u66b4\u9732\u4e86\uff0c\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u6765\u8bbf\u95ee Dashboard\uff0c\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> dashboard-external.yaml<pre><code>apiVersion: v1\nkind: Service\nmetadata:\nname: rook-ceph-mgr-dashboard-external\nnamespace: rook-ceph\nlabels:\napp: rook-ceph-mgr\nrook_cluster: rook-ceph\nspec:\nports:\n- name: dashboard\nport: 7000\nprotocol: TCP\ntargetPort: 7000\nselector:\napp: rook-ceph-mgr\nrook_cluster: rook-ceph\ntype: NodePort\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f dashboard-external.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u65b0\u521b\u5efa\u7684 <code>rook-ceph-mgr-dashboard-external</code> \u8fd9\u4e2a Service \u670d\u52a1\uff1a</p> <pre><code>$ kubectl get svc -n rook-ceph NAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nrook-ceph-mgr                           ClusterIP   10.96.49.29     &lt;none&gt;        9283/TCP            23m\nrook-ceph-mgr-dashboard                 ClusterIP   10.109.8.98     &lt;none&gt;        7000/TCP            23m\nrook-ceph-mgr-dashboard-external   NodePort    10.109.53.223    &lt;none&gt;        7000:31361/TCP      14s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u901a\u8fc7 <code>http://&lt;NodeIp&gt;:31361</code> \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Dashboard \u4e86\u3002</p> <p></p> <p>\u4f46\u662f\u5728\u8bbf\u95ee\u7684\u65f6\u5019\u9700\u8981\u6211\u4eec\u767b\u5f55\u624d\u80fd\u591f\u8bbf\u95ee\uff0c<code>Rook</code> \u521b\u5efa\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u7684\u7528\u6237 <code>admin</code>\uff0c\u5e76\u5728\u8fd0\u884c <code>Rook</code> \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u751f\u6210\u4e86\u4e00\u4e2a\u540d\u4e3a <code>rook-ceph-dashboard-admin-password</code> \u7684 Secret\uff0c\u8981\u83b7\u53d6\u5bc6\u7801\uff0c\u53ef\u4ee5\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\"{['data']['password']}\" | base64 --decode &amp;&amp; echo\nxxxx\uff08\u767b\u5f55\u5bc6\u7801\uff09\n</code></pre> <p>\u7528\u4e0a\u9762\u83b7\u5f97\u7684\u5bc6\u7801\u548c\u7528\u6237\u540d <code>admin</code> \u5c31\u53ef\u4ee5\u767b\u5f55 Dashboard \u4e86\uff0c\u5728 Dashboard \u4e0a\u9762\u53ef\u4ee5\u67e5\u770b\u5230\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\uff1a</p> <p></p>"},{"location":"storage/ceph/installation/#_6","title":"\u4f7f\u7528","text":"<p>\u73b0\u5728\u6211\u4eec\u7684 Ceph \u96c6\u7fa4\u642d\u5efa\u6210\u529f\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u4f7f\u7528\u5b58\u50a8\u4e86\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u521b\u5efa\u5b58\u50a8\u6c60\uff0c\u53ef\u4ee5\u7528 CRD \u6765\u5b9a\u4e49 Pool\u3002Rook \u63d0\u4f9b\u4e86\u4e24\u79cd\u673a\u5236\u6765\u7ef4\u6301 OSD\uff1a</p> <ul> <li>\u526f\u672c\uff1a\u7f3a\u7701\u9009\u9879\uff0c\u6bcf\u4e2a\u5bf9\u8c61\u90fd\u4f1a\u6839\u636e <code>spec.replicated.size</code> \u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\u8fdb\u884c\u590d\u5236\u3002\u5efa\u8bae\u975e\u751f\u4ea7\u73af\u5883\u81f3\u5c11 2 \u4e2a\u526f\u672c\uff0c\u751f\u4ea7\u73af\u5883\u81f3\u5c11 3 \u4e2a\u3002</li> <li>Erasure Code\uff1a\u662f\u4e00\u79cd\u8f83\u4e3a\u8282\u7ea6\u7684\u65b9\u5f0f\u3002EC \u628a\u6570\u636e\u62c6\u5206 n \u6bb5\uff08<code>spec.erasureCoded.dataChunks</code>\uff09\uff0c\u518d\u52a0\u5165 k \u4e2a\u4ee3\u7801\u6bb5\uff08<code>spec.erasureCoded.codingChunks</code>\uff09\uff0c\u7528\u5206\u5e03\u7684\u65b9\u5f0f\u628a <code>n+k</code> \u6bb5\u6570\u636e\u4fdd\u5b58\u5728\u78c1\u76d8\u4e0a\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b Ceph \u80fd\u591f\u9694\u79bb k \u4e2a <code>OSD</code> \u7684\u635f\u5931\u3002</li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u526f\u672c\u7684\u65b9\u5f0f\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 RBD \u7c7b\u578b\u7684\u5b58\u50a8\u6c60\uff1a</p> pool.yaml<pre><code>apiVersion: ceph.rook.io/v1\nkind: CephBlockPool\nmetadata:\nname: k8s-test-pool   # operator\u4f1a\u76d1\u542c\u5e76\u521b\u5efa\u4e00\u4e2apool\uff0c\u6267\u884c\u5b8c\u540e\u754c\u9762\u4e0a\u4e5f\u80fd\u770b\u5230\u5bf9\u5e94\u7684pool\nnamespace: rook-ceph\nspec:\nfailureDomain: host  # \u6570\u636e\u5757\u7684\u6545\u969c\u57df: \u503c\u4e3ahost\u65f6\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u5c06\u653e\u7f6e\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a;\u503c\u4e3aosd\u65f6\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u5c06\u653e\u7f6e\u5728\u4e0d\u540c\u7684osd\u4e0a\nreplicated:\nsize: 3   # \u6c60\u4e2d\u6570\u636e\u7684\u526f\u672c\u6570,1\u5c31\u662f\u4e0d\u4fdd\u5b58\u4efb\u4f55\u526f\u672c\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pool.yaml cephblockpool.ceph.rook.io/k8s-test-pool created\n</code></pre> <p>\u5b58\u50a8\u6c60\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u5728 Dashboard \u4e0a\u9762\u7684\u786e\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86\u4e00\u4e2a pool\uff0c\u4f46\u662f\u4f1a\u53d1\u73b0\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\u53d8\u6210\u4e86 <code>WARN</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u6709\u5982\u4e0b\u65e5\u5fd7\u51fa\u73b0\uff1a</p> <pre><code>Health check update: too few PGs per OSD (6 &lt; min 30) (TOO_FEW_PGS)\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u6bcf\u4e2a <code>osd</code> \u4e0a\u7684 <code>pg</code> \u6570\u91cf\u5c0f\u4e8e\u6700\u5c0f\u7684\u6570\u76ee30\u4e2a\u3002<code>pgs</code> \u4e3a8\uff0c\u56e0\u4e3a\u662f3\u526f\u672c\u7684\u914d\u7f6e\uff0c\u6240\u4ee5\u5f53\u67094\u4e2a <code>osd</code> \u7684\u65f6\u5019\uff0c\u6bcf\u4e2a <code>osd</code> \u4e0a\u5747\u5206\u4e868/4 *3=6\u4e2apgs\uff0c\u4e5f\u5c31\u662f\u51fa\u73b0\u4e86\u5982\u4e0a\u7684\u9519\u8bef\u5c0f\u4e8e\u6700\u5c0f\u914d\u7f6e30\u4e2a\uff0c\u96c6\u7fa4\u8fd9\u79cd\u72b6\u6001\u5982\u679c\u8fdb\u884c\u6570\u636e\u7684\u5b58\u50a8\u548c\u64cd\u4f5c\uff0c\u96c6\u7fa4\u4f1a\u5361\u6b7b\uff0c\u65e0\u6cd5\u54cd\u5e94io\uff0c\u540c\u65f6\u4f1a\u5bfc\u81f4\u5927\u9762\u79ef\u7684 <code>osd down</code>\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165 <code>toolbox</code> \u7684\u5bb9\u5668\u4e2d\u67e5\u770b\u4e0a\u9762\u5b58\u50a8\u7684 <code>pg</code> \u6570\u91cf\uff1a</p> <pre><code>$ ceph osd pool get k8s-test-pool pg_num\npg_num: 8\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 <code>pg_num</code> \u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <pre><code>$ ceph osd pool set k8s-test-pool pg_num 64\nset pool 1 pg_num to 64\n$ ceph -s\n  cluster:\n    id:     7851387c-5d18-489a-8c04-b699fb9764c0\n    health: HEALTH_OK\n\nservices:\n    mon: 3 daemons, quorum a,b,c (age 33m)\nmgr: a(active, since 32m)\nosd: 4 osds: 4 up (since 32m), 4 in (since 32m)\ndata:\n    pools:   1 pools, 64 pgs\n    objects: 0 objects, 0 B\n    usage:   182 GiB used, 605 GiB / 787 GiB avail\n    pgs:     64 active+clean\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u67e5\u770b\u5c31\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5c31\u662f\u5065\u5eb7\u72b6\u6001\u4e86\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u7684 pool \u4e0a\u6ca1\u6709\u6570\u636e\uff0c\u6240\u4ee5\u4fee\u6539 <code>pg</code> \u5f71\u54cd\u5e76\u4e0d\u5927\uff0c\u4f46\u662f\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\u91cd\u65b0\u4fee\u6539 <code>pg</code> \u6570\uff0c\u4f1a\u5bf9\u751f\u4ea7\u73af\u5883\u4ea7\u751f\u8f83\u5927\u5f71\u54cd\u3002\u56e0\u4e3a <code>pg</code> \u6570\u53d8\u4e86\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u6570\u636e\u91cd\u65b0\u5747\u8861\u548c\u8fc1\u79fb\uff0c\u6570\u636e\u8d8a\u5927\u54cd\u5e94 io \u7684\u65f6\u95f4\u4f1a\u8d8a\u957f\u3002\u6240\u4ee5\uff0c\u6700\u597d\u5728\u4e00\u5f00\u59cb\u5c31\u8bbe\u7f6e\u597d <code>pg</code> \u6570\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a <code>StorageClass</code> \u6765\u8fdb\u884c\u52a8\u6001\u5b58\u50a8\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a Ceph \u7684\u5757\u5b58\u50a8\u7684 <code>StorageClass</code>\uff1a</p> storageclass.yaml<pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: rook-ceph-block\nprovisioner: rook-ceph.rbd.csi.ceph.com\nparameters:\n# clusterID \u662f rook \u96c6\u7fa4\u8fd0\u884c\u7684\u547d\u540d\u7a7a\u95f4\nclusterID: rook-ceph\n# \u6307\u5b9a\u5b58\u50a8\u6c60\npool: k8s-test-pool\n# RBD image (\u5b9e\u9645\u7684\u5b58\u50a8\u4ecb\u8d28) \u683c\u5f0f. \u9ed8\u8ba4\u4e3a \"2\".\nimageFormat: \"2\"\n# RBD image \u7279\u6027. CSI RBD \u73b0\u5728\u53ea\u652f\u6301 `layering` .\nimageFeatures: layering\n# Ceph \u7ba1\u7406\u5458\u8ba4\u8bc1\u4fe1\u606f\uff0c\u8fd9\u4e9b\u90fd\u662f\u5728 clusterID \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u81ea\u52a8\u751f\u6210\u7684\ncsi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner\ncsi.storage.k8s.io/provisioner-secret-namespace: rook-ceph\ncsi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node\ncsi.storage.k8s.io/node-stage-secret-namespace: rook-ceph\n# \u6307\u5b9a volume \u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\uff0c\u5982\u679c\u4e0d\u6307\u5b9a, csi-provisioner \u4f1a\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a `ext4`\ncsi.storage.k8s.io/fstype: ext4\n# uncomment the following to use rbd-nbd as mounter on supported nodes\n# **IMPORTANT**: If you are using rbd-nbd as the mounter, during upgrade you will be hit a ceph-csi\n# issue that causes the mount to be disconnected. You will need to follow special upgrade steps\n# to restart your application pods. Therefore, this option is not recommended.\n#mounter: rbd-nbd\nreclaimPolicy: Delete\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 StorageClass \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f storageclass.yaml storageclass.storage.k8s.io/rook-ceph-block created\n$ kubectl get storageclass\nNAME              PROVISIONER                    AGE\nrook-ceph-block   rook-ceph.rbd.csi.ceph.com     35s\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a PVC \u6765\u4f7f\u7528\u4e0a\u9762\u7684 StorageClass \u5bf9\u8c61\uff1a</p> pvc.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: mysql-pv-claim\nlabels:\napp: wordpress\nspec:\nstorageClassName: rook-ceph-block\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 20Gi\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 PVC \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pvc.yaml persistentvolumeclaim/mysql-pv-claim created\n$ kubectl get pvc -l app=wordpress\nNAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pv-claim   Bound    pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3   20Gi       RWO            rook-ceph-block   32m\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684 PVC \u5bf9\u8c61\u5df2\u7ecf\u662f Bound \u72b6\u6001\u4e86\uff0c\u81ea\u52a8\u521b\u5efa\u4e86\u5bf9\u5e94\u7684 PV\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a PVC \u5bf9\u8c61\u6765\u505a\u6570\u636e\u6301\u4e45\u5316\u64cd\u4f5c\u4e86\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u53ef\u80fd\u96c6\u7fa4\u8fd8\u4f1a\u51fa\u73b0\u5982\u4e0b\u7684\u5065\u5eb7\u63d0\u793a\uff1a</p> <pre><code>$ ceph health detail\nHEALTH_WARN application not enabled on 1 pool(s)\nPOOL_APP_NOT_ENABLED application not enabled on 1 pool(s)\napplication not enabled on pool 'k8s-test-pool'\nuse 'ceph osd pool application enable &lt;pool-name&gt; &lt;app-name&gt;', where &lt;app-name&gt; is 'cephfs', 'rbd', 'rgw', or freeform for custom applications.\n$ ceph osd pool application enable k8s-test-pool k8srbd\nenabled application 'k8srbd' on pool 'k8s-test-pool'\n</code></pre> <p>\u6839\u636e\u63d0\u793a\u542f\u7528\u4e00\u4e2a application \u5373\u53ef\u3002</p> <p>\u5728\u5b98\u65b9\u4ed3\u5e93 cluster/examples/kubernetes \u76ee\u5f55\u4e0b\uff0c\u5b98\u65b9\u7ed9\u4e86\u4e2a wordpress \u7684\u4f8b\u5b50\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fd0\u884c\u6d4b\u8bd5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mysql.yaml\n$ kubectl apply -f wordpress.yaml  </code></pre> <p>\u5b98\u65b9\u7684\u8fd9\u4e2a\u793a\u4f8b\u91cc\u9762\u7684 wordpress \u7528\u7684 Loadbalancer \u7c7b\u578b\uff0c\u6211\u4eec\u53ef\u4ee5\u6539\u6210 NodePort\uff1a</p> <pre><code>$ kubectl get pvc -l app=wordpress\nNAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pv-claim   Bound    pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3   20Gi       RWO            rook-ceph-block   12h\nwp-pv-claim      Bound    pvc-237932ed-5ca7-468c-bd16-220ebb2a1ce3   20Gi       RWO            rook-ceph-block   25s\n$ kubectl get pods -l app=wordpress               NAME                              READY   STATUS    RESTARTS   AGE\nwordpress-5b886cf59b-4xwn8        1/1     Running   0          24m\nwordpress-mysql-b9ddd6d4c-qhjd4   1/1     Running   0          24m\n$ kubectl get svc -l app=wordpress\nNAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nwordpress         NodePort    10.106.253.225   &lt;none&gt;        80:30307/TCP   80s\nwordpress-mysql   ClusterIP   None             &lt;none&gt;        3306/TCP       87s\n</code></pre> <p>\u5f53\u5e94\u7528\u90fd\u5904\u4e8e Running \u72b6\u6001\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:30307</code> \u53bb\u8bbf\u95ee wordpress \u5e94\u7528</p> <p>\u6bd4\u5982\u6211\u4eec\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\u66f4\u6539\u4e0b\u5185\u5bb9\uff0c\u7136\u540e\u6211\u4eec\u5c06\u5e94\u7528 Pod \u5168\u90e8\u5220\u9664\u91cd\u5efa\uff1a</p> <pre><code>$ kubectl delete pod wordpress-mysql-b9ddd6d4c-qhjd4 wordpress-5b886cf59b-4xwn8\npod \"wordpress-mysql-b9ddd6d4c-qhjd4\" deleted\npod \"wordpress-5b886cf59b-4xwn8\" deleted\n$ kubectl get pods -l app=wordpress                                            NAME                              READY   STATUS    RESTARTS   AGE\nwordpress-5b886cf59b-kwxk4        1/1     Running   0          2m52s\nwordpress-mysql-b9ddd6d4c-kkcr7   1/1     Running   0          2m52s\n</code></pre> <p>\u5f53 Pod \u91cd\u5efa\u5b8c\u6210\u540e\u518d\u6b21\u8bbf\u95ee wordpress \u5e94\u7528\u7684\u4e3b\u9875\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e4b\u524d\u6211\u4eec\u6dfb\u52a0\u7684\u6570\u636e\u4ecd\u7136\u5b58\u5728\uff0c\u8fd9\u5c31\u8bc1\u660e\u6211\u4eec\u7684\u6570\u636e\u6301\u4e45\u5316\u662f\u6b63\u786e\u7684\u3002</p>"},{"location":"storage/local/hostPath/","title":"HostPath","text":"<p>\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u4e86 PV \u662f\u5bf9\u5e95\u5c42\u5b58\u50a8\u6280\u672f\u7684\u4e00\u79cd\u62bd\u8c61\uff0cPV \u4e00\u822c\u90fd\u662f\u7531\u7ba1\u7406\u5458\u6765\u521b\u5efa\u548c\u914d\u7f6e\u7684\uff0c\u6211\u4eec\u9996\u5148\u6765\u521b\u5efa\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 PersistentVolume\u3002Kubernetes \u652f\u6301 hostPath \u7c7b\u578b\u7684 PersistentVolume \u4f7f\u7528\u8282\u70b9\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u6765\u6a21\u62df\u9644\u5e26\u7f51\u7edc\u7684\u5b58\u50a8\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u751f\u4ea7\u96c6\u7fa4\u4e2d\uff0c\u6211\u4eec\u4e0d\u4f1a\u4f7f\u7528 hostPath\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u4f1a\u63d0\u4f9b\u7f51\u7edc\u5b58\u50a8\u8d44\u6e90\uff0c\u6bd4\u5982 NFS \u5171\u4eab\u5377\u6216 Ceph \u5b58\u50a8\u5377\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u8fd8\u53ef\u4ee5\u4f7f\u7528 StorageClasses \u6765\u8bbe\u7f6e\u52a8\u6001\u63d0\u4f9b\u5b58\u50a8\u3002\u56e0\u4e3a Pod \u5e76\u4e0d\u662f\u59cb\u7ec8\u56fa\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8981\u4f7f\u7528 hostPath \u7684\u8bdd\u6211\u4eec\u5c31\u9700\u8981\u5c06 Pod \u56fa\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u663e\u7136\u5c31\u5927\u5927\u964d\u4f4e\u4e86\u5e94\u7528\u7684\u5bb9\u9519\u6027\u3002</p>"},{"location":"storage/local/hostPath/#_1","title":"\u914d\u7f6e\u5c5e\u6027","text":""},{"location":"storage/local/hostPath/#_2","title":"\u5b58\u50a8\u80fd\u529b\u548c\u8bbf\u95ee\u6a21\u5f0f","text":"<p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c06\u6d4b\u8bd5\u7684\u5e94\u7528\u56fa\u5b9a\u5728\u8282\u70b9 <code>node1</code> \u4e0a\u9762\uff0c\u9996\u5148\u5728\u8be5\u8282\u70b9\u4e0a\u9762\u521b\u5efa\u4e00\u4e2a <code>/data/k8s/test/hostpath</code> \u7684\u76ee\u5f55\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a <code>index.html</code> \u7684\u6587\u4ef6\uff1a</p> <pre><code>$ echo 'Hello from Kubernetes hostpath storage' &gt; /data/k8s/test/hostpath/index.html\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff1a</p> pv-hostpath.yaml<pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: pv-hostpath\nlabels:\ntype: local\nspec:\nstorageClassName: manual\ncapacity:\nstorage: 10Gi\naccessModes:\n- ReadWriteOnce\nhostPath:\npath: \"/data/k8s/test/hostpath\"\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u4e86\u8be5\u5377\u4f4d\u4e8e\u96c6\u7fa4\u8282\u70b9\u4e0a\u7684 <code>/data/k8s/test/hostpath</code> \u76ee\u5f55\uff0c\u8fd8\u6307\u5b9a\u4e86 10G \u5927\u5c0f\u7684\u7a7a\u95f4\u548c <code>ReadWriteOnce</code> \u7684\u8bbf\u95ee\u6a21\u5f0f\uff0c\u8fd9\u610f\u5473\u7740\u8be5\u5377\u53ef\u4ee5\u5728\u5355\u4e2a\u8282\u70b9\u4e0a\u4ee5\u8bfb\u5199\u65b9\u5f0f\u6302\u8f7d\uff0c\u53e6\u5916\u8fd8\u5b9a\u4e49\u4e86\u540d\u79f0\u4e3a manual \u7684 StorageClass\uff0c\u8be5\u540d\u79f0\u7528\u6765\u5c06 PersistentVolumeClaim \u8bf7\u6c42\u7ed1\u5b9a\u5230\u8be5 PersistentVolume\u3002\u4e0b\u9762\u662f\u5173\u4e8e PV \u7684\u8fd9\u4e9b\u914d\u7f6e\u5c5e\u6027\u7684\u4e00\u4e9b\u8bf4\u660e\uff1a</p> <ul> <li><code>Capacity</code>\uff08\u5b58\u50a8\u80fd\u529b\uff09\uff1a\u4e00\u822c\u6765\u8bf4\uff0c\u4e00\u4e2a PV \u5bf9\u8c61\u90fd\u8981\u6307\u5b9a\u4e00\u4e2a\u5b58\u50a8\u80fd\u529b\uff0c\u901a\u8fc7 PV \u7684 capacity \u5c5e\u6027\u6765\u8bbe\u7f6e\u7684\uff0c\u76ee\u524d\u53ea\u652f\u6301\u5b58\u50a8\u7a7a\u95f4\u7684\u8bbe\u7f6e\uff0c\u5c31\u662f\u6211\u4eec\u8fd9\u91cc\u7684 <code>storage=10Gi</code>\uff0c\u4e0d\u8fc7\u672a\u6765\u53ef\u80fd\u4f1a\u52a0\u5165 IOPS\u3001\u541e\u5410\u91cf\u7b49\u6307\u6807\u7684\u914d\u7f6e\u3002</li> <li> <p><code>AccessModes</code>\uff08\u8bbf\u95ee\u6a21\u5f0f\uff09\uff1a\u7528\u6765\u5bf9 PV \u8fdb\u884c\u8bbf\u95ee\u6a21\u5f0f\u7684\u8bbe\u7f6e\uff0c\u7528\u4e8e\u63cf\u8ff0\u7528\u6237\u5e94\u7528\u5bf9\u5b58\u50a8\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u8bbf\u95ee\u6743\u9650\u5305\u62ec\u4e0b\u9762\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li><code>ReadWriteOnce\uff08RWO\uff09</code>\uff1a\u8bfb\u5199\u6743\u9650\uff0c\u4f46\u662f\u53ea\u80fd\u88ab\u5355\u4e2a\u8282\u70b9\u6302\u8f7d</li> <li><code>ReadOnlyMany\uff08ROX\uff09</code>\uff1a\u53ea\u8bfb\u6743\u9650\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u6302\u8f7d</li> <li><code>ReadWriteMany\uff08RWX\uff09</code>\uff1a\u8bfb\u5199\u6743\u9650\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u6302\u8f7d</li> </ul> <p>\u6ce8\u610f</p> <p>\u4e00\u4e9b PV \u53ef\u80fd\u652f\u6301\u591a\u79cd\u8bbf\u95ee\u6a21\u5f0f\uff0c\u4f46\u662f\u5728\u6302\u8f7d\u7684\u65f6\u5019\u53ea\u80fd\u4f7f\u7528\u4e00\u79cd\u8bbf\u95ee\u6a21\u5f0f\uff0c\u591a\u79cd\u8bbf\u95ee\u6a21\u5f0f\u662f\u4e0d\u4f1a\u751f\u6548\u7684\u3002</p> <p>\u4e0b\u56fe\u662f\u4e00\u4e9b\u5e38\u7528\u7684 Volume \u63d2\u4ef6\u652f\u6301\u7684\u8bbf\u95ee\u6a21\u5f0f\uff1a</p> \u8bbf\u95ee\u6a21\u5f0f Volume Plugin ReadWriteOnce ReadOnlyMany ReadWriteMany <code>AWSElasticBlockStore</code> \u2003-\u2003 \u2003-\u2003 <code>AzureFile</code> <code>AzureDisk</code> \u2003-\u2003 \u2003-\u2003 <code>CephFS</code> <code>Cinder</code> \u2003-\u2003 \u2003-\u2003 <code>FC</code> \u2003-\u2003 <code>FlexVolume</code> \u2003-\u2003 <code>Flocker</code> \u2003-\u2003 \u2003-\u2003 <code>GCEPersistentDisk</code> \u2003-\u2003 <code>Glusterfs</code> <code>HostPath</code> \u2003-\u2003 \u2003-\u2003 <code>ISCSI</code> \u2003-\u2003 <code>Quobyte</code> <code>NFS</code> <code>RBD</code> \u2003-\u2003 <code>VsphereVolume</code> \u2003-\u2003 \u2003-\u2003 <code>PortworxVolume</code> \u2003-\u2003 <code>ScaleIO</code> \u2003-\u2003 <code>StorageOS</code> \u2003-\u2003 \u2003-\u2003 </li> </ul> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pv-hostpath.yaml\npersistentvolume/pv-hostpath created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u67e5\u770b PersistentVolume \u7684\u4fe1\u606f\uff0c\u8f93\u51fa\u7ed3\u679c\u663e\u793a\u8be5 PersistentVolume \u7684\u72b6\u6001\uff08STATUS\uff09 \u4e3a <code>Available</code>\u3002 \u8fd9\u610f\u5473\u7740\u5b83\u8fd8\u6ca1\u6709\u88ab\u7ed1\u5b9a\u7ed9 PersistentVolumeClaim\uff1a</p>"},{"location":"storage/local/hostPath/#_3","title":"\u56de\u6536\u7b56\u7565","text":"<pre><code>$ kubectl get pv pv-hostpath\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE\npv-hostpath   10Gi       RWO            Retain           Available           manual                  58s\n</code></pre> <p>\u5176\u4e2d\u6709\u4e00\u9879 <code>RECLAIM POLICY</code> \u7684\u914d\u7f6e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 PV \u7684 <code>persistentVolumeReclaimPolicy</code>\uff08\u56de\u6536\u7b56\u7565\uff09\u5c5e\u6027\u6765\u8fdb\u884c\u914d\u7f6e\uff0c\u76ee\u524d PV \u652f\u6301\u7684\u7b56\u7565\u6709\u4e09\u79cd\uff1a</p> <ul> <li><code>Retain</code>\uff08\u4fdd\u7559\uff09\uff1a\u4fdd\u7559\u6570\u636e\uff0c\u9700\u8981\u7ba1\u7406\u5458\u624b\u5de5\u6e05\u7406\u6570\u636e</li> <li><code>Recycle</code>\uff08\u56de\u6536\uff09\uff1a\u6e05\u9664 PV \u4e2d\u7684\u6570\u636e\uff0c\u6548\u679c\u76f8\u5f53\u4e8e\u6267\u884c <code>rm -rf /thevolume/*</code></li> <li><code>Delete</code>\uff08\u5220\u9664\uff09\uff1a\u4e0e PV \u76f8\u8fde\u7684\u540e\u7aef\u5b58\u50a8\u5b8c\u6210 volume \u7684\u5220\u9664\u64cd\u4f5c\uff0c\u5f53\u7136\u8fd9\u5e38\u89c1\u4e8e\u4e91\u670d\u52a1\u5546\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u6bd4\u5982 ASW EBS\u3002</li> </ul> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u76ee\u524d\u53ea\u6709 <code>NFS</code> \u548c <code>HostPath</code> \u4e24\u79cd\u7c7b\u578b\u652f\u6301\u56de\u6536\u7b56\u7565\uff0c\u5f53\u7136\u4e00\u822c\u6765\u8bf4\u8fd8\u662f\u8bbe\u7f6e\u4e3a <code>Retain</code> \u8fd9\u79cd\u7b56\u7565\u4fdd\u9669\u4e00\u70b9\u3002</p> <p>\u6ce8\u610f</p> <p><code>Recycle</code> \u7b56\u7565\u4f1a\u901a\u8fc7\u8fd0\u884c\u4e00\u4e2a busybox \u5bb9\u5668\u6765\u6267\u884c\u6570\u636e\u5220\u9664\u547d\u4ee4\uff0c\u9ed8\u8ba4\u5b9a\u4e49\u7684 busybox \u955c\u50cf\u662f\uff1a<code>gcr.io/google_containers/busybox:latest</code>\uff0c\u5e76\u4e14 <code>imagePullPolicy: Always</code>\uff0c\u5982\u679c\u9700\u8981\u8c03\u6574\u914d\u7f6e\uff0c\u9700\u8981\u589e\u52a0kube-controller-manager \u542f\u52a8\u53c2\u6570\uff1a<code>--pv-recycler-pod-template-filepath-hostpath</code> \u6765\u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"storage/local/hostPath/#pv","title":"PV\u7684\u72b6\u6001","text":"<p>\u5173\u4e8e PV \u7684\u72b6\u6001\uff0c\u5b9e\u9645\u4e0a\u63cf\u8ff0\u7684\u662f PV \u7684\u751f\u547d\u5468\u671f\u7684\u67d0\u4e2a\u9636\u6bb5\uff0c\u4e00\u4e2a PV \u7684\u751f\u547d\u5468\u671f\u4e2d\uff0c\u53ef\u80fd\u4f1a\u5904\u4e8e4\u79cd\u4e0d\u540c\u7684\u9636\u6bb5\uff1a</p> <ul> <li><code>Available</code>\uff08\u53ef\u7528\uff09\uff1a\u8868\u793a\u53ef\u7528\u72b6\u6001\uff0c\u8fd8\u672a\u88ab\u4efb\u4f55 PVC \u7ed1\u5b9a</li> <li><code>Bound</code>\uff08\u5df2\u7ed1\u5b9a\uff09\uff1a\u8868\u793a PVC \u5df2\u7ecf\u88ab PVC \u7ed1\u5b9a</li> <li><code>Released</code>\uff08\u5df2\u91ca\u653e\uff09\uff1aPVC \u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u96c6\u7fa4\u91cd\u65b0\u58f0\u660e</li> <li><code>Failed</code>\uff08\u5931\u8d25\uff09\uff1a \u8868\u793a\u8be5 PV \u7684\u81ea\u52a8\u56de\u6536\u5931\u8d25</li> </ul> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u5b8c\u6210\u4e86 PV\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a PV \u7684\u8bdd\uff0c\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 PVC \u6765\u548c\u4ed6\u8fdb\u884c\u7ed1\u5b9a\u4e86\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u6211\u4eec\u7684\u670d\u52a1\u662f\u901a\u8fc7 Pod \u6765\u8fd0\u884c\u7684\uff0c\u800c\u4e0d\u662f Node\uff0c\u53ea\u662f Pod \u8dd1\u5728 Node \u4e0a\u800c\u5df2\u3002</p>"},{"location":"storage/local/hostPath/#pvc","title":"PVC\u7ed1\u5b9a","text":"<p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a PersistentVolumeClaim\uff0cPod \u4f7f\u7528 PVC \u6765\u8bf7\u6c42\u7269\u7406\u5b58\u50a8\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u7684 PVC \u8bf7\u6c42\u81f3\u5c11 3G \u5bb9\u91cf\u7684\u5377\uff0c\u8be5\u5377\u81f3\u5c11\u53ef\u4ee5\u4e3a\u4e00\u4e2a\u8282\u70b9\u63d0\u4f9b\u8bfb\u5199\u8bbf\u95ee\uff0c\u4e0b\u9762\u662f PVC \u7684\u914d\u7f6e\u6587\u4ef6\uff1a</p> pvc-hostpath.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: pvc-hostpath\nspec:\nstorageClassName: manual\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 3Gi\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a PVC \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f pvc-hostpath.yaml\npersistentvolumeclaim/pvc-hostpath created\n</code></pre> <p>\u521b\u5efa PVC \u4e4b\u540e\uff0cKubernetes \u5c31\u4f1a\u53bb\u67e5\u627e\u6ee1\u8db3\u6211\u4eec\u58f0\u660e\u8981\u6c42\u7684 PV\uff0c\u6bd4\u5982 <code>storageClassName</code>\u3001<code>accessModes</code> \u4ee5\u53ca\u5bb9\u91cf\u8fd9\u4e9b\u662f\u5426\u6ee1\u8db3\u8981\u6c42\uff0c\u5982\u679c\u6ee1\u8db3\u8981\u6c42\u5c31\u4f1a\u5c06 PV \u548c PVC \u7ed1\u5b9a\u5728\u4e00\u8d77\u3002</p> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u76ee\u524d PV \u548c PVC \u4e4b\u95f4\u662f\u4e00\u5bf9\u4e00\u7ed1\u5b9a\u7684\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2a PV \u53ea\u80fd\u88ab\u4e00\u4e2a PVC \u7ed1\u5b9a\u3002</p> <p>\u6211\u4eec\u73b0\u5728\u518d\u6b21\u67e5\u770b PV \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pv -l type=local\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS   REASON   AGE\npv-hostpath   10Gi       RWO            Retain           Bound    default/pvc-hostpath   manual                  81m\n</code></pre> <p>\u73b0\u5728\u8f93\u51fa\u7684 STATUS \u4e3a <code>Bound</code>\uff0c\u67e5\u770b PVC \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pvc pvc-hostpath\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS   AGE\npvc-hostpath   Bound    pv-hostpath   10Gi       RWO            manual         6m47s\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\u8868\u660e\u8be5 PVC \u7ed1\u5b9a\u4e86\u5230\u4e86\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>pv-hostpath</code> \u8fd9\u4e2a PV \u4e0a\u9762\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u867d\u7136\u58f0\u660e\u76843G\u7684\u5bb9\u91cf\uff0c\u4f46\u662f\u7531\u4e8e PV \u91cc\u9762\u662f 10G\uff0c\u6240\u4ee5\u663e\u7136\u4e5f\u662f\u6ee1\u8db3\u8981\u6c42\u7684\u3002</p> <p>PVC \u51c6\u5907\u597d\u8fc7\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u521b\u5efa Pod \u4e86\uff0c\u8be5 Pod \u4f7f\u7528\u4e0a\u9762\u6211\u4eec\u58f0\u660e\u7684 PVC \u4f5c\u4e3a\u5b58\u50a8\u5377\uff1a</p> pv-hostpath-pod.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pv-hostpath-pod\nspec:\nvolumes:\n- name: pv-hostpath\npersistentVolumeClaim:\nclaimName: pvc-hostpath\nnodeSelector:\nkubernetes.io/hostname: node1\ncontainers:\n- name: task-pv-container\nimage: nginx\nports:\n- containerPort: 80\nvolumeMounts:\n- mountPath: \"/usr/share/nginx/html\"\nname: pv-hostpath\n</code></pre> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u521b\u5efa\u7684 PV \u771f\u6b63\u7684\u5b58\u50a8\u5728\u8282\u70b9 <code>node1</code> \u4e0a\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5fc5\u987b\u628a Pod \u56fa\u5b9a\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0b\u9762\uff0c\u53e6\u5916\u53ef\u4ee5\u6ce8\u610f\u5230 Pod \u7684\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u4e86 PersistentVolumeClaim\uff0c\u4f46\u6ca1\u6709\u6307\u5b9a PersistentVolume\uff0c\u5bf9 Pod \u800c\u8a00\uff0cPVC \u5c31\u662f\u4e00\u4e2a\u5b58\u50a8\u5377\u3002\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f pv-hostpath-pod.yaml\npod/pv-hostpath-pod created\n$ kubectl get pod pv-hostpath-pod\nNAME              READY   STATUS    RESTARTS   AGE\npv-hostpath-pod   1/1     Running   0          105s\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u4e00\u4e2a shell \u8bbf\u95ee Pod \u4e2d\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl exec -it pv-hostpath-pod -- /bin/bash\n</code></pre> <p>\u5728 shell \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1 nginx \u7684\u6570\u636e \u662f\u5426\u6b63\u5728\u4ece hostPath \u5377\u63d0\u4f9b <code>index.html</code> \u6587\u4ef6\uff1a</p> <pre><code>root@pv-hostpath-pod:/# apt-get update\nroot@pv-hostpath-pod:/# apt-get install curl -y\nroot@pv-hostpath-pod:/# curl localhost\nHello from Kubernetes hostpath storage\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u7ed3\u679c\u662f\u6211\u4eec\u524d\u9762\u5199\u5230 hostPath \u5377\u79cd\u7684 <code>index.html</code> \u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u628a Pod \u5220\u9664\uff0c\u7136\u540e\u518d\u6b21\u91cd\u5efa\u518d\u6d4b\u8bd5\u4e00\u6b21\uff0c\u53ef\u4ee5\u53d1\u73b0\u5185\u5bb9\u8fd8\u662f\u6211\u4eec\u5728 hostPath \u79cd\u8bbe\u7f6e\u7684\u5185\u5bb9\u3002</p> \u6211\u4eec\u5728\u6301\u4e45\u5316\u5bb9\u5668\u6570\u636e\u7684\u65f6\u5019\u4f7f\u7528 PV/PVC \u6709\u4ec0\u4e48\u597d\u5904\u5462\uff1f <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e4b\u524d\u76f4\u63a5\u5728 Pod \u4e0b\u9762\u4e5f\u53ef\u4ee5\u4f7f\u7528 hostPath \u6765\u6301\u4e45\u5316\u6570\u636e\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u8d39\u52b2\u53bb\u521b\u5efa PV\u3001PVC \u5bf9\u8c61\u6765\u5f15\u7528\u5462\uff1f</p> <p>PVC \u548c PV \u7684\u8bbe\u8ba1\uff0c\u5176\u5b9e\u8ddf\u201c\u9762\u5411\u5bf9\u8c61\u201d\u7684\u601d\u60f3\u5b8c\u5168\u4e00\u81f4\uff0cPVC \u53ef\u4ee5\u7406\u89e3\u4e3a\u6301\u4e45\u5316\u5b58\u50a8\u7684\u201c\u63a5\u53e3\u201d\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u67d0\u79cd\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63cf\u8ff0\uff0c\u4f46\u4e0d\u63d0\u4f9b\u5177\u4f53\u7684\u5b9e\u73b0\uff1b\u800c\u8fd9\u4e2a\u6301\u4e45\u5316\u5b58\u50a8\u7684\u5b9e\u73b0\u90e8\u5206\u5219\u7531 PV \u8d1f\u8d23\u5b8c\u6210\u3002\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\uff0c\u4f5c\u4e3a\u5e94\u7528\u5f00\u53d1\u8005\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8ddf PVC \u8fd9\u4e2a\u201c\u63a5\u53e3\u201d\u6253\u4ea4\u9053\uff0c\u800c\u4e0d\u5fc5\u5173\u5fc3\u5177\u4f53\u7684\u5b9e\u73b0\u662f hostPath\u3001NFS \u8fd8\u662f Ceph\u3002\u6bd5\u7adf\u8fd9\u4e9b\u5b58\u50a8\u76f8\u5173\u7684\u77e5\u8bc6\u592a\u4e13\u4e1a\u4e86\uff0c\u5e94\u8be5\u4ea4\u7ed9\u4e13\u4e1a\u7684\u4eba\u53bb\u505a\uff0c\u8fd9\u6837\u5bf9\u4e8e\u6211\u4eec\u7684 Pod \u6765\u8bf4\u5c31\u4e0d\u7528\u7ba1\u5177\u4f53\u7684\u7ec6\u8282\u4e86\uff0c\u4f60\u53ea\u9700\u8981\u7ed9\u6211\u4e00\u4e2a\u53ef\u7528\u7684 PVC \u5373\u53ef\u4e86\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u5c31\u5b8c\u5168\u5c4f\u853d\u4e86\u7ec6\u8282\u548c\u89e3\u8026\u4e86\u554a\uff0c\u6240\u4ee5\u6211\u4eec\u66f4\u5e94\u8be5\u4f7f\u7528 PV\u3001PVC \u8fd9\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"storage/local/localPv/","title":"Local PV","text":"<p>\u6211\u4eec\u521b\u5efa\u4e86\u540e\u7aef\u662f hostPath \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\uff0c\u4f7f\u7528 hostPath \u6709\u4e00\u4e2a\u5c40\u9650\u6027\u5c31\u662f\uff0c\u6211\u4eec\u7684 Pod \u4e0d\u80fd\u968f\u4fbf\u6f02\u79fb\uff0c\u9700\u8981\u56fa\u5b9a\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u4e00\u65e6\u6f02\u79fb\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\u53bb\u4e86\u5bbf\u4e3b\u673a\u4e0a\u9762\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684\u6570\u636e\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f7f\u7528 hostPath \u7684\u65f6\u5019\u90fd\u4f1a\u642d\u914d <code>nodeSelector</code> \u6765\u8fdb\u884c\u4f7f\u7528\u3002\u4f46\u662f\u4f7f\u7528 hostPath \u660e\u663e\u4e5f\u6709\u4e00\u4e9b\u597d\u5904\u7684\uff0c\u56e0\u4e3a PV \u76f4\u63a5\u4f7f\u7528\u7684\u662f\u672c\u5730\u78c1\u76d8\uff0c\u5c24\u5176\u662f SSD \u76d8\uff0c\u5b83\u7684\u8bfb\u5199\u6027\u80fd\u76f8\u6bd4\u4e8e\u5927\u591a\u6570\u8fdc\u7a0b\u5b58\u50a8\u6765\u8bf4\uff0c\u8981\u597d\u5f97\u591a\uff0c\u6240\u4ee5\u5bf9\u4e8e\u4e00\u4e9b\u5bf9\u78c1\u76d8 IO \u8981\u6c42\u6bd4\u8f83\u9ad8\u7684\u5e94\u7528\u6bd4\u5982 etcd \u5c31\u975e\u5e38\u5b9e\u7528\u4e86\u3002\u4e0d\u8fc7\u5462\uff0c\u76f8\u6bd4\u4e8e\u6b63\u5e38\u7684 PV \u6765\u8bf4\uff0c\u4f7f\u7528\u4e86 hostPath \u7684\u8fd9\u4e9b\u8282\u70b9\u4e00\u65e6\u5b95\u673a\u6570\u636e\u5c31\u53ef\u80fd\u4e22\u5931\uff0c\u6240\u4ee5\u8fd9\u5c31\u8981\u6c42\u4f7f\u7528 hostPath \u7684\u5e94\u7528\u5fc5\u987b\u5177\u5907\u6570\u636e\u5907\u4efd\u548c\u6062\u590d\u7684\u80fd\u529b\uff0c\u5141\u8bb8\u4f60\u628a\u8fd9\u4e9b\u6570\u636e\u5b9a\u65f6\u5907\u4efd\u5728\u5176\u4ed6\u4f4d\u7f6e\u3002</p>"},{"location":"storage/local/localPv/#_1","title":"\u6982\u5ff5","text":"<p>\u6240\u4ee5\u5728 hostPath \u7684\u57fa\u7840\u4e0a\uff0cKubernetes \u4f9d\u9760 PV\u3001PVC \u5b9e\u73b0\u4e86\u4e00\u4e2a\u65b0\u7684\u7279\u6027\uff0c\u8fd9\u4e2a\u7279\u6027\u7684\u540d\u5b57\u53eb\u4f5c\uff1aLocal Persistent Volume\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684 <code>Local PV</code>\u3002</p>"},{"location":"storage/local/localPv/#_2","title":"\u529f\u80fd\u63cf\u8ff0","text":"<p>\u5176\u5b9e Local PV \u5b9e\u73b0\u7684\u529f\u80fd\u5c31\u975e\u5e38\u7c7b\u4f3c\u4e8e hostPath \u52a0\u4e0a <code>nodeAffinity</code>\uff0c\u6bd4\u5982\uff0c\u4e00\u4e2a Pod \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528\u7c7b\u578b\u4e3a Local \u7684 PV\uff0c\u800c\u8fd9\u4e2a PV \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 Volume\u3002\u5982\u679c\u8fd9\u4e2a hostPath \u5bf9\u5e94\u7684\u76ee\u5f55\uff0c\u5df2\u7ecf\u5728\u8282\u70b9 A \u4e0a\u88ab\u4e8b\u5148\u521b\u5efa\u597d\u4e86\uff0c\u90a3\u4e48\uff0c\u6211\u53ea\u9700\u8981\u518d\u7ed9\u8fd9\u4e2a Pod \u52a0\u4e0a\u4e00\u4e2a <code>nodeAffinity=nodeA</code>\uff0c\u4e0d\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a Volume \u4e86\u5417\uff1f\u7406\u8bba\u4e0a\u786e\u5b9e\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u7edd\u4e0d\u5e94\u8be5\u628a\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u5f53\u4f5c PV \u6765\u4f7f\u7528\uff0c\u56e0\u4e3a\u672c\u5730\u76ee\u5f55\u7684\u5b58\u50a8\u884c\u4e3a\u662f\u5b8c\u5168\u4e0d\u53ef\u63a7\uff0c\u5b83\u6240\u5728\u7684\u78c1\u76d8\u968f\u65f6\u90fd\u53ef\u80fd\u88ab\u5e94\u7528\u5199\u6ee1\uff0c\u751a\u81f3\u9020\u6210\u6574\u4e2a\u5bbf\u4e3b\u673a\u5b95\u673a\u3002\u6240\u4ee5\uff0c\u4e00\u822c\u6765\u8bf4 Local PV \u5bf9\u5e94\u7684\u5b58\u50a8\u4ecb\u8d28\u662f\u4e00\u5757\u989d\u5916\u6302\u8f7d\u5728\u5bbf\u4e3b\u673a\u7684\u78c1\u76d8\u6216\u8005\u5757\u8bbe\u5907\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u5c31\u662f\u201c\u4e00\u4e2a PV \u4e00\u5757\u76d8\u201d\u3002</p>"},{"location":"storage/local/localPv/#local-pvpv","title":"Local PV\u548c\u666e\u901aPV\u7684\u533a\u522b","text":"<p>\u53e6\u5916\u4e00\u4e2a Local PV \u548c\u666e\u901a\u7684 PV \u6709\u4e00\u4e2a\u5f88\u5927\u7684\u4e0d\u540c\u5728\u4e8e Local PV \u53ef\u4ee5\u4fdd\u8bc1 Pod \u59cb\u7ec8\u80fd\u591f\u88ab\u6b63\u786e\u5730\u8c03\u5ea6\u5230\u5b83\u6240\u8bf7\u6c42\u7684 Local PV \u6240\u5728\u7684\u8282\u70b9\u4e0a\u9762\uff0c\u5bf9\u4e8e\u666e\u901a\u7684 PV \u6765\u8bf4\uff0cKubernetes \u90fd\u662f\u5148\u8c03\u5ea6 Pod \u5230\u67d0\u4e2a\u8282\u70b9\u4e0a\uff0c\u7136\u540e\u518d\u6301\u4e45\u5316\u8282\u70b9\u4e0a\u7684 Volume \u76ee\u5f55\uff0c\u8fdb\u800c\u5b8c\u6210 Volume \u76ee\u5f55\u4e0e\u5bb9\u5668\u7684\u7ed1\u5b9a\u6302\u8f7d\uff0c\u4f46\u662f\u5bf9\u4e8e Local PV \u6765\u8bf4\uff0c\u8282\u70b9\u4e0a\u53ef\u4f9b\u4f7f\u7528\u7684\u78c1\u76d8\u5fc5\u987b\u662f\u63d0\u524d\u51c6\u5907\u597d\u7684\uff0c\u56e0\u4e3a\u5b83\u4eec\u5728\u4e0d\u540c\u8282\u70b9\u4e0a\u7684\u6302\u8f7d\u60c5\u51b5\u53ef\u80fd\u5b8c\u5168\u4e0d\u540c\uff0c\u751a\u81f3\u6709\u7684\u8282\u70b9\u53ef\u4ee5\u6ca1\u8fd9\u79cd\u78c1\u76d8\uff0c\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\uff0c\u8c03\u5ea6\u5668\u5c31\u5fc5\u987b\u80fd\u591f\u77e5\u9053\u6240\u6709\u8282\u70b9\u4e0e Local PV \u5bf9\u5e94\u7684\u78c1\u76d8\u7684\u5173\u8054\u5173\u7cfb\uff0c\u7136\u540e\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\u6765\u8c03\u5ea6 Pod\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5728\u8c03\u5ea6\u7684\u65f6\u5019\u8003\u8651 Volume \u7684\u5206\u5e03\u3002</p>"},{"location":"storage/local/localPv/#local-pv","title":"Local PV\u4f7f\u7528","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b Local PV \u7684\u4f7f\u7528\uff0c\u5f53\u7136\u6309\u7167\u4e0a\u9762\u6211\u4eec\u7684\u5206\u6790\u6211\u4eec\u5e94\u8be5\u7ed9\u5bbf\u4e3b\u673a\u6302\u8f7d\u5e76\u683c\u5f0f\u5316\u4e00\u4e2a\u53ef\u7528\u7684\u78c1\u76d8\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u6682\u65f6\u5c06 <code>node1</code> \u8282\u70b9\u4e0a\u7684 <code>/data/k8s/localpv</code> \u8fd9\u4e2a\u76ee\u5f55\u770b\u6210\u662f\u6302\u8f7d\u7684\u4e00\u4e2a\u72ec\u7acb\u7684\u78c1\u76d8\u3002\u73b0\u5728\u6211\u4eec\u6765\u58f0\u660e\u4e00\u4e2a Local PV \u7c7b\u578b\u7684 PV\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> pv-local.yaml<pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\nname: pv-local\nspec:\ncapacity:\nstorage: 5Gi\nvolumeMode: Filesystem\naccessModes:\n- ReadWriteOnce\npersistentVolumeReclaimPolicy: Delete\nstorageClassName: local-storage\nlocal:\npath: /data/k8s/localpv  # node1\u8282\u70b9\u4e0a\u7684\u76ee\u5f55\nnodeAffinity:\nrequired:\nnodeSelectorTerms:\n- matchExpressions:\n- key: kubernetes.io/hostname\noperator: In\nvalues:\n- node1\n</code></pre> <p>\u548c\u524d\u9762\u6211\u4eec\u5b9a\u4e49\u7684 PV \u4e0d\u540c\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>local</code> \u5b57\u6bb5\uff0c\u8868\u660e\u5b83\u662f\u4e00\u4e2a Local PV\uff0c\u800c path \u5b57\u6bb5\uff0c\u6307\u5b9a\u7684\u6b63\u662f\u8fd9\u4e2a PV \u5bf9\u5e94\u7684\u672c\u5730\u78c1\u76d8\u7684\u8def\u5f84\uff0c\u5373\uff1a<code>/data/k8s/localpv</code>\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u5982\u679c Pod \u8981\u60f3\u4f7f\u7528\u8fd9\u4e2a PV\uff0c\u90a3\u5b83\u5c31\u5fc5\u987b\u8fd0\u884c\u5728 <code>node1</code> \u8282\u70b9\u4e0a\u3002\u6240\u4ee5\uff0c\u5728\u8fd9\u4e2a PV \u7684\u5b9a\u4e49\u91cc\uff0c\u6dfb\u52a0\u4e86\u4e00\u4e2a\u8282\u70b9\u4eb2\u548c\u6027 <code>nodeAffinity</code> \u5b57\u6bb5\u6307\u5b9a <code>node1</code> \u8fd9\u4e2a\u8282\u70b9\u3002\u8fd9\u6837\uff0c\u8c03\u5ea6\u5668\u5728\u8c03\u5ea6 Pod \u7684\u65f6\u5019\uff0c\u5c31\u80fd\u591f\u77e5\u9053\u4e00\u4e2a PV \u4e0e\u8282\u70b9\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u4ece\u800c\u505a\u51fa\u6b63\u786e\u7684\u9009\u62e9\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pv-local.yaml persistentvolume/pv-local created\n$ kubectl get pv\nNAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS  CLAIM      STORAGECLASS      REASON   AGE\npv-local  5Gi        RWO            Delete           Available          local-storage              24s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a PV \u521b\u5efa\u540e\uff0c\u8fdb\u5165\u4e86 Available\uff08\u53ef\u7528\uff09\u72b6\u6001\u3002\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6309\u7167\u524d\u9762\u63d0\u5230\u7684\uff0c\u6211\u4eec\u8981\u4f7f\u7528\u8fd9\u4e2a Local PV \u7684\u8bdd\u5c31\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a PVC \u548c\u4ed6\u8fdb\u884c\u7ed1\u5b9a\uff1a</p> pvc-local.yaml<pre><code>kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\nname: pvc-local\nspec:\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 5Gi\nstorageClassName: local-storage\n</code></pre> <p>\u540c\u6837\u8981\u6ce8\u610f\u58f0\u660e\u7684\u8fd9\u4e9b\u5c5e\u6027\u9700\u8981\u548c\u4e0a\u9762\u7684 PV \u5bf9\u5e94\uff0c\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pvc-local.yaml persistentvolumeclaim/pvc-local created\n$ kubectl get pvc\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Bound    pv-local      5Gi        RWO            local-storage   38s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728 PVC \u548c PV \u5df2\u7ecf\u5904\u4e8e <code>Bound</code> \u7ed1\u5b9a\u72b6\u6001\u4e86\u3002\u4f46\u5b9e\u9645\u4e0a\u8fd9\u662f\u4e0d\u7b26\u5408\u6211\u4eec\u7684\u9700\u6c42\u7684\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7684 Pod \u58f0\u660e\u4f7f\u7528\u8fd9\u4e2a pvc-local\uff0c\u5e76\u4e14\u6211\u4eec\u4e5f\u660e\u786e\u89c4\u5b9a\uff0c\u8fd9\u4e2a Pod \u53ea\u80fd\u8fd0\u884c\u5728 <code>node2</code> \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6309\u7167\u4e0a\u9762\u6211\u4eec\u8fd9\u91cc\u7684\u64cd\u4f5c\uff0c\u8fd9\u4e2a pvc-local \u662f\u4e0d\u662f\u5c31\u548c\u6211\u4eec\u8fd9\u91cc\u7684 pv-local \u8fd9\u4e2a Local PV \u7ed1\u5b9a\u5728\u4e00\u8d77\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a PV \u7684\u5b58\u50a8\u5238\u53c8\u5728 <code>node1</code> \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u663e\u7136\u5c31\u4f1a\u51fa\u73b0\u51b2\u7a81\u4e86\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u7684\u8c03\u5ea6\u80af\u5b9a\u5c31\u4f1a\u5931\u8d25\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f7f\u7528 Local PV \u7684\u65f6\u5019\uff0c\u5fc5\u987b\u60f3\u529e\u6cd5\u5ef6\u8fdf\u8fd9\u4e2a\u201c\u7ed1\u5b9a\u201d\u64cd\u4f5c\u3002</p>"},{"location":"storage/local/localPv/#_3","title":"\u5ef6\u8fdf\u7ed1\u5b9a","text":"<p>\u600e\u4e48\u5b9e\u73b0\u5ef6\u8fdf\u7ed1\u5b9a\u5462\uff1f</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa <code>StorageClass</code> \u6765\u6307\u5b9a\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u5728 <code>StorageClass</code> \u79cd\u6709\u4e00\u4e2a <code>volumeBindingMode=WaitForFirstConsumer</code> \u7684\u5c5e\u6027\uff0c\u5c31\u662f\u544a\u8bc9 Kubernetes \u5728\u53d1\u73b0\u8fd9\u4e2a <code>StorageClass</code> \u5173\u8054\u7684 PVC \u4e0e PV \u53ef\u4ee5\u7ed1\u5b9a\u5728\u4e00\u8d77\uff0c\u4f46\u4e0d\u8981\u73b0\u5728\u5c31\u7acb\u523b\u6267\u884c\u7ed1\u5b9a\u64cd\u4f5c\uff08\u5373\uff1a\u8bbe\u7f6e PVC \u7684 <code>VolumeName</code> \u5b57\u6bb5\uff09\uff0c\u800c\u662f\u8981\u7b49\u5230\u7b2c\u4e00\u4e2a\u58f0\u660e\u4f7f\u7528\u8be5 PVC \u7684 Pod \u51fa\u73b0\u5728\u8c03\u5ea6\u5668\u4e4b\u540e\uff0c\u8c03\u5ea6\u5668\u518d\u7efc\u5408\u8003\u8651\u6240\u6709\u7684\u8c03\u5ea6\u89c4\u5219\uff0c\u5f53\u7136\u4e5f\u5305\u62ec\u6bcf\u4e2a PV \u6240\u5728\u7684\u8282\u70b9\u4f4d\u7f6e\uff0c\u6765\u7edf\u4e00\u51b3\u5b9a\uff0c\u8fd9\u4e2a Pod \u58f0\u660e\u7684 PVC\uff0c\u5230\u5e95\u5e94\u8be5\u8ddf\u54ea\u4e2a PV \u8fdb\u884c\u7ed1\u5b9a\u3002\u901a\u8fc7\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u673a\u5236\uff0c\u539f\u672c\u5b9e\u65f6\u53d1\u751f\u7684 PVC \u548c PV \u7684\u7ed1\u5b9a\u8fc7\u7a0b\uff0c\u5c31\u88ab\u5ef6\u8fdf\u5230\u4e86 Pod \u7b2c\u4e00\u6b21\u8c03\u5ea6\u7684\u65f6\u5019\u5728\u8c03\u5ea6\u5668\u4e2d\u8fdb\u884c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u8fd9\u4e2a\u7ed1\u5b9a\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd Pod \u7684\u6b63\u5e38\u8c03\u5ea6\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u521b\u5efa\u5bf9\u5e94\u7684 <code>StorageClass</code> \u5bf9\u8c61\uff1a</p> local-storageclass.yaml<pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n</code></pre> <p>\u8fd9\u4e2a <code>StorageClass</code> \u7684\u540d\u5b57\uff0c\u53eb\u4f5c <code>local-storage</code>\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5728 PV \u4e2d\u58f0\u660e\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5b83\u7684 <code>provisioner</code> \u5b57\u6bb5\uff0c\u6211\u4eec\u6307\u5b9a\u7684\u662f <code>no-provisioner</code>\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u662f\u624b\u52a8\u521b\u5efa\u7684 PV\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u52a8\u6001\u6765\u751f\u6210 PV\uff0c\u53e6\u5916\u8fd9\u4e2a <code>StorageClass</code> \u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>volumeBindingMode=WaitForFirstConsumer</code> \u7684\u5c5e\u6027\uff0c\u5b83\u662f Local PV \u91cc\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u5373\uff1a\u5ef6\u8fdf\u7ed1\u5b9a\u3002\u901a\u8fc7\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u673a\u5236\uff0c\u539f\u672c\u5b9e\u65f6\u53d1\u751f\u7684 PVC \u548c PV \u7684\u7ed1\u5b9a\u8fc7\u7a0b\uff0c\u5c31\u88ab\u5ef6\u8fdf\u5230\u4e86 Pod \u7b2c\u4e00\u6b21\u8c03\u5ea6\u7684\u65f6\u5019\u5728\u8c03\u5ea6\u5668\u4e2d\u8fdb\u884c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u8fd9\u4e2a\u7ed1\u5b9a\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd Pod \u7684\u6b63\u5e38\u8c03\u5ea6\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u8fd9\u4e2a StorageClass \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f local-storageclass.yaml storageclass.storage.k8s.io/local-storage created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u5220\u9664\u4e0a\u9762\u58f0\u660e\u7684 PVC \u5bf9\u8c61\uff0c\u91cd\u65b0\u521b\u5efa\uff1a</p> <pre><code>$ kubectl delete -f pvc-local.yaml persistentvolumeclaim \"pvc-local\" deleted\n$ kubectl create -f pvc-local.yaml\npersistentvolumeclaim/pvc-local created\n$ kubectl get pvc\nNAME           STATUS    VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Pending                                           local-storage   3s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u65f6\u5019\uff0c\u96c6\u7fa4\u4e2d\u5373\u4f7f\u5df2\u7ecf\u5b58\u5728\u4e86\u4e00\u4e2a\u53ef\u4ee5\u4e0e PVC \u5339\u914d\u7684 PV \u4e86\uff0c\u4f46\u8fd9\u4e2a PVC \u4f9d\u7136\u5904\u4e8e <code>Pending</code> \u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u7b49\u5f85\u7ed1\u5b9a\u7684\u72b6\u6001\uff0c\u8fd9\u5c31\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u662f\u5ef6\u8fdf\u7ed1\u5b9a\uff0c\u9700\u8981\u5728\u771f\u6b63\u7684 Pod \u4f7f\u7528\u7684\u65f6\u5019\u624d\u4f1a\u6765\u505a\u7ed1\u5b9a\u3002</p> <p>\u540c\u6837\u6211\u4eec\u58f0\u660e\u4e00\u4e2a Pod \u6765\u4f7f\u7528\u8fd9\u91cc\u7684 <code>pvc-local</code> \u8fd9\u4e2a PVC\uff0c\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> pv-local-pod.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: pv-local-pod\nspec:\nvolumes:\n- name: example-pv-local\npersistentVolumeClaim:\nclaimName: pvc-local\ncontainers:\n- name: example-pv-local\nimage: nginx\nports:\n- containerPort: 80\nvolumeMounts:\n- mountPath: /usr/share/nginx/html\nname: example-pv-local\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f pv-local-pod.yaml pod/pv-local-pod created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u8fd9\u4e2a\u65f6\u5019\u53bb\u67e5\u770b\u524d\u9762\u6211\u4eec\u58f0\u660e\u7684 PVC\uff0c\u4f1a\u7acb\u523b\u53d8\u6210 <code>Bound</code> \u72b6\u6001\uff0c\u4e0e\u524d\u9762\u5b9a\u4e49\u7684 PV \u7ed1\u5b9a\u5728\u4e86\u4e00\u8d77\uff1a</p> <pre><code>$ kubectl get pvc\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Bound    pv-local      5Gi        RWO            local-storage   4m59s\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728\u8fd9\u4e2a Pod \u7684 Volume \u76ee\u5f55\u91cc\uff0c\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>$ kubectl exec -it pv-local-pod /bin/sh\n# cd /usr/share/nginx/html\n# echo \"Hello from Kubernetes local pv storage\" &gt; test.txt  \n# \n</code></pre> <p>\u7136\u540e\uff0c\u767b\u5f55\u5230 <code>node1</code> \u8fd9\u53f0\u673a\u5668\u4e0a\uff0c\u67e5\u770b\u4e00\u4e0b\u5b83\u7684 <code>/data/k8s/localpv</code> \u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\uff0c\u4f60\u5c31\u53ef\u4ee5\u770b\u5230\u521a\u521a\u521b\u5efa\u7684\u8fd9\u4e2a\u6587\u4ef6\uff1a</p> <pre><code># \u5728node1\u8282\u70b9\u4e0a\n$ ls /data/k8s/localpv\ntest.txt\n$ cat /data/k8s/localpv/test.txt Hello from Kubernetes local pv storage\n</code></pre> <p>\u5982\u679c\u91cd\u65b0\u521b\u5efa\u8fd9\u4e2a Pod \u7684\u8bdd\uff0c\u5c31\u4f1a\u53d1\u73b0\uff0c\u6211\u4eec\u4e4b\u524d\u521b\u5efa\u7684\u6d4b\u8bd5\u6587\u4ef6\uff0c\u4f9d\u7136\u88ab\u4fdd\u5b58\u5728\u8fd9\u4e2a\u6301\u4e45\u5316 Volume \u5f53\u4e2d\uff1a</p> <pre><code>$ kubectl delete -f pv-local-pod.yaml  $ kubectl apply -f pv-local-pod.yaml $ kubectl exec -it pv-local-pod /bin/sh\n# ls /usr/share/nginx/html\ntest.txt\n# cat /usr/share/nginx/html/test.txt\nHello from Kubernetes local pv storage\n# \n</code></pre> <p>\u5230\u8fd9\u91cc\u5c31\u8bf4\u660e\u57fa\u4e8e\u672c\u5730\u5b58\u50a8\u7684 Volume \u662f\u5b8c\u5168\u53ef\u4ee5\u63d0\u4f9b\u5bb9\u5668\u6301\u4e45\u5316\u5b58\u50a8\u529f\u80fd\u7684\uff0c\u5bf9\u4e8e StatefulSet \u8fd9\u6837\u7684\u6709\u72b6\u6001\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u58f0\u660e Local \u7c7b\u578b\u7684 PV \u548c PVC\uff0c\u6765\u7ba1\u7406\u5e94\u7528\u7684\u5b58\u50a8\u72b6\u6001\u3002</p>"},{"location":"storage/local/localPv/#pv","title":"\u5220\u9664 PV","text":"<p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0a\u9762\u624b\u52a8\u521b\u5efa PV \u7684\u65b9\u5f0f\uff0c\u5373\u9759\u6001\u7684 PV \u7ba1\u7406\u65b9\u5f0f\uff0c\u5728\u5220\u9664 PV \u65f6\u9700\u8981\u6309\u5982\u4e0b\u6d41\u7a0b\u6267\u884c\u64cd\u4f5c\uff1a</p> <ul> <li>\u5220\u9664\u4f7f\u7528\u8fd9\u4e2a PV \u7684 Pod</li> <li>\u4ece\u5bbf\u4e3b\u673a\u79fb\u9664\u672c\u5730\u78c1\u76d8</li> <li>\u5220\u9664 PVC</li> <li>\u5220\u9664 PV</li> </ul> <p>\u5982\u679c\u4e0d\u6309\u7167\u8fd9\u4e2a\u6d41\u7a0b\u7684\u8bdd\uff0c\u8fd9\u4e2a PV \u7684\u5220\u9664\u5c31\u4f1a\u5931\u8d25\u3002</p>"},{"location":"storage/openEBS/cas/","title":"\u5bb9\u5668\u9644\u52a0\u5b58\u50a8","text":""},{"location":"storage/openEBS/cas/#_1","title":"\u5b58\u50a8\u5f15\u64ce\u6982\u8ff0","text":"<p>\u5b58\u50a8\u5f15\u64ce\u662f\u6301\u4e45\u5316\u5377<code>IO</code>\u8def\u5f84\u7684\u6570\u636e\u5e73\u9762\u7ec4\u4ef6\u3002 \u5728CAS\u67b6\u6784\u4e2d\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u7684\u914d\u7f6e\u7b56\u7565\uff0c\u4e3a\u4e0d\u540c\u7684\u5e94\u7528\u5de5\u4f5c\u8d1f\u8f7d\u9009\u62e9\u4e0d\u540c\u7684\u6570\u636e\u5e73\u9762\u3002 \u5b58\u50a8\u5f15\u64ce\u53ef\u4ee5\u901a\u8fc7\u7279\u6027\u96c6\u6216\u6027\u80fd\u4f18\u5316\u7ed9\u5b9a\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002</p> <p>\u64cd\u4f5c\u5458\u6216\u7ba1\u7406\u5458\u901a\u5e38\u9009\u62e9\u5177\u6709\u7279\u5b9a\u8f6f\u4ef6\u7248\u672c\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5e76\u6784\u5efa\u4f18\u5316\u7684\u5377\u6a21\u677f\uff0c \u8fd9\u4e9b\u5377\u6a21\u677f\u6839\u636e\u5e95\u5c42\u78c1\u76d8\u7684\u7c7b\u578b\u3001\u5f39\u6027\u3001\u526f\u672c\u6570\u91cf\u548c\u53c2\u4e0eKubernetes\u96c6\u7fa4\u7684\u8282\u70b9\u96c6\u8fdb\u884c\u5fae\u8c03\u3002 \u7528\u6237\u53ef\u4ee5\u5728\u53d1\u653e\u5377\u65f6\u9009\u62e9\u6700\u4f18\u7684\u5377\u6a21\u677f\uff0c\u4ece\u800c\u5728\u7ed9\u5b9a\u7684Kubernetes\u96c6\u7fa4\u4e0a\u4e3a\u6240\u6709\u5b58\u50a8\u5377\u8fd0\u884c\u6700\u4f18\u7684\u8f6f\u4ef6\u548c\u5b58\u50a8\u7ec4\u5408\u63d0\u4f9b\u6700\u5927\u7684\u7075\u6d3b\u6027\u3002</p>"},{"location":"storage/openEBS/cas/#_2","title":"\u5b58\u50a8\u5f15\u64ce\u7c7b\u578b","text":"<p>OpenEBS\u63d0\u4f9b\u4e86\u4e09\u79cd\u5b58\u50a8\u5f15\u64ce</p>"},{"location":"storage/openEBS/cas/#jiva","title":"Jiva","text":"<p><code>Jiva</code>\u662fOpenEBS 0.1\u7248\u4e2d\u53d1\u5e03\u7684\u7b2c\u4e00\u4e2a\u5b58\u50a8\u5f15\u64ce\uff0c\u4f7f\u7528\u8d77\u6765\u6700\u7b80\u5355\u3002\u5b83\u57fa\u4e8eGoLang\u5f00\u53d1\uff0c\u5185\u90e8\u4f7f\u7528<code>LongHorn</code>\u548c<code>gotgt</code>\u5806\u6808\u3002 <code>Jiva</code>\u5b8c\u5168\u5728\u7528\u6237\u7a7a\u95f4\u4e2d\u8fd0\u884c\uff0c\u5e76\u63d0\u4f9b\u540c\u6b65\u590d\u5236\u7b49\u6807\u51c6\u5757\u5b58\u50a8\u529f\u80fd\u3002 <code>Jiva</code>\u901a\u5e38\u9002\u7528\u4e8e\u5bb9\u91cf\u8f83\u5c0f\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u4e0d\u9002\u7528\u4e8e\u5927\u91cf\u5feb\u7167\u548c\u514b\u9686\u7279\u6027\u662f\u4e3b\u8981\u9700\u6c42\u7684\u60c5\u51b5</p>"},{"location":"storage/openEBS/cas/#cstor","title":"cStor","text":"<p><code>cStor</code>\u662fOpenEBS 0.7\u7248\u672c\u4e2d\u6700\u65b0\u53d1\u5e03\u7684\u5b58\u50a8\u5f15\u64ce\u3002<code>cStor</code>\u975e\u5e38\u5065\u58ee\uff0c\u63d0\u4f9b\u6570\u636e\u4e00\u81f4\u6027\uff0c\u5f88\u597d\u5730\u652f\u6301\u5feb\u7167\u548c\u514b\u9686\u7b49\u4f01\u4e1a\u5b58\u50a8\u7279\u6027\u3002 \u5b83\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5065\u58ee\u7684\u5b58\u50a8\u6c60\u7279\u6027\uff0c\u7528\u4e8e\u5728\u5bb9\u91cf\u548c\u6027\u80fd\u65b9\u9762\u8fdb\u884c\u5168\u9762\u7684\u5b58\u50a8\u7ba1\u7406\u3002 <code>cStor</code>\u4e0e<code>NDM</code> (Node Disk Manager)\u4e00\u8d77\uff0c\u4e3aKubernetes\u4e0a\u7684\u6709\u72b6\u6001\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u5b8c\u6574\u7684\u6301\u4e45\u5316\u5b58\u50a8\u7279\u6027</p>"},{"location":"storage/openEBS/cas/#openebs-local-pv","title":"OpenEBS Local PV","text":"<p><code>OpenEBS Local PV</code>\u662f\u4e00\u4e2a\u65b0\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u5b83\u53ef\u4ee5\u4ece\u672c\u5730\u78c1\u76d8\u6216\u5de5\u4f5c\u8282\u70b9\u4e0a\u7684\u4e3b\u673a\u8def\u5f84\u521b\u5efa\u6301\u4e45\u5377\u6216PV\u3002 CAS\u5f15\u64ce\u53ef\u4ee5\u4eceOpenEBS\u7684<code>1.0.0</code>\u7248\u672c\u4e2d\u83b7\u5f97\u3002\u4f7f\u7528<code>OpenEBS Local PV</code>\uff0c\u6027\u80fd\u5c06\u7b49\u540c\u4e8e\u521b\u5efa\u5377\u7684\u672c\u5730\u78c1\u76d8\u6216\u6587\u4ef6\u7cfb\u7edf(\u4e3b\u673a\u8def\u5f84)\u3002 \u8bb8\u591a\u4e91\u539f\u751f\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u4e0d\u9700\u8981\u590d\u5236\u3001\u5feb\u7167\u6216\u514b\u9686\u7b49\u9ad8\u7ea7\u5b58\u50a8\u7279\u6027\uff0c\u56e0\u4e3a\u5b83\u4eec\u672c\u8eab\u5c31\u63d0\u4f9b\u4e86\u8fd9\u4e9b\u7279\u6027\u3002\u8fd9\u7c7b\u5e94\u7528\u7a0b\u5e8f\u9700\u8981\u4ee5\u6301\u4e45\u5377\u7684\u5f62\u5f0f\u8bbf\u95ee\u7ba1\u7406\u7684\u78c1\u76d8</p> <p></p> <ul> <li><code>SP</code>: \u5b58\u50a8\u6c60\uff0c\u8868\u793aJiva\u81ea\u5b9a\u4e49\u5b58\u50a8\u8d44\u6e90</li> <li><code>CV</code>: <code>cStor</code>\u5377\uff0c\u8868\u793acStor\u5377\u81ea\u5b9a\u4e49\u8d44\u6e90</li> <li><code>CVR</code>\uff1a<code>cStor</code>\u5377\u526f\u672c</li> <li><code>SPC</code>\uff1a\u5b58\u50a8\u6c60\u58f0\u660e\uff0c\u8868\u793acStor\u6c60\u805a\u5408\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90</li> <li><code>CSP</code>: <code>cStor</code>\u5b58\u50a8\u6c60\uff0c\u8868\u793a<code>cStor</code> Pool\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684\u81ea\u5b9a\u4e49\u8d44\u6e90</li> </ul> <p>\u4e00\u4e2a<code>SPC</code>\u5bf9\u5e94\u591a\u4e2a<code>CSP</code>\uff0c\u76f8\u5e94\u7684\u4e00\u4e2a<code>CV</code>\u5bf9\u5e94\u591a\u4e2a<code>CVR</code>\u3002</p>"},{"location":"storage/openEBS/cas/#_3","title":"\u5b58\u50a8\u5f15\u64ce\u58f0\u660e","text":"<p>\u901a\u8fc7\u6307\u5b9a\u6ce8\u91caopenebs\u6765\u9009\u62e9\u5b58\u50a8\u5f15\u64ce\u3002 <code>StorageClass</code>\u89c4\u8303\u4e2d\u7684<code>io/cas-type</code>\u3002<code>StorageClass</code>\u5b9a\u4e49\u4e86\u63d0\u4f9b\u7a0b\u5e8f\u7684\u7ec6\u8282\u3002\u4e3a\u6bcf\u4e2aCAS\u5f15\u64ce\u6307\u5b9a\u5355\u72ec\u7684\u4f9b\u5e94\u7a0b\u5e8f\u3002</p> cStorJivaLocal PV HostPathLocal PV Device cStor\u5b58\u50a8\u7c7b\u89c4\u8303\u6587\u4ef6\u5185\u5bb9<pre><code>---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: cStor-storageclass\nannotations:\nopenebs.io/cas-type: cstor\ncas.openebs.io/config: |\n- name: StoragePoolClaim\nvalue: \"cStorPool-SSD\"\nprovisioner: openebs.io/provisioner-iscsi\n---\n</code></pre> Jiva\u5b58\u50a8\u7c7b\u89c4\u8303\u6587\u4ef6\u5185\u5bb9<pre><code>---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: jiva-storageclass\nannotations:\nopenebs.io/cas-type: jiva\ncas.openebs.io/config: |\n- name: StoragePool\nvalue: default\nprovisioner: openebs.io/provisioner-iscsi\n---\n</code></pre> <p>\u5f53cas\u7c7b\u578b\u4e3a<code>Jiva</code>\u65f6\uff0c<code>StoragePool</code>\u7684<code>default</code>\u503c\u5177\u6709\u7279\u6b8a\u542b\u4e49\u3002 \u5f53<code>pool</code>\u4e3a\u9ed8\u8ba4\u503c\u65f6\uff0c<code>Jiva</code>\u5f15\u64ce\u5c06\u4ece\u5bb9\u5668(\u526f\u672cpod)\u672c\u8eab\u7684\u5b58\u50a8\u7a7a\u95f4\u4e2d\u4e3a\u526f\u672cpod\u5f00\u8f9f\u6570\u636e\u5b58\u50a8\u7a7a\u95f4\u3002 \u5f53\u6240\u9700\u7684\u5377\u5927\u5c0f\u5f88\u5c0f(\u6bd4\u5982<code>5G</code>\u5230<code>10G</code>)\u65f6\uff0c<code>StoragePool default</code>\u5de5\u4f5c\u5f97\u5f88\u597d\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\u5bb9\u7eb3\u5728\u5bb9\u5668\u672c\u8eab\u5185\u3002</p> Local PV\u5b58\u50a8\u7c7b\u89c4\u8303\u6587\u4ef6\u5185\u5bb9-\u4e3b\u673a\u8def\u5f84<pre><code>---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: localpv-hostpath-sc\nannotations:\nopenebs.io/cas-type: local\ncas.openebs.io/config: |\n- name: BasePath\nvalue: \"/var/openebs/local\"\n- name: StorageType\nvalue: \"hostpath\"\nprovisioner: openebs.io/local\n---\n</code></pre> Local PV\u5b58\u50a8\u7c7b\u89c4\u8303\u6587\u4ef6\u5185\u5bb9-\u4e3b\u673a\u8bbe\u5907<pre><code>---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\nname: localpv-device-sc\nannotations:\nopenebs.io/cas-type: local\ncas.openebs.io/config: |\n- name: StorageType\nvalue: \"device\"\n- name: FSType\nvalue: ext4\nprovisioner: openebs.io/local\n---\n</code></pre> <p><code>cStor</code>\u3001<code>Jiva</code>\u3001<code>Local PV</code>\u7279\u6027\u6bd4\u8f83\uff1a</p> \u7279\u6027 <code>Jiva</code> <code>cStor</code> <code>Local PV</code> \u8f7b\u91cf\u7ea7\u8fd0\u884c\u4e8e\u7528\u6237\u7a7a\u95f4 Yes Yes Yes \u540c\u6b65\u590d\u5236 Yes Yes No \u9002\u5408\u4f4e\u5bb9\u91cf\u5de5\u4f5c\u8d1f\u8f7d Yes Yes Yes \u652f\u6301\u5feb\u7167\uff0c\u514b\u9686 Basic Advanced No \u6570\u636e\u4e00\u81f4\u6027 Yes Yes NA \u4f7f\u7528Velero\u6062\u590d\u5907\u4efd Yes Yes Yes \u9002\u5408\u9ad8\u5bb9\u91cf\u5de5\u4f5c\u8d1f\u8f7d No Yes Yes \u81ea\u52a8\u7cbe\u7b80\u914d\u7f6e Yes No \u78c1\u76d8\u6c60\u6216\u805a\u5408\u652f\u6301 Yes No \u52a8\u6001\u6269\u5bb9 Yes Yes \u6570\u636e\u5f39\u6027(RAID\u652f\u6301) Yes No \u63a5\u8fd1\u539f\u751f\u78c1\u76d8\u6027\u80fd No No Yes <p>\u5927\u591a\u6570\u573a\u666f\u63a8\u8350<code>cStor</code>\uff0c\u56e0\u5176\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u529f\u80fd\uff0c\u5305\u62ec\u5feb\u7167/\u514b\u9686\u3001\u5b58\u50a8\u6c60\u529f\u80fd\uff08\u5982\u7cbe\u7b80\u8d44\u6e90\u8c03\u914d\u3001\u6309\u9700\u6269\u5bb9\u7b49\uff09\u3002</p> <p><code>Jiva</code>\u9002\u7528\u4e8e\u4f4e\u5bb9\u91cf\u9700\u6c42\u7684\u5de5\u4f5c\u8d1f\u8f7d\u573a\u666f\uff0c\u4f8b\u5982<code>5</code>\u5230<code>50G</code>\u3002 \u5c3d\u7ba1\u4f7f\u7528<code>Jiva</code>\u6ca1\u6709\u7a7a\u95f4\u9650\u5236\uff0c\u4f46\u5efa\u8bae\u5c06\u5176\u7528\u4e8e\u4f4e\u5bb9\u91cf\u5de5\u4f5c\u8d1f\u8f7d\u3002 <code>Jiva</code>\u975e\u5e38\u6613\u4e8e\u4f7f\u7528\uff0c\u5e76\u63d0\u4f9b\u4f01\u4e1a\u7ea7\u5bb9\u5668\u672c\u5730\u5b58\u50a8\uff0c\u800c\u4e0d\u9700\u8981\u4e13\u7528\u786c\u76d8\u3002 \u6709\u5feb\u7167\u548c\u514b\u9686\u529f\u80fd\u7684\u9700\u6c42\u7684\u573a\u666f\uff0c\u4f18\u5148\u8003\u8651\u4f7f\u7528<code>cStor</code>\u800c\u4e0d\u662f<code>Jiva</code>\u3002</p>"},{"location":"storage/openEBS/cas/#cas","title":"CAS\u5f15\u64ce\u4f7f\u7528\u573a\u666f","text":"<p>\u5982\u4e0a\u8868\u6240\u793a\uff0c\u6bcf\u4e2a\u5b58\u50a8\u5f15\u64ce\u90fd\u6709\u81ea\u5df1\u7684\u4f18\u52bf\u3002 \u9009\u62e9\u5f15\u64ce\u5b8c\u5168\u53d6\u51b3\u4e8e\u5e94\u7528\u7a0b\u5e8f\u7684\u5de5\u4f5c\u8d1f\u8f7d\u4ee5\u53ca\u5b83\u5f53\u524d\u548c\u672a\u6765\u7684\u5bb9\u91cf\u548c/\u6216\u6027\u80fd\u589e\u957f\u3002 \u4e0b\u9762\u7684\u6307\u5bfc\u539f\u5219\u5728\u5b9a\u4e49\u5b58\u50a8\u7c7b\u65f6\u4e3a\u9009\u62e9\u7279\u5b9a\u7684\u5f15\u64ce\u63d0\u4f9b\u4e00\u4e9b\u5e2e\u52a9\u3002</p> <p>\u9009\u62e9\u5404\u4e2a\u5b58\u50a8\u5f15\u64ce\u7684\u7406\u60f3\u6761\u4ef6\u5982\u4e0b\uff1a</p> cStorJivaLocal PV HostPathLocal PV Device <ul> <li>\u5f53\u9700\u8981\u540c\u6b65\u590d\u5236\u6570\u636e\u5e76\u5728\u8282\u70b9\u4e0a\u6709\u591a\u4e2a\u78c1\u76d8\u65f6</li> <li>\u5f53\u60a8\u4ece\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7684\u672c\u5730\u78c1\u76d8\u6216\u7f51\u7edc\u78c1\u76d8\u6c60\u7ba1\u7406\u591a\u4e2a\u5e94\u7528\u7a0b\u5e8f\u7684\u5b58\u50a8\u65f6\u3002 \u901a\u8fc7\u7cbe\u7b80\u914d\u7f6e\u3001\u5b58\u50a8\u6c60\u548c\u5377\u7684\u6309\u9700\u6269\u5bb9\u3001\u5b58\u50a8\u6c60\u7684\u6027\u80fd\u6309\u9700\u6269\u5bb9\u7b49\u7279\u6027\uff0c\u5b9e\u73b0\u5bf9\u5b58\u50a8\u5c42\u7684\u7ba1\u7406\u3002 <code>cStor</code>\u7528\u4e8e\u5728\u672c\u5730\u8fd0\u884c\u7684Kubernetes\u96c6\u7fa4\u4e0a\u6784\u5efaKubernetes\u672c\u5730\u5b58\u50a8\u670d\u52a1\uff0c\u7c7b\u4f3c\u4e8e<code>AWS EBS</code>\u6216\u8c37\u6b4c<code>PD</code>\u3002</li> <li>\u5f53\u9700\u8981\u5b58\u50a8\u7ea7\u5feb\u7167\u548c\u514b\u9686\u80fd\u529b\u65f6</li> <li>\u5f53\u60a8\u9700\u8981\u4f01\u4e1a\u7ea7\u5b58\u50a8\u4fdd\u62a4\u7279\u6027\uff0c\u5982\u6570\u636e\u4e00\u81f4\u6027\u3001\u5f39\u6027(RAID\u4fdd\u62a4)\u3002</li> <li>\u5982\u679c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u5b58\u50a8\u7ea7\u590d\u5236\uff0c\u90a3\u4e48\u4f7f\u7528OpenEBS\u4e3b\u673a\u8def\u5f84<code>Local PV</code>\u6216OpenEBS\u8bbe\u5907<code>Local PV</code>\u53ef\u80fd\u662f\u66f4\u597d\u7684\u9009\u62e9\u3002</li> </ul> <ul> <li>\u5f53\u60a8\u60f3\u8981\u6570\u636e\u7684\u540c\u6b65\u590d\u5236\uff0c\u5e76\u4e14\u62e5\u6709\u5355\u4e2a\u672c\u5730\u78c1\u76d8\u6216\u5355\u4e2a\u7ba1\u7406\u78c1\u76d8(\u5982\u4e91\u78c1\u76d8(<code>EBS</code>\u3001<code>GPD</code>))\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u5feb\u7167\u6216\u514b\u9686\u7279\u6027\u65f6</li> <li><code>Jiva</code>\u662f\u6700\u5bb9\u6613\u7ba1\u7406\u7684\uff0c\u56e0\u4e3a\u78c1\u76d8\u7ba1\u7406\u6216\u6c60\u7ba1\u7406\u4e0d\u5728\u8fd9\u4e2a\u5f15\u64ce\u7684\u8303\u56f4\u5185\u3002<code>Jiva</code>\u6c60\u662f\u672c\u5730\u78c1\u76d8\u3001\u7f51\u7edc\u78c1\u76d8\u3001\u865a\u62df\u78c1\u76d8\u6216\u4e91\u78c1\u76d8\u7684\u6302\u8f7d\u8def\u5f84\u3002</li> <li>\u4ee5\u4e0b\u573a\u666f<code>Jiva</code>\u66f4\u4f18\u4e8e<code>cStor</code>:<ul> <li>\u5f53\u7a0b\u5e8f\u4e0d\u9700\u8981\u5b58\u50a8\u7ea7\u7684\u5feb\u7167\u3001\u514b\u9686\u7279\u6027</li> <li>\u5f53\u8282\u70b9\u4e0a\u6ca1\u6709\u7a7a\u95f2\u78c1\u76d8\u65f6\u3002<code>Jiva</code>\u53ef\u4ee5\u5728\u4e3b\u673a\u76ee\u5f55\u4e0a\u4f7f\u7528\uff0c\u5e76\u4e14\u4ecd\u7136\u53ef\u4ee5\u5b9e\u73b0\u590d\u5236\u3002</li> <li>\u5f53\u4e0d\u9700\u8981\u52a8\u6001\u6269\u5c55\u672c\u5730\u78c1\u76d8\u4e0a\u7684\u5b58\u50a8\u65f6\u3002\u5c06\u66f4\u591a\u78c1\u76d8\u6dfb\u52a0\u5230<code>Jiva</code>\u6c60\u662f\u4e0d\u53ef\u80fd\u7684\uff0c\u56e0\u6b64<code>Jiva</code>\u6c60\u7684\u5927\u5c0f\u662f\u56fa\u5b9a\u7684\uff0c\u5982\u679c\u5b83\u5728\u7269\u7406\u78c1\u76d8\u4e0a\u3002 \u4f46\u662f\uff0c\u5982\u679c\u5e95\u5c42\u78c1\u76d8\u662f\u865a\u62df\u78c1\u76d8\u3001\u7f51\u7edc\u78c1\u76d8\u6216\u4e91\u78c1\u76d8\uff0c\u5219\u53ef\u4ee5\u52a8\u6001\u5730\u66f4\u6539<code>Jiva</code>\u6c60\u7684\u5927\u5c0f</li> <li>\u5bb9\u91cf\u9700\u6c42\u8f83\u5c0f\u3002\u5927\u5bb9\u91cf\u5e94\u7528\u901a\u5e38\u9700\u8981\u52a8\u6001\u589e\u52a0\u5bb9\u91cf\uff0c<code>cStor</code>\u66f4\u9002\u5408\u8fd9\u79cd\u9700\u6c42</li> </ul> </li> </ul> <ul> <li>\u5f53\u5e94\u7528\u7a0b\u5e8f\u672c\u8eab\u5177\u5907\u7ba1\u7406\u590d\u5236\u80fd\u529b\uff08\u4f8b\u5982\uff1aes\uff09\u65f6\uff0c\u4e0d\u9700\u8981\u5728\u5b58\u50a8\u5c42\u8fdb\u884c\u590d\u5236\u3002\u5728\u5927\u591a\u6570\u8fd9\u6837\u7684\u60c5\u51b5\u4e0b\uff0c\u5e94\u7528\u7a0b\u5e8f\u662f\u4f5c\u4e3astatefulset\u90e8\u7f72\u7684</li> <li>\u9ad8\u4e8e<code>Jiva</code>\u4e0e<code>cStor</code>\u7684\u8bfb\u5199\u6027\u80fd\u9700\u6c42</li> <li>\u5f53\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u6ca1\u6709\u4e13\u7528\u7684\u672c\u5730\u78c1\u76d8\u6216\u7279\u5b9a\u5e94\u7528\u7a0b\u5e8f\u4e0d\u9700\u8981\u4e13\u7528\u7684\u5b58\u50a8\u65f6\uff0c\u5efa\u8bae\u4f7f\u7528<code>HostPath</code>\u3002 \u5982\u679c\u60a8\u60f3\u8de8\u591a\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5171\u4eab\u4e00\u4e2a\u672c\u5730\u78c1\u76d8\uff0c\u4e3b\u673a\u8def\u5f84<code>Local PV</code>\u662f\u6b63\u786e\u7684\u65b9\u6cd5</li> </ul> <ul> <li>\u5f53\u5e94\u7528\u7a0b\u5e8f\u7ba1\u7406\u590d\u5236\u672c\u8eab\uff0c\u4e0d\u9700\u8981\u5728\u5b58\u50a8\u5c42\u8fdb\u884c\u590d\u5236\u65f6\u3002\u5728\u5927\u591a\u6570\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5e94\u7528\u7a0b\u5e8f\u88ab\u90e8\u7f72\u4e3a\u6709\u72b6\u6001\u96c6</li> <li>\u9ad8\u4e8e<code>Jiva</code>\u4e0e<code>cStor</code>\u7684\u8bfb\u5199\u6027\u80fd\u9700\u6c42</li> <li>\u9ad8\u4e8eOpenEBS\u4e3b\u673a\u8def\u5f84<code>Local PV</code>\u7684\u8bfb\u5199\u6027\u80fd\u9700\u6c42</li> <li>\u5f53\u9700\u8981\u63a5\u8fd1\u78c1\u76d8\u6027\u80fd\u65f6\u3002\u8be5\u5377\u4e13\u7528\u4e8e\u5199\u5165\u5355\u4e2a<code>SSD</code>\u6216<code>NVMe</code>\u63a5\u53e3\u4ee5\u83b7\u5f97\u6700\u9ad8\u6027\u80fd</li> </ul>"},{"location":"storage/openEBS/cas/#_4","title":"\u603b\u7ed3","text":"<ul> <li>\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u5904\u4e8e\u751f\u4ea7\u4e2d\uff0c\u5e76\u4e14\u4e0d\u9700\u8981\u5b58\u50a8\u7ea7\u590d\u5236\uff0c\u90a3\u4e48\u9996\u9009<code>Local PV</code></li> <li>\u5982\u679c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u5904\u4e8e\u751f\u4ea7\u72b6\u6001\uff0c\u5e76\u4e14\u9700\u8981\u5b58\u50a8\u7ea7\u590d\u5236\uff0c\u90a3\u4e48\u9996\u9009<code>cStor</code></li> <li>\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u8f83\u5c0f\uff0c\u9700\u8981\u5b58\u50a8\u7ea7\u590d\u5236\uff0c\u4f46\u4e0d\u9700\u8981\u5feb\u7167\u6216\u514b\u9686\uff0c\u5219\u9996\u9009<code>Jiva</code></li> </ul>"},{"location":"storage/openEBS/control-plane/","title":"\u63a7\u5236\u5e73\u9762","text":""},{"location":"storage/openEBS/control-plane/#_1","title":"\u7ec4\u4ef6\u6982\u8ff0","text":"<p>OpenEBS \u96c6\u7fa4\u7684\u63a7\u5236\u5e73\u9762\u901a\u5e38\u88ab\u79f0\u4e3a Maya\uff0c\u63a7\u5236\u5e73\u9762\u8d1f\u8d23\u4f9b\u5e94\u5377\u3001\u76f8\u5173\u7684\u5377\u64cd\u4f5c\uff0c\u5982\u5feb\u7167\u3001\u5236\u4f5c\u514b\u9686\u3001\u521b\u5efa\u5b58\u50a8\u7b56\u7565\u3001\u6267\u884c\u5b58\u50a8\u7b56\u7565\u3001\u5bfc\u51fa\u5377\u6307\u6807\u4f9b Prometheus/grafana \u6d88\u8d39\u7b49\u3002</p> <p>OpenEBS \u63a7\u5236\u5e73\u9762 Maya \u5b9e\u73b0\u4e86\u521b\u5efa\u8d85\u878d\u5408\u7684 OpenEBS\uff0c\u5e76\u5c06\u5176\u6302\u8f7d\u5230\u5982 Kubernetes \u8c03\u5ea6\u5f15\u64ce\u4e0a\uff0c\u7528\u6765\u6269\u5c55\u7279\u5b9a\u7684\u5bb9\u5668\u7f16\u6392\u7cfb\u7edf\u63d0\u4f9b\u7684\u5b58\u50a8\u529f\u80fd\uff1bOpenEBS \u7684\u63a7\u5236\u5e73\u9762\u4e5f\u662f\u57fa\u4e8e\u5fae\u670d\u52a1\u7684\uff0c\u901a\u8fc7\u4e0d\u540c\u7684\u7ec4\u4ef6\u5b9e\u73b0\u5b58\u50a8\u7ba1\u7406\u529f\u80fd\u3001\u76d1\u63a7\u3001\u5bb9\u5668\u7f16\u6392\u63d2\u4ef6\u7b49\u529f\u80fd\u3002</p> <p></p> <p>OpenEBS \u63d0\u4f9b\u4e86\u4e00\u4e2a\u52a8\u6001\u4f9b\u5e94\u5668\uff0c\u5b83\u662f\u6807\u51c6\u7684 Kubernetes \u5916\u90e8\u5b58\u50a8\u63d2\u4ef6\u3002OpenEBS PV \u4f9b\u5e94\u5668\u7684\u4e3b\u8981\u4efb\u52a1\u662f\u5411\u5e94\u7528 Pod \u53d1\u8d77\u5377\u4f9b\u5e94\uff0c\u5e76\u5b9e\u73b0Kubernetes \u7684 PV \u89c4\u8303\u3002</p> <p><code>maya-apiserver</code> \u66b4\u9732\u4e86\u5b58\u50a8 REST API\uff0c\u5e76\u627f\u62c5\u4e86\u5927\u90e8\u5206\u7684\u5377\u7b56\u7565\u5904\u7406\u548c\u7ba1\u7406\u3002</p> <p>\u63a7\u5236\u5e73\u9762\u548c\u6570\u636e\u5e73\u9762\u4e4b\u95f4\u7684\u8fde\u63a5\u91c7\u7528 Kubernetes sidecar \u6a21\u5f0f\u3002\u6709\u5982\u4e0b\u51e0\u4e2a\u573a\u666f\uff0c\u63a7\u5236\u5e73\u9762\u9700\u8981\u4e0e\u6570\u636e\u5e73\u9762\u8fdb\u884c\u901a\u4fe1\u3002</p> <ul> <li>\u5bf9\u4e8e IOPS\u3001\u541e\u5410\u91cf\u3001\u5ef6\u8fdf\u7b49\u5377\u7edf\u8ba1 - \u901a\u8fc7 <code>volume-exporter</code> sidecar\u5b9e\u73b0</li> <li>\u7528\u4e8e\u901a\u8fc7\u5377\u63a7\u5236\u5668 Pod \u6267\u884c\u5377\u7b56\u7565\uff0c\u4ee5\u53ca\u901a\u8fc7\u5377\u590d\u5236 Pod \u8fdb\u884c\u78c1\u76d8/\u6c60\u7ba1\u7406 - \u901a\u8fc7\u5377\u7ba1\u7406 sidecar \u5b9e\u73b0\u3002</li> </ul> <p>\u4e0b\u9762\u5bf9\u4e0a\u8ff0\u63a7\u5236\u5e73\u9762\u7684\u7ec4\u6210\u8fdb\u884c\u8be6\u7ec6\u8bf4\u660e\u3002</p>"},{"location":"storage/openEBS/control-plane/#openebs-pv-provisioner","title":"OpenEBS PV Provisioner","text":"<p>\u8be5\u7ec4\u4ef6\u4f5c\u4e3a\u4e00\u4e2a Pod \u8fd0\u884c\uff0c\u5e76\u505a\u51fa\u4f9b\u5e94\u51b3\u7b56\u3002\u5b83\u7684\u4f7f\u7528\u65b9\u5f0f\u662f\u5f00\u53d1\u8005\u7528\u6240\u9700\u7684\u5377\u53c2\u6570\u6784\u5efa\u4e00\u4e2a\u8bf7\u6c42\uff0c\u9009\u62e9\u5408\u9002\u7684\u5b58\u50a8\u7c7b\uff0c\u5e76\u5728 YAML \u89c4\u8303\u4e0a\u8c03\u7528 kubelet\u3002OpenEBS PV \u52a8\u6001\u4f9b\u5e94\u5668\u4e0e<code>maya-apiserver</code> \u4ea4\u4e92\uff0c\u5728\u9002\u5f53\u7684\u8282\u70b9\u4e0a\u4e3a\u5377\u63a7\u5236\u5668 Pod \u548c\u5377\u590d\u5236 Pod \u521b\u5efa\u90e8\u7f72\u89c4\u8303\u3002\u53ef\u4ee5\u4f7f\u7528 PVC \u89c4\u8303\u4e2d\u7684\u6ce8\u89e3\u6765\u63a7\u5236\u5bb9\u91cf Pod\uff08\u63a7\u5236\u5668/\u526f\u672c\uff09\u7684\u8c03\u5ea6\u3002</p> <p>\u76ee\u524d\uff0cOpenEBS \u4f9b\u5e94\u5668\u53ea\u652f\u6301\u4e00\u79cd\u7c7b\u578b\u7684\u7ed1\u5b9a\uff0c\u5373 <code>iSCSI</code>\u3002</p>"},{"location":"storage/openEBS/control-plane/#maya-apiserver","title":"Maya-ApiServer","text":"<p><code>maya-apiserver</code> \u4f5c\u4e3a\u4e00\u4e2a Pod \u8fd0\u884c\uff0c\u4e3b\u8981\u662f\u7528\u6765\u66b4\u9732 OpenEBS REST APIs\u3002</p> <p><code>maya-apiserver</code> \u8fd8\u8d1f\u8d23\u521b\u5efa\u521b\u5efa\u5377 Pod \u6240\u9700\u7684\u90e8\u7f72\u89c4\u8303\u6587\u4ef6\uff0c\u5728\u751f\u6210\u8fd9\u4e9b\u89c4\u8303\u6587\u4ef6\u540e\uff0c\u5b83\u8c03\u7528 kube-apiserver \u6765\u76f8\u5e94\u5730\u8c03\u5ea6Pods\u3002\u5728 OpenEBS PV \u4f9b\u5e94\u5668\u7684\u5377\u4f9b\u5e94\u7ed3\u675f\u65f6\uff0c\u4f1a\u521b\u5efa\u4e00\u4e2aKubernetes \u5bf9\u8c61 PV\uff0c\u5e76\u6302\u8f7d\u5728\u5e94\u7528 Pod \u4e0a\uff0cPV\u7531\u63a7\u5236\u5668 Pod \u6258\u7ba1\uff0c\u63a7\u5236\u5668 Pod \u7531\u4e00\u7ec4\u4f4d\u4e8e\u4e0d\u540c\u8282\u70b9\u7684\u526f\u672c Pod \u652f\u6301\uff0c\u63a7\u5236\u5668 Pod\u548c\u526f\u672c Pod \u662f\u6570\u636e\u5e73\u9762\u7684\u4e00\u90e8\u5206\uff0c\u3002</p> <p><code>maya-apiserver</code> \u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u4efb\u52a1\u662f\u5377\u7b56\u7565\u7ba1\u7406\u3002OpenEBS \u63d0\u4f9b\u4e86\u975e\u5e38\u7ec6\u5316\u7684\u89c4\u8303\u6765\u8868\u8fbe\u7b56\u7565\uff0cm-apiserver \u89e3\u91ca\u8fd9\u4e9b YAML \u89c4\u8303\uff0c\u5c06\u5176\u8f6c\u6362\u4e3a\u53ef\u6267\u884c\u7684\u7ec4\u4ef6\uff0c\u5e76\u901a\u8fc7\u5377\u7ba1\u7406 sidecar \u6765\u6267\u884c\u3002</p>"},{"location":"storage/openEBS/control-plane/#maya-volume-exporter","title":"Maya Volume Exporter","text":"<p><code>Maya Volume Exporter</code> \u662f\u6bcf\u4e2a\u5b58\u50a8\u63a7\u5236\u5668 Pod\uff08cStor/Jiva\uff09\u7684 sidecar\u3002\u8fd9\u4e9b sidecars \u5c06\u63a7\u5236\u5e73\u9762\u4e0e\u6570\u636e\u5e73\u9762\u8fde\u63a5\u8d77\u6765\uff0c\u4ee5\u83b7\u53d6\u7edf\u8ba1\u6570\u636e\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>volume \u8bfb/\u5199\u5ef6\u8fdf</li> <li>\u8bfb/\u5199 IOPS</li> <li>\u8bfb/\u5199\u5757\u5927\u5c0f</li> <li>\u5bb9\u91cf\u7edf\u8ba1</li> <li><code>OpenEBS volume exporter</code> \u6570\u636e\u6d41</li> </ul>"},{"location":"storage/openEBS/control-plane/#volume-sidecars","title":"Volume \u7ba1\u7406 Sidecars","text":"<p>Sidecars \u8fd8\u7528\u4e8e\u5c06\u63a7\u5236\u5668\u914d\u7f6e\u53c2\u6570\u548c\u5377\u7b56\u7565\u4f20\u9012\u7ed9\u4f5c\u4e3a\u6570\u636e\u5e73\u9762\u7684\u5377\u63a7\u5236\u5668 Pod\uff0c\u4ee5\u53ca\u5c06\u526f\u672c\u914d\u7f6e\u53c2\u6570\u548c\u526f\u672c\u6570\u636e\u4fdd\u62a4\u53c2\u6570\u4f20\u9012\u7ed9\u5377\u526f\u672c Pod\u3002</p> <p></p>"},{"location":"storage/openEBS/data-plane/","title":"\u6570\u636e\u5e73\u9762","text":"<p>OpenEBS \u6301\u4e45\u5316\u5b58\u50a8\u5377\u901a\u8fc7 Kubernetes \u7684 PV \u6765\u521b\u5efa\uff0c\u4f7f\u7528 iSCSI \u6765\u5b9e\u73b0\uff0c\u6570\u636e\u4fdd\u5b58\u5728\u8282\u70b9\u4e0a\u6216\u8005\u4e91\u5b58\u50a8\u4e2d\u3002OpenEBS \u7684\u5377\u5b8c\u5168\u72ec\u7acb\u4e8e\u7528\u6237\u7684\u5e94\u7528\u7684\u751f\u547d\u5468\u671f\u6765\u7ba1\u7406\uff0c\u548c Kuberentes \u4e2d PV \u7684\u601d\u8def\u4e00\u81f4\u3002OpenEBS \u5377\u4e3a\u5bb9\u5668\u63d0\u4f9b\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u5177\u6709\u9488\u5bf9\u7cfb\u7edf\u6545\u969c\u7684\u5f39\u6027\uff0c\u66f4\u5feb\u5730\u8bbf\u95ee\u5b58\u50a8\uff0c\u5feb\u7167\u548c\u5907\u4efd\u529f\u80fd\u3002\u540c\u65f6\u8fd8\u63d0\u4f9b\u4e86\u76d1\u63a7\u4f7f\u7528\u60c5\u51b5\u548c\u6267\u884c QoS \u7b56\u7565\u7684\u673a\u5236\u3002</p> <p>\u76ee\u524d\uff0cOpenEBS \u63d0\u4f9b\u4e86\u4e24\u4e2a\u53ef\u4ee5\u8f7b\u677e\u63d2\u5165\u7684\u5b58\u50a8\u5f15\u64ce\u3002\u8fd9\u4e24\u4e2a\u5f15\u64ce\u5206\u522b\u53eb\u505a <code>Jiva</code> \u548c <code>cStor</code>\u3002\u8fd9\u4e24\u4e2a\u5b58\u50a8\u5f15\u64ce\u90fd\u5b8c\u5168\u8fd0\u884c\u5728Linux \u7528\u6237\u7a7a\u95f4\u4e2d\uff0c\u5e76\u4e14\u57fa\u4e8e\u5fae\u670d\u52a1\u67b6\u6784\u3002</p>"},{"location":"storage/openEBS/data-plane/#jiva","title":"Jiva","text":"<p><code>Jiva</code> \u5b58\u50a8\u5f15\u64ce\u662f\u57fa\u4e8e Rancher \u7684 LongHorn \u548c gotgt \u5f00\u53d1\u7684,\u91c7\u7528 GO \u8bed\u8a00\u7f16\u5199\uff0c\u8fd0\u884c\u5728\u7528\u6237\u7a7a\u95f4\u3002LongHorn \u63a7\u5236\u5668\u5c06\u4f20\u5165\u7684 IO \u540c\u6b65\u590d\u5236\u5230 LongHorn \u590d\u5236\u5668\u4e0a\u3002\u590d\u5236\u5668\u8003\u8651\u4ee5 Linux \u7a00\u758f\u6587\u4ef6\u4e3a\u57fa\u7840\uff0c\u8fdb\u884c\u52a8\u6001\u4f9b\u5e94\u3001\u5feb\u7167\u3001\u91cd\u5efa\u7b49\u5b58\u50a8\u529f\u80fd\u3002</p>"},{"location":"storage/openEBS/data-plane/#cstor","title":"Cstor","text":"<p><code>cStor</code> \u6570\u636e\u5f15\u64ce\u662f\u7528C\u8bed\u8a00\u7f16\u5199\u7684\uff0c\u5177\u6709\u9ad8\u6027\u80fd\u7684 iSCSI \u76ee\u6807\u548c<code>Copy-On-Write</code> \u5757\u7cfb\u7edf\uff0c\u53ef\u63d0\u4f9b\u6570\u636e\u5b8c\u6574\u6027\u3001\u6570\u636e\u5f39\u6027\u548c\u65f6\u95f4\u70b9\u5feb\u7167\u548c\u514b\u9686\u3002<code>cStor</code> \u5177\u6709\u6c60\u529f\u80fd\uff0c\u53ef\u5c06\u8282\u70b9\u4e0a\u7684\u78c1\u76d8\u4ee5\u955c\u50cf\u5f0f\u6216 RAIDZ \u6a21\u5f0f\u805a\u5408\uff0c\u4ee5\u63d0\u4f9b\u66f4\u5927\u7684\u5bb9\u91cf\u548c\u6027\u80fd\u5355\u4f4d\u3002</p>"},{"location":"storage/openEBS/data-plane/#local-pv","title":"Local PV","text":"<p>\u5bf9\u4e8e\u90a3\u4e9b\u4e0d\u9700\u8981\u5b58\u50a8\u7ea7\u590d\u5236\u7684\u5e94\u7528\uff0cLocal PV \u53ef\u80fd\u662f\u4e0d\u9519\u7684\u9009\u62e9\uff0c\u56e0\u4e3a\u5b83\u80fd\u63d0\u4f9b\u66f4\u9ad8\u7684\u6027\u80fd\u3002OpenEBS LocalPV \u4e0e Kubernetes LocalPV \u7c7b\u4f3c\uff0c\u53ea\u4e0d\u8fc7\u5b83\u662f\u7531 OpenEBS \u63a7\u5236\u5e73\u9762\u52a8\u6001\u8c03\u914d\u7684\uff0c\u5c31\u50cf\u5176\u4ed6\u5e38\u89c4 PV \u4e00\u6837\u3002OpenEBS LocalPV \u6709\u4e24\u79cd\u7c7b\u578b--\u4e3b\u673a\u8def\u5f84 LocalPV \u6216\u8bbe\u5907 LocalPV\uff0c\u4e3b\u673a\u8def\u5f84 LocalPV \u6307\u7684\u662f\u4e3b\u673a\u4e0a\u7684\u4e00\u4e2a\u5b50\u76ee\u5f55\uff0c\u8bbe\u5907 LocalPV \u6307\u7684\u662f\u8282\u70b9\u4e0a\u7684\u4e00\u4e2a\u88ab\u53d1\u73b0\u7684\u78c1\u76d8\uff08\u76f4\u63a5\u8fde\u63a5\u6216\u7f51\u7edc\u8fde\u63a5\uff09\u3002OpenEBS \u5f15\u5165\u4e86\u4e00\u4e2aLocalPV \u4f9b\u5e94\u5668\uff0c\u7528\u4e8e\u6839\u636e PVC \u548c\u5b58\u50a8\u7c7b\u89c4\u8303\u4e2d\u7684\u4e00\u4e9b\u6807\u51c6\u9009\u62e9\u5339\u914d\u7684\u78c1\u76d8\u6216\u4e3b\u673a\u8def\u5f84\u3002</p>"},{"location":"storage/openEBS/installation/","title":"\u90e8\u7f72\u5b89\u88c5","text":""},{"location":"storage/openEBS/installation/#_1","title":"\u5b89\u88c5","text":"<p>\u7531\u4e8e OpenEBS \u901a\u8fc7 iSCSI \u534f\u8bae\u63d0\u4f9b\u5b58\u50a8\u652f\u6301\uff0c\u56e0\u6b64\uff0c\u9700\u8981\u5728\u6240\u6709 Kubernetes \u8282\u70b9\u4e0a\u90fd\u5b89\u88c5 iSCSI \u5ba2\u6237\u7aef\uff08\u542f\u52a8\u5668\uff09\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f CentOS \u7684\u7cfb\u7edf\uff0c\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5b89\u88c5\u542f\u52a8 iSCSI \u542f\u52a8\u5668\uff1a</p> <pre><code># \u5b89\u88c5 iscsi\n$ yum install iscsi-initiator-utils -y\n\n# \u67e5\u770b InitiatorName \u662f\u5426\u6b63\u5e38\u914d\u7f6e\n$ cat /etc/iscsi/initiatorname.iscsi\n\n# \u542f\u52a8\u67e5\u770b\u72b6\u6001\n$ systemctl enable --now iscsid\n$ systemctl start iscsid.service\n$ systemctl status iscsid.service\n</code></pre> <p>iSCSI \u5ba2\u6237\u7aef\u542f\u52a8\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u5b89\u88c5 OpenEBS \u4e86\u3002</p> <p></p> <p>\u76f4\u63a5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u5b89\u88c5 OpenEBS \u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f https://openebs.github.io/charts/openebs-operator.yaml\n</code></pre> <p>\u8be5\u547d\u4ee4\u4f1a\u5c06\u5e94\u7528\u5b89\u88c5\u5230\u540d\u4e3a openebs \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\uff0c\u5b89\u88c5\u6210\u529f\u540e\u6b63\u5e38\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684 Pod\uff1a</p> <pre><code>$ kubectl get pods -n openebs                               NAME                                           READY   STATUS    RESTARTS   AGE\nmaya-apiserver-5db4c7f9bc-fv9sc                1/1     Running   0          19h\nopenebs-admission-server-6c64d9ff64-sklvp      1/1     Running   0          19h\nopenebs-localpv-provisioner-784d8f9b56-9mphk   1/1     Running   1          19h\nopenebs-ndm-fdlpx                              1/1     Running   0          19h\nopenebs-ndm-jfxbj                              1/1     Running   0          19h\nopenebs-ndm-operator-6d5978d6fb-swp65          1/1     Running   0          19h\nopenebs-provisioner-7b99c87dbf-zpxqn           1/1     Running   1          19h\nopenebs-snapshot-operator-69b9f8cd8b-r6hrn     2/2     Running   1          19h\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b OpenEBS \u8fd8\u4f1a\u5b89\u88c5\u4e00\u4e9b\u5185\u7f6e\u7684 StorageClass \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get sc\nNAME                        PROVISIONER                                                RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE\nopenebs-device              openebs.io/local                                           Delete          WaitForFirstConsumer   false                  19h\nopenebs-hostpath            openebs.io/local                                           Delete          WaitForFirstConsumer   false                  19h\nopenebs-jiva-default        openebs.io/provisioner-iscsi                               Delete          Immediate              false                  19h\nopenebs-snapshot-promoter   volumesnapshot.external-storage.k8s.io/snapshot-promoter   Delete          Immediate              false                  19h\n</code></pre>"},{"location":"storage/openEBS/installation/#_2","title":"\u6d4b\u8bd5","text":"<p>\u63a5\u4e0b\u6765\u6211\u4eec\u521b\u5efa\u4e00\u4e2a PVC \u8d44\u6e90\u5bf9\u8c61\uff0cPods \u4f7f\u7528\u8fd9\u4e2a PVC \u5c31\u53ef\u4ee5\u4ece OpenEBS \u52a8\u6001 Local PV Provisioner \u4e2d\u8bf7\u6c42 Hostpath Local PV \u4e86\u3002</p> <p>\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u81ea\u5e26\u7684 <code>openebs-hostpath</code> \u8fd9\u4e2a StorageClass \u6765\u521b\u5efa PVC\uff1a</p> local-hostpath-pvc.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: local-hostpath-pvc\nspec:\nstorageClassName: openebs-hostpath\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 5Gi\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a PVC \u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f local-hostpath-pvc.yaml\n$ kubectl get pvc local-hostpath-pvc\nNAME                 STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS       AGE\nlocal-hostpath-pvc   Pending                                      openebs-hostpath   12s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a PVC \u7684\u72b6\u6001\u662f <code>Pending</code>\uff0c\u8fd9\u662f\u56e0\u4e3a\u5bf9\u5e94\u7684 StorageClass \u662f\u5ef6\u8fdf\u7ed1\u5b9a\u6a21\u5f0f\uff0c\u6240\u4ee5\u9700\u8981\u7b49\u5230 Pod \u6d88\u8d39\u8fd9\u4e2a PVC \u540e\u624d\u4f1a\u53bb\u7ed1\u5b9a\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53bb\u521b\u5efa\u4e00\u4e2a Pod \u6765\u4f7f\u7528\u8fd9\u4e2a PVC\u3002</p> <p>\u58f0\u660e\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 Pod \u8d44\u6e90\u6e05\u5355\uff1a</p> local-hostpath-pod.yaml<pre><code>apiVersion: v1\nkind: Pod\nmetadata:\nname: hello-local-hostpath-pod\nspec:\nvolumes:\n- name: local-storage\npersistentVolumeClaim:\nclaimName: local-hostpath-pvc\ncontainers:\n- name: hello-container\nimage: busybox\ncommand:\n- sh\n- -c\n- 'while true; do echo \"`date` [`hostname`] Hello from OpenEBS Local PV.\" &gt;&gt; /mnt/store/greet.txt; sleep $(($RANDOM % 5 + 300)); done'\nvolumeMounts:\n- mountPath: /mnt/store\nname: local-storage\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f local-hostpath-pod.yaml\n$ kubectl get pods hello-local-hostpath-pod          NAME                       READY   STATUS    RESTARTS   AGE\nhello-local-hostpath-pod   1/1     Running   0          2m7s\n$ kubectl get pvc local-hostpath-pvc           NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS       AGE\nlocal-hostpath-pvc   Bound    pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88   5Gi        RWO            openebs-hostpath   5m41s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Pod \u8fd0\u884c\u6210\u529f\u540e\uff0cPVC \u4e5f\u7ed1\u5b9a\u4e0a\u4e86\u4e00\u4e2a\u81ea\u52a8\u751f\u6210\u7684 PV\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u8fd9\u4e2a PV \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pv pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88 -o yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  annotations:\n    pv.kubernetes.io/provisioned-by: openebs.io/local\n  creationTimestamp: \"2021-01-07T02:48:14Z\"\nfinalizers:\n  - kubernetes.io/pv-protection\n  labels:\n    openebs.io/cas-type: local-hostpath\n  ......\n  name: pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88\n  resourceVersion: \"21193802\"\nselfLink: /api/v1/persistentvolumes/pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88\n  uid: f7cccdb3-d23a-4831-86c3-4363eb1a8dee\nspec:\n  accessModes:\n  - ReadWriteOnce\n  capacity:\n    storage: 5Gi\n  claimRef:\n    apiVersion: v1\n    kind: PersistentVolumeClaim\n    name: local-hostpath-pvc\n    namespace: default\n    resourceVersion: \"21193645\"\nuid: 3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88\n  local:\n    fsType: \"\"\npath: /var/openebs/local/pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - node2\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: openebs-hostpath\n  volumeMode: Filesystem\nstatus:\n  phase: Bound\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u81ea\u52a8\u751f\u6210\u7684 PV \u548c\u6211\u4eec\u524d\u9762\u81ea\u5df1\u624b\u52a8\u521b\u5efa\u7684 Local PV \u57fa\u672c\u4e0a\u662f\u4e00\u81f4\u7684\uff0c\u548c node2 \u8282\u70b9\u662f\u4eb2\u548c\u5173\u7cfb\uff0c\u672c\u5730\u6570\u636e\u76ee\u5f55\u4f4d\u4e8e <code>/var/openebs/local/pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88</code> \u4e0b\u9762\u3002</p> <p>\u63a5\u7740\u6211\u4eec\u6765\u9a8c\u8bc1\u4e0b volume \u6570\u636e\uff0c\u524d\u5f80 <code>node2</code> \u8282\u70b9\u67e5\u770b\u4e0b\u4e0a\u9762\u7684\u6570\u636e\u76ee\u5f55\u4e2d\u7684\u6570\u636e\uff1a</p> <pre><code>[root@node2 ~]# ls /var/openebs/local/pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88\ngreet.txt\n[root@node2 ~]# cat /var/openebs/local/pvc-3f4a1a65-6cbc-42bf-a1f8-87ad238c0b88/greet.txt\nThu Jan  7 10:48:49 CST 2021 [hello-local-hostpath-pod] Hello from OpenEBS Local PV.\nThu Jan  7 10:53:50 CST 2021 [hello-local-hostpath-pod] Hello from OpenEBS Local PV.\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Pod \u5bb9\u5668\u4e2d\u7684\u6570\u636e\u5df2\u7ecf\u6301\u4e45\u5316\u5230 Local PV \u5bf9\u5e94\u7684\u76ee\u5f55\u4e2d\u53bb\u4e86\u3002\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f StorageClass \u9ed8\u8ba4\u7684\u6570\u636e\u56de\u6536\u7b56\u7565\u662f Delete\uff0c\u6240\u4ee5\u5982\u679c\u5c06 PVC \u5220\u6389\u540e\u6570\u636e\u4f1a\u81ea\u52a8\u5220\u9664\uff0c\u6211\u4eec\u53ef\u4ee5 Velero \u8fd9\u6837\u7684\u5de5\u5177\u6765\u8fdb\u884c\u5907\u4efd\u8fd8\u539f\u3002</p>"},{"location":"storage/openEBS/node-disk-manager/","title":"\u8282\u70b9\u78c1\u76d8\u7ba1\u7406\u5668","text":"<p><code>Node Disk Manager</code> (<code>NDM</code>)\u586b\u8865\u4e86\u4f7f\u7528 Kubernetes \u7ba1\u7406\u6709\u72b6\u6001\u5e94\u7528\u7684\u6301\u4e45\u6027\u5b58\u50a8\u6240\u9700\u7684\u5de5\u5177\u94fe\u4e2d\u7684\u7a7a\u767d\u3002\u5bb9\u5668\u65f6\u4ee3\u7684 DevOps \u67b6\u6784\u5e08\u5fc5\u987b\u4ee5\u81ea\u52a8\u5316\u7684\u65b9\u5f0f\u670d\u52a1\u4e8e\u5e94\u7528\u548c\u5e94\u7528\u5f00\u53d1\u8005\u7684\u57fa\u7840\u8bbe\u65bd\u9700\u6c42\uff0c\u4ee5\u63d0\u4f9b\u8de8\u73af\u5883\u7684\u5f39\u6027\u548c\u4e00\u81f4\u6027\u3002\u8fd9\u4e9b\u8981\u6c42\u610f\u5473\u7740\u5b58\u50a8\u6808\u672c\u8eab\u5fc5\u987b\u975e\u5e38\u7075\u6d3b\uff0c\u4ee5\u4fbf Kubernetes \u548c\u4e91\u539f\u751f\u751f\u6001\u7cfb\u7edf\u4e2d\u7684\u5176\u4ed6\u8f6f\u4ef6\u53ef\u4ee5\u8f7b\u677e\u4f7f\u7528\u8fd9\u4e2a\u6808\u3002NDM \u5728 Kubernetes \u7684\u5b58\u50a8\u6808\u4e2d\u8d77\u5230\u4e86\u57fa\u7840\u6027\u7684\u4f5c\u7528\uff0c\u5b83\u5c06\u4e0d\u540c\u7684\u78c1\u76d8\u7edf\u4e00\u8d77\u6765\uff0c\u5e76\u901a\u8fc7\u5c06\u5b83\u4eec\u8bc6\u522b\u4e3a Kubernetes \u5bf9\u8c61\u6765\u63d0\u4f9b\u90e8\u5206\u6c60\u5316\u7684\u80fd\u529b\u3002\u540c\u65f6\uff0c NDM \u8fd8\u53ef\u4ee5\u53d1\u73b0\u3001\u4f9b\u5e94\u3001\u76d1\u63a7\u548c\u7ba1\u7406\u5e95\u5c42\u78c1\u76d8\uff0c\u8fd9\u6837Kubernetes PV \u4f9b\u5e94\u5668\uff08\u5982 OpenEBS \u548c\u5176\u4ed6\u5b58\u50a8\u7cfb\u7edf\u548cPrometheus\uff09\u53ef\u4ee5\u7ba1\u7406\u78c1\u76d8\u5b50\u7cfb\u7edf\u3002</p> <p></p>"},{"location":"storage/openEBS/node-disk-manager/#filter","title":"\u5185\u7f6e filter","text":"<p>\u7528\u6237\u53ef\u4ee5\u4ec5\u5305\u542b\u9009\u5b9a\u7684\u5757\u8bbe\u5907\u6765\u521b\u5efa\u5757\u8bbe\u5907 CR\uff0c\u7136\u540e\u4ec5\u4f7f\u7528\u521b\u5efa\u7684\u5757\u8bbe\u5907 CR \u6765\u521b\u5efa cStor \u6c60\u6216\u7528\u4e8e\u57fa\u4e8e\u8bbe\u5907\u914d\u7f6e\u672c\u5730 PV\u3002 \u4e3a\u4e86\u5305\u542b\u9009\u5b9a\u7684\u5757\u8bbe\u5907\uff0c\u8bf7\u5728 NDM \u914d\u7f6e\u90e8\u5206\u4e0b\u4f7f\u7528\u6240\u9700\u7684\u5757\u8bbe\u5907\u66f4\u65b0\u64cd\u4f5c\u5458 YAML \u6587\u4ef6\uff0c\u4ee5\u4fbf\u4ec5\u4f7f\u7528\u8fd9\u4e9b\u5757\u8bbe\u5907\u6765\u521b\u5efa\u5757\u8bbe\u5907 CR\u3002 \u5728\u4ee5\u4e0b\u914d\u7f6e\u4e2d\u6dfb\u52a0\u5757\u8bbe\u5907\u8def\u5f84\u4ee5\u6307\u5b9a\u7279\u5b9a\u78c1\u76d8\u3002 \u6b64\u914d\u7f6e\u5fc5\u987b\u6dfb\u52a0\u5230 <code>openebs-operator.yaml</code> \u4e2d <code>Configmap</code> \u4e0b\u7684 <code>openebs-ndm-config</code> \u4e2d\u3002</p> <p>\u6b64\u66f4\u6539\u5fc5\u987b\u5728 OpenEBS \u5b89\u88c5\u4e4b\u524d\u4e0b\u8f7d\u7684 <code>openebs-operator.yaml</code> \u6587\u4ef6\u4e2d\u5b8c\u6210\u3002 \u5982\u679c\u5728 OpenEBS \u5b89\u88c5\u540e\u6267\u884c\u66f4\u6539\uff0c\u5219\u7528\u6237\u5fc5\u987b\u91cd\u65b0\u542f\u52a8\u76f8\u5e94\u7684 NDM DaemonSet Pod \u624d\u80fd\u66f4\u65b0 NDM \u914d\u7f6e\u3002</p> <pre><code>filterconfigs:\n- key: path-filter\nname: path filter\nstate: true\ninclude: \"/dev/sda\"\nexclude: \"\"\n</code></pre> <p>\u4f7f\u7528\u4e0a\u8ff0\u914d\u7f6e\u65f6\uff0c\u4ec5\u4f7f\u7528\u5757\u8bbe\u5907<code>/dev/sda</code>\u6765\u521b\u5efa\u5757\u8bbe\u5907\u81ea\u5b9a\u4e49\u8d44\u6e90\u3002 \u6240\u6709\u5176\u4ed6\u78c1\u76d8\u5c06\u88ab\u6392\u9664\u3002</p> <p>\u6ce8\u610f</p> <p>NDM Configmap \u4e2d\u7684\u8fc7\u6ee4\u5668\u914d\u7f6e\u4e0d\u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5e76\u4e14 Configmap \u9002\u7528\u4e8e\u96c6\u7fa4\u7ea7\u522b\u3002 \u8fd9\u610f\u5473\u7740\uff0c\u5982\u679c\u7528\u6237\u5728 <code>filterconfigs</code> \u4e2d\u63d0\u4f9b <code>/dev/sdb</code> \u4f5c\u4e3a\u5305\u542b\u8fc7\u6ee4\u5668\uff0c\u5219\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u6240\u6709 <code>/dev/sdb</code> \u5757\u8bbe\u5907\u5c06\u7528\u4e8e\u7531 NDM \u521b\u5efa\u5757\u8bbe\u5907 CR\u3002</p>"},{"location":"storage/openEBS/node-disk-manager/#filter_1","title":"\u6392\u9664 filter","text":"<p>NDM \u5bf9\u8981\u6392\u9664\u7684\u78c1\u76d8\u8fdb\u884c\u4e00\u4e9b\u8fc7\u6ee4\uff0c\u4f8b\u5982\u542f\u52a8\u78c1\u76d8\u3002 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cNDM \u5728\u521b\u5efa\u5757\u8bbe\u5907 CR \u65f6\u6392\u9664\u4ee5\u4e0b\u8bbe\u5907\u8def\u5f84\u3002 \u6b64\u914d\u7f6e\u6dfb\u52a0\u5230 <code>openebs-operator.yaml</code> \u4e2d Configmap \u4e0b\u7684 <code>openebs-ndm-config</code> \u4e2d\u3002</p> <pre><code>/dev/loop - loop devices.\n/dev/fd - file descriptors.\n/dev/sr - CD-ROM devices.\n/dev/ram - ramdisks.\n/dev/dm -lvm.\n/dev/md -multiple device ( software RAID devices).\n/dev/rbd - ceph RBD devices\n/dev/zd - zfs volumes\n</code></pre> <p>\u4ee5\u4e0b\u662f\u6765\u81ea openebs \u64cd\u4f5c\u5458 YAML \u7684 NDM \u914d\u7f6e\u6587\u4ef6\u7247\u6bb5\uff0c\u5176\u4e2d\u4e0d\u5305\u62ec\u63d0\u4f9b\u7684\u78c1\u76d8/\u8def\u5f84\u3002</p> <pre><code>filterconfigs:\n  - key: os-disk-exclude-filter\n    name: os disk exclude filter\n    state: true\nexclude: \"/,/etc/hosts,/boot\"\n- key: vendor-filter\n    name: vendor filter\n    state: true\ninclude: \"\"\nexclude: \"CLOUDBYT,OpenEBS\"\n- key: path-filter\n    name: path filter\n    state: true\ninclude: \"\"\nexclude: \"loop,/dev/fd0,/dev/sr0,/dev/ram,/dev/dm-,/dev/md,/dev/rbd\"  </code></pre> <p>\u8fd8\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u66f4\u591a\u4e0e\u8282\u70b9\u5173\u8054\u7684\u78c1\u76d8\u7c7b\u578b\u6765\u8fdb\u884c\u81ea\u5b9a\u4e49\u3002 \u4f8b\u5982\uff0c\u5df2\u7528\u78c1\u76d8\u3001\u4e0d\u9700\u8981\u7684\u78c1\u76d8\u7b49\u3002</p> <p>\u6b64\u66f4\u6539\u5fc5\u987b\u5728 OpenEBS \u5b89\u88c5\u4e4b\u524d\u4e0b\u8f7d\u7684 <code>openebs-operator.yaml</code> \u6587\u4ef6\u4e2d\u5b8c\u6210\u3002 \u5982\u679c\u5728 OpenEBS \u5b89\u88c5\u540e\u6267\u884c\u66f4\u6539\uff0c\u5219\u7528\u6237\u5fc5\u987b\u91cd\u65b0\u542f\u52a8\u76f8\u5e94\u7684 NDM DaemonSet Pod \u624d\u80fd\u66f4\u65b0 NDM \u914d\u7f6e\u3002</p> <pre><code>filterconfigs:\n  - key: path-filter\n    name: path filter\n    state: true\ninclude: \"\"\nexclude: \"loop,/dev/fd0,/dev/sr0,/dev/ram,/dev/dm-,/dev/md,/dev/sdb\"\n</code></pre> <p>\u5907\u6ce8</p> <p>NDM Configmap \u4e2d\u7684\u8fc7\u6ee4\u5668\u914d\u7f6e\u4e0d\u652f\u6301\u6b63\u5219\u8868\u8fbe\u5f0f\uff0c\u5e76\u4e14 Configmap \u9002\u7528\u4e8e\u96c6\u7fa4\u7ea7\u522b\u3002 \u8fd9\u610f\u5473\u7740\uff0c\u5982\u679c\u7528\u6237\u5728 configmap \u4e2d\u63d0\u4f9b <code>/dev/sdb</code> \u4f5c\u4e3a\u6392\u9664\u8fc7\u6ee4\u5668\uff0c\u5219\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u6240\u6709 <code>/dev/sdb</code> \u5757\u8bbe\u5907\u90fd\u5c06\u88ab NDM \u6392\u9664\u3002</p> <p>\u5efa\u8bae\u5728\u96c6\u7fa4\u4e2d\u5355\u72ec\u4f7f\u7528OpenEBS Provisioner\u3002 \u5982\u679c\u60a8\u5c06\u5176\u4ed6\u5b58\u50a8\u63d0\u4f9b\u7a0b\u5e8f\u914d\u7f6e\u7a0b\u5e8f\uff08\u4f8b\u5982 <code>gce-pd</code>\uff09\u4e0e OpenEBS \u4e00\u8d77\u4f7f\u7528\uff0c\u8bf7\u4f7f\u7528\u6392\u9664\u8fc7\u6ee4\u5668\u4ee5\u907f\u514d OpenEBS \u6d88\u8017\u8fd9\u4e9b\u78c1\u76d8\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u60a8\u5728 GKE \u4e2d\u4f7f\u7528\u6807\u51c6\u5b58\u50a8\u7c7b\uff0c\u5b58\u50a8\u914d\u7f6e\u7a0b\u5e8f\u4e3a <code>kubernetes.io/gce-pd</code>\uff0c\u5e76\u4e14\u5f53\u5b83\u521b\u5efa PVC \u65f6\uff0cGPD \u4f1a\u9644\u52a0\u5230\u8be5\u8282\u70b9\u3002 \u8be5 GPD \u5c06\u7531 NDM \u68c0\u6d4b\u5230\uff0c\u5e76\u4e14 OpenEBS \u53ef\u4ee5\u4f7f\u7528\u5b83\u6765\u914d\u7f6e\u5377\u3002 \u4e3a\u4e86\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\uff0c\u5efa\u8bae\u5c06\u8282\u70b9\u4e0a\u521b\u5efa\u7684\u5173\u8054\u8bbe\u5907\u8def\u5f84\u653e\u5728\u8def\u5f84\u8fc7\u6ee4\u5668\u4e0b\u7684\u6392\u9664\u5b57\u6bb5\u4e2d\u3002 \u5982\u679c GPD \u4f5c\u4e3a <code>/dev/sdc</code> \u9644\u52a0\uff0c\u5219\u5728\u4e0a\u8ff0\u5b57\u6bb5\u4e2d\u6dfb\u52a0 <code>/dev/sdc</code> \u3002</p> <p>\u5728\u4e0b\u8f7d\u7684 <code>openebs-operator.yaml</code> \u4e2d\uff0c\u627e\u5230 <code>openebs-ndm-config</code> configmap \u5e76\u6839\u636e\u9700\u8981\u66f4\u65b0\u8def\u5f84\u8fc7\u6ee4\u5668\u548c\u4efb\u4f55\u5176\u4ed6\u8fc7\u6ee4\u5668\u7684\u503c\u3002</p> <pre><code>---\n# This is the node-disk-manager related config.\n# It can be used to customize the disks probes and filters\napiVersion: v1\nkind: ConfigMap\nmetadata:\nname: openebs-ndm-config\nnamespace: openebs\ndata:\n# udev-probe is default or primary probe which should be enabled to run ndm\n# filterconfigs contains configs of filters - in their form fo include\n# and exclude comma separated strings\nnode-disk-manager.config: |\nprobeconfigs:\n- key: udev-probe\nname: udev probe\nstate: true\n- key: seachest-probe\nname: seachest probe\nstate: false\n- key: smart-probe\nname: smart probe\nstate: true\nfilterconfigs:\n- key: os-disk-exclude-filter\nname: os disk exclude filter\nstate: true\nexclude: \"/,/etc/hosts,/boot\"\n- key: vendor-filter\nname: vendor filter\nstate: true\ninclude: \"\"\nexclude: \"CLOUDBYT,OpenEBS\"\n- key: path-filter\nname: path filter\nstate: true\ninclude: \"\"\nexclude: \"loop,/dev/fd0,/dev/sr0,/dev/ram,/dev/dm-,/dev/md,/dev/sdc\"\n---\n</code></pre>"},{"location":"storage/openEBS/node-disk-manager/#cr","title":"\u4e3a\u4e0d\u652f\u6301\u7684\u78c1\u76d8\u521b\u5efa\u5757\u8bbe\u5907 CR","text":"<p>\u76ee\u524d\uff0cNDM \u5f00\u7bb1\u5373\u7528\uff0c\u53ef\u4ee5\u7ba1\u7406<code>disk</code>\u3001<code>partition</code>\u3001<code>lvm</code>\u3001<code>crypt</code> \u548c\u5176\u4ed6 <code>dm</code> \u8bbe\u5907\u3002 \u5982\u679c\u7528\u6237\u9700\u8981\u4e3a\u5176\u4ed6\u8bbe\u5907\u7c7b\u578b\uff08\u4f8b\u5982 <code>md</code> \u9635\u5217\u6216\u4efb\u4f55\u5176\u4ed6\u4e0d\u652f\u6301\u7684\u8bbe\u5907\u7c7b\u578b\uff09\u62e5\u6709 <code>blockdevice</code>\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6b65\u9aa4\u624b\u52a8\u521b\u5efa <code>blockdevice</code> \u8d44\u6e90\uff1a</p> <p>\u4f7f\u7528\u4ee5\u4e0b\u89c4\u8303\u521b\u5efa\u793a\u4f8b\u5757\u8bbe\u5907 CR YAML\u3002 \u4ee5\u4e0b\u662f\u793a\u4f8b\u5757\u8bbe\u5907 CR YAML\u3002</p> <pre><code>apiVersion: openebs.io/v1alpha1\nkind: BlockDevice\nmetadata:\nname: example-blockdevice-1\nlabels:\nkubernetes.io/hostname: &lt;host name in which disk/blockdevice is attached&gt; # like gke-openebs-user-default-pool-044afcb8-bmc0\nndm.io/managed: \"false\" # for manual blockdevice creation put false\nndm.io/blockdevice-type: blockdevice\nstatus:\nclaimState: Unclaimed\nstate: Active\nspec:\ncapacity:\nlogicalSectorSize: 512\nstorage: &lt;total capacity in bytes&gt; #like 53687091200\ndetails:\ndeviceType: &lt;device type&gt; # like disk, partition, lvm, crypt, md\nfirmwareRevision: &lt;firmware revision&gt;\nmodel: &lt;model name of blockdevice&gt; # like PersistentDisk\nserial: &lt;serial no of disk&gt; # like google-disk-2\ncompliance: &lt;compliance of disk&gt; #like \"SPC-4\"\nvendor: &lt;vendor of disk&gt; #like Google\ndevlinks:\n- kind: by-id\nlinks:\n- &lt;link1&gt; # like /dev/disk/by-id/scsi-0Google_PersistentDisk_disk-2\n- &lt;link2&gt; # like /dev/disk/by-id/google-disk-2\n- kind: by-path\nlinks:\n- &lt;link1&gt; # like /dev/disk/by-path/virtio-pci-0000:00:03.0-scsi-0:0:2:0\nnodeAttributes:\nnodeName: &lt;node name&gt; # output of `kubectl get nodes` can be used\npath: &lt;devpath&gt; # like /dev/md0\n</code></pre> <p>\u4f7f\u7528\u78c1\u76d8\u4fe1\u606f\u4fee\u6539\u521b\u5efa\u7684\u5757\u8bbe\u5907 CR \u793a\u4f8b YAML\u3002 \u5728\u4e0a\u9762\u7684\u5757\u8bbe\u5907 CR \u793a\u4f8b\u89c4\u8303\u4e2d\uff0c\u5728\u5e94\u7528 YAML \u4e4b\u524d\u5fc5\u987b\u586b\u5199\u4ee5\u4e0b\u5b57\u6bb5\u3002</p> \u5b57\u6bb5\u540d\u79f0 \u7528\u9014\u63cf\u8ff0 <code>name</code> \u4e3a\u5757\u8bbe\u5907 CR \u63d0\u4f9b\u552f\u4e00\u7684\u540d\u79f0\u3002 \u5728\u4e0a\u9762\u7684 YAML \u89c4\u8303\u4e2d\uff0c\u5757\u8bbe\u5907 CR \u7684\u7ed9\u5b9a\u540d\u79f0\u662f <code>example-blockdevice-1</code> <code>kubernetes.io/hostname</code> \u9644\u52a0\u5757\u8bbe\u5907\u7684\u8282\u70b9\u7684\u4e3b\u673a\u540d\u3002 <code>storage</code> \u63d0\u4f9b\u4ee5\u5b57\u8282\u4e3a\u5355\u4f4d\u7684\u5b58\u50a8\u5bb9\u91cf\uff0c\u4f8b\u5982 53687091200\u3002 <code>logicalSectorSize</code> \u5757\u8bbe\u5907\u7684\u903b\u8f91\u6247\u533a\u5927\u5c0f\u3002 \u4f8b\u5982\uff0c512\u30014096 \u7b49\u3002\u5728\u4e0a\u9762\u7684\u793a\u4f8b\u7247\u6bb5\u4e2d\u63d0\u4f9b\u4e86 512\u3002 \u8be5\u503c\u53ef\u4ee5\u6839\u636e\u8bbe\u5907\u7684\u903b\u8f91\u6247\u533a\u5927\u5c0f\u8fdb\u884c\u66f4\u6539\u3002 <code>deviceType</code> \u8bbe\u5907\u7c7b\u578b\u3002 \u8fd9\u53ef\u4ee5\u4ece <code>lsblk</code> \u8f93\u51fa\u4e2d\u83b7\u5f97\u3002 \u4f8b\u5982\uff1a<code>lvm</code>\u3001<code>crypt</code>\u3001<code>nbd</code>\u3001<code>md</code> \u7b49 <code>links</code> \u5bf9\u4e8e <code>by-id</code> \u548c <code>by-path</code> \u5e94\u586b\u5199\u6b64\u5b57\u6bb5\u3002 \u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ece\u5de5\u4f5c\u8282\u70b9\u83b7\u53d6\u8fd9\u4e9b\u8be6\u7ec6\u4fe1\u606f <code>udevadm info -q property -n &lt;device_path&gt;</code> <code>nodeName</code> \u9644\u52a0\u5757\u8bbe\u5907\u7684\u8282\u70b9\u7684\u540d\u79f0\u3002 <code>kubectl get Nodes</code> \u7684\u8f93\u51fa\u53ef\u7528\u4e8e\u83b7\u53d6\u8be5\u503c\u3002 <code>path</code> \u8be5\u503c\u5e94\u7c7b\u4f3c\u4e8e <code>/dev/dm-0</code> \u6216 <code>/dev/md0</code>\u3002 <p>\u5e94\u7528\u4fee\u6539\u540e\u7684 YAML \u6587\u4ef6\u4e3a\u63d0\u4f9b\u7684\u8bbe\u5907\u8def\u5f84\u521b\u5efa\u5757\u8bbe\u5907 CR\u3002</p> <pre><code>kubectl apply -f &lt;blockdevice-cr.yaml&gt; -n &lt;openebs_namespace&gt;\n</code></pre> <p>\u5bf9\u6bcf\u4e2a\u4e0d\u652f\u6301\u7684\u8bbe\u5907\u91cd\u590d\u76f8\u540c\u7684\u6b65\u9aa4\uff0c\u5e76\u4e3a\u8bbe\u5907\u521b\u5efa\u5757\u8bbe\u5907 CR\u3002</p> <p>\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b <code>kubectl get blockdevice -n openebs</code> \u547d\u4ee4\u9a8c\u8bc1\u662f\u5426\u5df2\u521b\u5efa\u5757\u8bbe\u5907\u3002</p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u60a8\u8981\u4e3a\u4e0d\u53d7\u652f\u6301\u7684\u8bbe\u5907\u521b\u5efa\u5757\u8bbe\u5907 CR\uff0c\u5219\u5fc5\u987b\u5728\u6392\u9664\u8fc7\u6ee4\u5668\u4e0b\u6dfb\u52a0\u76f8\u5e94\u7684\u78c1\u76d8\uff0c\u4ee5\u4fbf NDM \u4e0d\u4f1a\u9009\u62e9\u7279\u5b9a\u78c1\u76d8\u6765\u521b\u5efa BD\u3002</p>"},{"location":"storage/openEBS/snapshot-clone/","title":"\u5feb\u7167\u514b\u9686","text":""},{"location":"storage/openEBS/snapshot-clone/#kubernetes","title":"\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u5377\u5feb\u7167\u5e76\u4ece\u5feb\u7167\u6062\u590d\u5377","text":"<p>\u60a8\u7684\u96c6\u7fa4\u4e2d\u5fc5\u987b\u6709\u6b63\u5728\u4f7f\u7528\u7684\u73b0\u6709\u5377\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa PersistentVolumeClaim (PVC) \u6765\u521b\u5efa\u8be5\u5377\u3002 \u51fa\u4e8e\u672c\u6559\u7a0b\u7684\u76ee\u7684\uff0c\u5047\u8bbe\u6211\u4eec\u5df2\u7ecf\u901a\u8fc7\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 YAML \u6587\u4ef6\u8c03\u7528 <code>kubectl create -f your_pvc_file.yaml</code> \u521b\u5efa\u4e86 PVC\uff1a</p> your_pvc_file.yaml<pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\nname: cstor-pvc\nspec:\naccessModes:\n- ReadWriteOnce\nresources:\nrequests:\nstorage: 5Gi\nstorageClassName: cstor-csi-disk\n</code></pre> <p>\u4e0b\u9762\u8be6\u7ec6\u4ecb\u7ecd\u7684\u793a\u4f8b\u89e3\u91ca\u4e86\u4f7f\u7528\u5feb\u7167\u6240\u9700\u7684\u6784\u9020\uff0c\u5e76\u5c55\u793a\u4e86\u5982\u4f55\u521b\u5efa\u548c\u4f7f\u7528\u5feb\u7167\u3002 \u5728\u521b\u5efa\u5377\u5feb\u7167\u4e4b\u524d\uff0c\u5fc5\u987b\u8bbe\u7f6e <code>VolumeSnapshotClass</code>\u3002</p> <pre><code>kind: VolumeSnapshotClass\napiVersion: snapshot.storage.k8s.io/v1\nmetadata:\nname: csi-cstor-snapshotclass\nannotations:\nsnapshot.storage.kubernetes.io/is-default-class: \"true\"\ndriver: cstor.csi.openebs.io\ndeletionPolicy: Delete\n</code></pre> <p>\u8be5\u9a71\u52a8\u7a0b\u5e8f\u6307\u5411 OpenEBS CStor CSI \u9a71\u52a8\u7a0b\u5e8f\u3002 \u5220\u9664\u7b56\u7565\u53ef\u4ee5\u8bbe\u7f6e\u4e3a <code>delete</code> \u6216 <code>retain</code>\u3002 \u8bbe\u7f6e\u4e3a <code>retain</code> \u65f6\uff0c\u5373\u4f7f\u5220\u9664 <code>VolumeSnapshot</code> \u5bf9\u8c61\uff0c\u4e5f\u4f1a\u4fdd\u7559\u5b58\u50a8\u96c6\u7fa4\u4e0a\u7684\u5e95\u5c42\u7269\u7406\u5feb\u7167\u3002</p>"},{"location":"storage/openEBS/snapshot-clone/#_1","title":"\u521b\u5efa\u5377\u7684\u5feb\u7167","text":"<p>\u8981\u521b\u5efa\u5377\u7684\u5feb\u7167\uff0c\u4e0b\u9762\u662f\u5b9a\u4e49\u5feb\u7167\u7684 YAML \u6587\u4ef6\u793a\u4f8b\uff1a</p> <pre><code>apiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshot\nmetadata:\nname: cstor-pvc-snap\nspec:\nvolumeSnapshotClassName: csi-cstor-snapshotclass\nsource:\npersistentVolumeClaimName: cstor-pvc\n</code></pre> <p>\u4e3a\u540d\u4e3a <code>cstor-pvc</code> \u7684 PVC \u521b\u5efa\u5feb\u7167\uff0c\u5e76\u4e14\u5feb\u7167\u7684\u540d\u79f0\u8bbe\u7f6e\u4e3a <code>cstor-pvc-snap</code>\u3002</p> <pre><code>$ kubectl create -f snapshot.yaml\nvolumesnapshot.snapshot.storage.k8s.io/cstor-pvc-snap created\n\n$ kubectl get volumesnapshots\nNAME                   AGE\ncstor-pvc-snap              10s\n</code></pre>"},{"location":"storage/openEBS/sync-replication/","title":"\u540c\u6b65\u590d\u5236","text":"<p>OpenEBS\u7ba1\u7406k8s\u8282\u70b9\u4e0a\u5b58\u50a8\uff0c\u5e76\u4e3ak8s\u6709\u72b6\u6001\u8d1f\u8f7d\uff08StatefulSet\uff09\u63d0\u4f9b\u672c\u5730\u5b58\u50a8\u5377\u6216\u5206\u5e03\u5f0f\u5b58\u50a8\u5377\u3002</p> <ul> <li> <p>\u672c\u5730\u5377\uff08Local PV\uff09</p> <ul> <li>OpenEBS\u53ef\u4ee5\u4f7f\u7528\u5bbf\u4e3b\u673a\u88f8\u5757\u8bbe\u5907\u6216\u5206\u533a\uff0c\u6216\u8005\u4f7f\u7528Hostpaths\u4e0a\u7684\u5b50\u76ee\u5f55\uff0c\u6216\u8005\u4f7f\u7528<code>LVM</code>\u3001<code>ZFS</code>\u6765\u521b\u5efa\u6301\u4e45\u5316\u5377</li> <li>\u672c\u5730\u5377\u76f4\u63a5\u6302\u8f7d\u5230Stateful Pod\u4e2d\uff0c\u800c\u4e0d\u9700\u8981OpenEBS\u5728\u6570\u636e\u8def\u5f84\u4e2d\u589e\u52a0\u4efb\u4f55\u5f00\u9500</li> <li>OpenEBS\u4e3a\u672c\u5730\u5377\u63d0\u4f9b\u4e86\u989d\u5916\u7684\u5de5\u5177\uff0c\u7528\u4e8e\u76d1\u63a7\u3001\u5907\u4efd/\u6062\u590d\u3001\u707e\u96be\u6062\u590d\u3001\u7531ZFS\u6216LVM\u652f\u6301\u7684\u5feb\u7167\u7b49</li> </ul> </li> <li> <p>\u5bf9\u4e8e\u5206\u5e03\u5f0f\u5377(\u5373\u590d\u5236\u5377)</p> <ul> <li>OpenEBS\u4f7f\u7528\u5176\u4e2d\u4e00\u4e2a\u5f15\u64ce(<code>Mayastor</code>\u3001<code>cStor</code>\u6216<code>Jiva</code>)\u4e3a\u6bcf\u4e2a\u5206\u5e03\u5f0f\u6301\u4e45\u5377\u521b\u5efa\u5fae\u670d\u52a1</li> <li>\u6709\u72b6\u6001Pod\u5c06\u6570\u636e\u5199\u5165OpenEBS\u5f15\u64ce\uff0cOpenEBS\u5f15\u64ce\u5c06\u6570\u636e\u540c\u6b65\u590d\u5236\u5230\u96c6\u7fa4\u4e2d\u7684\u591a\u4e2a\u8282\u70b9\u3002 OpenEBS\u5f15\u64ce\u672c\u8eab\u4f5c\u4e3apod\u90e8\u7f72\uff0c\u5e76\u7531Kubernetes\u8fdb\u884c\u534f\u8c03\u3002 \u5f53\u8fd0\u884cStateful Pod\u7684\u8282\u70b9\u5931\u8d25\u65f6\uff0cPod\u5c06\u88ab\u91cd\u65b0\u8c03\u5ea6\u5230\u96c6\u7fa4\u4e2d\u7684\u53e6\u4e00\u4e2a\u8282\u70b9\uff0cOpenEBS\u5c06\u4f7f\u7528\u5176\u4ed6\u8282\u70b9\u4e0a\u7684\u53ef\u7528\u6570\u636e\u526f\u672c\u63d0\u4f9b\u5bf9\u6570\u636e\u7684\u8bbf\u95ee</li> <li>\u6709\u72b6\u6001\u7684Pods\u4f7f\u7528<code>iSCSI</code> (<code>cStor</code>\u548c<code>Jiva</code>)\u6216NVMeoF (<code>Mayastor</code>)\u8fde\u63a5OpenEBS\u5206\u5e03\u5f0f\u6301\u4e45\u5377</li> <li>OpenEBS <code>cStor</code>\u548c<code>Jiva</code>\u4e13\u6ce8\u4e8e\u5b58\u50a8\u7684\u6613\u7528\u6027\u548c\u6301\u4e45\u6027\u3002\u5b83\u4eec\u5206\u522b\u4f7f\u7528\u81ea\u5b9a\u4e49\u7248\u672c\u7684<code>ZFS</code>\u548c<code>Longhorn</code>\u6280\u672f\u5c06\u6570\u636e\u5199\u5165\u5b58\u50a8\u3002 OpenEBS <code>Mayastor</code>\u662f\u6700\u65b0\u5f00\u53d1\u7684\u4ee5\u8010\u4e45\u6027\u548c\u6027\u80fd\u4e3a\u8bbe\u8ba1\u76ee\u6807\u7684\u5f15\u64ce\uff0c\u9ad8\u6548\u5730\u7ba1\u7406\u8ba1\u7b97(\u5927\u9875\u9762\u3001\u6838\u5fc3)\u548c\u5b58\u50a8(<code>NVMe Drives</code>)\uff0c\u4ee5\u63d0\u4f9b\u5feb\u901f\u5206\u5e03\u5f0f\u5757\u5b58\u50a8</li> </ul> </li> </ul> <p>\u6ce8\u610f</p> <p>OpenEBS\u5206\u5e03\u5f0f\u5757\u5377\u88ab\u79f0\u4e3a\u590d\u5236\u5377\uff0c\u4ee5\u907f\u514d\u4e0e\u4f20\u7edf\u7684\u5206\u5e03\u5f0f\u5757\u5b58\u50a8\u6df7\u6dc6\uff0c\u4f20\u7edf\u7684\u5206\u5e03\u5f0f\u5757\u5b58\u50a8\u503e\u5411\u4e8e\u5c06\u6570\u636e\u5206\u5e03\u5230\u96c6\u7fa4\u4e2d\u7684\u8bb8\u591a\u8282\u70b9\u4e0a\u3002 \u590d\u5236\u5377\u662f\u4e3a\u4e91\u539f\u751f\u6709\u72b6\u6001\u5de5\u4f5c\u8d1f\u8f7d\u8bbe\u8ba1\u7684\uff0c\u8fd9\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u9700\u8981\u5927\u91cf\u7684\u5377\uff0c\u8fd9\u4e9b\u5377\u7684\u5bb9\u91cf\u901a\u5e38\u53ef\u4ee5\u4ece\u5355\u4e2a\u8282\u70b9\u63d0\u4f9b\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u8de8\u96c6\u7fa4\u4e2d\u7684\u591a\u4e2a\u8282\u70b9\u5206\u7247\u7684\u5355\u4e2a\u5927\u5377</p>"},{"location":"storage/openEBS/sync-replication/#_1","title":"\u590d\u5236\u5377","text":"<p>\u590d\u5236\u5377</p> <p>\u590d\u5236\u5377\uff0c\u987e\u540d\u601d\u4e49\uff0c\u662f\u5c06\u6570\u636e\u540c\u6b65\u590d\u5236\u5230\u591a\u4e2a\u8282\u70b9\u7684\u5377\u3002 \u5377\u53ef\u4ee5\u627f\u53d7\u8282\u70b9\u6545\u969c\u3002 \u8fd8\u53ef\u4ee5\u8de8\u53ef\u7528\u6027\u533a\u57df\u8bbe\u7f6e\u590d\u5236\uff0c\u5e2e\u52a9\u5e94\u7528\u7a0b\u5e8f\u8de8\u53ef\u7528\u6027\u533a\u57df\u79fb\u52a8\u3002</p> <p>\u590d\u5236\u5377\u8fd8\u5177\u6709\u4f01\u4e1a\u5b58\u50a8\u529f\u80fd\uff0c\u4f8b\u5982\u5feb\u7167\u3001\u514b\u9686\u3001\u5377\u6269\u5c55\u7b49\u3002 \u590d\u5236\u5377\u662f <code>Percona/MySQL</code>\u3001<code>Jira</code>\u3001<code>GitLab</code> \u7b49\u6709\u72b6\u6001\u5de5\u4f5c\u8d1f\u8f7d\u7684\u9996\u9009\u3002</p> <p>\u6839\u636e\u9644\u52a0\u5230 Kubernetes \u5de5\u4f5c\u8282\u70b9\u7684\u5b58\u50a8\u7c7b\u578b\u548c\u5e94\u7528\u7a0b\u5e8f\u6027\u80fd\u8981\u6c42\uff0c\u60a8\u53ef\u4ee5\u4ece <code>Jiva</code>\u3001<code>cStor</code> \u6216 <code>Mayastor</code> \u4e2d\u8fdb\u884c\u9009\u62e9\u3002</p>"}]}